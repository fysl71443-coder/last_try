{% extends 'base.html' %}
{% block title %}{{ _('Sales / Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª') }}{% endblock %}
{% block content %}

<style>
body {
  background: #f4f6f9;
}
.sales-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0px 4px 8px rgba(0,0,0,0.05);
  padding: 1.5rem;
  margin-bottom: 1rem;
}
.branch-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: bold;
}
.branch-place-india { background: #74b9ff; color: white; }
.branch-china-town { background: #fd79a8; color: white; }
.status-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: bold;
}
.status-unpaid { background: #ffeaa7; color: #2d3436; }
.status-partial { background: #fab1a0; color: #2d3436; }
.status-paid { background: #00b894; color: white; }
.item-row {
  border: 1px solid #e9ecef;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 0.5rem;
  background: #f8f9fa;
}
</style>

<div class="container py-4">
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹ -->
    <div class="section-header mb-3">
        <h3 class="mb-0">ğŸ’° {{ _('Sales / Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª') }}</h3>
        <div class="d-flex flex-wrap gap-2">
            <a href="{{ url_for('main.inventory') }}" class="btn btn-outline-info">
                ğŸ“¦ {{ _('Inventory / Ø§Ù„Ù…Ø®Ø²ÙˆÙ†') }}
            </a>
            <a href="{{ url_for('main.purchases') }}" class="btn btn-outline-warning">
                ğŸ›’ {{ _('Purchases / Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª') }}
            </a>
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary">
                ğŸ  {{ _('Dashboard / Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…') }}
            </a>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© -->
    <div class="sales-card">
        <h5 class="mb-3">{{ _('Create New Invoice / Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©') }}</h5>

        <div class="alert alert-info">
            <strong>ğŸ’¡ {{ _('Note / Ù…Ù„Ø§Ø­Ø¸Ø©') }}:</strong>
            {{ _('Meals are automatically loaded from Cost Management system with calculated prices / Ø§Ù„ÙˆØ¬Ø¨Ø§Øª ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ù…Ø¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©') }}
            <a href="{{ url_for('main.inventory') }}" class="alert-link">{{ _('Manage Meals / Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ¬Ø¨Ø§Øª') }}</a>
        </div>

        <form method="POST" id="sales-form">
            {{ form.hidden_tag() }}
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>


            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
            <div class="row mb-3">
                <div class="col-md-3">
                    {{ form.date.label(class_='form-label') }}
                    {{ form.date(class_='form-control') }}
                </div>
                <div class="col-md-3">
                    {{ form.payment_method.label(class_='form-label') }}
                    {{ form.payment_method(class_='form-select') }}
                </div>
                <div class="col-md-3">
                    {{ form.branch.label(class_='form-label') }}
                    {{ form.branch(class_='form-select') }}
                </div>
                <div class="col-md-3">
                    {{ form.customer_name.label(class_='form-label') }}
                    {{ form.customer_name(class_='form-control') }}
                </div>
                    <div class="mt-1">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="openAddCustomerModalSales()">â• {{ _('New Customer / Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯') }}</button>
                    </div>
            </div>
            <div class="row mb-3" id="special-discount-row" style="display:none">
                <div class="col-md-3">
                    <label class="form-label">{{ _('Customer Discount % / Ù†Ø³Ø¨Ø© Ø®ØµÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„') }}</label>
                    {{ form.special_discount_pct(class_='form-control', step='0.01', placeholder=_('Enter customer discount %')) }}
                    <div class="form-text">{{ _('Applied to all items when a customer-specific discount is set.') }}</div>
                </div>
            </div>


            <!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
            <h6 class="mb-3">{{ _('Invoice Items (Ready Meals) / Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø§Ù„ÙˆØ¬Ø¨Ø§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©)') }}</h6>
            <div id="items-container">
                {% for item_form in form.items %}
                <div class="row g-3 mb-2 item-row">
                    <div class="col-md-3">
                        {{ item_form.product_id.label(class_='form-label') }}
                        {{ item_form.product_id(class_='form-select') }}
                    </div>
                    <div class="col-md-1">
                        {{ item_form.quantity.label(class_='form-label') }}
                        {{ item_form.quantity(class_='form-control') }}
                    </div>
                    <div class="col-md-2">
                        {{ item_form.price_before_tax.label(class_='form-label') }}
                        {{ item_form.price_before_tax(class_='form-control') }}
                    </div>
                    <div class="col-md-2">
                        {{ item_form.tax_amount.label(class_='form-label') }}
                        {{ item_form.tax_amount(class_='form-control') }}
                    </div>
                    <div class="col-md-2">
                        {{ item_form.discount.label(class_='form-label') }}
                        {{ item_form.discount(class_='form-control', step='0.01') }}
                    </div>
                    <div class="col-md-1">
                        {{ item_form.total_price.label(class_='form-label') }}
                        {{ item_form.total_price(class_='form-control') }}
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                        <button type="button" class="btn btn-danger btn-sm remove-item-btn">âˆ’</button>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <button type="button" class="btn btn-secondary" id="add-item">
                        â• {{ _('Add Meal / Ø¥Ø¶Ø§ÙØ© ÙˆØ¬Ø¨Ø©') }}
                    </button>
                </div>
                <div class="col-md-6 text-end">
                    {{ form.submit(class_='btn btn-primary btn-lg') }}

        <!-- Add Customer Modal (Sales) -->
        <div class="modal fade" id="addCustomerSalesModal" tabindex="-1" aria-labelledby="addCustomerSalesModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="addCustomerSalesModalLabel">{{ _('Add Customer / Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="mb-2">
                  <label class="form-label">{{ _('Name / Ø§Ù„Ø§Ø³Ù…') }}</label>
                  <input id="salesNewCustName" class="form-control" placeholder="{{ _('Customer name') }}">
                </div>
                <div class="mb-2">
                  <label class="form-label">{{ _('Phone / Ø§Ù„Ù‡Ø§ØªÙ') }}</label>
                  <input id="salesNewCustPhone" class="form-control" placeholder="{{ _('Phone (optional)') }}">
                </div>
                <div class="mb-2">
                  <label class="form-label">{{ _('Discount % / Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ…') }}</label>
                  <input id="salesNewCustDisc" type="number" min="0" max="100" step="0.01" class="form-control" value="0">
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Close / Ø¥ØºÙ„Ø§Ù‚') }}</button>
                <button type="button" class="btn btn-primary" onclick="submitNewCustomerSales()">{{ _('Save / Ø­ÙØ¸') }}</button>
              </div>
            </div>
          </div>
        </div>

                </div>
            </div>
        </form>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
    {% if invoices %}
    <div class="sales-card">
        <h5 class="mb-3">{{ _('Previous Invoices / Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©') }}</h5>

        <div class="table-responsive">
            <table class="table table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>{{ _('Invoice No / Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©') }}</th>
                        <th>{{ _('Date / Ø§Ù„ØªØ§Ø±ÙŠØ®') }}</th>
                        <th>{{ _('Branch / Ø§Ù„ÙØ±Ø¹') }}</th>
                        <th>{{ _('Customer / Ø§Ù„Ø¹Ù…ÙŠÙ„') }}</th>
                        <th>{{ _('Payment Method / Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹') }}</th>
                        <th>{{ _('Discount / Ø§Ù„Ø®ØµÙ…') }}</th>
                        <th>{{ _('Total / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ') }}</th>
                        <th>{{ _('Status / Ø§Ù„Ø­Ø§Ù„Ø©') }}</th>
                        <th>{{ _('Actions / Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for invoice in invoices %}
                    <tr>
                        <td><strong>{{ invoice.invoice_number }}</strong></td>
                        <td>{{ invoice.date.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <span class="branch-badge branch-{{ invoice.branch.replace('_', '-') }}">
                                {% if invoice.branch == 'place_india' %}
                                    Place India
                                {% elif invoice.branch == 'china_town' %}
                                    China Town
                                {% else %}
                                    {{ invoice.branch }}
                                {% endif %}
                            </span>
                        </td>
                        <td>{{ invoice.customer_name or '-' }}</td>
                        <td>
                            {% if invoice.payment_method == 'cash' %}
                                ğŸ’° {{ _('Cash / Ù†Ù‚Ø¯Ø§Ù‹') }}
                            {% elif invoice.payment_method == 'card' %}
                                ğŸ’³ {{ _('Card / Ø¨Ø·Ø§Ù‚Ø©') }}
                            {% elif invoice.payment_method == 'bank_transfer' %}
                                ğŸ¦ {{ _('Bank Transfer / ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ') }}
                            {% elif invoice.payment_method == 'check' %}
                                ğŸ“ {{ _('Check / Ø´ÙŠÙƒ') }}
                            {% else %}
                                {{ invoice.payment_method }}
                            {% endif %}
                        </td>
                        <td>
                            {% if invoice.discount_amount and invoice.discount_amount > 0 %}
                                <span style="color: #d63384;">-${{ "%.2f"|format(invoice.discount_amount) }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>${{ "%.2f"|format(invoice.total_after_tax_discount) }}</td>
                        <td>
                            <span class="status-badge status-{{ invoice.status }}">
                                {% if invoice.status == 'paid' %}
                                    {{ _('Paid / Ù…Ø¯ÙÙˆØ¹') }}
                                {% elif invoice.status == 'partial' %}
                                    {{ _('Partial / Ø¬Ø²Ø¦ÙŠ') }}
                                {% else %}
                                    {{ _('Unpaid / ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹') }}
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" onclick="viewInvoice({{ invoice.id }})">
                                ğŸ‘ {{ _('View / Ø¹Ø±Ø¶') }}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSalesInvoice({{ invoice.id }}, '{{ invoice.invoice_number }}')">
                                ğŸ—‘ï¸ {{ _('Delete / Ø­Ø°Ù') }}
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<!-- SocketIO and JavaScript -->
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
    // SocketIO for real-time updates
    var socket = io();
    socket.on('sales_update', function(data) {
        console.log('Sales updated:', data);
        // Show notification
        alert('New invoice created: ' + data.invoice_number + ' - $' + data.total);
        // Reload page to show updates
        location.reload();
    });

    // Products data for calculations
    const products = {{ products_json | safe }};

    // Auto-calculation functionality
    document.addEventListener('change', e => {
        if(e.target.matches('select[name^="items-"][name$="-product_id"], input[name^="items-"][name$="-quantity"], input[name^="items-"][name$="-discount"]')) {
            const row = e.target.closest('.item-row');
            const productSelect = row.querySelector('select[name$="-product_id"]');
            const quantityInput = row.querySelector('input[name$="-quantity"]');
            const discountInput = row.querySelector('input[name$="-discount"]');
            const priceInput = row.querySelector('input[name$="-price_before_tax"]');
            const taxInput = row.querySelector('input[name$="-tax_amount"]');
            const totalInput = row.querySelector('input[name$="-total_price"]');

            const productId = parseInt(productSelect.value);
            const quantity = parseInt(quantityInput.value) || 0;
            const discount = parseFloat(discountInput.value) || 0;

            const product = products.find(p => p.id === productId);
            if(product && quantity > 0) {
                const price = product.price_before_tax * quantity;
                // Treat row discount as percentage for preview, and apply BEFORE tax
                const discountPct = parseFloat(discountInput.value) || 0;
                const discountVal = price * (discountPct/100);
                const taxable = price - discountVal;
                const tax = taxable * 0.15; // 15% tax
                const total = taxable + tax;

                priceInput.value = price.toFixed(2);
                taxInput.value = tax.toFixed(2);
                totalInput.value = total.toFixed(2);
            } else {
                // Clear fields if no valid product/quantity
                priceInput.value = '0.00';
                taxInput.value = '0.00';
                totalInput.value = '0.00';
            }
        }
    });

    // Add new item functionality
    let itemIndex = {{ form.items|length }};

    document.getElementById('add-item').addEventListener('click', function() {
        const itemsContainer = document.getElementById('items-container');
        const newItem = document.createElement('div');
        newItem.className = 'row g-3 mb-2 item-row fade-in';
        newItem.innerHTML = `
            <div class="col-md-3">
                <label class="form-label">{{ _('Meal / Ø§Ù„ÙˆØ¬Ø¨Ø©') }}</label>
                <select class="form-select" name="items-${itemIndex}-product_id">
                    <option value="0">{{ _('Select Meal / Ø§Ø®ØªØ± Ø§Ù„ÙˆØ¬Ø¨Ø©') }}</option>
                    ${products.map(m => `<option value="${m.id}">${m.name}</option>`).join('')}
                </select>
            </div>
            <div class="col-md-1">
                <label class="form-label">{{ _('Quantity / Ø§Ù„ÙƒÙ…ÙŠØ©') }}</label>
                <input class="form-control" name="items-${itemIndex}-quantity" type="number" value="1">
            </div>
            <div class="col-md-2">
                <label class="form-label">{{ _('Price / Ø§Ù„Ø³Ø¹Ø±') }}</label>
                <input class="form-control" name="items-${itemIndex}-price_before_tax" readonly>
            </div>
            <div class="col-md-2">
                <label class="form-label">{{ _('Tax / Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©') }}</label>
                <input class="form-control" name="items-${itemIndex}-tax_amount" readonly>
            </div>
            <div class="col-md-2">
                <label class="form-label">{{ _('Discount / Ø§Ù„Ø®ØµÙ…') }}</label>
                <input class="form-control" name="items-${itemIndex}-discount" step="0.01" type="number" value="0">
            </div>
            <div class="col-md-1">
                <label class="form-label">{{ _('Total / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ') }}</label>
                <input class="form-control" name="items-${itemIndex}-total_price" readonly>
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-danger btn-sm remove-item-btn">âˆ’</button>
            </div>
        `;
        itemsContainer.appendChild(newItem);
        requestAnimationFrame(()=>{ newItem.classList.add('show'); });
        itemIndex++;
    });

    // Remove item functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-item-btn')) {
            const row = e.target.closest('.item-row');
            if(row){ row.classList.remove('show'); setTimeout(()=>{ row.remove(); }, 180); }
        }
    });

    // View invoice details
    function viewInvoice(invoiceId) {
        alert('Invoice details for ID: ' + invoiceId + ' (Feature coming soon)');
    }

    async function deleteSalesInvoice(invoiceId, invoiceNumber) {
        const confirmed = await showConfirm('{{ _("Are you sure you want to delete sales invoice") }} "' + invoiceNumber + '"?\n\n{{ _("This action cannot be undone.") }}');
        if (confirmed) {
            // Ask for password
            const password = await showPrompt('{{ _("Enter deletion password / Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø­Ø°Ù") }}:');
            if (password === null) return; // User cancelled

            if (!password || password.trim() === '') {
                await showAlert('{{ _("Password required / ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù…Ø·Ù„ÙˆØ¨Ø©") }}');
                return;
            }

            // Create a form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/delete_sales_invoice/' + invoiceId;

            // Add password field
            const passwordInput = document.createElement('input');
            passwordInput.type = 'hidden';
            passwordInput.name = 'password';
            passwordInput.value = password.trim();
            form.appendChild(passwordInput);

            // Add CSRF token if available
            const csrfToken = document.querySelector('input[name="csrf_token"]');

    // Add Customer (Sales screen)
    function openAddCustomerModalSales(){
        try{
            document.getElementById('salesNewCustName').value='';
            document.getElementById('salesNewCustPhone').value='';
            document.getElementById('salesNewCustDisc').value='0';
            const m = new bootstrap.Modal(document.getElementById('addCustomerSalesModal'));
            m.show();
        }catch(e){ alert('Cannot open modal'); }
    }
    async function submitNewCustomerSales(){
        const name = (document.getElementById('salesNewCustName').value||'').trim();
        const phone = (document.getElementById('salesNewCustPhone').value||'').trim();
        const discount = parseFloat(document.getElementById('salesNewCustDisc').value||'0')||0;
        if(!name){ alert('{{ _("Name is required /  ") if false else _("Name is required /  ") }}'); return; }
        try{
            const tokMeta = document.querySelector("meta[name='csrf-token']");
            const tok = tokMeta ? tokMeta.getAttribute('content') : '';
            const res = await fetch('{{ url_for('main.api_customers_create') }}',{
                method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':tok},
                body: JSON.stringify({name, phone, discount_percent: discount})
            });
            const j = await res.json();
            if(!res.ok || !j || j.ok!==true){ throw new Error((j && j.error) || 'Failed'); }
            // Fill the form field with new customer
            const input = document.querySelector('input[name="customer_name"]');
            if(input) input.value = j.customer.name || '';
            try{ bootstrap.Modal.getInstance(document.getElementById('addCustomerSalesModal')).hide(); }catch(_){ }
        }catch(e){ alert(String(e.message||e)); }
    }

            if (csrfToken) {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = 'csrf_token';
    // Customer discount UI toggle (show if KEETA/HUNGER or any positive discount value)
    function updateSpecialDiscountVisibility(){
        const input = document.querySelector('input[name="customer_name"]');
        const row = document.getElementById('special-discount-row');
        if(!input || !row) return;
        const name = (input.value || '').trim().toUpperCase();
        const discInput = row.querySelector('input[name="special_discount_pct"]');
        const discVal = parseFloat(discInput && discInput.value || '0') || 0;
        if(name === 'KEETA' || name === 'HUNGER' || discVal > 0){
            row.style.display = '';
        } else {
            row.style.display = 'none';
            if(discInput) discInput.value = '';
        }
    }
    document.addEventListener('DOMContentLoaded', updateSpecialDiscountVisibility);
    document.addEventListener('input', function(e){
        if(e.target && e.target.name === 'customer_name'){
            updateSpecialDiscountVisibility();
        }
    });

                tokenInput.value = csrfToken.value;
                form.appendChild(tokenInput);
            }

            document.body.appendChild(form);
            form.submit();
        }
    }
</script>

<script>
// Global handlers for Add Customer (Sales)
window.openAddCustomerModalSales = function(){
  try{
    document.getElementById('salesNewCustName').value='';
    document.getElementById('salesNewCustPhone').value='';
    document.getElementById('salesNewCustDisc').value='0';
    const m = new bootstrap.Modal(document.getElementById('addCustomerSalesModal'));
    m.show();
  }catch(e){ alert('Cannot open modal'); }
}
window.submitNewCustomerSales = async function(){
  const name = (document.getElementById('salesNewCustName').value||'').trim();
  const phone = (document.getElementById('salesNewCustPhone').value||'').trim();
  const discount = parseFloat(document.getElementById('salesNewCustDisc').value||'0')||0;
  if(!name){ alert('{{ _('Name is required / Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨') }}'); return; }
  try{
    const tokMeta = document.querySelector("meta[name='csrf-token']");
    const tok = tokMeta ? tokMeta.getAttribute('content') : '';
    const res = await fetch('{{ url_for('main.api_customers_create') }}',{
      method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':tok},
      body: JSON.stringify({name, phone, discount_percent: discount})
    });
    const j = await res.json();
    if(!res.ok || !j || j.ok!==true){ throw new Error((j && j.error) || 'Failed'); }
    const input = document.querySelector('input[name="customer_name"]');
    if(input) input.value = j.customer.name || '';
    // Apply customer discount to the special discount field and show the row
    const row = document.getElementById('special-discount-row');
    const discInput = row ? row.querySelector('input[name="special_discount_pct"]') : null;
    if(discInput){ discInput.value = (j.customer.discount_percent || 0); }
    if(row){ row.style.display = ''; }
    try{ updateSpecialDiscountVisibility && updateSpecialDiscountVisibility(); }catch(_){ }
    try{ bootstrap.Modal.getInstance(document.getElementById('addCustomerSalesModal')).hide(); }catch(_){ }
  }catch(e){ alert(String(e.message||e)); }
}
</script>


{% endblock %}
