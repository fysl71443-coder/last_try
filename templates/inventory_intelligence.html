{% extends 'base.html' %}
{% block title %}{{ _('Inventory & Production Cost Intelligence') }}{% endblock %}
{% block content %}

<style>
:root{
  --bg:#f1f5f9; --card:#fff; --muted:#5c6773; --accent:#1565c0; --accent-dark:#0d47a1; --danger:#dc3545; --ok:#28a745; --warn:#ffc107;
}
.intel-wrap{ max-width:1440px; margin:0 auto; padding:16px }
.intel-wrap.ops-layout.hub-wrap{ background:var(--bg); }
.sec{ background:var(--card); border:1px solid rgba(13,71,161,.08); border-radius:var(--ops-card-radius, 12px); box-shadow:0 2px 10px rgba(21,101,192,.06); padding:18px; margin-bottom:16px }
.grid{ display:grid; gap:12px }
.grid.kpi{ grid-template-columns:repeat(5, minmax(160px, 1fr)) }
.card{ border-radius:16px; background:#fff; padding:16px; box-shadow:0 10px 26px rgba(18,22,33,.06); display:flex; align-items:center; gap:12px; transition:transform .2s ease }
.card:hover{ transform:translateY(-2px) }
.icon{ font-size:26px }
.num{ font-weight:700; font-size:22px }
.label{ color:var(--muted); font-size:13px }
.cmp{ font-size:12px }
.cmp.up{ color:var(--ok) } .cmp.down{ color:var(--danger) }
.table-responsive{ border-radius:12px; overflow:auto }
table.tbl{ width:100%; border-collapse:separate; border-spacing:0 }
table.tbl th, table.tbl td{ padding:10px 12px; border-bottom:1px solid rgba(0,0,0,.06); font-size:13px }
table.tbl th{ background:#f8fafc; position:sticky; top:0; z-index:1 }
.filters{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px }
.chip{ display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border:1px solid rgba(0,0,0,.08); border-radius:999px; font-size:12px; background:#fff }
.bar-chart{ display:flex; flex-direction:column; gap:6px }
.bar{ display:flex; align-items:center; gap:8px }
.bar .name{ width:220px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.bar .val{ flex:1; background:linear-gradient(90deg, var(--accent), var(--accent-dark)); height:10px; border-radius:6px; position:relative }
.bar .val::after{ content:''; position:absolute; right:0; top:0; bottom:0; width:2px; background:rgba(255,255,255,.9); border-radius:2px }
.spark{ display:flex; align-items:flex-end; gap:3px; height:42px }
.spark .pt{ width:12px; background:var(--accent); border-radius:3px }
.alert{ padding:12px 14px; border-radius:12px; background:#fff3cd; border:1px solid #ffeeba; color:#664d03; font-size:13px }
.flow{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; align-items:center; text-align:center; margin-top:12px }
.flow .box{ background:#f8fafc; border:1px dashed rgba(0,0,0,.12); border-radius:12px; padding:12px }
.arrow{ font-size:22px; color:var(--accent) }
.risk.low{ color:var(--danger); font-weight:700 }
.risk.excess{ color:#6610f2; font-weight:700 }
.risk.ok{ color:var(--ok); font-weight:700 }
@media (max-width:1024px){ .grid.kpi{ grid-template-columns:repeat(2, 1fr) } }
</style>

<div class="intel-wrap container py-4 ops-layout hub-wrap" dir="auto">
  <div class="ops-header-bar mb-3">
    <span class="ops-icon"><i class="fa-solid fa-chart-line"></i></span>
    <div>
      <h1 class="ops-title mb-0">{{ _('Inventory & Production Cost Intelligence') }}</h1>
      <span class="ops-subtitle">{{ _('KPIs, purchases summary, meal cost and sales analysis') }}</span>
    </div>
    <div class="ops-actions">
      <a href="{{ url_for('main.dashboard') }}" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-house me-1"></i>{{ _('Dashboard') }}</a>
      <a href="{{ url_for('inventory.inventory') }}" class="btn btn-sm btn-outline-primary"><i class="fa-solid fa-boxes-stacked me-1"></i>{{ _('Inventory') }}</a>
    </div>
  </div>
  <div class="sec">
    <h5 class="mb-3">{{ _('KPI Overview') }}</h5>
    <div class="grid kpi">
      <div class="card"><div class="icon"><i class="fa-solid fa-boxes-stacked"></i></div><div><div class="label">{{ _('Total Inventory Cost') }}</div><div class="num">{{ '{:,.2f}'.format(kpi.total_inventory_cost or 0) }}</div><div class="cmp up">{{ _('vs last period') }}</div></div></div>
      <div class="card"><div class="icon"><i class="fa-solid fa-receipt"></i></div><div><div class="label">{{ _('Ingredient Purchases (This Month)') }}</div><div class="num">{{ '{:,.2f}'.format(kpi.total_purchases_month or 0) }}</div><div class="cmp up">{{ _('trend') }}</div></div></div>
      <div class="card"><div class="icon"><i class="fa-solid fa-utensils"></i></div><div><div class="label">{{ _('Meals Sold (This Month)') }}</div><div class="num">{{ '{:,.0f}'.format(kpi.total_meals_sold_month or 0) }}</div><div class="cmp up">{{ _('live') }}</div></div></div>
      <div class="card"><div class="icon"><i class="fa-solid fa-coins"></i></div><div><div class="label">{{ _('Estimated Meal Cost') }}</div><div class="num">{{ '{:,.2f}'.format(kpi.estimated_total_meal_cost or 0) }}</div><div class="cmp down"><i class="fa-solid fa-triangle-exclamation me-1"></i>{{ _('cost based on latest recipe prices') }}</div></div></div>
      <div class="card"><div class="icon"><i class="fa-solid fa-chart-line"></i></div><div><div class="label">{{ _('Total Profit (Sales - Prod Cost)') }}</div><div class="num">{{ '{:,.2f}'.format(kpi.total_profit_generated or 0) }}</div><div class="cmp up">{{ _('live margin') }}</div></div></div>
    </div>
  </div>

  <div class="sec">
    <h5 class="mb-2">{{ _('Purchases Summary') }}</h5>
    <div class="filters">
      <span class="chip">{{ _('Date Range') }}</span>
      <span class="chip">{{ _('Supplier') }}</span>
      <span class="chip">{{ _('Ingredient Category') }}</span>
    </div>
    <div class="table-responsive">
      <table class="tbl">
        <thead>
          <tr>
            <th>{{ _('Date') }}</th>
            <th>{{ _('Invoice No') }}</th>
            <th>{{ _('Supplier') }}</th>
            <th>{{ _('Payment') }}</th>
            <th>{{ _('Status') }}</th>
            <th class="text-end">{{ _('Subtotal') }}</th>
            <th class="text-end">{{ _('VAT') }}</th>
            <th class="text-end">{{ _('Discount') }}</th>
            <th class="text-end">{{ _('Final Total') }}</th>
            <th class="text-center">{{ _('Items') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for r in purchases %}
          <tr>
            <td>{{ r.date }}</td>
            <td>{{ r.invoice_number }}</td>
            <td>{{ r.supplier }}</td>
            <td>{{ r.payment_method }}</td>
            <td>{{ r.status }}</td>
            <td class="text-end">{{ '{:,.2f}'.format(r.subtotal or 0) }}</td>
            <td class="text-end">{{ '{:,.2f}'.format(r.vat or 0) }}</td>
            <td class="text-end">{{ '{:,.2f}'.format(r.discount or 0) }}</td>
            <td class="text-end">{{ '{:,.2f}'.format(r.final_total or 0) }}</td>
            <td class="text-center">{{ r.items_count }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="row mt-3">
      <div class="col-md-6">
        <h6 class="mb-2">{{ _('Top Purchased Ingredients') }}</h6>
        <div class="bar-chart">
          {% for b in top_ingredients %}
            <div class="bar">
              <div class="name">{{ b.name }}</div>
              {% set pct = (b.total / (top_ingredients[0].total or 1)) if top_ingredients %}
              <div class="val" style="width: {{ (pct * 100)|round(1) }}%"></div>
              <div class="num">{{ '{:,.2f}'.format(b.total or 0) }}</div>
            </div>
          {% endfor %}
        </div>
      </div>
      <div class="col-md-6">
        <h6 class="mb-2">{{ _('Purchase Trend') }}</h6>
        <div class="spark">
          {% for p in purchase_trend %}
          {% set h = (p.total / (purchase_trend|map(attribute='total')|max if purchase_trend else 1)) * 38 %}
          <div class="pt" title="{{ p.date }}" style="height: {{ h|round(1) }}px"></div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="sec">
    <h5 class="mb-2">{{ _('Meal Cost & Sales Analysis') }}</h5>
    <div class="alert mb-2"><i class="fa-solid fa-triangle-exclamation me-2"></i>{{ _('Cost may vary due to outdated ingredient prices') }}</div>
    {% if outdated_meals and outdated_meals|length > 0 %}
      <div class="alert"><i class="fa-solid fa-triangle-exclamation me-2"></i>{{ _('Meals using ingredients with outdated cost data') }}: {{ outdated_meals|join(', ') }}</div>
    {% endif %}
    <div class="table-responsive">
      <table class="tbl">
        <thead>
          <tr>
            <th>{{ _('Meal') }}</th>
            <th class="text-center">{{ _('Sales Count') }}</th>
            <th class="text-end">{{ _('Consumption Cost') }}</th>
            <th class="text-end">{{ _('Revenue') }}</th>
            <th class="text-end">{{ _('Profit') }}</th>
            <th class="text-end">{{ _('Margin %%') }}</th>
            <th>{{ _('Contribution') }}</th>
          </tr>
        </thead>
        <tbody>
          {% set total_profit = meals_analysis|map(attribute='profit')|sum if meals_analysis else 0 %}
          {% for m in meals_analysis %}
          {% set margin = (100 * (m.profit / m.revenue)) if m.revenue else 0 %}
          {% set contrib = (100 * (m.profit / total_profit)) if total_profit else 0 %}
          <tr>
            <td>{{ m.meal_name }}</td>
            <td class="text-center">{{ '{:,.0f}'.format(m.sold_qty or 0) }}</td>
            <td class="text-end">{{ '{:,.2f}'.format(m.consumption_cost or 0) }}</td>
            <td class="text-end">{{ '{:,.2f}'.format(m.revenue or 0) }}</td>
            <td class="text-end">{{ '{:,.2f}'.format(m.profit or 0) }}</td>
            <td class="text-end">{{ '{:,.1f}'.format(margin) }}%</td>
            <td>{{ '{:,.1f}'.format(contrib) }}%</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="sec">
    <h5 class="mb-2">{{ _('Dynamic Stock Analysis') }}</h5>
    <div class="flow">
      <div class="box"><i class="fa-solid fa-boxes-stacked me-2"></i>{{ _('Initial Stock') }}</div>
      <div class="arrow">➕ ➖</div>
      <div class="box">{{ _('Purchases ➖ Estimated Usage') }}</div>
    </div>
    <div class="table-responsive mt-2">
      <table class="tbl">
        <thead>
          <tr>
            <th>{{ _('Ingredient') }}</th>
            <th class="text-end">{{ _('Opening Qty') }}</th>
            <th class="text-end">{{ _('Purchases Qty') }}</th>
            <th class="text-end">{{ _('Estimated Usage') }}</th>
            <th class="text-end">{{ _('Expected Stock') }}</th>
            <th>{{ _('Risk') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for r in stock_rows %}
          <tr>
            <td>{{ r.ingredient }}</td>
            <td class="text-end">{{ '{:,.3f}'.format(r.opening_qty or 0) }}</td>
            <td class="text-end">{{ '{:,.3f}'.format(r.purchases_qty or 0) }}</td>
            <td class="text-end">{{ '{:,.3f}'.format(r.estimated_usage or 0) }}</td>
            <td class="text-end">{{ '{:,.3f}'.format(r.expected_stock or 0) }}</td>
            <td><span class="risk {{ r.risk }}">{% if r.risk == 'ok' %}{{ _('Ok') }}{% elif r.risk == 'low' %}{{ _('Low') }}{% elif r.risk == 'excess' %}{{ _('Excess') }}{% else %}{{ r.risk|capitalize }}{% endif %}</span></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<script>
// Minimal micro-animations for section reveal
document.querySelectorAll('.sec').forEach(function(sec){
  sec.style.opacity = '0'; sec.style.transform = 'translateY(6px)';
});
var io = new IntersectionObserver(function(entries){
  entries.forEach(function(e){ if(e.isIntersecting){ e.target.style.transition = 'all .35s ease'; e.target.style.opacity = '1'; e.target.style.transform = 'translateY(0)'; } });
}, { threshold:.12 });
document.querySelectorAll('.sec').forEach(function(sec){ io.observe(sec); });
</script>

{% endblock %}

