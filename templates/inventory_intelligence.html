{% extends 'base.html' %}
{% block title %}{{ _('Inventory & Production Cost Intelligence / Ø°ÙƒØ§Ø¡ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ù†ØªØ§Ø¬') }}{% endblock %}
{% block content %}

<style>
:root{
  --bg:#ffffff; --card:#fff; --muted:#5c6773; --accent:#0d6efd; --danger:#dc3545; --ok:#28a745; --warn:#ffc107;
}
.intel-wrap{ max-width:1440px; margin:0 auto; padding:16px }
.sec{ background:var(--card); border:1px solid rgba(0,0,0,.06); border-radius:20px; box-shadow:0 14px 40px rgba(18,22,33,.06); padding:18px; margin-bottom:16px }
.grid{ display:grid; gap:12px }
.grid.kpi{ grid-template-columns:repeat(5, minmax(160px, 1fr)) }
.card{ border-radius:16px; background:#fff; padding:16px; box-shadow:0 10px 26px rgba(18,22,33,.06); display:flex; align-items:center; gap:12px; transition:transform .2s ease }
.card:hover{ transform:translateY(-2px) }
.icon{ font-size:26px }
.num{ font-weight:700; font-size:22px }
.label{ color:var(--muted); font-size:13px }
.cmp{ font-size:12px }
.cmp.up{ color:var(--ok) } .cmp.down{ color:var(--danger) }
.table-responsive{ border-radius:12px; overflow:auto }
table.tbl{ width:100%; border-collapse:separate; border-spacing:0 }
table.tbl th, table.tbl td{ padding:10px 12px; border-bottom:1px solid rgba(0,0,0,.06); font-size:13px }
table.tbl th{ background:#f8fafc; position:sticky; top:0; z-index:1 }
.filters{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px }
.chip{ display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border:1px solid rgba(0,0,0,.08); border-radius:999px; font-size:12px; background:#fff }
.bar-chart{ display:flex; flex-direction:column; gap:6px }
.bar{ display:flex; align-items:center; gap:8px }
.bar .name{ width:220px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.bar .val{ flex:1; background:linear-gradient(90deg, #0d6efd, #6610f2); height:10px; border-radius:6px; position:relative }
.bar .val::after{ content:''; position:absolute; right:0; top:0; bottom:0; width:2px; background:rgba(255,255,255,.9); border-radius:2px }
.spark{ display:flex; align-items:flex-end; gap:3px; height:42px }
.spark .pt{ width:12px; background:#0d6efd; border-radius:3px }
.alert{ padding:12px 14px; border-radius:12px; background:#fff3cd; border:1px solid #ffeeba; color:#664d03; font-size:13px }
.flow{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; align-items:center; text-align:center; margin-top:12px }
.flow .box{ background:#f8fafc; border:1px dashed rgba(0,0,0,.12); border-radius:12px; padding:12px }
.arrow{ font-size:22px; color:#0d6efd }
.risk.low{ color:var(--danger); font-weight:700 }
.risk.excess{ color:#6610f2; font-weight:700 }
.risk.ok{ color:var(--ok); font-weight:700 }
@media (max-width:1024px){ .grid.kpi{ grid-template-columns:repeat(2, 1fr) } }
</style>

<div class="intel-wrap" dir="auto">
  <div class="sec">
    <h5 class="mb-3">{{ _('KPI Overview / Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©') }}</h5>
    <div class="grid kpi">
      <div class="card"><div class="icon">ğŸ“¦</div><div><div class="label">{{ _('Total Inventory Cost / Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†') }}</div><div class="num">{{ '{:,.2f}'.format(kpi.total_inventory_cost or 0) }}</div><div class="cmp up">{{ _('vs last period / Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©') }}</div></div></div>
      <div class="card"><div class="icon">ğŸ§¾</div><div><div class="label">{{ _('Ingredient Purchases (This Month) / Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ§Ø¯ (Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)') }}</div><div class="num">{{ '{:,.2f}'.format(kpi.total_purchases_month or 0) }}</div><div class="cmp up">{{ _('trend / Ø§Ù„Ø§ØªØ¬Ø§Ù‡') }}</div></div></div>
      <div class="card"><div class="icon">ğŸ½</div><div><div class="label">{{ _('Meals Sold (This Month) / Ø§Ù„ÙˆØ¬Ø¨Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© (Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)') }}</div><div class="num">{{ '{:,.0f}'.format(kpi.total_meals_sold_month or 0) }}</div><div class="cmp up">{{ _('live / ÙÙˆØ±ÙŠ') }}</div></div></div>
      <div class="card"><div class="icon">ğŸ’°</div><div><div class="label">{{ _('Estimated Meal Cost / ØªÙ‚Ø¯ÙŠØ± ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ù†ØªØ§Ø¬') }}</div><div class="num">{{ '{:,.2f}'.format(kpi.estimated_total_meal_cost or 0) }}</div><div class="cmp down">âš  {{ _('cost based on latest recipe prices / Ø§Ù„ØªÙƒÙ„ÙØ© Ø­Ø³Ø¨ Ø¢Ø®Ø± Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª') }}</div></div></div>
      <div class="card"><div class="icon">ğŸ“Š</div><div><div class="label">{{ _('Total Profit (Sales - Prod Cost) / Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­') }}</div><div class="num">{{ '{:,.2f}'.format(kpi.total_profit_generated or 0) }}</div><div class="cmp up">{{ _('live margin / Ù‡Ø§Ù…Ø´ ÙÙˆØ±ÙŠ') }}</div></div></div>
    </div>
  </div>

  <div class="sec">
    <h5 class="mb-2">{{ _('Purchases Summary / Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª') }}</h5>
    <div class="filters">
      <span class="chip">{{ _('Date Range / Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ®') }}</span>
      <span class="chip">{{ _('Supplier / Ø§Ù„Ù…ÙˆØ±Ø¯') }}</span>
      <span class="chip">{{ _('Ingredient Category / ÙØ¦Ø© Ø§Ù„Ù…ÙƒÙˆÙ†') }}</span>
    </div>
    <div class="table-responsive">
      <table class="tbl">
        <thead>
          <tr>
            <th>{{ _('Date / Ø§Ù„ØªØ§Ø±ÙŠØ®') }}</th>
            <th>{{ _('Invoice No / Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©') }}</th>
            <th>{{ _('Supplier / Ø§Ù„Ù…ÙˆØ±Ø¯') }}</th>
            <th>{{ _('Payment / Ø§Ù„Ø¯ÙØ¹') }}</th>
            <th>{{ _('Status / Ø§Ù„Ø­Ø§Ù„Ø©') }}</th>
            <th class="text-end">{{ _('Subtotal') }}</th>
            <th class="text-end">{{ _('VAT') }}</th>
            <th class="text-end">{{ _('Discount') }}</th>
            <th class="text-end">{{ _('Final Total') }}</th>
            <th class="text-center">{{ _('Items') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for r in purchases %}
          <tr>
            <td>{{ r.date }}</td>
            <td>{{ r.invoice_number }}</td>
            <td>{{ r.supplier }}</td>
            <td>{{ r.payment_method }}</td>
            <td>{{ r.status }}</td>
            <td class="text-end">{{ '{:,.2f}'.format(r.subtotal or 0) }}</td>
            <td class="text-end">{{ '{:,.2f}'.format(r.vat or 0) }}</td>
            <td class="text-end">{{ '{:,.2f}'.format(r.discount or 0) }}</td>
            <td class="text-end">{{ '{:,.2f}'.format(r.final_total or 0) }}</td>
            <td class="text-center">{{ r.items_count }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="row mt-3">
      <div class="col-md-6">
        <h6 class="mb-2">{{ _('Top Purchased Ingredients / Ø£ÙƒØ«Ø± Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø´Ø±Ø§Ø¡Ù‹') }}</h6>
        <div class="bar-chart">
          {% for b in top_ingredients %}
            <div class="bar">
              <div class="name">{{ b.name }}</div>
              {% set pct = (b.total / (top_ingredients[0].total or 1)) if top_ingredients %}
              <div class="val" style="width: {{ (pct * 100)|round(1) }}%"></div>
              <div class="num">{{ '{:,.2f}'.format(b.total or 0) }}</div>
            </div>
          {% endfor %}
        </div>
      </div>
      <div class="col-md-6">
        <h6 class="mb-2">{{ _('Purchase Trend / Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª') }}</h6>
        <div class="spark">
          {% for p in purchase_trend %}
          {% set h = (p.total / (purchase_trend|map(attribute='total')|max if purchase_trend else 1)) * 38 %}
          <div class="pt" title="{{ p.date }}" style="height: {{ h|round(1) }}px"></div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="sec">
    <h5 class="mb-2">{{ _('Meal Cost & Sales Analysis / ØªØ­Ù„ÙŠÙ„ ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ¬Ø¨Ø§Øª ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª') }}</h5>
    <div class="alert mb-2">âš  {{ _('Cost may vary due to outdated ingredient prices / Ù‚Ø¯ ØªØ®ØªÙ„Ù Ø§Ù„ØªÙƒÙ„ÙØ© Ø¨Ø³Ø¨Ø¨ Ø£Ø³Ø¹Ø§Ø± Ù‚Ø¯ÙŠÙ…Ø©') }}</div>
    {% if outdated_meals and outdated_meals|length > 0 %}
      <div class="alert">âš  {{ _('Meals using ingredients with outdated cost data / ÙˆØ¬Ø¨Ø§Øª ØªØ­ØªÙˆÙŠ Ù…ÙƒÙˆÙ†Ø§Øª Ø¨Ø³Ø¹Ø± Ù‚Ø¯ÙŠÙ…') }}: {{ outdated_meals|join(', ') }}</div>
    {% endif %}
    <div class="table-responsive">
      <table class="tbl">
        <thead>
          <tr>
            <th>{{ _('Meal / Ø§Ù„ÙˆØ¬Ø¨Ø©') }}</th>
            <th class="text-center">{{ _('Sales Count / Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª') }}</th>
            <th class="text-end">{{ _('Consumption Cost / ØªÙƒÙ„ÙØ© Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ') }}</th>
            <th class="text-end">{{ _('Revenue / Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯') }}</th>
            <th class="text-end">{{ _('Profit / Ø§Ù„Ø±Ø¨Ø­') }}</th>
            <th class="text-end">{{ _('Margin % / Ø§Ù„Ù‡Ø§Ù…Ø´ %') }}</th>
            <th>{{ _('Contribution / Ø§Ù„Ù…Ø³Ø§Ù‡Ù…Ø©') }}</th>
          </tr>
        </thead>
        <tbody>
          {% set total_profit = meals_analysis|map(attribute='profit')|sum if meals_analysis else 0 %}
          {% for m in meals_analysis %}
          {% set margin = (100 * (m.profit / m.revenue)) if m.revenue else 0 %}
          {% set contrib = (100 * (m.profit / total_profit)) if total_profit else 0 %}
          <tr>
            <td>{{ m.meal_name }}</td>
            <td class="text-center">{{ '{:,.0f}'.format(m.sold_qty or 0) }}</td>
            <td class="text-end">{{ '{:,.2f}'.format(m.consumption_cost or 0) }}</td>
            <td class="text-end">{{ '{:,.2f}'.format(m.revenue or 0) }}</td>
            <td class="text-end">{{ '{:,.2f}'.format(m.profit or 0) }}</td>
            <td class="text-end">{{ '{:,.1f}'.format(margin) }}%</td>
            <td>{{ '{:,.1f}'.format(contrib) }}%</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="sec">
    <h5 class="mb-2">{{ _('Dynamic Stock Analysis / ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ') }}</h5>
    <div class="flow">
      <div class="box">ğŸ“¦ {{ _('Initial Stock / Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ') }}</div>
      <div class="arrow">â• â–</div>
      <div class="box">{{ _('Purchases â– Estimated Usage / Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª â– Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ') }}</div>
    </div>
    <div class="table-responsive mt-2">
      <table class="tbl">
        <thead>
          <tr>
            <th>{{ _('Ingredient / Ø§Ù„Ù…ÙƒÙˆÙ†') }}</th>
            <th class="text-end">{{ _('Opening Qty / Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠØ©') }}</th>
            <th class="text-end">{{ _('Purchases Qty / ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª') }}</th>
            <th class="text-end">{{ _('Estimated Usage / Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ') }}</th>
            <th class="text-end">{{ _('Expected Stock / Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹') }}</th>
            <th>{{ _('Risk / Ø§Ù„Ù…Ø®Ø§Ø·Ø±') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for r in stock_rows %}
          <tr>
            <td>{{ r.ingredient }}</td>
            <td class="text-end">{{ '{:,.3f}'.format(r.opening_qty or 0) }}</td>
            <td class="text-end">{{ '{:,.3f}'.format(r.purchases_qty or 0) }}</td>
            <td class="text-end">{{ '{:,.3f}'.format(r.estimated_usage or 0) }}</td>
            <td class="text-end">{{ '{:,.3f}'.format(r.expected_stock or 0) }}</td>
            <td><span class="risk {{ r.risk }}">{{ r.risk|capitalize }}</span></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<script>
// Minimal micro-animations for section reveal
document.querySelectorAll('.sec').forEach(function(sec){
  sec.style.opacity = '0'; sec.style.transform = 'translateY(6px)';
});
var io = new IntersectionObserver(function(entries){
  entries.forEach(function(e){ if(e.isIntersecting){ e.target.style.transition = 'all .35s ease'; e.target.style.opacity = '1'; e.target.style.transform = 'translateY(0)'; } });
}, { threshold:.12 });
document.querySelectorAll('.sec').forEach(function(sec){ io.observe(sec); });
</script>

{% endblock %}

