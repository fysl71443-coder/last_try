{% extends "base.html" %}
{% block title %}{{ _('Customer Statement') }} — {{ customer.name }}{% endblock %}
{% block content %}
<style>
  /* تخطيط احترافي للكشف — شاشة وطباعة */
  .stmt-doc { font-family: 'Cairo', 'Tajawal', sans-serif; color: #1f2937; }
  .stmt-doc .report-header-unified { border-bottom: 2px solid #1f2937; padding-bottom: 0.75rem; margin-bottom: 1rem; }
  .stmt-doc .report-header-company { font-size: 1.2rem; font-weight: 700; color: #1f2937; }
  .stmt-doc .stmt-title { font-size: 1.25rem; font-weight: 700; margin: 0 0 0.5rem 0; }
  .stmt-doc .stmt-meta { font-size: 0.9rem; color: #374151; margin-bottom: 1rem; }
  .stmt-doc .stmt-customer-box {
    background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;
    padding: 0.75rem 1rem; margin-bottom: 1rem;
  }
  .stmt-doc .stmt-customer-box .label { font-weight: 600; color: #374151; }
  .stmt-doc .stmt-summary {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0.75rem; margin-bottom: 1rem;
    padding: 0.75rem 1rem; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 6px;
  }
  .stmt-doc .stmt-summary-item { font-size: 0.9rem; }
  .stmt-doc .stmt-summary-item .val { font-weight: 700; font-variant-numeric: tabular-nums; }
  .stmt-doc .stmt-summary-item.remaining .val { color: #b91c1c; }
  .stmt-doc .stmt-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
  .stmt-doc .stmt-table th, .stmt-doc .stmt-table td { padding: 0.5rem 0.6rem; border: 1px solid #d1d5db; text-align: right; }
  .stmt-doc .stmt-table thead th { background: #374151; color: #fff; font-weight: 600; }
  .stmt-doc .stmt-table tbody tr:nth-child(even) { background: #f9fafb; }
  .stmt-doc .stmt-table .mono { font-variant-numeric: tabular-nums; }
  .stmt-doc .stmt-footer { margin-top: 1.5rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb; font-size: 0.85rem; color: #6b7280; }
  @page { size: A4; margin: 14mm; }
  @media print {
    .no-print { display: none !important; }
    body, .stmt-doc, .stmt-doc * { color: #000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .stmt-doc .report-header-unified { border-color: #000 !important; }
    .stmt-doc .stmt-table th, .stmt-doc .stmt-table td { border-color: #333 !important; }
    .stmt-doc .stmt-table thead th { background: #333 !important; color: #fff !important; }
    .stmt-doc .stmt-customer-box, .stmt-doc .stmt-summary { background: #f5f5f5 !important; border-color: #333 !important; }
    .stmt-doc .stmt-summary-item.remaining .val { color: #000 !important; font-weight: 700; }
    tr { page-break-inside: avoid; }
  }
</style>
<div class="container py-4 ops-layout hub-wrap">
  <div class="ops-header-bar no-print">
    <span class="ops-icon"><i class="fa-solid fa-file-invoice-dollar"></i></span>
    <div>
      <h1 class="ops-title mb-0">{{ _('Customer Statement') }}</h1>
      <span class="ops-subtitle">{{ customer.name }}{% if customer.phone %} — {{ customer.phone }}{% endif %}</span>
    </div>
    <div class="ops-actions">
      <a href="{{ url_for('customers.customers') }}" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-users me-1"></i>{{ _('Customers') }}</a>
      <button type="button" class="btn btn-sm btn-primary" onclick="window.print()"><i class="fa-solid fa-print me-1"></i>{{ _('Print') }}</button>
    </div>
  </div>

  <div class="no-print mb-3">
    <div class="ops-form-card">
      <div class="ops-form-head">{{ _('Period') }}</div>
      <div class="ops-form-body">
        <form class="row g-3 align-items-end" method="get">
          <div class="col-md-3">
            <label class="form-label">{{ _('Start Date') }}</label>
            <input type="date" class="form-control" name="start_date" value="{{ start_date }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">{{ _('End Date') }}</label>
            <input type="date" class="form-control" name="end_date" value="{{ end_date }}">
          </div>
          <div class="col-md-3">
            <button class="btn btn-primary" type="submit"><i class="fa-solid fa-filter me-1"></i>{{ _('Filter') }}</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="stmt-doc">
    {# ترويسة رسمية: اسم الشركة والرقم الضريبي والبيانات #}
    <div class="report-header-unified border-bottom pb-3 mb-3" style="border-color: #1f2937 !important;">
      <div class="d-flex flex-wrap align-items-center gap-3">
        {% if show_logo and logo_url %}
        <img src="{{ logo_url }}" alt="logo" class="report-header-logo" style="height: 52px; max-width: 160px; object-fit: contain;" />
        {% endif %}
        <div>
          <h2 class="report-header-company mb-1" style="font-size: 1.25rem; font-weight: 700; color: #1f2937; margin: 0;">{{ company_name or 'Company' }}</h2>
          {% if tax_number %}<div class="report-header-tax small text-muted">الرقم الضريبي: {{ tax_number }}</div>{% endif %}
          {% if address %}<div class="report-header-address small text-muted">{{ address }}</div>{% endif %}
          {% if phone %}<div class="report-header-phone small text-muted">هاتف: {{ phone }}</div>{% endif %}
          {% if email %}<div class="report-header-email small text-muted">بريد: {{ email }}</div>{% endif %}
        </div>
      </div>
    </div>

    <h2 class="stmt-title">كشف حساب عميل</h2>
    <div class="stmt-meta">الفترة: {{ start_date }} — {{ end_date }} · تاريخ الإصدار: {{ generated_at }}</div>

    <div class="stmt-customer-box">
      <span class="label">{{ _('Customer') }}:</span> {{ customer.name }}
      {% if customer.phone %}<span class="ms-2">|</span> هاتف: {{ customer.phone }}{% endif %}
      {% if customer_email %}<span class="ms-2">|</span> {{ customer_email }}{% endif %}
    </div>

    <div class="stmt-summary">
      <div class="stmt-summary-item"><span class="text-muted">{{ _('Opening') }}:</span> <span class="val">{{ '%.2f'|format(opening_balance) }}</span> ر.س</div>
      <div class="stmt-summary-item"><span class="text-muted">{{ _('Total Invoices') }}:</span> <span class="val">{{ '%.2f'|format(total_invoices) }}</span> ر.س</div>
      <div class="stmt-summary-item"><span class="text-muted">{{ _('Total Paid') }}:</span> <span class="val">{{ '%.2f'|format(total_paid) }}</span> ر.س</div>
      <div class="stmt-summary-item remaining"><span class="text-muted">{{ _('Remaining') }}:</span> <span class="val">{{ '%.2f'|format(remaining) }}</span> ر.س</div>
    </div>

    <div class="table-responsive">
      <table class="stmt-table">
        <thead>
          <tr>
            <th>{{ _('Date') }}') }} / المرجع</th>
            <th>{{ _('Description') }}') }} / مدين</th>
            <th class="text-end mono">{{ _('Credit') }}') }} / الرصيد</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr>
            <td>{{ r.date }}</td>
            <td>{{ r.ref }}</td>
            <td>{{ r.desc }}</td>
            <td class="text-end mono">{{ '%.2f'|format(r.debit or 0) }}</td>
            <td class="text-end mono">{{ '%.2f'|format(r.credit or 0) }}</td>
            <td class="text-end mono">{{ '%.2f'|format(r.balance or 0) }}</td>
          </tr>
          {% else %}
          <tr><td colspan="6" class="text-center text-muted py-3">لا توجد حركات في الفترة المحددة</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="stmt-footer">
      {{ _('Issue date') }}: {{ generated_at }} — {{ _('Credit customer statement (invoices and payments)') }}
    </div>
  </div>
</div>
{% endblock %}
