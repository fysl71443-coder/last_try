{% extends 'base.html' %}
{% block title %}إدارة المستخدمين والصلاحيات{% endblock %}
{% block content %}
<div class="container py-4 ops-layout hub-wrap">
  <div class="ops-header-bar">
    <span class="ops-icon"><i class="fa fa-users"></i></span>
    <div>
      <h1 class="ops-title mb-0">إدارة المستخدمين والصلاحيات</h1>
      <span class="ops-subtitle">المستخدمون، الأدوار والصلاحيات</span>
    </div>
    <div class="ops-actions d-flex flex-wrap gap-2">
      <a href="{{ url_for('main.dashboard') }}" class="btn btn-sm btn-outline-secondary" data-partial><i class="fa-solid fa-house me-1"></i> {{ _('Dashboard') }}</a>
      {% if can('users','add') %}
      <button type="button" class="btn btn-sm btn-primary" id="btnAdd"><i class="fa-solid fa-user-plus me-1"></i> {{ _('Add user') }}</button>
      {% endif %}
      {% if can('users','edit') %}
      <button type="button" class="btn btn-sm btn-outline-secondary" id="btnEdit" disabled><i class="fa-solid fa-pen me-1"></i> {{ _('Edit') }}</button>
      {% endif %}
      {% if can('users','delete') %}
      <button type="button" class="btn btn-sm btn-outline-danger" id="btnDelete" disabled><i class="fa-solid fa-trash me-1"></i> {{ _('Delete') }}</button>
      {% endif %}
      {% if can('users','edit') %}
      <button type="button" class="btn btn-sm btn-outline-secondary" id="btnPerms" disabled><i class="fa-solid fa-shield-halved me-1"></i> {{ _('Permissions') }}</button>
      {% endif %}
    </div>
  </div>

  <div class="ops-form-card mt-0">
    <div class="ops-form-head">{{ _('Users list') }}</div>
    <div class="ops-form-body">
      <div class="row g-3 align-items-center mb-3">
        <div class="col-md-4"><input type="text" class="form-control form-control-sm" id="searchBox" placeholder="بحث..."></div>
        <div class="col-md-8 text-end"><small class="text-muted">تلميح: استخدم البحث والترتيب لتسهيل الوصول</small></div>
      </div>
      <div class="table-responsive screen-table-wrap">
        <table class="table table-hover screen-table mb-0" id="usersTable">
          <thead>
            <tr>
              <th><input type="checkbox" id="selAll"></th>
              <th>الاسم / اسم الدخول</th>
              <th>البريد</th>
              <th>الدور</th>
              <th>الحالة</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody>
            {% for u in users %}
            <tr data-id="{{ u.id }}" data-active="{{ 1 if u.active else 0 }}" data-username="{{ u.username }}" data-email="{{ u.email or '' }}" data-role="{{ u.role or 'user' }}">
              <td><input type="checkbox" class="rowSel"></td>
              <td>{{ u.username }}</td>
              <td>{{ u.email or '-' }}</td>
              <td>{{ u.role or '-' }}</td>
              <td>
                {% if u.active %}
                <span class="badge text-bg-success">نشط</span>
                {% else %}
                <span class="badge text-bg-secondary">غير نشط</span>
                {% endif %}
              </td>
              <td>
                {% if can('users','edit') %}
                <button type="button" class="btn btn-sm btn-outline-primary me-1" title="تعديل بيانات الدخول وكلمة المرور" data-action="edit"><i class="fa-solid fa-pen"></i></button>
                <button type="button" class="btn btn-sm btn-outline-secondary me-1" title="الصلاحيات" data-action="perms"><i class="fa-solid fa-shield-halved"></i></button>
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr><td colspan="6" class="text-center">لا يوجد مستخدمون</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
        <div><button class="btn btn-outline-secondary btn-sm" id="prevPage">السابق</button><button class="btn btn-outline-secondary btn-sm" id="nextPage">التالي</button><span class="ms-2" id="pageInfo"></span></div>
        <div><small class="text-muted">ترتيب بالضغط على رأس العمود</small></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal: إدارة الصلاحيات -->
<div class="modal fade screen-modal" id="permsModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa fa-shield-halved me-2"></i> إدارة الصلاحيات</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <button class="btn btn-outline-secondary btn-sm" id="checkAll">تحديد الكل</button>
            <button class="btn btn-outline-secondary btn-sm" id="uncheckAll">إلغاء الكل</button>
          </div>
          <div class="d-flex gap-2">
            <select id="branchSelect" class="form-select form-select-sm">
              <option value="all">جميع الفروع</option>
              <option value="place_india">فرع Place India</option>
              <option value="china_town">فرع China Town</option>
            </select>
          </div>
        </div>
        <div id="screensList" class="list-group">
          <!-- سيتم ملؤها جافاسكربت -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
        <button class="btn btn-success" id="savePerms">حفظ</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: إضافة/تعديل مستخدم -->
<div class="modal fade" id="userModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="userModalTitle">مستخدم جديد</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="userFormAlert" class="alert alert-danger d-none"></div>
        <form id="userForm">
          <div class="mb-2">
            <label class="form-label">اسم المستخدم</label>
            <input type="text" class="form-control" id="uf_username" required />
          </div>
          <div class="mb-2">
            <label class="form-label">البريد الإلكتروني</label>
            <input type="email" class="form-control" id="uf_email" placeholder="اختياري" />
          </div>
          <div class="mb-2">
            <label class="form-label">الدور</label>
            <select class="form-select" id="uf_role">
              <option value="user">User</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="mb-2" id="pwGroup">
            <label class="form-label">كلمة المرور</label>
            <input type="password" class="form-control" id="uf_password" placeholder="••••••" minlength="4" autocomplete="new-password" />
            <div class="form-text" id="pwHelp">إلزامي عند الإضافة — عند التعديل اتركه فارغاً للإبقاء على كلمة المرور الحالية</div>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="uf_active" checked />
            <label class="form-check-label" for="uf_active">نشط</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
        <button class="btn btn-primary" id="userFormSubmit">حفظ</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}



{% block scripts %}
<script>
// Users page JS (bound after Bootstrap loaded)
(function(){
  const table = document.getElementById('usersTable');
  if(!table) return;
  const rows = Array.from(table.querySelectorAll('tbody tr'));
  const searchBox = document.getElementById('searchBox');
  const selAll = document.getElementById('selAll');
  const pageInfo = document.getElementById('pageInfo');
  const btnAdd = document.getElementById('btnAdd');
  const btnEdit = document.getElementById('btnEdit');
  const btnDelete = document.getElementById('btnDelete');
  const btnPerms = document.getElementById('btnPerms');

  // pagination + search
  let page=1, perPage=10;
  function render(){
    const q = searchBox.value.toLowerCase();
    let vis=0, start=(page-1)*perPage, end=start+perPage;
    rows.forEach((tr)=>{
      const txt = tr.innerText.toLowerCase();
      const match = txt.includes(q);
      tr.style.display = match? '' : 'none';
      if(match){
        if(vis>=start && vis<end){ tr.style.display=''; } else { tr.style.display='none'; }
        vis++;
      }
    });
    const total = rows.filter(r=>r.innerText.toLowerCase().includes(q)).length;
    const totalPages = Math.max(1, Math.ceil(total/perPage));
    if(page>totalPages){ page=totalPages; render(); return; }
    pageInfo.textContent = `صفحة ${page} من ${totalPages}`;
  }
  render();
  document.getElementById('prevPage').onclick=()=>{ if(page>1){ page--; render(); }};
  document.getElementById('nextPage').onclick=()=>{ page++; render(); };
  searchBox.addEventListener('input', ()=>{ page=1; render(); });

  // selection
  function updateToolbar(){
    const selected = table.querySelectorAll('.rowSel:checked');
    const any = selected.length>0; const single = selected.length===1;
    btnEdit.disabled = !single; btnDelete.disabled = !any; btnPerms.disabled = !single;
  }
  selAll.addEventListener('change', ()=>{
    table.querySelectorAll('.rowSel').forEach(cb=>{ cb.checked=selAll.checked; });
    updateToolbar();
  });
  table.addEventListener('change', (e)=>{ if(e.target.classList.contains('rowSel')) updateToolbar(); });

  // helpers
  async function api(method, url, body){
    const token = document.querySelector('meta[name="csrf-token"]')?.content;
    const headers = { 'Content-Type': 'application/json' };
    if(token){ headers['X-CSRFToken'] = token; }
    const res = await fetch(url, { method, headers, credentials:'same-origin', body: body?JSON.stringify(body):undefined });
    if(!res.ok){ const t=await res.text(); throw new Error(t||res.status); }
    return res.json();
  }
  function selectedIds(){ return Array.from(table.querySelectorAll('.rowSel:checked')).map(cb=>cb.closest('tr').dataset.id); }

  // actions
  const userModal = new bootstrap.Modal(document.getElementById('userModal'));
  const userForm = document.getElementById('userForm');
  const userFormSubmit = document.getElementById('userFormSubmit');
  const userFormAlert = document.getElementById('userFormAlert');
  const uf_username = document.getElementById('uf_username');
  const uf_email = document.getElementById('uf_email');
  const uf_role = document.getElementById('uf_role');
  const uf_password = document.getElementById('uf_password');
  const uf_active = document.getElementById('uf_active');
  const pwGroup = document.getElementById('pwGroup');
  const userModalTitle = document.getElementById('userModalTitle');
  let editId = null;

  btnAdd?.addEventListener('click', ()=>{
    editId = null; userModalTitle.textContent='مستخدم جديد';
    userForm.reset(); uf_active.checked=true; pwGroup.classList.remove('d-none');
    userFormAlert.classList.add('d-none');
    userModal.show();
  });

  function openEditModalForRow(row){
    if(!row || !row.dataset.id) return;
    editId = row.dataset.id;
    userModalTitle.textContent='تعديل مستخدم';
    uf_username.value = (row.dataset.username || row.children[1].innerText || '').trim();
    uf_username.readOnly = true;
    const emailVal = (row.dataset.email || row.children[2].innerText || '').trim();
    uf_email.value = (emailVal === '-' || !emailVal) ? '' : emailVal;
    uf_role.value = (row.dataset.role || 'user').toLowerCase();
    uf_active.checked = (row.dataset.active==='1');
    uf_password.value = '';
    pwGroup.classList.remove('d-none');
    userFormAlert.classList.add('d-none');
    userModal.show();
  }

  btnEdit?.addEventListener('click', ()=>{
    const ids = selectedIds(); if(ids.length!==1) return;
    const row = table.querySelector(`tr[data-id="${ids[0]}"]`);
    openEditModalForRow(row);
  });

  // نقر زر "تعديل" أو "الصلاحيات" داخل الصف: تحديد الصف ثم فتح النافذة المناسبة
  table.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-action]');
    if(!btn) return;
    const row = btn.closest('tr');
    if(!row || !row.dataset.id) return;
    table.querySelectorAll('.rowSel').forEach(cb=> cb.checked = false);
    const rowCb = row.querySelector('.rowSel');
    if(rowCb){ rowCb.checked = true; updateToolbar(); }
    if(btn.dataset.action === 'edit'){
      openEditModalForRow(row);
    } else if(btn.dataset.action === 'perms'){
      const uid = row.dataset.id;
      (async ()=>{
        try{
          const scope = document.getElementById('branchSelect').value;
          const res = await fetch(`/api/users/${uid}/permissions?branch_scope=${encodeURIComponent(scope)}`);
          const data = await res.json();
          list.querySelectorAll('.permCheck, .screenCheck').forEach(cb=>cb.checked=false);
          (data.items||[]).forEach(p=>{
            const hasAny = p.view||p.add||p.edit||p.delete||p.print;
            const scrCb = document.getElementById(`sc_${p.screen_key}`);
            if(scrCb) scrCb.checked = hasAny;
            ['view','add','edit','delete','print'].forEach(k=>{
              const el = document.getElementById(`${p.screen_key}_${k}`);
              if(el) el.checked = !!p[k];
            });
          });
          permsModal.show();
        }catch(err){ console.warn('load perms failed', err); }
      })();
    }
  });

  function apiErrorToMessage(err){
    const s = (err&&err.message) ? String(err.message) : String(err);
    if(/username_taken|username_password_required/i.test(s)) return 'اسم المستخدم مطلوب أو مستخدم بالفعل';
    if(/email_taken/i.test(s)) return 'البريد الإلكتروني مستخدم بالفعل';
    if(/not_found/i.test(s)) return 'المستخدم غير موجود';
    if(s.includes('400')||s.includes('404')) return s.replace(/^.*error[: ]*/i,'').trim() || 'حدث خطأ في الطلب';
    return s || 'حدث خطأ';
  }
  userFormSubmit.addEventListener('click', async ()=>{
    userFormAlert.classList.add('d-none');
    const payload = {
      username: uf_username.value.trim(),
      email: uf_email.value.trim()||null,
      role: uf_role.value,
      active: uf_active.checked
    };
    try{
      if(editId===null){
        if(!uf_password.value.trim()) throw new Error('كلمة المرور مطلوبة');
        payload.password = uf_password.value.trim();
        await api('POST','/api/users', payload);
      }else{
        const pw = uf_password.value.trim();
        if(pw){ payload.password = pw; }
        await api('PATCH', `/api/users/${editId}`, payload);
      }
      location.reload();
    }catch(e){
      userFormAlert.textContent = apiErrorToMessage(e);
      userFormAlert.classList.remove('d-none');
    }
  });
  btnDelete?.addEventListener('click', async ()=>{
    const ids = selectedIds(); if(ids.length===0) return;
    if(!confirm('تأكيد حذف المستخدمين المختارين؟')) return;
    try{ await api('DELETE','/api/users',{ids}); location.reload(); }catch(e){ alert('خطأ: '+e.message); }
  });

  // permissions modal
  const screens = [
    {key:'dashboard', name:'لوحة التحكم'},
    {key:'sales', name:'المبيعات'},
    {key:'purchases', name:'المشتريات'},
    {key:'inventory', name:'المخزون'},
    {key:'expenses', name:'المصروفات'},
    {key:'employees', name:'الموظفون'},
    {key:'salaries', name:'الرواتب'},
    {key:'financials', name:'القوائم المالية'},
    {key:'vat', name:'VAT'},
    {key:'reports', name:'التقارير'},
    {key:'invoices', name:'كل الفواتير'},
    {key:'payments', name:'المدفوعات والمستحقات'},
    {key:'customers', name:'العملاء'},
    {key:'menu', name:'المنيو'},
    {key:'settings', name:'الإعدادات'},
    {key:'suppliers', name:'الموردون'},
    {key:'table_settings', name:'إعدادات الطاولات'},
    {key:'users', name:'إدارة المستخدمين والصلاحيات'},
    {key:'sample_data', name:'إنشاء بيانات تجريبية'},
    {key:'archive', name:'الأرشفة'},
    {key:'journal', name:'قيود اليومية'}
  ];
  function permRow(scr){
    return `<div class="list-group-item">
      <div class="form-check">
        <input class="form-check-input screenCheck" type="checkbox" data-key="${scr.key}" id="sc_${scr.key}">
        <label class="form-check-label" for="sc_${scr.key}"><i class="fa fa-window-maximize me-1"></i> ${scr.name}</label>
      </div>
      <div class="row g-2 ms-4 mt-2">
        ${['view','add','edit','delete','print'].map(p=>`
          <div class='col-auto'>
            <div class='form-check form-check-inline'>
              <input class='form-check-input permCheck' type='checkbox' data-key='${scr.key}' data-perm='${p}' id='${scr.key}_${p}'>
              <label class='form-check-label' for='${scr.key}_${p}'>${p}</label>
            </div>
          </div>`).join('')}
      </div>
    </div>`;
  }
  const list = document.getElementById('screensList');
  list.innerHTML = screens.map(permRow).join('');
  document.getElementById('checkAll').onclick=()=>{ list.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=true); };
  document.getElementById('uncheckAll').onclick=()=>{ list.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=false); };

  // toggle all perms when screen checkbox changes, and keep header in sync (bound once)
  list.addEventListener('change', (e)=>{
    const t = e.target;
    if(t.classList.contains('screenCheck')){
      const row = t.closest('.list-group-item');
      row?.querySelectorAll('.permCheck').forEach(cb=> cb.checked = t.checked);
    }
    if(t.classList.contains('permCheck')){
      const row = t.closest('.list-group-item');
      const any = Array.from(row?.querySelectorAll('.permCheck')||[]).some(cb=>cb.checked);
      const header = row?.querySelector('.screenCheck');
      if(header) header.checked = any;
    }
  });

  const permsModal = new bootstrap.Modal(document.getElementById('permsModal'));
  btnPerms?.addEventListener('click', async ()=>{
    const ids = selectedIds(); if(ids.length!==1) return;
    const uid = ids[0];
    try{
      const scope = document.getElementById('branchSelect').value;
      const res = await fetch(`/api/users/${uid}/permissions?branch_scope=${encodeURIComponent(scope)}`);
      const data = await res.json();
      list.querySelectorAll('.permCheck, .screenCheck').forEach(cb=>cb.checked=false);
      (data.items||[]).forEach(p=>{
        const hasAny = p.view||p.add||p.edit||p.delete||p.print;
        const scrCb = document.getElementById(`sc_${p.screen_key}`);
        if(scrCb) scrCb.checked = hasAny;
        ['view','add','edit','delete','print'].forEach(k=>{
          const el = document.getElementById(`${p.screen_key}_${k}`);
          if(el) el.checked = !!p[k];
        });
      });
      permsModal.show();
    }catch(e){ console.warn('load perms failed', e); }
  });

  // branch change reloads perms if modal is open
  document.getElementById('branchSelect')?.addEventListener('change', async ()=>{
    const bsModalEl = document.getElementById('permsModal');
    if(!bsModalEl.classList.contains('show')) return;
    const ids = selectedIds(); if(ids.length!==1) return;
    const uid = ids[0];
    try{
      const scope = document.getElementById('branchSelect').value;
      const res = await fetch(`/api/users/${uid}/permissions?branch_scope=${encodeURIComponent(scope)}`);
      const data = await res.json();
      list.querySelectorAll('.permCheck, .screenCheck').forEach(cb=>cb.checked=false);
      (data.items||[]).forEach(p=>{
        const hasAny = p.view||p.add||p.edit||p.delete||p.print;
        const scrCb = document.getElementById(`sc_${p.screen_key}`);
        if(scrCb) scrCb.checked = hasAny;
        ['view','add','edit','delete','print'].forEach(k=>{
          const el = document.getElementById(`${p.screen_key}_${k}`);
          if(el) el.checked = !!p[k];
        });
      });
    }catch(e){ console.warn('reload perms failed', e); }
  });

  // save permissions (bind once)
  document.getElementById('savePerms')?.addEventListener('click', async ()=>{
    const ids = selectedIds(); if(ids.length!==1){ alert('اختر مستخدماً واحداً'); return; }
    const uid = ids[0];
    const scope = document.getElementById('branchSelect').value;
    const items = [];
    document.querySelectorAll('#screensList .list-group-item').forEach(item=>{
      const key = item.querySelector('.screenCheck').dataset.key;
      const obj = { screen_key:key };
      item.querySelectorAll('.permCheck').forEach(p=> obj[p.dataset.perm] = p.checked );
      items.push(obj);
    });
    try{
      await api('POST', `/api/users/${uid}/permissions`, { items, branch_scope: scope });
      permsModal.hide();
      alert('تم حفظ الصلاحيات');
    }catch(e){ alert('تعذر الحفظ: '+(e.message||e)); }
  });

})();
</script>
{% endblock %}
