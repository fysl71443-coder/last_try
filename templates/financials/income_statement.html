{% extends 'base.html' %}
{% block title %}قائمة الدخل{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h3 class="mb-0">قائمة الدخل / Income Statement</h3>
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-outline-secondary btn-sm" onclick="history.back()">رجوع / Back</button>
      <a class="btn btn-outline-primary btn-sm" href="{{ url_for('financials.balance_sheet') }}">المركز المالي / Balance Sheet</a>
      <a class="btn btn-outline-primary btn-sm" href="{{ url_for('financials.trial_balance') }}">ميزان المراجعة / Trial Balance</a>
      <a target="_blank" class="btn btn-outline-secondary btn-sm" href="/financials/print/income_statement?period={{ data.period }}&start_date={{ data.start_date }}&end_date={{ data.end_date }}&branch={{ data.branch or 'all' }}">طباعة / Print</a>
      <a target="_blank" class="btn btn-outline-success btn-sm" href="/financials/export/income_statement?period={{ data.period }}&start_date={{ data.start_date }}&end_date={{ data.end_date }}">تصدير CSV</a>
    </div>
  </div>

  <form method="get" class="row g-2 align-items-end mb-3">
    <div class="col-auto">
      <label class="form-label">الفترة</label>
      <select name="period" class="form-select">
        <option value="today" {% if data.period=='today' %}selected{% endif %}>اليوم</option>
        <option value="this_week" {% if data.period=='this_week' %}selected{% endif %}>هذا الأسبوع</option>
        <option value="this_month" {% if data.period=='this_month' %}selected{% endif %}>هذا الشهر</option>
        <option value="this_year" {% if data.period=='this_year' %}selected{% endif %}>هذه السنة</option>
        <option value="custom" {% if data.period=='custom' %}selected{% endif %}>مخصص</option>
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label">من تاريخ</label>
      <input type="date" name="start_date" class="form-control" value="{{ data.start_date if data.period=='custom' else '' }}" {{ '' if data.period=='custom' else 'disabled' }}>
    </div>
    <div class="col-auto">
      <label class="form-label">إلى تاريخ</label>
      <input type="date" name="end_date" class="form-control" value="{{ data.end_date if data.period=='custom' else '' }}" {{ '' if data.period=='custom' else 'disabled' }}>
    </div>
    <div class="col-auto">
      <label class="form-label">الفرع</label>
      <select name="branch" class="form-select">
        <option value="all" {% if (data.branch or 'all')=='all' %}selected{% endif %}>الكل</option>
        <option value="place_india" {% if data.branch=='place_india' %}selected{% endif %}>Place India</option>
        <option value="china_town" {% if data.branch=='china_town' %}selected{% endif %}>China Town</option>
      </select>
    </div>

    <div class="col-auto">
      <button class="btn btn-primary">عرض</button>
    </div>

  <div class="d-flex gap-2 mb-3"></div>

  </form>

  <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
    <span class="badge bg-light text-dark border">الفترة: {{ data.period }}</span>
    <span class="badge bg-light text-dark border">من: {{ data.start_date }}</span>
    <span class="badge bg-light text-dark border">إلى: {{ data.end_date }}</span>
  </div>

  {% set _all_zero = ( (data.revenue or 0)==0 and (data.cogs or 0)==0 and (data.operating_expenses or 0)==0 and (data.other_income or 0)==0 and (data.other_expenses or 0)==0 and (data.tax or 0)==0 ) %}
  {% if _all_zero %}
  <div class="alert alert-warning">لا توجد بيانات ضمن الفترة المحددة.</div>
  {% endif %}

  <div class="row g-3">
    <div class="col-6 col-md-3"><div class="card shadow-sm p-3 h-100"><div class="text-muted small">الإيرادات / Revenue</div><div class="fs-4 fw-bold text-end">{{ '%.2f'|format(data.revenue) }}</div></div></div>
    <div class="col-6 col-md-3"><div class="card shadow-sm p-3 h-100"><div class="text-muted small">تكلفة المبيعات / COGS</div><div class="fs-4 fw-bold text-end">{{ '%.2f'|format(data.cogs) }}</div></div></div>
    <div class="col-6 col-md-3"><div class="card shadow-sm p-3 h-100"><div class="text-muted small">الربح الإجمالي / Gross Profit</div><div class="fs-4 fw-bold text-end">{{ '%.2f'|format(data.gross_profit) }}</div></div></div>
    <div class="col-6 col-md-3"><div class="card shadow-sm p-3 h-100"><div class="text-muted small">المصاريف التشغيلية / Operating Expenses</div><div class="fs-4 fw-bold text-end">{{ '%.2f'|format(data.operating_expenses) }}</div></div></div>
    <div class="col-6 col-md-3"><div class="card shadow-sm p-3 h-100"><div class="text-muted small">الربح التشغيلي / Operating Profit</div><div class="fs-4 fw-bold text-end">{{ '%.2f'|format(data.operating_profit) }}</div></div></div>
    <div class="col-6 col-md-3"><div class="card shadow-sm p-3 h-100"><div class="text-muted small">دخل آخر / Other Income</div><div class="fs-4 fw-bold text-end">{{ '%.2f'|format(data.other_income) }}</div></div></div>
    <div class="col-6 col-md-3"><div class="card shadow-sm p-3 h-100"><div class="text-muted small">مصروفات أخرى / Other Expenses</div><div class="fs-4 fw-bold text-end">{{ '%.2f'|format(data.other_expenses) }}</div></div></div>
    <div class="col-6 col-md-3"><div class="card shadow-sm p-3 h-100"><div class="text-muted small">الربح قبل الضريبة / Profit Before Tax</div><div class="fs-4 fw-bold text-end">{{ '%.2f'|format(data.net_profit_before_tax) }}</div></div></div>
    <div class="col-6 col-md-3"><div class="card shadow-sm p-3 h-100"><div class="text-muted small">صافي ضريبة القيمة المضافة / VAT Net</div><div class="fs-4 fw-bold text-end">{{ '%.2f'|format((data.vat_net or 0)) }}</div></div></div>
    <div class="col-6 col-md-3"><div class="card shadow-sm p-3 h-100"><div class="text-muted small">ضريبة قيمة مضافة مستحقة / VAT Payable</div><div class="fs-4 fw-bold text-end">{{ '%.2f'|format(((data.vat_net or 0) if (data.vat_net or 0) > 0 else 0)) }}</div></div></div>
    <div class="col-6 col-md-3"><div class="card shadow-sm p-3 h-100"><div class="text-muted small">الربح بعد الضريبة / Profit After Tax</div><div class="fs-4 fw-bold text-end">{{ '%.2f'|format(data.net_profit_after_tax) }}</div></div></div>
  </div>

    <div class="card mt-3">
      <div class="card-header fw-semibold">ملخص المبيعات حسب الفرع / Branch Sales Summary</div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>الفرع / Branch</th>
                <th class="text-end">المبيعات الإجمالية / Gross Sales</th>
                <th class="text-end">الخصم الإجمالي / Total Discount</th>
              </tr>
            </thead>
            <tbody>
              {% for br, agg in (data.branch_totals or {}).items() %}
              <tr>
                {% set code = '4011' if br=='china_town' else ('4012' if br=='place_india' else None) %}
                <td>{% if br=='china_town' %}China Town{% elif br=='place_india' %}Place India{% else %}{{ br }}{% endif %}</td>
                <td class="text-end">{% if code %}<a href="{{ url_for('financials.account_statement') }}?code={{ code }}&start_date={{ data.start_date }}&end_date={{ data.end_date }}" class="text-decoration-none">{{ '%.2f'|format(agg.gross or 0) }}</a>{% else %}{{ '%.2f'|format(agg.gross or 0) }}{% endif %}</td>
                <td class="text-end"><a href="{{ url_for('financials.account_statement') }}?code=4140&start_date={{ data.start_date }}&end_date={{ data.end_date }}" class="text-decoration-none">{{ '%.2f'|format(agg.discount or 0) }}</a></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    {% for br, chans in (data.branch_channels or {}).items() %}
    <div class="card mt-3">
      <div class="card-header fw-semibold">تفصيل فرع: {% if br=='china_town' %}China Town{% elif br=='place_india' %}Place India{% else %}{{ br }}{% endif %}</div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>القناة / Channel</th>
                <th class="text-end">المبيعات الإجمالية / Gross</th>
                <th class="text-end">الخصم / Discount</th>
                <th class="text-end">العدد / Count</th>
              </tr>
            </thead>
            <tbody>
              {% for ch, agg in chans.items() %}
              <tr>
                {% set ch_code = '4013' if ch=='keeta' else ('4014' if ch=='hunger' else ( '4011' if br=='china_town' else ('4012' if br=='place_india' else None))) %}
                <td>{% if ch=='keeta' %}Keeta Online{% elif ch=='hunger' %}Hunger Online{% elif ch=='offline' %}Offline{% else %}{{ ch }}{% endif %}</td>
                <td class="text-end">{% if ch_code %}<a href="{{ url_for('financials.account_statement') }}?code={{ ch_code }}&start_date={{ data.start_date }}&end_date={{ data.end_date }}" class="text-decoration-none">{{ '%.2f'|format(agg.gross or 0) }}</a>{% else %}{{ '%.2f'|format(agg.gross or 0) }}{% endif %}</td>
                <td class="text-end"><a href="{{ url_for('financials.account_statement') }}?code=4140&start_date={{ data.start_date }}&end_date={{ data.end_date }}" class="text-decoration-none">{{ '%.2f'|format(agg.discount or 0) }}</a></td>
                <td class="text-end">{{ agg.count or 0 }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endfor %}

  <div class="row g-3 mt-3">
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header fw-semibold">ضريبة القيمة المضافة / VAT</div>
        <div class="card-body">
          <div class="d-flex justify-content-between"><span>مدخلات / Input</span><span class="fw-bold">{{ '%.2f'|format(data.vat_in or 0) }}</span></div>
          <div class="d-flex justify-content-between"><span>مخرجات / Output</span><span class="fw-bold">{{ '%.2f'|format(data.vat_out or 0) }}</span></div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header fw-semibold">تفصيل تكلفة المبيعات / COGS Breakdown</div>
        <div class="card-body">
          <div class="d-flex justify-content-between"><span>مخزون بداية الفترة / Opening Inventory</span><span class="fw-bold">{{ '%.2f'|format((data.cogs_breakdown.opening if data.cogs_breakdown else 0) or 0) }}</span></div>
          <div class="d-flex justify-content-between"><span>مشتريات الفترة / Purchases</span><span class="fw-bold">{{ '%.2f'|format((data.cogs_breakdown.purchases if data.cogs_breakdown else 0) or 0) }}</span></div>
          <div class="d-flex justify-content-between"><span>مخزون نهاية الفترة / Closing Inventory</span><span class="fw-bold">{{ '%.2f'|format((data.cogs_breakdown.closing if data.cogs_breakdown else 0) or 0) }}</span></div>
          <div class="d-flex justify-content-between"><span>هدر المواد / Waste</span><span class="fw-bold">{{ '%.2f'|format((data.cogs_breakdown.waste if data.cogs_breakdown else 0) or 0) }}</span></div>
          <hr>
          <div class="d-flex justify-content-between"><span>المُحتسب / Computed</span><span class="fw-bold">{{ '%.2f'|format((data.cogs_breakdown.computed if data.cogs_breakdown else 0) or 0) }}</span></div>
          <div class="d-flex justify-content-between"><span>من القيود / Journal COGS</span><span class="fw-bold">{{ '%.2f'|format((data.cogs_breakdown.journal if data.cogs_breakdown else 0) or 0) }}</span></div>
          <div class="d-flex justify-content-between"><span>المعتمد / Used</span><span class="fw-bold">{{ (data.cogs_breakdown.used if data.cogs_breakdown else '-') }}</span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-3">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header fw-semibold">تفصيل حسب النوع / Totals by Type</div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>النوع / Type</th>
                  <th class="text-end">المبلغ / Amount</th>
                </tr>
              </thead>
              <tbody>
                {% for t, amt in data.type_totals.items() %}
                <tr>
                  <td>{{ t }}</td>
                  <td class="text-end">{{ '%.2f'|format(amt or 0) }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-3 small text-muted">الفترة: {{ data.start_date }} إلى {{ data.end_date }}</div>
</div>
{% endblock %}
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  var periodSel = document.querySelector('select[name="period"]');
  var startInput = document.querySelector('input[name="start_date"]');
  var endInput = document.querySelector('input[name="end_date"]');
  function sync(){
    var v = (periodSel && periodSel.value)||'';
    if(v !== 'custom'){
      if(startInput){ startInput.value=''; startInput.setAttribute('disabled','disabled'); }
      if(endInput){ endInput.value=''; endInput.setAttribute('disabled','disabled'); }
    }else{
      if(startInput){ startInput.removeAttribute('disabled'); }
      if(endInput){ endInput.removeAttribute('disabled'); }
    }
  }
  if(periodSel){ periodSel.addEventListener('change', sync); }
  sync();
});
</script>
{% endblock %}
