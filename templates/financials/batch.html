<!doctype html>
<html lang="{{ get_locale() or 'ar' }}" dir="{{ 'rtl' if (get_locale() or 'ar') == 'ar' else 'ltr' }}">
<head>
  <meta charset="utf-8"/>
  <title>Batch Transactions</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
</head>
<body class="p-3">
  <div class="container-fluid">
    <h5 class="mb-3">إضافة مجموعة عمليات مالية (Batch Transactions)</h5>
    <div class="card p-3 mb-2">
      <div class="row g-2">
        <div class="col-md-3"><label class="form-label">تاريخ الدفعة</label><input type="date" id="bt-date" class="form-control"/></div>
        <div class="col-md-9 d-flex align-items-end"><button class="btn btn-primary" id="bt-generate">توليد القيود المحاسبية تلقائيًا</button></div>
      </div>
    </div>
    <div class="card p-3">
      <div class="mb-2 d-flex gap-2">
        <button class="btn btn-outline-secondary" id="bt-add">+ إضافة صف عملية جديد</button>
        <button class="btn btn-outline-danger" id="bt-del">حذف صف</button>
        <button class="btn btn-outline-secondary" id="bt-copy">نسخ</button>
        <button class="btn btn-outline-secondary" id="bt-paste">لصق</button>
        <button class="btn btn-outline-secondary" id="bt-dup">تكرار</button>
      </div>
      <table class="table table-sm" id="bt-table">
        <thead><tr><th>نوع العملية</th><th>الطرف</th><th class="text-end">المبلغ</th><th>طريقة الدفع</th><th>الوصف</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="bt-result" class="mt-3"></div>
  </div>
  <script>
    const tbody = document.querySelector('#bt-table tbody');
    let clip = null; let sel = null;
    function addRow(data){ const tr=document.createElement('tr'); const d=data||{}; tr.innerHTML=`
      <td><select class="form-select form-select-sm type">
            <option value="supplier_payment">دفعة لمورد</option>
            <option value="customer_receipt">استلام من عميل</option>
            <option value="owner_draw">مسحوبات شخصية</option>
            <option value="operating_expense">مصروف تشغيل</option>
            <option value="bank_deposit">إيداع بالبنك</option>
          </select></td>
      <td><input class="form-control form-control-sm party" value="${d.party||''}"/></td>
      <td><input class="form-control form-control-sm amount text-end" type="number" step="0.01" value="${d.amount||''}"/></td>
      <td><select class="form-select form-select-sm method">
            <option value="cash">نقد</option>
            <option value="bank">بنك</option>
            <option value="card">نقاط بيع</option>
            <option value="wallet">محفظة</option>
          </select></td>
      <td><input class="form-control form-control-sm desc" value="${d.description||''}"/></td>`; tbody.appendChild(tr); tr.addEventListener('click',()=>{ sel=tr; tbody.querySelectorAll('tr').forEach(r=>r.classList.remove('table-active')); tr.classList.add('table-active'); }); if(d.type){ tr.querySelector('.type').value=d.type; } if(d.method){ tr.querySelector('.method').value=d.method; } }
    function selected(){ return sel || tbody.querySelector('tr'); }
    document.getElementById('bt-add').addEventListener('click',()=>addRow({}));
    document.getElementById('bt-del').addEventListener('click',()=>{ const r=selected(); if(r){ r.remove(); sel=null; }});
    document.getElementById('bt-copy').addEventListener('click',()=>{ const r=selected(); if(!r) return; clip={ type:r.querySelector('.type').value, party:r.querySelector('.party').value, amount:r.querySelector('.amount').value, method:r.querySelector('.method').value, description:r.querySelector('.desc').value }; });
    document.getElementById('bt-paste').addEventListener('click',()=>{ if(!clip) return; const r=selected(); if(!r) return; r.querySelector('.type').value=clip.type; r.querySelector('.party').value=clip.party; r.querySelector('.amount').value=clip.amount; r.querySelector('.method').value=clip.method; r.querySelector('.desc').value=clip.description; });
    document.getElementById('bt-dup').addEventListener('click',()=>{ if(!clip) return; addRow(clip); });
    document.getElementById('bt-generate').addEventListener('click', async()=>{
      const date = document.getElementById('bt-date').value || new Date().toISOString().slice(0,10);
      const rows=[]; tbody.querySelectorAll('tr').forEach(tr=>{ rows.push({ type: tr.querySelector('.type').value, party: tr.querySelector('.party').value, amount: tr.querySelector('.amount').value, method: tr.querySelector('.method').value, description: tr.querySelector('.desc').value }); });
      const r = await fetch('/financials/api/batch/generate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ date, rows }) });
      const j = await r.json(); const out=document.getElementById('bt-result');
      if(j.ok){ out.innerHTML = `<div class='alert alert-success'>تم إنشاء ${j.count} عملية — قيود منشأة: ${ (j.created||[]).join(', ') }</div>`; } else { out.innerHTML = `<div class='alert alert-danger'>فشل: ${j.error||''}</div>`; }
    });
    addRow({}); addRow({});
  </script>
</body>
</html>
