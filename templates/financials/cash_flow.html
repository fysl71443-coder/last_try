{% extends "base.html" %}
{% block title %}{{ _('Cash Flow') }}{% endblock %}
{% block head %}
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
{% include 'partials/report_common_styles.html' %}
<style>
  .cf-debit { color: #198754; }
  .cf-credit { color: #dc3545; }
  @media print {
    .no-print { display: none !important; }
    .ops-header-bar { display: none !important; }
    .cf-debit, .cf-credit { color: #000 !important; }
  }
</style>
{% endblock %}
{% block content %}
<div class="container py-4 ops-layout hub-wrap report-wrap" dir="rtl">
  <div class="ops-header-bar no-print mb-3">
    <span class="ops-icon"><i class="fa-solid fa-water"></i></span>
    <div>
      <h1 class="ops-title mb-0">{{ _('Cash Flow') }}</h1>
      <span class="ops-subtitle">{{ _('Cash movements by period') }}</span>
    </div>
    <div class="ops-actions">
      <a href="{{ url_for('main.dashboard') }}" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-house me-1"></i>{{ _('Home') }}</a>
      <a href="{{ url_for('financials.accounts_hub') }}" class="btn btn-sm btn-outline-primary"><i class="fa-solid fa-book me-1"></i>{{ _('Accounts Hub') }}</a>
      <a href="{{ url_for('financials.print_cash_flow', start_date=data.start_date, end_date=data.end_date) }}" target="_blank" class="btn btn-sm btn-primary"><i class="fa-solid fa-print me-1"></i>{{ _('Print') }}</a>
    </div>
  </div>
  {% include 'partials/report_header.html' %}

  <div class="report-filter-card no-print">
    <div class="card-title"><i class="fa-solid fa-filter"></i> {{ _('Period') }}</div>
    <form method="get" action="{{ url_for('financials.cash_flow') }}" class="row g-3 align-items-end flex-wrap">
      <div class="col-auto">
        <label class="form-label">{{ _('From') }}</label>
        <input type="date" name="start_date" class="form-control form-control-sm" value="{{ data.start_date.isoformat() if data.start_date and hasattr(data.start_date, 'isoformat') else data.start_date }}" style="min-width: 150px;">
      </div>
      <div class="col-auto">
        <label class="form-label">{{ _('To') }}</label>
        <input type="date" name="end_date" class="form-control form-control-sm" value="{{ data.end_date.isoformat() if data.end_date and hasattr(data.end_date, 'isoformat') else data.end_date }}" style="min-width: 150px;">
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary btn-sm"><i class="fa-solid fa-filter me-1"></i>{{ _('Apply') }}</button>
      </div>
    </form>
  </div>

  <div class="report-actions no-print">
    <a href="{{ url_for('financials.accounts_hub') }}" class="btn btn-outline-secondary btn-sm"><i class="fa-solid fa-arrow-right me-1"></i>{{ _('Accounts Hub') }}</a>
    <a href="{{ url_for('financials.print_cash_flow', start_date=data.start_date, end_date=data.end_date) }}" target="_blank" class="btn btn-primary btn-sm"><i class="fa-solid fa-print me-1"></i>{{ _('Print') }}</a>
  </div>

  <div class="report-period-bar">
    <span><strong>{{ _('From') }}:</strong> {{ data.start_date.isoformat() if data.start_date and hasattr(data.start_date, 'isoformat') else data.start_date }}</span>
    <span><strong>{{ _('To') }}:</strong> {{ data.end_date.isoformat() if data.end_date and hasattr(data.end_date, 'isoformat') else data.end_date }}</span>
  </div>

  <div class="report-kpi-section">
    <div class="report-kpi-section-title"><i class="fa-solid fa-chart-pie me-1"></i> {{ _('Summary') }}</div>
    <div class="report-cards">
      <div class="report-card report-card-primary">
        <div class="label">{{ _('Inflow') }} ﷼</div>
        <div class="value mono">{{ '%.2f'|format(data.inflow or 0) }}</div>
      </div>
      <div class="report-card report-card-danger">
        <div class="label">{{ _('Outflow') }} ﷼</div>
        <div class="value mono">{{ '%.2f'|format(data.outflow or 0) }}</div>
      </div>
      <div class="report-card report-card-accent">
        <div class="label">{{ _('Net') }} ﷼</div>
        <div class="value mono {% if (data.net or 0) >= 0 %}text-success{% else %}text-danger{% endif %}">{{ '%.2f'|format(data.net or 0) }}</div>
      </div>
    </div>
  </div>

  <div class="report-table-card">
    <div class="report-table-card-header"><i class="fa-solid fa-table-list"></i> {{ _('Cash movements') }}</div>
    <div class="report-table-wrap">
      <table class="table report-table align-middle mb-0">
        <thead>
          <tr>
            <th>{{ _('Account') }}</th>
            <th>{{ _('Date') }}</th>
            <th class="text-end">{{ _('Debit') }} ({{ _('Inflow') }})</th>
            <th class="text-end">{{ _('Credit') }} ({{ _('Outflow') }})</th>
            <th class="text-end">{{ _('Balance') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for r in (data.rows or []) %}
          <tr>
            <td><a href="{{ url_for('financials.account_statement') }}?code={{ r.code }}&start_date={{ data.start_date }}&end_date={{ data.end_date }}" class="text-decoration-none">{{ r.code }} – {{ r.name }}</a></td>
            <td>{{ r.date.isoformat() if r.date and hasattr(r.date, 'isoformat') else r.date }}</td>
            <td class="text-end mono cf-debit">{{ '%.2f'|format(r.debit or 0) }}</td>
            <td class="text-end mono cf-credit">{{ '%.2f'|format(r.credit or 0) }}</td>
            <td class="text-end mono fw-semibold">{{ '%.2f'|format(r.running_balance | default(0)) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% if not (data.rows or []) %}
    <div class="text-center text-muted py-5 px-3">{{ _('No movements in this period.') }}</div>
    {% endif %}
    {% if data.pagination and data.pagination.total_pages > 1 %}
    <div class="border-top p-2 no-print d-flex flex-wrap align-items-center gap-2">
      {% set pag = data.pagination %}
      <span class="text-muted small">{{ pag.total }} {{ _('rows') }} — {{ _('Page') }} {{ pag.page }} / {{ pag.total_pages }}</span>
      <a href="{{ url_for('financials.cash_flow', start_date=data.start_date, end_date=data.end_date, page=pag.prev_num or 1, per_page=pag.per_page) }}" class="btn btn-sm btn-outline-secondary {% if not pag.has_prev %}disabled{% endif %}">{{ _('Previous') }}</a>
      <a href="{{ url_for('financials.cash_flow', start_date=data.start_date, end_date=data.end_date, page=pag.next_num or pag.total_pages, per_page=pag.per_page) }}" class="btn btn-sm btn-outline-secondary {% if not pag.has_next %}disabled{% endif %}">{{ _('Next') }}</a>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
