{% extends 'base.html' %}
{% block title %}{{ _('Trial balance') }}{% endblock %}
{% block head %}
{% include 'partials/report_common_styles.html' %}
<style>
  .tb-section-toggle { cursor: pointer; user-select: none; display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; padding: 0.65rem 1rem; font-weight: 600; font-size: 0.9rem; background: var(--report-bg); border-bottom: 1px solid var(--report-border); transition: background .15s; }
  .tb-section-toggle:hover { background: #e2e8f0; }
  .tb-section-toggle .chevron { transition: transform .2s; color: var(--report-muted); }
  .tb-section-toggle.collapsed .chevron { transform: rotate(-90deg); }
  .tb-section-toggle .nums { font-variant-numeric: tabular-nums; direction: ltr; }
  .tb-section-detail { padding: 0 1rem 0.75rem; background: #fff; }
  .tb-section-detail.collapsed { display: none; }
  .tb-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  .tb-table th, .tb-table td { padding: 0.4rem 0.75rem; text-align: right; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
  .tb-table td:nth-child(3), .tb-table td:nth-child(4) { font-variant-numeric: tabular-nums; direction: ltr; }
  .tb-link { color: var(--report-primary); text-decoration: none; }
  .tb-link:hover { text-decoration: underline; }
  @media print {
    .tb-section-detail.collapsed { display: block !important; }
    .tb-section-toggle { cursor: default; }
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4 report-wrap" dir="rtl">
  <div class="ops-header-bar no-print mb-3">
    <span class="ops-icon"><i class="fa-solid fa-scale-balanced"></i></span>
    <div>
      <h1 class="ops-title mb-0">{{ _('Trial balance') }}</h1>
      <span class="ops-subtitle">{{ _('As of date') }} — {{ data.company_name or 'Company' }}</span>
    </div>
    <div class="ops-actions">
      <a href="{{ url_for('main.dashboard') }}" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-house me-1"></i>{{ _('Home') }}</a>
      <a href="{{ url_for('financials.accounts_hub') }}" class="btn btn-sm btn-outline-primary"><i class="fa-solid fa-book me-1"></i>{{ _('Accounts Hub') }}</a>
      <a href="{{ url_for('financials.income_statement') }}" class="btn btn-sm btn-outline-primary">{{ _('Income Statement') }}</a>
      <a href="{{ url_for('financials.balance_sheet') }}" class="btn btn-sm btn-outline-primary">{{ _('Balance sheet') }}</a>
      <a target="_blank" href="{{ url_for('financials.print_trial_balance', date=data.date, hide_zero=1 if data.hide_zero else 0) }}" class="btn btn-sm btn-primary"><i class="fa-solid fa-print me-1"></i>{{ _('Print') }}</a>
      <a target="_blank" href="{{ url_for('financials.export_trial_balance', date=data.date, hide_zero=1 if data.hide_zero else 0) }}" class="btn btn-sm btn-outline-success"><i class="fa-solid fa-file-excel me-1"></i>{{ _('Export CSV') }}</a>
    </div>
  </div>
  {% include 'partials/report_header.html' %}

  <div class="report-filter-card no-print">
    <div class="card-title"><i class="fa-solid fa-filter"></i> {{ _('Filter') }}</div>
    <form method="get" class="row g-3 align-items-end flex-wrap">
      <div class="col-auto">
        <label class="form-label">{{ _('As of date') }}</label>
        <input type="date" name="date" class="form-control form-control-sm" value="{{ data.date }}" style="min-width: 150px;">
      </div>
      <div class="col-auto d-flex align-items-center gap-2">
        <label class="form-label mb-0 d-flex align-items-center gap-1">
          <input type="checkbox" name="hide_zero" value="1" {% if data.hide_zero %}checked{% endif %} class="form-check-input">
          {{ _('Hide zero balances') }}
        </label>
        <input type="hidden" name="hide_zero" value="0">
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary btn-sm"><i class="fa-solid fa-eye me-1"></i>{{ _('Show') }}</button>
      </div>
    </form>
  </div>

  <div class="report-actions no-print">
    <a href="{{ url_for('financials.accounts_hub') }}" class="btn btn-outline-secondary btn-sm"><i class="fa-solid fa-arrow-right me-1"></i>{{ _('Accounts Hub') }}</a>
    <a target="_blank" href="{{ url_for('financials.print_trial_balance', date=data.date, hide_zero=1 if data.hide_zero else 0) }}" class="btn btn-primary btn-sm"><i class="fa-solid fa-print me-1"></i>{{ _('Print') }}</a>
  </div>

  <div class="report-period-bar">
    <span><strong>{{ _('As of') }}:</strong> {{ data.date.strftime('%Y-%m-%d') if data.date else '—' }}</span>
    <span><strong>{{ _('Hide zero') }}:</strong> {{ _('Yes') if data.hide_zero else _('No') }}</span>
  </div>

  {% set diff = (data.total_debit or 0) - (data.total_credit or 0) %}
  <div class="report-kpi-section">
    <div class="report-kpi-section-title"><i class="fa-solid fa-chart-pie me-1"></i> {{ _('Summary') }}</div>
    <div class="report-cards">
      <div class="report-card report-card-primary">
        <div class="label">{{ _('Total Debit') }} ﷼</div>
        <div class="value mono">{{ '{:,.2f}'.format(data.total_debit or 0) }}</div>
      </div>
      <div class="report-card report-card-primary">
        <div class="label">{{ _('Total Credit') }} ﷼</div>
        <div class="value mono">{{ '{:,.2f}'.format(data.total_credit or 0) }}</div>
      </div>
      {% if diff|round(2) != 0 %}
      <div class="report-card report-card-danger">
        <div class="label">{{ _('Difference') }} ({{ _('unbalanced') }})</div>
        <div class="value mono">{{ '{:,.2f}'.format(diff) }}</div>
      </div>
      {% else %}
      <div class="report-card report-card-accent">
        <div class="label">{{ _('Balance') }}</div>
        <div class="value mono text-success">✓ {{ _('Balanced') }}</div>
      </div>
      {% endif %}
    </div>
  </div>

  <div class="report-table-card">
    <div class="report-table-card-header"><i class="fa-solid fa-list"></i> {{ _('Trial balance — accounts with movement (expandable)') }}</div>
    {% for g in (data.tb_groups or []) %}
    <div class="tb-section">
      <div class="tb-section-toggle collapsed" data-target="tb-detail-{{ g.group_key }}">
        <span>{{ g.group_name }} <span class="text-muted small">({{ (g.accounts or [])|length }} {{ _('accounts') }})</span></span>
        <span class="nums">{{ _('Debit') }} {{ '{:,.2f}'.format(g.debit or 0) }} · {{ _('Credit') }} {{ '{:,.2f}'.format(g.credit or 0) }} <i class="fa-solid fa-chevron-down chevron ms-1"></i></span>
      </div>
      <div class="tb-section-detail collapsed" id="tb-detail-{{ g.group_key }}">
        <table class="tb-table">
          <thead><tr><th>{{ _('Code') }}</th><th>{{ _('Account') }}</th><th class="text-end">{{ _('Debit') }}</th><th class="text-end">{{ _('Credit') }}</th></tr></thead>
          <tbody>
            {% for a in (g.accounts or []) %}
            <tr>
              <td><a href="{{ url_for('financials.account_statement') }}?code={{ a.code }}&start_date=2025-01-01&end_date={{ data.date }}" class="tb-link">{{ a.code }}</a></td>
              <td><a href="{{ url_for('financials.account_statement') }}?code={{ a.code }}&start_date=2025-01-01&end_date={{ data.date }}" class="tb-link">{{ a.name }}</a></td>
              <td class="text-end mono">{{ '{:,.2f}'.format(a.debit or 0) }}</td>
              <td class="text-end mono">{{ '{:,.2f}'.format(a.credit or 0) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endfor %}
    {% if not (data.tb_groups or []) %}
    <div class="text-center text-muted py-5 px-3">{{ _('No accounts with movement.') }}</div>
    {% endif %}
  </div>

  <div class="report-table-card">
    <div class="report-table-card-header"><i class="fa-solid fa-calculator"></i> {{ _('Totals by Type') }}</div>
    <div class="p-3">
      <table class="tb-table">
        <thead><tr><th>{{ _('Type') }}</th><th class="text-end">{{ _('Debit') }}</th><th class="text-end">{{ _('Credit') }}</th></tr></thead>
        <tbody>
          {% for t in (data.order or []) %}
          {% set s = (data.type_totals or {}).get(t, {}) %}
          <tr>
            <td>{{ t }}</td>
            <td class="text-end mono">{{ '{:,.2f}'.format(s.debit or 0) }}</td>
            <td class="text-end mono">{{ '{:,.2f}'.format(s.credit or 0) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  document.querySelectorAll('.tb-section-toggle[data-target]').forEach(function(tog){
    var id = tog.getAttribute('data-target');
    var detail = id ? document.getElementById(id) : null;
    if (!detail) return;
    tog.addEventListener('click', function(){
      detail.classList.toggle('collapsed');
      tog.classList.toggle('collapsed');
    });
  });
});
</script>
{% endblock %}
