{% extends 'base.html' %}
{% block title %}{{ _('Trial balance') }}{% endblock %}

{% block head %}
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  .tb-report { font-family: 'Cairo', 'Tajawal', sans-serif; --tb-text: #1F2937; --tb-heading: #111827; --tb-border: #E5E7EB; --tb-bg: #F9FAFB; --tb-card: #fff; --tb-muted: #6B7280; --tb-primary: #2563EB; color: var(--tb-text); background: var(--tb-bg); }
  .tb-report .tb-header { background: var(--tb-card); border: 1px solid var(--tb-border); border-radius: 10px; padding: 1.5rem 1.75rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,.06); }
  .tb-report .tb-company { font-size: 1.15rem; font-weight: 700; color: var(--tb-heading); margin: 0 0 0.25rem 0; }
  .tb-report .tb-title { font-size: 1rem; font-weight: 500; color: var(--tb-muted); margin: 0 0 0.5rem 0; }
  .tb-report .tb-meta { font-size: 0.9rem; color: var(--tb-muted); display: flex; flex-wrap: wrap; gap: 1rem; }
  .tb-report .tb-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; padding: 0.75rem 1rem; background: #f8fafc; border: 1px solid var(--tb-border); border-radius: 8px; margin-bottom: 1.5rem; }
  .tb-report .tb-actions .btn { font-size: 0.9rem; }
  .tb-report .tb-badges { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; margin-bottom: 1.5rem; }
  .tb-report .tb-badges .badge { font-size: 0.95rem; padding: 0.4rem 0.75rem; }
  .tb-report .tb-panel { background: var(--tb-card); border: 1px solid var(--tb-border); border-radius: 10px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,.06); margin-bottom: 1.5rem; }
  .tb-report .tb-section { border-bottom: 1px solid var(--tb-border); }
  .tb-report .tb-section:last-child { border-bottom: none; }
  .tb-report .tb-section-toggle { cursor: pointer; user-select: none; display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; padding: 0.6rem 1rem; font-weight: 600; font-size: 0.95rem; background: #f8fafc; transition: background .15s; }
  .tb-report .tb-section-toggle:hover { background: #f1f5f9; }
  .tb-report .tb-section-toggle .chevron { transition: transform .2s; color: var(--tb-muted); }
  .tb-report .tb-section-toggle.collapsed .chevron { transform: rotate(-90deg); }
  .tb-report .tb-section-toggle .nums { font-variant-numeric: tabular-nums; direction: ltr; }
  .tb-report .tb-section-detail { padding: 0 1rem 0.75rem; background: #fff; }
  .tb-report .tb-section-detail.collapsed { display: none; }
  .tb-report .tb-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  .tb-report .tb-table th, .tb-report .tb-table td { padding: 0.35rem 0.5rem; text-align: right; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
  .tb-report .tb-table td:nth-child(3), .tb-report .tb-table td:nth-child(4) { font-variant-numeric: tabular-nums; direction: ltr; }
  .tb-report .tb-link { color: var(--tb-primary); text-decoration: none; }
  .tb-report .tb-link:hover { text-decoration: underline; }
  .tb-report .tb-type-totals { background: var(--tb-card); border: 1px solid var(--tb-border); border-radius: 10px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,.06); }
  .tb-report .tb-type-totals .tb-type-head { font-size: 1rem; font-weight: 700; padding: 0.75rem 1rem; background: #f8fafc; border-bottom: 1px solid var(--tb-border); }
  .tb-report .tb-type-totals .tb-type-body { padding: 1rem; }
  .tb-report .tb-type-totals table { width: 100%; border-collapse: collapse; }
  .tb-report .tb-type-totals th, .tb-report .tb-type-totals td { padding: 0.4rem 0.5rem; text-align: right; }
  .tb-report .tb-type-totals td:last-child, .tb-report .tb-type-totals th:last-child { text-align: left; font-variant-numeric: tabular-nums; direction: ltr; }
  @media print {
    .tb-report .tb-actions, .no-print { display: none !important; }
    .tb-report .tb-section-detail.collapsed { display: block !important; }
    .tb-report .tb-section-toggle { cursor: default; }
    body, body * { color: #000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .tb-report .tb-title, .tb-report .tb-meta { color: #000 !important; }
    .tb-report .tb-table th, .tb-report .tb-table td { border-color: #333 !important; }
    .tb-report .tb-table thead th { background: #e8e8e8 !important; color: #000 !important; }
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4 tb-report" dir="rtl">
  <div class="tb-header">
    <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
      <div>
        <h1 class="tb-company">{{ data.company_name }}</h1>
        <p class="tb-title">{{ _('Trial balance') }}</p>
        <div class="tb-meta">
          <span><i class="fa-solid fa-calendar-days"></i> {{ _('As of') }} {{ data.date.strftime('%Y-%m-%d') }}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="tb-actions no-print">
    <a href="{{ url_for('main.dashboard') }}" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-house me-1"></i>{{ _('Dashboard') }}</a>
    <a href="{{ url_for('financials.income_statement') }}" class="btn btn-sm btn-outline-primary">{{ _('Income Statement') }}</a>
    <a href="{{ url_for('financials.balance_sheet') }}" class="btn btn-sm btn-outline-primary">{{ _('Balance sheet') }}</a>
    <a target="_blank" href="{{ url_for('financials.print_trial_balance', date=data.date) }}" class="btn btn-sm btn-primary"><i class="fa-solid fa-print me-1"></i>{{ _('Print') }}</a>
    <a target="_blank" href="{{ url_for('financials.export_trial_balance', date=data.date) }}" class="btn btn-sm btn-outline-success"><i class="fa-solid fa-file-excel me-1"></i>{{ _('Export CSV') }}</a>
    <div class="ms-auto d-flex flex-wrap align-items-center gap-2">
      <form method="get" class="d-flex flex-wrap align-items-center gap-2">
        <label class="mb-0 small text-muted">{{ _('As of date') }}</label>
        <input type="date" name="date" class="form-control form-control-sm" value="{{ data.date }}" style="max-width: 11rem;">
        <button type="submit" class="btn btn-outline-secondary btn-sm"><i class="fa-solid fa-filter me-1"></i>{{ _('Show') }}</button>
      </form>
    </div>
  </div>

  <div class="tb-badges">
    <span class="badge bg-light text-dark border">{{ _('Debit') }}: {{ '{:,.2f}'.format(data.total_debit or 0) }}</span>
    <span class="badge bg-light text-dark border">{{ _('Credit') }}: {{ '{:,.2f}'.format(data.total_credit or 0) }}</span>
    {% set diff = (data.total_debit or 0) - (data.total_credit or 0) %}
    {% if diff|round(2) != 0 %}
    <div class="alert alert-warning py-1 px-2 mb-0">{{ _('Warning: Trial balance is not balanced') }} ({{ _('diff') }}: {{ '{:,.2f}'.format(diff) }})</div>
    {% endif %}
  </div>

  <div class="tb-panel">
    <div class="tb-panel-head" style="font-size:1rem; font-weight:700; padding:0.75rem 1rem; background:#f8fafc; border-bottom:1px solid var(--tb-border);">{{ _('Trial balance — accounts with movement only (expandable)') }}</div>
    {% for g in (data.tb_groups or []) %}
    <div class="tb-section">
      <div class="tb-section-toggle" data-target="tb-detail-{{ g.group_key }}">
        <span>{{ g.group_name }} <span class="text-muted small">({{ (g.accounts or [])|length }} {{ _('accounts') }})</span></span>
        <span class="nums">{{ _('Debit') }} {{ '{:,.2f}'.format(g.debit or 0) }} · {{ _('Credit') }} {{ '{:,.2f}'.format(g.credit or 0) }} <i class="fa-solid fa-chevron-down chevron ms-1"></i></span>
      </div>
      <div class="tb-section-detail collapsed" id="tb-detail-{{ g.group_key }}">
        <table class="tb-table">
          <thead><tr><th>{{ _('Code') }}</th><th>{{ _('Account') }}</th><th>{{ _('Debit') }}</th><th>{{ _('Credit') }}</th></tr></thead>
          <tbody>
            {% for a in (g.accounts or []) %}
            <tr>
              <td><a href="{{ url_for('financials.account_statement') }}?code={{ a.code }}&start_date=2025-01-01&end_date={{ data.date }}" class="tb-link">{{ a.code }}</a></td>
              <td><a href="{{ url_for('financials.account_statement') }}?code={{ a.code }}&start_date=2025-01-01&end_date={{ data.date }}" class="tb-link">{{ a.name }}</a></td>
              <td>{{ '{:,.2f}'.format(a.debit or 0) }}</td>
              <td>{{ '{:,.2f}'.format(a.credit or 0) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endfor %}
    {% if not (data.tb_groups or []) %}
    <div class="p-4 text-center text-muted">{{ _('No accounts with movement.') }}</div>
    {% endif %}
  </div>

  <div class="tb-type-totals">
    <div class="tb-type-head">{{ _('Totals by Type') }}</div>
    <div class="tb-type-body">
      <table class="tb-table">
        <thead><tr><th>{{ _('Type') }}</th><th class="text-end">{{ _('Debit') }}</th><th class="text-end">{{ _('Credit') }}</th></tr></thead>
        <tbody>
          {% for t in (data.order or []) %}
          {% set s = (data.type_totals or {}).get(t, {}) %}
          <tr>
            <td>{{ t }}</td>
            <td class="text-end" style="font-variant-numeric: tabular-nums; direction: ltr;">{{ '{:,.2f}'.format(s.debit or 0) }}</td>
            <td class="text-end" style="font-variant-numeric: tabular-nums; direction: ltr;">{{ '{:,.2f}'.format(s.credit or 0) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  document.querySelectorAll('.tb-section-toggle[data-target]').forEach(function(tog){
    var id = tog.getAttribute('data-target');
    var detail = id ? document.getElementById(id) : null;
    if (!detail) return;
    tog.classList.add('collapsed');
    detail.classList.add('collapsed');
    tog.addEventListener('click', function(){
      detail.classList.toggle('collapsed');
      tog.classList.toggle('collapsed');
    });
  });
});
</script>
{% endblock %}
