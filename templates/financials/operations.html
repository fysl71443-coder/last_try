{% extends 'base.html' %}
{% block title %}العمليات والحركات{% endblock %}
{% block content %}
<div class="container py-4 ops-layout hub-wrap">
  <div class="ops-header-bar">
    <span class="ops-icon"><i class="fa-solid fa-gears"></i></span>
    <div>
      <h1 class="ops-title mb-0">العمليات والحركات</h1>
      <span class="ops-subtitle">إنشاء عمليات مالية سريعة (دفعات مورد، استلام عميل، سلفة، مصروف تشغيل، إيداع بنك)</span>
    </div>
    <div class="ops-actions">
      <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-house me-1"></i>لوحة التحكم</a>
      <a href="{{ url_for('financials.accounts_hub') }}" class="btn btn-sm btn-outline-primary"><i class="fa-solid fa-book me-1"></i>شاشة الحسابات</a>
    </div>
  </div>

  <div class="ops-form-card mt-0">
    <div class="ops-form-head">إنشاء عملية مالية</div>
    <div class="ops-form-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">نوع العملية</label>
          <select id="op-type" class="form-select">
            <option value="supplier_payment">دفعة لمورد</option>
            <option value="supplier_ap">إنشاء ذمة مورد</option>
            <option value="customer_receipt">استلام من عميل</option>
            <option value="employee_advance">سلفة موظف</option>
            <option value="owner_draw">مسحوبات شخصية</option>
            <option value="operating_expense">مصروف تشغيل</option>
            <option value="bank_deposit">إيداع بالبنك</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">التاريخ</label>
          <input type="date" id="op-date" class="form-control"/>
          <small class="text-muted">يوم/شهر/سنة</small>
        </div>
        <div class="col-md-4">
          <label class="form-label">المبلغ</label>
          <input type="number" step="0.01" id="op-amount" class="form-control" placeholder="0.00"/>
        </div>
      </div>
      <div class="row g-3 mt-2">
        <div class="col-md-4" id="grp-supplier" style="display:none">
          <label class="form-label">المورد</label>
          <select id="op-supplier" class="form-select"></select>
          <div class="mt-2" id="grp-category">
            <label class="form-label">تصنيف</label>
            <select id="op-category" class="form-select"><option value="inventory">مشتريات مخزون</option><option value="expense">مصروف</option></select>
          </div>
        </div>
        <div class="col-md-4" id="grp-customer" style="display:none">
          <label class="form-label">العميل</label>
          <select id="op-customer" class="form-select"></select>
        </div>
        <div class="col-md-4" id="grp-method">
          <label class="form-label">طريقة الدفع</label>
          <select id="op-method" class="form-select">
            <option value="cash">نقد</option>
            <option value="bank">بنك</option>
            <option value="card">نقاط بيع</option>
            <option value="wallet">محفظة</option>
          </select>
        </div>
        <div class="col-md-8">
          <label class="form-label">ملاحظة (اختياري)</label>
          <input type="text" id="op-note" class="form-control" placeholder="تفاصيل العملية (شراء منتجات/خدمة/وصف المصروف)"/>
        </div>
      </div>
      <div class="mt-3 d-flex gap-2 align-items-center">
        <button class="btn btn-primary" id="op-submit"><i class="fa-solid fa-check me-1"></i>إنشاء العملية</button>
        <div id="op-result" class="ms-2"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
(function(){
  function fetchJSON(u){ return fetch(u).then(function(r){ return r.json(); }); }
  function loadSuppliers(){ fetchJSON('/financials/api/list_suppliers').then(function(j){ var sel=document.getElementById('op-supplier'); sel.innerHTML=''; (j.suppliers||[]).forEach(function(s){ var o=document.createElement('option'); o.value=s.name; o.textContent=s.name; sel.appendChild(o); }); }); }
  function loadCustomers(){ fetchJSON('/financials/api/list_customers').then(function(j){ var sel=document.getElementById('op-customer'); sel.innerHTML=''; (j.customers||[]).forEach(function(c){ var o=document.createElement('option'); o.value=c.name; o.textContent=c.name; sel.appendChild(o); }); }); }
  function showFields(){ var t=document.getElementById('op-type').value; var sup=document.getElementById('grp-supplier'); var cus=document.getElementById('grp-customer'); var mth=document.getElementById('grp-method'); var cat=document.getElementById('grp-category'); sup.style.display='none'; cus.style.display='none'; mth.style.display=''; if(cat) cat.style.display='none'; if(t==='supplier_ap'||t==='supplier_payment'){ sup.style.display=''; loadSuppliers(); if(t==='supplier_ap'&&cat) cat.style.display='block'; } else if(t==='customer_receipt'){ cus.style.display=''; loadCustomers(); } else if(t==='bank_deposit'){ mth.style.display='none'; } }
  document.getElementById('op-type').addEventListener('change', showFields);
  showFields();
  document.getElementById('op-submit').addEventListener('click', function(){
    var btn=this; btn.disabled=true;
    var type=document.getElementById('op-type').value;
    var date=document.getElementById('op-date').value||new Date().toISOString().slice(0,10);
    var amount=parseFloat(document.getElementById('op-amount').value||0);
    var method=document.getElementById('op-method').value||'cash';
    var note=document.getElementById('op-note').value||'';
    var out=document.getElementById('op-result');
    if(!(amount>0)){ out.innerHTML='<div class="alert alert-warning">أدخل مبلغًا صالحًا</div>'; btn.disabled=false; return; }
    var party='';
    if(type==='supplier_ap'||type==='supplier_payment'){ party=document.getElementById('op-supplier').value||''; }
    if(type==='customer_receipt') party=document.getElementById('op-customer').value||'';
    if((type==='supplier_ap'||type==='operating_expense')){ out.innerHTML='<div class="alert alert-info">استخدم تبويب العمليات في شاشة الحسابات المتكاملة لهذا النوع.</div>'; btn.disabled=false; return; }
    var payload=null;
    if(type==='supplier_payment'){ if(!party){ out.innerHTML='<div class="alert alert-warning">اختر المورد</div>'; btn.disabled=false; return; } payload={ type:'supplier_payment', date, amount, payment_method:method, supplier_name:party, note: note||'سداد من شاشة العمليات' }; }
    else if(type==='customer_receipt'){ payload={ type:'collection', date, amount, payment_method:method, debtor_type:'customer', party: party||'', note: note||'تحصيل من شاشة العمليات' }; }
    else if(type==='employee_advance'){ party=document.getElementById('op-customer').value||''; payload={ type:'collection', date, amount, payment_method:method, debtor_type:'employee_advance', party: party||'', note: note||'تحصيل سلفة' }; }
    else if(type==='owner_draw'){ payload={ type:'owner_draw', date, amount, payment_method:method, note: note||'سحب من شاشة العمليات' }; }
    else if(type==='bank_deposit'){ payload={ type:'bank_deposit', date, amount, payment_method:'bank', note: note||'إيداع من شاشة العمليات' }; }
    if(!payload){ out.innerHTML='<div class="alert alert-danger">نوع العملية غير مدعوم</div>'; btn.disabled=false; return; }
    fetch('/financials/api/quick-txn',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) })
      .then(function(r){ if(!r.ok){ return r.json().then(function(j){ throw new Error(j&&j.error?j.error:('HTTP '+r.status)); }); } return r.json(); })
      .then(function(j){ if(j&&j.ok&&j.entry_number){ out.innerHTML='<div class="alert alert-success">تم إنشاء العملية — قيد: '+j.entry_number+'</div>'; document.getElementById('op-amount').value=''; document.getElementById('op-note').value=''; } else { out.innerHTML='<div class="alert alert-danger">فشل إنشاء القيد: '+(j&&j.error?j.error:'لم يُنشأ قيد يومية')+'</div>'; } btn.disabled=false; })
      .catch(function(e){ out.innerHTML='<div class="alert alert-danger">فشل: '+e.message+'</div>'; btn.disabled=false; });
  });
})();
</script>
{% endblock %}
