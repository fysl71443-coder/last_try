{% extends 'base.html' %}
{% block title %}Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†{% endblock %}
{% block content %}
<style>
  .settings-wrap{padding:16px}
  .section-card{background:#ffffff; border:1px solid #eaeaea; border-radius:16px; box-shadow:0 12px 28px rgba(30,64,175,0.12)}
  .tabs{display:flex; gap:8px; margin-bottom:12px}
  .tab{padding:10px 14px; border:1px solid #eaeaea; border-radius:12px; background:#fff; cursor:pointer; display:flex; align-items:center; gap:8px}
  .tab.active{background:linear-gradient(135deg,#60A5FA,#3B82F6); color:#fff; border-color:transparent; box-shadow:0 10px 24px rgba(30,64,175,.25)}
  .tab i{font-size:16px}
  .pane{display:none}
  .pane.active{display:block}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap}
  .toastx{position:fixed;top:-80px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#60A5FA,#3B82F6);color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.18);z-index:1100}
  .modalx{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.25);z-index:1200}
  .modalx .box{background:#fff;border-radius:14px;padding:16px;min-width:320px;max-width:520px;border:1px solid #eaeaea;box-shadow:0 12px 28px rgba(0,0,0,.18)}
  .sidepanel{position:fixed;top:0;right:-520px;width:480px;height:100vh;background:#fff;border-left:1px solid #eee;box-shadow:-8px 0 20px rgba(0,0,0,.1);z-index:1201;display:flex;flex-direction:column}
  .sidepanel .hd{padding:14px 12px;font-weight:800;background:linear-gradient(135deg,#eef4ff,#ffffff);display:flex;align-items:center;justify-content:space-between}
  .sidepanel .bd{padding:14px;overflow:auto}
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:1200;display:none;opacity:0;transition:opacity .3s ease}
  table{width:100%;border-collapse:collapse}
  thead th{position:sticky;top:0;background:linear-gradient(90deg,#E8F2FF,#FFFFFF);z-index:1}
  tbody tr{transition:transform .18s ease, box-shadow .18s ease, background .18s ease}
  tbody tr:hover{transform:translateY(-3px);box-shadow:0 12px 26px rgba(30,64,175,0.08);background:linear-gradient(90deg,#F8FBFF,#FFFFFF)}
  .badgex{display:inline-block;padding:.35em .6em;border-radius:.45rem;font-weight:700;color:#fff}
  .hourly{background:linear-gradient(135deg,#FBBF24,#F59E0B);color:#111}
  .monthly{background:linear-gradient(135deg,#34D399,#16A34A)}
</style>

<div class="container-fluid settings-wrap">
  <div class="section-header">
    <h3><i class="fa-solid fa-gear"></i> Ø´Ø§Ø´Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
    <div class="d-flex align-items-center gap-2"><input type="month" id="monthSel" class="form-control" style="max-width:180px" value="{{ '%04d'|format(year) }}-{{ '%02d'|format(month) }}"><button class="btn btn-outline-secondary" id="btnReload">ğŸ”„</button></div>
  </div>
  <div class="tabs">
    <div class="tab active" data-tab="dept"><i class="fa-solid fa-building"></i><span>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span></div>
    <div class="tab" data-tab="emp"><i class="fa-solid fa-users"></i><span>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span></div>
  </div>
  <div class="section-card p-3">
    <div class="pane active" id="pane-dept">
      <div class="toolbar mb-2">
        <button class="btn btn-primary" id="btnAddDept">â• Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…</button>
        <button class="btn btn-success" id="btnSaveDept">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
        <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="applyFuture"><label class="form-check-label" for="applyFuture">ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</label></div>
        <div class="text-muted" id="deptSaveStatus"></div>
      </div>
      <div class="table-responsive">
        <table class="table table-hover table-sm align-middle" id="deptTable">
          <thead class="table-light"><tr><th>#</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th class="text-end">Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø©</th><th class="text-end">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</th><th>ØªØ­ÙƒÙ…</th></tr></thead>
          <tbody>
            {% for dr in dept_rates %}
            <tr data-name="{{ (dr.name or '')|lower }}">
              <td>{{ loop.index }}</td>
              <td class="text-start"><span class="fw-bold">{{ dr.name }}</span></td>
              <td><input type="text" class="form-control form-control-sm deptRate" lang="en" inputmode="decimal" value="{{ '%.2f'|format((dept_rate_map.get(dr.name) or dr.hourly_rate or 0)|float) }}"></td>
              <td><input type="text" class="form-control form-control-sm deptHours" lang="en" inputmode="decimal" value="{{ '%.2f'|format(0.0) }}"></td>
              <td><button class="btn btn-outline-primary btn-sm btnEditDept">âœï¸</button> <button class="btn btn-outline-danger btn-sm btnDelDept">ğŸ—‘</button></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="pane" id="pane-emp">
      <div class="toolbar mb-2">
        <button class="btn btn-success" id="btnSaveEmp">ğŸ’¾ Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>
        <div class="text-muted" id="empSaveStatus"></div>
      </div>
      <div class="table-responsive">
        <table class="table table-hover table-sm align-middle" id="empTable2">
          <thead class="table-light"><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ù†ÙˆØ¹ Ø§Ù„Ø±Ø§ØªØ¨</th><th class="text-end">Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th class="text-end">Ø³Ø§Ø¹Ø§Øª Ø´Ù‡Ø±ÙŠØ©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th><th>ØªØ­ÙƒÙ…</th></tr></thead>
          <tbody>
            {% for e in employees %}
            <tr data-id="{{ e.id }}">
              <td>{{ loop.index }}</td>
              <td class="text-start"><span class="fw-bold">{{ e.full_name }}</span></td>
              <td>
                <select class="form-select form-select-sm empDept">
                  <option value="">â€”</option>
                  {% for dr in dept_rates %}
                  <option value="{{ dr.name }}" {% if (e.department or '')|lower == (dr.name or '')|lower %}selected{% endif %}>{{ dr.name }}</option>
                  {% endfor %}
                </select>
              </td>
              <td>
                <select class="form-select form-select-sm empKind">
                  <option value="hourly">Ø¨Ø§Ù„Ø³Ø§Ø¹Ø©</option>
                  <option value="monthly">Ø´Ù‡Ø±ÙŠ</option>
                </select>
                <span class="badgex hourly">Hourly</span>
              </td>
              <td><input type="text" class="form-control form-control-sm empRate" lang="en" inputmode="decimal" value="{{ '%.2f'|format((e.salary_default.base_salary if e.salary_default else 0)|float) }}"></td>
              <td><input type="text" class="form-control form-control-sm empHours" lang="en" inputmode="decimal" value="{{ '%.2f'|format((hours_map.get(e.id) or e.work_hours or 0)|float) }}"></td>
              <td><input type="text" class="form-control form-control-sm empNote" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></td>
              <td><button class="btn btn-outline-danger btn-sm btnDelEmp">ğŸ—‘</button></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="toastx" id="toastx" style="display:none"></div>
  <div class="modalx" id="modalx"><div class="box"><div class="mb-2 fw-bold" id="modalTitle"></div><div id="modalBody"></div><div class="mt-3 d-flex gap-2 justify-content-end"><button class="btn btn-secondary btn-sm" id="modalCancel">Ø¥Ù„ØºØ§Ø¡</button><button class="btn btn-danger btn-sm" id="modalOk">ØªØ£ÙƒÙŠØ¯</button></div></div></div>
  <div class="backdrop" id="backdrop"></div>
  <div class="sidepanel" id="panel"><div class="hd"><div>ØªØ­Ø±ÙŠØ± Ø§Ù„Ù‚Ø³Ù…</div><button class="btn btn-sm btn-outline-secondary" id="panelClose">âœ–</button></div><div class="bd"><form id="panelForm" class="d-grid gap-2"><input type="hidden" name="name" id="pName"><div><label class="form-label">Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø©</label><input type="text" class="form-control" name="hourly_rate" id="pRate" lang="en" inputmode="decimal"></div><div><label class="form-label">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</label><input type="text" class="form-control" name="monthly_hours" id="pHours" lang="en" inputmode="decimal"></div><div><label class="form-label">Ø§Ù„Ø´Ù‡Ø±</label><input type="month" class="form-control" name="month" id="pMonth" value="{{ '%04d'|format(year) }}-{{ '%02d'|format(month) }}"></div><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="pFuture" name="apply_future"><label class="form-check-label" for="pFuture">ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</label></div><div class="mt-2"><button type="submit" class="btn btn-primary" id="pSave">Ø­ÙØ¸</button></div></form></div></div>
</div>

<script>
  var CSRF = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  function toEn(n, opts){ try{ if(n===undefined||n===null||n==='') return '0'; var num = Number(n); if(!isFinite(num)) return String(n); var o = Object.assign({useGrouping:false}, (opts||{})); return num.toLocaleString('en-US', o); }catch(e){ return String(n); } }
  function toNum(s){ try{ if(s===undefined||s===null) return 0; var str = String(s); var map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9','Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9'}; str = str.replace(/[Ù -Ù©Û°-Û¹]/g, function(ch){ return map[ch]||ch; }); var n = parseFloat(str); if(isNaN(n)) return 0; return n; }catch(e){ try{ var n2 = Number(s); return isNaN(n2)?0:n2; }catch(_){ return 0; } } }
  function showToast(msg){ var t=document.getElementById('toastx'); t.textContent=msg; t.style.display='block'; t.style.top='-80px'; setTimeout(function(){ t.style.transition='top .25s ease'; t.style.top='22px'; setTimeout(function(){ t.style.top='-80px'; setTimeout(function(){ t.style.display='none'; },250); },1600); },10); }
  function switchTab(tab){ document.querySelectorAll('.tab').forEach(function(el){ el.classList.toggle('active', el.getAttribute('data-tab')===tab); }); document.querySelectorAll('.pane').forEach(function(el){ el.classList.toggle('active', el.id==='pane-'+tab); }); }
  document.querySelectorAll('.tab').forEach(function(el){ el.addEventListener('click', function(){ switchTab(this.getAttribute('data-tab')); }); });
  document.getElementById('btnReload').addEventListener('click', function(){ location.reload(); });
  ;(function(){ try{ fetch('/api/dept-rates', { credentials:'same-origin' }).then(function(r){ return r.json(); }).then(function(j){ if(!j||!j.ok) return; var rows=j.rows||[]; rows.forEach(function(it){ var tr=document.querySelector('#deptTable tbody tr[data-name="'+String((it.name||'').toLowerCase())+'"]'); if(!tr) return; var r=Number(it.hourly_rate||0); var mh=Number(it.monthly_hours||0); var rateInp=tr.querySelector('.deptRate'); var mhInp=tr.querySelector('.deptHours'); if(rateInp) rateInp.value=toEn(r,{minimumFractionDigits:2,maximumFractionDigits:2}); if(mhInp) mhInp.value=toEn(mh,{minimumFractionDigits:2,maximumFractionDigits:2}); }); }); }catch(e){} })();
  document.querySelectorAll('#deptTable .deptRate, #deptTable .deptHours').forEach(function(inp){ inp.addEventListener('input', function(){ var tr=this.closest('tr'); tr.classList.add('table-warning'); tr.setAttribute('data-dirty','1'); }); });
  document.querySelectorAll('#empTable2 .empDept, #empTable2 .empKind, #empTable2 .empRate, #empTable2 .empHours, #empTable2 .empNote').forEach(function(inp){ inp.addEventListener('change', function(){ var tr=this.closest('tr'); tr.classList.add('table-warning'); tr.setAttribute('data-dirty','1'); var kindSel=tr.querySelector('.empKind'); var badge=tr.querySelector('.badgex'); if(kindSel&&badge){ var k=kindSel.value||'hourly'; badge.textContent=k==='monthly'?'Monthly':'Hourly'; badge.className='badgex '+(k==='monthly'?'monthly':'hourly'); } }); });
  document.getElementById('btnSaveDept').addEventListener('click', async function(){ var btn=this; btn.disabled=true; var st=document.getElementById('deptSaveStatus'); var ok=0, fail=0; var rows=[].slice.call(document.querySelectorAll('#deptTable tbody tr[data-dirty="1"]')); var mon=document.getElementById('monthSel').value||''; var fut=document.getElementById('applyFuture').checked; for(var i=0;i<rows.length;i++){ var tr=rows[i]; var name=(tr.getAttribute('data-name')||'').trim(); var rate=toNum(tr.querySelector('.deptRate').value||'0'); var mh=toNum(tr.querySelector('.deptHours').value||'0'); try{ var fd=new FormData(); fd.append('name', name); fd.append('hourly_rate', String(rate)); fd.append('monthly_hours', String(mh)); fd.append('month', mon); fd.append('apply_future', fut? 'true':'false'); var r=await fetch('/api/dept-rates', { method:'POST', headers:{'X-CSRFToken': CSRF, 'Accept':'application/json'}, body: fd, credentials:'same-origin' }); if(r.ok){ ok++; tr.classList.remove('table-warning'); tr.setAttribute('data-dirty',''); } else { fail++; } }catch(e){ fail++; } }
    btn.disabled=false; if(st){ st.textContent='ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ('+ok+')'+(fail? 'ØŒ ÙØ´Ù„ '+fail:''); } showToast(ok && !fail ? 'âœ… ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù…' : (fail? 'âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…':'âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„Ø§Øª')); });
  document.getElementById('btnSaveEmp').addEventListener('click', async function(){ var btn=this; btn.disabled=true; var st=document.getElementById('empSaveStatus'); var ok=0, fail=0; var rows=[].slice.call(document.querySelectorAll('#empTable2 tbody tr[data-dirty="1"]')); for(var i=0;i<rows.length;i++){ var tr=rows[i]; var id=parseInt(tr.getAttribute('data-id')||'0'); var dept=tr.querySelector('.empDept').value||''; var kind=tr.querySelector('.empKind').value||'hourly'; var rate=toNum(tr.querySelector('.empRate').value||'0'); var hours=toNum(tr.querySelector('.empHours').value||'0'); var noteVal=tr.querySelector('.empNote').value||''; try{ if(kind==='monthly'){ var fd1=new FormData(); fd1.append('base_salary', String(rate)); if(dept){ fd1.append('department', dept); } var r1=await fetch('/api/employees/'+id, { method:'PUT', headers:{'X-CSRFToken': CSRF, 'Accept':'application/json'}, body: fd1, credentials:'same-origin' }); if(!r1.ok) throw new Error('fail'); } else { var fd2=new FormData(); fd2.append('emp_id', String(id)); fd2.append('work_type','hourly'); fd2.append('hourly_rate_employee', String(rate)); fd2.append('monthly_hours', String(hours)); var r2=await fetch('/api/employee/settings', { method:'POST', headers:{'X-CSRFToken': CSRF, 'Accept':'application/json'}, body: fd2, credentials:'same-origin' }); if(!r2.ok) throw new Error('fail'); if(dept){ var fd3=new FormData(); fd3.append('department', dept); var r3=await fetch('/api/employees/'+id, { method:'PUT', headers:{'X-CSRFToken': CSRF, 'Accept':'application/json'}, body: fd3, credentials:'same-origin' }); if(!r3.ok) throw new Error('fail'); } }
        if(noteVal){ var fd4=new FormData(); fd4.append('emp_id', String(id)); fd4.append('note', noteVal); await fetch('/api/employee/note', { method:'POST', headers:{'X-CSRFToken': CSRF, 'Accept':'application/json'}, body: fd4, credentials:'same-origin' }); }
        ok++; tr.classList.remove('table-warning'); tr.setAttribute('data-dirty',''); }catch(e){ fail++; } }
    btn.disabled=false; if(st){ st.textContent='ØªÙ… Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ('+ok+')'+(fail? 'ØŒ ÙØ´Ù„ '+fail:''); } showToast(ok && !fail ? 'âœ… ØªÙ… Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†' : (fail? 'âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†':'âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„Ø§Øª')); });
  document.querySelectorAll('#empTable2 .btnDelEmp').forEach(function(b){ b.addEventListener('click', async function(){ var tr=this.closest('tr'); var id=parseInt(tr.getAttribute('data-id')||'0'); if(!id) return; if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©ØŸ')) return; try{ var r=await fetch('/api/employees/'+id, { method:'DELETE', headers:{'X-CSRFToken': CSRF, 'Accept':'application/json'}, credentials:'same-origin' }); var j=await r.json().catch(function(){ return null; }); if(r.ok && j && j.ok){ showToast('ğŸ—‘ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù ÙˆÙƒÙ„ Ø³Ø¬Ù„Ø§ØªÙ‡'); tr.parentNode.removeChild(tr); } else { showToast('âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù'); } }catch(e){ showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'); } }); });
  document.querySelectorAll('#deptTable .btnEditDept').forEach(function(b){ b.addEventListener('click', function(){ var tr=this.closest('tr'); var name=(tr.getAttribute('data-name')||'').trim(); var rate=toNum(tr.querySelector('.deptRate').value||'0'); var mh=toNum(tr.querySelector('.deptHours').value||'0'); var p=document.getElementById('panel'); var bd=document.getElementById('backdrop'); document.getElementById('pName').value=name; document.getElementById('pRate').value=toEn(rate,{minimumFractionDigits:2,maximumFractionDigits:2}); document.getElementById('pHours').value=toEn(mh,{minimumFractionDigits:2,maximumFractionDigits:2}); document.getElementById('pMonth').value=document.getElementById('monthSel').value||''; p.style.transition='right .3s ease'; bd.style.display='block'; setTimeout(function(){ bd.style.opacity='1'; },10); p.style.right='0'; }); });
  document.getElementById('panelClose').addEventListener('click', function(){ var p=document.getElementById('panel'); var bd=document.getElementById('backdrop'); p.style.right='-520px'; bd.style.opacity='0'; setTimeout(function(){ bd.style.display='none'; },300); });
  document.getElementById('panelForm').addEventListener('submit', async function(ev){ ev.preventDefault(); var fd=new FormData(ev.target); fd.set('hourly_rate', String(toNum(fd.get('hourly_rate')||'0'))); fd.set('monthly_hours', String(toNum(fd.get('monthly_hours')||'0'))); try{ var r=await fetch('/api/dept-rates', { method:'POST', headers:{'X-CSRFToken': CSRF, 'Accept':'application/json'}, body: fd, credentials:'same-origin' }); if(r.ok){ showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù…'); document.getElementById('panelClose').click(); document.getElementById('btnReload').click(); } else { showToast('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù…'); } }catch(e){ showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'); } });
  document.getElementById('btnAddDept').addEventListener('click', function(){ var p=document.getElementById('panel'); var bd=document.getElementById('backdrop'); document.getElementById('pName').value=''; document.getElementById('pRate').value='0.00'; document.getElementById('pHours').value='0.00'; document.getElementById('pMonth').value=document.getElementById('monthSel').value||''; p.style.transition='right .3s ease'; bd.style.display='block'; setTimeout(function(){ bd.style.opacity='1'; },10); p.style.right='0'; });
  document.querySelectorAll('#deptTable .btnDelDept').forEach(function(b){ b.addEventListener('click', function(){ var tr=this.closest('tr'); var name=(tr.getAttribute('data-name')||'').trim(); var depts = {{ employees | map(attribute='department') | list | tojson }}; var inDept = depts.filter(function(d){ return String((d||'').toLowerCase())===name; }); var modal=document.getElementById('modalx'); document.getElementById('modalTitle').textContent='Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…: '+name; var body=document.getElementById('modalBody'); var html=''; if(inDept.length>0){ html += '<div class="alert alert-warning">ÙŠÙˆØ¬Ø¯ '+inDept.length+' Ù…ÙˆØ¸Ù ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…. Ø§Ø®ØªØ± Ù‚Ø³Ù… Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†Ù‡Ù… Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù.</div>'; html += '<div class="mb-2"><label class="form-label">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¥Ù„Ù‰ Ù‚Ø³Ù…</label><select class="form-select" id="reassignTo"><option value="">â€”</option>'; {% for dr in dept_rates %} html += '<option value="{{ dr.name }}">{{ dr.name }}</option>'; {% endfor %} html += '</select></div>'; } else { html += '<div class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ† ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ</div>'; } body.innerHTML=html; modal.style.display='flex'; var ok=document.getElementById('modalOk'); var cancel=document.getElementById('modalCancel'); function close(){ modal.style.display='none'; ok.replaceWith(ok.cloneNode(true)); cancel.replaceWith(cancel.cloneNode(true)); }
      document.getElementById('modalCancel').addEventListener('click', function(){ close(); });
      document.getElementById('modalOk').addEventListener('click', async function(){ try{ var to=document.getElementById('reassignTo')? document.getElementById('reassignTo').value:''; if(inDept.length>0 && to){ var fd1=new FormData(); fd1.append('from_dept', name); fd1.append('to_dept', to); var r1=await fetch('/api/dept-reassign', { method:'POST', headers:{'X-CSRFToken': CSRF, 'Accept':'application/json'}, body: fd1, credentials:'same-origin' }); if(!r1.ok) throw new Error('reassign'); } var fd2=new FormData(); fd2.append('name', name); fd2.append('mode','delete'); var r2=await fetch('/api/dept-rates', { method:'POST', headers:{'X-CSRFToken': CSRF, 'Accept':'application/json'}, body: fd2, credentials:'same-origin' }); if(r2.ok){ showToast('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…'); close(); document.getElementById('btnReload').click(); } else { showToast('âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…'); } }catch(e){ showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù'); } }); }); });
</script>
{% endblock %}
