{% extends "base.html" %}
{% block content %}
<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø³Ø§Ø¹Ø©</h3>
    <a class="btn btn-outline-primary" href="{{ url_for('main.dashboard') }}">â¬…ï¸ Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
  </div>

  <div class="alert alert-secondary small">
    Ø­Ø¯Ù‘Ø« Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø³Ø§Ø¹Ø© Ù„Ù„Ø£Ù‚Ø³Ø§Ù…ØŒ Ø«Ù… Ø£Ø¯Ø®Ù„ Ø³Ø§Ø¹Ø§Øª ÙƒÙ„ Ù…ÙˆØ¸Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±. ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ = (Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ã— Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø© Ù„Ù„Ù‚Ø³Ù…).
  </div>

  <form method="POST" class="row g-2 align-items-end mb-4">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <input type="hidden" name="year" value="{{ year }}"/>
    <input type="hidden" name="month" value="{{ month }}"/>
    <div class="col-sm-3">
      <label class="form-label">Ø§Ù„Ù‚Ø³Ù…</label>
      <select name="dept_name" class="form-select" required>
        {% for r in dept_rates %}
          <option value="{{ r.name }}" {% if selected and selected.name==r.name %}selected{% endif %}>{{ r.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-sm-3">
      <label class="form-label">Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø© (SAR)</label>
      <input type="number" step="0.01" min="0" name="hourly_rate" class="form-control" value="{{ selected.hourly_rate if selected else '' }}" required>
    </div>
    <div class="col-sm-3">
      <button class="btn btn-success w-100">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø³Ø¹Ø±</button>
    </div>
  </form>

  <div class="table-responsive mb-4">
    <table class="table table-bordered table-sm align-middle">
      <thead class="table-light position-sticky top-0" style="z-index:1;">
        <tr>
          <th>#</th>
          <th>Ø§Ù„Ù‚Ø³Ù…</th>
          <th>Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø©</th>
          <th style="width:160px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody>
        {% for r in dept_rates %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ r.name }}</td>
          <td>{{ '%.2f'|format(r.hourly_rate or 0) }}</td>
          <td>
            <form method="post" class="d-inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
              <input type="hidden" name="mode" value="delete_dept"/>
              <input type="hidden" name="dept_name" value="{{ r.name }}"/>
              <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…ØŸ')">Ø­Ø°Ù</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <form method="post" class="row g-2 align-items-end mb-4">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <input type="hidden" name="mode" value="add_dept"/>
    <div class="col-sm-5">
      <label class="form-label">Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø³Ù…</label>
      <input type="text" name="new_dept_name" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…" required>
    </div>
    <div class="col-sm-3">
      <label class="form-label">Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø©</label>
      <input type="number" step="0.01" min="0" name="new_hourly_rate" class="form-control" value="0">
    </div>
    <div class="col-sm-3">
      <button class="btn btn-outline-success w-100">Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù…</button>
    </div>
  </form>

  <h5 class="mb-2">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h5>
    <form method="GET" class="row g-2 align-items-end mb-2" id="periodForm">
    <div class="col-sm-2">
      <label class="form-label">Ø³Ù†Ø©</label>
      <input type="number" name="year" class="form-control" value="{{ year }}">
    </div>
    <div class="col-sm-2">
      <label class="form-label">Ø´Ù‡Ø±</label>
      <input type="number" name="month" class="form-control" min="1" max="12" value="{{ month }}">
    </div>
    
  </form>

  <div class="row g-2 align-items-end mb-3">
    <div class="col-sm-3">
      <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø±Ø§ØªØ¨</label>
      <select class="form-select" id="salaryTypeFilter">
        <option value="all">Ø§Ù„ÙƒÙ„</option>
        <option value="hourly">Ø³Ø§Ø¹Ø§ØªÙŠ</option>
        <option value="monthly">Ø´Ù‡Ø±ÙŠ</option>
      </select>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-sm-2">
          <label class="form-label">Ø§Ù„Ù‚Ø³Ù…</label>
          <select class="form-select" id="payDept">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            {% for r in dept_rates %}
            <option value="{{ r.name|lower }}">{{ r.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-sm-2">
          <label class="form-label">Ø´Ù‡Ø±</label>
          <input type="month" class="form-control" id="payMonth" value="{{ '%04d-%02d'|format(year, month) }}">
        </div>
        <div class="col-sm-2">
          <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº</label>
          <input type="number" step="0.01" min="0" class="form-control" id="payAmount">
        </div>
        <div class="col-sm-2">
          <label class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
          <select class="form-select" id="payMethod">
            <option value="cash">Ù†Ù‚Ø¯ÙŠ</option>
            <option value="bank">Ø¨Ù†Ùƒ</option>
          </select>
        </div>
        <div class="col-sm-4 text-end">
          <button type="button" class="btn btn-warning" id="btnDeptPay">ğŸ’³ Ø³Ø¯Ø§Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…</button>
          <button type="button" class="btn btn-primary" id="btnAllPay">ğŸ’³ Ø³Ø¯Ø§Ø¯ Ø¬Ù…Ø§Ø¹ÙŠ</button>
        </div>
      </div>
    </div>
  </div>

  <form method="POST">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <input type="hidden" name="mode" value="hours"/>
    <input type="hidden" name="year" value="{{ year }}"/>
    <input type="hidden" name="month" value="{{ month }}"/>

    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm align-middle" id="hoursTable">
        <thead class="table-light position-sticky top-0" style="z-index:1;">
          <tr>
            <th>#</th>
            <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
            <th>Ø§Ù„Ù‚Ø³Ù…</th>
          <th>Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th>
          <th>ØºÙŠØ§Ø¨ (Ø³Ø§Ø¹Ø§Øª)</th>
          <th>Ø³Ø§Ø¹Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</th>
          <th>Ø¨Ø¯Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</th>
          <th>Ø®ØµÙ… Ø§Ù„ØºÙŠØ§Ø¨</th>
          <th>Ø§Ù„Ø¨Ø¯Ù„Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</th>
          <th>Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</th>
          <th>Ø§Ù„Ø£Ø¬Ø± Ø§Ù„Ù…Ø­Ø³ÙˆØ¨</th>
          <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th style="width:160px">Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø¯Ø§Ø¯</th>
          <th>Ø³Ø¯Ø§Ø¯</th>
          </tr>
        </thead>
        <tbody>
          {% for emp in employees %}
          {% set rate = dept_rate_map.get((emp.department or '')|lower, 0) %}
          {% set h = hours_map.get(emp.id, 0) %}
          {% set d = defaults_map.get(emp.id) %}
          {% set allow_def = (d.allowances if d else 0) %}
          {% set ded_def = (d.deductions if d else 0) %}
          {% set calc = (rate or 0) * (h or 0) %}
          {% set st = (status_map.get(emp.id) or 'due') %}
          <tr data-rate="{{ '%.2f'|format(rate or 0) }}" data-emp="{{ emp.id }}" data-type="{{ 'hourly' if (rate or 0) > 0 else 'monthly' }}">
            <td>{{ loop.index }}</td>
            <td>{{ emp.full_name }}</td>
            <td>{{ emp.department or '-' }}</td>
            <td style="width:160px">
              <input type="number" step="0.01" min="0" class="form-control emp-hours" name="hours_{{ emp.id }}" value="{{ h }}">
            </td>
            <td style="width:160px">
              <input type="number" step="0.01" min="0" class="form-control emp-absent" name="absent_hours_{{ emp.id }}" value="0">
            </td>
            <td style="width:160px">
              <input type="number" step="0.01" min="0" class="form-control emp-ot" name="overtime_hours_{{ emp.id }}" value="0">
            </td>
            <td class="fw-bold emp-ot-allow">0.00</td>
            <td class="fw-bold emp-abs-ded">0.00</td>
            <td style="width:140px">
              <input type="number" step="0.01" min="0" class="form-control" name="allow_default_{{ emp.id }}" value="{{ '%.2f'|format(allow_def or 0) }}">
            </td>
            <td style="width:140px">
              <input type="number" step="0.01" min="0" class="form-control" name="ded_default_{{ emp.id }}" value="{{ '%.2f'|format(ded_def or 0) }}">
            </td>
            <td class="fw-bold emp-wage">{{ '%.2f'|format(calc) }}</td>
            <td class="fw-bold emp-total">{{ '%.2f'|format(calc) }}</td>
            <td>
              {% if st == 'paid' %}<span class="badge bg-success">Ù…Ø¯ÙÙˆØ¹</span>
              {% elif st == 'partial' %}<span class="badge bg-warning text-dark">Ø¬Ø²Ø¦ÙŠ</span>
              {% else %}<span class="badge bg-danger">Ù…Ø³ØªØ­Ù‚</span>{% endif %}
            </td>
            <td>
              <input type="number" step="0.01" min="0" class="form-control emp-pay-amt" placeholder="0.00">
            </td>
            <td>
              <button type="button" class="btn btn-outline-success btn-sm emp-pay-btn">Ø³Ø¯Ø§Ø¯</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-end gap-2">
      <button class="btn btn-primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø³Ø§Ø¹Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ÙˆØ§ØªØ¨</button>
    </div>
  </form>
</div>

<script>
// Live wage & absence deduction recalculation
(function(){
  const table = document.getElementById('hoursTable');
  if(!table) return;
  function recalc(tr){
    const rate = parseFloat(tr.getAttribute('data-rate')) || 0;
    const hours = parseFloat(tr.querySelector('.emp-hours')?.value||0) || 0;
    const absent = parseFloat(tr.querySelector('.emp-absent')?.value||0) || 0;
    const ot = parseFloat(tr.querySelector('.emp-ot')?.value||0) || 0;
    const allowDef = parseFloat(tr.querySelector('[name^="allow_default_"]')?.value||0) || 0;
    const dedDef = parseFloat(tr.querySelector('[name^="ded_default_"]')?.value||0) || 0;
    const wageCell = tr.querySelector('.emp-wage');
    const absCell = tr.querySelector('.emp-abs-ded');
    const otCell = tr.querySelector('.emp-ot-allow');
    const totalCell = tr.querySelector('.emp-total');
    if(wageCell){ wageCell.textContent = (rate * hours).toFixed(2); }
    if(absCell){ absCell.textContent = (rate * absent).toFixed(2); }
    if(otCell){ otCell.textContent = (rate * ot).toFixed(2); }
    if(totalCell){ totalCell.textContent = (rate * hours + rate * ot - rate * absent + allowDef - dedDef).toFixed(2); }
  }
  table.addEventListener('input', function(e){
    const tr = e.target.closest('tr');
    if(!tr) return;
    recalc(tr);
  });
  // Initial pass
  table.querySelectorAll('tbody tr').forEach(recalc);
})();

(function(){
  const table = document.getElementById('hoursTable');
  const sel = document.getElementById('salaryTypeFilter');
  if(!table || !sel) return;
  function apply(){
    const v = sel.value;
    table.querySelectorAll('tbody tr').forEach(tr => {
      const t = tr.getAttribute('data-type')||'all';
      tr.style.display = (v==='all' || v===t) ? '' : 'none';
    });
  }
  sel.addEventListener('change', apply);
  apply();
})();

// Payment actions
(function(){
  const monthVal = `${String({{ year }}).padStart(4,'0')}-${String({{ month }}).padStart(2,'0')}`;
  document.querySelectorAll('.emp-pay-btn').forEach(btn => {
    btn.addEventListener('click', async function(){
      const tr = this.closest('tr');
      const empId = tr.getAttribute('data-emp');
      const amt = tr.querySelector('.emp-pay-amt')?.value || '0';
      const fd = new FormData();
      fd.append('csrf_token', '{{ csrf_token() }}');
      fd.append('paid_amount', amt);
      fd.append('payment_method', 'cash');
      const url = `/employees/${empId}/pay?employee_id=${empId}&year=${monthVal.split('-')[0]}&month=${monthVal.split('-')[1]}`;
      try{ const r = await fetch(url, { method:'POST', body: fd }); if(r.ok){ location.reload(); } else { alert('ÙØ´Ù„ Ø§Ù„Ø³Ø¯Ø§Ø¯'); } }catch(e){ alert('ÙØ´Ù„ Ø§Ù„Ø³Ø¯Ø§Ø¯'); }
    });
  });
  document.getElementById('btnAllPay')?.addEventListener('click', async function(){
    const m = document.getElementById('payMonth').value || monthVal;
    const amt = document.getElementById('payAmount').value || '0';
    const method = document.getElementById('payMethod').value || 'cash';
    const fd = new FormData(); fd.append('csrf_token', '{{ csrf_token() }}'); fd.append('employee_id', 'all'); fd.append('month', m); fd.append('paid_amount', amt); fd.append('payment_method', method);
    try{ const r = await fetch('/salaries/pay', { method:'POST', body: fd }); if(r.ok){ location.reload(); } else { alert('ÙØ´Ù„ Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ'); } }catch(e){ alert('ÙØ´Ù„ Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ'); }
  });
  document.getElementById('btnDeptPay')?.addEventListener('click', async function(){
    const dept = (document.getElementById('payDept').value||'').toLowerCase();
    const m = document.getElementById('payMonth').value || monthVal;
    const amt = document.getElementById('payAmount').value || '0';
    const method = document.getElementById('payMethod').value || 'cash';
    const fd = new FormData(); fd.append('csrf_token', '{{ csrf_token() }}'); fd.append('employee_id', 'all'); fd.append('department', dept); fd.append('month', m); fd.append('paid_amount', amt); fd.append('payment_method', method);
    try{ const r = await fetch('/salaries/pay', { method:'POST', body: fd }); if(r.ok){ location.reload(); } else { alert('ÙØ´Ù„ Ø³Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ø³Ù…'); } }catch(e){ alert('ÙØ´Ù„ Ø³Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ø³Ù…'); }
  });
})();
  // Instant change for year/month without button
  (function(){
    const form = document.getElementById('periodForm');
    if(!form) return;
    const y = form.querySelector('[name="year"]');
    const m = form.querySelector('[name="month"]');
    function go(){
      const yy = (y?.value||'').trim();
      const mm = (m?.value||'').trim();
      const params = new URLSearchParams(window.location.search);
      if(yy) params.set('year', yy);
      if(mm) params.set('month', mm);
      window.location.search = params.toString();
    }
    y?.addEventListener('change', go);
    m?.addEventListener('change', go);
  })();
</script>
{% endblock %}
