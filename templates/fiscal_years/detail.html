{% extends 'base.html' %}
{% set back_url = url_for('fiscal_years.list_years') %}
{% block title %}{{ _('Fiscal year') }} {{ fy.year }}{% endblock %}
{% block content %}
<div class="container py-4 ops-layout hub-wrap">
  <div class="ops-header-bar">
    <span class="ops-icon"><i class="fa-solid fa-calendar-days"></i></span>
    <div>
      <h1 class="ops-title mb-0">{{ _('Fiscal year') }} {{ fy.year }}</h1>
      <span class="ops-subtitle">{{ fy.start_date.strftime('%Y-%m-%d') }} â€” {{ fy.end_date.strftime('%Y-%m-%d') }}</span>
    </div>
    <div class="ops-actions d-flex flex-wrap gap-2">
      <a href="{{ url_for('journal.audit', run=1, from_date=fy.start_date.strftime('%Y-%m-%d'), to_date=fy.end_date.strftime('%Y-%m-%d'), fiscal_year_id=fy.id) }}" class="btn btn-primary btn-sm"><i class="fa-solid fa-magnifying-glass-chart me-1"></i>ğŸ” ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</a>
      <a href="{{ url_for('journal.audit_pdf', from_date=fy.start_date.strftime('%Y-%m-%d'), to_date=fy.end_date.strftime('%Y-%m-%d'), fiscal_year_id=fy.id) }}" target="_blank" class="btn btn-outline-primary btn-sm"><i class="fa-solid fa-file-pdf me-1"></i>ØªÙ‚Ø±ÙŠØ± PDF Ø§Ù„Ø±Ø³Ù…ÙŠ</a>
      <a href="{{ url_for('fiscal_years.import_journal', id=fy.id) }}" class="btn btn-outline-primary btn-sm"><i class="fa-solid fa-file-import me-1"></i>{{ _('Import journal') }}</a>
      <a href="{{ url_for('fiscal_years.list_years') }}" class="btn btn-outline-secondary btn-sm"><i class="fa-solid fa-list me-1"></i>{{ _('List') }}</a>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-6">
      {% if closure_audit_status %}
      <div class="ops-form-card border-{{ 'danger' if closure_audit_status.has_critical else 'success' }}">
        <div class="ops-form-head"><i class="fa-solid fa-shield-halved me-1"></i>Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ù„Ù„Ø¥Ù‚ÙØ§Ù„</div>
        <div class="ops-form-body">
          {% if closure_audit_status.no_snapshot_yet %}
          <p class="mb-2 text-muted"><strong>Ù„Ù… ÙŠÙØ¬Ø±Ù ØªØ¯Ù‚ÙŠÙ‚ Ø¨Ø¹Ø¯.</strong> <a href="{{ url_for('journal.audit', run=1, from_date=fy.start_date.strftime('%Y-%m-%d'), to_date=fy.end_date.strftime('%Y-%m-%d'), fiscal_year_id=fy.id) }}">ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</a> Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©. Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„ Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>
          {% elif closure_audit_status.has_critical %}
          <p class="mb-2 text-danger"><strong>âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù‚ÙØ§Ù„ Ø§Ù„Ø³Ù†Ø© â€” ØªÙˆØ¬Ø¯ {{ closure_audit_status.critical_count }} Ù…Ù„Ø§Ø­Ø¸Ø© Ø­Ø±Ø¬Ø©.</strong> Ø¹Ø§Ù„Ø¬Ù‡Ø§ Ù…Ù† ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ù…Ø¨Ø±Ø± Ø§Ù„ØªØ¬Ø§ÙˆØ² Ø£Ø¯Ù†Ø§Ù‡.</p>
          <form method="post" action="{{ url_for('fiscal_years.close', id=fy.id) }}" class="mb-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <label class="form-label small">Ø³Ø¨Ø¨ Ø§Ù„ØªØ¬Ø§ÙˆØ² (Ø¥Ù„Ø²Ø§Ù…ÙŠ)</label>
            <textarea name="override_reason" class="form-control form-control-sm" rows="2" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¹ØªÙ…Ø¯ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€” Ø³ÙŠØªÙ… Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹ (20 Ø­Ø±ÙØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)" minlength="20" required></textarea>
            <button type="submit" class="btn btn-warning btn-sm mt-2"><i class="fa-solid fa-lock me-1"></i>Ø¥Ù‚ÙØ§Ù„ Ù…Ø¹ Ø§Ù„ØªØ¬Ø§ÙˆØ²</button>
          </form>
          {% else %}
          <p class="mb-2 text-success"><strong>âœ” Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ù‚ÙØ§Ù„</strong> â€” Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­Ø±Ø¬Ø© (Ø¹Ø§Ù„ÙŠ).</p>
          {% endif %}
          {% if not closure_audit_status.no_snapshot_yet and closure_audit_status.snapshot and closure_audit_status.snapshot.summary %}
          <p class="small text-muted mb-0">Ø¢Ø®Ø± ØªØ¯Ù‚ÙŠÙ‚: Ø¥Ø¬Ù…Ø§Ù„ÙŠ {{ closure_audit_status.snapshot.summary.total }} â€” Ø¹Ø§Ù„ÙŠ: {{ closure_audit_status.snapshot.summary.high }} | Ù…ØªÙˆØ³Ø·: {{ closure_audit_status.snapshot.summary.medium }} | Ù…Ù†Ø®ÙØ¶: {{ closure_audit_status.snapshot.summary.low }}</p>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <div class="ops-form-card">
        <div class="ops-form-head">{{ _('Status') }}</div>
        <div class="ops-form-body">
          {% if fy.status == 'open' %}
          <p class="mb-2"><span class="badge bg-success fs-6">ğŸŸ¢ {{ _('Open') }}</span> â€” {{ _('Invoices and journal entries allowed') }}</p>
          {% if reopen_details and reopen_details.get('reopen_reason') %}
          <p class="small text-muted mb-2">Ø¢Ø®Ø± Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­: {{ reopen_details.reopen_reason }}{% if reopen_details.get('reopened_by_username') %} â€” {{ reopen_details.reopened_by_username }}{% endif %}</p>
          {% endif %}
          {% if not closure_audit_status or closure_audit_status.no_snapshot_yet or not closure_audit_status.has_critical %}
          <form method="post" action="{{ url_for('fiscal_years.close', id=fy.id) }}" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="submit" class="btn btn-warning btn-sm"><i class="fa-solid fa-lock me-1"></i>{{ _('Close year') }}</button>
          </form>
          {% endif %}
          <form method="post" action="{{ url_for('fiscal_years.partial_close', id=fy.id) }}" class="d-inline-block ms-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="date" name="closed_until" class="form-control form-control-sm d-inline-block w-auto" required>
            <input type="text" name="override_reason" class="form-control form-control-sm d-inline-block ms-1" style="width: 14rem;" placeholder="{{ _('Override reason') }} (20+ Ø¥Ø°Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­Ø±Ø¬Ø©)" minlength="20">
            <button type="submit" class="btn btn-outline-warning btn-sm ms-1">{{ _('Partial close until') }}</button>
          </form>
          {% elif fy.status == 'closed' %}
          <p class="mb-2"><span class="badge bg-secondary fs-6">ğŸ”’ {{ _('Closed') }}</span> â€” {{ _('No new invoices or entries; viewing and reports allowed') }}</p>
          {% if closure_log and closure_log.action == 'close_override' and closure_details and closure_details.get('override_reason') %}
          <p class="small text-warning mb-2">ØªÙ… Ø§Ù„Ø¥Ù‚ÙØ§Ù„ Ù…Ø¹ Ø§Ù„ØªØ¬Ø§ÙˆØ² â€” Ø§Ù„Ø³Ø¨Ø¨: {{ closure_details.override_reason }}</p>
          {% endif %}
          {% if closure_details and closure_details.get('audit_snapshot') %}
          <p class="small text-muted mb-2">Ù„Ù‚Ø·Ø© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„: Ø¥Ø¬Ù…Ø§Ù„ÙŠ {{ closure_details.audit_snapshot.summary.total }} (Ø¹Ø§Ù„ÙŠ: {{ closure_details.audit_snapshot.summary.high }} | Ù…ØªÙˆØ³Ø·: {{ closure_details.audit_snapshot.summary.medium }} | Ù…Ù†Ø®ÙØ¶: {{ closure_details.audit_snapshot.summary.low }})</p>
          {% endif %}
          <form method="post" action="{{ url_for('fiscal_years.reopen', id=fy.id) }}" class="mt-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <label class="form-label small">Ø³Ø¨Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙØªØ­ (Ø¥Ù„Ø²Ø§Ù…ÙŠ â€” 20 Ø­Ø±ÙØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)</label>
            <textarea name="reopen_reason" class="form-control form-control-sm" rows="2" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚ÙŠÙˆØ¯ Ø£Ùˆ ØªØµØ­ÙŠØ­ Ø£Ø®Ø·Ø§Ø¡ â€” Ù…Ø¹ØªÙ…Ø¯ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©" minlength="20" required></textarea>
            <button type="submit" class="btn btn-outline-success btn-sm mt-1"><i class="fa-solid fa-lock-open me-1"></i>{{ _('Reopen') }}</button>
          </form>
          {% else %}
          <p class="mb-2"><span class="badge bg-warning text-dark fs-6">âš  {{ _('Partially closed') }}</span> {% if fy.closed_until %}{{ _('until') }} {{ fy.closed_until.strftime('%Y-%m-%d') }}{% endif %}</p>
          <form method="post" action="{{ url_for('fiscal_years.close', id=fy.id) }}" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="submit" class="btn btn-warning btn-sm">{{ _('Close fully') }}</button>
          </form>
          <form method="post" action="{{ url_for('fiscal_years.reopen', id=fy.id) }}" class="d-inline ms-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="text" name="reopen_reason" class="form-control form-control-sm d-inline-block ms-1" style="width: 12rem;" placeholder="{{ _('Reason') }} (20+)" minlength="20" required>
            <button type="submit" class="btn btn-outline-success btn-sm">{{ _('Reopen') }}</button>
          </form>
          {% endif %}
        </div>
      </div>

      <div class="ops-form-card">
        <div class="ops-form-head">{{ _('Open exceptional period') }}</div>
        <div class="ops-form-body">
          <p class="small text-muted mb-2">{{ _('For importing entries or corrections; full audit log required.') }}</p>
          <form method="post" action="{{ url_for('fiscal_years.add_exceptional_period', id=fy.id) }}" class="row g-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="col-md-4"><label class="form-label small">{{ _('From') }}</label><input type="date" name="start_date" class="form-control form-control-sm" required></div>
            <div class="col-md-4"><label class="form-label small">{{ _('To') }}</label><input type="date" name="end_date" class="form-control form-control-sm" required></div>
            <div class="col-md-4"><label class="form-label small">{{ _('Reason') }}</label><input type="text" name="reason" class="form-control form-control-sm" placeholder="{{ _('e.g. Import / Correction') }}"></div>
            <div class="col-12"><button type="submit" class="btn btn-outline-primary btn-sm"><i class="fa-solid fa-calendar-plus me-1"></i>{{ _('Add period') }}</button></div>
          </form>
        </div>
      </div>

      {% if fy.exceptional_periods %}
      <div class="ops-form-card">
        <div class="ops-form-head">{{ _('Exceptional periods') }}</div>
        <div class="ops-form-body p-0">
          <ul class="list-group list-group-flush">
            {% for ep in fy.exceptional_periods %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>{{ ep.start_date.strftime('%Y-%m-%d') }} â€” {{ ep.end_date.strftime('%Y-%m-%d') }}{% if ep.reason %} ({{ ep.reason }}){% endif %}</span>
              <small class="text-muted">{{ ep.created_at.strftime('%Y-%m-%d %H:%M') if ep.created_at else '' }}</small>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
      {% endif %}
    </div>

    <div class="col-lg-6">
      <div class="ops-form-card">
        <div class="ops-form-head">{{ _('Audit log') }}</div>
        <div class="ops-form-body p-0">
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead><tr><th>{{ _('Date') }}</th><th>{{ _('Action') }}</th></tr></thead>
              <tbody>
                {% for log in audit_logs_page or [] %}
                <tr>
                  <td class="small">{{ log.created_at.strftime('%Y-%m-%d %H:%M') if log.created_at else 'â€”' }}</td>
                  <td>
                    {% if log.action == 'close' %}<span class="badge bg-secondary">Ø¥Ù‚ÙØ§Ù„</span>
                    {% elif log.action == 'close_override' %}<span class="badge bg-warning text-dark">Ø¥Ù‚ÙØ§Ù„ Ù…Ø¹ Ø§Ù„ØªØ¬Ø§ÙˆØ²</span>
                    {% elif log.action == 'reopen' %}<span class="badge bg-info">Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­</span>
                    {% elif log.action == 'partial_close' %}<span class="badge bg-light text-dark">Ø¥Ù‚ÙØ§Ù„ Ø¬Ø²Ø¦ÙŠ</span>
                    {% else %}<span class="badge bg-light text-dark">{{ log.action }}</span>{% endif %}
                  </td>
                </tr>
                {% else %}
                <tr><td colspan="2" class="text-muted small">{{ _('No audit entries yet') }}</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {% if fy.notes %}
      <div class="ops-form-card">
        <div class="ops-form-head">{{ _('Notes') }}</div>
        <div class="ops-form-body"><p class="mb-0 small">{{ fy.notes }}</p></div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
