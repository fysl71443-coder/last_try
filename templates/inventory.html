{% extends 'base.html' %}
{% set back_url = url_for('main.dashboard') %}

{% block title %}{{ _('Inventory & Cost Management / Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ') }}{% endblock %}
{% block content %}

<style>
body {
  background: #f4f6f9;
}
.inventory-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0px 4px 8px rgba(0,0,0,0.05);
  padding: 1.5rem;
  margin-bottom: 1rem;
}
.stats-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 12px;
  padding: 1.5rem;
  text-align: center;
  margin-bottom: 1rem;
}
.action-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0px 4px 8px rgba(0,0,0,0.05);
  padding: 2rem;
  text-align: center;
  transition: all 0.2s ease-in-out;
  height: 100%;
}
.action-card:hover {
  transform: translateY(-3px);
  box-shadow: 0px 6px 14px rgba(0,0,0,0.1);
}
.action-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  color: #2a5298;
}
.cost-highlight {
  font-weight: bold;
  color: #2e7d32;
}
.price-highlight {
  font-weight: bold;
  color: #1976d2;
}
</style>

<div class="container py-4">
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹ -->
    <div class="section-header mb-3">
        <h3 class="mb-0">ğŸ“¦ {{ _('Inventory & Cost Management / Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ') }}</h3>
        <div class="d-flex flex-wrap gap-2">
            <a href="{{ url_for('main.purchases') }}" class="btn btn-outline-warning">
                ğŸ›’ {{ _('Purchases / Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª') }}
            </a>
            <a href="{{ url_for('main.sales') }}" class="btn btn-outline-info">
                ğŸ’° {{ _('Sales / Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª') }}
            </a>
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary">
                ğŸ  {{ _('Dashboard / Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…') }}
            </a>
        </div>
    </div>

    <div class="inventory-card">
        <h5 class="mb-3">{{ _('Purchases Ledger / Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª') }}</h5>
        <div class="table-responsive">
            <table class="table table-striped table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>{{ _('Date / Ø§Ù„ØªØ§Ø±ÙŠØ®') }}</th>
                        <th>{{ _('Invoice No / Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©') }}</th>
                        <th>{{ _('Supplier / Ø§Ù„Ù…ÙˆØ±Ø¯') }}</th>
                        <th>{{ _('Payment / Ø§Ù„Ø¯ÙØ¹') }}</th>
                        <th>{{ _('Status / Ø§Ù„Ø­Ø§Ù„Ø©') }}</th>
                        <th class="text-end">{{ _('Subtotal / Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ') }}</th>
                        <th class="text-end">{{ _('VAT / Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©') }}</th>
                        <th class="text-end">{{ _('Discount / Ø§Ù„Ø®ØµÙ…') }}</th>
                        <th class="text-end">{{ _('Final Total / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ') }}</th>
                        <th>{{ _('Items / Ø§Ù„Ø¹Ù†Ø§ØµØ±') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in purchases or [] %}
                    <tr>
                        <td class="text-center"><span class="badge bg-secondary">{{ loop.index }}</span></td>
                        <td>{{ p.date }}</td>
                        <td><strong class="text-primary">{{ p.invoice_number }}</strong></td>
                        <td>{{ p.supplier_name or '-' }}</td>
                        <td><span class="badge bg-light text-dark">{{ p.payment_method }}</span></td>
                        <td>
                            {% if (p.status or '').lower() == 'paid' %}
                            <span class="badge bg-success">{{ _('Paid / Ù…Ø¯ÙÙˆØ¹') }}</span>
                            {% elif (p.status or '').lower() == 'partial' %}
                            <span class="badge bg-warning">{{ _('Partial / Ø¬Ø²Ø¦ÙŠ') }}</span>
                            {% elif (p.status or '').lower() == 'unpaid' %}
                            <span class="badge bg-danger">{{ _('Unpaid / ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹') }}</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ p.status or '-' }}</span>
                            {% endif %}
                        </td>
                        <td class="text-end">ï·¼{{ '%.2f'|format(p.total_before_tax or 0) }}</td>
                        <td class="text-end">ï·¼{{ '%.2f'|format(p.tax_amount or 0) }}</td>
                        <td class="text-end">ï·¼{{ '%.2f'|format(p.discount_amount or 0) }}</td>
                        <td class="text-end">ï·¼{{ '%.2f'|format(p.total_after_tax_discount or 0) }}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-primary" data-toggle-items="{{ p.id }}">{{ _('Show Items / Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù†Ø§ØµØ±') }}</button>
                        </td>
                    </tr>
                    <tr class="d-none" data-items-row="{{ p.id }}">
                        <td colspan="11">
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>{{ _('Item / Ø§Ù„ØµÙ†Ù') }}</th>
                                            <th class="text-end">{{ _('Unit Price / Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©') }}</th>
                                            <th class="text-end">{{ _('Quantity / Ø§Ù„ÙƒÙ…ÙŠØ©') }}</th>
                                            <th class="text-end">{{ _('Discount / Ø§Ù„Ø®ØµÙ…') }}</th>
                                            <th class="text-end">{{ _('Tax / Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©') }}</th>
                                            <th class="text-end">{{ _('Total / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for it in p['items'] %}
                                        <tr>
                                            <td>{{ it.name }}</td>
                                            <td class="text-end">ï·¼{{ '%.4f'|format(it.price_before_tax or 0) }}</td>
                                            <td class="text-end">{{ '%.4f'|format(it.quantity or 0) }}</td>
                                            <td class="text-end">ï·¼{{ '%.2f'|format(it.discount or 0) }}</td>
                                            <td class="text-end">ï·¼{{ '%.2f'|format(it.tax or 0) }}</td>
                                            <td class="text-end">ï·¼{{ '%.2f'|format(it.total_price or 0) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <style>
    :root{ --intel-muted:#5c6773; --intel-ok:#28a745; --intel-warn:#ffc107; --intel-danger:#dc3545 }
    .intel-grid{ display:grid; gap:12px; grid-template-columns:repeat(5, minmax(160px, 1fr)) }
    .intel-card{ border-radius:16px; background:#fff; padding:16px; box-shadow:0 10px 26px rgba(18,22,33,.06); display:flex; align-items:center; gap:12px }
    .intel-num{ font-weight:700; font-size:22px }
    .intel-label{ color:var(--intel-muted); font-size:13px }
    .intel-sec{ background:white; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.05); padding:1rem; margin-bottom:1rem }
    .bar-chart .bar{ display:flex; align-items:center; gap:8px }
    .bar .name{ width:220px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .bar .val{ flex:1; background:linear-gradient(90deg,#0d6efd,#6610f2); height:10px; border-radius:6px; position:relative }
    .spark{ display:flex; align-items:flex-end; gap:3px; height:42px }
    .spark .pt{ width:12px; background:#0d6efd; border-radius:3px }
    .risk.low{ color:var(--intel-danger); font-weight:700 }
    .risk.excess{ color:#6610f2; font-weight:700 }
    .risk.ok{ color:var(--intel-ok); font-weight:700 }
    @media (max-width:1024px){ .intel-grid{ grid-template-columns:repeat(2,1fr) } }
    </style>

    <div class="intel-sec">
      <h5 class="mb-3">{{ _('KPI Overview / Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©') }}</h5>
      <div class="intel-grid">
        <div class="intel-card"><div>ğŸ“¦</div><div><div class="intel-label">{{ _('Total Inventory Cost / Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†') }}</div><div class="intel-num">{{ '{:,.2f}'.format(kpi.total_inventory_cost or 0) }}</div></div></div>
        <div class="intel-card"><div>ğŸ§¾</div><div><div class="intel-label">{{ _('Ingredient Purchases (This Month) / Ù…Ø´ØªØ±ÙŠØ§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±') }}</div><div class="intel-num">{{ '{:,.2f}'.format(kpi.total_purchases_month or 0) }}</div></div></div>
        <div class="intel-card"><div>ğŸ½</div><div><div class="intel-label">{{ _('Meals Sold (This Month) / Ø§Ù„ÙˆØ¬Ø¨Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©') }}</div><div class="intel-num">{{ '{:,.0f}'.format(kpi.total_meals_sold_month or 0) }}</div></div></div>
        <div class="intel-card"><div>ğŸ’°</div><div><div class="intel-label">{{ _('Estimated Meal Cost / ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©') }}</div><div class="intel-num">{{ '{:,.2f}'.format(kpi.estimated_total_meal_cost or 0) }}</div></div></div>
        <div class="intel-card"><div>ğŸ“Š</div><div><div class="intel-label">{{ _('Total Profit / Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­') }}</div><div class="intel-num">{{ '{:,.2f}'.format(kpi.total_profit_generated or 0) }}</div></div></div>
      </div>
    </div>

    <div class="intel-sec">
      <h5 class="mb-2">{{ _('Purchases Summary / Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª') }}</h5>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead class="table-light">
            <tr>
              <th>{{ _('Date / Ø§Ù„ØªØ§Ø±ÙŠØ®') }}</th>
              <th>{{ _('Invoice No / Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©') }}</th>
              <th>{{ _('Supplier / Ø§Ù„Ù…ÙˆØ±Ø¯') }}</th>
              <th>{{ _('Payment / Ø§Ù„Ø¯ÙØ¹') }}</th>
              <th>{{ _('Status / Ø§Ù„Ø­Ø§Ù„Ø©') }}</th>
              <th class="text-end">{{ _('Subtotal') }}</th>
              <th class="text-end">{{ _('VAT') }}</th>
              <th class="text-end">{{ _('Discount') }}</th>
              <th class="text-end">{{ _('Final Total') }}</th>
              <th class="text-center">{{ _('Items') }}</th>
            </tr>
          </thead>
          <tbody>
            {% for r in purchases_summary %}
            <tr>
              <td>{{ r.date }}</td>
              <td>{{ r.invoice_number }}</td>
              <td>{{ r.supplier }}</td>
              <td>{{ r.payment_method }}</td>
              <td>{{ r.status }}</td>
              <td class="text-end">{{ '{:,.2f}'.format(r.subtotal or 0) }}</td>
              <td class="text-end">{{ '{:,.2f}'.format(r.vat or 0) }}</td>
              <td class="text-end">{{ '{:,.2f}'.format(r.discount or 0) }}</td>
              <td class="text-end">{{ '{:,.2f}'.format(r.final_total or 0) }}</td>
              <td class="text-center">{{ r.items_count }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="row mt-3">
        <div class="col-md-6">
          <h6 class="mb-2">{{ _('Top Purchased Ingredients / Ø£ÙƒØ«Ø± Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø´Ø±Ø§Ø¡Ù‹') }}</h6>
          <div class="bar-chart">
            {% for b in top_ingredients %}
              <div class="bar">
                <div class="name">{{ b.name }}</div>
                {% set pct = (b.total / (top_ingredients[0].total or 1)) if top_ingredients %}
                <div class="val" style="width: {{ (pct * 100)|round(1) }}%"></div>
                <div class="intel-num">{{ '{:,.2f}'.format(b.total or 0) }}</div>
              </div>
            {% endfor %}
          </div>
        </div>
        <div class="col-md-6">
          <h6 class="mb-2">{{ _('Purchase Trend / Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª') }}</h6>
          <div class="spark">
            {% for p in purchase_trend %}
            {% set h = (p.total / (purchase_trend|map(attribute='total')|max if purchase_trend else 1)) * 38 %}
            <div class="pt" title="{{ p.date }}" style="height: {{ h|round(1) }}px"></div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div class="intel-sec">
      <h5 class="mb-2">{{ _('Meal Cost & Sales Analysis / ØªØ­Ù„ÙŠÙ„ ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ¬Ø¨Ø§Øª ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª') }}</h5>
      {% if outdated_meals and outdated_meals|length > 0 %}
        <div class="alert alert-warning">âš  {{ _('Meals using ingredients with outdated cost data / ÙˆØ¬Ø¨Ø§Øª ØªØ­ØªÙˆÙŠ Ù…ÙƒÙˆÙ†Ø§Øª Ø¨Ø³Ø¹Ø± Ù‚Ø¯ÙŠÙ…') }}: {{ outdated_meals|join(', ') }}</div>
      {% endif %}
      <div class="table-responsive">
        <table class="table table-sm">
          <thead class="table-light">
            <tr>
              <th>{{ _('Meal / Ø§Ù„ÙˆØ¬Ø¨Ø©') }}</th>
              <th class="text-center">{{ _('Sales Count / Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª') }}</th>
              <th class="text-end">{{ _('Consumption Cost / ØªÙƒÙ„ÙØ© Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ') }}</th>
              <th class="text-end">{{ _('Revenue / Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯') }}</th>
              <th class="text-end">{{ _('Profit / Ø§Ù„Ø±Ø¨Ø­') }}</th>
              <th class="text-end">Margin / Ø§Ù„Ù‡Ø§Ù…Ø´</th>
              <th>{{ _('Contribution / Ø§Ù„Ù…Ø³Ø§Ù‡Ù…Ø©') }}</th>
            </tr>
          </thead>
          <tbody>
            {% set total_profit = meals_analysis|map(attribute='profit')|sum if meals_analysis else 0 %}
            {% for m in meals_analysis %}
            {% set margin = (100 * (m.profit / m.revenue)) if m.revenue else 0 %}
            {% set contrib = (100 * (m.profit / total_profit)) if total_profit else 0 %}
            <tr>
              <td>{{ m.meal_name }}</td>
              <td class="text-center">{{ '{:,.0f}'.format(m.sold_qty or 0) }}</td>
              <td class="text-end">{{ '{:,.2f}'.format(m.consumption_cost or 0) }}</td>
              <td class="text-end">{{ '{:,.2f}'.format(m.revenue or 0) }}</td>
              <td class="text-end">{{ '{:,.2f}'.format(m.profit or 0) }}</td>
              <td class="text-end">{{ '{:,.1f}'.format(margin) }}%</td>
              <td>{{ '{:,.1f}'.format(contrib) }}%</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="intel-sec">
      <h5 class="mb-2">{{ _('Dynamic Stock Analysis / ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ') }}</h5>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead class="table-light">
            <tr>
              <th>{{ _('Ingredient / Ø§Ù„Ù…ÙƒÙˆÙ†') }}</th>
              <th class="text-end">{{ _('Opening Qty / Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠØ©') }}</th>
              <th class="text-end">{{ _('Purchases Qty / ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª') }}</th>
              <th class="text-end">{{ _('Estimated Usage / Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ') }}</th>
              <th class="text-end">{{ _('Expected Stock / Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹') }}</th>
              <th>{{ _('Risk / Ø§Ù„Ù…Ø®Ø§Ø·Ø±') }}</th>
            </tr>
          </thead>
          <tbody>
            {% for r in stock_rows %}
            <tr>
              <td>{{ r.ingredient }}</td>
              <td class="text-end">{{ '{:,.3f}'.format(r.opening_qty or 0) }}</td>
              <td class="text-end">{{ '{:,.3f}'.format(r.purchases_qty or 0) }}</td>
              <td class="text-end">{{ '{:,.3f}'.format(r.estimated_usage or 0) }}</td>
              <td class="text-end">{{ '{:,.3f}'.format(r.expected_stock or 0) }}</td>
              <td><span class="risk {{ r.risk }}">{{ r.risk|capitalize }}</span></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
</div>
<script>
(function(){
  document.addEventListener('click', function(e){
    var btn = e.target.closest('[data-toggle-items]');
    if(!btn) return;
    var id = btn.getAttribute('data-toggle-items');
    var row = document.querySelector('tr[data-items-row="' + id + '"]');
    if(!row) return;
    var showText = '{{ _('Show Items / Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù†Ø§ØµØ±') }}';
    var hideText = '{{ _('Hide Items / Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ±') }}';
    if(row.classList.contains('d-none')){ row.classList.remove('d-none'); btn.textContent = hideText; }
    else { row.classList.add('d-none'); btn.textContent = showText; }
  });
})();
</script>

{% endblock %}
