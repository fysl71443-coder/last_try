{% extends 'base.html' %}
{% set back_url = url_for('main.dashboard') %}

{% block title %}{{ _('Inventory & Cost Management') }}{% endblock %}
{% block content %}

<style>.cost-highlight{ font-weight:700; color:var(--ops-blue,#1565c0); } .price-highlight{ font-weight:700; color:var(--ops-blue-dark,#0d47a1); }</style>

<div class="container py-4 ops-layout hub-wrap">
    <div class="ops-header-bar">
        <span class="ops-icon"><i class="fa-solid fa-boxes-stacked"></i></span>
        <div>
            <h1 class="ops-title mb-0">{{ _('Inventory & Cost Management') }}</h1>
            <span class="ops-subtitle">{{ _('Purchases ledger and cost overview') }}</span>
        </div>
        <div class="ops-actions d-flex flex-wrap gap-2">
            <a href="{{ url_for('purchases.purchases') }}" class="btn btn-sm">ðŸ›’ {{ _('Purchases') }}</a>
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-house me-1"></i>{{ _('Dashboard') }}</a>
        </div>
    </div>

    <div class="ops-tabs-wrap">
        <div class="ops-tabs" role="tablist">
            <button type="button" class="ops-tab active" data-panel="panel-ledger">{{ _('Movements') }}</button>
            <button type="button" class="ops-tab" data-panel="panel-reports">{{ _('Reports') }}</button>
        </div>
    </div>

    <div class="ops-body ops-body-no-sidebar">
        <main class="ops-main">
            <div id="panel-ledger" class="ops-panel" data-panel>
    <div class="ops-form-card">
        <div class="ops-form-head">{{ _('Purchases Ledger') }}</div>
        <div class="ops-form-body">
        <form method="get" action="{{ url_for('inventory.inventory') }}" class="row g-3 align-items-end mb-3">
          <div class="col-auto"><label class="form-label">{{ _('From date') }}</label><input type="date" name="start_date" class="form-control" value="{{ start_ledger_val or '' }}"></div>
          <div class="col-auto"><label class="form-label">{{ _('To date') }}</label><input type="date" name="end_date" class="form-control" value="{{ end_ledger_val or '' }}"></div>
          <div class="col-auto"><button type="submit" class="btn btn-primary"><i class="fa-solid fa-filter me-1"></i>{{ _('Apply') }}</button></div>
        </form>
        <div class="table-responsive screen-table-wrap">
            <table class="table table-hover align-middle screen-table mb-0">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>{{ _('Date') }}</th>
                        <th>{{ _('Invoice No') }}</th>
                        <th>{{ _('Supplier') }}</th>
                        <th>{{ _('Payment') }}</th>
                        <th>{{ _('Status') }}</th>
                        <th class="text-end">{{ _('Subtotal') }}</th>
                        <th class="text-end">{{ _('VAT') }}</th>
                        <th class="text-end">{{ _('Discount') }}</th>
                        <th class="text-end">{{ _('Final Total') }}</th>
                        <th>{{ _('Items') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in purchases or [] %}
                    <tr>
                        <td class="text-center"><span class="badge bg-secondary">{{ loop.index }}</span></td>
                        <td>{{ p.date }}</td>
                        <td><strong class="text-primary">{{ p.invoice_number }}</strong></td>
                        <td>{{ p.supplier_name or '-' }}</td>
                        <td><span class="badge bg-light text-dark">{{ p.payment_method }}</span></td>
                        <td>
                            {% if (p.status or '').lower() == 'paid' %}
                            <span class="badge bg-success">{{ _('Paid') }}</span>
                            {% elif (p.status or '').lower() == 'partial' %}
                            <span class="badge bg-warning">{{ _('Partial') }}</span>
                            {% elif (p.status or '').lower() == 'unpaid' %}
                            <span class="badge bg-danger">{{ _('Unpaid') }}</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ p.status or '-' }}</span>
                            {% endif %}
                        </td>
                        <td class="text-end">ï·¼{{ '%.2f'|format(p.total_before_tax or 0) }}</td>
                        <td class="text-end">ï·¼{{ '%.2f'|format(p.tax_amount or 0) }}</td>
                        <td class="text-end">ï·¼{{ '%.2f'|format(p.discount_amount or 0) }}</td>
                        <td class="text-end">ï·¼{{ '%.2f'|format(p.total_after_tax_discount or 0) }}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-primary" data-toggle-items="{{ p.id }}">{{ _('Show Items') }}</button>
                        </td>
                    </tr>
                    <tr class="d-none" data-items-row="{{ p.id }}">
                        <td colspan="11">
                            <div class="table-responsive screen-table-wrap">
                                <table class="table table-sm table-bordered mb-0 screen-table">
                                    <thead>
                                        <tr>
                                            <th>{{ _('Item') }}</th>
                                            <th class="text-end">{{ _('Unit Price') }}</th>
                                            <th class="text-end">{{ _('Quantity') }}</th>
                                            <th class="text-end">{{ _('Discount') }}</th>
                                            <th class="text-end">{{ _('Tax') }}</th>
                                            <th class="text-end">{{ _('Total') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for it in p['items'] %}
                                        <tr>
                                            <td>{{ it.name }}</td>
                                            <td class="text-end">ï·¼{{ '%.4f'|format(it.price_before_tax or 0) }}</td>
                                            <td class="text-end">{{ '%.4f'|format(it.quantity or 0) }}</td>
                                            <td class="text-end">ï·¼{{ '%.2f'|format(it.discount or 0) }}</td>
                                            <td class="text-end">ï·¼{{ '%.2f'|format(it.tax or 0) }}</td>
                                            <td class="text-end">ï·¼{{ '%.2f'|format(it.total_price or 0) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        </div>
    </div>
            </div>

            <div id="panel-reports" class="ops-panel d-none" data-panel>
    <style>
    :root{ --intel-muted:#5c6773; --intel-ok:#28a745; --intel-warn:#ffc107; --intel-danger:#dc3545 }
    .intel-grid{ display:grid; gap:12px; grid-template-columns:repeat(5, minmax(160px, 1fr)) }
    .intel-card{ border-radius:16px; background:#fff; padding:16px; box-shadow:0 10px 26px rgba(18,22,33,.06); display:flex; align-items:center; gap:12px }
    .intel-num{ font-weight:700; font-size:22px }
    .intel-label{ color:var(--intel-muted); font-size:13px }
    .intel-sec{ background:white; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.05); padding:1rem; margin-bottom:1rem }
    .bar-chart .bar{ display:flex; align-items:center; gap:8px }
    .bar .name{ width:220px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .bar .val{ flex:1; background:linear-gradient(90deg,#0d6efd,#6610f2); height:10px; border-radius:6px; position:relative }
    .spark{ display:flex; align-items:flex-end; gap:3px; height:42px }
    .spark .pt{ width:12px; background:#0d6efd; border-radius:3px }
    .risk.low{ background:rgba(243,156,18,.08); color:#b45309; font-weight:600; padding:.2rem .5rem; border-radius:6px }
    .risk.ok{ color:var(--ops-blue-dark,#0d47a1) }
    .risk.excess{ background:rgba(102,16,242,.06); color:#5a32a3; font-weight:600; padding:.2rem .5rem; border-radius:6px }
    @media (max-width:1024px){ .intel-grid{ grid-template-columns:repeat(2,1fr) } }
    </style>

    <div class="intel-sec">
      <h5 class="mb-3">{{ _('KPI Overview') }}</h5>
      <div class="intel-grid">
        <div class="intel-card"><div><i class="fa-solid fa-boxes-stacked"></i></div><div><div class="intel-label">{{ _('Total Inventory Cost') }}</div><div class="intel-num">{{ '{:,.2f}'.format(kpi.total_inventory_cost or 0) }}</div></div></div>
        <div class="intel-card"><div><i class="fa-solid fa-receipt"></i></div><div><div class="intel-label">{{ _('Ingredient Purchases (This Month)') }}</div><div class="intel-num">{{ '{:,.2f}'.format(kpi.total_purchases_month or 0) }}</div></div></div>
        <div class="intel-card"><div><i class="fa-solid fa-utensils"></i></div><div><div class="intel-label">{{ _('Meals Sold (This Month)') }}</div><div class="intel-num">{{ '{:,.0f}'.format(kpi.total_meals_sold_month or 0) }}</div></div></div>
        <div class="intel-card"><div><i class="fa-solid fa-coins"></i></div><div><div class="intel-label">{{ _('Estimated Meal Cost') }}</div><div class="intel-num">{{ '{:,.2f}'.format(kpi.estimated_total_meal_cost or 0) }}</div></div></div>
        <div class="intel-card"><div><i class="fa-solid fa-chart-line"></i></div><div><div class="intel-label">{{ _('Total Profit') }}</div><div class="intel-num">{{ '{:,.2f}'.format(kpi.total_profit_generated or 0) }}</div></div></div>
      </div>
    </div>

    <div class="intel-sec">
      <h5 class="mb-2">{{ _('Purchases Summary') }}</h5>
      <div class="table-responsive screen-table-wrap">
        <table class="table table-sm table-hover screen-table">
          <thead>
            <tr>
              <th>{{ _('Date') }}</th>
              <th>{{ _('Invoice No') }}</th>
              <th>{{ _('Supplier') }}</th>
              <th>{{ _('Payment') }}</th>
              <th>{{ _('Status') }}</th>
              <th class="text-end">{{ _('Subtotal') }}</th>
              <th class="text-end">{{ _('VAT') }}</th>
              <th class="text-end">{{ _('Discount') }}</th>
              <th class="text-end">{{ _('Final Total') }}</th>
              <th class="text-center">{{ _('Items') }}</th>
            </tr>
          </thead>
          <tbody>
            {% for r in purchases_summary %}
            <tr>
              <td>{{ r.date }}</td>
              <td>{{ r.invoice_number }}</td>
              <td>{{ r.supplier }}</td>
              <td>{{ r.payment_method }}</td>
              <td>{{ r.status }}</td>
              <td class="text-end">{{ '{:,.2f}'.format(r.subtotal or 0) }}</td>
              <td class="text-end">{{ '{:,.2f}'.format(r.vat or 0) }}</td>
              <td class="text-end">{{ '{:,.2f}'.format(r.discount or 0) }}</td>
              <td class="text-end">{{ '{:,.2f}'.format(r.final_total or 0) }}</td>
              <td class="text-center">{{ r.items_count }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="row mt-3">
        <div class="col-md-6">
          <h6 class="mb-2">{{ _('Top Purchased Ingredients') }}</h6>
          <div class="bar-chart">
            {% for b in top_ingredients %}
              <div class="bar">
                <div class="name">{{ b.name }}</div>
                {% set pct = (b.total / (top_total_max or 1)) if top_ingredients %}
                <div class="val" style="width: {{ (pct * 100)|round(1) }}%"></div>
                <div class="intel-num">{{ '{:,.2f}'.format(b.total or 0) }}</div>
              </div>
            {% endfor %}
          </div>
        </div>
        <div class="col-md-6">
          <h6 class="mb-2">{{ _('Purchase Trend') }}</h6>
          <div class="spark">
            {% for p in purchase_trend %}
            {% set h = (p.total / (trend_max_total or 1)) * 38 %}
            <div class="pt" title="{{ p.date }}" style="height: {{ h|round(1) }}px"></div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div class="intel-sec">
      <h5 class="mb-2">{{ _('Meal Cost & Sales Analysis') }}</h5>
      <div class="mb-2 d-flex flex-wrap gap-2 align-items-end">
        <div>
          <label class="form-label">{{ _('Start Date') }}</label>
          <input id="salesStart" type="date" class="form-control" value="{{ start_date_val or '' }}">
        </div>
        <div>
          <label class="form-label">{{ _('End Date') }}</label>
          <input id="salesEnd" type="date" class="form-control" value="{{ end_date_val or '' }}">
        </div>
        <div>
          <label class="form-label">{{ _('Branch') }}</label>
          <select id="salesBranch" class="form-select" style="min-width:180px;">
            <option value="">{{ _('All') }}</option>
            {% for code, name in (branches or {}).items() %}
            <option value="{{ code }}" {% if selected_branch == code %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <button id="applySalesFilter" class="btn btn-outline-primary">{{ _('Apply') }}</button>
        </div>
      </div>
      {% if outdated_meals and outdated_meals|length > 0 %}
        <div class="alert alert-warning"><i class="fa-solid fa-triangle-exclamation me-2"></i>{{ _('Meals using ingredients with outdated cost data') }}: {{ outdated_meals|join(', ') }}</div>
      {% endif %}
      <div class="table-responsive screen-table-wrap">
        <table class="table table-sm table-hover screen-table">
          <thead>
            <tr>
              <th>{{ _('Meal') }}</th>
              <th class="text-center">{{ _('Sales Count') }}</th>
              <th class="text-end">{{ _('Consumption Cost') }}</th>
              <th class="text-end">{{ _('Revenue') }}</th>
              <th class="text-end">{{ _('Profit') }}</th>
              <th class="text-end">Margin / Ø§Ù„Ù‡Ø§Ù…Ø´</th>
              <th>{{ _('Contribution') }}</th>
            </tr>
          </thead>
          <tbody>
            {% set total_profit = meals_analysis|map(attribute='profit')|sum if meals_analysis else 0 %}
            {% for m in meals_analysis %}
            {% set margin = (100 * (m.profit / m.revenue)) if m.revenue else 0 %}
            {% set contrib = (100 * (m.profit / total_profit)) if total_profit else 0 %}
            <tr>
              <td>{{ m.meal_name }}</td>
              <td class="text-center">{{ '{:,.0f}'.format(m.sold_qty or 0) }}</td>
              <td class="text-end">{{ '{:,.2f}'.format(m.consumption_cost or 0) }}</td>
              <td class="text-end">{{ '{:,.2f}'.format(m.revenue or 0) }}</td>
              <td class="text-end">{{ '{:,.2f}'.format(m.profit or 0) }}</td>
              <td class="text-end">{{ '{:,.1f}'.format(margin) }}%</td>
              <td class="d-flex align-items-center justify-content-between">
                <span>{{ '{:,.1f}'.format(contrib) }}%</span>
                <button type="button" class="btn btn-sm btn-outline-primary" data-toggle-meal="{{ m.meal_name }}">{{ _('Details') }}</button>
              </td>
            </tr>
            <tr class="d-none" data-meal-row="{{ m.meal_name }}">
              <td colspan="7">
                <div class="table-responsive screen-table-wrap">
                  <table class="table table-sm table-bordered mb-0 screen-table">
                    <thead>
                      <tr>
                        <th>{{ _('Invoice') }}</th>
                        <th>{{ _('Date') }}</th>
                        <th class="text-end">{{ _('Qty') }}</th>
                        <th class="text-end">{{ _('Unit') }}</th>
                        <th class="text-end">{{ _('Total') }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for d in (sold_details_map.get(m.meal_name) or []) %}
                      <tr>
                        <td>{{ d.invoice_number }}</td>
                        <td>{{ d.date }}</td>
                        <td class="text-end">{{ '{:,.2f}'.format(d.quantity or 0) }}</td>
                        <td class="text-end">{{ '{:,.2f}'.format(d.unit_price or 0) }}</td>
                        <td class="text-end">{{ '{:,.2f}'.format(d.total_price or 0) }}</td>
                      </tr>
                      {% endfor %}
                      {% if not (sold_details_map.get(m.meal_name) or []) %}
                      <tr><td colspan="5" class="text-muted">{{ _('No details') }}</td></tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="intel-sec">
      <h5 class="mb-2">{{ _('Dynamic Stock Analysis') }}</h5>
      <div class="table-responsive screen-table-wrap">
        <table class="table table-sm table-hover screen-table">
          <thead>
            <tr>
              <th>{{ _('Ingredient') }}</th>
              <th class="text-end">{{ _('Opening Qty') }}</th>
              <th class="text-end">{{ _('Purchases Qty') }}</th>
              <th class="text-end">{{ _('Estimated Usage') }}</th>
              <th class="text-end">{{ _('Expected Stock') }}</th>
              <th>{{ _('Risk') }}</th>
            </tr>
          </thead>
          <tbody>
            {% for r in stock_rows %}
            <tr>
              <td>{{ r.ingredient }}</td>
              <td class="text-end">{{ '{:,.3f}'.format(r.opening_qty or 0) }}</td>
              <td class="text-end">{{ '{:,.3f}'.format(r.purchases_qty or 0) }}</td>
              <td class="text-end">{{ '{:,.3f}'.format(r.estimated_usage or 0) }}</td>
              <td class="text-end">{{ '{:,.3f}'.format(r.expected_stock or 0) }}</td>
              <td><span class="risk {{ r.risk }}">{{ r.risk|capitalize }}</span></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
            </div>
        </main>
    </div>
</div>
<script>
document.querySelectorAll('.ops-tabs-wrap .ops-tab[data-panel]').forEach(function(btn){
  btn.addEventListener('click', function(){
    var id = this.getAttribute('data-panel');
    document.querySelectorAll('.ops-tabs-wrap .ops-tab[data-panel]').forEach(function(b){ b.classList.remove('active'); });
    document.querySelectorAll('.ops-panel[data-panel]').forEach(function(p){ p.classList.add('d-none'); });
    this.classList.add('active');
    var p = document.getElementById(id);
    if (p) p.classList.remove('d-none');
  });
});
</script>
<script>
(function(){
  document.addEventListener('click', function(e){
    var btn = e.target.closest('[data-toggle-items]');
    if(!btn) return;
    var id = btn.getAttribute('data-toggle-items');
    var row = document.querySelector('tr[data-items-row="' + id + '"]');
    if(!row) return;
    var showText = '{{ _('Show Items') }}';
    var hideText = '{{ _('Hide Items') }}';
    if(row.classList.contains('d-none')){ row.classList.remove('d-none'); btn.textContent = hideText; }
    else { row.classList.add('d-none'); btn.textContent = showText; }
  });
  document.addEventListener('click', function(e){
    var btn = e.target.closest('[data-toggle-meal]');
    if(!btn) return;
    var key = btn.getAttribute('data-toggle-meal');
    var row = document.querySelector('tr[data-meal-row="' + key + '"]');
    if(!row) return;
    var showText = '{{ _('Details') }}';
    var hideText = '{{ _('Hide') }}';
    if(row.classList.contains('d-none')){ row.classList.remove('d-none'); btn.textContent = hideText; }
    else { row.classList.add('d-none'); btn.textContent = showText; }
  });
  document.getElementById('applySalesFilter')?.addEventListener('click', function(ev){
    ev.preventDefault();
    var s = document.getElementById('salesStart')?.value || '';
    var e = document.getElementById('salesEnd')?.value || '';
    var b = document.getElementById('salesBranch')?.value || '';
    var url = new URL(window.location.href);
    var q = url.searchParams;
    if(s) q.set('start_date', s); else q.delete('start_date');
    if(e) q.set('end_date', e); else q.delete('end_date');
    if(b) q.set('branch', b); else q.delete('branch');
    url.search = q.toString();
    window.location.href = url.toString();
  });
})();
</script>

{% endblock %}
