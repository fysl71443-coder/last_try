<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Receipt Print - {{ invoice_number }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/receipt.css') }}">
    <style>
        {% set pw = (settings.receipt_paper_width if settings and settings.receipt_paper_width else '80') %}
        {% set fs = (settings.receipt_font_size if settings and settings.receipt_font_size else 12) %}
        {% set logo_h = (settings.receipt_logo_height if settings and settings.receipt_logo_height else 100) %}
        {% set extra_bottom = (settings.receipt_extra_bottom_mm if settings and (settings.receipt_extra_bottom_mm is not none) else 15) %}
        /* تنسيقات مبسطة للطباعة الحرارية */
        body {
            font-family: "DejaVu Sans", Arial, sans-serif;
            font-size: {{ fs }}px;
            margin: 0;
            padding: 0;
            color: #000;
        }
        .receipt {
            width: {{ pw }}mm;
            max-width: {{ pw }}mm;
            padding: 8px;
            margin: 0 auto;
        }
        .center { text-align: center; }
        .logo {
            max-height: {{ logo_h }}px;
            max-width: {{ logo_h|int * 3 }}px;
            object-fit: contain;
            margin-bottom: 12px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        .items td {
            padding: 4px 0;
            border-bottom: 1px solid #000;
            color: #000;
        }
        .totals td {
            padding: 6px 0;
        }
        .small {
            font-size: {{ (fs|int - 1) if (fs|int > 9) else fs }}px;
            color: #000;
        }
        hr {
            border: none;
            border-top: 2px solid #000;
            margin: 8px 0;
        }
        .qr-section {
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .qr-code {
            width: 80px;
            height: 80px;
        }
        .payment-info {
            flex: 1;
        }
        .thank-you {
            margin-top: 12px;
            font-weight: 800;
            font-size: {{ (fs|int + 3) }}px;
        }

        /* طباعة */
        @media print {
            body { 
              margin: 0; 
              font-size: {{ (fs|int + 2) if (fs|int < 15) else fs }}px; 
              -webkit-print-color-adjust: exact; 
              color-adjust: exact; 
              print-color-adjust: exact; 
              color: #000; 
            }
            /* Re-assert black for all text elements */
            body, h1, h2, h3, h4, h5, h6, p, span, div, td, th, small, strong, em, b, i, table, .thank-you, .small { color: #000 !important; }
            .receipt { width: {{ pw }}mm; max-width: {{ pw }}mm; }
            @page { margin: 0 0 {{ extra_bottom }}mm 0; size: {{ pw }}mm auto; }
        }
    </style>
</head>
<body onload="window.print()">
    <div class="receipt">
        <!-- Header with Logo -->
        <div class="center">
            {% if settings and settings.receipt_show_logo and settings.logo_url %}
            <img src="{{ settings.logo_url }}" class="logo" alt="logo">
            {% endif %}
            <h2>{{ settings.company_name if settings else 'Restaurant' }}</h2>
            {% if (not settings) or (settings and settings.receipt_show_tax_number) %}
            <div class="small">VAT: {{ settings.tax_number if settings else 'N/A' }}</div>
            {% endif %}
            <div class="small">{{ settings.address if settings else 'Address' }}</div>
            <div class="small">Tel: {{ settings.phone if settings else 'Phone' }}</div>
            <hr>
        </div>

        <!-- Invoice Details -->
        <div>
            <div>Branch: <strong>{{ branch_name }}</strong></div>
            <div>Date: {{ local_dt.strftime('%Y-%m-%d %H:%M:%S') }}</div>
            <div>Invoice: <strong>{{ invoice_number }}</strong></div>
            <div>Customer: {{ invoice.customer_name or invoice.customer_phone or '-' }}</div>
            {% if invoice.table_number %}
            <div>Table: {{ invoice.table_number }}</div>
            {% endif %}
        </div>

        <hr>

        <!-- Items -->
        <table class="items">
            {% for item in items %}
            <tr>
                <td>{{ item.product_name }}</td>
                <td style="text-align:center">x{{ item.quantity }}</td>
                <td style="text-align:right">{{ '%.2f' % item.price_before_tax }}</td>
            </tr>
            {% endfor %}
        </table>

        <hr>

        <!-- Totals -->
        <table class="totals">
            <tr>
                <td>Subtotal</td>
                <td style="text-align:right">{{ '%.2f' % subtotal }}{% if settings and settings.currency_image %} <img src="{{ settings.currency_image }}" width="12" height="12" alt="currency">{% elif currency_data_url %} <img src="{{ currency_data_url }}" width="12" height="12" alt="currency">{% endif %}</td>
            </tr>
            {% if invoice.discount_amount and invoice.discount_amount > 0 %}
            <tr>
                <td>Discount</td>
                <td style="text-align:right">-{{ '%.2f' % invoice.discount_amount }}{% if settings and settings.currency_image %} <img src="{{ settings.currency_image }}" width="12" height="12" alt="currency">{% elif currency_data_url %} <img src="{{ currency_data_url }}" width="12" height="12" alt="currency">{% endif %}</td>
            </tr>
            {% endif %}
            <tr>
                <td>VAT ({{ (settings.vat_rate if settings else 15)|int }}%)</td>
                <td style="text-align:right">{{ '%.2f' % vat_amount }}{% if settings and settings.currency_image %} <img src="{{ settings.currency_image }}" width="12" height="12" alt="currency">{% elif currency_data_url %} <img src="{{ currency_data_url }}" width="12" height="12" alt="currency">{% endif %}</td>
            </tr>
            <tr style="border-top: 2px solid #333;">
                <td><strong>Total</strong></td>
                <td style="text-align:right"><strong>{{ '%.2f' % total }}{% if settings and settings.currency_image %} <img src="{{ settings.currency_image }}" width="12" height="12" alt="currency">{% elif currency_data_url %} <img src="{{ currency_data_url }}" width="12" height="12" alt="currency">{% endif %}</strong></td>
            </tr>
            {% if invoice and (invoice.payment_method or (invoice.status and invoice.status.lower() == 'paid')) %}
            <tr>
                <td>Payment</td>
                <td style="text-align:right">{{ (invoice.payment_method or 'Cash')|title }}</td>
            </tr>
            {% endif %}
        </table>

        <!-- Payment & QR Code -->
        <div class="qr-section">
            <div class="payment-info">
                {% if invoice and (invoice.status and invoice.status.lower() == 'paid') %}
                <div class="small">Payment: {{ (invoice.payment_method or 'Cash')|title }}</div>
                {% endif %}
                {% if invoice.status %}
                <div class="small">Status: {{ invoice.status.upper() }}</div>
                {% endif %}
            </div>
            {% if qr_b64 %}
            <div class="center">
                <img src="data:image/png;base64,{{ qr_b64 }}" alt="ZATCA QR Code" class="qr-code">
            </div>
            {% endif %}
        </div>

        <!-- Footer -->
        <div class="center thank-you">
            {% if settings and settings.receipt_footer_text %}
              {{ settings.receipt_footer_text }}
            {% elif settings and settings.footer_message %}
              {{ settings.footer_message }}
            {% else %}
              THANK YOU FOR VISIT
            {% endif %}
        </div>
    </div>
</body>
</html>
