{% extends "base.html" %}
{% block content %}
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-3">
      <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" style="height:48px;">
      <div>
        <div class="fw-bold">{{ (settings.company_name if settings and settings.company_name else 'Company') }}</div>
        {% if current_user.is_authenticated %}<div class="text-muted small">{{ _('Welcome') }} {{ current_user.username }}</div>{% endif %}
      </div>
    </div>
    <div class="text-end">
      <h2 class="mb-1">ğŸ§¾ Payroll Statements / ÙƒØ´ÙˆÙØ§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨</h2>
      <a class="btn btn-outline-primary" href="{{ url_for('main.dashboard') }}">â¬…ï¸ Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
    </div>
  </div>

  <form method="GET" class="filters d-flex gap-2 align-items-end flex-wrap" id="filtersForm">
    <label class="form-label">Year / Ø§Ù„Ø³Ù†Ø©</label>
    <select name="year" class="form-select">
      {% for y in years %}
        <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
      {% endfor %}
    </select>

    <label class="form-label">Month / Ø§Ù„Ø´Ù‡Ø±</label>
    <select name="month" class="form-select">
      {% for m in months %}
        <option value="{{ m.value }}" {% if m.value == month %}selected{% endif %}>{{ m.label }}</option>
      {% endfor %}
    </select>

    <label class="form-label">Status / Ø§Ù„Ø­Ø§Ù„Ø©</label>
    <select name="status" class="form-select">
      <option value="all" {% if status=="all" %}selected{% endif %}>ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
      <option value="due" {% if status=="due" %}selected{% endif %}>Ù…Ø³ØªØ­Ù‚Ø©</option>
      <option value="partial" {% if status=="partial" %}selected{% endif %}>Ø¬Ø²Ø¦ÙŠ</option>
      <option value="paid" {% if status=="paid" %}selected{% endif %}>Ù…Ø¯ÙÙˆØ¹Ø©</option>
    </select>
    <label class="form-label">Department / Ø§Ù„Ù‚Ø³Ù…</label>
    <select name="dept" class="form-select">
      <option value="">Ø§Ù„ÙƒÙ„</option>
      {% for d in (dept_options or []) %}
        <option value="{{ d }}" {% if d == (dept_selected or '') %}selected{% endif %}>{{ d }}</option>
      {% endfor %}
    </select>
    
    <button type="button" class="btn btn-outline-secondary" id="btnPrintMonth">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
    <button type="button" class="btn btn-outline-dark" id="btnPrintDetailed">ğŸ–¨ï¸ ØªÙ‚Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠ Ù„Ù„ÙØªØ±Ø©</button>
  </form>

  <div class="small text-muted mb-2">
    Year / Ø§Ù„Ø³Ù†Ø© {{ year }} â€¢ Month / Ø§Ù„Ø´Ù‡Ø± {{ month }} â€¢ Status / Ø§Ù„Ø­Ø§Ù„Ø© {{ 'Ø§Ù„ÙƒÙ„' if status=='all' else ('Ù…Ø³ØªØ­Ù‚Ø©' if status=='due' else ('Ø¬Ø²Ø¦ÙŠ' if status=='partial' else 'Ù…Ø¯ÙÙˆØ¹Ø©')) }}
  </div>
  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <div class="p-3 border rounded bg-light">
        <div class="text-muted small mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª</div>
        {% set total_ded = payrolls|sum(attribute='deductions') %}
        <div class="fw-bold">{{ '%.2f'|format(total_ded or 0) }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="p-3 border rounded bg-light">
        <div class="text-muted small mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù„Ù Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</div>
        <div class="fw-bold">{{ '%.2f'|format(emp_adv_total or 0) }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="p-3 border rounded bg-light">
        <div class="text-muted small mb-1">Ø¹Ø¯Ø¯ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
        <div class="fw-bold">{{ journal_count or 0 }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="p-3 border rounded bg-light">
        <div class="text-muted small mb-1">Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©</div>
        <div>
          <span class="badge bg-success">Ù…Ø¯ÙÙˆØ¹Ø©</span>
          <span class="badge bg-warning text-dark">Ø¬Ø²Ø¦ÙŠ</span>
          <span class="badge bg-danger">Ù…Ø³ØªØ­Ù‚Ø©</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const f = document.getElementById('filtersForm');
  if(!f) return;
  const y = f.querySelector('[name="year"]');
  const m = f.querySelector('[name="month"]');
  const s = f.querySelector('[name="status"]');
  const dept = f.querySelector('[name="dept"]');
  function apply(){
    const params = new URLSearchParams(window.location.search);
    if(y) params.set('year', y.value);
    if(m) params.set('month', m.value);
    if(s) params.set('status', s.value);
    if(dept) params.set('dept', dept.value);
    try{
      const store = { year: y?.value||'', month: m?.value||'', status: s?.value||'', dept: dept?.value||'' };
      localStorage.setItem('payroll_filters', JSON.stringify(store));
    }catch(e){}
    window.location.search = params.toString();
  }
  (function(){ try{ const raw = localStorage.getItem('payroll_filters'); if(raw){ const st = JSON.parse(raw); if(y && st.year) y.value = st.year; if(m && st.month) m.value = st.month; if(s && st.status) s.value = st.status; if(dept && st.dept !== undefined) dept.value = st.dept; } }catch(e){} })();
  y && y.addEventListener('change', apply);
  m && m.addEventListener('change', apply);
  s && s.addEventListener('change', apply);
  dept && dept.addEventListener('change', apply);
  const btnMonth = document.getElementById('btnPrintMonth');
  const btnDet = document.getElementById('btnPrintDetailed');
  if(btnMonth){ btnMonth.addEventListener('click', function(){ openPrintModal('{{ url_for('main.payroll_print', year=year, month=month) }}'); }); }
  if(btnDet){ btnDet.addEventListener('click', function(){ openPrintModal('{{ url_for('reports.payroll_report', year_from=year, month_from=month, year_to=year, month_to=month, print=1) }}'); }); }
})();
</script>

  <div class="small text-muted mb-2"></div>

  {% set ns = namespace(basic=0, allowances=0, deductions=0, prev_due=0, total=0, paid=0, remaining=0) %}
  <div class="table-responsive">
  <table class="table table-bordered table-sm align-middle">
    <thead class="table-light">
      <tr>
        <th>#</th>
        <th>Employee / Ø§Ù„Ù…ÙˆØ¸Ù</th>
        <th class="text-end">Basic / Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th>
        <th class="text-end">Allowances / Ø§Ù„Ø¨Ø¯Ù„Ø§Øª</th>
        <th class="text-end">Deductions / Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª</th>
        <th class="text-end">Prev Due / Ø³Ø§Ø¨Ù‚Ø©</th>
        <th class="text-end">Total / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
        <th class="text-end">Paid / Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
        <th class="text-end">Remaining / Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
        <th>Status / Ø§Ù„Ø­Ø§Ù„Ø©</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for p in payrolls %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ p.employee.full_name }}</td>
        <td class="text-end">{{ "%.2f"|format(p.basic) }}</td>
        <td class="text-end">{{ "%.2f"|format(p.allowances) }}</td>
        <td class="text-end">{{ "%.2f"|format(p.deductions) }}</td>
        <td class="text-end">{{ "%.2f"|format(p.prev_due) }}</td>
        <td class="text-end">{{ "%.2f"|format(p.total) }}</td>
        <td class="text-end text-success fw-bold">{{ "%.2f"|format(p.paid) }}</td>
        <td class="text-end {% if p.remaining > 0 %}text-danger{% else %}text-success{% endif %} fw-bold">{{ "%.2f"|format(p.remaining) }}</td>
        <td>
          {% if p.status == "due" %}
            <span class="badge bg-danger">Ù…Ø³ØªØ­Ù‚Ø©</span>
          {% elif p.status == "partial" %}
            <span class="badge bg-warning text-dark">Ø¬Ø²Ø¦ÙŠ</span>
          {% else %}
            <span class="badge bg-success">Ù…Ø¯ÙÙˆØ¹Ø©</span>
          {% endif %}
        </td>
        <td>
          {% if p.status != 'paid' and p.remaining > 0 %}
            <a href="{{ url_for('main.pay_salary', emp_id=p.employee.id, month=month, year=year) }}" class="btn btn-sm btn-success">ğŸ’µ Ø³Ø¯Ø§Ø¯</a>
          {% endif %}
        </td>
      </tr>
      {% set ns.basic = ns.basic + (p.basic or 0) %}
      {% set ns.allowances = ns.allowances + (p.allowances or 0) %}
      {% set ns.deductions = ns.deductions + (p.deductions or 0) %}
      {% set ns.prev_due = ns.prev_due + (p.prev_due or 0) %}
      {% set ns.total = ns.total + (p.total or 0) %}
      {% set ns.paid = ns.paid + (p.paid or 0) %}
      {% set ns.remaining = ns.remaining + (p.remaining or 0) %}
      {% endfor %}
    </tbody>
    <tfoot class="table-light">
      <tr>
        <th colspan="2" class="text-end">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª</th>
        <th class="text-end">{{ '%.2f'|format(ns.basic) }}</th>
        <th class="text-end">{{ '%.2f'|format(ns.allowances) }}</th>
        <th class="text-end">{{ '%.2f'|format(ns.deductions) }}</th>
        <th class="text-end">{{ '%.2f'|format(ns.prev_due) }}</th>
        <th class="text-end">{{ '%.2f'|format(ns.total) }}</th>
        <th class="text-end text-success">{{ '%.2f'|format(ns.paid) }}</th>
        <th class="text-end {% if ns.remaining>0 %}text-danger{% else %}text-success{% endif %}">{{ '%.2f'|format(ns.remaining) }}</th>
        <th></th>
        <th></th>
      </tr>
    </tfoot>
  </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  var form = document.querySelector('form.filters');
  if(!form) return;
  function submitWithSpinner(){
    var btn = document.createElement('div');
    btn.className = 'spinner-border text-primary';
    btn.style.marginLeft = '8px';
    form.appendChild(btn);
    form.submit();
  }
  ['year','month','status'].forEach(function(name){
    var el = form.querySelector('[name="'+name+'"]');
    if(el){ el.addEventListener('change', submitWithSpinner); }
  });
})();
</script>
{% endblock %}
