{% extends "base.html" %}
{% block content %}
<div class="container">
  <div class="d-flex justify-content-between align-items-center">
    <h2 class="mb-2">ğŸ§¾ Payroll Statements / ÙƒØ´ÙˆÙØ§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨</h2>
    <a class="btn btn-outline-primary" href="{{ url_for('main.dashboard') }}">â¬…ï¸ Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
  </div>

  <form method="GET" class="filters d-flex gap-2 align-items-end flex-wrap">
    <label>Year / Ø§Ù„Ø³Ù†Ø©</label>
    <select name="year">
      {% for y in years %}
        <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
      {% endfor %}
    </select>

    <label>Month / Ø§Ù„Ø´Ù‡Ø±</label>
    <select name="month">
      {% for m in months %}
        <option value="{{ m.value }}" {% if m.value == month %}selected{% endif %}>{{ m.label }}</option>
      {% endfor %}
    </select>

    <label>Status / Ø§Ù„Ø­Ø§Ù„Ø©</label>
    <select name="status">
      <option value="all" {% if status=="all" %}selected{% endif %}>ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
      <option value="due" {% if status=="due" %}selected{% endif %}>Ù…Ø³ØªØ­Ù‚Ø©</option>
      <option value="partial" {% if status=="partial" %}selected{% endif %}>Ø¬Ø²Ø¦ÙŠ</option>
      <option value="paid" {% if status=="paid" %}selected{% endif %}>Ù…Ø¯ÙÙˆØ¹Ø©</option>
    </select>
    <button class="btn btn-primary">ğŸ” Ø¨Ø­Ø«</button>
    <button type="button" class="btn btn-outline-secondary" onclick="openPrintModal('{{ url_for('main.payroll_print', year=year, month=month) }}')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
    <button type="button" class="btn btn-outline-dark" onclick="openPrintModal('{{ url_for('reports.payroll_report', year_from=year, month_from=month, year_to=year, month_to=month, print=1) }}')">ğŸ–¨ï¸ ØªÙ‚Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠ Ù„Ù„ÙØªØ±Ø©</button>
  </form>

  <div class="small text-muted mb-2">
    <span class="me-2">Paid/Ø§Ù„Ù…Ø¯ÙÙˆØ¹ = <span class="text-success fw-bold">Ø£Ø®Ø¶Ø±</span></span>
    <span class="me-2">Remaining/Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ = <span class="text-danger fw-bold">Ø£Ø­Ù…Ø±</span> Ø¥Ø°Ø§ > 0</span>
    <span class="me-2">Status = <span class="badge bg-success">Ù…Ø¯ÙÙˆØ¹Ø©</span> / <span class="badge bg-warning text-dark">Ø¬Ø²Ø¦ÙŠ</span> / <span class="badge bg-danger">Ù…Ø³ØªØ­Ù‚Ø©</span></span>
  </div>

  <table class="styled-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Employee / Ø§Ù„Ù…ÙˆØ¸Ù</th>
        <th class="text-end">Basic / Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th>
        <th class="text-end">Allowances / Ø§Ù„Ø¨Ø¯Ù„Ø§Øª</th>
        <th class="text-end">Deductions / Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª</th>
        <th class="text-end">Prev Due / Ø³Ø§Ø¨Ù‚Ø©</th>
        <th class="text-end">Total / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
        <th class="text-end">Paid / Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
        <th class="text-end">Remaining / Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
        <th>Status / Ø§Ù„Ø­Ø§Ù„Ø©</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for p in payrolls %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ p.employee.full_name }}</td>
        <td class="text-end">{{ "%.2f"|format(p.basic) }}</td>
        <td class="text-end">{{ "%.2f"|format(p.allowances) }}</td>
        <td class="text-end">{{ "%.2f"|format(p.deductions) }}</td>
        <td class="text-end">{{ "%.2f"|format(p.prev_due) }}</td>
        <td class="text-end">{{ "%.2f"|format(p.total) }}</td>
        <td class="text-end text-success fw-bold">{{ "%.2f"|format(p.paid) }}</td>
        <td class="text-end {% if p.remaining > 0 %}text-danger{% else %}text-success{% endif %} fw-bold">{{ "%.2f"|format(p.remaining) }}</td>
        <td>
          {% if p.status == "due" %}
            <span class="badge bg-danger">Ù…Ø³ØªØ­Ù‚Ø©</span>
          {% elif p.status == "partial" %}
            <span class="badge bg-warning text-dark">Ø¬Ø²Ø¦ÙŠ</span>
          {% else %}
            <span class="badge bg-success">Ù…Ø¯ÙÙˆØ¹Ø©</span>
          {% endif %}
        </td>
        <td>
          {% if p.status != 'paid' and p.remaining > 0 %}
            <a href="{{ url_for('main.pay_salary', emp_id=p.employee.id, month=month, year=year) }}" class="btn btn-sm btn-success">ğŸ’µ Ø³Ø¯Ø§Ø¯</a>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  var form = document.querySelector('form.filters');
  if(!form) return;
  function submitWithSpinner(){
    var btn = document.createElement('div');
    btn.className = 'spinner-border text-primary';
    btn.style.marginLeft = '8px';
    form.appendChild(btn);
    form.submit();
  }
  ['year','month','status'].forEach(function(name){
    var el = form.querySelector('[name="'+name+'"]');
    if(el){ el.addEventListener('change', submitWithSpinner); }
  });
})();
</script>
{% endblock %}
