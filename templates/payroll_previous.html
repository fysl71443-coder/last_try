{% extends 'base.html' %}
{% block title %}{{ _('Previous Payroll / Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©') }}{% endblock %}
{% block head %}
<style>
.page-rtl{direction:rtl}
.btn-navy{background:linear-gradient(135deg,#1E40AF 0%,#4F46E5 100%);color:#fff;border:none;position:relative;overflow:hidden}
.btn-navy:hover{filter:brightness(1.05);transform:scale(1.05)}
.glass-card{background:rgba(255,255,255,.75);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.4);box-shadow:0 20px 40px rgba(30,64,175,.15);border-radius:16px}
.kpi-card{display:flex;align-items:center;gap:12px;padding:16px;position:relative}
.kpi-icon{width:40px;height:40px}
.pill-tabs{display:flex;gap:8px;flex-wrap:wrap}
.pill-tab{padding:8px 14px;border-radius:999px;background:#f1f3f5;color:#1E40AF;border:1px solid #e6e9ee;cursor:pointer;position:relative}
.pill-tab.active{background:linear-gradient(135deg,#1E40AF,#4F46E5);color:#fff}
.pill-tab.active::after{content:"";position:absolute;bottom:-2px;left:12px;right:12px;height:3px;background:linear-gradient(90deg,#06B6D4,#22D3EE);filter:drop-shadow(0 0 6px rgba(6,182,212,.6))}
.table-hover-elevate tbody tr{transition:all .18s ease}
.table-hover-elevate tbody tr:hover{background:linear-gradient(90deg, rgba(79,70,229,.06), rgba(79,70,229,.0));box-shadow:0 4px 16px rgba(0,0,0,.08);transform:translateY(-1px)}
.avatar{width:36px;height:36px;border-radius:50%;background:#e9eef5}
.sticky-wrap{position:relative}
.sticky-wrap .table thead th{position:sticky;top:0;background:#fff;z-index:2;box-shadow:0 2px 0 rgba(0,0,0,.06)}
.logo{transition:transform .18s ease;will-change:transform}
.suggest-box{position:absolute;top:100%;right:0;left:0;z-index:30;background:#0b1020;border:1px solid #0ea5e9;border-top:none;border-radius:0 0 12px 12px;box-shadow:0 12px 20px rgba(0,0,0,.35);display:none;max-height:220px;overflow:auto}
.suggest-item{padding:10px 12px;cursor:pointer;color:#e2f6ff}
.suggest-item .hl{color:#22D3EE;text-shadow:0 0 8px rgba(34,211,238,.8)}
.suggest-item:hover{background:#0b1a2e}
.ripple::after{content:"";position:absolute;left:50%;top:50%;width:5px;height:5px;background:radial-gradient(circle, rgba(255,255,255,.8) 0%, rgba(255,255,255,0) 70%);transform:translate(-50%,-50%) scale(0);border-radius:50%;opacity:0;transition:transform .5s ease, opacity .8s ease}
.ripple:active::after{transform:translate(-50%,-50%) scale(20);opacity:1}
.toast-pp{position:fixed;top:16px;right:16px;background:#09122a;color:#e2f6ff;border:1px solid #22D3EE;border-radius:12px;box-shadow:0 12px 24px rgba(0,0,0,.35);padding:12px 16px;z-index:1055;animation:ppPulse 2.5s infinite}
@keyframes ppPulse{0%{box-shadow:0 0 0 0 rgba(34,211,238,.5)}70%{box-shadow:0 0 0 12px rgba(34,211,238,0)}100%{box-shadow:0 0 0 0 rgba(34,211,238,0)}}
.offcanvas.show .offcanvas-body{animation:ppScale .25s ease}
@keyframes ppScale{0%{transform:scale(.96);opacity:.0}100%{transform:scale(1);opacity:1}}
.spark{position:absolute;right:16px;bottom:10px;width:120px;height:28px}
.topbar{display:flex;align-items:center;gap:10px}
.btn-grad{background:linear-gradient(135deg,#1E40AF,#4F46E5);color:#fff;border:none;border-radius:12px;padding:10px 14px;position:relative;overflow:hidden}
.btn-grad:hover{transform:scale(1.06)}
.tag-anim{transition:all .25s ease;transform:scale(1);opacity:.95}
.tag-anim.active{transform:scale(1.06);box-shadow:0 12px 20px rgba(79,70,229,.15);opacity:1}
.row-enter{transform:translateY(12px);opacity:0}
.row-enter.row-show{transform:translateY(0);opacity:1;transition:transform .6s ease, opacity .6s ease}
.slide-card{position:fixed;left:0;right:0;bottom:-100%;background:#ffffffee;border-top:1px solid #eaeaea;border-radius:18px 18px 0 0;box-shadow:0 -12px 34px rgba(0,0,0,.12);z-index:1100;padding:16px;backdrop-filter:blur(10px)}
.slide-card.show{bottom:0;transition:bottom .45s ease}
.slide-title{font-weight:800;background:linear-gradient(135deg,#eef4ff,#ffffff);padding:12px;border-radius:12px}
.status-dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-left:6px}
.status-paid{background:#22c55e}
.status-due{background:#ef4444}
.status-review{background:#f59e0b}
.status-arch{background:#0f172a}
</style>
{% endblock %}
{% block content %}
<div class="container py-4 page-rtl">
  <div class="d-flex align-items-center justify-content-between mb-3" id="ppHeader">
    <div class="d-flex align-items-center gap-3">
      <img src="/static/logo.svg" class="logo" style="width:32px;height:32px;border-radius:8px" id="ppLogo">
      <div>
        <div class="fw-semibold" style="color:#0B2347">Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>
        <div class="text-muted small">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© â€º Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>
      </div>
    </div>
    <div class="d-flex align-items-center gap-2 position-relative topbar" style="min-width:360px">
      <input class="form-control" id="ppSearch" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…ÙˆØ¸Ù Ø£Ùˆ Ø§Ù„Ø´Ù‡Ø±...">
      <div id="ppSuggest" class="suggest-box"></div>
      <div class="avatar"></div>
      <button class="btn btn-outline-secondary" id="ppBack">ğŸ”™ Ø±Ø¬ÙˆØ¹</button>
      <a class="btn btn-grad ripple" href="/reports">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</a>
      <button class="btn btn-navy ripple" id="btnImportCSV">âŠ Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ§Ø±ÙŠØ®ÙŠØ©</button>
      <input type="file" id="ppCsv" accept=".csv" hidden>
    </div>
  </div>

  <div id="ppSlide" class="slide-card">
    <div class="slide-title" id="ppSlideTitle"></div>
    <div id="ppSlideBody" class="mt-2"></div>
    <div class="mt-3 d-flex gap-2 align-items-center">
      <div class="d-flex align-items-center gap-2">
        <label for="ppPayMethod" class="text-muted small">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
        <select id="ppPayMethod" class="form-select form-select-sm" style="max-width:140px">
          <option value="cash">CASH</option>
          <option value="bank">BANK</option>
        </select>
      </div>
      <button class="btn btn-navy ripple" id="ppPayNow">ğŸ’³ Ø³Ø¯Ø§Ø¯ Ø±Ø§ØªØ¨ Ø§Ù„Ø¢Ù†</button>
      <button class="btn btn-outline-secondary ripple" id="ppPrintSlip">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© Ø¨ÙŠØ§Ù† Ø±Ø§ØªØ¨</button>
      <button class="btn btn-outline-dark ripple" id="ppJournalBtn">ğŸ“Š Ù‚ÙŠØ¯ Ù…Ø­Ø§Ø³Ø¨ÙŠ</button>
      <button class="btn btn-outline-secondary ripple" id="ppArchive">ğŸ—‚ Ø£Ø±Ø´ÙØ© Ø§Ù„Ø´Ù‡Ø±</button>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-12 col-xl-4"><div class="glass-card kpi-card"><div id="lottieMoneyPP" class="kpi-icon"></div><div class="flex-grow-1"><div class="text-muted small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div><div class="fs-5 fw-bold" id="kpiPPTotal">â€”</div></div><canvas class="spark" id="ppSpark"></canvas></div></div>
    <div class="col-12 col-xl-4"><div class="glass-card kpi-card"><div id="lottieMonthPP" class="kpi-icon"></div><div class="flex-grow-1"><div class="text-muted small">Ø¢Ø®Ø± Ø´Ù‡Ø± ØªÙ… ØµØ±ÙÙ‡</div><div class="fs-6 fw-semibold" id="kpiPPLast">â€”</div></div></div></div>
    <div class="col-12 col-xl-4"><div class="glass-card kpi-card"><div id="lottieCountPP" class="kpi-icon"></div><div class="flex-grow-1"><div class="text-muted small">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©</div><div class="fs-5 fw-bold" id="kpiPPMonths">â€”</div></div></div></div>
  </div>

  <div class="pill-tabs mb-3" id="ppDeptTabs">
    <button class="pill-tab active" data-dept="all">Ø§Ù„ÙƒÙ„</button>
    <button class="pill-tab" data-dept="kitchen">Ø´ÙŠÙ</button>
    <button class="pill-tab" data-dept="hall">Ø§Ù„ØµØ§Ù„Ø©</button>
    <button class="pill-tab" data-dept="admin">Ø¥Ø¯Ø§Ø±ÙŠ</button>
    <button class="pill-tab" data-dept="branches">ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</button>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex align-items-center gap-2 mb-2">
        <input type="month" class="form-control" style="max-width:180px" id="ppMonth">
        <select class="form-select" style="max-width:160px" id="ppStatus"><option value="">Ø§Ù„Ø­Ø§Ù„Ø©</option><option value="paid">Ù…Ø³Ø¯Ø¯</option><option value="due">ØºÙŠØ± Ù…Ø³Ø¯Ø¯</option></select>
      </div>
      <div class="table-responsive sticky-wrap" id="ppGridWrap">
        <table class="table table-borderless table-hover table-hover-elevate align-middle table-sm">
          <thead class="table-light"><tr><th>#</th><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø´Ù‡Ø±</th><th class="text-end">Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th><th class="text-end">OT</th><th class="text-end">Bonus</th><th class="text-end">Total</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>âš™</th></tr></thead>
          <tbody id="ppTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="offcanvas offcanvas-end" tabindex="-1" id="ppCanvas" aria-labelledby="ppCanvasLabel">
    <div class="offcanvas-header" style="background:linear-gradient(135deg,#0B2347,#163D75);color:#fff"><h5 id="ppCanvasLabel">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø§ØªØ¨</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button></div>
    <div class="offcanvas-body">
      <div class="d-grid gap-2">
        <div><span class="text-muted">Ø§Ù„Ù…ÙˆØ¸Ù:</span> <span id="ppName"></span></div>
        <div><span class="text-muted">Ø§Ù„Ø´Ù‡Ø±:</span> <span id="ppMonthLabel"></span></div>
        <div><span class="text-muted">Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ:</span> <span id="ppBasic"></span></div>
        <div><span class="text-muted">OT:</span> <span id="ppOT"></span></div>
        <div><span class="text-muted">Bonus:</span> <span id="ppBonus"></span></div>
        <div><span class="text-muted">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span> <span id="ppTotal"></span></div>
      </div>
      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-navy ripple" id="ppPrint">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
        <button class="btn btn-outline-secondary ripple" id="ppEdit">ğŸ’¾ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn btn-outline-dark ripple" id="ppPreview">ğŸ“Š Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚ÙŠØ¯</button>
      </div>
    </div>
  </div>

</div>
<script>
(async function(){ try{ const r = await fetch('/api/payroll/history'); const j = await r.json(); if(j&&j.ok){ document.getElementById('kpiPPTotal').textContent = 'ï·¼'+Number(j.total||0).toFixed(2); document.getElementById('kpiPPLast').textContent = j.last_month||'â€”'; document.getElementById('kpiPPMonths').textContent = Number(j.months||0); const s=j.series||[]; const cv=document.getElementById('ppSpark'); if(cv&&s.length){ const ctx=cv.getContext('2d'); const w=cv.width=cv.clientWidth; const h=cv.height=cv.clientHeight; const vals=s.map(x=>Number(x.total||0)); const max=Math.max.apply(null,vals.concat([1])); const min=Math.min.apply(null,vals.concat([0])); const pad=4; ctx.clearRect(0,0,w,h); ctx.strokeStyle='#22D3EE'; ctx.lineWidth=2; ctx.beginPath(); s.forEach((x,i)=>{ const vx=pad + (w-2*pad)*i/(s.length-1||1); const vy=h-pad - (h-2*pad)*(vals[i]-min)/(max-min||1); if(i===0) ctx.moveTo(vx,vy); else ctx.lineTo(vx,vy); }); ctx.stroke(); ctx.fillStyle='rgba(79,70,229,.15)'; ctx.beginPath(); s.forEach((x,i)=>{ const vx=pad + (w-2*pad)*i/(s.length-1||1); const vy=h-pad - (h-2*pad)*(vals[i]-min)/(max-min||1); if(i===0) ctx.moveTo(vx,vy); else ctx.lineTo(vx,vy); }); ctx.lineTo(w-pad,h-pad); ctx.lineTo(pad,h-pad); ctx.closePath(); ctx.fill(); } } }catch(e){} }());
async function loadPP(){ const month = document.getElementById('ppMonth')?.value || ''; const status = document.getElementById('ppStatus')?.value || ''; const dept = document.querySelector('#ppDeptTabs .pill-tab.active')?.getAttribute('data-dept') || ''; const url = new URL('/api/payroll/history/list', location.origin); if(month) url.searchParams.set('month', month); if(status) url.searchParams.set('status', status); if(dept && dept!=='all') url.searchParams.set('department', dept); try{ const r = await fetch(url); const j = await r.json(); if(j&&j.ok){ const tbody=document.getElementById('ppTableBody'); tbody.innerHTML=''; let i=0; (j.rows||[]).forEach(x=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${++i}</td><td>${x.employee_name||''}</td><td>${x.month_label||''}</td><td class='text-end'>${Number(x.basic||0).toFixed(2)}</td><td class='text-end'>${Number(x.ot||0).toFixed(2)}</td><td class='text-end'>${Number(x.bonus||0).toFixed(2)}</td><td class='text-end'>${Number(x.total||0).toFixed(2)}</td><td>${x.status||''}</td><td><div class='dropdown'><button class='btn btn-sm btn-outline-secondary' data-bs-toggle='dropdown'>â‹®</button><ul class='dropdown-menu'><li><button class='dropdown-item' data-pp='${encodeURIComponent(JSON.stringify(x))}' data-bs-toggle='offcanvas' data-bs-target='#ppCanvas'>Ù…Ø¹Ø§ÙŠÙ†Ø©</button></li><li><button class='dropdown-item' data-act='edit' data-pp='${encodeURIComponent(JSON.stringify(x))}'>ØªØ¹Ø¯ÙŠÙ„</button></li><li><button class='dropdown-item' data-act='print' data-pp='${encodeURIComponent(JSON.stringify(x))}'>Ø·Ø¨Ø§Ø¹Ø©</button></li><li><button class='dropdown-item' data-act='send' data-pp='${encodeURIComponent(JSON.stringify(x))}'>Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø¯ÙŠØ±</button></li></ul></div></td>`; tbody.appendChild(tr); }); document.querySelectorAll('[data-bs-target="#ppCanvas"]').forEach(b=> b.addEventListener('click', function(){ const x = JSON.parse(decodeURIComponent(this.getAttribute('data-pp')||'%7B%7D')); document.getElementById('ppName').textContent = x.employee_name||''; document.getElementById('ppMonthLabel').textContent = x.month_label||''; document.getElementById('ppBasic').textContent = 'ï·¼'+Number(x.basic||0).toFixed(2); document.getElementById('ppOT').textContent = 'ï·¼'+Number(x.ot||0).toFixed(2); document.getElementById('ppBonus').textContent = 'ï·¼'+Number(x.bonus||0).toFixed(2); document.getElementById('ppTotal').textContent = 'ï·¼'+Number(x.total||0).toFixed(2); }); document.querySelectorAll('[data-act]').forEach(b=> b.addEventListener('click', function(){ const act=this.getAttribute('data-act'); const x = JSON.parse(decodeURIComponent(this.getAttribute('data-pp')||'%7B%7D')); if(act==='print'){ window.open('/salaries/statements/print?year='+x.month_label.split('/')[1]+'&month='+x.month_label.split('/')[0],'_blank'); } else if(act==='send'){ showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒØ´Ù Ù„Ù„Ù…Ø¯ÙŠØ±'); } else if(act==='edit'){ showToast('ÙØªØ­ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); } }); const anyDue=(j.rows||[]).some(r=> (r.status||'').toLowerCase()!=='paid'); if(anyDue){ showToast('Ø±Ø§ØªØ¨ Ø´Ù‡Ø± Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¨Ø¹Ø¯'); } } }catch(e){ }
}
document.getElementById('ppMonth')?.addEventListener('change', loadPP);
document.getElementById('ppStatus')?.addEventListener('change', loadPP);
document.querySelectorAll('#ppDeptTabs .pill-tab').forEach(b=> b.addEventListener('click', function(){ document.querySelectorAll('#ppDeptTabs .pill-tab').forEach(x=> x.classList.remove('active')); this.classList.add('active'); loadPP(); }));
loadPP();
document.getElementById('btnImportCSV')?.addEventListener('click', ()=> document.getElementById('ppCsv').click());
document.getElementById('ppCsv')?.addEventListener('change', async function(){ const f=this.files?.[0]; if(!f) return; const fd=new FormData(); fd.append('file', f); try{ const r = await fetch('/api/payroll-import', { method:'POST', body: fd }); const j = await r.json(); showToast(r.ok&&j.ok?('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: '+(j.imported||0)):'ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯'); loadPP(); }catch(e){ showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©'); } });
try{ lottie.loadAnimation({ container: document.getElementById('lottieMoneyPP'), renderer:'svg', loop:true, autoplay:true, path:'https://lottie.host/7f8da2c2-money.json' }); lottie.loadAnimation({ container: document.getElementById('lottieMonthPP'), renderer:'svg', loop:true, autoplay:true, path:'https://lottie.host/b1c2a3d4-clock.json' }); lottie.loadAnimation({ container: document.getElementById('lottieCountPP'), renderer:'svg', loop:true, autoplay:true, path:'https://lottie.host/92b0a1f1-payroll.json' }); }catch(e){}
function showToast(msg){ const el=document.createElement('div'); el.className='toast-pp'; el.textContent=msg||''; document.body.appendChild(el); setTimeout(()=>{ el.remove(); },5000); }
const EMPS = [{% for e in employees or [] %}'{{ e.full_name|replace("'"," ") }}'{% if not loop.last %},{% endif %}{% endfor %}];
const monthsLabels = [];
document.getElementById('ppSearch')?.addEventListener('input', function(){ const q=(this.value||'').trim(); const box=document.getElementById('ppSuggest'); if(!q){ box.style.display='none'; box.innerHTML=''; return; } const combos = EMPS.flatMap(n=> monthsLabels.map(m=> `${n} â€“ ${m}`)); const list=[...EMPS, ...monthsLabels, ...combos].filter(x=> x && x.toLowerCase().includes(q.toLowerCase())).slice(0,8); box.innerHTML = list.map(t=>{ const s=t.toLowerCase(); const idx=s.indexOf(q.toLowerCase()); const pre=t.substring(0,idx); const mid=t.substring(idx, idx+q.length); const suf=t.substring(idx+q.length); return `<div class='suggest-item'>${pre}<span class='hl'>${mid}</span>${suf}</div>`; }).join(''); box.style.display = list.length?'block':'none'; Array.from(box.querySelectorAll('.suggest-item')).forEach(i=> i.addEventListener('click',()=>{ document.getElementById('ppSearch').value=i.textContent; box.style.display='none'; })); });
document.getElementById('ppBack')?.addEventListener('click', ()=> history.back());
function openJournalPanel(x){ const d=`<div class='d-grid gap-2'><div><span class='text-muted'>Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯:</span> ${x.journal_no||'-'}</div><div><span class='text-muted'>Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> ${x.journal_date||'-'}</div><div><span class='text-muted'>Ù…Ø¯ÙŠÙ†/Ø¯Ø§Ø¦Ù†:</span> ï·¼${Number(x.total||0).toFixed(2)}</div><div><span class='text-muted'>Ø§Ù„Ø´Ø±Ø­:</span> Ø±Ø§ØªØ¨ ${x.employee_name||''} Ù„Ø´Ù‡Ø± ${x.month_label||''}</div><div class='mt-2'><a class='btn btn-outline-dark' href='/journal/entries'>ğŸ” Ù…Ø±Ø§Ø¬Ø¹Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ</a></div></div>`; const card=document.getElementById('ppSlide'); document.getElementById('ppSlideTitle').textContent='Ù‚ÙŠØ¯ Ù…Ø­Ø§Ø³Ø¨ÙŠ'; document.getElementById('ppSlideBody').innerHTML=d; card.classList.add('show'); }
document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ document.getElementById('ppSlide')?.classList.remove('show'); } });
const ppBody = document.getElementById('ppTableBody');
if(ppBody){ const obs = new MutationObserver(()=>{ const m=[]; ppBody.querySelectorAll('tr').forEach(tr=>{ const td = tr.children[2]; if(td) m.push(td.textContent||''); const stCell = tr.children[7]; if(stCell){ const t=(stCell.textContent||'').toLowerCase(); const dot = t.includes('Ù…Ø³Ø¯Ø¯')||t.includes('paid')? 'status-dot status-paid' : (t.includes('ØºÙŠØ±')||t.includes('due')? 'status-dot status-due' : (t.includes('Ù…Ø±Ø§Ø¬Ø¹Ø©')||t.includes('review')? 'status-dot status-review' : 'status-dot status-arch')); if(!stCell.querySelector('.status-dot')){ const sp=document.createElement('span'); sp.className=dot; stCell.appendChild(sp); } } }); monthsLabels.splice(0, monthsLabels.length, ...Array.from(new Set(m.filter(Boolean)))); }); obs.observe(ppBody, { childList: true }); ppBody.addEventListener('click', function(e){ const tr=e.target.closest('tr'); if(!tr) return; const cells=tr.children; const x={ employee_name:(cells[1]?.textContent||''), month_label:(cells[2]?.textContent||''), basic:parseFloat((cells[3]?.textContent||'0').replace(/[^0-9.]/g,''))||0, ot:parseFloat((cells[4]?.textContent||'0').replace(/[^0-9.]/g,''))||0, bonus:parseFloat((cells[5]?.textContent||'0').replace(/[^0-9.]/g,''))||0, total:parseFloat((cells[6]?.textContent||'0').replace(/[^0-9.]/g,''))||0, status:(cells[7]?.textContent||'') }; const card=document.getElementById('ppSlide'); document.getElementById('ppSlideTitle').textContent = (x.employee_name||'')+' â€“ '+(x.month_label||''); document.getElementById('ppSlideBody').innerHTML = `<div class='d-grid gap-2'><div><span class='text-muted'>Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ:</span> ï·¼${Number(x.basic||0).toFixed(2)}</div><div><span class='text-muted'>OT:</span> ï·¼${Number(x.ot||0).toFixed(2)}</div><div><span class='text-muted'>Bonus:</span> ï·¼${Number(x.bonus||0).toFixed(2)}</div><div><span class='text-muted'>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span> ï·¼${Number(x.total||0).toFixed(2)}</div><div><span class='text-muted'>Ø§Ù„Ø­Ø§Ù„Ø©:</span> ${x.status||''}</div></div>`; card.classList.add('show'); document.getElementById('ppPayNow').onclick = ()=> showToast('Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø§ØªØ¨'); document.getElementById('ppPrintSlip').onclick = ()=> window.print(); document.getElementById('ppJournalBtn').onclick = ()=> openJournalPanel(x); document.getElementById('ppArchive').onclick = ()=> showToast('ØªÙ…Øª Ø§Ù„Ø£Ø±Ø´ÙØ©'); }); }
ppBody&&ppBody.addEventListener('click', function(e){ const tr=e.target.closest('tr'); if(!tr) return; const btn=tr.querySelector('button[data-pp]'); let dat=btn?btn.getAttribute('data-pp'):''; let full={}; try{ full=JSON.parse(decodeURIComponent(dat)); }catch(_){ full={}; } const cells=tr.children; window.ppCurrent = { employee_id: full.employee_id||0, month_label:(cells[2]?.textContent||''), total: parseFloat((cells[6]?.textContent||'0').replace(/[^0-9.]/g,''))||0 }; });
document.getElementById('ppPayNow')?.addEventListener('click', async function(){ const sel=window.ppCurrent||null; if(!sel) return; const lab=(sel.month_label||'').trim(); if(!lab||lab.indexOf('/')<0) return; const parts=lab.split('/'); const mm=(parts[0]||'').padStart(2,'0'); const yy=(parts[1]||''); const ym=`${yy}-${mm}`; const amt=Number(sel.total||0); if(!(amt>0)) return; const pm=(document.getElementById('ppPayMethod')?.value||'cash').toLowerCase(); try{ const meta=document.querySelector('meta[name="csrf-token"]'); const tok=meta?meta.getAttribute('content'):''; const fd=new FormData(); fd.append('employee_id', String(sel.employee_id||'')); fd.append('month', ym); fd.append('paid_amount', String(amt)); fd.append('payment_method', pm); const r=await fetch('/api/payroll/pay', { method:'POST', headers:{ 'X-CSRFToken': tok }, body: fd, credentials:'same-origin' }); showToast(r.ok?'ØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­':'ØªØ¹Ø°Ø± Ø§Ù„Ø³Ø¯Ø§Ø¯'); loadPP(); }catch(e){ showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©'); } });
const hdr=document.getElementById('ppHeader'); const lg=document.getElementById('ppLogo'); if(hdr&&lg){ hdr.addEventListener('mousemove', function(ev){ const r=hdr.getBoundingClientRect(); const cx=ev.clientX - r.left; const cy=ev.clientY - r.top; const rx=(cx/r.width - .5)*8; const ry=(cy/r.height - .5)*-8; lg.style.transform = `perspective(300px) rotateY(${rx}deg) rotateX(${ry}deg) scale(1.06)`; }); hdr.addEventListener('mouseleave', function(){ lg.style.transform='none'; }); }
</script>
{% endblock %}
