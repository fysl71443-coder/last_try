{% extends 'base.html' %}
{% if current_user.is_authenticated %}{% set back_url = url_for('main.dashboard') %}{% else %}{% set back_url = '#' %}{% endif %}

{% set back_url = url_for('main.dashboard') %}

{% block title %}{{ _('Monthly Salaries / Ø±ÙˆØ§ØªØ¨ Ø´Ù‡Ø±ÙŠØ©') }}{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">ğŸ’¼ {{ _('Monthly Salaries / Ø±ÙˆØ§ØªØ¨ Ø´Ù‡Ø±ÙŠØ©') }}</h3>
  <a href="{{ url_for('main.dashboard') if current_user.is_authenticated else url_for('main.login') }}" class="btn btn-primary">ğŸ  {{ _('Dashboard / Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…') }}</a>
  </div>

  <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ù†Ø© ÙˆØ§Ù„Ø´Ù‡Ø± -->
  <form method="GET" class="row g-2 align-items-end mb-3">
    <div class="col-auto">
      <label class="form-label">{{ _('Year / Ø§Ù„Ø³Ù†Ø©') }}</label>
      <input type="number" name="year" class="form-control" value="{{ year }}">
    </div>
    <div class="col-auto">
      <label class="form-label">{{ _('Month / Ø§Ù„Ø´Ù‡Ø±') }}</label>
      <select name="month" class="form-select">
        {% for m in range(1,13) %}
          <option value="{{ m }}" {% if m==month %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <button class="btn btn-secondary">{{ _('Show / Ø¹Ø±Ø¶') }}</button>
    </div>
  </form>

  <form method="POST" action="{{ url_for('main.salaries_monthly_save') if current_user.is_authenticated else '#' }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <input type="hidden" name="year" value="{{ year }}">
    <input type="hidden" name="month" value="{{ month }}">

    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead class="table-dark">
              <tr>
                <th>#</th>
                <th>{{ _('Employee / Ø§Ù„Ù…ÙˆØ¸Ù') }}</th>
                <th>{{ _('Basic / Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ') }}</th>
                <th>{{ _('Allowances / Ø§Ù„Ø¨Ø¯Ù„Ø§Øª') }}</th>
                <th>{{ _('Deductions / Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª') }}</th>
                <th>{{ _('Prev Due / Ø³Ø§Ø¨Ù‚Ø©') }}</th>
                <th>{{ _('Total / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ') }}</th>
                <th>{{ _('Paid / Ø§Ù„Ù…Ø¯ÙÙˆØ¹') }}</th>
                <th>{{ _('Remaining / Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ') }}</th>
                <th>{{ _('Pay / Ø¯ÙØ¹') }}</th>
              </tr>
            </thead>
            <tbody>
              {% for r in rows %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>{{ r.employee_name }}</td>
                <td><input type="number" step="0.01" name="basic_salary_{{ r.id }}" class="form-control form-control-sm" value="{{ '%.2f'|format(r.basic_salary) }}"></td>
                <td><input type="number" step="0.01" name="allowances_{{ r.id }}" class="form-control form-control-sm" value="{{ '%.2f'|format(r.allowances) }}"></td>
                <td><input type="number" step="0.01" name="deductions_{{ r.id }}" class="form-control form-control-sm" value="{{ '%.2f'|format(r.deductions) }}"></td>
                <td><input type="number" step="0.01" name="previous_salary_due_{{ r.id }}" class="form-control form-control-sm" value="{{ '%.2f'|format(r.previous_salary_due) }}"></td>
                <td><span class="badge bg-secondary">{{ '%.2f'|format(r.total_salary) }}</span></td>
                <td><span class="badge bg-info">{{ '%.2f'|format(r.paid) }}</span></td>
                <td><span class="badge bg-warning text-dark">{{ '%.2f'|format(r.remaining) }}</span></td>
                <td>
                  <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-success" onclick="payFull('{{ r.id }}','{{ r.remaining }}')">{{ _('Pay Full') }}</button>
                    <button type="button" class="btn btn-outline-success" onclick="payCustom('{{ r.id }}','{{ r.remaining }}')">{{ _('Enter Amount') }}</button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="text-end mt-3">
          <button class="btn btn-primary">ğŸ’¾ {{ _('Save Changes / Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª') }}</button>
        </div>
      </div>
    </div>
  </form>
</div>

<script>
function sendSalaryPayment(id, amount){
  if(!amount || parseFloat(amount)<=0){ alert('{{ _('Invalid amount / Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­') }}'); return; }
  const form = new FormData();
  form.append('invoice_id', id);
  form.append('invoice_type', 'salary');
  form.append('amount', amount);
  const csrf = document.querySelector('input[name="csrf_token"]');
  const tokenMeta = document.querySelector('meta[name="csrf-token"]');
  if(tokenMeta){ form.append('csrf_token', tokenMeta.content); }

  if (csrf) form.append('csrf_token', csrf.value);
  fetch('#', { method:'POST', body: form, credentials:'same-origin' })
    .then(r=>r.json()).then(d=>{ if(d.status==='success') location.reload(); else alert('Error'); })
    .catch(()=>alert('Network error'));
}
function payFull(id, remaining){
  const amt = parseFloat(remaining||0);
  if(!amt || amt<=0){ alert('{{ _('Nothing to pay / Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø¯ÙØ¹') }}'); return; }
  if(!confirm('{{ _('Confirm full payment / ØªØ£ÙƒÙŠØ¯ Ø¯ÙØ¹ ÙƒØ§Ù…Ù„') }}: '+amt)) return;
  sendSalaryPayment(id, amt);
}
function payCustom(id, remaining){
  const input = prompt("{{ _('Enter amount to pay / Ø§Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹') }}\n{{ _('Remaining / Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ') }}: "+remaining);
  if(!input) return;
  const amt = parseFloat((input||'').toString().replace(',', '.'));
  if(!amt || isNaN(amt) || amt<=0){ alert('{{ _('Invalid amount / Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­') }}'); return; }
  sendSalaryPayment(id, amt);
}
</script>
{% endblock %}

