<!DOCTYPE html>
<html lang="{{ get_locale() or 'ar' }}" dir="{{ 'rtl' if (get_locale() or 'ar') == 'ar' else 'ltr' }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ _('Payroll Statement') }} — {{ company_name or 'Company' }}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    @page { size: A4; margin: 12mm; }
    :root { --fg-muted:#666; --border-strong:#333; }
    body { color: #1f2937; }
    @media print {
      .no-print,
      .print-hide,
      #payroll-filters-block,
      #ps-filter-form,
      .d-print-none { display: none !important; visibility: hidden !important; }
      body, body * { color: #000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .table-print th, .table-print td { border-color: #333 !important; }
      .table-print thead th { background: #e8e8e8 !important; color: #000 !important; }
      .table-print tfoot td { background: #e8e8e8 !important; font-weight: 700 !important; }
      tr { page-break-inside: avoid; }
      thead { display: table-header-group; }
      .report-header { page-break-after: avoid; }
      .payroll-unified-block { page-break-inside: avoid; }
      /* إظهار المحتوى الاحترافي فقط: رأس التقرير + الفترة النصية + الجدول */
      .report-header .chip { display: inline-block !important; visibility: visible !important; }
    }
    .report-title { font-weight: 700; margin-bottom: 6px; }
    .report-header { border-bottom: 2px solid var(--border-strong); margin-bottom: 12px; padding-bottom: 8px; }
    .header-card { border: 1px solid #ddd; border-radius: 6px; padding: 10px 12px; background: #fff; }
    .report-logo { height: 50px; max-width: 160px; object-fit: contain; }
    .chip { display: inline-block; padding: 2px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 0.8rem; margin: 2px 6px 2px 0; background: #f7f7f7; }
    .monospace-numbers { font-variant-numeric: tabular-nums; }
    .table-print { font-size: 0.9rem; width: 100%; border-collapse: collapse; }
    .table-print th, .table-print td { padding: 6px 8px; border: 1px solid #ddd; }
    .table-print thead th { background: #e8e8e8; font-weight: 600; }
    .table-print .mono { font-variant-numeric: tabular-nums; }
    .ps-emp { margin-bottom: 1.5rem; }
    .ps-emp-name { font-weight: 700; font-size: 1rem; margin-bottom: 0.5rem; padding: 0.35rem 0.5rem; background: #f5f5f5; border-radius: 6px; }
    .st-paid { color: #0d6efd; }
    .st-partial { color: #fd7e14; }
    .st-due { color: #dc3545; }
    .st-credit { color: #198754; }
  </style>
</head>
<body class="p-4">

  <div class="container py-3">
    <div class="header-card mb-3">
      <div class="row g-2 align-items-center">
        <div class="col-auto">
          {% if show_logo and logo_url %}
            <img src="{{ logo_url }}" alt="logo" class="report-logo" />
          {% endif %}
        </div>
        <div class="col">
          <div class="h5 mb-1">{{ company_name or 'Company' }}</div>
          <div class="small text-muted">VAT: {{ tax_number or '-' }}{% if address %} | {{ address }}{% endif %}</div>
        </div>
        <div class="col-auto text-end">
          <div class="small text-muted">{{ _('Printed') }}: {{ generated_at or '' }}</div>
          <button type="button" class="btn btn-sm btn-outline-secondary no-print mt-1" onclick="window.print()">{{ _('Print') }}</button>
        </div>
      </div>
    </div>

    <div class="report-header payroll-unified-block">
      <h4 class="report-title mb-1">{{ _('Payroll Statement') }} / كشف الرواتب</h4>
      <div class="mt-1">
        <span class="chip">{{ _('Period') }}: {{ period_label }} · {{ generated_at or '' }}</span>
      </div>
      <div class="no-print print-hide mt-2" id="payroll-filters-block">
        <form method="get" action="{{ url_for('reports.print_payroll') }}" id="ps-filter-form" class="border rounded p-3 mb-2 bg-light">
          <div class="row g-2 align-items-end flex-wrap">
            <div class="col-auto">
              <label class="form-label mb-0 small fw-bold">{{ _('Period') }}</label>
              <div class="d-flex gap-2 align-items-center flex-wrap">
                <div class="d-flex align-items-center gap-1">
                  <input type="radio" name="period_mode" id="ps-mode-single" value="single" checked>
                  <label for="ps-mode-single" class="mb-0 small">{{ _('Single month') }}</label>
                </div>
                <input type="month" name="month" id="ps-month" class="form-control form-control-sm" value="{{ '%04d-%02d'|format(year_from|default(year), month_from|default(month)) }}" style="width:10rem;">
                <div class="d-flex align-items-center gap-1">
                  <input type="radio" name="period_mode" id="ps-mode-range" value="range">
                  <label for="ps-mode-range" class="mb-0 small">{{ _('From – To') }}</label>
                </div>
                <input type="month" name="month_from" id="ps-month-from" class="form-control form-control-sm d-none" value="{{ '%04d-%02d'|format(year_from|default(year), month_from|default(month)) }}" style="width:10rem;" placeholder="{{ _('From') }}">
                <span class="d-none" id="ps-range-sep">–</span>
                <input type="month" name="month_to" id="ps-month-to" class="form-control form-control-sm d-none" value="{{ '%04d-%02d'|format(year_to|default(year), month_to|default(month)) }}" style="width:10rem;" placeholder="{{ _('To') }}">
              </div>
            </div>
            <div class="col-auto">
              <label class="form-label mb-0 small fw-bold">{{ _('Employees') }}</label>
              <div class="d-flex gap-1 align-items-start">
                <select name="employee_ids" id="ps-employees" class="form-select form-select-sm" multiple size="4" style="min-width:200px;">
                  {% for e in (all_employees or []) %}
                  <option value="{{ e.id }}" {{ 'selected' if e.id in (selected_employee_ids or []) else '' }}>{{ e.full_name }}{% if e.department %} ({{ e.department }}){% endif %}</option>
                  {% endfor %}
                </select>
                <div class="d-flex flex-column gap-1">
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="ps-emp-all" title="{{ _('Select all') }}">{{ _('All') }}</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="ps-emp-clear" title="{{ _('Clear selection') }}">{{ _('Clear') }}</button>
                </div>
              </div>
              <small class="text-muted">{{ _('Leave empty = All. Select one or more employees.') }}</small>
            </div>
            <div class="col-auto">
              <button type="submit" class="btn btn-sm btn-outline-primary">{{ _('Update') }}</button>
              <a href="{{ url_for('reports.reports') }}" class="btn btn-sm btn-outline-secondary">{{ _('Back to reports') }}</a>
              <button type="button" id="btn-print-payroll" class="btn btn-sm btn-primary"><i class="fa-solid fa-print me-1"></i>{{ _('Print') }}</button>
            </div>
          </div>
        </form>
      </div>
    </div>

  {# تقرير واحد موحد — جدول واحد لجميع الأقسام (admin, hall, kitchen) بدون تقسيم صفحات #}
  {% if payroll_table_rows %}
  <div class="table-responsive mb-4 payroll-unified-block">
    <table class="table table-bordered table-sm align-middle table-print">
      <thead class="table-light">
        <tr>
          <th>{{ _('Employee name') }}</th>
          <th class="text-end mono">{{ _('Basic') }}</th>
          <th class="text-end mono">{{ _('Extra') }}</th>
          <th class="text-end mono">{{ _('Absence') }}</th>
          <th class="text-end mono">{{ _('Incentive') }}</th>
          <th class="text-end mono">{{ _('Allowances') }}</th>
          <th class="text-end mono">{{ _('Deductions') }}</th>
          <th class="text-end mono">{{ _('Total') }}</th>
          <th>{{ _('Department') }}</th>
          <th>{{ _('Signature') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for row in payroll_table_rows %}
        <tr>
          <td>{{ row.name or '—' }}</td>
          <td class="text-end mono">{{ '{:,.2f}'.format(row.basic or 0) }}</td>
          <td class="text-end mono">{{ '{:,.2f}'.format(row.extra or 0) }}</td>
          <td class="text-end mono">{{ '{:,.2f}'.format(row.absence or 0) }}</td>
          <td class="text-end mono">{{ '{:,.2f}'.format(row.incentive or 0) }}</td>
          <td class="text-end mono">{{ '{:,.2f}'.format(row.allowances or 0) }}</td>
          <td class="text-end mono">{{ '{:,.2f}'.format(row.deductions or 0) }}</td>
          <td class="text-end mono">{{ '{:,.2f}'.format(row.total or 0) }}</td>
          <td>{{ row.department or '—' }}</td>
          <td></td>
        </tr>
        {% endfor %}
      </tbody>
      {% if payroll_totals %}
      <tfoot>
        <tr class="table-secondary">
          <th class="text-end">{{ _('Total') }}</th>
          <td class="text-end mono">{{ '{:,.2f}'.format(payroll_totals.basic or 0) }}</td>
          <td class="text-end mono">{{ '{:,.2f}'.format(payroll_totals.extra or 0) }}</td>
          <td class="text-end mono">{{ '{:,.2f}'.format(payroll_totals.absence or 0) }}</td>
          <td class="text-end mono">{{ '{:,.2f}'.format(payroll_totals.incentive or 0) }}</td>
          <td class="text-end mono">{{ '{:,.2f}'.format(payroll_totals.allowances or 0) }}</td>
          <td class="text-end mono">{{ '{:,.2f}'.format(payroll_totals.deductions or 0) }}</td>
          <td class="text-end mono">{{ '{:,.2f}'.format(payroll_totals.total or 0) }}</td>
          <td colspan="2"></td>
        </tr>
      </tfoot>
      {% endif %}
    </table>
  </div>
  {% endif %}

  {% for emp in employees %}
  <div class="ps-emp no-print">
    <div class="ps-emp-name">{{ emp.name or '—' }}</div>
    <div class="table-responsive">
      <table class="table table-bordered table-sm table-print">
        <thead class="table-light">
          <tr>
            <th>{{ _('Month') }}</th>
            <th>{{ _('Basic') }}</th>
            <th>{{ _('Extra') }}</th>
            <th>{{ _('Absence') }}</th>
            <th>{{ _('Incentive') }}</th>
            <th>{{ _('Allowances') }}</th>
            <th>{{ _('Deductions') }}</th>
            <th>{{ _('Previous due') }}</th>
            <th>{{ _('Total') }}</th>
            <th>{{ _('Paid') }}</th>
            <th>{{ _('Remaining') }}</th>
            <th>{{ _('Status') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for row in (emp.salaries or []) %}
          <tr>
            <td>{% if row.year and row.month %}{{ row.year }}-{{ '%02d'|format(row.month) }}{% else %}—{% endif %}</td>
            <td class="mono">{{ '{:,.2f}'.format(row.basic or 0) }}</td>
            <td class="mono">{{ '{:,.2f}'.format(row.extra or 0) }}</td>
            <td class="mono">{{ '{:,.2f}'.format(row.absence or 0) }}</td>
            <td class="mono">{{ '{:,.2f}'.format(row.incentive or 0) }}</td>
            <td class="mono">{{ '{:,.2f}'.format(row.allowances or 0) }}</td>
            <td class="mono">{{ '{:,.2f}'.format(row.deductions or 0) }}</td>
            <td class="mono">{{ '{:,.2f}'.format(row.prev_due or 0) }}</td>
            <td class="mono">{{ '{:,.2f}'.format(row.total or 0) }}</td>
            <td class="mono">{{ '{:,.2f}'.format(row.paid_amount or row.paid or 0) }}</td>
            <td class="mono">{{ '{:,.2f}'.format(row.remaining_amount or row.remaining or 0) }}</td>
            <td>
              {% if row.status == 'paid' %}<span class="st-paid">{{ _('Paid') }}</span>
              {% elif row.status == 'partial' %}<span class="st-partial">{{ _('Partial') }}</span>
              {% elif row.status == 'due' %}<span class="st-due">{{ _('Due') }}</span>
              {% elif row.status == 'credit' %}<span class="st-credit">{{ _('Credit') }}</span>
              {% else %}{{ row.status }}{% endif %}
            </td>
          </tr>
          {% endfor %}
          {% if not (emp.salaries or []) %}
          <tr><td colspan="12" class="text-center text-muted">{{ _('No data') }}</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
  {% endfor %}

  {% if not employees and not payroll_table_rows %}
  <p class="text-muted">{{ _('No employees or payroll data for the selected period.') }}</p>
  {% endif %}

  </div><!-- .container -->

  <script>
    (function() {
      var btn = document.getElementById('btn-print-payroll');
      if (btn) btn.addEventListener('click', function() { window.print(); });

      function psTogglePeriod() {
        var single = document.getElementById('ps-mode-single');
        var monthEl = document.getElementById('ps-month');
        var monthFrom = document.getElementById('ps-month-from');
        var monthTo = document.getElementById('ps-month-to');
        var sep = document.getElementById('ps-range-sep');
        if (!single || !monthEl) return;
        var isSingle = single.checked;
        monthEl.classList.toggle('d-none', !isSingle);
        monthEl.disabled = !isSingle;
        if (monthFrom) { monthFrom.classList.toggle('d-none', isSingle); monthFrom.disabled = isSingle; }
        if (monthTo) { monthTo.classList.toggle('d-none', isSingle); monthTo.disabled = isSingle; }
        if (sep) sep.classList.toggle('d-none', isSingle);
      }
      document.getElementById('ps-mode-single') && document.getElementById('ps-mode-single').addEventListener('change', psTogglePeriod);
      document.getElementById('ps-mode-range') && document.getElementById('ps-mode-range').addEventListener('change', psTogglePeriod);
      psTogglePeriod();

      document.getElementById('ps-emp-all') && document.getElementById('ps-emp-all').addEventListener('click', function() {
        var sel = document.getElementById('ps-employees');
        if (sel) { for (var i = 0; i < sel.options.length; i++) sel.options[i].selected = true; }
      });
      document.getElementById('ps-emp-clear') && document.getElementById('ps-emp-clear').addEventListener('click', function() {
        var sel = document.getElementById('ps-employees');
        if (sel) { for (var i = 0; i < sel.options.length; i++) sel.options[i].selected = false; }
      });

      document.getElementById('ps-filter-form') && document.getElementById('ps-filter-form').addEventListener('submit', function() {
        var single = document.getElementById('ps-mode-single');
        if (single && single.checked) {
          var mFrom = document.getElementById('ps-month-from');
          var mTo = document.getElementById('ps-month-to');
          if (mFrom) mFrom.removeAttribute('name');
          if (mTo) mTo.removeAttribute('name');
        } else {
          var month = document.getElementById('ps-month');
          if (month) month.removeAttribute('name');
        }
      });
    })();
  </script>
</body>
</html>
