<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<title>Payroll Statement — {{ period_label }}</title>
<style>
  body { font-family: "Segoe UI", Tahoma, Arial, sans-serif; padding:20px; direction: rtl; color:#222; }
  h2, h3 { margin:0; }
  table { width:100%; border-collapse:collapse; margin-top:12px; margin-bottom:20px; }
  th, td { border:1px solid #ddd; padding:6px; text-align:center; }
  th { background:#f4f6f8; }
  .total-row { font-weight:700; background:#fafafa; }
  .paid { color:#27ae60; font-weight:700; }
  .partial { color:#f39c12; font-weight:700; }
  .due { color:#e67e22; font-weight:700; }
  .credit { color:#c0392b; font-weight:700; }
</style>
</head>
<body>
<h2>{{ company_name }}</h2>
<div>Payroll Statement — {{ period_label }}</div>
<div>Generated at: {{ generated_at }}</div>

{% set company_totals = {'basic':0, 'allowances':0, 'deductions':0, 'prev_due':0, 'total':0, 'paid':0, 'remaining':0} %}

{% for employee in employees %}
  <h3>{{ employee.name }}</h3>
  <table>
    <thead>
      <tr>
        <th>Month</th>
        <th>Basic</th>
        <th>Allowances</th>
        <th>Deductions</th>
        <th>Prev Due</th>
        <th>Total</th>
        <th>Paid</th>
        <th>Remaining</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% set emp_totals = {'basic':0, 'allowances':0, 'deductions':0, 'prev_due':0, 'total':0, 'paid':0, 'remaining':0} %}
      {% for sal in employee.salaries %}
      <tr>
        <td>{{ sal.month.strftime("%Y-%m") }}</td>
        <td>{{ "%.2f"|format(sal.basic) }}</td>
        <td>{{ "%.2f"|format(sal.allowances) }}</td>
        <td>{{ "%.2f"|format(sal.deductions) }}</td>
        <td>{{ "%.2f"|format(sal.prev_due) }}</td>
        <td>{{ "%.2f"|format(sal.total) }}</td>
        <td>{{ "%.2f"|format(sal.paid_amount) }}</td>
        <td>{{ "%.2f"|format(sal.remaining_amount) }}</td>
        <td class="{{ sal.status }}">{{ sal.status }}</td>
      </tr>
      {% set emp_totals = {
           'basic': emp_totals.basic + sal.basic,
           'allowances': emp_totals.allowances + sal.allowances,
           'deductions': emp_totals.deductions + sal.deductions,
           'prev_due': emp_totals.prev_due + sal.prev_due,
           'total': emp_totals.total + sal.total,
           'paid': emp_totals.paid + sal.paid_amount,
           'remaining': emp_totals.remaining + sal.remaining_amount
        } %}
      {% endfor %}
      <tr class="total-row">
        <td>Totals</td>
        <td>{{ "%.2f"|format(emp_totals.basic) }}</td>
        <td>{{ "%.2f"|format(emp_totals.allowances) }}</td>
        <td>{{ "%.2f"|format(emp_totals.deductions) }}</td>
        <td>{{ "%.2f"|format(emp_totals.prev_due) }}</td>
        <td>{{ "%.2f"|format(emp_totals.total) }}</td>
        <td>{{ "%.2f"|format(emp_totals.paid) }}</td>
        <td>{{ "%.2f"|format(emp_totals.remaining) }}</td>
        <td></td>
      </tr>
      {% set company_totals = {
           'basic': company_totals.basic + emp_totals.basic,
           'allowances': company_totals.allowances + emp_totals.allowances,
           'deductions': company_totals.deductions + emp_totals.deductions,
           'prev_due': company_totals.prev_due + emp_totals.prev_due,
           'total': company_totals.total + emp_totals.total,
           'paid': company_totals.paid + emp_totals.paid,
           'remaining': company_totals.remaining + emp_totals.remaining
      } %}
    </tbody>
  </table>
{% endfor %}

<h3>Company Totals</h3>
<table>
  <thead>
    <tr>
      <th>Basic</th>
      <th>Allowances</th>
      <th>Deductions</th>
      <th>Prev Due</th>
      <th>Total</th>
      <th>Paid</th>
      <th>Remaining</th>
    </tr>
  </thead>
  <tbody>
    <tr class="total-row">
      <td>{{ "%.2f"|format(company_totals.basic) }}</td>
      <td>{{ "%.2f"|format(company_totals.allowances) }}</td>
      <td>{{ "%.2f"|format(company_totals.deductions) }}</td>
      <td>{{ "%.2f"|format(company_totals.prev_due) }}</td>
      <td>{{ "%.2f"|format(company_totals.total) }}</td>
      <td>{{ "%.2f"|format(company_totals.paid) }}</td>
      <td>{{ "%.2f"|format(company_totals.remaining) }}</td>
    </tr>
  </tbody>
</table>

<div style="margin-top:12px;">Print / طباعة</div>
</body>
</html>
