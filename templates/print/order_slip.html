<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>Order Slip</title>
  <style>
    {% set pw = (settings.receipt_paper_width if settings and settings.receipt_paper_width else '80') %}
    {% set pw_int = pw|int %}
    {% set fs = 12 if pw_int <= 58 else 13 %}
    {% set fs_tot = 13 if pw_int <= 58 else 14 %}
    @page { size: {{ pw }}mm auto; margin: 4mm; }
    body{font-family:'Courier New', monospace; margin:0; padding:0; color:#000; font-weight:700; line-height:1.3;}
    .receipt{width: {{ pw }}mm; max-width: {{ pw }}mm; margin:0 auto; padding:4px 6px;}
    .sep{border-top:2px solid #000;margin:6px 0}
    .center{text-align:center}
    table{width:100%;border-collapse:collapse}
    th,td{padding:2px 4px;font-size:{{ fs }}px;color:#000;word-break:break-word}
    th{border-bottom:2px solid #000;font-weight:700}
    .totals td{padding:2px 0;font-size:{{ fs_tot }}px}
    .note{margin-top:6px;font-size:{{ fs - 1 }}px;line-height:1.5;color:#000}
    .num{font-family:"Courier New", monospace; direction:ltr}
    .left{text-align:left}
    .right{text-align:right}
    .item-col{width:{{ 64 if pw_int <= 58 else 68 }}%}
    .qty-col{width:{{ 18 if pw_int <= 58 else 16 }}%; text-align:center}
    .price-col{width:{{ 18 if pw_int <= 58 else 16 }}%}
    .qty-price{display:flex;justify-content:space-between}
    .qty{min-width:40%}
    .price{min-width:40%;text-align:right}
    @media print{
      body{font-weight:700;color:#000;-webkit-print-color-adjust:exact;print-color-adjust:exact;color-adjust:exact}
    }
  </style>
</head>
<body>
  <div class="receipt">
    <div class="center">Order No: {{ order_number }}</div>
    <div class="center">Branch: {{ branch_name }} — Table: {{ table_number }}</div>
    <div class="center">Date: {{ date_time }}</div>
    {% if customer_name or customer_phone %}
    <div class="center">Customer: {{ customer_name }}{% if customer_phone %} — {{ customer_phone }}{% endif %}</div>
    {% endif %}
    {% if payment_method %}
    <div class="center">Payment: {{ payment_method|upper }}</div>
    {% endif %}
    <div class="sep"></div>
    <table>
      <thead>
        <tr>
          <th class="left item-col">Item</th>
          <th class="center qty-col">Qty</th>
          <th class="right price-col">Total</th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
        <tr>
          <td class="left item-col">{{ it.product_name }}</td>
          <td class="num center qty-col">{{ '%.2f'|format(it.quantity) }}</td>
          <td class="num right price-col">{{ '%.2f'|format(it.line_total) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="sep"></div>
    <table class="totals">
      <tr>
        <td>Subtotal (SAR):</td>
        <td style="text-align:right;width:120px">{{ '%.2f'|format(subtotal) }}</td>
      </tr>
      {% if discount and discount > 0 %}
      <tr>
        <td>Discount ({{ '%.2f'|format(discount_pct) }}%):</td>
        <td style="text-align:right;width:120px">{{ '%.2f'|format(discount) }}</td>
      </tr>
      {% endif %}
      <tr>
        <td>VAT ({{ '%.2f'|format(tax_pct) }}%):</td>
        <td style="text-align:right;width:120px">{{ '%.2f'|format(vat) }}</td>
      </tr>
      <tr>
        <td><strong>Grand Total (SAR):</strong></td>
        <td style="text-align:right;width:120px"><strong>{{ '%.2f'|format(total) }}</strong></td>
      </tr>
    </table>
    <div class="sep"></div>
    <div class="note">
      <div>⚠ هذه ليست فاتورة ضريبية نهائية</div>
      <div>هذا الإيصال لمتابعة الطلب فقط</div>
      <div>الرجاء أخذ الفاتورة النهائية عند الدفع</div>
      <div style="margin-top:6px">⚠ This is NOT a final tax invoice</div>
      <div>This slip is for order follow-up</div>
      <div>Please take the invoice when paying</div>
    </div>
  </div>
  <script>
    window.addEventListener('load', function(){
      setTimeout(function(){ try{ window.print(); }catch(_){} }, 150);
    });
    window.addEventListener('afterprint', function(){
      try{ window.close(); }catch(_){ }
    });
  </script>
</body>
</html>
