<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sales Receipt</title>
  <style>
    {% set pw = (settings.receipt_paper_width if settings and settings.receipt_paper_width else '80') %}
    {% set fs = (settings.receipt_font_size if settings and settings.receipt_font_size else 12) %}
    {% set logo_h = (settings.receipt_logo_height if settings and settings.receipt_logo_height else 100) %}
    {% set extra_bottom = (settings.receipt_extra_bottom_mm if settings and (settings.receipt_extra_bottom_mm is not none) else 15) %}
    {% set effective_logo_height = (branch_settings.receipt_logo_height if (branch_settings is defined and branch_settings and branch_settings.receipt_logo_height) else logo_h) %}
    
    body{
      font-family: Arial, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      font-size: {{ fs }}px; 
      line-height: 1.35;
      margin: 0;
      padding: 8px;
      color: #000;
      font-weight: 500;
    }
    body, h1, h2, h3, h4, h5, h6, p, span, div, td, th, small, strong, em, b, i,
    .muted, .small, .company-name, .grand-total { color: #000 !important; font-weight: 500 !important; }
    .wrap{
      width: {{ pw }}mm; 
      max-width: {{ pw }}mm; 
      margin: 0 auto;
      padding: 0;
    }
    .center{text-align: center; margin-bottom: 8px;}
    .muted{color: #000; font-size: {{ (fs|int - 1) if (fs|int > 8) else fs }}px;}
    .small{font-size: {{ (fs|int - 2) if (fs|int > 8) else fs }}px; color: #000;}
    .logo-img{
      height: {{ effective_logo_height }}px; 
      max-width: 90%; 
      margin-bottom: 10px; 
      object-fit: contain;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .company-name{
      font-size: {{ (fs|int + 4) if fs else 16 }}px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    table{
      width: 100%; 
      border-collapse: collapse;
      margin: 8px 0;
      font-size: {{ (fs|int - 1) if (fs|int > 8) else fs }}px;
      table-layout: fixed;
    }
    th{
      padding: 4px 2px; 
      border-bottom: 1px solid #333;
      font-weight: 600;
      font-size: {{ (fs|int + 1) if (fs|int > 8) else (fs|int) }}px;
      color: #000;
    }
    td{
      padding: 3px 2px; 
      border-bottom: 1px solid #333;
      vertical-align: top;
      color: #000;
    }
    .total-row td{
      font-weight: 600;
      border-bottom: 1px solid #333;
      padding: 4px 2px;
      color: #000;
    }
    .grand-total{
      border-top: 2px solid #000 !important;
      border-bottom: 2px solid #000 !important;
      font-size: {{ (fs|int + 3) if fs else 15 }}px;
      font-weight: 700;
      color: #000;
    }
    .right{text-align: right;}
    .center-text{text-align: center;}
    .left{text-align: left;}
    hr{
      margin: 8px 0;
      border: none;
      border-top: 2px solid #000;
    }
    .footer{
      margin-top: 12px;
      font-size: {{ (fs|int - 1) if (fs|int > 8) else fs }}px;
    }
    @media print{
      .no-print{display: none !important;}
      body{
        background: #fff; 
        font-size: {{ (fs|int + 1) if (fs|int < 15) else fs }}px;
        margin: 0;
        padding: 4px;
        -webkit-print-color-adjust: exact;
        color-adjust: exact;
        print-color-adjust: exact;
        color: #000;
        font-weight: 500;
      }
      body, h1, h2, h3, h4, h5, h6, p, span, div, td, th, small, strong, em, b, i,
      table, .company-name, .muted, .small, .grand-total { color: #000 !important; font-weight: 500 !important; }
      .wrap{
        width: {{ pw }}mm;
        max-width: {{ pw }}mm;
        margin: 0;
        padding: 0;
      }
      .logo-img{
        height: {{ effective_logo_height }}px;
        max-width: 85%;
        margin-bottom: 8px;
      }
      table{
        page-break-inside: avoid;
        margin: 6px 0;
      }
      hr{
        margin: 4px 0;
        page-break-after: avoid;
      }
      .footer{
        margin-top: 8px;
        page-break-inside: avoid;
      }
      @page{ 
        margin: 2mm 2mm {{ extra_bottom }}mm 2mm; 
        size: {{ pw }}mm auto;
      }
    }
    {% if items and items|length <= 3 %}
    .footer{margin-top: 15px;}
    {% elif items and items|length <= 6 %}
    .footer{margin-top: 12px;}
    {% else %}
    .footer{margin-top: 8px;}
    {% endif %}
    thead tr th:nth-child(1), tbody tr td:nth-child(1){ width: 55%; }
    thead tr th:nth-child(2), tbody tr td:nth-child(2){ width: 15%; }
    thead tr th:nth-child(3), tbody tr td:nth-child(3){ width: 30%; }
  </style>
</head>
<body>
  {% set currency_src = None %}
  {% if settings and settings.currency_image %}
    {% set currency_src = settings.currency_image %}
  {% elif settings and settings.currency and (settings.currency.startswith('http') or settings.currency.startswith('/')) %}
    {% set currency_src = settings.currency %}
  {% endif %}
  {% set receipt_currency = (settings.currency if settings and settings.currency else 'SAR') %}
  <div class="wrap">
    <div class="center">
      {% set branch_code_top = (inv.branch or inv.branch_code or '')|lower %}
      {% set is_china_top = branch_code_top[0:5] == 'china' %}
      {% set is_india_top = ('place' in branch_code_top) or ('india' in branch_code_top) %}
      {% set branch_logo_url = None %}
      {% if is_china_top and settings and settings.china_town_logo_url %}
        {% set branch_logo_url = settings.china_town_logo_url %}
      {% elif is_india_top and settings and settings.place_india_logo_url %}
        {% set branch_logo_url = settings.place_india_logo_url %}
      {% endif %}
      {% if logo_data_url %}
      <img src="{{ logo_data_url }}" alt="logo" class="logo-img"/>
      {% elif branch_settings is defined and branch_settings and branch_settings.receipt_show_logo and branch_settings.branch_data_url %}
      <img src="{{ branch_settings.branch_data_url }}" alt="logo" class="logo-img"/>
      {% elif branch_settings is defined and branch_settings and branch_settings.receipt_show_logo and branch_settings.logo_url %}
      <img src="{{ branch_settings.logo_url }}" alt="logo" class="logo-img"/>
      {% elif branch_logo_url and (not settings or settings.receipt_show_logo) %}
      <img src="{{ branch_logo_url }}" alt="logo" class="logo-img"/>
      {% elif settings and settings.receipt_show_logo and settings.logo_url %}
      <img src="{{ settings.logo_url }}" alt="logo" class="logo-img"/>
      {% elif (not settings or settings.receipt_show_logo) and logo_url %}
      <img src="{{ logo_url }}" alt="logo" class="logo-img"/>
      {% endif %}
      <div class="company-name">{{ settings.company_name if settings else company_name }}</div>
      {% set show_vat = (not settings) or (settings and settings.receipt_show_tax_number) %}
      {% if show_vat %}
        {% if settings and settings.tax_number %}
        <div class="small muted">{{ _('VAT No.') }}: {{ settings.tax_number }}</div>
        {% elif tax_number %}
        <div class="small muted">{{ _('VAT No.') }}: {{ tax_number }}</div>
        {% endif %}
      {% endif %}
      {% set branch_code = (inv.branch or inv.branch_code or '')|lower %}
      {% set is_china = branch_code[0:5] == 'china' %}
      {% set is_india = ('place' in branch_code) or ('india' in branch_code) %}
      {% if is_china %}
        {% if settings and (settings.china_town_phone1 or settings.china_town_phone2) %}
        <div class="small muted">
          {{ _('Phone') }}: {{ (settings.china_town_phone1 or '') ~ ((' / ' ~ settings.china_town_phone2) if settings.china_town_phone2 else '') }}
        </div>
        {% endif %}
      {% elif is_india %}
        {% if settings and (settings.place_india_phone1 or settings.place_india_phone2) %}
        <div class="small muted">
          {{ _('Phone') }}: {{ (settings.place_india_phone1 or '') ~ ((' / ' ~ settings.place_india_phone2) if settings.place_india_phone2 else '') }}
        </div>
        {% endif %}
      {% endif %}
      {% if branch_name %}
      <div class="small muted">{{ _('Branch') }}: {{ branch_name }}</div>
      {% endif %}
    </div>

    {% if date_time %}
    <div class="center small muted">{{ date_time }}</div>
    {% endif %}
    {% if display_invoice_number %}
    <div class="center small muted">{{ _('Invoice') }}: {{ display_invoice_number }}</div>
    {% endif %}
    {% if inv.table_number %}
    <div class="center small muted">{{ _('Table') }}: {{ inv.table_number }}</div>
    {% endif %}
    {% if inv.customer_name %}
    <div class="center small muted">{{ _('Customer') }}: {{ inv.customer_name }}</div>
    {% endif %}
    {% if inv.customer_phone %}
    <div class="center small muted">{{ _('Phone') }}: {{ inv.customer_phone }}</div>
    {% endif %}
    <hr/>

    <table>
      <thead>
        <tr>
          <th class="left">{{ _('Item') }}</th>
          <th class="center-text">{{ _('Qty') }}</th>
          <th class="right">{{ _('Amount') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for r in items %}
        <tr>
          <td class="left">{{ r.product_name }}</td>
          <td class="center-text">{{ (r.quantity or 0)|int }}</td>
          <td class="right">{{ '%.2f'|format(r.total_price or 0) }} {{ receipt_currency }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <hr/>
    <table>
      <tr class="total-row">
        <td class="left">{{ _('Subtotal') }}</td>
        <td></td>
        <td class="right">{{ '%.2f'|format(inv.total_before_tax or 0) }} {{ receipt_currency }}</td>
      </tr>
      <tr class="total-row">
        <td class="left">{{ _('VAT') }}</td>
        <td></td>
        <td class="right">{{ '%.2f'|format(inv.tax_amount or 0) }} {{ receipt_currency }}</td>
      </tr>
      {% if inv.discount_amount and inv.discount_amount > 0 %}
      <tr class="total-row">
        <td class="left">{{ _('Discount') }}</td>
        <td></td>
        <td class="right">-{{ '%.2f'|format(inv.discount_amount) }} {{ receipt_currency }}</td>
      </tr>
      {% endif %}
      <tr class="total-row grand-total">
        <td class="left">{{ _('Total') }}</td>
        <td></td>
        <td class="right">{{ '%.2f'|format(inv.total_after_tax_discount or 0) }} {{ receipt_currency }}</td>
      </tr>
    </table>

    {% if inv.payment_method %}
    {% set pm = (inv.payment_method or '')|upper %}
    <div class="center small">{{ _('Payment') }} / طريقة الدفع: {{ pm }}</div>
    {% endif %}

    {% if qr_data_url %}
    <div class="center"><img src="{{ qr_data_url }}" alt="QR" style="width:90px;height:90px"/></div>
    {% endif %}

    <div class="footer center">
      {% if settings and settings.receipt_footer_text %}
        {{ settings.receipt_footer_text }}
      {% elif settings and settings.footer_message %}
        {{ settings.footer_message }}
      {% else %}
        THANK YOU FOR VISIT
      {% endif %}
    </div>

    <div class="no-print center">
      <button onclick="window.print()">{{ _('Print') }}</button>
      <button id="btnCashCalcPrint" style="margin-left:8px;">Cash Change Calculator</button>
      <div id="cashCalcPrint" style="display:none; margin-top:8px; padding:8px; border:1px solid #333; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.15);">
        <div style="margin-bottom:6px; font-weight:600;">Cash Change Calculator</div>
        <div style="display:flex; gap:10px; justify-content:center; align-items:flex-end; flex-wrap:wrap;">
          <div style="margin-left:auto;">
            <div>Amount Received</div>
            <input id="cashRecvPrint" type="number" step="0.01" min="0" placeholder="0.00" style="padding:8px; width:140px; border:1px solid #333; border-radius:8px;">
          </div>
          <div>
            <div>Total</div>
            <div id="cashTotalPrint" style="padding:8px; border:1px solid #333; border-radius:8px; min-width:140px; background:#f6f6f6;">SAR0.00</div>
          </div>
          <div>
            <div>Change</div>
            <div id="cashChangePrint" style="padding:8px; border:1px solid #198754; border-radius:8px; background:#198754; color:#fff; min-width:140px;">SAR0.00</div>
          </div>
          <div>
            <div>Due</div>
            <div id="cashDuePrint" style="padding:8px; border:1px solid #ffc107; border-radius:8px; background:#ffc107; min-width:140px;">SAR0.00</div>
          </div>
        </div>
      </div>
    </div>
    <script class="no-print">
      (function(){
        function getTotal(){ try{ return parseFloat('{{ '%.2f'|format(inv.total_after_tax_discount or 0) }}'); }catch(_){ return 0; } }
        function compute(){
          var total = getTotal();
          var recv = parseFloat(document.getElementById('cashRecvPrint')?.value||'0')||0;
          var change = Math.max(0, recv - total);
          var due = Math.max(0, total - recv);
          var set=function(id,val){ var el=document.getElementById(id); if(el){ el.textContent = 'SAR' + Number(val||0).toFixed(2); } };
          set('cashTotalPrint', total);
          set('cashChangePrint', change);
          set('cashDuePrint', due);
        }
        var btn = document.getElementById('btnCashCalcPrint');
        var box = document.getElementById('cashCalcPrint');
        if(btn && box){ btn.addEventListener('click', function(){ box.style.display = (box.style.display==='none' || !box.style.display) ? 'block' : 'none'; compute(); }); }
        document.getElementById('cashRecvPrint')?.addEventListener('input', compute);
      })();
    </script>
       
