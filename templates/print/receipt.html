<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sales Receipt</title>
  <style>
    {% set pw = (settings.receipt_paper_width if settings and settings.receipt_paper_width else '80') %}
    {% set fs = (settings.receipt_font_size if settings and settings.receipt_font_size else 12) %}
    {% set logo_h = (settings.receipt_logo_height if settings and settings.receipt_logo_height else 100) %}
    {% set extra_bottom = (settings.receipt_extra_bottom_mm if settings and (settings.receipt_extra_bottom_mm is not none) else 15) %}
    {% set effective_logo_height = branch_settings.receipt_logo_height if branch_settings and branch_settings.receipt_logo_height else logo_h %}
    
    body{
      font-family: 'Courier New', monospace; 
      font-size: {{ fs }}px; 
      line-height: 1.3;
      margin: 0;
      padding: 8px;
    }
    .wrap{
      width: {{ pw }}mm; 
      max-width: {{ pw }}mm; 
      margin: 0 auto;
      padding: 0;
    }
    .center{text-align: center; margin-bottom: 8px;}
    .muted{color: #000; font-size: {{ (fs|int - 1) if (fs|int > 8) else fs }}px;}
    .small{font-size: {{ (fs|int - 2) if (fs|int > 8) else fs }}px; color: #000;}
    
    /* Logo styling - bigger and clearer */
    .logo-img{
      height: {{ effective_logo_height }}px; 
      max-width: 90%; 
      margin-bottom: 10px; 
      object-fit: contain;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    
    /* Company info */
    .company-name{
      font-size: {{ (fs|int + 2) if fs else 14 }}px;
      font-weight: bold;
      margin-bottom: 6px;
    }
    
    /* Table styling for thermal printer */
    table{
      width: 100%; 
      border-collapse: collapse;
      margin: 8px 0;
      font-size: {{ (fs|int - 1) if (fs|int > 8) else fs }}px;
    }
    th{
      padding: 4px 2px; 
      border-bottom: 1px solid #000;
      font-weight: 700;
      font-size: {{ (fs|int - 1) if (fs|int > 8) else fs }}px;
      color: #000;
    }
    td{
      padding: 3px 2px; 
      border-bottom: 1px solid #000;
      vertical-align: top;
      color: #000;
    }
    .total-row td{
      font-weight: 700;
      border-bottom: 1px solid #000;
      padding: 4px 2px;
      color: #000;
    }
    .grand-total{
      border-top: 2px solid #000 !important;
      border-bottom: 2px solid #000 !important;
      font-size: {{ (fs|int + 1) if fs else 13 }}px;
      font-weight: 700;
      color: #000;
    }
    
    /* Alignment classes */
    .right{text-align: right;}
    .center-text{text-align: center;}
    .left{text-align: left;}
    
    /* Compact spacing */
    hr{
      margin: 8px 0;
      border: none;
      border-top: 2px solid #000;
    }
    
    /* Footer */
    .footer{
      margin-top: 12px;
      font-size: {{ (fs|int - 1) if (fs|int > 8) else fs }}px;
    }
    /* Thermal printer optimizations */
    @media print{
      .no-print{display: none !important;}
      body{
        background: #fff; 
        font-size: {{ (fs|int + 2) if (fs|int < 15) else fs }}px;
        margin: 0;
        padding: 4px;
        -webkit-print-color-adjust: exact;
        color-adjust: exact;
        print-color-adjust: exact;
        color: #000;
      }
      table, th, td, .company-name, .muted, .small { color: #000 !important; }
      .wrap{
        width: {{ pw }}mm;
        max-width: {{ pw }}mm;
        margin: 0;
        padding: 0;
      }
      .logo-img{
        height: {{ effective_logo_height }}px;
        max-width: 85%;
        margin-bottom: 8px;
      }
      table{
        page-break-inside: avoid;
        margin: 6px 0;
      }
      hr{
        margin: 4px 0;
        page-break-after: avoid;
      }
      .footer{
        margin-top: 8px;
        page-break-inside: avoid;
      }
      @page{ 
        margin: 2mm 2mm {{ extra_bottom }}mm 2mm; 
        size: {{ pw }}mm auto;
      }
    }
    
    /* Dynamic spacing based on content */
    {% if items and items|length <= 3 %}
    .footer{margin-top: 15px;}
    {% elif items and items|length <= 6 %}
    .footer{margin-top: 12px;}
    {% else %}
    .footer{margin-top: 8px;}
    {% endif %}
  </style>
</head>
<body>
  {% set currency_src = None %}
  {% if settings and settings.currency_image %}
    {% set currency_src = settings.currency_image %}
  {% elif settings and settings.currency and (settings.currency.startswith('http') or settings.currency.startswith('/')) %}
    {% set currency_src = settings.currency %}
  {% endif %}
  <div class="wrap">
    <div class="center">
      {% set branch_code_top = (inv.branch or inv.branch_code or '')|lower %}
      {% set is_china_top = branch_code_top[0:5] == 'china' %}
      {% set is_india_top = ('place' in branch_code_top) or ('india' in branch_code_top) %}
      {% set branch_logo_url = None %}
      {% if is_china_top and settings and settings.china_town_logo_url %}
        {% set branch_logo_url = settings.china_town_logo_url %}
      {% elif is_india_top and settings and settings.place_india_logo_url %}
        {% set branch_logo_url = settings.place_india_logo_url %}
      {% endif %}
      {% if logo_data_url %}
      <img src="{{ logo_data_url }}" alt="logo" class="logo-img"/>
      {% elif branch_settings and branch_settings.receipt_show_logo and branch_settings.branch_data_url %}
      <img src="{{ branch_settings.branch_data_url }}" alt="logo" class="logo-img"/>
      {% elif branch_settings and branch_settings.receipt_show_logo and branch_settings.logo_url %}
      <img src="{{ branch_settings.logo_url }}" alt="logo" class="logo-img"/>
      {% elif branch_logo_url and (not settings or settings.receipt_show_logo) %}
      <img src="{{ branch_logo_url }}" alt="logo" class="logo-img"/>
      {% elif settings and settings.receipt_show_logo and settings.logo_url %}
      <img src="{{ settings.logo_url }}" alt="logo" class="logo-img"/>
      {% elif (not settings or settings.receipt_show_logo) and logo_url %}
      <img src="{{ logo_url }}" alt="logo" class="logo-img"/>
      {% endif %}
      <div class="company-name">{{ settings.company_name if settings else company_name }}</div>
      {% set show_vat = (not settings) or (settings and settings.receipt_show_tax_number) %}
      {% if show_vat %}
        {% if settings and settings.tax_number %}
        <div class="small muted">{{ _('VAT No.') }}: {{ settings.tax_number }}</div>
        {% elif tax_number %}
        <div class="small muted">{{ _('VAT No.') }}: {{ tax_number }}</div>
        {% endif %}
      {% endif %}
      {# Branch-specific phones #}
      {% set branch_code = (inv.branch or inv.branch_code or '')|lower %}
      {% set is_china = branch_code[0:5] == 'china' %}
      {% set is_india = ('place' in branch_code) or ('india' in branch_code) %}
      {% if is_china %}
        {% if settings and (settings.china_town_phone1 or settings.china_town_phone2) %}
        <div class="small muted">
          {{ _('Phone') }}: {{ (settings.china_town_phone1 or '') ~ ((' / ' ~ settings.china_town_phone2) if settings.china_town_phone2 else '') }}
        </div>
        {% elif settings and settings.phone %}
        <div class="small muted">{{ _('Phone') }}: {{ settings.phone }}</div>
        {% endif %}
      {% elif is_india %}
        {% if settings and (settings.place_india_phone1 or settings.place_india_phone2) %}
        <div class="small muted">
          {{ _('Phone') }}: {{ (settings.place_india_phone1 or '') ~ ((' / ' ~ settings.place_india_phone2) if settings.place_india_phone2 else '') }}
        </div>
        {% elif settings and settings.phone %}
        <div class="small muted">{{ _('Phone') }}: {{ settings.phone }}</div>
        {% endif %}
      {% else %}
        {% if settings and settings.phone %}
        <div class="small muted">{{ _('Phone') }}: {{ settings.phone }}</div>
        {% elif phone %}
        <div class="small muted">{{ _('Phone') }}: {{ phone }}</div>
        {% endif %}
      {% endif %}
      {% if settings and settings.address %}
      <div class="small muted">{{ settings.address }}</div>
      {% endif %}
    </div>

    <hr/>

    <div class="small" style="margin-bottom: 8px;">
      <div style="display: flex; justify-content: space-between;">
        <span>Invoice No:</span>
        <span><strong>{{ display_invoice_number or (inv.invoice_number or inv.id) }}</strong></span>
      </div>
      <div style="display: flex; justify-content: space-between;">
        <span>Date/Time:</span>
        <span>{{ date_time }}</span>
      </div>
      <div style="display: flex; justify-content: space-between;">
        <span>Branch:</span>
        <span><strong>{{ branch_name or (inv.branch or inv.branch_code or 'Main') }}</strong></span>
      </div>
      {% if inv.table_number %}
      <div style="display: flex; justify-content: space-between;">
        <span>Table:</span>
        <span><strong>{{ inv.table_number }}</strong></span>
      </div>
      {% endif %}
      {% if inv and (inv.payment_method or (inv.status in ['paid','PAID']) or paid) %}
      <div style="display: flex; justify-content: space-between;">
        <span>Payment:</span>
        <span>{{ (inv.payment_method or 'Cash')|title }}</span>
      </div>
      {% endif %}
      <div style="display: flex; justify-content: space-between;">
        <span>Customer:</span>
        <span>{{ inv.customer_name or 'Cash customer' }}</span>
      </div>
      {% if inv.customer_phone %}
      <div style="display: flex; justify-content: space-between;">
        <span>Phone:</span>
        <span>{{ inv.customer_phone }}</span>
      </div>
      {% endif %}
    </div>

    <table>
      <thead>
        <tr>
          <th class="left">{{ _('Item') }}</th>
          <th class="center-text">{{ _('Qty') }}</th>
          <th class="right">{{ _('Price') }}</th>
          <th class="right">{{ _('Total') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
        <tr>
          <td class="left">{{ it.product_name }}</td>
          <td class="center-text">{{ '%.0f'|format(it.quantity or 0) if (it.quantity or 0) == (it.quantity or 0)|int else '%.2f'|format(it.quantity or 0) }}</td>
          <td class="right">{{ '%.2f'|format(((it.total_price or 0) / (it.quantity or 1))) }}{% if settings and settings.currency_image %} <img src="{{ settings.currency_image }}" class="currency-img" alt="currency" style="width: 12px; height: 12px; vertical-align: middle;">{% endif %}</td>
          <td class="right">{{ '%.2f'|format(it.total_price or 0) }}{% if settings and settings.currency_image %} <img src="{{ settings.currency_image }}" class="currency-img" alt="currency" style="width: 12px; height: 12px; vertical-align: middle;">{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <hr style="margin: 6px 0;">

    <div style="margin: 6px 0;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
        <span>{{ _('Subtotal') }}</span>
        <span>{{ '%.2f'|format(inv.total_before_tax or 0) }}{% if settings and settings.currency_image %} <img src="{{ settings.currency_image }}" class="currency-img" alt="currency" style="width: 12px; height: 12px; vertical-align: middle;">{% endif %}</span>
      </div>
      <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
        <span>{{ _('VAT 15%%') }}</span>
        <span>{{ '%.2f'|format(inv.tax_amount or 0) }}{% if settings and settings.currency_image %} <img src="{{ settings.currency_image }}" class="currency-img" alt="currency" style="width: 12px; height: 12px; vertical-align: middle;">{% endif %}</span>
      </div>
      {% if inv.discount_amount and inv.discount_amount > 0 %}
      {% set base_total = (inv.total_before_tax or 0) %}
      {% set rate = (inv.discount_amount / base_total * 100) if base_total > 0 else 0 %}
      {% set cust = (inv.customer_name or '')|upper %}
      <div style="display: flex; justify-content: space-between; margin-bottom: 2px; color: #d63384;">
        <span>{{ _('Discount') }}{% if cust in ['KEETA','HUNGER'] %} ({{ '%.1f'|format(rate or 0) }}%){% endif %}</span>
        <span>-{{ '%.2f'|format(inv.discount_amount or 0) }}{% if settings and settings.currency_image %} <img src="{{ settings.currency_image }}" class="currency-img" alt="currency" style="width: 12px; height: 12px; vertical-align: middle;">{% endif %}</span>
      </div>
      {% endif %}
    </div>

    <hr style="margin: 6px 0; border-top: 2px solid #000;">

    <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: {{ (fs|int + 2) if fs else 14 }}px; margin: 8px 0;">
      <span>{{ _('Grand Total') }}</span>
      <span>{{ '%.2f'|format(inv.total_after_tax_discount or 0) }}{% if settings and settings.currency_image %} <img src="{{ settings.currency_image }}" class="currency-img" alt="currency" style="width: 12px; height: 12px; vertical-align: middle;">{% endif %}</span>
    </div>

    <!-- QR Code Section - only if items exist -->
    {% if items and items|length > 0 %}
    <div class="center" style="margin: 10px 0;">
      {% if qr_data_url %}
        <img src="{{ qr_data_url }}" alt="QR Code" style="width: 60px; height: 60px;">
      {% else %}
        <div id="qr-code" style="width: 60px; height: 60px; margin: 0 auto; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 8px; color: #666;">
          QR
        </div>
      {% endif %}
    </div>
    {% endif %}

    <div class="center footer">
      {% if settings and settings.receipt_footer_text %}
        <div><strong>{{ settings.receipt_footer_text }}</strong></div>
      {% elif settings and settings.footer_message %}
        <div><strong>{{ settings.footer_message }}</strong></div>
      {% else %}
        <div><strong>{{ _('THANK YOU FOR VISIT') }}</strong></div>
      {% endif %}
    </div>

    <div class="center no-print" style="margin-top: 20px; padding: 10px;">
      <button onclick="window.print()" style="
        background: #007bff; 
        color: white; 
        border: none; 
        padding: 12px 24px; 
        border-radius: 6px; 
        font-size: 16px; 
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      ">🖨️ طباعة / Print</button>
    </div>
  </div>

  <!-- QR Code Generation Script -->
  {% if not qr_data_url %}
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      try {
        const qrElement = document.getElementById('qr-code');
        if (qrElement && typeof QRCode !== 'undefined') {
          qrElement.innerHTML = '';
          new QRCode(qrElement, {
            text: '{{ inv.invoice_number or inv.id }}',
            width: 80,
            height: 80,
            correctLevel: QRCode.CorrectLevel.M
          });
        }
      } catch(e) {
        console.log('QR Code generation failed:', e);
      }
    });
  </script>
  {% endif %}
</body>
</html>

