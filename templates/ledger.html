{% extends 'base.html' %}
{% block title %}{{ _('Employee Ledger / ÙƒØ´ÙˆÙØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨') }}{% endblock %}
{% block head %}
<style>
.page-rtl{direction:rtl}
.btn-navy{background:linear-gradient(135deg,#1E40AF 0%,#4F46E5 100%);color:#fff;border:none;position:relative;overflow:hidden}
.btn-navy:hover{filter:brightness(1.05);transform:scale(1.05)}
.glass-card{background:rgba(255,255,255,.75);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.4);box-shadow:0 20px 40px rgba(30,64,175,.15);border-radius:16px}
.kpi-card{display:flex;align-items:center;gap:12px;padding:16px;position:relative}
.kpi-icon{width:40px;height:40px}
.pill-tabs{display:flex;gap:8px;flex-wrap:wrap}
.pill-tab{padding:8px 14px;border-radius:999px;background:#f1f3f5;color:#1E40AF;border:1px solid #e6e9ee;cursor:pointer;position:relative}
.pill-tab.active{background:linear-gradient(135deg,#1E40AF,#4F46E5);color:#fff}
.pill-tab.active::after{content:"";position:absolute;bottom:-2px;left:12px;right:12px;height:3px;background:linear-gradient(90deg,#06B6D4,#22D3EE);filter:drop-shadow(0 0 6px rgba(6,182,212,.6))}
.table-hover-elevate tbody tr{transition:all .18s ease}
.table-hover-elevate tbody tr:hover{background:linear-gradient(90deg, rgba(79,70,229,.06), rgba(79,70,229,.0));box-shadow:0 4px 16px rgba(0,0,0,.08);transform:translateY(-1px)}
.avatar{width:36px;height:36px;border-radius:50%;background:#e9eef5}
.sticky-wrap{position:relative}
.sticky-wrap .table thead th{position:sticky;top:0;background:#fff;z-index:2;box-shadow:0 2px 0 rgba(0,0,0,.06)}
.logo{transition:transform .18s ease;will-change:transform}
.suggest-box{position:absolute;top:100%;right:0;left:0;z-index:30;background:#0b1020;border:1px solid #0ea5e9;border-top:none;border-radius:0 0 12px 12px;box-shadow:0 12px 20px rgba(0,0,0,.35);display:none;max-height:220px;overflow:auto}
.suggest-item{padding:10px 12px;cursor:pointer;color:#e2f6ff}
.suggest-item .hl{color:#22D3EE;text-shadow:0 0 8px rgba(34,211,238,.8)}
.suggest-item:hover{background:#0b1a2e}
.ripple::after{content:"";position:absolute;left:50%;top:50%;width:5px;height:5px;background:radial-gradient(circle, rgba(255,255,255,.8) 0%, rgba(255,255,255,0) 70%);transform:translate(-50%,-50%) scale(0);border-radius:50%;opacity:0;transition:transform .5s ease, opacity .8s ease}
.ripple:active::after{transform:translate(-50%,-50%) scale(20);opacity:1}
.toast-led{position:fixed;top:16px;right:16px;background:#09122a;color:#e2f6ff;border:1px solid #22D3EE;border-radius:12px;box-shadow:0 12px 24px rgba(0,0,0,.35);padding:12px 16px;z-index:1055;animation:ledPulse 2.5s infinite}
@keyframes ledPulse{0%{box-shadow:0 0 0 0 rgba(34,211,238,.5)}70%{box-shadow:0 0 0 12px rgba(34,211,238,0)}100%{box-shadow:0 0 0 0 rgba(34,211,238,0)}}
.offcanvas.show .offcanvas-body{animation:ledScale .25s ease}
@keyframes ledScale{0%{transform:scale(.96);opacity:.0}100%{transform:scale(1);opacity:1}}
.spark{position:absolute;right:16px;bottom:10px;width:120px;height:28px}
</style>
{% endblock %}
{% block content %}
<div class="container py-4 page-rtl">
  <div class="d-flex align-items-center justify-content-between mb-3" id="ledHeader">
    <div class="d-flex align-items-center gap-3">
      <img src="/static/logo.svg" class="logo" style="width:32px;height:32px;border-radius:8px" id="ledLogo">
      <div>
        <div class="fw-semibold" style="color:#0B2347">ÙƒØ´ÙˆÙØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</div>
        <div class="text-muted small">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© â€º ÙƒØ´ÙˆÙØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</div>
      </div>
    </div>
    <div class="d-flex align-items-center gap-2" style="min-width:360px">
      <div class="avatar"></div>
      <button class="btn btn-navy ripple" id="btnNewEntry">âŠ Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠØ¯ Ø¬Ø¯ÙŠØ¯</button>
      <a class="btn btn-outline-dark ripple" href="{{ url_for('main.chart_of_accounts') }}">ğŸŒ³ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</a>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-12 col-xl-4"><div class="glass-card kpi-card"><div id="lottieDed" class="kpi-icon"></div><div class="flex-grow-1"><div class="text-muted small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª</div><div class="fs-5 fw-bold" id="kpiDed">â€”</div></div><canvas class="spark" id="ledSpark"></canvas></div></div>
    <div class="col-12 col-xl-4"><div class="glass-card kpi-card"><div id="lottieAdv" class="kpi-icon"></div><div class="flex-grow-1"><div class="text-muted small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù„Ù Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</div><div class="fs-5 fw-bold" id="kpiAdv">â€”</div></div></div></div>
    <div class="col-12 col-xl-4"><div class="glass-card kpi-card"><div id="lottieCnt" class="kpi-icon"></div><div class="flex-grow-1"><div class="text-muted small">Ø¹Ø¯Ø¯ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div><div class="fs-5 fw-bold" id="kpiCnt">â€”</div></div></div></div>
  </div>

  <div class="pill-tabs mb-3" id="ledDeptTabs">
    <button class="pill-tab active" data-dept="all">Ø§Ù„ÙƒÙ„</button>
    <button class="pill-tab" data-dept="kitchen">Ø´ÙŠÙ</button>
    <button class="pill-tab" data-dept="hall">Ø§Ù„ØµØ§Ù„Ø©</button>
    <button class="pill-tab" data-dept="admin">Ø¥Ø¯Ø§Ø±ÙŠ</button>
    <button class="pill-tab" data-dept="branches">ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</button>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex align-items-center gap-2 mb-2">
        <input type="month" class="form-control" style="max-width:180px" id="ledMonth">
        <select class="form-select" style="max-width:160px" id="ledType"><option value="">Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙŠØ¯</option><option value="advance">Ø³Ù„ÙØ©</option><option value="deduction">Ø®ØµÙ…</option></select>
        <select class="form-select" style="max-width:160px" id="ledStatus"><option value="">Ø§Ù„Ø­Ø§Ù„Ø©</option><option value="paid">Ù…Ø³Ø¯Ø¯</option><option value="partial">Ø¬Ø²Ø¦ÙŠ</option><option value="due">Ù…Ø³ØªØ­Ù‚</option></select>
        <select class="form-select" style="max-width:220px" id="ledEmployee"><option value="">Ø§Ù„Ù…ÙˆØ¸Ù</option>{% for e in employees or [] %}<option value="{{ e.id }}">{{ e.full_name }}</option>{% endfor %}</select>
      </div>
      <div class="table-responsive sticky-wrap" id="ledGridWrap">
        <table class="table table-borderless table-hover table-hover-elevate align-middle table-sm">
          <thead class="table-light"><tr><th>#</th><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙŠØ¯</th><th class="text-end">Ù…Ø¯ÙŠÙ†</th><th class="text-end">Ø¯Ø§Ø¦Ù†</th><th class="text-end">Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>âš™</th></tr></thead>
          <tbody id="ledTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="offcanvas offcanvas-end" tabindex="-1" id="ledCanvas" aria-labelledby="ledCanvasLabel">
    <div class="offcanvas-header" style="background:linear-gradient(135deg,#1E40AF,#4F46E5);color:#fff"><h5 id="ledCanvasLabel">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button></div>
    <div class="offcanvas-body">
      <div class="d-grid gap-2">
        <div><span class="text-muted">Ø§Ù„Ù…ÙˆØ¸Ù:</span> <span id="ledName"></span></div>
        <div><span class="text-muted">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> <span id="ledDate"></span></div>
        <div><span class="text-muted">Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙŠØ¯:</span> <span id="ledTypeLabel"></span></div>
        <div><span class="text-muted">Ù…Ø¯ÙŠÙ†:</span> <span id="ledDebit"></span></div>
        <div><span class="text-muted">Ø¯Ø§Ø¦Ù†:</span> <span id="ledCredit"></span></div>
        <div><span class="text-muted">Ø§Ù„Ø±ØµÙŠØ¯:</span> <span id="ledBalance"></span></div>
        <div><span class="text-muted">Ø§Ù„Ø­Ø§Ù„Ø©:</span> <span id="ledStatusLabel"></span></div>
      </div>
      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-navy ripple" id="ledEdit">ğŸ’¾ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn btn-outline-secondary ripple" id="ledDelete">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        <button class="btn btn-outline-dark ripple" id="ledPreview">ğŸ“Š Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù‚ÙŠØ¯</button>
        <button class="btn btn-outline-secondary ripple" id="ledPrint">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>
    </div>
  </div>

</div>
<script>
async function loadLedMetrics(){ const m=document.getElementById('ledMonth')?.value||''; const url=new URL('/api/ledger/metrics', location.origin); if(m) url.searchParams.set('date', m+'-01'); try{ const r=await fetch(url); const j=await r.json(); if(j&&j.ok){ document.getElementById('kpiDed').textContent='ï·¼'+Number(j.deductions_total||0).toFixed(2); document.getElementById('kpiAdv').textContent='ï·¼'+Number(j.advances_outstanding||0).toFixed(2); document.getElementById('kpiCnt').textContent=Number(j.entries_count||0); const s=(j.series||[]); const cv=document.getElementById('ledSpark'); if(cv&&s.length){ const ctx=cv.getContext('2d'); const w=cv.width=cv.clientWidth; const h=cv.height=cv.clientHeight; const vals=s.map(x=>Number((x.debit_total||0)-(x.credit_total||0))); const max=Math.max.apply(null,vals.concat([1])); const min=Math.min.apply(null,vals.concat([0])); const pad=4; ctx.clearRect(0,0,w,h); ctx.strokeStyle='#22D3EE'; ctx.lineWidth=2; ctx.beginPath(); s.forEach((x,i)=>{ const vx=pad + (w-2*pad)*i/(s.length-1||1); const vy=h-pad - (h-2*pad)*(vals[i]-min)/(max-min||1); if(i===0) ctx.moveTo(vx,vy); else ctx.lineTo(vx,vy); }); ctx.stroke(); ctx.fillStyle='rgba(79,70,229,.15)'; ctx.beginPath(); s.forEach((x,i)=>{ const vx=pad + (w-2*pad)*i/(s.length-1||1); const vy=h-pad - (h-2*pad)*(vals[i]-min)/(max-min||1); if(i===0) ctx.moveTo(vx,vy); else ctx.lineTo(vx,vy); }); ctx.lineTo(w-pad,h-pad); ctx.lineTo(pad,h-pad); ctx.closePath(); ctx.fill(); } } }catch(e){} }
async function loadLedger(){ const m=document.getElementById('ledMonth')?.value||''; const t=document.getElementById('ledType')?.value||''; const st=document.getElementById('ledStatus')?.value||''; const emp=document.getElementById('ledEmployee')?.value||''; const dept=document.querySelector('#ledDeptTabs .pill-tab.active')?.getAttribute('data-dept')||''; const url=new URL('/api/ledger/list', location.origin); if(m) url.searchParams.set('month', m); if(t) url.searchParams.set('type', t); if(emp) url.searchParams.set('emp_id', emp); try{ const r=await fetch(url); const j=await r.json(); if(j&&j.ok){ const tbody=document.getElementById('ledTableBody'); tbody.innerHTML=''; let i=0; (j.rows||[]).forEach(x=>{ if(st && (x.status||'').toLowerCase()!==st.toLowerCase()) return; const tr=document.createElement('tr'); tr.setAttribute('data-name', x.employee_name||''); tr.innerHTML=`<td>${++i}</td><td>${x.employee_name||''}</td><td>${x.date||''}</td><td>${x.type||''}</td><td class='text-end'>${Number(x.debit||0).toFixed(2)}</td><td class='text-end'>${Number(x.credit||0).toFixed(2)}</td><td class='text-end'>${Number(x.balance||0).toFixed(2)}</td><td>${x.status||''}</td><td><div class='dropdown'><button class='btn btn-sm btn-outline-secondary' data-bs-toggle='dropdown'>â‹®</button><ul class='dropdown-menu'><li><button class='dropdown-item' data-led='${encodeURIComponent(JSON.stringify(x))}' data-bs-toggle='offcanvas' data-bs-target='#ledCanvas'>Ù…Ø¹Ø§ÙŠÙ†Ø©</button></li><li><button class='dropdown-item' data-act='edit' data-led='${encodeURIComponent(JSON.stringify(x))}'>ØªØ¹Ø¯ÙŠÙ„</button></li><li><button class='dropdown-item' data-act='delete' data-led='${encodeURIComponent(JSON.stringify(x))}'>Ø­Ø°Ù</button></li><li><button class='dropdown-item' data-act='print' data-led='${encodeURIComponent(JSON.stringify(x))}'>Ø·Ø¨Ø§Ø¹Ø©</button></li></ul></div></td>`; tbody.appendChild(tr); }); document.querySelectorAll('[data-bs-target="#ledCanvas"]').forEach(b=> b.addEventListener('click', function(){ const x=JSON.parse(decodeURIComponent(this.getAttribute('data-led')||'%7B%7D')); document.getElementById('ledName').textContent=x.employee_name||''; document.getElementById('ledDate').textContent=x.date||''; document.getElementById('ledTypeLabel').textContent=x.type||''; document.getElementById('ledDebit').textContent='ï·¼'+Number(x.debit||0).toFixed(2); document.getElementById('ledCredit').textContent='ï·¼'+Number(x.credit||0).toFixed(2); document.getElementById('ledBalance').textContent='ï·¼'+Number(x.balance||0).toFixed(2); document.getElementById('ledStatusLabel').textContent=x.status||''; document.getElementById('ledEdit').onclick=()=> showToast('ÙØªØ­ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); document.getElementById('ledDelete').onclick=()=> showToast('Ø­Ø°Ù Ø§Ù„Ù‚ÙŠØ¯'); document.getElementById('ledPreview').onclick=()=> showToast('Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù‚ÙŠØ¯'); document.getElementById('ledPrint').onclick=()=> window.print(); }); document.querySelectorAll('[data-act]').forEach(b=> b.addEventListener('click', function(){ const act=this.getAttribute('data-act'); const x=JSON.parse(decodeURIComponent(this.getAttribute('data-led')||'%7B%7D')); if(act==='edit'){ showToast('ÙØªØ­ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); } else if(act==='delete'){ showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø­Ø°Ù'); } else if(act==='print'){ window.print(); } })); const incompatible=(j.rows||[]).some(r=> !/advance|deduction/i.test(r.type||'')); if(incompatible){ showToast('Ù‚ÙŠØ¯ ØºÙŠØ± Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø£Ùˆ Ø§Ù„Ø³Ù„Ù'); } const needsApproval=(j.rows||[]).some(r=> (r.status||'').toLowerCase()==='due'); if(needsApproval){ showToast('Ù‚ÙŠØ¯ Ø¬Ø¯ÙŠØ¯ ÙŠØ­ØªØ§Ø¬ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ±'); } } }catch(e){} }
document.getElementById('ledMonth')?.addEventListener('change', ()=>{ loadLedMetrics(); loadLedger(); });
document.getElementById('ledType')?.addEventListener('change', loadLedger);
document.getElementById('ledStatus')?.addEventListener('change', loadLedger);
document.getElementById('ledEmployee')?.addEventListener('change', loadLedger);
document.querySelectorAll('#ledDeptTabs .pill-tab').forEach(b=> b.addEventListener('click', function(){ document.querySelectorAll('#ledDeptTabs .pill-tab').forEach(x=> x.classList.remove('active')); this.classList.add('active'); loadLedger(); }));
loadLedMetrics();
loadLedger();
try{ lottie.loadAnimation({ container: document.getElementById('lottieDed'), renderer:'svg', loop:true, autoplay:true, path:'https://lottie.host/92b0a1f1-payroll.json' }); lottie.loadAnimation({ container: document.getElementById('lottieAdv'), renderer:'svg', loop:true, autoplay:true, path:'https://lottie.host/7f8da2c2-money.json' }); lottie.loadAnimation({ container: document.getElementById('lottieCnt'), renderer:'svg', loop:true, autoplay:true, path:'https://lottie.host/b1c2a3d4-clock.json' }); }catch(e){}
function showToast(msg){ const el=document.createElement('div'); el.className='toast-led'; el.textContent=msg||''; document.body.appendChild(el); setTimeout(()=>{ el.remove(); },5000); }
const hdr=document.getElementById('ledHeader'); const lg=document.getElementById('ledLogo'); if(hdr&&lg){ hdr.addEventListener('mousemove', function(ev){ const r=hdr.getBoundingClientRect(); const cx=ev.clientX - r.left; const cy=ev.clientY - r.top; const rx=(cx/r.width - .5)*8; const ry=(cy/r.height - .5)*-8; lg.style.transform = `perspective(300px) rotateY(${rx}deg) rotateX(${ry}deg) scale(1.06)`; }); hdr.addEventListener('mouseleave', function(){ lg.style.transform='none'; }); }
</script>
{% endblock %}
