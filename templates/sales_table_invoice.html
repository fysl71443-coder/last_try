{% extends 'base.html' %}
{% block title %}Sales - Table #{{ table_number }} — {{ branch_label }}{% endblock %}
{% block content %}
<style>
  :root{
    --ui-primary:#1c2c58;
    --ui-accent:#c9a34a;
    --ui-bg:#0e1220;
    --ui-card:rgba(255,255,255,0.08);
    --ui-glass:rgba(255,255,255,0.12);
    --ui-border:rgba(255,255,255,0.22);
    --ui-text:#0d0d0d;
    --ui-contrast:#ffffff;
    --ui-radius:14px;
    --ui-shadow:0 10px 28px rgba(12,18,32,.25);
    --ui-ring:0 0 0 3px rgba(201,163,74,.35);
    --ui-gradient: radial-gradient(1000px 600px at 10% -10%, rgba(28,44,88,.20), transparent 60%), radial-gradient(800px 400px at 90% 0%, rgba(201,163,74,.16), transparent 55%), linear-gradient(180deg, #f7f8fb, #eef0f6);
  }
  .premium-ui{ font-family: 'Tajawal', 'Inter', 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; background: var(--ui-gradient); min-height: 100vh; }
  .split { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  @media (max-width: 992px) { .split { grid-template-columns: 1fr; } }
  .card{ border-radius: var(--ui-radius); box-shadow: var(--ui-shadow); backdrop-filter: saturate(120%) blur(6px); }
  .glass-card{ background: linear-gradient(180deg, var(--ui-card), transparent); border: 1px solid var(--ui-border); }
  .cat-card{ cursor: pointer; border-radius: 16px; background: linear-gradient(180deg, rgba(28,44,88,.08), rgba(28,44,88,.02)); transition: transform .14s ease, box-shadow .14s ease; will-change: transform; min-height: 110px; }
  .cat-card:hover{ transform: translateY(-2px) scale(1.01); box-shadow: 0 8px 20px rgba(28,44,88,.18); }
  .cat-card:active{ transform: translateY(0) scale(.98); }
  .meal-card{ cursor: pointer; border-radius: 16px; background: linear-gradient(180deg, rgba(28,44,88,.06), rgba(28,44,88,.02)); transition: transform .12s ease, box-shadow .12s ease; }
  .meal-card:hover{ transform: translateY(-1px) scale(1.01); box-shadow: 0 6px 16px rgba(28,44,88,.16); }
  .meal-card:active{ transform: translateY(0) scale(.98); }
  .thumb{ position: relative; }
  .thumb::after{ content:''; position:absolute; inset:0; background: linear-gradient(180deg, rgba(0,0,0,.0), rgba(0,0,0,.06)); pointer-events:none; }
  .thumb img{ image-rendering: -webkit-optimize-contrast; }
  .thumb .cap{ position:absolute; left:0; right:0; bottom:0; padding:6px 8px; background: linear-gradient(180deg, rgba(0,0,0,.0), rgba(0,0,0,.25)); color:#fff; font-weight:600; font-size:.9rem; text-shadow:0 1px 2px rgba(0,0,0,.35); display:flex; justify-content:space-between; align-items:center; }
  [dir="rtl"] .thumb .cap{ flex-direction:row-reverse; }
  .elegant-title{ background: linear-gradient(90deg, #1c2c58, #2b3e78 40%, #c9a34a 90%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; letter-spacing:.3px; }
  .lux-btn{ background: linear-gradient(135deg, var(--ui-primary), #0f1f44); color:#fff; border: 1px solid rgba(201,163,74,.45); box-shadow: 0 10px 24px rgba(12,18,32,.35), inset 0 0 0 1px rgba(255,255,255,.06); border-radius: 14px; padding: 10px 18px; font-weight:600; letter-spacing:.2px; transition: transform .15s ease, box-shadow .15s ease, filter .15s ease; }
  .lux-btn:hover{ filter: brightness(1.06); box-shadow: 0 14px 32px rgba(12,18,32,.42), inset 0 0 0 1px rgba(255,255,255,.08); }
  .lux-btn:active{ transform: translateY(1px) scale(.99); }
  .lux-btn-red{ background: linear-gradient(135deg, #b21f2d, #7a0c16); color:#fff; border: 1px solid rgba(220,53,69,.45); box-shadow: 0 10px 24px rgba(178,31,45,.35), inset 0 0 0 1px rgba(255,255,255,.06); border-radius: 14px; padding: 10px 18px; font-weight:600; letter-spacing:.2px; transition: transform .15s ease, box-shadow .15s ease, filter .15s ease; }
  .lux-btn-red:hover{ filter: brightness(1.06); box-shadow: 0 14px 32px rgba(178,31,45,.42), inset 0 0 0 1px rgba(255,255,255,.08); }
  .lux-btn-red:active{ transform: translateY(1px) scale(.99); }
  .lux-btn-gray{ background: linear-gradient(135deg, #6c757d, #495057); color:#fff; border: 1px solid rgba(108,117,125,.45); box-shadow: 0 10px 24px rgba(73,80,87,.35), inset 0 0 0 1px rgba(255,255,255,.06); border-radius: 14px; padding: 10px 18px; font-weight:600; letter-spacing:.2px; transition: transform .15s ease, box-shadow .15s ease, filter .15s ease; }
  .lux-btn-gray:hover{ filter: brightness(1.06); box-shadow: 0 14px 32px rgba(73,80,87,.42), inset 0 0 0 1px rgba(255,255,255,.08); }
  .lux-btn-gray:active{ transform: translateY(1px) scale(.99); }
  .form-control, .form-select{ border-radius: 12px; transition: box-shadow .18s ease, transform .12s ease; }
  .form-control:focus, .form-select:focus{ box-shadow: var(--ui-ring), 0 10px 22px rgba(12,18,32,.18); border-color: var(--ui-accent); }
  .table{ border-collapse: separate; border-spacing: 0 6px; }
  .table thead th{ background: linear-gradient(180deg, rgba(12,18,32,.06), rgba(12,18,32,.0)); }
  #itemsList .table tbody tr{ background: #fff; border-radius: 12px; }
  #itemsList .table tbody tr td:first-child{ border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
  #itemsList .table tbody tr td:last-child{ border-top-right-radius: 12px; border-bottom-right-radius: 12px; }
  .metrics{ display:flex; justify-content:end; gap:18px; }
  .metrics div{ background: linear-gradient(180deg, rgba(12,18,32,.05), rgba(12,18,32,.0)); padding:8px 12px; border-radius: 12px; }
  .reveal{ animation: fadeUp .35s ease both; }
  @keyframes fadeUp{ 0%{ opacity:0; transform: translateY(8px) scale(.98); } 100%{ opacity:1; transform: translateY(0) scale(1); } }
  .pressed3d{ transform: perspective(600px) translateZ(-2px) scale(.985); }
  .trash-target{ opacity:.25; }
  [dir="rtl"] .premium-ui .metrics{ justify-content:start; }
  [dir="rtl"] .premium-ui .form-label{ text-align:right; }
  .btn-outline-danger{ border-radius: 12px; }
  .row.g-2 .col-6, .row.g-2 .col-md-4, .row.g-2 .col-lg-3{ will-change: transform; }
</style>
<style>
  /* Print only the injected invoice container */
  @media print {
    body * { visibility: hidden !important; }
    #invoice, #invoice * { visibility: visible !important; }
    #invoice { position: absolute; left: 0; top: 0; width: 100%; }
  }
</style>

{% if current_user.is_authenticated %}{% set back_url = url_for('main.sales_tables', branch_code=branch_code) %}{% else %}{% set back_url = '#' %}{% endif %}

{% set currency_src = None %}
{% if settings and settings.currency_image %}
  {% set currency_src = settings.currency_image %}
{% elif settings and settings.currency and (settings.currency.startswith('http') or settings.currency.startswith('/')) %}
  {% set currency_src = settings.currency %}
{% endif %}
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<div class="container-fluid py-3 premium-ui">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="mb-0 elegant-title">Table #{{ table_number }} — {{ branch_label }}</h4>
      <small class="text-muted">Select category then meal to add to invoice</small>
    </div>
    <div>
      <a class="btn btn-outline-secondary" href="{{ back_url }}">← Back to Tables</a>
    </div>
  </div>

  <div id="invoice" style="display:none;"></div>

  <div class="split">
    <!-- Right: Categories and Meals -->
    <div>
      <div class="mb-2">
        <h5 class="mb-2">Main Categories</h5>
        <div class="row g-2">
          {% for c in categories %}
          <div class="col-6 col-md-4 col-lg-3">
            <div class="card cat-card p-2 h-100" data-cat-name="{{ c }}">
              <div class="card-body d-flex align-items-center justify-content-center">
                <div class="fw-bold text-center">{{ c }}</div>
              </div>
            </div>
            <!-- Meals inside category card -->
            <!-- Inline holder removed: using modal approach for cleaner navigation -->


          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Left: Invoice Form -->
    <div>
      <div class="card glass-card">
        <div class="card-body">
          <div class="row g-2">
            <input type="hidden" id="csrfTokenPage" value="{{ csrf_token() }}">
            <div class="col-md-6">
              <label class="form-label">Date</label>
              <input id="date" type="date" class="form-control" value="{{ today }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Invoice No.</label>
              <input id="invNo" type="text" class="form-control" placeholder="Auto" readonly>
            </div>
            <div class="col-md-8">
              <div class="d-flex align-items-center justify-content-between">
                <label class="form-label mb-0">Customer</label>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="openAddCustomerModalTable()">➕ {{ _('New Customer / عميل جديد') }}</button>
              </div>
              <input id="custName" type="text" class="form-control mt-1" placeholder="Type name or phone...">
              <div id="custList" class="list-group position-absolute w-50" style="z-index:10; display:none;"></div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Customer Phone</label>
              <input id="custPhone" type="text" class="form-control" placeholder="Auto" readonly>
            </div>
            <div class="col-md-4">
              <label class="form-label">Discount %</label>
              <input id="discountPct" type="number" step="0.01" value="0" class="form-control bg-light" readonly title="Auto from customer; editable only for KEETA/HUNGER">
            </div>
            <div class="col-md-4">
              <label class="form-label">Tax %</label>
              <input id="taxPct" type="number" step="0.01" value="{{ vat_rate }}" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Payment</label>
              <select id="payMethod" class="form-select">
                <option value="">-- اختر طريقة الدفع --</option>
                <option value="CASH">CASH</option>
                <option value="CARD">CARD</option>
              </select>
            </div>
          </div>

          <hr>

          <div>
            <h6 class="mb-2">Items</h6>
            <div id="itemsList" class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>Meal</th>
                    <th class="text-center" style="width:100px;">Qty</th>
                    <th class="text-end" style="width:140px;">Unit</th>
                    <th class="text-end" style="width:140px;">Total</th>
                    <th style="width:50px;"></th>
                  </tr>
                </thead>
                <tbody id="itemsBody"></tbody>
              </table>
            </div>
            <div class="trash-target"><i class="bi bi-trash"></i></div>

            <div class="metrics">
              <div><strong>Subtotal</strong>: <span id="subtotal">0.00</span> {% if currency_src %}<img src="{{ currency_src }}" width="14" height="14" alt="currency">{% elif settings and settings.currency %} {{ settings.currency }}{% endif %}</div>
              <div><strong>Tax</strong>: <span id="tax">0.00</span> {% if currency_src %}<img src="{{ currency_src }}" width="14" height="14" alt="currency">{% elif settings and settings.currency %} {{ settings.currency }}{% endif %}</div>
              <div><strong>Discount</strong>: <span id="discount">0.00</span> {% if currency_src %}<img src="{{ currency_src }}" width="14" height="14" alt="currency">{% elif settings and settings.currency %} {{ settings.currency }}{% endif %}</div>
              <div><strong>Grand Total</strong>: <span id="grand">0.00</span> {% if currency_src %}<img src="{{ currency_src }}" width="14" height="14" alt="currency">{% elif settings and settings.currency %} {{ settings.currency }}{% endif %}</div>
            </div>
          </div>

          <div class="mt-3 d-flex justify-content-center align-items-center gap-3">
            <button id="btnGenerateInvoice" class="btn lux-btn">Issue Invoice / إصدار فاتورة</button>
            <button id="btnVoidInvoice" class="btn lux-btn-red">Cancel Invoice / إلغاء الفاتورة</button>
            <button id="btnPrintOrder" class="btn lux-btn-gray">PRINT ORDER-طباعة الطلب</button>
          </div>
          <div class="mt-3 text-center">
            <button type="button" class="btn btn-outline-primary btn-sm" id="btnCashCalcTbl">Cash Change Calculator</button>
          </div>
          <div id="cashCalcTbl" class="mt-2 card border-0 shadow-sm" style="display:none">
            <div class="card-body p-3">
            <div class="fw-semibold mb-2">Cash Change Calculator</div>
            <div class="row g-2 justify-content-center">
              <div class="col-12 col-md-5">
                <label class="form-label text-end w-100">Amount Received</label>
                <div class="input-group" style="width:140px; margin-left:auto;">
                  <span class="input-group-text">SAR</span>
                  <input id="cashReceivedTbl" type="number" step="0.01" min="0" class="form-control" placeholder="0.00">
                </div>
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label">Total</label>
                <div class="form-control bg-light" id="cashTotalTbl">SAR0.00</div>
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label">Change</label>
                <div class="form-control bg-success text-white" id="cashChangeTbl">SAR0.00</div>
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label">Due</label>
                <div class="form-control bg-warning" id="cashDueTbl">SAR0.00</div>
              </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

<!-- One global modal placed once per page to avoid multiple instances -->
<div class="modal fade" id="catModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="catModalTitle">Items</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">


        <div id="catEmpty" class="alert alert-info d-none">No items in this category yet</div>
        <div class="row g-2" id="catGrid"></div>
      </div>
    </div>
  </div>
</div>

  </div>
</div>

<div id="pos-init" style="display:none"
     data-branch="{{ branch_code }}"
     data-table="{{ table_number }}"
     data-vat="{{ vat_rate }}"
     data-draft='{{ draft_items|safe }}'
     data-draft-id="{{ current_draft.id if current_draft else '' }}"
     data-cat-map='{{ cat_map_json|safe }}'
     data-cat-images='{{ cat_image_map_json|safe }}'
     data-cust-name="{{ init_cust_name }}"
     data-cust-phone="{{ init_cust_phone }}"
     data-disc="{{ init_discount_pct }}"
     data-tax="{{ init_tax_pct }}"
     data-pay="{{ init_payment_method }}">
</div>

<!-- Add Customer Modal (Table Invoice) -->
<div class="modal fade" id="addCustomerTableModal" tabindex="-1" aria-labelledby="addCustomerTableModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addCustomerTableModalLabel">{{ _('Add Customer / إضافة عميل') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">{{ _('Name / الاسم') }}</label>
          <input id="tblNewCustName" class="form-control" placeholder="{{ _('Customer name') }}">
        </div>
        <div class="mb-2">
          <label class="form-label">{{ _('Phone / الهاتف') }}</label>
          <input id="tblNewCustPhone" class="form-control" placeholder="{{ _('Phone (optional)') }}">
        </div>
        <div class="mb-2">
          <label class="form-label">{{ _('Discount %% / نسبة الخصم') }}</label>
          <input id="tblNewCustDisc" type="number" min="0" max="100" step="0.01" class="form-control" value="0">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Close / إغلاق') }}</button>
        <button type="button" class="btn btn-primary" onclick="submitNewCustomerTable()">{{ _('Save / حفظ') }}</button>
      </div>
    </div>
  </div>
</div>

<script>
  function openAddCustomerModalTable(){
    try{
      document.getElementById('tblNewCustName').value = '';
      document.getElementById('tblNewCustPhone').value = '';
      document.getElementById('tblNewCustDisc').value = '0';
      const m = new bootstrap.Modal(document.getElementById('addCustomerTableModal'));
      m.show();
    }catch(e){ alert('Cannot open modal'); }
  }
  async function submitNewCustomerTable(){
    const name = (document.getElementById('tblNewCustName').value||'').trim();
    const phone = (document.getElementById('tblNewCustPhone').value||'').trim();
    const discount = parseFloat(document.getElementById('tblNewCustDisc').value||'0')||0;
    if(!name){ alert('Name is required / الاسم مطلوب'); return; }
    try{
      const res = await fetch('{{ url_for('main.api_customers_create') }}', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({name, phone, discount_percent: discount})
      });
      const j = await res.json();
      if(!res.ok || !j || j.ok !== true){ throw new Error((j && j.error) || 'Failed'); }
      const c = j.customer || {};
      // Populate fields on the invoice form
      const nameInput = document.getElementById('custName');
      const phoneInput = document.getElementById('custPhone');
      const discInput = document.getElementById('discountPct');
      if(nameInput) nameInput.value = c.name || name;
      if(phoneInput) phoneInput.value = c.phone || phone || '';
      if(discInput){
        const d = (typeof c.discount_percent !== 'undefined') ? c.discount_percent : discount;
        discInput.value = (parseFloat(d||0) || 0).toString();
      }
      try{ bootstrap.Modal.getInstance(document.getElementById('addCustomerTableModal')).hide(); }catch(_){ }
    }catch(e){ alert(String(e.message||e)); }
  }
</script>

<script>
  (function(){
    const el = document.getElementById('btnPrintOrder');
    if(!el) return;
    const url = '{{ url_for('main.print_order_slip', branch=branch_code, table=table_number) }}';
    el.addEventListener('click', function(){
      try{
        window.open(url, 'order_print', 'width=520,height=800');
      }catch(_){
        window.location.href = url;
      }
    });
  })();
</script>

<script src="{{ url_for('static', filename='js/pos_table.js') }}?v={{ ASSET_VERSION }}"></script>
<script>
  (function(){
    try{
      var n = "{{ init_cust_name }}";
      var p = "{{ init_cust_phone }}";
      var d = "{{ init_discount_pct }}";
      var t = "{{ init_tax_pct }}";
      var m = "{{ init_payment_method }}";
      if(n){ var el = document.getElementById('custName'); if(el) el.value = n; }
      if(p){ var elp = document.getElementById('custPhone'); if(elp) elp.value = p; }
      if(d){ var eld = document.getElementById('discountPct'); if(eld) eld.value = String(d); }
      if(t){ var elt = document.getElementById('taxPct'); if(elt) elt.value = String(t); }
      if(m){ var elm = document.getElementById('payMethod'); if(elm) elm.value = m.toUpperCase(); }
    }catch(e){}
  })();
</script>

<script>
  function parseMoneyTxtTbl(t){ try{ return parseFloat(String(t||'').replace(/[^0-9.\-]/g,''))||0; }catch(_){ return 0; } }
  function getGrandTbl(){ const el=document.getElementById('grand'); return parseMoneyTxtTbl(el && el.textContent || '0'); }
  function computeCashChangeTbl(){
    const box = document.getElementById('cashCalcTbl'); if(!box) return;
    const pm = (document.getElementById('payMethod')?.value||'');
    const force = !!window.cashCalcForceShowTbl;
    box.style.display = (force || pm==='CASH') ? 'block' : 'none';
    const total = getGrandTbl();
    const recv = parseFloat(document.getElementById('cashReceivedTbl')?.value||'0')||0;
    const change = Math.max(0, recv - total);
    const due = Math.max(0, total - recv);
    const set=(id,val)=>{ const el=document.getElementById(id); if(el){ el.textContent = `SAR${Number(val||0).toFixed(2)}`; } };
    set('cashTotalTbl', total);
    set('cashChangeTbl', change);
    set('cashDueTbl', due);
  }
  document.getElementById('cashReceivedTbl')?.addEventListener('input', computeCashChangeTbl);
  document.getElementById('payMethod')?.addEventListener('change', computeCashChangeTbl);
  document.getElementById('btnCashCalcTbl')?.addEventListener('click', function(){ window.cashCalcForceShowTbl = !window.cashCalcForceShowTbl; computeCashChangeTbl(); });
  try{
    const target = document.getElementById('grand');
    if(target){
      const obs = new MutationObserver(()=> computeCashChangeTbl());
      obs.observe(target, { childList:true, characterData:true, subtree:true });
      computeCashChangeTbl();
    }
  }catch(_){ }
</script>

{% endblock %}

