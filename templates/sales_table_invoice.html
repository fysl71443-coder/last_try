{% extends 'base.html' %}
{% block title %}{{ _('Sales - Table / Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª - Ø§Ù„Ø·Ø§ÙˆÙ„Ø©') }} #{{ table_number }} â€” {{ branch_label }}{% endblock %}
{% block content %}
<style>
  .split { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .cat-card { cursor: pointer; transition: transform .1s ease; }
  .cat-card:hover { transform: translateY(-2px); }
  .meal-card { cursor: pointer; }
  @media (max-width: 992px) { .split { grid-template-columns: 1fr; } }
</style>
{% set back_url = url_for('sales_tables', branch_code=branch_code) %}

<div class="container-fluid py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="mb-0">{{ _('Table') }} #{{ table_number }} â€” {{ branch_label }}</h4>
      <small class="text-muted">{{ _('Select category then meal to add to invoice / Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø«Ù… Ø§Ù„ÙˆØ¬Ø¨Ø©') }}</small>
    </div>
    <div>
      <a class="btn btn-outline-secondary" href="{{ url_for('sales_tables', branch_code=branch_code) }}">â† {{ _('Back to Tables / Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø·Ø§ÙˆÙ„Ø§Øª') }}</a>
    </div>
  </div>

  <div class="split">
    <!-- Right: Categories and Meals -->
    <div>
      <div class="mb-2">
        <h5 class="mb-2">{{ _('Main Categories / Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©') }}</h5>
        <div class="row g-2">
          {% for c in categories %}
          <div class="col-6 col-md-4 col-lg-3">
            <div class="card cat-card p-2 h-100" onclick="selectCategory('{{ c }}', {{ loop.index0 }})">
              <div class="card-body d-flex align-items-center justify-content-center">
                <div class="fw-bold text-center">{{ c }}</div>
              </div>
            </div>
            <!-- Meals inside category card -->
            <!-- Inline holder removed: using modal approach for cleaner navigation -->


          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Left: Invoice Form -->
    <div>
      <div class="card">
        <div class="card-body">
          <div class="row g-2">
            <input type="hidden" id="csrfTokenPage" value="{{ csrf_token() }}">
            <div class="col-md-6">
              <label class="form-label">{{ _('Date / Ø§Ù„ØªØ§Ø±ÙŠØ®') }}</label>
              <input id="date" type="date" class="form-control" value="{{ today }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('Invoice No. / Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©') }}</label>
              <input id="invNo" type="text" class="form-control" placeholder="Auto" readonly>
            </div>
            <div class="col-md-8">
              <label class="form-label">{{ _('Customer / Ø§Ù„Ø¹Ù…ÙŠÙ„') }}</label>
              <input id="custName" type="text" class="form-control" placeholder="{{ _('Type name or phone...') }}">
              <div id="custList" class="list-group position-absolute w-50" style="z-index:10; display:none;"></div>
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Customer Phone / Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„') }}</label>
              <input id="custPhone" type="text" class="form-control" placeholder="{{ _('Auto') }}" readonly>
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Discount %% / Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… %%') }}</label>
              <input id="discountPct" type="number" step="0.01" value="0" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Tax %% / Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© %%') }}</label>
              <input id="taxPct" type="number" step="0.01" value="{{ vat_rate }}" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Payment / Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹') }}</label>
              <select id="payMethod" class="form-select">
                <option value="CASH">Cash</option>
                <option value="MADA">MADA</option>
                <option value="VISA">VISA</option>
                <option value="BANK">BANK</option>
              </select>
            </div>
          </div>

          <hr>

          <div>
            <h6 class="mb-2">{{ _('Items / Ø§Ù„Ø£ØµÙ†Ø§Ù') }}</h6>
            <div id="itemsList" class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>{{ _('Meal') }}</th>
                    <th class="text-center" style="width:100px;">{{ _('Qty') }}</th>
                    <th class="text-end" style="width:140px;">{{ _('Unit') }}</th>
                    <th class="text-end" style="width:140px;">{{ _('Total') }}</th>
                    <th style="width:50px;"></th>
                  </tr>
                </thead>
                <tbody id="itemsBody"></tbody>
              </table>
            </div>

            <div class="d-flex justify-content-end gap-3">
              <div><strong>{{ _('Subtotal') }}</strong>: <span id="subtotal">0.00</span></div>
              <div><strong>{{ _('Tax') }}</strong>: <span id="tax">0.00</span></div>
              <div><strong>{{ _('Discount') }}</strong>: <span id="discount">0.00</span></div>
              <div><strong>{{ _('Grand Total') }}</strong>: <span id="grand">0.00</span></div>
            </div>
          </div>

          <div class="mt-3 d-flex justify-content-between align-items-center">
            <button class="btn btn-outline-danger" onclick="voidInvoice()">{{ _('Cancel Invoice / Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©') }}</button>
            <button class="btn btn-success" onclick="payAndPrint()">{{ _('Pay & Print / Ø¯ÙØ¹ + Ø·Ø¨Ø§Ø¹Ø©') }}</button>
          </div>
        </div>
      </div>
    </div>

<!-- One global modal placed once per page to avoid multiple instances -->
<div class="modal fade" id="catModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="catModalTitle">{{ _('Items') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="catEmpty" class="alert alert-info d-none">{{ _('No items in this category yet / Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¨Ø¹Ø¯') }}</div>
        <div class="row g-2" id="catGrid"></div>
      </div>
    </div>
  </div>
</div>

  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.cat-card').forEach((el, i)=>{
      el.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); selectCategory(el.innerText.trim(), i);} });
      el.addEventListener('click', ()=> selectCategory(el.innerText.trim(), i));
      el.setAttribute('tabindex','0');
    });
    // expose codes for external script
    document.body.dataset.branch = '{{ branch_code }}';
    document.body.dataset.table = '{{ table_no }}';
  });

  // Category name -> id map injected from server when available
  window.CAT_MAP = {{ cat_map_json | safe }};
  console.log('ğŸ—ºï¸ CAT_MAP loaded:', window.CAT_MAP);

  const meals = {{ meals_json | safe }};
  console.log('ğŸ¥˜ Meals loaded:', meals.length, 'meals');
  console.log('ğŸ“‚ Categories available:', {{ categories | tojson }});
  let currentCategory = null;
  const items = [];
  let currentDraftId = {{ current_draft.id if current_draft else 'null' }};
  let custTimer = null;

  // Load existing draft items
  const draftItems = {{ draft_items|safe }};
  if (draftItems && draftItems.length > 0) {
    draftItems.forEach(item => {
      items.push({
        meal_id: item.meal_id,
        name: item.name,
        unit: item.price,
        qty: item.quantity
      });
    });
  }
  const custList = document.getElementById('custList');
  const custName = document.getElementById('custName');
  const custPhone = document.getElementById('custPhone');

  if(custName){
    custName.addEventListener('input', () => {
      clearTimeout(custTimer);
      const q = custName.value.trim();
      if(!q){ if(custList){ custList.style.display='none'; } return; }
      custTimer = setTimeout(async () => {
        let data = [];
        try{
          const res = await fetch(`/api/customers/lookup?q=${encodeURIComponent(q)}`, { credentials: 'same-origin' });
          if(!res.ok) throw new Error('HTTP '+res.status);
          data = await res.json();
        }catch(e){ data = []; }
        if(!custList){ return; }
        custList.innerHTML = '';
        if(!Array.isArray(data) || !data.length){ custList.style.display='none'; return; }
        data.forEach(c => {
          const a = document.createElement('a');
          a.href = '#'; a.className = 'list-group-item list-group-item-action';
          a.textContent = `${c.name} (${c.phone||'-'}) â€” ${c.discount_percent}%`;
          a.onclick = (e)=>{ e.preventDefault(); selectCustomer(c); };
          custList.appendChild(a);
        });
        custList.style.display = 'block';
      }, 250);
    });
  }

  function selectCustomer(c){
    custName.value = c.name;
    custPhone.value = c.phone || '';
    document.getElementById('discountPct').value = (c.discount_percent||0);
    custList.style.display='none';
    renderItems();
  }

  async function selectCategory(cat, idx){
    currentCategory = cat;
    console.log('ğŸ” Category selected:', cat);
    console.log('ğŸ—ºï¸ CAT_MAP:', window.CAT_MAP);

    // Open modal and populate with items in this category (from Menu API or fallback)
    const modalEl = document.getElementById('catModal');
    const modalTitle = document.getElementById('catModalTitle');
    const grid = document.getElementById('catGrid');
    const empty = document.getElementById('catEmpty');
    modalTitle.textContent = cat;
    grid.innerHTML = '';
    empty.classList.add('d-none');

    // Try menu category mapping first
    const catId = (window.CAT_MAP && window.CAT_MAP[cat]) ? window.CAT_MAP[cat] : null;
    console.log('ğŸ†” Category ID found:', catId);

    let data = [];
    if(catId){
      try{
        console.log('ğŸ“¡ Fetching items from API:', `/api/menu/${catId}/items`);
        const resp = await fetch(`/api/menu/${catId}/items`, { credentials: 'same-origin' });
        console.log('ğŸ“¡ API Response status:', resp.status);
        if(!resp.ok) {
          console.error('âŒ API Error:', resp.status, resp.statusText);
          data = [];
        } else {
          data = await resp.json();
          console.log('ğŸ“¦ API Data received:', data);
        }
      }catch(e){
        console.error('âŒ Fetch error:', e);
        data = [];
      }
    } else {
      console.log('âš ï¸ No category ID found, will use fallback');
    }

    if(catId && Array.isArray(data) && data.length > 0){
      console.log('âœ… Using API data:', data.length, 'items');
      data.forEach(m => {
        const col = document.createElement('div');
        col.className = 'col-6 col-md-4 col-lg-3';
        const price = Number(m.price || 0);
        const safeName = (m.name || '').replace(/`/g,'');
        col.innerHTML = `
          <div class="card meal-card h-100" onclick='addMenuItemClose(${m.meal_id}, ${JSON.stringify(safeName)}, ${price})'>
            <div class="card-body d-flex flex-column justify-content-between">
              <div class="fw-bold">${safeName}</div>
              <div class="text-muted">{{ _('Price') }}: ${price.toFixed(2)}</div>
            </div>
          </div>`;
        grid.appendChild(col);
      });
    } else {
      console.log('âš ï¸ Using fallback: local meals filter');
      // Fallback: local meals filter
      const filtered = meals.filter(m => m.category === cat);
      console.log('ğŸ” Filtered meals:', filtered.length, 'for category:', cat);

      if(filtered.length === 0){
        console.log('âŒ No items found for category:', cat);
        empty.classList.remove('d-none');
        // Add helpful message to empty state
        empty.innerHTML = `
          <div class="alert alert-info">
            <h6>{{ _('No items in this category yet / Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¨Ø¹Ø¯') }}</h6>
            <p class="mb-0">{{ _('Please add meals to this category in the Menu admin page / ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© ÙˆØ¬Ø¨Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙÙŠ ØµÙØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©') }}</p>
            <small class="text-muted">Category: "${cat}"</small>
          </div>
        `;
      } else {
        console.log('âœ… Found', filtered.length, 'items in fallback');
        filtered.forEach(m => {
          const col = document.createElement('div');
          col.className = 'col-6 col-md-4 col-lg-3';
          const price = Number(m.price || 0);
          const safeName = (m.name || '').replace(/`/g,'');
          col.innerHTML = `
            <div class="card meal-card h-100" onclick="addItemClose(${m.id})">
              <div class="card-body d-flex flex-column justify-content-between">
                <div class="fw-bold">${safeName}</div>
                <div class="text-muted">{{ _('Price') }}: ${price.toFixed(2)}</div>
              </div>
            </div>`;
          grid.appendChild(col);
        });
      }
    }

    // Reuse single modal instance to avoid double backdrops and stuck state
    console.log('ğŸ­ Opening modal...');
    if(window.bootstrap && bootstrap.Modal){
      console.log('âœ… Bootstrap Modal available');
      if(!window.__catModalInstance){
        console.log('ğŸ†• Creating new modal instance');
        window.__catModalInstance = new bootstrap.Modal(modalEl, { backdrop: true, keyboard: true });
      }
      console.log('ğŸ“± Showing modal');
      window.__catModalInstance.show();
    } else {
      console.log('âš ï¸ Bootstrap not available, using fallback');
      // Fallback: no Bootstrap available => inline grid visible
      modalEl.classList.add('show');
      modalEl.style.display = 'block';
    }
  }

  function addItemClose(mealId){ addItem(mealId); const m=document.getElementById('catModal'); const inst=bootstrap.Modal.getInstance(m); if(inst) inst.hide(); setTimeout(()=>{document.body.classList.remove('modal-open'); document.querySelectorAll('.modal-backdrop').forEach(b=>b.remove());}, 50); }
  function addMenuItemClose(mealId, name, unit){ addMenuItem(mealId, name, unit); const m=document.getElementById('catModal'); const inst=bootstrap.Modal.getInstance(m); if(inst) inst.hide(); setTimeout(()=>{document.body.classList.remove('modal-open'); document.querySelectorAll('.modal-backdrop').forEach(b=>b.remove());}, 50); }

  async function addItem(mealId){
    const m = meals.find(x => x.id === mealId);
    if(!m) return;
    const existing = items.find(x => x.meal_id === m.id);
    if(existing){
      existing.qty += 1;
    } else {
      items.push({ meal_id: m.id, name: m.name, unit: m.price, qty: 1 });
    }

    renderItems();
    await saveDraftOrder(); // Auto-save after adding item
  }

  // Add item using data from Menu API (fallback if meal not in global list)
  function addMenuItem(mealId, name, unit){
    const m = meals.find(x => x.id === mealId);
    if(m){ addItem(mealId); return; }
    const existing = items.find(x => x.meal_id === mealId);
    if(existing){ existing.qty += 1; }
    else { items.push({ meal_id: mealId, name: name, unit: unit, qty: 1 }); }
    renderItems();
  }

  function renderItems(){
    const body = document.getElementById('itemsBody');
    body.innerHTML = '';
    let subtotal = 0;
    let tax = 0;
    const taxPct = parseFloat(document.getElementById('taxPct').value || '0');
    const discountPct = parseFloat(document.getElementById('discountPct').value || '0');

    items.forEach((it, idx) => {
      const lineSub = it.unit * it.qty;
      const lineTax = lineSub * (taxPct/100.0);
      subtotal += lineSub; tax += lineTax;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${it.name}</td>
        <td class="text-center"><input type="number" min="1" step="1" value="${it.qty}" class="form-control form-control-sm" onchange="changeQty(${idx}, this.value)"></td>
        <td class="text-end">${it.unit.toFixed(2)}</td>
        <td class="text-end">${(lineSub+lineTax).toFixed(2)}</td>
        <td><button class="btn btn-sm btn-outline-danger" onclick="removeItem(${idx})">Ã—</button></td>`;
      body.appendChild(row);
    });

    const discountVal = (subtotal + tax) * (discountPct/100.0);
    const grand = (subtotal + tax) - discountVal;
    document.getElementById('subtotal').innerText = subtotal.toFixed(2);
    document.getElementById('tax').innerText = tax.toFixed(2);
    document.getElementById('discount').innerText = discountVal.toFixed(2);
    document.getElementById('grand').innerText = grand.toFixed(2);
  }

  async function changeQty(idx, v){
    items[idx].qty = parseFloat(v||'1');
    renderItems();
    await saveDraftOrder(); // Auto-save after quantity change
  }

  async function removeItem(idx){
    items.splice(idx,1);
    renderItems();
    await saveDraftOrder(); // Auto-save after item removal
  }

  // Auto-save draft order
  async function saveDraftOrder() {
    if (!currentDraftId || items.length === 0) return;

    try {
      const response = await fetch(`/api/draft_orders/${currentDraftId}/update`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
        },
        body: JSON.stringify({
          items: items,
          customer_name: document.getElementById('custName').value,
          customer_phone: document.getElementById('custPhone').value,
          payment_method: document.getElementById('payMethod').value
        })
      });

      const data = await response.json();
      if (!data.success) {
        console.error('Failed to save draft order:', data.error);
      }
    } catch (error) {
      console.error('Error saving draft order:', error);
    }
  }

  async function payAndPrint(){
    if(items.length === 0){
      await showAlert('{{ _('Add at least one item / Ø£Ø¶Ù Ø¹Ù†ØµØ±Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„') }}');
      return;
    }

    // Direct payment and print - no additional screens
    let payload;

    if (currentDraftId) {
      // Convert draft to invoice directly
      payload = {
        draft_id: currentDraftId,
        customer_name: document.getElementById('custName').value,
        customer_phone: document.getElementById('custPhone').value,
        payment_method: document.getElementById('payMethod').value
      };
    } else {
      // Regular checkout
      payload = {
        branch_code: '{{ branch_code }}',
        table_no: {{ table_no }},
        items: items.map(x => ({ meal_id: x.meal_id, qty: x.qty })),
        customer_name: document.getElementById('custName').value,
        customer_phone: document.getElementById('custPhone').value,
        discount_pct: parseFloat(document.getElementById('discountPct').value || '0'),
        tax_pct: parseFloat(document.getElementById('taxPct').value || '0'),
        payment_method: document.getElementById('payMethod').value
      };
    }

    // Send request to appropriate endpoint
    let endpoint = currentDraftId ? '/api/draft/checkout' : '/api/sales/checkout';
    var __meta = document.querySelector('meta[name="csrf-token"]');
    var __hidden = document.getElementById('csrfTokenPage');
    var token = (__meta ? __meta.content : '') || (__hidden ? __hidden.value : '');
    const headers = { 'Content-Type': 'application/json' };
    if(token){ headers['X-CSRFToken'] = token; }
    let data;
    try{
      const res = await fetch(endpoint, {
        method: 'POST', headers, credentials:'same-origin', body: JSON.stringify(payload)
      });
      if(!res.ok){
        const txt = await res.text();
        await showAlert(txt || ('HTTP '+res.status));
        return;
      }
      data = await res.json().catch(()=>null);
    }catch(e){ await showAlert('Network error'); return; }
    if(!data){ await showAlert('Error'); return; }
    const ok = (data.ok === true) || (data.status === 'success');
    if(!ok){ await showAlert((data && data.error) || 'Error'); return; }
    // Ensure any modal leftovers are removed
    document.body.classList.remove('modal-open');
    document.querySelectorAll('.modal-backdrop').forEach(b=>b.remove());
    if(data.print_url){ window.open(data.print_url, '_blank'); } else { alert('Invoice created (test echo).'); }
  }

  async function voidInvoice(){
    if(items.length === 0){
      await showAlert('{{ _('Invoice is already empty / Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©') }}');
      return;
    }
    const pwd = await showPrompt("{{ _('Enter void password / Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¥Ù„ØºØ§Ø¡') }}");
    if(pwd === null) return; // cancelled prompt
    if(!pwd || pwd.trim().length===0){
      await showAlert("{{ _('Password required / ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø©') }}");
      return;
    }
    try{
      const token = document.querySelector('meta[name="csrf-token"]')?.content || document.getElementById('csrfTokenPage')?.value;
      const headers = { 'Content-Type':'application/json' };
      if(token){ headers['X-CSRFToken'] = token; }
      const resp = await fetch('{{ url_for('api_sales_void_check') }}', {
        method:'POST', headers, credentials:'same-origin',
        body: JSON.stringify({ password: pwd })
      });
      const data = await resp.json().catch(()=>({ok:false,error:'Invalid response'}));
      if(!resp.ok || !data.ok){
        await showAlert(data.error || '{{ _('Wrong password / ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©') }}');
        return;
      }
      // Clear invoice items and totals

      items.length = 0;
      renderItems();
      await showAlert('{{ _('Invoice cancelled / ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©') }}');
    }catch(e){ await showAlert('Error'); }
  }

  // Initialize the page
  document.addEventListener('DOMContentLoaded', function() {
    renderItems(); // Show any loaded draft items

    // Auto-save when customer info changes
    const custName = document.getElementById('custName');
    const custPhone = document.getElementById('custPhone');
    const payMethod = document.getElementById('payMethod');

    if (custName) custName.addEventListener('blur', saveDraftOrder);
    if (custPhone) custPhone.addEventListener('blur', saveDraftOrder);
    if (payMethod) payMethod.addEventListener('change', saveDraftOrder);
  });
</script>
{% endblock %}

