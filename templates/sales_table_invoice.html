{% extends 'base.html' %}
{% block title %}Sales - Table #{{ table_number }} — {{ branch_label }}{% endblock %}
{% block content %}
<style>
  .split { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .cat-card { cursor: pointer; transition: transform .1s ease; }
  .cat-card:hover { transform: translateY(-2px); }
  .meal-card { cursor: pointer; }
  @media (max-width: 992px) { .split { grid-template-columns: 1fr; } }
</style>
<style>
  /* Print only the injected invoice container */
  @media print {
    body * { visibility: hidden !important; }
    #invoice, #invoice * { visibility: visible !important; }
    #invoice { position: absolute; left: 0; top: 0; width: 100%; }
  }
</style>

{% set back_url = url_for('main.sales_tables', branch_code=branch_code) %}

<div class="container-fluid py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="mb-0">Table #{{ table_number }} — {{ branch_label }}</h4>
      <small class="text-muted">Select category then meal to add to invoice</small>
    </div>
    <div>
      <a class="btn btn-outline-secondary" href="{{ back_url }}">← Back to Tables</a>
    </div>
  </div>

  <div id="invoice" style="display:none;"></div>

  <div class="split">
    <!-- Right: Categories and Meals -->
    <div>
      <div class="mb-2">
        <h5 class="mb-2">Main Categories</h5>
        <div class="row g-2">
          {% for c in categories %}
          <div class="col-6 col-md-4 col-lg-3">
            <div class="card cat-card p-2 h-100" data-cat-name="{{ c }}">
              <div class="card-body d-flex align-items-center justify-content-center">
                <div class="fw-bold text-center">{{ c }}</div>
              </div>
            </div>
            <!-- Meals inside category card -->
            <!-- Inline holder removed: using modal approach for cleaner navigation -->


          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Left: Invoice Form -->
    <div>
      <div class="card">
        <div class="card-body">
          <div class="row g-2">
            <input type="hidden" id="csrfTokenPage" value="{{ csrf_token() }}">
            <div class="col-md-6">
              <label class="form-label">Date</label>
              <input id="date" type="date" class="form-control" value="{{ today }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Invoice No.</label>
              <input id="invNo" type="text" class="form-control" placeholder="Auto" readonly>
            </div>
            <div class="col-md-8">
              <label class="form-label">Customer</label>
              <input id="custName" type="text" class="form-control" placeholder="Type name or phone...">
              <div id="custList" class="list-group position-absolute w-50" style="z-index:10; display:none;"></div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Customer Phone</label>
              <input id="custPhone" type="text" class="form-control" placeholder="Auto" readonly>
            </div>
            <div class="col-md-4">
              <label class="form-label">Discount %</label>
              <input id="discountPct" type="number" step="0.01" value="0" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Tax %</label>
              <input id="taxPct" type="number" step="0.01" value="{{ vat_rate }}" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Payment</label>
              <select id="payMethod" class="form-select">
                <option value="">-- اختر طريقة الدفع --</option>
                <option value="CASH">CASH</option>
                <option value="CARD">CARD</option>
              </select>
            </div>
          </div>

          <hr>

          <div>
            <h6 class="mb-2">Items</h6>
            <div id="itemsList" class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>Meal</th>
                    <th class="text-center" style="width:100px;">Qty</th>
                    <th class="text-end" style="width:140px;">Unit</th>
                    <th class="text-end" style="width:140px;">Total</th>
                    <th style="width:50px;"></th>
                  </tr>
                </thead>
                <tbody id="itemsBody"></tbody>
              </table>
            </div>

            <div class="d-flex justify-content-end gap-3">
              <div><strong>Subtotal</strong>: <span id="subtotal">0.00</span> {% if settings and settings.currency_image %}<img src="{{ settings.currency_image }}" width="14" height="14" alt="currency">{% elif settings and settings.currency %} {{ settings.currency }}{% endif %}</div>
              <div><strong>Tax</strong>: <span id="tax">0.00</span> {% if settings and settings.currency_image %}<img src="{{ settings.currency_image }}" width="14" height="14" alt="currency">{% elif settings and settings.currency %} {{ settings.currency }}{% endif %}</div>
              <div><strong>Discount</strong>: <span id="discount">0.00</span> {% if settings and settings.currency_image %}<img src="{{ settings.currency_image }}" width="14" height="14" alt="currency">{% elif settings and settings.currency %} {{ settings.currency }}{% endif %}</div>
              <div><strong>Grand Total</strong>: <span id="grand">0.00</span> {% if settings and settings.currency_image %}<img src="{{ settings.currency_image }}" width="14" height="14" alt="currency">{% elif settings and settings.currency %} {{ settings.currency }}{% endif %}</div>
            </div>
          </div>

          <div class="mt-3 d-flex justify-content-between align-items-center">
            <div class="d-flex gap-2">
              <button id="btnVoidInvoice" class="btn btn-outline-danger">Cancel Invoice</button>
              <button id="btnPrePrint" class="btn btn-outline-primary">Print before Pay</button>
            </div>
            <button id="btnPayPrint" class="btn btn-success">Pay & Print</button>
          </div>
        </div>
      </div>
    </div>

<!-- One global modal placed once per page to avoid multiple instances -->
<div class="modal fade" id="catModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="catModalTitle">Items</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">


        <div id="catEmpty" class="alert alert-info d-none">No items in this category yet</div>
        <div class="row g-2" id="catGrid"></div>
      </div>
    </div>
  </div>
</div>

  </div>
</div>

<div id="pos-init" style="display:none"
     data-branch="{{ branch_code }}"
     data-table="{{ table_number }}"
     data-vat="{{ vat_rate }}"
     data-draft='{{ draft_items|safe }}'
     data-draft-id="{{ current_draft.id if current_draft else '' }}"
     data-cat-map='{{ cat_map_json|safe }}'>
</div>
<script src="{{ url_for('static', filename='js/pos_table.js') }}?v={{ ASSET_VERSION }}"></script>

{% endblock %}

