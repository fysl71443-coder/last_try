{% extends 'base.html' %}
{% block title %}Sales - Table #{{ table_number }} — {{ branch_label }}{% endblock %}
{% block content %}
<style>
  .split { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .cat-card { cursor: pointer; transition: transform .1s ease; }
  .cat-card:hover { transform: translateY(-2px); }
  .meal-card { cursor: pointer; }
  @media (max-width: 992px) { .split { grid-template-columns: 1fr; } }
</style>
<style>
  /* Print only the injected invoice container */
  @media print {
    body * { visibility: hidden !important; }
    #invoice, #invoice * { visibility: visible !important; }
    #invoice { position: absolute; left: 0; top: 0; width: 100%; }
  }
</style>

{% if current_user.is_authenticated %}{% set back_url = url_for('main.sales_tables', branch_code=branch_code) %}{% else %}{% set back_url = '#' %}{% endif %}

{% set currency_src = None %}
{% if settings and settings.currency_image %}
  {% set currency_src = settings.currency_image %}
{% elif settings and settings.currency and (settings.currency.startswith('http') or settings.currency.startswith('/')) %}
  {% set currency_src = settings.currency %}
{% endif %}
<div class="container-fluid py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="mb-0">Table #{{ table_number }} — {{ branch_label }}</h4>
      <small class="text-muted">Select category then meal to add to invoice</small>
    </div>
    <div>
      <a class="btn btn-outline-secondary" href="{{ back_url }}">← Back to Tables</a>
    </div>
  </div>

  <div id="invoice" style="display:none;"></div>

  <div class="split">
    <!-- Right: Categories and Meals -->
    <div>
      <div class="mb-2">
        <h5 class="mb-2">Main Categories</h5>
        <div class="row g-2">
          {% for c in categories %}
          <div class="col-6 col-md-4 col-lg-3">
            <div class="card cat-card p-2 h-100" data-cat-name="{{ c }}">
              <div class="card-body d-flex align-items-center justify-content-center">
                <div class="fw-bold text-center">{{ c }}</div>
              </div>
            </div>
            <!-- Meals inside category card -->
            <!-- Inline holder removed: using modal approach for cleaner navigation -->


          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Left: Invoice Form -->
    <div>
      <div class="card">
        <div class="card-body">
          <div class="row g-2">
            <input type="hidden" id="csrfTokenPage" value="{{ csrf_token() }}">
            <div class="col-md-6">
              <label class="form-label">Date</label>
              <input id="date" type="date" class="form-control" value="{{ today }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Invoice No.</label>
              <input id="invNo" type="text" class="form-control" placeholder="Auto" readonly>
            </div>
            <div class="col-md-8">
              <div class="d-flex align-items-center justify-content-between">
                <label class="form-label mb-0">Customer</label>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="openAddCustomerModalTable()">➕ {{ _('New Customer / عميل جديد') }}</button>
              </div>
              <input id="custName" type="text" class="form-control mt-1" placeholder="Type name or phone...">
              <div id="custList" class="list-group position-absolute w-50" style="z-index:10; display:none;"></div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Customer Phone</label>
              <input id="custPhone" type="text" class="form-control" placeholder="Auto" readonly>
            </div>
            <div class="col-md-4">
              <label class="form-label">Discount %</label>
              <input id="discountPct" type="number" step="0.01" value="0" class="form-control bg-light" readonly title="Auto from customer; editable only for KEETA/HUNGER">
            </div>
            <div class="col-md-4">
              <label class="form-label">Tax %</label>
              <input id="taxPct" type="number" step="0.01" value="{{ vat_rate }}" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Payment</label>
              <select id="payMethod" class="form-select">
                <option value="">-- اختر طريقة الدفع --</option>
                <option value="CASH">CASH</option>
                <option value="BANK">BANK</option>
              </select>
            </div>
          </div>

          <hr>

          <div>
            <h6 class="mb-2">Items</h6>
            <div id="itemsList" class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>Meal</th>
                    <th class="text-center" style="width:100px;">Qty</th>
                    <th class="text-end" style="width:140px;">Unit</th>
                    <th class="text-end" style="width:140px;">Total</th>
                    <th style="width:50px;"></th>
                  </tr>
                </thead>
                <tbody id="itemsBody"></tbody>
              </table>
            </div>
            <div class="trash-target"><i class="bi bi-trash"></i></div>

            <div class="d-flex justify-content-end gap-3">
              <div><strong>Subtotal</strong>: <span id="subtotal">0.00</span> {% if currency_src %}<img src="{{ currency_src }}" width="14" height="14" alt="currency">{% elif settings and settings.currency %} {{ settings.currency }}{% endif %}</div>
              <div><strong>Tax</strong>: <span id="tax">0.00</span> {% if currency_src %}<img src="{{ currency_src }}" width="14" height="14" alt="currency">{% elif settings and settings.currency %} {{ settings.currency }}{% endif %}</div>
              <div><strong>Discount</strong>: <span id="discount">0.00</span> {% if currency_src %}<img src="{{ currency_src }}" width="14" height="14" alt="currency">{% elif settings and settings.currency %} {{ settings.currency }}{% endif %}</div>
              <div><strong>Grand Total</strong>: <span id="grand">0.00</span> {% if currency_src %}<img src="{{ currency_src }}" width="14" height="14" alt="currency">{% elif settings and settings.currency %} {{ settings.currency }}{% endif %}</div>
            </div>
          </div>

          <div class="mt-3 d-flex justify-content-between align-items-center">
            <div class="d-flex gap-2">
              <button id="btnVoidInvoice" class="btn btn-outline-danger">Cancel Invoice</button>
            </div>
            <button id="btnPayPrint" class="btn btn-success">Pay & Print</button>
          </div>
        </div>
      </div>
    </div>

<!-- One global modal placed once per page to avoid multiple instances -->
<div class="modal fade" id="catModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="catModalTitle">Items</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">


        <div id="catEmpty" class="alert alert-info d-none">No items in this category yet</div>
        <div class="row g-2" id="catGrid"></div>
      </div>
    </div>
  </div>
</div>

  </div>
</div>

<div id="pos-init" style="display:none"
     data-branch="{{ branch_code }}"
     data-table="{{ table_number }}"
     data-vat="{{ vat_rate }}"
     data-draft='{{ draft_items|safe }}'
     data-draft-id="{{ current_draft.id if current_draft else '' }}"
     data-cat-map='{{ cat_map_json|safe }}'>
</div>

<!-- Add Customer Modal (Table Invoice) -->
<div class="modal fade" id="addCustomerTableModal" tabindex="-1" aria-labelledby="addCustomerTableModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addCustomerTableModalLabel">{{ _('Add Customer / إضافة عميل') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">{{ _('Name / الاسم') }}</label>
          <input id="tblNewCustName" class="form-control" placeholder="{{ _('Customer name') }}">
        </div>
        <div class="mb-2">
          <label class="form-label">{{ _('Phone / الهاتف') }}</label>
          <input id="tblNewCustPhone" class="form-control" placeholder="{{ _('Phone (optional)') }}">
        </div>
        <div class="mb-2">
          <label class="form-label">{{ _('Discount %% / نسبة الخصم') }}</label>
          <input id="tblNewCustDisc" type="number" min="0" max="100" step="0.01" class="form-control" value="0">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Close / إغلاق') }}</button>
        <button type="button" class="btn btn-primary" onclick="submitNewCustomerTable()">{{ _('Save / حفظ') }}</button>
      </div>
    </div>
  </div>
</div>

<script>
  function openAddCustomerModalTable(){
    try{
      document.getElementById('tblNewCustName').value = '';
      document.getElementById('tblNewCustPhone').value = '';
      document.getElementById('tblNewCustDisc').value = '0';
      const m = new bootstrap.Modal(document.getElementById('addCustomerTableModal'));
      m.show();
    }catch(e){ alert('Cannot open modal'); }
  }
  async function submitNewCustomerTable(){
    const name = (document.getElementById('tblNewCustName').value||'').trim();
    const phone = (document.getElementById('tblNewCustPhone').value||'').trim();
    const discount = parseFloat(document.getElementById('tblNewCustDisc').value||'0')||0;
    if(!name){ alert('Name is required / الاسم مطلوب'); return; }
    try{
      const res = await fetch('{{ url_for('main.api_customers_create') }}', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({name, phone, discount_percent: discount})
      });
      const j = await res.json();
      if(!res.ok || !j || j.ok !== true){ throw new Error((j && j.error) || 'Failed'); }
      const c = j.customer || {};
      // Populate fields on the invoice form
      const nameInput = document.getElementById('custName');
      const phoneInput = document.getElementById('custPhone');
      const discInput = document.getElementById('discountPct');
      if(nameInput) nameInput.value = c.name || name;
      if(phoneInput) phoneInput.value = c.phone || phone || '';
      if(discInput){
        const d = (typeof c.discount_percent !== 'undefined') ? c.discount_percent : discount;
        discInput.value = (parseFloat(d||0) || 0).toString();
      }
      try{ bootstrap.Modal.getInstance(document.getElementById('addCustomerTableModal')).hide(); }catch(_){ }
    }catch(e){ alert(String(e.message||e)); }
  }
</script>

<script src="{{ url_for('static', filename='js/pos_table.js') }}?v={{ ASSET_VERSION }}"></script>

{% endblock %}

