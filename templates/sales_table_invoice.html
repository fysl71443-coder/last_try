{% extends 'base.html' %}
{% block title %}{{ _('Sales - Table / المبيعات - الطاولة') }} #{{ table_no }} — {{ branch_label }}{% endblock %}
{% block content %}
<style>
  .split { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .cat-card { cursor: pointer; transition: transform .1s ease; }
  .cat-card:hover { transform: translateY(-2px); }
  .meal-card { cursor: pointer; }
  @media (max-width: 992px) { .split { grid-template-columns: 1fr; } }
</style>
<div class="container-fluid py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="mb-0">{{ _('Table') }} #{{ table_no }} — {{ branch_label }}</h4>
      <small class="text-muted">{{ _('Select category then meal to add to invoice / اختر القسم ثم الوجبة') }}</small>
    </div>
    <div>
      <a class="btn btn-outline-secondary" href="{{ url_for('sales_tables', branch_code=branch_code) }}">← {{ _('Back to Tables / رجوع للطاولات') }}</a>
    </div>
  </div>

  <div class="split">
    <!-- Right: Categories and Meals -->
    <div>
      <div class="mb-2">
        <h5 class="mb-2">{{ _('Main Categories / الأقسام الرئيسية') }}</h5>
        <div id="categoriesGrid" class="row g-2"></div>
      </div>

      <div>
        <h6 class="mb-2">{{ _('Meals / الوجبات') }}</h6>
        <div id="mealsGrid" class="row g-2"></div>
      </div>

      <!-- Drill-down Panel for Section Items -->
      <div id="sectionPanel" class="card mt-2" style="display:none;">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong id="sectionTitle"></strong>
          <button class="btn btn-sm btn-outline-secondary" onclick="closeSectionPanel()">{{ _('Back / رجوع') }}</button>
        </div>
        <div class="card-body">
          <div id="sectionItemsGrid" class="row g-2"></div>
        </div>
      </div>
    </div>

    <!-- Left: Invoice Form -->
    <div>
      <div class="card">
        <div class="card-body">
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">{{ _('Date / التاريخ') }}</label>
              <input id="date" type="date" class="form-control" value="{{ today }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('Invoice No. / رقم الفاتورة') }}</label>
              <input id="invNo" type="text" class="form-control" placeholder="Auto" readonly>
            </div>
            <div class="col-md-8">
              <label class="form-label">{{ _('Customer / العميل') }}</label>
              <input id="custName" type="text" class="form-control" placeholder="{{ _('Type name or phone...') }}">
              <div id="custList" class="list-group position-absolute w-50" style="z-index:10; display:none;"></div>
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Customer Phone / هاتف العميل') }}</label>
              <input id="custPhone" type="text" class="form-control" placeholder="{{ _('Auto') }}" readonly>
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Discount %% / نسبة الخصم %%') }}</label>
              <input id="discountPct" type="number" step="0.01" value="0" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Tax %% / الضريبة %%') }}</label>
              <input id="taxPct" type="number" step="0.01" value="{{ vat_rate }}" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Payment / طريقة الدفع') }}</label>
              <select id="payMethod" class="form-select">
                <option value="CASH">Cash</option>
                <option value="MADA">MADA</option>
                <option value="VISA">VISA</option>
                <option value="BANK">BANK</option>
              </select>
            </div>
          </div>

          <hr>

          <div>
            <h6 class="mb-2">{{ _('Items / الأصناف') }}</h6>
            <div id="itemsList" class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>{{ _('Meal') }}</th>
                    <th class="text-center" style="width:100px;">{{ _('Qty') }}</th>
                    <th class="text-end" style="width:140px;">{{ _('Unit') }}</th>
                    <th class="text-end" style="width:140px;">{{ _('Total') }}</th>
                    <th style="width:50px;"></th>
                  </tr>
                </thead>
                <tbody id="itemsBody"></tbody>
              </table>
            </div>

            <div class="d-flex justify-content-end gap-3">
              <div><strong>{{ _('Subtotal') }}</strong>: <span id="subtotal">0.00</span></div>
              <div><strong>{{ _('Tax') }}</strong>: <span id="tax">0.00</span></div>
              <div><strong>{{ _('Discount') }}</strong>: <span id="discount">0.00</span></div>
              <div><strong>{{ _('Grand Total') }}</strong>: <span id="grand">0.00</span></div>
            </div>
          </div>

          <div class="mt-3 text-end">
            <button class="btn btn-success" onclick="payAndPrint()">{{ _('Pay & Print / دفع + طباعة') }}</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const meals = {{ meals_json | safe }};
  let currentCategory = null;
  const items = [];
  let custTimer = null;
  const custList = document.getElementById('custList');
  const custName = document.getElementById('custName');
  const custPhone = document.getElementById('custPhone');

  // Load sections for this branch and render main category cards
  async function loadSections(){
    const grid = document.getElementById('categoriesGrid');
    if(!grid) return;
    grid.innerHTML = '';
    try{
      const res = await fetch(`/api/pos/{{ branch_code }}/sections`);
      const sections = await res.json();
      sections.forEach(sec => {
        const col = document.createElement('div');
        col.className = 'col-6 col-md-4 col-lg-3';
        const img = (sec.image_url && sec.image_url.trim()) ? sec.image_url : "{{ url_for('static', filename='img/item-placeholder.svg') }}";
        col.innerHTML = `
          <div class="card cat-card h-100" onclick='openSection(${JSON.stringify({id: 0}).replace("0", "` + "${sec.id}" + "")})'>
            <img src="${img}" class="card-img-top" alt="section" style="height:120px;object-fit:cover;">
            <div class="card-body d-flex align-items-center justify-content-center p-2">
              <div class="fw-bold text-center small">${sec.name}</div>
            </div>
          </div>`;
        // adjust onclick to pass object safely
        col.querySelector('.card').onclick = () => openSection(sec);
        grid.appendChild(col);
      });
    }catch(e){
      grid.innerHTML = `<div class="alert alert-danger">{{ _('Failed to load sections / فشل تحميل الأقسام') }}</div>`;
    }
  }
  document.addEventListener('DOMContentLoaded', loadSections);

  custName.addEventListener('input', () => {
    clearTimeout(custTimer);
    const q = custName.value.trim();
    if(!q){ custList.style.display='none'; return; }
    custTimer = setTimeout(async () => {
      const res = await fetch(`/api/customers/lookup?q=${encodeURIComponent(q)}`);
      const data = await res.json();
      custList.innerHTML = '';
      if(!data.length){ custList.style.display='none'; return; }
      data.forEach(c => {
        const a = document.createElement('a');
        a.href = '#'; a.className = 'list-group-item list-group-item-action';
        a.textContent = `${c.name} (${c.phone||'-'}) — ${c.discount_percent}%`;
        a.onclick = (e)=>{ e.preventDefault(); selectCustomer(c); };
        custList.appendChild(a);
      });
      custList.style.display = 'block';
    }, 250);
  });

  function selectCustomer(c){
    custName.value = c.name;
    custPhone.value = c.phone || '';
    document.getElementById('discountPct').value = (c.discount_percent||0);
    custList.style.display='none';
    renderItems();
  }

  function selectCategory(cat){
    currentCategory = cat;
    const grid = document.getElementById('mealsGrid');
    grid.innerHTML = '';
    const norm = (s) => (s||'').toString().trim().toLowerCase();
    let filtered = meals.filter(m => norm(m.category) === norm(cat));
    if (filtered.length === 0) {
      // Fallback to partial match if exact match yields nothing
      filtered = meals.filter(m => norm(m.category).includes(norm(cat)) || norm(cat).includes(norm(m.category)));
    }
    if (filtered.length === 0) {
      const alert = document.createElement('div');
      alert.className = 'alert alert-warning';
      alert.textContent = '{{ _('No meals under this category / لا توجد وجبات تحت هذا القسم') }}';
      grid.appendChild(alert);
      return;
    }
    filtered.forEach(m => {
      const col = document.createElement('div');
      col.className = 'col-6 col-md-4 col-lg-3';
      col.innerHTML = `
        <div class="card meal-card h-100" onclick="addItem(${m.id})">
          <div class="card-body d-flex flex-column justify-content-between">
            <div class="fw-bold">${m.name}</div>
            <div class="text-muted">{{ _('Price') }}: ${m.price.toFixed(2)}</div>
          </div>
        </div>`;
      grid.appendChild(col);
    });
    grid.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function addItem(mealId){
    const m = meals.find(x => x.id === mealId);
    if(!m) return;
    const existing = items.find(x => x.meal_id === m.id);
    if(existing){ existing.qty += 1; }
    else { items.push({ meal_id: m.id, name: m.name, unit: m.price, qty: 1 }); }
    renderItems();
  }

  function renderItems(){
    const body = document.getElementById('itemsBody');
    body.innerHTML = '';
    let subtotal = 0;
    let tax = 0;
    const taxPct = parseFloat(document.getElementById('taxPct').value || '0');
    const discountPct = parseFloat(document.getElementById('discountPct').value || '0');

    items.forEach((it, idx) => {
      const lineSub = it.unit * it.qty;
      const lineTax = lineSub * (taxPct/100.0);
      subtotal += lineSub; tax += lineTax;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${it.name}</td>
        <td class="text-center"><input type="number" min="1" step="1" value="${it.qty}" class="form-control form-control-sm" onchange="changeQty(${idx}, this.value)"></td>
        <td class="text-end">${it.unit.toFixed(2)}</td>
        <td class="text-end">${(lineSub+lineTax).toFixed(2)}</td>
        <td><button class="btn btn-sm btn-outline-danger" onclick="removeItem(${idx})">×</button></td>`;
      body.appendChild(row);
    });

    const discountVal = (subtotal + tax) * (discountPct/100.0);
    const grand = (subtotal + tax) - discountVal;
    document.getElementById('subtotal').innerText = subtotal.toFixed(2);
    document.getElementById('tax').innerText = tax.toFixed(2);
    document.getElementById('discount').innerText = discountVal.toFixed(2);
    document.getElementById('grand').innerText = grand.toFixed(2);
  }

  function changeQty(idx, v){ items[idx].qty = parseFloat(v||'1'); renderItems(); }
  function removeItem(idx){ items.splice(idx,1); renderItems(); }

  async function payAndPrint(){
    if(items.length === 0){ alert('{{ _('Add at least one item') }}'); return; }
    const payload = {
      branch_code: '{{ branch_code }}',
      table_no: {{ table_no }},
      items: items.map(x => ({ meal_id: x.meal_id, qty: x.qty })),
      customer_name: document.getElementById('custName').value,
      customer_phone: document.getElementById('custPhone').value,
      discount_pct: parseFloat(document.getElementById('discountPct').value || '0'),
      tax_pct: parseFloat(document.getElementById('taxPct').value || '0'),
      payment_method: document.getElementById('payMethod').value
    };
    const res = await fetch('{{ url_for('api_sales_checkout') }}', {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!data.ok){ alert(data.error || 'Error'); return; }
    window.open(data.print_url, '_blank');
  }
</script>
{% endblock %}

