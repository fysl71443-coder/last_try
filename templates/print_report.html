<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ report_title or 'Print Report' }}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    @page { size: A4; margin: 12mm; }
    :root { --fg-muted:#666; --border-strong:#333; }
    @media print {
      body { font-size: 11pt; }
      .no-print { display: none !important; }
      a { text-decoration: none; color: inherit; }
      /* Enforce black text and high-contrast in print */
      body, body * { color: #000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      button, .btn { color: #000 !important; background: none !important; border: 1px solid #000 !important; box-shadow: none !important; }
      tfoot, .totals-row, .grand-total { color: #000 !important; font-weight: bold !important; background: #fff !important; border-color: #000 !important; }
      .table-print th, .table-print td { border-color: #bbb !important; }
      .table-print thead th { background: #fff !important; color:#000 !important; }
      table { page-break-inside: auto; }
      tr { page-break-inside: avoid; page-break-after: auto; }
    }
    .report-title { text-align: center; margin-bottom: 6px; font-weight: 700; letter-spacing: .2px; }
    .muted { color: var(--fg-muted); font-size: 0.9rem; }
    .report-header { border-bottom: 2px solid var(--border-strong); margin-bottom: 12px; padding-bottom: 8px; }
    .header-card { border: 1px solid #ddd; border-radius: 6px; padding: 10px 12px; background: #fff; }
    .report-logo { height: 50px; max-width: 160px; object-fit: contain; }
    .chip { display: inline-block; padding: 2px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 0.8rem; margin: 2px 6px 0 0; background: #f7f7f7; }
    .monospace-numbers { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .table-print { font-size: 0.95rem; }
    .table-print tfoot tr { border-top: 2px solid #888; }
    .items-grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 6px; }
    .item-card { border: 1px solid #bbb; border-radius: 6px; padding: 6px; background: #fff; }
    .item-name { font-weight: 600; margin-bottom: 4px; }
    .item-meta { font-size: 0.85rem; display: grid; grid-template-columns: repeat(3, auto); gap: 4px 12px; }
  </style>
</head>
<body>

  <div class="container py-3">
    <div class="header-card mb-3">
      <div class="row g-2 align-items-center">
        <div class="col-auto">
          {% if settings and settings.receipt_show_logo and settings.logo_url %}
            <img src="{{ settings.logo_url }}" alt="logo" class="report-logo" />
          {% endif %}
</div>
        <div class="col">
          <div class="h5 mb-1">{{ settings.company_name or 'Company' }}</div>
          <div class="small text-muted">VAT: {{ settings.tax_number or '-' }}{% if settings.address %} | {{ settings.address }}{% endif %}</div>
        </div>
        <div class="col-auto text-end">
          <div class="small text-muted">Printed: {{ generated_at or '' }}</div>
        </div>
      </div>
    </div>
    <script>
      document.addEventListener('click', function(e){
        var btn = e.target.closest('[data-target]');
        if(!btn) return;
        var sel = btn.getAttribute('data-target');
        var el = document.querySelector(sel);
        if(!el) return;
        el.style.display = (el.style.display === 'none' || !el.style.display) ? 'block' : 'none';
      });
    </script>

    <div class="report-header">
      <div class="d-flex justify-content-between align-items-center">
        <h4 class="report-title mb-0">{{ report_title }}</h4>
        <button class="btn btn-sm btn-outline-secondary no-print" onclick="window.print()">Print</button>
      </div>
      <div class="mt-1">
        {% if start_date or end_date %}<span class="chip">Range: {{ start_date or 'All' }} â†’ {{ end_date or 'All' }}</span>{% endif %}
        {% if payment_method %}<span class="chip">PM: {{ payment_method|upper }}</span>{% endif %}
        {% if branch %}<span class="chip">Branch: {{ branch }}</span>{% endif %}
      </div>
    </div>

    {% if grouped_invoices %}
    <div class="table-responsive">
      <table class="table table-bordered table-sm align-middle table-print">
        <thead class="table-light">
          <tr>
            <th>Branch</th>
            <th>Date</th>
            <th>Invoice No.</th>
            <th>Items</th>
            <th>Payment</th>
            <th class="text-end">Subtotal</th>
            <th class="text-end">Discount</th>
            <th class="text-end">VAT</th>
            <th class="text-end">Total</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
          {% for inv in grouped_invoices %}
          {% set _id = 'inv_items_' ~ loop.index0 %}
          <tr class="table-secondary">
            <td>{{ inv.branch }}</td>
            <td>{{ inv.date }}</td>
            <td>{{ inv.invoice_number }}</td>
            <td class="text-end monospace-numbers">{{ (inv.item_count or (inv['items']|length)) }}</td>
            <td>{{ inv.payment_method }}</td>
            <td class="text-end monospace-numbers">{{ "%.2f"|format(inv.subtotal) }}</td>
            <td class="text-end monospace-numbers">{{ "%.2f"|format(inv.discount) }}</td>
            <td class="text-end monospace-numbers">{{ "%.2f"|format(inv.vat) }}</td>
            <td class="text-end monospace-numbers">{{ "%.2f"|format(inv.total) }}</td>
            <td><button type="button" class="btn btn-sm btn-link p-0" data-target="#{{ _id }}">ðŸ”½</button></td>
          </tr>
          <tr class="table-row-details">
            <td colspan="10">
              <div id="{{ _id }}" style="display:none;">
                <div class="items-grid">
                  {% for it in inv['items'] %}
                  <div class="item-card">
                    <div class="item-name">{{ it.item_name }}</div>
                    <div class="item-meta">
                      <div>Qty: <span class="monospace-numbers">{{ "%.2f"|format(it.quantity) }}</span></div>
                      <div>Amt: <span class="monospace-numbers">{{ "%.2f"|format(it.amount) }}</span></div>
                      {% if it.discount and it.discount > 0 %}<div>Disc: <span class="monospace-numbers">{{ "%.2f"|format(it.discount) }}</span></div>{% endif %}
                      <div>VAT: <span class="monospace-numbers">{{ "%.2f"|format(it.vat) }}</span></div>
                      <div>Total: <span class="monospace-numbers">{{ "%.2f"|format(it.total) }}</span></div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="table-responsive">
      <table class="table table-bordered table-striped table-sm align-middle table-print">
        <thead class="table-light">
          <tr>
            {% for col in columns %}
              <th>{{ col }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in data %}
          <tr>
            {% for col in columns %}
              {% if row[col] is number %}
                {% set _cname = (col|string).lower() %}
                {% set _is_money = _cname in ['amount','discount','vat','total','line total'] %}
                <td class="text-end monospace-numbers">{{ "%.2f"|format(row[col]) }}</td>
              {% else %}
                <td>{{ row[col] }}</td>
              {% endif %}
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
        {% if totals and totals_columns %}
        <tfoot>
          <tr class="table-secondary fw-bold">
            <td colspan="{{ totals_colspan or 1 }}" class="text-end">Totals:</td>
            {% for col in totals_columns %}
              <td>{{ "%.2f"|format(totals[col] or 0) }}</td>
            {% endfor %}
          </tr>
        </tfoot>
        {% endif %}
      </table>
    </div>
    {% endif %}

    {% if item_totals %}
    <div class="mt-3">
      <h6>{{ item_totals_title or 'Item Totals' }}</h6>
      <table class="table table-sm table-bordered w-auto table-print">
        <thead class="table-light"><tr><th>{{ item_totals_name_label or 'Item' }}</th><th class="text-end">{{ item_totals_value_label or 'Qty' }}</th></tr></thead>
        <tbody>
          {% for name, qty in item_totals|dictsort %}
          <tr><td>{{ name }}</td><td class="text-end monospace-numbers">{{ '%.2f'|format(qty) }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

	    {% if payment_totals %}
	    <div class="mt-3">
	      <h6>Payment Method Totals</h6>
	      <table class="table table-sm table-bordered w-auto table-print">
	        <thead class="table-light"><tr><th>Method</th><th class="text-end">Total</th></tr></thead>
	        <tbody>
	          {% for pm, val in payment_totals|dictsort %}
	          <tr><td>{{ pm }}</td><td class="text-end monospace-numbers">{{ '%.2f'|format(val) }}</td></tr>
	          {% endfor %}
	        </tbody>
	      </table>
	    </div>
	    {% endif %}

    {% if branch_totals %}
    <div class="mt-3">
      <h6>Branch Totals</h6>
      <table class="table table-sm table-bordered w-auto table-print">
        <thead class="table-light"><tr><th>Branch</th><th class="text-end">Amount</th><th class="text-end">Discount</th><th class="text-end">VAT</th><th class="text-end">Total</th></tr></thead>
        <tbody>
          {% for br, t in branch_totals|dictsort %}
          <tr>
            <td>{{ br }}</td>
            <td class="text-end monospace-numbers">{{ '%.2f'|format(t.amount) }}</td>
            <td class="text-end monospace-numbers">{{ '%.2f'|format(t.discount) }}</td>
            <td class="text-end monospace-numbers">{{ '%.2f'|format(t.vat) }}</td>
            <td class="text-end monospace-numbers">{{ '%.2f'|format(t.total) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

    {% if overall %}
    <div class="mt-3">
      <h6>Grand Totals</h6>
      <table class="table table-sm table-bordered w-auto table-print">
        <thead class="table-light"><tr><th class="text-end">Amount</th><th class="text-end">Discount</th><th class="text-end">VAT</th><th class="text-end">Total</th></tr></thead>
        <tbody>
          <tr>
            <td class="text-end monospace-numbers">{{ '%.2f'|format(overall.amount or 0) }}</td>
            <td class="text-end monospace-numbers">{{ '%.2f'|format(overall.discount or 0) }}</td>
            <td class="text-end monospace-numbers">{{ '%.2f'|format(overall.vat or 0) }}</td>
            <td class="text-end monospace-numbers">{{ '%.2f'|format(overall.total or 0) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    {% endif %}

  </div>

  <script>
    (function(){
      function autoPrint(){ setTimeout(function(){ try{ window.print(); }catch(e){} }, 300); }
      window.addEventListener('load', autoPrint);
      window.onafterprint = function(){ try{ window.close(); }catch(e){} };
    })();
  </script>
</body>
</html>

