{% extends 'base.html' %}
{% block title %}{{ _('Menu Management') }}{% endblock %}
{% block content %}
<div class="container py-4 ops-layout hub-wrap">
  <div class="ops-header-bar">
    <span class="ops-icon"><i class="fa-solid fa-utensils"></i></span>
    <div>
      <h1 class="ops-title mb-0">{{ _('Menu') }}</h1>
      <span class="ops-subtitle">{{ _('Manage menu sections and items') }}</span>
    </div>
    <div class="ops-actions d-flex flex-wrap gap-2" data-partial-links>
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('main.dashboard') }}"><i class="fa-solid fa-house me-1"></i>{{ _('Dashboard') }}</a>
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('sales.pos_home', branch_code='place_india') }}"><i class="fa-solid fa-cash-register me-1"></i>{{ _('POS') }}</a>
    </div>
  </div>

  <style>
    .sec-tabs{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:12px}
    .sec-tab{position:relative;display:flex;align-items:center;justify-content:center;aspect-ratio:1/1;border:2px solid transparent;border-radius:14px;background:#f0f2f5;font-weight:700;font-size:14px;cursor:pointer;transition:transform .1s, border-color .1s;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.6)}
    .sec-tab:hover{transform:scale(1.01)}
    .sec-badge{position:absolute;top:6px;right:6px;background:#0d6efd;color:#fff;border-radius:999px;font-size:12px;line-height:1;padding:4px 7px}
    .meal-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .meal{border:1px solid #eee;border-radius:14px;padding:12px;background:#fafafa}
    .meal .thumb{aspect-ratio:4/3;background:#e9ecef;border-radius:10px;background-size:cover;background-position:center;margin-bottom:8px}
  </style>

  <div class="ops-form-card mt-0 mb-3">
    <div class="ops-form-head">{{ _('Menu sections') }}</div>
    <div class="ops-form-body">
    <div class="sec-tabs">
      {% for s in sections %}
        <a class="sec-tab {% if current_section and s.id==current_section.id %}active{% endif %}"
           href="{{ url_for('main.menu', cat_id=s.id) }}">
          <div style="position:absolute;inset:0;background:linear-gradient(0deg,rgba(0,0,0,.55),rgba(0,0,0,.05)); border-radius:14px"></div>
          <span style="position:relative;z-index:1">{{ s.name }}</span>
          <span class="sec-badge">{{ item_counts.get(s.id, 0) }}</span>
        </a>
      {% endfor %}
    </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-5">
      <div class="screen-section">
        <div class="screen-section-title">{{ _('Add') }}</div>
        <div class="screen-section-body">
        <h6 class="mb-2">{{ _('Add Section') }}</h6>
        <form method="post" action="{{ url_for('main.menu_category_add') }}" class="row g-2">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <div class="col-md-8">
            <input type="text" name="name" class="form-control form-control-sm" placeholder="{{ _('Name') }}" required/>
          </div>
          <div class="col-md-4">
            <input type="number" name="display_order" class="form-control form-control-sm" placeholder="{{ _('# (order)') }}"/>
          </div>
          <div class="col-12 d-flex gap-2">
            <button class="btn btn-xs btn-success" style="padding:4px 8px; font-size:12px">{{ _('Add') }}</button>
            <a class="btn btn-xs btn-outline-secondary" style="padding:4px 8px; font-size:12px" href="{{ url_for('main.menu') }}">{{ _('All sections') }}</a>
          </div>
        </form>

        <hr class="my-3"/>
        <h6 class="mb-2">{{ _('Delete Section') }}</h6>
        <form id="deleteSectionForm" method="post" onsubmit="return handleDeleteSection(event)" class="row g-2 align-items-end">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <div class="col-md-8">
            <select id="deleteSectionSelect" class="form-select form-select-sm">
              <option value="">-- {{ _('Choose section to delete') }} --</option>
              {% for s in sections %}
                <option value="{{ s.id }}" {% if current_section and s.id==current_section.id %}selected{% endif %}>{{ s.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4 d-grid">
            <button class="btn btn-xs btn-outline-danger" style="padding:4px 8px; font-size:12px">{{ _('Delete section') }}</button>
          </div>
        </form>
        </div>
      </div>
    </div>

    <div class="col-lg-7">
      <div class="ops-form-card">
        <div class="ops-form-head">{{ _('Section Items') }}</div>
        <div class="ops-form-body">
        <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
          {% if current_section %}<div class="small text-muted">{{ _('Current Section') }}: <strong>{{ current_section.name }}</strong></div>{% endif %}
          {% if current_section %}<button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#importMealsModal"><i class="fa-solid fa-file-import me-1"></i>{{ _('Import Meals (Excel)') }}</button>{% endif %}
        </div>

        {% if current_section %}
        <div class="mb-3 p-3 border rounded bg-light">
          <h6 class="mb-2">{{ _('Add items to section') }}</h6>
          <p class="small text-muted mb-2">{{ _('Select section above, then check the meals to add. Already-in-section items are disabled.') }}</p>
          <form method="post" action="{{ url_for('main.menu_items_bulk_add') }}" id="bulkAddForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="section_id" value="{{ current_section.id }}"/>
            <div class="d-flex gap-2 mb-2 flex-wrap">
              <button type="button" class="btn btn-sm btn-outline-secondary" id="bulkSelectAvailable">{{ _('Select all (available)') }}</button>
              <button type="button" class="btn btn-sm btn-outline-secondary" id="bulkClearSelection">{{ _('Clear selection') }}</button>
              <button type="submit" class="btn btn-sm btn-primary"><i class="fa-solid fa-plus me-1"></i>{{ _('Add selected to section') }}</button>
            </div>
            <div class="border rounded p-2 bg-white" style="max-height:220px; overflow-y: auto;">
              <div class="row g-1 small">
                {% for m in meals or [] %}
                {% set already = (m.id in existing_meal_ids_in_section) if existing_meal_ids_in_section is defined else false %}
                <div class="col-12 col-md-6 col-lg-4">
                  <label class="d-flex align-items-center gap-2 mb-0 py-1 cursor-pointer">
                    <input type="checkbox" name="meal_ids" value="{{ m.id }}" class="form-check-input bulk-meal-cb" {{ 'disabled' if already else '' }} {{ 'data-in-section' if already else '' }}/>
                    <span class="{{ 'text-muted' if already else '' }}">{{ m.name }}{% if m.name_ar %} / {{ m.name_ar }}{% endif %}</span>
                    {% if already %}<span class="badge bg-secondary ms-1">{{ _('في القسم') }}</span>{% endif %}
                  </label>
                </div>
                {% endfor %}
              </div>
            </div>
          </form>
        </div>

        <form method="post" action="{{ url_for('main.menu_item_add') }}" class="row g-2 align-items-end mb-3" id="addItemForm">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <input type="hidden" name="section_id" value="{{ current_section.id }}"/>
          <div class="col-md-5">
            <label class="form-label form-label-sm">{{ _('Meal') }}</label>
            <select name="meal_id" class="form-select form-select-sm" id="mealSelect">
              <option value="">-- {{ _('Choose a meal') }} --</option>
              {% for m in meals or [] %}
                <option value="{{ m.id }}" data-name="{{ m.name }}{% if m.name_ar %} / {{ m.name_ar }}{% endif %}" data-price="{{ '%.2f'|format(m.selling_price or 0) }}">{{ m.name }}{% if m.name_ar %} / {{ m.name_ar }}{% endif %}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label form-label-sm">{{ _('Name') }}</label>
            <input type="text" name="name" class="form-control form-control-sm" placeholder="{{ _('Auto from meal (editable)') }}"/>
          </div>
          <div class="col-md-2">
            <label class="form-label form-label-sm">{{ _('Price') }}</label>
            <input type="number" step="0.01" name="price" class="form-control form-control-sm" placeholder="{{ _('Auto from meal') }}"/>
          </div>
          <div class="col-md-1 d-grid">
            <button class="btn btn-xs btn-primary" style="padding:4px 8px; font-size:12px">{{ _('Add') }}</button>
          </div>
        </form>

        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>#</th>
                <th>{{ _('Item') }}</th>
                <th>{{ _('Price') }}</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for it in items %}
              <tr>
                <td>{{ it.id }}</td>
                <td>
                  <form method="post" action="{{ url_for('main.menu_item_update', item_id=it.id) }}" class="d-flex gap-2">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="text" name="name" value="{{ it.name }}" class="form-control form-control-sm" style="max-width:220px"/>
                    <input type="number" step="0.01" name="price" value="{{ '%.2f'|format(it.price or 0) }}" class="form-control form-control-sm" style="max-width:120px"/>
                    <button class="btn btn-xs btn-outline-primary" style="padding:4px 8px; font-size:12px">{{ _('Save') }}</button>
                  </form>
                </td>
                <td></td>
                <td class="text-nowrap">
                  <form method="post" action="{{ url_for('main.menu_item_delete', item_id=it.id) }}" class="d-inline" onsubmit="return confirmDeleteItem()">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button class="btn btn-xs btn-outline-danger" style="padding:4px 8px; font-size:12px">{{ _('Delete') }}</button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="4" class="text-muted">{{ _('No items') }}</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <div class="text-muted">{{ _('Add a section then select it to manage items') }}</div>
        {% endif %}
      </div>

<script>

  // Auto-fill price (and optionally name if needed) when selecting a meal
  (function(){
    const sel = document.getElementById('mealSelect');
    if(sel){
      sel.addEventListener('change', function(){
        const opt = this.selectedOptions && this.selectedOptions[0];
        if(!opt) return;
        const pr = opt.getAttribute('data-price') || '';
        const nm = opt.getAttribute('data-name') || '';
        const priceInput = document.querySelector('form#addItemForm input[name="price"]');
        const nameInput = document.querySelector('form#addItemForm input[name="name"]');
        if(priceInput && pr){ priceInput.value = pr; }
        if(nameInput && nm){ nameInput.value = nm; }
      });
    }
  })();

  // إضافة أصناف جماعية: تحديد الكل (المتاح فقط) ومسح التحديد
  (function(){
    document.getElementById('bulkSelectAvailable')?.addEventListener('click', function(){
      document.querySelectorAll('#bulkAddForm .bulk-meal-cb:not([disabled])').forEach(function(cb){ cb.checked = true; });
    });
    document.getElementById('bulkClearSelection')?.addEventListener('click', function(){
      document.querySelectorAll('#bulkAddForm .bulk-meal-cb').forEach(function(cb){ cb.checked = false; });
    });
  })();

  // تركيز تلقائي على نموذج إضافة عنصر عند الضغط على "إضافة أصناف" في جدول الأقسام
  (function(){
    const urlParams = new URLSearchParams(window.location.search);
    if((urlParams.get('focus')||'').toLowerCase()==='add_item'){
      const el = document.getElementById('addItemForm');
      if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); el.querySelector('select[name=meal_id]')?.focus(); }
    }
  })();

  // Delete menu item with password protection
  function deleteMenuItem(event, form) {
    event.preventDefault();

    if (!confirm("{{ _('Remove item?') }}")) {
      return false;
    }

    const password = prompt("أدخل كلمة المرور لحذف العنصر (1991):");
    if (!password) {
      return false;
    }

    // Set password in hidden field
    form.querySelector('.password-field').value = password;

    // Submit form
    form.submit();
    return true;
  }

  function confirmDeleteItem(){
    return confirm("{{ _('Remove item?') }}");
  }

  // Delete functions for API calls
  async function deleteOne(itemId) {
    const password = prompt("أدخل كلمة المرور لحذف الصنف (1991):");
    if (!password) return;

    const res = await fetch(`/api/items/${itemId}/delete`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrf()
      },
      body: JSON.stringify({ password })
    });

    const data = await res.json();
    if (!data.ok) {
      alert(data.error === 'invalid_password' ? 'كلمة المرور غير صحيحة' : data.error);
      return;
    }

    alert('تم حذف الصنف بنجاح');
    location.reload();
  }

  function handleDeleteSection(e){
    e.preventDefault();
    const sel = document.getElementById('deleteSectionSelect');
    const val = sel && sel.value ? sel.value.trim() : '';
    if(!val){
      alert("{{ _('Please choose a section') }}");
      return false;
    }
    if(!confirm("{{ _('Delete this section?') }}")){
      return false;
    }
    const form = document.getElementById('deleteSectionForm');
    const base = "{{ url_for('main.menu_category_delete', cat_id=0) }}";
    form.action = base.replace('/0/', `/${val}/`).replace('/0', `/${val}`);
    form.submit();
    return true;
  }


</script>

<!-- Import Meals Modal (Excel/CSV) -->
<div class="modal fade" id="importMealsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{{ url_for('purchases.meals_import') }}" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        {% if current_section %}<input type="hidden" name="cat_id" value="{{ current_section.id }}"/>{% endif %}
        <div class="modal-header">
          <h5 class="modal-title">{{ _('Import Meals') }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">{{ _('Select File') }}</label>
            <input type="file" name="file" class="form-control" accept=".xlsx,.xls,.csv" required>
            <div class="form-text">{{ _('Supported: Excel (.xlsx, .xls), CSV') }}</div>
          </div>
          <div class="alert alert-info">
            <strong>{{ _('Required columns') }}:</strong><br>
            {{ _('Name, Name (Arabic), Selling Price') }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-success">{{ _('Import') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>

  async function deleteAll() {
    const ok = confirm('سيتم حذف جميع الأصناف! هل أنت متأكد؟');
    if (!ok) return;

    const password = prompt('أدخل كلمة المرور لحذف جميع الأصناف (1991):');
    if (!password) return;

    const res = await fetch('/api/items/delete-all', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrf()
      },
      body: JSON.stringify({ password })
    });

    const data = await res.json();
    if (!data.ok) {
      alert(data.error === 'invalid_password' ? 'كلمة المرور غير صحيحة' : data.error);
      return;
    }

    alert(`تم حذف ${data.deleted} صنف بنجاح`);
    location.reload();
  }
</script>
    </div>
  </div>
</div>
{% endblock %}

