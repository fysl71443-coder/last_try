{% extends 'base.html' %}
{% block title %}{{ _('Reports / التقارير') }}{% endblock %}
{% block content %}
<div class="container py-4">
  <h3>{{ _('Reports & Print / التقارير والطباعة') }}</h3>
  <form class="row g-2 align-items-end mb-3" onsubmit="openPrint(); return false;">
    <div class="col-auto">
      <label class="form-label">{{ _('Type / النوع') }}</label>
      <select id="rep-cat" class="form-select">
        <option value="sales">{{ _('Sales / مبيعات') }}</option>
        <option value="purchases">{{ _('Purchases / مشتريات') }}</option>
        <option value="expenses">{{ _('Expenses / مصروفات') }}</option>
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label">{{ _('From Date / من تاريخ') }}</label>
      <input id="sd" type="date" class="form-control" value="{{ request.args.get('start_date','') }}">
    </div>
    <div class="col-auto">
      <label class="form-label">{{ _('To Date / إلى تاريخ') }}</label>
      <input id="ed" type="date" class="form-control" value="{{ request.args.get('end_date','') }}">
    </div>
    <div class="col-auto">
      <label class="form-label">{{ _('Branch / الفرع') }}</label>
      <select id="branch" class="form-select">
        <option value="all">{{ _('All / جميع الفروع') }}</option>
        <option value="china_town">China Town</option>
        <option value="place_india">Place India</option>
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label">{{ _('Payment Method / طريقة الدفع') }}</label>
      <select id="pm" class="form-select">
        <option value="all">{{ _('All / الكل') }}</option>
        <option value="cash">{{ _('Cash / نقدي') }}</option>
        <option value="card">{{ _('Card / بطاقة') }}</option>
        <option value="bank">{{ _('Bank / بنك') }}</option>
        <option value="pending">{{ _('Pending / آجل') }}</option>
      </select>
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary">{{ _('Print / طباعة') }}</button>
      <button type="button" class="btn btn-outline-success" onclick="openCSV()">{{ _('Export CSV / تصدير CSV') }}</button>
      <button type="button" class="btn btn-warning" onclick="openDailySales()">{{ _('Daily Sales CSV / المبيعات اليومية CSV') }}</button>
      <button type="button" class="btn btn-warning" onclick="openDailySalesPDF()">{{ _('Daily Sales PDF / المبيعات اليومية PDF') }}</button>
      <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">{{ _('Back / رجوع') }}</a>
    </div>
  </form>

  <hr/>
  <h5 class="mt-3">{{ _('Customer Sales / مبيعات العملاء') }}</h5>
  <form class="row g-2 align-items-end mb-3" onsubmit="openCustomerSales(); return false;">
    <div class="col-md-4">
      <label class="form-label">{{ _('Customer Groups / مجموعات العملاء') }}</label>
      <select id="cust-groups" class="form-select" multiple>
        <option value="hunger">hunger</option>
        <option value="keeta">keeta</option>
        <option value="noon">noon</option>
      </select>
      <div class="form-text">{{ _('Select one or more groups / اختر مجموعة أو أكثر') }}</div>
    </div>
    <div class="col-auto">
      <label class="form-label">{{ _('From Date / من تاريخ') }}</label>
      <input id="csd" type="date" class="form-control">
    </div>
    <div class="col-auto">
      <label class="form-label">{{ _('To Date / إلى تاريخ') }}</label>
      <input id="ced" type="date" class="form-control">
    </div>
    <div class="col-auto">
      <label class="form-label">{{ _('Branch / الفرع') }}</label>
      <select id="cbranch" class="form-select">
        <option value="all">{{ _('All / جميع الفروع') }}</option>
        <option value="place_india">Place India</option>
        <option value="china_town">China Town</option>
      </select>
    </div>
    <div class="col-auto">
      <button class="btn btn-outline-primary" type="submit">{{ _('Open Report / فتح التقرير') }}</button>
    </div>
  </form>

  <div class="alert alert-info">
    {{ _('Choose the category, date range and payment method, then click Print. A print page will open in a new tab. / اختر النوع وحدد الفترة وطريقة الدفع ثم اضغط طباعة. سيتم فتح صفحة الطباعة في نافذة جديدة.') }}
  </div>
</div>

<script>
function openPrint() {
  const cat = document.getElementById('rep-cat').value;
  const pm = document.getElementById('pm').value || 'all';
  const sd = document.getElementById('sd').value || '';
  const ed = document.getElementById('ed').value || '';
  const br = document.getElementById('branch').value || 'all';
  let path = '/reports/print/all-invoices/sales';
  if (cat === 'purchases') path = '/reports/print/all-invoices/purchases';
  else if (cat === 'expenses') path = '/reports/print/all-invoices/expenses';
  const url = `${path}?payment_method=${encodeURIComponent(pm)}&start_date=${encodeURIComponent(sd)}&end_date=${encodeURIComponent(ed)}&branch=${encodeURIComponent(br)}`;
  window.open(url, '_blank');
}

function openCSV() {
  const cat = document.getElementById('rep-cat').value;
  const pm = document.getElementById('pm').value || 'all';
  const sd = document.getElementById('sd').value || '';
  const ed = document.getElementById('ed').value || '';
  const br = document.getElementById('branch').value || 'all';
  let path = '/reports/print/all-invoices/sales';
  if (cat === 'purchases') path = '/reports/print/all-invoices/purchases';
  else if (cat === 'expenses') path = '/reports/print/all-invoices/expenses';
  const url = `${path}?payment_method=${encodeURIComponent(pm)}&start_date=${encodeURIComponent(sd)}&end_date=${encodeURIComponent(ed)}&branch=${encodeURIComponent(br)}&format=csv`;
  window.open(url, '_blank');
}

function openDailySales(){
  const pm = document.getElementById('pm').value || 'all';
  const br = document.getElementById('branch').value || 'all';
  const url = `/reports/print/daily-sales?payment_method=${encodeURIComponent(pm)}&branch=${encodeURIComponent(br)}&format=csv`;
  window.open(url, '_blank');
}

function openDailySalesPDF(){
  const pm = document.getElementById('pm').value || 'all';
  const br = document.getElementById('branch').value || 'all';
  const url = `/reports/print/daily-sales?payment_method=${encodeURIComponent(pm)}&branch=${encodeURIComponent(br)}&format=pdf`;
  window.open(url, '_blank');
}

function selectedGroups(){
  const sel = document.getElementById('cust-groups');
  return Array.from(sel?.selectedOptions || []).map(o => o.value);
}

function openCustomerSales(){
  const sd = document.getElementById('csd').value || '';
  const ed = document.getElementById('ced').value || '';
  const br = document.getElementById('cbranch').value || 'all';
  const names = selectedGroups();
  const qs = new URLSearchParams({
    start_date: sd,
    end_date: ed,
    branch: br,
  });
  if(names.length > 0){ qs.set('customers', names.join(',')); }
  const url = `/reports/print/customer-sales?${qs.toString()}`;
  window.open(url, '_blank');
}
</script>
{% endblock %}
