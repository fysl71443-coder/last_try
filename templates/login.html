<!DOCTYPE html>
<html lang="{{ get_locale() or 'ar' }}" dir="{{ 'rtl' if (get_locale() or 'ar') == 'ar' else 'ltr' }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <title>{{ _('Login') }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/numex.css') }}?v={{ ASSET_VERSION or '1' }}">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="background">
    <canvas id="snowCanvas"></canvas>
    <div class="lang-switch">
      <a href="?lang=en">EN</a>
      <a href="?lang=ar">AR</a>
    </div>
    <div class="login-container">
      <div class="login-card">
        <p class="company">{{ (settings.company_name if settings and settings.company_name else _('Company')) }}</p>
        <h2>{{ _('Login') }}</h2>
        <p class="subtitle">{{ _('Please sign in') }}</p>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('main.login') }}" novalidate accept-charset="UTF-8" autocomplete="off" id="login-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="input-group">
            <label for="username">{{ _('Username') }}</label>
            <input type="text" id="username" name="username" placeholder="{{ _('Username') }}"
                   value="{{ request.form.get('username', '') }}" required autocomplete="username">
          </div>
          <div class="input-group">
            <label for="password">{{ _('Password') }}</label>
            <input type="password" id="password" name="password" placeholder="{{ _('Password') }}"
                   required autocomplete="current-password">
          </div>
          <div class="login-extra">
            <div class="form-check">
              <input type="checkbox" name="remember" class="form-check-input" id="remember" {% if request.form.get('remember') %}checked{% endif %}>
              <label for="remember" class="form-check-label">{{ _('Remember Me') }}</label>
            </div>
          </div>
          <div class="input-group">
            <label for="otp">{{ _('2FA Code') }} <span style="opacity:0.75">({{ _('اختياري') }})</span></label>
            <input type="text" id="otp" name="otp" placeholder="{{ _('2FA Code') }}" inputmode="numeric" autocomplete="one-time-code">
          </div>
          <button type="submit" class="login-btn">{{ _('Login') }}</button>
        </form>

        <div class="login-links">
          <a href="#">{{ _('Sign Up') }}</a>
          <a href="#">{{ _('Forgot Password?') }}</a>
        </div>
      </div>
    </div>
    <img src="{{ url_for('static', filename='images/snowman.png') }}" alt="{{ _('رجل ثلج') }}" class="snowman"
         onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/snowman.svg') }}';">
  </div>
  <script src="{{ url_for('static', filename='js/login-misbah.js') }}?v={{ ASSET_VERSION or '1' }}"></script>
  <script>
(function () {
  var form = document.getElementById('login-form');
  if (!form) return;
  var msgFill = {{ _("Please fill username and password") | tojson }};
  var msgOtp = {{ _("Invalid OTP format (6 digits)") | tojson }};
  form.addEventListener('submit', function (e) {
    var u = document.getElementById('username');
    var p = document.getElementById('password');
    var o = document.getElementById('otp');
    if (!u || !p || !u.value.trim() || !p.value.trim()) {
      e.preventDefault();
      alert(msgFill);
      return;
    }
    if (o && o.value && !/^\d{6}$/.test(o.value.trim())) {
      e.preventDefault();
      alert(msgOtp);
      return;
    }
  });
})();
  </script>
</body>
</html>
