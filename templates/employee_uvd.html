{% extends 'base.html' %}
{% block title %}Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†{% endblock %}
{% block content %}
<style>
  :root{--p1: var(--primary); --p2:#E67E22; --s1: var(--link); --s2:#64B5F6; --accent: var(--primary); --bg: var(--bg)}
  .uvd-container{padding:16px}
  .topbar{display:flex;align-items:center;gap:12px;justify-content:space-between;background:#fff;border:1px solid #eaeaea;border-radius:16px;padding:12px 16px}
  .topbar .left{display:flex;align-items:center;gap:12px}
  .topbar .brand{display:flex;align-items:center;gap:8px;font-weight:800;color:var(--secondary)}
  .brand-logo{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--p2));color:#fff;box-shadow:0 8px 22px rgba(230,126,34,.25)}
  .brand-logo:hover{filter:saturate(120%)}
  .topbar input[type="search"]{min-width:300px;border:1px solid #ced4da;border-radius:12px;padding:10px;box-shadow:0 6px 14px rgba(0,0,0,.06)}
  .suggest{position:absolute;background:#fff;border:1px solid #eaeaea;border-radius:10px;box-shadow:0 12px 24px rgba(0,0,0,.12);min-width:300px;display:none;overflow:hidden}
  .suggest .item{padding:8px 12px;cursor:pointer}
  .suggest .item:hover{background:#f5f5f5}
  .add-btn{background-color:var(--primary);color:#fff;border:1px solid var(--primary);border-radius:12px;padding:10px 14px;font-weight:700}
  .add-btn:hover{transform:translateY(-1px);box-shadow:0 4px 10px rgba(0,0,0,.08)}
  .sidebar{position:sticky;top:12px;background:#fff;border:1px solid #eaeaea;border-radius:16px;padding:12px;box-shadow:0 10px 26px rgba(0,0,0,.06)}
  .nav-item{padding:10px;border-radius:12px;cursor:pointer;display:flex;align-items:center;gap:8px}
  .nav-item:hover{background:#f6f8ff}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .kpi{position:relative;background:#fff;border:1px solid #eaeaea;border-radius:18px;padding:14px;overflow:hidden;box-shadow:0 14px 34px rgba(0,0,0,.08)}
  .kpi .title{font-size:13px;color:#666}
  .kpi .value{font-size:22px;font-weight:800;color:var(--secondary)}
  .kpi .lottie{position:absolute;right:10px;top:8px;width:48px;height:48px;opacity:.9}
  .spark{height:40px;width:100%}
  .dept-tabs{display:flex;flex-wrap:wrap;gap:8px;margin:16px 0}
  .dept-tab{padding:10px 12px;border:1px solid #eaeaea;border-radius:12px;background:#fff;cursor:pointer;display:flex;align-items:center;gap:6px}
  .dept-tab.active{background:var(--primary);color:#fff;border-color:transparent;box-shadow:0 10px 24px rgba(230,126,34,.25)}
  .badge{background:#fff;color:var(--link);border:1px solid #cfe3ff;border-radius:10px;padding:2px 8px;font-weight:700}
  .panel{display:none}
  .panel.active{display:block}
  table{width:100%;border-collapse:collapse}
  thead th{position:sticky;top:0;background:var(--primary);color:#fff;z-index:1}
  th,td{padding:10px;border:1px solid #eee;text-align:center;white-space:nowrap}
  tbody tr{transition:transform .2s ease, box-shadow .2s ease, background .2s ease}
  tbody tr:hover{background:#f5f5f5;transform:translateY(-1px);box-shadow:0 6px 12px rgba(0,0,0,.06)}
  .ops-btn{position:relative}
  .ops-menu{position:absolute;right:0;top:100%;background:#fff;border:1px solid #eaeaea;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.12);display:none;min-width:180px;z-index:1000}
  .ops-fly{position:fixed;background:#fff;border:1px solid #eaeaea;border-radius:10px;box-shadow:0 12px 28px rgba(0,0,0,.18);min-width:180px;z-index:2000}
  .ops-menu .it{padding:8px 12px;cursor:pointer}
  .ops-menu .it:hover{background:#f6fbff}
  .ripple-btn{position:relative;overflow:hidden}
  .slideover{position:fixed;top:0;right:-520px;width:480px;height:100vh;background:#fff;border-left:1px solid #eee;box-shadow:-8px 0 20px rgba(0,0,0,.1);z-index:1000;display:flex;flex-direction:column}
  .slideover-header{padding:18px 16px;font-weight:800;background:#fff;border-bottom:1px solid #eee;color:var(--secondary)}
  .slideover-body{padding:14px;overflow:auto}
  .toast{position:fixed;top:-80px;left:50%;transform:translateX(-50%);background:var(--primary);color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.18);z-index:1100}
</style>

<div class="container-fluid uvd-container">
  <div class="topbar">
    <div class="left">
      <div class="brand"><div class="brand-logo"><i class="fa-solid fa-building"></i></div><span>Logo Restaurant</span></div>
      <strong>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</strong>
    </div>
    <div style="min-width:300px" title="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù">
      <select id="empSelect" class="form-select">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù</option>
        {% for e in employees %}
        <option value="{{ e.id }}">{{ e.full_name }}</option>
        {% endfor %}
      </select>
    </div>
    <a id="btnAddEmp" class="add-btn ripple-btn" href="/employees/create">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</a>
    <div class="right">ğŸ‘¤ Ù…Ø±Ø­Ø¨Ø§Ù‹ {{ current_user.username }}</div>
  </div>

  <div class="mt-3">
      <div class="kpis">
        <div class="kpi">
          <div class="title"><i class="fa-solid fa-users"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
          <div class="value">{{ emp_count }}</div>
          <div class="lottie" id="lottieEmp"></div>
          <canvas class="spark" data-kind="emp"></canvas>
        </div>
        <div class="kpi">
          <div class="title"><i class="fa-solid fa-money-bill"></i> Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</div>
          <div class="value">{{ '%.2f'|format(sal_sum) }}</div>
          <div class="lottie" id="lottieSal"></div>
          <canvas class="spark" data-kind="sal"></canvas>
        </div>
        <div class="kpi">
          <div class="title"><i class="fa-solid fa-credit-card"></i> Ø§Ù„Ø³Ù„Ù Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</div>
          <div class="value">{{ '%.2f'|format(adv_out) }}</div>
          <div class="lottie" id="lottieAdv"></div>
          <canvas class="spark" data-kind="adv"></canvas>
        </div>
        <div class="kpi">
          <div class="title"><i class="fa-solid fa-calendar-day"></i> Ø¢Ø®Ø± ØµØ±Ù</div>
          <div class="value">{{ (last_pay_dt.strftime('%d/%m/%Y') if last_pay_dt else 'â€”') }}</div>
          <div class="lottie" id="lottiePay"></div>
          <canvas class="spark" data-kind="pay"></canvas>
        </div>
        <div class="kpi">
          <div class="title"><i class="fa-solid fa-bell"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
          <div class="value">{{ je_cnt }}</div>
          <canvas class="spark" data-kind="je"></canvas>
        </div>
      </div>

      <div class="dept-tabs" id="quick-nav" style="margin-top:8px">
        <a class="dept-tab" href="/employee-uvd">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</a>
        <a class="dept-tab" href="/payroll/previous">Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</a>
        <a class="dept-tab" href="/advances">Ø§Ù„Ø³Ù„Ù</a>
        <a class="dept-tab" href="/ledger">ÙƒØ´ÙˆÙ Ø§Ù„Ø­Ø³Ø§Ø¨</a>
        <a class="dept-tab" href="/reports/monthly">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</a>
      </div>

      <div class="dept-tabs">
        <div class="dept-tab active" data-dept="all">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… <span class="badge">{{ emp_count }}</span></div>
        {% for k,v in dept_counts.items() %}
        <div class="dept-tab" data-dept="{{ k }}">{{ k }} <span class="badge">{{ v }}</span></div>
        {% endfor %}
      </div>

      <div id="panel-employees" class="panel active">
        <div class="d-flex align-items-center gap-2 mb-2">
          <label class="form-label mb-0">ØªØ±ØªÙŠØ¨</label>
          <select id="empSort" class="form-select" style="width:200px">
            <option value="name">Ø§Ù„Ø§Ø³Ù…</option>
            <option value="basic">Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</option>
            <option value="advance">Ø§Ù„Ø³Ù„Ù</option>
            <option value="last_salary">Ø¢Ø®Ø± Ø±Ø§ØªØ¨</option>
            <option value="status">Ø§Ù„Ø­Ø§Ù„Ø©</option>
          </select>
          <label class="form-label mb-0">Ø¹Ø¯Ø¯ Ù„ÙƒÙ„ ØµÙØ­Ø©</label>
          <select id="empPageSize" class="form-select" style="width:120px">
            <option>10</option>
            <option selected>20</option>
            <option>50</option>
          </select>
        </div>
        <table>
          <thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¯ÙˆØ±</th><th>Ø§Ù„ÙØ±Ø¹</th><th>Ø±Ø§ØªØ¨ Ø£Ø³Ø§Ø³ÙŠ</th><th>Ø³Ù„ÙØ©</th><th>Ø¢Ø®Ø± Ø±Ø§ØªØ¨</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>âš™</th></tr></thead>
          <tbody>
            {% for e in employees %}
            <tr data-row="emp" data-id="{{ e.id }}" data-dept="{{ (e.department or 'other')|lower }}">
              <td>{{ loop.index }}</td>
              <td>{{ e.full_name }}</td>
              <td>{{ e.position or '' }}</td>
              <td>{{ e.branch_code or '' }}</td>
              <td>{{ '%.2f'|format((emp_metrics.get(e.id, {}).get('basic') or 0)) }}</td>
              <td>{{ '%.2f'|format((emp_metrics.get(e.id, {}).get('advance') or 0)) }}</td>
              <td>{{ '%.2f'|format((emp_metrics.get(e.id, {}).get('last_salary') or 0)) }}</td>
              <td>{{ e.status }}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary ops-btn">â‹®</button>
                <div class="ops-menu">
                  <div class="it" data-op="view">Ø¹Ø±Ø¶</div>
                  <div class="it" data-op="edit">ØªØ¹Ø¯ÙŠÙ„</div>
                  <div class="it" data-op="advance">Ø³Ù„ÙØ©</div>
                  <div class="it" data-op="deduct">Ø®ØµÙ…</div>
                  <div class="it" data-op="pay">Ø³Ø¯Ø§Ø¯ Ø±Ø§ØªØ¨</div>
                  <div class="it" data-op="accrual">Ø­Ø³Ø§Ø¨ Ù…Ø³ØªØ­Ù‚</div>
                  <div class="it" data-op="journal">Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚ÙŠØ¯</div>
                  <div class="it text-danger" data-op="delete">Ø­Ø°Ù</div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div id="panel-prev" class="panel" style="display:none">
        <div class="dept-tabs mb-2">
          <button class="dept-tab active" data-dept="all">Ø§Ù„ÙƒÙ„</button>
          <button class="dept-tab" data-dept="kitchen">Ø´ÙŠÙ</button>
          <button class="dept-tab" data-dept="hall">Ø§Ù„ØµØ§Ù„Ø©</button>
          <button class="dept-tab" data-dept="admin">Ø¥Ø¯Ø§Ø±ÙŠ</button>
        </div>
        <table>
          <thead><tr><th>Ø§Ù„Ø³Ù†Ø©</th><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
          <tbody>
            {% for s in prev_salaries %}
            <tr data-row="sal" data-id="{{ s.id }}" data-dept="{{ (s.employee.department if s.employee else '')|lower }}">
              <td>{{ s.year }}</td>
              <td>{{ s.month }}</td>
              <td>{{ s.employee.full_name if s.employee else s.employee_id }}</td>
              <td>{{ '%.2f'|format(s.total_salary or 0) }}</td>
              <td>{{ s.status }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div id="panel-adv" class="panel" style="display:none">
        <div class="dept-tabs mb-2">
          <button class="dept-tab active" data-dept="all">Ø§Ù„ÙƒÙ„</button>
          <button class="dept-tab" data-dept="kitchen">Ø´ÙŠÙ</button>
          <button class="dept-tab" data-dept="hall">Ø§Ù„ØµØ§Ù„Ø©</button>
          <button class="dept-tab" data-dept="admin">Ø¥Ø¯Ø§Ø±ÙŠ</button>
        </div>
        <table>
          <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ù…Ø¯ÙŠÙ†</th><th>Ø¯Ø§Ø¦Ù†</th></tr></thead>
          <tbody>
            {% for a in advances %}
            <tr data-row="adv" data-id="{{ a.id }}" data-emp="{{ a.employee_id }}">
              <td>{{ a.line_date }}</td>
              <td>{{ a.description }}</td>
              <td>{{ '%.2f'|format(a.debit or 0) }}</td>
              <td>{{ '%.2f'|format(a.credit or 0) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div id="panel-ledger" class="panel" style="display:none">
        <table>
          <thead><tr><th>Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
        <tbody>
          {% for j in ledgers %}
          <tr data-row="je" data-id="{{ j.id }}">
            <td>{{ j.entry_number }}</td>
            <td>{{ j.date }}</td>
            <td>{{ j.description }}</td>
            <td>{{ j.status }}</td>
          </tr>
          {% endfor %}
        </tbody>
        </table>
      </div>
      <div id="panel-ext" class="panel" style="height:70vh;border:1px solid #eaeaea;border-radius:16px;overflow:hidden;background:#ffffffd9">
        <iframe id="panelIframe" src="" style="width:100%;height:100%;border:0;"> </iframe>
      </div>
    </div>

  <div id="slideover" class="slideover">
    <div class="slideover-header">ØªÙØ§ØµÙŠÙ„</div>
    <div class="slideover-body" id="slideoverBody"></div>
  </div>
  <div id="toast" class="toast">Ù…Ø±Ø­Ø¨Ø§Ù‹! ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
</div>

<script>
  window.AUTO_OPEN_CREATE = {{ 'true' if auto_open_create else 'false' }};
  function showToast(msg){const t=document.getElementById('toast');t.textContent=msg||t.textContent;if(window.gsap){gsap.to(t,{duration:.4,y:100});setTimeout(()=>gsap.to(t,{duration:.4,y:-100}),5000)}else{t.style.transition='transform .4s ease, opacity .4s';t.style.transform='translateY(100px)';t.style.opacity='1';setTimeout(()=>{t.style.transform='translateY(-100px)';t.style.opacity='0';},5000)}}
  function openSlideover(html){const p=document.getElementById('slideover');document.getElementById('slideoverBody').innerHTML=html;if(window.gsap){gsap.to(p,{duration:.5,x:-520,scale:1,ease:'power2.out'})}else{p.style.transition='transform .5s ease';p.style.transform='translateX(-520px)'}}
  function closeSlideover(){const p=document.getElementById('slideover');if(window.gsap){gsap.to(p,{duration:.4,x:0,ease:'power2.in'})}else{p.style.transition='transform .4s ease';p.style.transform='translateX(0)'}}
  document.addEventListener('click',function(ev){if(ev.target.id==='toast'){closeSlideover()}})
  const empTab = document.querySelector('.nav-item[data-tab="employees"]');
  if(empTab){ empTab.addEventListener('click',()=>{ const k='employees'; document.querySelectorAll('.panel').forEach(p=>{p.classList.toggle('active',p.id==='panel-'+k)}); if(window.gsap){ gsap.fromTo('#panel-'+k,{opacity:0,y:16},{opacity:1,y:0,duration:.3}); } else { const el=document.querySelector('#panel-'+k); if(el){ el.style.opacity='0'; el.style.transform='translateY(16px)'; setTimeout(()=>{ el.style.transition='all .3s ease'; el.style.opacity='1'; el.style.transform='translateY(0)'; }, 0); } } }); }
  
  document.querySelectorAll('.dept-tab').forEach(b=>{b.addEventListener('click',()=>{document.querySelectorAll('.dept-tab').forEach(bb=>bb.classList.remove('active'));b.classList.add('active');const dept=b.dataset.dept;document.querySelectorAll('tbody tr[data-row="emp"]').forEach(tr=>{const d=tr.dataset.dept||'other';tr.style.display=(dept==='all'||dept===d)?'':'none'})})})
  ;(function(){ const last = localStorage.getItem('uvd_dept'); if(last){ const btn = Array.from(document.querySelectorAll('.dept-tab')).find(el=>el.dataset.dept===last); if(btn){ btn.click(); } } document.querySelectorAll('.dept-tab').forEach(el=> el.addEventListener('click', ()=>{ try{ localStorage.setItem('uvd_dept', el.dataset.dept||'all'); }catch(e){} })); })()
  ;(function(){ const map={}; try{ {% for e in employees %} map['{{ e.id }}']='{{ (e.department or '')|lower }}'; {% endfor %} }catch(err){} document.querySelectorAll('#panel-prev .dept-tab').forEach(b=>{ b.addEventListener('click', function(){ document.querySelectorAll('#panel-prev .dept-tab').forEach(x=>x.classList.remove('active')); this.classList.add('active'); const d=this.getAttribute('data-dept')||'all'; document.querySelectorAll('#panel-prev tbody tr[data-row="sal"]').forEach(tr=>{ const dd=(tr.getAttribute('data-dept')||''); const ok = d==='all' || (d==='kitchen'&&/kitchen|chef|Ø´ÙŠÙ/i.test(dd)) || (d==='hall'&&/hall|floor|wait|ØµØ§Ù„Ø©|Ø§Ù„ØµØ§Ù„Ø©/i.test(dd)) || (d==='admin'&&/admin|Ø¥Ø¯Ø§Ø±ÙŠ/i.test(dd)); tr.style.display = ok? '' : 'none'; }); }); }); document.querySelectorAll('#panel-adv .dept-tab').forEach(b=>{ b.addEventListener('click', function(){ document.querySelectorAll('#panel-adv .dept-tab').forEach(x=>x.classList.remove('active')); this.classList.add('active'); const d=this.getAttribute('data-dept')||'all'; document.querySelectorAll('#panel-adv tbody tr[data-row="adv"]').forEach(tr=>{ const emp=(tr.getAttribute('data-emp')||''); const dd=map[emp]||''; const ok = d==='all' || (d==='kitchen'&&/kitchen|chef|Ø´ÙŠÙ/i.test(dd)) || (d==='hall'&&/hall|floor|wait|ØµØ§Ù„Ø©|Ø§Ù„ØµØ§Ù„Ø©/i.test(dd)) || (d==='admin'&&/admin|Ø¥Ø¯Ø§Ø±ÙŠ/i.test(dd)); tr.style.display = ok? '' : 'none'; }); }); }); })()
  document.querySelectorAll('tbody tr').forEach(r=>{r.addEventListener('click',()=>{const cells=[...r.children].map(td=>td.textContent);openSlideover('<div>'+cells.join(' | ')+'</div>')})})
  ;(function(){
    function hideOps(){ document.querySelectorAll('.ops-fly').forEach(m=> m.remove()); document.querySelectorAll('.ops-menu').forEach(m=> m.style.display='none'); }
    document.addEventListener('click', function(e){ if(!e.target.closest('.ops-btn') && !e.target.closest('.ops-fly')){ hideOps(); } });
    document.querySelectorAll('.ops-btn').forEach(btn=>{
      btn.addEventListener('click', function(ev){ ev.stopPropagation(); hideOps(); const cell = this.parentElement; const row = this.closest('tr'); const id = row?.getAttribute('data-id')||''; const orig = cell.querySelector('.ops-menu'); if(!orig) return; const fly = orig.cloneNode(true); fly.classList.remove('ops-menu'); fly.classList.add('ops-fly'); fly.style.display='block'; fly.dataset.empId = id; document.body.appendChild(fly); const r = this.getBoundingClientRect(); const w = fly.offsetWidth; const h = fly.offsetHeight; let top = r.bottom + 6; let left = r.right - w; if(top + h > window.innerHeight) top = r.top - h - 6; if(left < 6) left = 6; fly.style.top = (top)+'px'; fly.style.left = (left)+'px'; fly.querySelectorAll('.it').forEach(it=>{
        it.addEventListener('click', function(ev2){ ev2.stopPropagation(); const op = this.getAttribute('data-op'); const rid = fly.dataset.empId; const tr = document.querySelector('tr[data-id="'+rid+'"]'); hideOps(); if(!tr) return; switch(op){
        case 'edit':
          (function(){ const cells=[...tr.children].map(td=>td.textContent); const html=`<form id='editEmpForm' class='d-grid gap-2'>
            <div class='input-group'><span class='input-group-text'>Ø§Ù„Ø§Ø³Ù…</span><input name='full_name' class='form-control' value='${cells[1]||''}' required></div>
            <div class='input-group'><span class='input-group-text'>Ø§Ù„ÙˆØ¸ÙŠÙØ©</span><input name='position' class='form-control' value='${cells[2]||''}'></div>
            <div class='input-group'><span class='input-group-text'>Ø§Ù„ÙØ±Ø¹</span><input name='branch_code' class='form-control' value='${cells[3]||''}'></div>
            <div class='input-group'><span class='input-group-text'>Ø±Ø§ØªØ¨ Ø£Ø³Ø§Ø³ÙŠ</span><input name='base_salary' type='number' step='0.01' class='form-control' value='${parseFloat(cells[4]||'0')}'></div>
            <div class='input-group'><span class='input-group-text'>Ù†ÙˆØ¹ Ø§Ù„Ø±Ø§ØªØ¨</span><select name='salary_type' class='form-select'><option value='fixed'>Ø«Ø§Ø¨Øª</option><option value='hourly'>Ø¨Ø§Ù„Ø³Ø§Ø¹Ø©</option></select></div>
            <div class='input-group'><span class='input-group-text'>Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø©</span><input name='hourly_rate' type='number' step='0.01' class='form-control' value=''></div>
            <div class='d-flex gap-2 mt-2'><button class='btn btn-primary' type='submit'>ğŸ’¾ Ø­ÙØ¸</button><button type='button' class='btn btn-outline-secondary' id='cancelEdit'>Ø¥Ù„ØºØ§Ø¡</button></div>
          </form>`; openSlideover(html); const f=document.getElementById('editEmpForm'); document.getElementById('cancelEdit').onclick=closeSlideover; f.onsubmit=async function(e){ e.preventDefault(); const fd=new FormData(f); fd.append('csrf_token', '{{ csrf_token() }}'); const r=await fetch('/api/employees/'+id, { method:'PUT', body:fd }); const j=await r.json(); showToast(j&&j.ok?'ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„':'ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); if(j&&j.ok){ tr.children[1].textContent = String(fd.get('full_name')||''); tr.children[2].textContent = String(fd.get('position')||''); tr.children[3].textContent = String(fd.get('branch_code')||''); tr.children[4].textContent = Number(fd.get('base_salary')||0).toFixed(2); closeSlideover(); } } })();
          break;
        case 'advance':
          (function(){ const html=`<form id='advForm' class='d-grid gap-2'>
            <div class='input-group'><span class='input-group-text'>Ø§Ù„Ù…Ø¨Ù„Øº</span><input name='amount' type='number' step='0.01' class='form-control' required></div>
            <div class='input-group'><span class='input-group-text'>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</span><select name='method' class='form-select'><option value='cash'>Ù†Ù‚Ø¯ÙŠ</option><option value='bank'>Ø¨Ù†Ùƒ</option><option value='card'>Ø¨Ø·Ø§Ù‚Ø©</option></select></div>
            <div class='input-group'><span class='input-group-text'>Ø§Ù„ØªØ§Ø±ÙŠØ®</span><input name='date' type='date' class='form-control' value='${new Date().toISOString().slice(0,10)}'></div>
            <div class='d-flex gap-2 mt-2'><button class='btn btn-primary' type='submit'>ğŸ’¾ Ø­ÙØ¸</button><button type='button' class='btn btn-outline-secondary' id='cancelAdv'>Ø¥Ù„ØºØ§Ø¡</button></div>
          </form>`; openSlideover(html); const f=document.getElementById('advForm'); document.getElementById('cancelAdv').onclick=closeSlideover; f.onsubmit=async function(e){ e.preventDefault(); const fd=new FormData(f); fd.append('employee_id', id); fd.append('csrf_token', '{{ csrf_token() }}'); const r=await fetch('/api/advances', { method:'POST', body:fd }); const j=await r.json(); showToast(j&&j.ok?'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ù„ÙØ©':'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ù„ÙØ©'); if(j&&j.ok){ closeSlideover(); } } })();
          break;
        case 'pay':
          (function(){ const iframe=document.getElementById('panelIframe'); document.querySelectorAll('.panel').forEach(p=> p.classList.remove('active')); const ext=document.getElementById('panel-ext'); ext.classList.add('active'); iframe.src='/employees/'+id+'/pay'; showToast('ÙØªØ­ Ø³Ø¯Ø§Ø¯ Ø±Ø§ØªØ¨ Ø§Ù„Ù…ÙˆØ¸Ù'); })();
          break;
        case 'journal':
          (function(){ fetch('/api/employee-ledger?emp_id='+id).then(r=>r.json()).then(j=>{ const rows=(j.rows||[]); let html='<div><h6>Ù‚ÙŠÙˆØ¯ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù</h6><table class="table"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ù…Ø¯ÙŠÙ†</th><th>Ø¯Ø§Ø¦Ù†</th></tr></thead><tbody>'; rows.forEach(x=>{ html+=`<tr><td>${x.date||'-'}</td><td>${x.description||''}</td><td class='text-end'>${Number(x.debit||0).toFixed(2)}</td><td class='text-end'>${Number(x.credit||0).toFixed(2)}</td></tr>`; }); html+='</tbody></table></div>'; openSlideover(html); }).catch(()=> showToast('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯')); })();
          break;
        case 'delete':
          (function(){ if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙØŸ')) return; fetch('/api/employees/'+id, { method:'DELETE', headers: { 'X-CSRFToken': '{{ csrf_token() }}' } }).then(r=> r.json()).then(j=>{ showToast(j&&j.ok?'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù':'ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù'); if(j&&j.ok){ tr.remove(); } }).catch(()=> showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©')); })();
          break;
        }
      });
    });
    document.querySelectorAll('tbody tr').forEach(r=>{ r.addEventListener('click', function(ev){ if(ev.target.closest('button')||ev.target.closest('.ops-menu')) return; const cells=[...r.children].map(td=>td.textContent); openSlideover('<div>'+cells.join(' | ')+'</div>'); }); });
  })();
  ;(function(){ const btn=document.createElement('button'); btn.className='btn btn-outline-primary btn-sm'; btn.textContent='ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù'; const cont=document.querySelector('#panel-ledger'); if(cont){ cont.insertBefore(btn, cont.firstChild); btn.addEventListener('click', function(){ const table=cont.querySelector('table'); if(!table) return; const w=window.open('', '_blank'); w.document.write('<html><head><title>ÙƒØ´Ù Ø­Ø³Ø§Ø¨</title></head><body>'+table.outerHTML+'<script>window.onload=function(){window.print();};<\/script></body></html>'); w.document.close(); }); } })()
  document.querySelectorAll('.ripple-btn').forEach(btn=>{btn.addEventListener('click',e=>{const x=e.offsetX,y=e.offsetY;const s=document.createElement('span');s.style.position='absolute';s.style.left=x+'px';s.style.top=y+'px';s.style.width=s.style.height='8px';s.style.borderRadius='50%';s.style.background='rgba(255,255,255,.7)';btn.appendChild(s); if(window.gsap){ gsap.to(s,{duration:.5,scale:12,opacity:0,onComplete:()=>s.remove()}); } else { s.style.transition='transform .5s ease, opacity .5s ease'; requestAnimationFrame(()=>{ s.style.transform='scale(12)'; s.style.opacity='0'; }); setTimeout(()=>{ try{ s.remove(); }catch(e){} }, 520); } })})
  ;(function(){document.querySelectorAll('.spark').forEach(c=>{const ctx=c.getContext('2d');const w=c.width=c.clientWidth;const h=c.height=c.clientHeight;ctx.clearRect(0,0,w,h);ctx.strokeStyle='#4c7cf5';ctx.lineWidth=2;const pts=Array.from({length:20},(_,i)=>({x:(i/(20-1))*w,y:h-((Math.sin(i*.5)+1)/2)*h*0.8-5}));ctx.beginPath();pts.forEach((p,i)=>{if(i===0)ctx.moveTo(p.x,p.y);else ctx.lineTo(p.x,p.y)});ctx.stroke();ctx.fillStyle='rgba(76,124,245,.12)';ctx.lineTo(w,h);ctx.lineTo(0,h);ctx.closePath();ctx.fill()})})()
  showToast('Ù…Ø±Ø­Ø¨Ø§Ù‹! ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†')
  (function(){
    const sel = document.getElementById('empSelect');
    function apply(){
      const id = sel?.value||'';
      const rows = Array.from(document.querySelectorAll('#panel-employees tbody tr[data-row="emp"]'));
      rows.forEach(tr=>{
        const tid = tr.getAttribute('data-id')||'';
        tr.style.display = (!id || tid===id) ? '' : 'none';
      });
    }
    sel?.addEventListener('change', apply);
  })();
  (function(){
    const sortSel = document.getElementById('empSort');
    const pageSel = document.getElementById('empPageSize');
    function sortRows(){
      const key = (sortSel?.value||'name');
      const tbody = document.querySelector('#panel-employees tbody');
      const rows = Array.from(tbody.querySelectorAll('tr[data-row="emp"]'));
      rows.sort((a,b)=>{
        function val(tr){
          if(key==='name') return (tr.children[1]?.textContent||'').toLowerCase();
          if(key==='status') return (tr.children[7]?.textContent||'').toLowerCase();
          if(key==='basic') return parseFloat(tr.children[4]?.textContent||'0');
          if(key==='advance') return parseFloat(tr.children[5]?.textContent||'0');
          if(key==='last_salary') return parseFloat(tr.children[6]?.textContent||'0');
          return (tr.children[1]?.textContent||'').toLowerCase();
        }
        const va = val(a), vb = val(b);
        if(typeof va==='number' && typeof vb==='number') return vb - va;
        return String(va).localeCompare(String(vb));
      });
      rows.forEach((tr,i)=>{ tr.querySelector('td:first-child').textContent = String(i+1); tbody.appendChild(tr); });
      paginate();
    }
    function paginate(){
      const size = parseInt(pageSel?.value||'20');
      const rows = Array.from(document.querySelectorAll('#panel-employees tbody tr[data-row="emp"]')).filter(tr=> tr.style.display !== 'none');
      rows.forEach((tr,i)=>{ tr.style.display = (i < size) ? (tr.style.display||'') : 'none'; });
    }
    sortSel?.addEventListener('change', sortRows);
    pageSel?.addEventListener('change', paginate);
    sortRows();
  })();
  const slh=document.getElementById('slHeader'); if(slh){ document.addEventListener('mousemove',e=>{const r=slh.getBoundingClientRect();const dx=(e.clientX-(r.left+r.width/2))/r.width;const dy=(e.clientY-(r.top+r.height/2))/r.height; if(window.gsap){ gsap.to(slh,{duration:.2,transform:'translate3d('+dx*6+'px,'+dy*6+'px,0) rotate('+dx*2+'deg)'}); } else { slh.style.transition='transform .2s ease'; slh.style.transform='translate3d('+dx*6+'px,'+dy*6+'px,0) rotate('+dx*2+'deg)'; } }) }
  
  document.querySelectorAll('tbody tr[data-row="emp"] .ops-menu .it').forEach(it=>{
    it.addEventListener('click', async function(ev){ ev.stopPropagation(); const tr=this.closest('tr'); const id=parseInt(tr.getAttribute('data-id')); const op=this.getAttribute('data-op'); if(op==='view'){ const cells=[...tr.children].map(td=>td.textContent); openSlideover('<div>'+cells.join(' | ')+'</div>'); }
    else if(op==='edit'){ const name=tr.children[1].textContent.trim(); const pos=tr.children[2].textContent.trim(); const br=tr.children[3].textContent.trim(); const base=tr.children[4].textContent.trim(); const html=`<form id='empForm' class='d-grid gap-2'>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„Ø§Ø³Ù…</span><input name='full_name' class='form-control' value='${name}' required></div>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„Ù‚Ø³Ù…</span><input name='department' class='form-control' value='${(tr.dataset.dept||'')}'></div>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„ÙˆØ¸ÙŠÙØ©</span><input name='position' class='form-control' value='${pos}'></div>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„ÙØ±Ø¹</span><input name='branch_code' class='form-control' value='${br}'></div>
        <div class='input-group'><span class='input-group-text'>Ø±Ø§ØªØ¨ Ø£Ø³Ø§Ø³ÙŠ</span><input name='base_salary' type='number' step='0.01' class='form-control' value='${base}'></div>
            <div class='d-flex gap-2 mt-2'><button class='btn btn-primary ripple' type='submit'>ğŸ’¾ Ø­ÙØ¸</button><button type='button' class='btn btn-outline-secondary' id='cancelEdit'>Ø¥Ù„ØºØ§Ø¡</button></div>
      </form>`; openSlideover(html); document.getElementById('cancelEdit').onclick=closeSlideover; const f=document.getElementById('empForm'); f.onsubmit=async function(e){ e.preventDefault(); const fd=new FormData(f); fd.append('id', String(id)); const r=await fetch('/api/employees/'+id, { method:'PUT', body:fd }); const j=await r.json(); if(j&&j.ok){ tr.children[1].textContent=fd.get('full_name'); tr.children[2].textContent=fd.get('position'); tr.children[3].textContent=fd.get('branch_code'); tr.children[4].textContent=parseFloat(fd.get('base_salary')||0).toFixed(2); tr.dataset.dept=(fd.get('department')||'').toLowerCase(); showToast('ØªÙ… Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù'); closeSlideover(); } else { showToast('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); } } }
    else if(op==='delete'){ const confirmHtml=`<div class='d-grid gap-2'><div>Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙØŸ</div><div class='d-flex gap-2'><button id='doDel' class='btn btn-danger'>Ù†Ø¹Ù…ØŒ Ø­Ø°Ù</button><button class='btn btn-outline-secondary' id='noDel'>Ø¥Ù„ØºØ§Ø¡</button></div></div>`; openSlideover(confirmHtml); document.getElementById('noDel').onclick=closeSlideover; document.getElementById('doDel').onclick=async function(){ const r=await fetch('/api/employees/'+id, { method:'DELETE' }); const j=await r.json(); if(j&&j.ok){ tr.remove(); showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù'); closeSlideover(); } else { showToast('ØªØ¹Ø°Ø± Ø§Ù„Ø­Ø°Ù'); } } }
    else if(op==='advance'){ const html=`<form id='advForm' class='d-grid gap-2'>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„Ù…Ø¨Ù„Øº</span><input name='amount' type='number' step='0.01' class='form-control' required></div>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„ØªØ§Ø±ÙŠØ®</span><input name='date' type='date' class='form-control' value='${new Date().toISOString().slice(0,10)}'></div>
        <div class='input-group'><span class='input-group-text'>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</span><select name='method' class='form-select'><option value='cash'>Ù†Ù‚Ø¯ÙŠ</option><option value='bank'>Ø¨Ù†Ùƒ</option><option value='card'>Ø¨Ø·Ø§Ù‚Ø©</option></select></div>
            <div class='d-flex gap-2 mt-2'><button class='btn btn-primary ripple' type='submit'>ğŸ’¾ Ø­ÙØ¸</button><button type='button' class='btn btn-outline-secondary' id='cancelAdv'>Ø¥Ù„ØºØ§Ø¡</button></div>
      </form>`; openSlideover(html); document.getElementById('cancelAdv').onclick=closeSlideover; const f=document.getElementById('advForm'); f.onsubmit=async function(e){ e.preventDefault(); const fd=new FormData(f); fd.append('employee_id', String(id)); const r=await fetch('/api/advances', { method:'POST', body:fd }); const j=await r.json(); if(j&&j.ok){ showToast('ØªÙ… Ù…Ù†Ø­ Ø§Ù„Ø³Ù„ÙØ©'); closeSlideover(); } else { showToast('ÙØ´Ù„ Ù…Ù†Ø­ Ø§Ù„Ø³Ù„ÙØ©'); } } }
    else if(op==='deduct'){ const html=`<form id='dedForm' class='d-grid gap-2'>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„Ø´Ù‡Ø±</span><input name='month' type='month' class='form-control' value='${new Date().toISOString().slice(0,7)}'></div>
        <div class='input-group'><span class='input-group-text'>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…</span><input name='deduction_amount' type='number' step='0.01' class='form-control' required></div>
        <div class='d-flex gap-2 mt-2'><button class='btn btn-primary ripple' type='submit'>ğŸ’¾ Ø­ÙØ¸</button><button type='button' class='btn btn-outline-secondary' id='cancelDed'>Ø¥Ù„ØºØ§Ø¡</button></div>
      </form>`; openSlideover(html); document.getElementById('cancelDed').onclick=closeSlideover; const f=document.getElementById('dedForm'); f.onsubmit=async function(e){ e.preventDefault(); const fd=new FormData(f); const month=String(fd.get('month')||''); const amt=parseFloat(String(fd.get('deduction_amount')||'0')); const y=parseInt(month.split('-')[0]||'0'); const m=parseInt(month.split('-')[1]||'0'); const api = new URL('/api/salaries/upsert', location.origin); api.searchParams.set('employee_id', String(id)); api.searchParams.set('month', month); const body=new FormData(); body.append('employee_id', String(id)); body.append('month', month); body.append('deduction_amount', String(amt||0)); body.append('absence_hours', '0'); body.append('overtime_hours', '0'); body.append('bonus_amount', '0'); body.append('csrf_token', '{{ csrf_token() }}'); const r=await fetch('/api/salaries/upsert', { method:'POST', body }); const j=await r.json(); showToast(j&&j.ok?'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®ØµÙ…':'ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®ØµÙ…'); if(j&&j.ok){ closeSlideover(); } }
    }
    else if(op==='pay'){ const html=`<form id='payForm' class='d-grid gap-2'>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„Ø´Ù‡Ø±</span><input name='month' type='month' class='form-control' value='${new Date().toISOString().slice(0,7)}'></div>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</span><input name='paid_amount' type='number' step='0.01' class='form-control' required></div>
        <div class='input-group'><span class='input-group-text'>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</span><select name='payment_method' class='form-select'><option value='cash'>Ù†Ù‚Ø¯ÙŠ</option><option value='bank'>Ø¨Ù†Ùƒ</option><option value='card'>Ø¨Ø·Ø§Ù‚Ø©</option></select></div>
            <div class='d-flex gap-2 mt-2'><button class='btn btn-primary ripple' type='submit'>ğŸ’¾ Ø­ÙØ¸</button><button type='button' class='btn btn-outline-secondary' id='cancelPay'>Ø¥Ù„ØºØ§Ø¡</button></div>
          </form>`; openSlideover(html); document.getElementById('cancelPay').onclick=closeSlideover; const f=document.getElementById('payForm'); f.onsubmit=async function(e){ e.preventDefault(); const fd=new FormData(f); fd.append('employee_id', String(id)); fd.append('csrf_token', '{{ csrf_token() }}'); const r=await fetch('/salaries/pay', { method:'POST', body:fd }); const ok = r.status===200; if(ok){ showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹ Ø§Ù„Ø±Ø§ØªØ¨'); closeSlideover(); } else { showToast('ÙØ´Ù„ Ø¯ÙØ¹ Ø§Ù„Ø±Ø§ØªØ¨'); } } }
    else if(op==='accrual'){ const html=`<form id='accForm' class='d-grid gap-2'>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„Ø´Ù‡Ø±</span><input name='month' type='month' class='form-control' value='${new Date().toISOString().slice(0,7)}'></div>
        <div class='d-flex gap-2 mt-2'><button class='btn btn-primary ripple' type='submit'>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ­Ù‚</button><button type='button' class='btn btn-outline-secondary' id='cancelAcc'>Ø¥Ù„ØºØ§Ø¡</button></div>
      </form>`; openSlideover(html); document.getElementById('cancelAcc').onclick=closeSlideover; const f=document.getElementById('accForm'); f.onsubmit=async function(e){ e.preventDefault(); const fd=new FormData(f); fd.append('employee_id', String(id)); fd.append('csrf_token', '{{ csrf_token() }}'); const r=await fetch('/salaries/accrual', { method:'POST', body:fd }); const j=await r.json(); showToast(j&&j.ok?'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ­Ù‚':'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ­Ù‚'); if(j&&j.ok){ closeSlideover(); } }
    }
    else if(op==='journal'){ const url=new URL('/api/employee-ledger', location.origin); url.searchParams.set('emp_id', String(id)); const r=await fetch(url); const j=await r.json(); if(j&&j.ok){ const rows=(j.rows||[]).map(x=>`<tr><td>${x.date}</td><td>${x.entry}</td><td>${x.desc}</td><td class='text-end'>${Number(x.debit||0).toFixed(2)}</td><td class='text-end'>${Number(x.credit||0).toFixed(2)}</td></tr>`).join(''); openSlideover(`<div class='table-responsive'><table class='table table-sm'><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ù…Ø¯ÙŠÙ†</th><th>Ø¯Ø§Ø¦Ù†</th></tr></thead><tbody>${rows}</tbody></table></div>`); } else { showToast('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯'); } }
  }); });
  function openAddEmp(){ const html=`<form id='addEmpForm' class='d-grid gap-2'>
      <div class='input-group'><span class='input-group-text'>Ø§Ù„Ø§Ø³Ù…</span><input name='full_name' class='form-control' required></div>
      <div class='input-group'><span class='input-group-text'>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ</span><input name='national_id' class='form-control' required></div>
      <div class='input-group'><span class='input-group-text'>Ø§Ù„Ù‚Ø³Ù…</span><input name='department' class='form-control'></div>
      <div class='input-group'><span class='input-group-text'>Ø§Ù„ÙˆØ¸ÙŠÙØ©</span><input name='position' class='form-control'></div>
      <div class='input-group'><span class='input-group-text'>Ø§Ù„Ù‡Ø§ØªÙ</span><input name='phone' class='form-control'></div>
      <div class='input-group'><span class='input-group-text'>Ø§Ù„Ø¨Ø±ÙŠØ¯</span><input name='email' class='form-control'></div>
      <div class='input-group'><span class='input-group-text'>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†</span><input name='hire_date' type='date' class='form-control' value='${new Date().toISOString().slice(0,10)}'></div>
      <div class='input-group'><span class='input-group-text'>Ø§Ù„ÙØ±Ø¹</span><input name='branch_code' class='form-control'></div>
      <div class='input-group'><span class='input-group-text'>Ø±Ø§ØªØ¨ Ø£Ø³Ø§Ø³ÙŠ</span><input name='base_salary' type='number' step='0.01' class='form-control' value='0'></div>
      <div class='d-flex gap-2 mt-2'><button class='btn btn-primary ripple' type='submit'>ğŸ’¾ Ø­ÙØ¸</button><a class='btn btn-outline-primary' href='/employees/create'>ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</a><button type='button' class='btn btn-outline-secondary' id='cancelAdd'>Ø¥Ù„ØºØ§Ø¡</button></div>
    </form>`; openSlideover(html); document.getElementById('cancelAdd').onclick=closeSlideover; const f=document.getElementById('addEmpForm'); f.onsubmit=async function(e){ e.preventDefault(); const fd=new FormData(f); fd.append('csrf_token', '{{ csrf_token() }}'); const r=await fetch('/api/employees', { method:'POST', body:fd }); const j=await r.json(); if(j&&j.ok){ const tbody=document.querySelector('#panel-employees tbody'); const idx=tbody.children.length+1; const d=(fd.get('department')||'').toLowerCase(); const tr=document.createElement('tr'); tr.setAttribute('data-row','emp'); tr.setAttribute('data-id', String(j.id)); tr.setAttribute('data-dept', d); tr.innerHTML=`<td>${idx}</td><td>${fd.get('full_name')||''}</td><td>${fd.get('position')||''}</td><td>${fd.get('branch_code')||''}</td><td>${parseFloat(fd.get('base_salary')||0).toFixed(2)}</td><td>${(0).toFixed(2)}</td><td>${(0).toFixed(2)}</td><td>active</td><td><button class='btn btn-sm btn-outline-primary ops-btn'>â‹®</button><div class='ops-menu'><div class='it' data-op='edit'>ØªØ¹Ø¯ÙŠÙ„</div><div class='it' data-op='advance'>Ù…Ù†Ø­ Ø³Ù„ÙØ©</div><div class='it' data-op='pay'>Ø¯ÙØ¹ Ø±Ø§ØªØ¨</div><div class='it' data-op='journal'>Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚ÙŠØ¯</div><div class='it text-danger' data-op='delete'>Ø­Ø°Ù</div></div></td>`; tbody.appendChild(tr); showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù'); closeSlideover(); } else { showToast('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù'); } } }
  document.getElementById('btnAddEmp')?.addEventListener('click', function(ev){ ev.preventDefault(); openAddEmp(); });
  if(window.AUTO_OPEN_CREATE){ openAddEmp(); }
  try{lottie.loadAnimation({container:document.getElementById('lottieEmp'),renderer:'svg',loop:true,autoplay:true,path:'https://assets8.lottiefiles.com/packages/lf20_3rwasyjy.json'})}catch(e){}
  try{lottie.loadAnimation({container:document.getElementById('lottieSal'),renderer:'svg',loop:true,autoplay:true,path:'https://assets1.lottiefiles.com/packages/lf20_ujd3f9rs.json'})}catch(e){}
  try{lottie.loadAnimation({container:document.getElementById('lottieAdv'),renderer:'svg',loop:true,autoplay:true,path:'https://assets3.lottiefiles.com/packages/lf20_vfux7z1h.json'})}catch(e){}
  try{lottie.loadAnimation({container:document.getElementById('lottiePay'),renderer:'svg',loop:true,autoplay:true,path:'https://assets9.lottiefiles.com/packages/lf20_udydk9.json'})}catch(e){}
  document.addEventListener('click', function(ev){ const b = ev.target.closest('.ops-btn'); if(!b) return; ev.stopPropagation(); document.querySelectorAll('.ops-fly').forEach(m=> m.remove()); const cell = b.parentElement; const row = b.closest('tr'); const id = row?.getAttribute('data-id')||''; const orig = cell.querySelector('.ops-menu'); if(!orig) return; const fly = orig.cloneNode(true); fly.classList.remove('ops-menu'); fly.classList.add('ops-fly'); fly.style.display='block'; fly.dataset.empId = id; document.body.appendChild(fly); const r = b.getBoundingClientRect(); const w = fly.offsetWidth; const h = fly.offsetHeight; let top = r.bottom + 6; let left = r.right - w; if(top + h > window.innerHeight) top = r.top - h - 6; if(left < 6) left = 6; fly.style.top = (top)+'px'; fly.style.left = (left)+'px'; });
  document.addEventListener('click', async function(ev){ const it = ev.target.closest('.ops-fly .it'); if(!it) return; ev.stopPropagation(); const rid = it.closest('.ops-fly')?.dataset.empId||''; const tr = document.querySelector('tr[data-id="'+rid+'"]'); document.querySelectorAll('.ops-fly').forEach(m=> m.remove()); if(!tr) return; const id = parseInt(rid||'0'); const op = it.getAttribute('data-op'); if(op==='view'){ const cells=[...tr.children].map(td=>td.textContent); openSlideover('<div>'+cells.join(' | ')+'</div>'); }
    else if(op==='edit'){ const name=tr.children[1].textContent.trim(); const pos=tr.children[2].textContent.trim(); const br=tr.children[3].textContent.trim(); const base=tr.children[4].textContent.trim(); const html=`<form id='empForm' class='d-grid gap-2'>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„Ø§Ø³Ù…</span><input name='full_name' class='form-control' value='${name}' required></div>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„Ù‚Ø³Ù…</span><input name='department' class='form-control' value='${(tr.dataset.dept||'')}'></div>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„ÙˆØ¸ÙŠÙØ©</span><input name='position' class='form-control' value='${pos}'></div>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„ÙØ±Ø¹</span><input name='branch_code' class='form-control' value='${br}'></div>
        <div class='input-group'><span class='input-group-text'>Ø±Ø§ØªØ¨ Ø£Ø³Ø§Ø³ÙŠ</span><input name='base_salary' type='number' step='0.01' class='form-control' value='${base}'></div>
            <div class='d-flex gap-2 mt-2'><button class='btn btn-primary ripple' type='submit'>ğŸ’¾ Ø­ÙØ¸</button><button type='button' class='btn btn-outline-secondary' id='cancelEdit'>Ø¥Ù„ØºØ§Ø¡</button></div>
      </form>`; openSlideover(html); document.getElementById('cancelEdit').onclick=closeSlideover; const f=document.getElementById('empForm'); f.onsubmit=async function(e){ e.preventDefault(); const fd=new FormData(f); fd.append('id', String(id)); const r=await fetch('/api/employees/'+id, { method:'PUT', body:fd }); const j=await r.json(); if(j&&j.ok){ tr.children[1].textContent=fd.get('full_name'); tr.children[2].textContent=fd.get('position'); tr.children[3].textContent=fd.get('branch_code'); tr.children[4].textContent=parseFloat(fd.get('base_salary')||0).toFixed(2); tr.dataset.dept=(fd.get('department')||'').toLowerCase(); showToast('ØªÙ… Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù'); closeSlideover(); } else { showToast('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); } } }
    else if(op==='delete'){ const confirmHtml=`<div class='Ø¯-grid gap-2'><div>Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙØŸ</div><div class='d-flex gap-2'><button id='doDel' class='btn btn-danger'>Ù†Ø¹Ù…ØŒ Ø­Ø°Ù</button><button class='btn btn-outline-secondary' id='noDel'>Ø¥Ù„ØºØ§Ø¡</button></div></div>`; openSlideover(confirmHtml); document.getElementById('noDel').onclick=closeSlideover; document.getElementById('doDel').onclick=async function(){ const r=await fetch('/api/employees/'+id, { method:'DELETE', headers: { 'X-CSRFToken': '{{ csrf_token() }}' } }); const j=await r.json(); if(j&&j.ok){ tr.remove(); showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù'); closeSlideover(); } else { showToast('ØªØ¹Ø°Ø± Ø§Ù„Ø­Ø°Ù'); } } }
    else if(op==='advance'){ const html=`<form id='advForm' class='d-grid gap-2'>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„Ù…Ø¨Ù„Øº</span><input name='amount' type='number' step='0.01' class='form-control' required></div>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„ØªØ§Ø±ÙŠØ®</span><input name='date' type='date' class='form-control' value='${new Date().toISOString().slice(0,10)}'></div>
        <div class='input-group'><span class='input-group-text'>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</span><select name='method' class='form-select'><option value='cash'>Ù†Ù‚Ø¯ÙŠ</option><option value='bank'>Ø¨Ù†Ùƒ</option><option value='card'>Ø¨Ø·Ø§Ù‚Ø©</option></select></div>
            <div class='d-flex gap-2 mt-2'><button class='btn btn-primary ripple' type='submit'>ğŸ’¾ Ø­ÙØ¸</button><button type='button' class='btn btn-outline-secondary' id='cancelAdv'>Ø¥Ù„ØºØ§Ø¡</button></div>
      </form>`; openSlideover(html); document.getElementById('cancelAdv').onclick=closeSlideover; const f=document.getElementById('advForm'); f.onsubmit=async function(e){ e.preventDefault(); const fd=new FormData(f); fd.append('employee_id', String(id)); fd.append('csrf_token', '{{ csrf_token() }}'); const r=await fetch('/api/advances', { method:'POST', body:fd }); const j=await r.json(); showToast(j&&j.ok?'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ù„ÙØ©':'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ù„ÙØ©'); if(j&&j.ok){ closeSlideover(); } } }
    else if(op==='deduct'){ const html=`<form id='dedForm' class='d-grid gap-2'>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„Ø´Ù‡Ø±</span><input name='month' type='month' class='form-control' value='${new Date().toISOString().slice(0,7)}'></div>
        <div class='input-group'><span class='input-group-text'>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…</span><input name='deduction_amount' type='number' step='0.01' class='form-control' required></div>
        <div class='d-flex gap-2 mt-2'><button class='btn btn-primary ripple' type='submit'>ğŸ’¾ Ø­ÙØ¸</button><button type='button' class='btn btn-outline-secondary' id='cancelDed'>Ø¥Ù„ØºØ§Ø¡</button></div>
      </form>`; openSlideover(html); document.getElementById('cancelDed').onclick=closeSlideover; const f=document.getElementById('dedForm'); f.onsubmit=async function(e){ e.preventDefault(); const fd=new FormData(f); const month=String(fd.get('month')||''); const amt=parseFloat(String(fd.get('deduction_amount')||'0')); const body=new FormData(); body.append('employee_id', String(id)); body.append('month', month); body.append('deduction_amount', String(amt||0)); body.append('absence_hours', '0'); body.append('overtime_hours', '0'); body.append('bonus_amount', '0'); body.append('csrf_token', '{{ csrf_token() }}'); const r=await fetch('/api/salaries/upsert', { method:'POST', body }); const j=await r.json(); showToast(j&&j.ok?'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®ØµÙ…':'ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®ØµÙ…'); if(j&&j.ok){ closeSlideover(); } }
    }
    else if(op==='pay'){ const html=`<form id='payForm' class='d-grid gap-2'>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„Ø´Ù‡Ø±</span><input name='month' type='month' class='form-control' value='${new Date().toISOString().slice(0,7)}'></div>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</span><input name='paid_amount' type='number' step='0.01' class='form-control' required></div>
        <div class='input-group'><span class='input-group-text'>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</span><select name='payment_method' class='form-select'><option value='cash'>Ù†Ù‚Ø¯ÙŠ</option><option value='bank'>Ø¨Ù†Ùƒ</option><option value='card'>Ø¨Ø·Ø§Ù‚Ø©</option></select></div>
            <div class='d-flex gap-2 mt-2'><button class='btn btn-primary ripple' type='submit'>ğŸ’¾ Ø­ÙØ¸</button><button type='button' class='btn btn-outline-secondary' id='cancelPay'>Ø¥Ù„ØºØ§Ø¡</button></div>
          </form>`; openSlideover(html); document.getElementById('cancelPay').onclick=closeSlideover; const f=document.getElementById('payForm'); f.onsubmit=async function(e){ e.preventDefault(); const fd=new FormData(f); fd.append('employee_id', String(id)); fd.append('csrf_token', '{{ csrf_token() }}'); const r=await fetch('/salaries/pay', { method:'POST', body:fd }); const ok = r.status===200; if(ok){ showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹ Ø§Ù„Ø±Ø§ØªØ¨'); closeSlideover(); } else { showToast('ÙØ´Ù„ Ø¯ÙØ¹ Ø§Ù„Ø±Ø§ØªØ¨'); } } }
    else if(op==='accrual'){ const html=`<form id='accForm' class='d-grid gap-2'>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„Ø´Ù‡Ø±</span><input name='month' type='month' class='form-control' value='${new Date().toISOString().slice(0,7)}'></div>
        <div class='d-flex gap-2 mt-2'><button class='btn btn-primary ripple' type='submit'>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ­Ù‚</button><button type='button' class='btn btn-outline-secondary' id='cancelAcc'>Ø¥Ù„ØºØ§Ø¡</button></div>
      </form>`; openSlideover(html); document.getElementById('cancelAcc').onclick=closeSlideover; const f=document.getElementById('accForm'); f.onsubmit=async function(e){ e.preventDefault(); const fd=new FormData(f); fd.append('employee_id', String(id)); fd.append('csrf_token', '{{ csrf_token() }}'); const r=await fetch('/salaries/accrual', { method:'POST', body:fd }); const j=await r.json(); showToast(j&&j.ok?'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ­Ù‚':'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ­Ù‚'); if(j&&j.ok){ closeSlideover(); } }
    }
    else if(op==='journal'){ const url=new URL('/api/employee-ledger', location.origin); url.searchParams.set('emp_id', String(id)); fetch(url).then(r=>r.json()).then(j=>{ if(j&&j.ok){ const rows=(j.rows||[]).map(x=>`<tr><td>${x.date}</td><td>${x.entry}</td><td>${x.desc}</td><td class='text-end'>${Number(x.debit||0).toFixed(2)}</td><td class='text-end'>${Number(x.credit||0).toFixed(2)}</td></tr>`).join(''); openSlideover(`<div class='table-responsive'><table class='table table-sm'><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ù…Ø¯ÙŠÙ†</th><th>Ø¯Ø§Ø¦Ù†</th></tr></thead><tbody>${rows}</tbody></table></div>`); } else { showToast('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯'); } }).catch(()=> showToast('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯')); }
  });
</script>
{% endblock %}
