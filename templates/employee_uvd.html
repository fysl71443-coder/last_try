{% extends 'base.html' %}
{% block title %}Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†{% endblock %}
{% block content %}
<style>
  :root{--p1:#1E40AF;--p2:#4F46E5;--s1:#06B6D4;--s2:#22D3EE;--accent:#00eaff;--bg:#f5f7fb}
  .uvd-container{padding:16px}
  .topbar{display:flex;align-items:center;gap:12px;justify-content:space-between;background:#ffffffd9;border:1px solid #eaeaea;border-radius:16px;padding:12px 16px;backdrop-filter:blur(10px)}
  .topbar .left{display:flex;align-items:center;gap:12px}
  .topbar .brand{display:flex;align-items:center;gap:8px;font-weight:800}
  .brand-logo{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,var(--p1),var(--p2));color:#fff;box-shadow:0 8px 22px rgba(79,70,229,.25)}
  .brand-logo:hover{filter:saturate(120%)}
  .topbar input[type="search"]{min-width:300px;border:1px solid #dfe3eb;border-radius:12px;padding:10px;box-shadow:0 6px 14px rgba(0,0,0,.06)}
  .suggest{position:absolute;background:#fff;border:1px solid #eaeaea;border-radius:10px;box-shadow:0 12px 24px rgba(0,0,0,.12);min-width:300px;display:none;overflow:hidden}
  .suggest .item{padding:8px 12px;cursor:pointer}
  .suggest .item:hover{background:#f0f7ff}
  .add-btn{background:linear-gradient(135deg,var(--s1),var(--s2));color:#fff;border:none;border-radius:12px;padding:10px 14px;font-weight:700}
  .add-btn:hover{transform:scale(1.1)}
  .sidebar{position:sticky;top:12px;background:#ffffffcc;border:1px solid #eaeaea;border-radius:16px;padding:12px;backdrop-filter:blur(10px);box-shadow:0 10px 26px rgba(0,0,0,.06)}
  .nav-item{padding:10px;border-radius:12px;cursor:pointer;display:flex;align-items:center;gap:8px}
  .nav-item:hover{background:#f6f8ff}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .kpi{position:relative;background:#ffffffd9;border:1px solid #eaeaea;border-radius:18px;padding:14px;overflow:hidden;box-shadow:0 14px 34px rgba(0,0,0,.08)}
  .kpi .title{font-size:13px;color:#666}
  .kpi .value{font-size:22px;font-weight:800}
  .kpi .lottie{position:absolute;right:10px;top:8px;width:48px;height:48px;opacity:.9}
  .spark{height:40px;width:100%}
  .dept-tabs{display:flex;flex-wrap:wrap;gap:8px;margin:16px 0}
  .dept-tab{padding:10px 12px;border:1px solid #eaeaea;border-radius:12px;background:#fff;cursor:pointer;display:flex;align-items:center;gap:6px}
  .dept-tab.active{background:linear-gradient(135deg,var(--p1),var(--p2));color:#fff;border-color:transparent;box-shadow:0 10px 24px rgba(30,64,175,.25)}
  .badge{background:#1112;color:#0d6efd;border:1px solid #cfe3ff;border-radius:10px;padding:2px 8px;font-weight:700}
  .panel{display:none}
  .panel.active{display:block}
  table{width:100%;border-collapse:collapse}
  thead th{position:sticky;top:0;background:#f8f9fa;box-shadow:0 3px 6px rgba(0,0,0,.06);z-index:1}
  th,td{padding:10px;border:1px solid #eee;text-align:center;white-space:nowrap}
  tbody tr{transition:transform .2s ease, box-shadow .2s ease, background .2s ease}
  tbody tr:hover{background:linear-gradient(90deg,#f0f7ff,#ffffff);transform:translateY(-1px);box-shadow:0 6px 12px rgba(0,0,0,.06)}
  .ops-btn{position:relative}
  .ops-menu{position:absolute;right:0;top:100%;background:#fff;border:1px solid #eaeaea;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.12);display:none;min-width:180px}
  .ops-menu .it{padding:8px 12px;cursor:pointer}
  .ops-menu .it:hover{background:#f6fbff}
  .ripple-btn{position:relative;overflow:hidden}
  .slideover{position:fixed;top:0;right:-520px;width:480px;height:100vh;background:#fff;border-left:1px solid #eee;box-shadow:-8px 0 20px rgba(0,0,0,.1);z-index:1000;display:flex;flex-direction:column}
  .slideover-header{padding:18px 16px;font-weight:800;background:linear-gradient(135deg,#eef4ff,#ffffff)}
  .slideover-body{padding:14px;overflow:auto}
  .toast{position:fixed;top:-80px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--p1),var(--p2));color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.18);z-index:1100}
</style>

<div class="container-fluid uvd-container">
  <div class="topbar">
    <div class="left">
      <div class="brand"><div class="brand-logo">ğŸ½ï¸</div><span>Logo Restaurant</span></div>
      <strong>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</strong>
    </div>
    <div style="min-width:300px">
      <select id="empSelect" class="form-select">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù</option>
        {% for e in employees %}
        <option value="{{ e.id }}">{{ e.full_name }}</option>
        {% endfor %}
      </select>
    </div>
    <a id="btnAddEmp" class="add-btn ripple-btn" href="/employees/create">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</a>
    <div class="right">ğŸ‘¤ Ù…Ø±Ø­Ø¨Ø§Ù‹ {{ current_user.username }}</div>
  </div>

  <div class="row mt-3">
    <div class="col-md-3">
      <div class="sidebar">
        <div class="nav-item" data-tab="employees">â–ªï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
        <a class="nav-item" data-tab="prev" href="/payroll/previous">â–ªï¸ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</a>
        <a class="nav-item" data-tab="adv" href="/advances">â–ªï¸ Ø§Ù„Ø³Ù„Ù</a>
        <a class="nav-item" data-tab="ledger" href="/ledger">â–ªï¸ ÙƒØ´ÙˆÙØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</a>
        <a class="nav-item" data-tab="reports" href="/reports/monthly">â–ªï¸ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</a>
        <a class="nav-item" data-tab="settings" href="/employees/settings">â–ªï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</a>
      </div>
    </div>
  <div class="col-md-9">
      <div class="kpis">
        <div class="kpi">
          <div class="title">ğŸ§‘â€ğŸ³ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
          <div class="value">{{ emp_count }}</div>
          <div class="lottie" id="lottieEmp"></div>
          <canvas class="spark" data-kind="emp"></canvas>
        </div>
        <div class="kpi">
          <div class="title">ğŸ’µ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</div>
          <div class="value">{{ '%.2f'|format(sal_sum) }}</div>
          <div class="lottie" id="lottieSal"></div>
          <canvas class="spark" data-kind="sal"></canvas>
        </div>
        <div class="kpi">
          <div class="title">ğŸ’³ Ø§Ù„Ø³Ù„Ù Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</div>
          <div class="value">{{ '%.2f'|format(adv_out) }}</div>
          <div class="lottie" id="lottieAdv"></div>
          <canvas class="spark" data-kind="adv"></canvas>
        </div>
        <div class="kpi">
          <div class="title">ğŸ“… Ø¢Ø®Ø± ØµØ±Ù</div>
          <div class="value">{{ (last_pay_dt.strftime('%d/%m/%Y') if last_pay_dt else 'â€”') }}</div>
          <div class="lottie" id="lottiePay"></div>
          <canvas class="spark" data-kind="pay"></canvas>
        </div>
        <div class="kpi">
          <div class="title">ğŸ”” Ø¹Ø¯Ø¯ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
          <div class="value">{{ je_cnt }}</div>
          <canvas class="spark" data-kind="je"></canvas>
        </div>
      </div>

      <div class="dept-tabs" id="quick-nav" style="margin-top:8px">
        <a class="dept-tab" href="/employee-uvd">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</a>
        <a class="dept-tab" href="/payroll/previous">Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</a>
        <a class="dept-tab" href="/advances">Ø§Ù„Ø³Ù„Ù</a>
        <a class="dept-tab" href="/ledger">ÙƒØ´ÙˆÙ Ø§Ù„Ø­Ø³Ø§Ø¨</a>
        <a class="dept-tab" href="/reports/monthly">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</a>
      </div>

      <div class="dept-tabs">
        <div class="dept-tab active" data-dept="all">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… <span class="badge">{{ emp_count }}</span></div>
        {% for k,v in dept_counts.items() %}
        <div class="dept-tab" data-dept="{{ k }}">{{ k }} <span class="badge">{{ v }}</span></div>
        {% endfor %}
      </div>

      <div id="panel-employees" class="panel active">
        <table>
          <thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¯ÙˆØ±</th><th>Ø§Ù„ÙØ±Ø¹</th><th>Ø±Ø§ØªØ¨ Ø£Ø³Ø§Ø³ÙŠ</th><th>Ø³Ù„ÙØ©</th><th>Ø¢Ø®Ø± Ø±Ø§ØªØ¨</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>âš™</th></tr></thead>
          <tbody>
            {% for e in employees %}
            <tr data-row="emp" data-id="{{ e.id }}" data-dept="{{ (e.department or 'other')|lower }}">
              <td>{{ loop.index }}</td>
              <td>{{ e.full_name }}</td>
              <td>{{ e.position or '' }}</td>
              <td>{{ e.branch_code or '' }}</td>
              <td>{{ '%.2f'|format((e.base_salary or 0)) }}</td>
              <td>{{ '%.2f'|format(0) }}</td>
              <td>{{ '%.2f'|format(0) }}</td>
              <td>{{ e.status }}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary ops-btn">â‹®</button>
                <div class="ops-menu">
                  <div class="it" data-op="edit">ØªØ¹Ø¯ÙŠÙ„</div>
                  <div class="it" data-op="advance">Ù…Ù†Ø­ Ø³Ù„ÙØ©</div>
                  <div class="it" data-op="pay">Ø¯ÙØ¹ Ø±Ø§ØªØ¨</div>
                  <div class="it" data-op="journal">Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚ÙŠØ¯</div>
                  <div class="it text-danger" data-op="delete">Ø­Ø°Ù</div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div id="panel-prev" class="panel" style="display:none">
        <div class="dept-tabs mb-2">
          <button class="dept-tab active" data-dept="all">Ø§Ù„ÙƒÙ„</button>
          <button class="dept-tab" data-dept="kitchen">Ø´ÙŠÙ</button>
          <button class="dept-tab" data-dept="hall">Ø§Ù„ØµØ§Ù„Ø©</button>
          <button class="dept-tab" data-dept="admin">Ø¥Ø¯Ø§Ø±ÙŠ</button>
        </div>
        <table>
          <thead><tr><th>Ø§Ù„Ø³Ù†Ø©</th><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
          <tbody>
            {% for s in prev_salaries %}
            <tr data-row="sal" data-id="{{ s.id }}" data-dept="{{ (s.employee.department if s.employee else '')|lower }}">
              <td>{{ s.year }}</td>
              <td>{{ s.month }}</td>
              <td>{{ s.employee.full_name if s.employee else s.employee_id }}</td>
              <td>{{ '%.2f'|format(s.total_salary or 0) }}</td>
              <td>{{ s.status }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div id="panel-adv" class="panel" style="display:none">
        <div class="dept-tabs mb-2">
          <button class="dept-tab active" data-dept="all">Ø§Ù„ÙƒÙ„</button>
          <button class="dept-tab" data-dept="kitchen">Ø´ÙŠÙ</button>
          <button class="dept-tab" data-dept="hall">Ø§Ù„ØµØ§Ù„Ø©</button>
          <button class="dept-tab" data-dept="admin">Ø¥Ø¯Ø§Ø±ÙŠ</button>
        </div>
        <table>
          <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ù…Ø¯ÙŠÙ†</th><th>Ø¯Ø§Ø¦Ù†</th></tr></thead>
          <tbody>
            {% for a in advances %}
            <tr data-row="adv" data-id="{{ a.id }}" data-emp="{{ a.employee_id }}">
              <td>{{ a.line_date }}</td>
              <td>{{ a.description }}</td>
              <td>{{ '%.2f'|format(a.debit or 0) }}</td>
              <td>{{ '%.2f'|format(a.credit or 0) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div id="panel-ledger" class="panel" style="display:none">
        <table>
          <thead><tr><th>Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
        <tbody>
          {% for j in ledgers %}
          <tr data-row="je" data-id="{{ j.id }}">
            <td>{{ j.entry_number }}</td>
            <td>{{ j.date }}</td>
            <td>{{ j.description }}</td>
            <td>{{ j.status }}</td>
          </tr>
          {% endfor %}
        </tbody>
        </table>
      </div>
      <div id="panel-ext" class="panel" style="height:70vh;border:1px solid #eaeaea;border-radius:16px;overflow:hidden;background:#ffffffd9">
        <iframe id="panelIframe" src="" style="width:100%;height:100%;border:0;"> </iframe>
      </div>
    </div>
  </div>

  <div id="slideover" class="slideover">
    <div class="slideover-header">ØªÙØ§ØµÙŠÙ„</div>
    <div class="slideover-body" id="slideoverBody"></div>
  </div>
  <div id="toast" class="toast">Ù…Ø±Ø­Ø¨Ø§Ù‹! ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
</div>

<script>
  window.AUTO_OPEN_CREATE = {{ 'true' if auto_open_create else 'false' }};
  function showToast(msg){const t=document.getElementById('toast');t.textContent=msg||t.textContent;if(window.gsap){gsap.to(t,{duration:.4,y:100});setTimeout(()=>gsap.to(t,{duration:.4,y:-100}),5000)}else{t.style.transition='transform .4s ease, opacity .4s';t.style.transform='translateY(100px)';t.style.opacity='1';setTimeout(()=>{t.style.transform='translateY(-100px)';t.style.opacity='0';},5000)}}
  function openSlideover(html){const p=document.getElementById('slideover');document.getElementById('slideoverBody').innerHTML=html;if(window.gsap){gsap.to(p,{duration:.5,x:-520,scale:1,ease:'power2.out'})}else{p.style.transition='transform .5s ease';p.style.transform='translateX(-520px)'}}
  function closeSlideover(){const p=document.getElementById('slideover');if(window.gsap){gsap.to(p,{duration:.4,x:0,ease:'power2.in'})}else{p.style.transition='transform .4s ease';p.style.transform='translateX(0)'}}
  document.addEventListener('click',function(ev){if(ev.target.id==='toast'){closeSlideover()}})
  const empTab = document.querySelector('.nav-item[data-tab="employees"]');
  if(empTab){ empTab.addEventListener('click',()=>{ const k='employees'; document.querySelectorAll('.panel').forEach(p=>{p.classList.toggle('active',p.id==='panel-'+k)}); if(window.gsap){ gsap.fromTo('#panel-'+k,{opacity:0,y:16},{opacity:1,y:0,duration:.3}); } else { const el=document.querySelector('#panel-'+k); if(el){ el.style.opacity='0'; el.style.transform='translateY(16px)'; setTimeout(()=>{ el.style.transition='all .3s ease'; el.style.opacity='1'; el.style.transform='translateY(0)'; }, 0); } } }); }
  
  document.querySelectorAll('.dept-tab').forEach(b=>{b.addEventListener('click',()=>{document.querySelectorAll('.dept-tab').forEach(bb=>bb.classList.remove('active'));b.classList.add('active');const dept=b.dataset.dept;document.querySelectorAll('tbody tr[data-row="emp"]').forEach(tr=>{const d=tr.dataset.dept||'other';tr.style.display=(dept==='all'||dept===d)?'':'none'})})})
  ;(function(){ const map={}; try{ {% for e in employees %} map['{{ e.id }}']='{{ (e.department or '')|lower }}'; {% endfor %} }catch(err){} document.querySelectorAll('#panel-prev .dept-tab').forEach(b=>{ b.addEventListener('click', function(){ document.querySelectorAll('#panel-prev .dept-tab').forEach(x=>x.classList.remove('active')); this.classList.add('active'); const d=this.getAttribute('data-dept')||'all'; document.querySelectorAll('#panel-prev tbody tr[data-row="sal"]').forEach(tr=>{ const dd=(tr.getAttribute('data-dept')||''); const ok = d==='all' || (d==='kitchen'&&/kitchen|chef|Ø´ÙŠÙ/i.test(dd)) || (d==='hall'&&/hall|floor|wait|ØµØ§Ù„Ø©|Ø§Ù„ØµØ§Ù„Ø©/i.test(dd)) || (d==='admin'&&/admin|Ø¥Ø¯Ø§Ø±ÙŠ/i.test(dd)); tr.style.display = ok? '' : 'none'; }); }); }); document.querySelectorAll('#panel-adv .dept-tab').forEach(b=>{ b.addEventListener('click', function(){ document.querySelectorAll('#panel-adv .dept-tab').forEach(x=>x.classList.remove('active')); this.classList.add('active'); const d=this.getAttribute('data-dept')||'all'; document.querySelectorAll('#panel-adv tbody tr[data-row="adv"]').forEach(tr=>{ const emp=(tr.getAttribute('data-emp')||''); const dd=map[emp]||''; const ok = d==='all' || (d==='kitchen'&&/kitchen|chef|Ø´ÙŠÙ/i.test(dd)) || (d==='hall'&&/hall|floor|wait|ØµØ§Ù„Ø©|Ø§Ù„ØµØ§Ù„Ø©/i.test(dd)) || (d==='admin'&&/admin|Ø¥Ø¯Ø§Ø±ÙŠ/i.test(dd)); tr.style.display = ok? '' : 'none'; }); }); }); })()
  document.querySelectorAll('tbody tr').forEach(r=>{r.addEventListener('click',()=>{const cells=[...r.children].map(td=>td.textContent);openSlideover('<div>'+cells.join(' | ')+'</div>')})})
  ;(function(){
    function hideOps(){ document.querySelectorAll('.ops-menu').forEach(m=> m.style.display='none'); }
    document.addEventListener('click', function(e){ if(!e.target.closest('.ops-btn') && !e.target.closest('.ops-menu')){ hideOps(); } });
    document.querySelectorAll('.ops-btn').forEach(btn=>{
      btn.addEventListener('click', function(ev){ ev.stopPropagation(); const menu = this.parentElement.querySelector('.ops-menu'); const vis = (menu.style.display==='block'); hideOps(); menu.style.display = vis? 'none' : 'block'; });
    });
    document.querySelectorAll('.ops-menu .it').forEach(it=>{
      it.addEventListener('click', function(ev){ ev.stopPropagation(); const tr=this.closest('tr'); const id=tr?.getAttribute('data-id'); const op=this.getAttribute('data-op'); hideOps(); if(!id) return; switch(op){
        case 'edit':
          (function(){ const cells=[...tr.children].map(td=>td.textContent); const html=`<form id='editEmpForm' class='d-grid gap-2'>
            <div class='input-group'><span class='input-group-text'>Ø§Ù„Ø§Ø³Ù…</span><input name='full_name' class='form-control' value='${cells[1]||''}' required></div>
            <div class='input-group'><span class='input-group-text'>Ø§Ù„ÙˆØ¸ÙŠÙØ©</span><input name='position' class='form-control' value='${cells[2]||''}'></div>
            <div class='input-group'><span class='input-group-text'>Ø§Ù„ÙØ±Ø¹</span><input name='branch_code' class='form-control' value='${cells[3]||''}'></div>
            <div class='input-group'><span class='input-group-text'>Ø±Ø§ØªØ¨ Ø£Ø³Ø§Ø³ÙŠ</span><input name='base_salary' type='number' step='0.01' class='form-control' value='${parseFloat(cells[4]||'0')}'></div>
            <div class='d-flex gap-2 mt-2'><button class='btn btn-navy' type='submit'>ğŸ’¾ Ø­ÙØ¸</button><button type='button' class='btn btn-outline-secondary' id='cancelEdit'>Ø¥Ù„ØºØ§Ø¡</button></div>
          </form>`; openSlideover(html); const f=document.getElementById('editEmpForm'); document.getElementById('cancelEdit').onclick=closeSlideover; f.onsubmit=async function(e){ e.preventDefault(); const fd=new FormData(f); const r=await fetch('/api/employees/'+id, { method:'PUT', body:fd }); const j=await r.json(); showToast(j&&j.ok?'ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„':'ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); if(j&&j.ok){ tr.children[1].textContent = String(fd.get('full_name')||''); tr.children[2].textContent = String(fd.get('position')||''); tr.children[3].textContent = String(fd.get('branch_code')||''); tr.children[4].textContent = Number(fd.get('base_salary')||0).toFixed(2); closeSlideover(); } } })();
          break;
        case 'advance':
          (function(){ const html=`<form id='advForm' class='d-grid gap-2'>
            <div class='input-group'><span class='input-group-text'>Ø§Ù„Ù…Ø¨Ù„Øº</span><input name='amount' type='number' step='0.01' class='form-control' required></div>
            <div class='input-group'><span class='input-group-text'>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</span><select name='method' class='form-select'><option value='cash'>Ù†Ù‚Ø¯ÙŠ</option><option value='bank'>Ø¨Ù†Ùƒ</option><option value='card'>Ø¨Ø·Ø§Ù‚Ø©</option></select></div>
            <div class='input-group'><span class='input-group-text'>Ø§Ù„ØªØ§Ø±ÙŠØ®</span><input name='date' type='date' class='form-control' value='${new Date().toISOString().slice(0,10)}'></div>
            <div class='d-flex gap-2 mt-2'><button class='btn btn-navy' type='submit'>ğŸ’¾ Ø­ÙØ¸</button><button type='button' class='btn btn-outline-secondary' id='cancelAdv'>Ø¥Ù„ØºØ§Ø¡</button></div>
          </form>`; openSlideover(html); const f=document.getElementById('advForm'); document.getElementById('cancelAdv').onclick=closeSlideover; f.onsubmit=async function(e){ e.preventDefault(); const fd=new FormData(f); fd.append('employee_id', id); const r=await fetch('/api/advances', { method:'POST', body:fd }); const j=await r.json(); showToast(j&&j.ok?'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ù„ÙØ©':'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ù„ÙØ©'); if(j&&j.ok){ closeSlideover(); } } })();
          break;
        case 'pay':
          (function(){ const iframe=document.getElementById('panelIframe'); document.querySelectorAll('.panel').forEach(p=> p.classList.remove('active')); const ext=document.getElementById('panel-ext'); ext.classList.add('active'); iframe.src='/employees/'+id+'/pay'; showToast('ÙØªØ­ Ø³Ø¯Ø§Ø¯ Ø±Ø§ØªØ¨ Ø§Ù„Ù…ÙˆØ¸Ù'); })();
          break;
        case 'journal':
          (function(){ fetch('/api/employee-ledger?employee_id='+id).then(r=>r.json()).then(j=>{ const rows=(j.rows||[]); let html='<div><h6>Ù‚ÙŠÙˆØ¯ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù</h6><table class="table"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ù…Ø¯ÙŠÙ†</th><th>Ø¯Ø§Ø¦Ù†</th></tr></thead><tbody>'; rows.forEach(x=>{ html+=`<tr><td>${x.date||'-'}</td><td>${x.description||''}</td><td class='text-end'>${Number(x.debit||0).toFixed(2)}</td><td class='text-end'>${Number(x.credit||0).toFixed(2)}</td></tr>`; }); html+='</tbody></table></div>'; openSlideover(html); }).catch(()=> showToast('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯')); })();
          break;
        case 'delete':
          (function(){ if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙØŸ')) return; fetch('/api/employees/'+id, { method:'DELETE' }).then(r=> r.json()).then(j=>{ showToast(j&&j.ok?'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù':'ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù'); if(j&&j.ok){ tr.remove(); } }).catch(()=> showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©')); })();
          break;
      }
    });
    });
    document.querySelectorAll('tbody tr').forEach(r=>{ r.addEventListener('click', function(ev){ if(ev.target.closest('button')||ev.target.closest('.ops-menu')) return; const cells=[...r.children].map(td=>td.textContent); openSlideover('<div>'+cells.join(' | ')+'</div>'); }); });
  })();
  ;(function(){ const btn=document.createElement('button'); btn.className='btn btn-outline-primary btn-sm'; btn.textContent='ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù'; const cont=document.querySelector('#panel-ledger'); if(cont){ cont.insertBefore(btn, cont.firstChild); btn.addEventListener('click', function(){ const table=cont.querySelector('table'); if(!table) return; const w=window.open('', '_blank'); w.document.write('<html><head><title>ÙƒØ´Ù Ø­Ø³Ø§Ø¨</title></head><body>'+table.outerHTML+'<script>window.onload=function(){window.print();};<\/script></body></html>'); w.document.close(); }); } })()
  document.querySelectorAll('.ripple-btn').forEach(btn=>{btn.addEventListener('click',e=>{const x=e.offsetX,y=e.offsetY;const s=document.createElement('span');s.style.position='absolute';s.style.left=x+'px';s.style.top=y+'px';s.style.width=s.style.height='8px';s.style.borderRadius='50%';s.style.background='rgba(255,255,255,.7)';btn.appendChild(s); if(window.gsap){ gsap.to(s,{duration:.5,scale:12,opacity:0,onComplete:()=>s.remove()}); } else { s.style.transition='transform .5s ease, opacity .5s ease'; requestAnimationFrame(()=>{ s.style.transform='scale(12)'; s.style.opacity='0'; }); setTimeout(()=>{ try{ s.remove(); }catch(e){} }, 520); } })})
  ;(function(){document.querySelectorAll('.spark').forEach(c=>{const ctx=c.getContext('2d');const w=c.width=c.clientWidth;const h=c.height=c.clientHeight;ctx.clearRect(0,0,w,h);ctx.strokeStyle='#4c7cf5';ctx.lineWidth=2;const pts=Array.from({length:20},(_,i)=>({x:(i/(20-1))*w,y:h-((Math.sin(i*.5)+1)/2)*h*0.8-5}));ctx.beginPath();pts.forEach((p,i)=>{if(i===0)ctx.moveTo(p.x,p.y);else ctx.lineTo(p.x,p.y)});ctx.stroke();ctx.fillStyle='rgba(76,124,245,.12)';ctx.lineTo(w,h);ctx.lineTo(0,h);ctx.closePath();ctx.fill()})})()
  showToast('Ù…Ø±Ø­Ø¨Ø§Ù‹! ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†')
  document.getElementById('empSelect')?.addEventListener('change', function(){
    const id = this.value || '';
    document.querySelectorAll('tbody tr[data-row="emp"]').forEach(tr=>{
      const tid = tr.getAttribute('data-id') || '';
      tr.style.display = (!id || tid === id) ? '' : 'none';
    });
  });
  const slh=document.getElementById('slHeader'); if(slh){ document.addEventListener('mousemove',e=>{const r=slh.getBoundingClientRect();const dx=(e.clientX-(r.left+r.width/2))/r.width;const dy=(e.clientY-(r.top+r.height/2))/r.height; if(window.gsap){ gsap.to(slh,{duration:.2,transform:'translate3d('+dx*6+'px,'+dy*6+'px,0) rotate('+dx*2+'deg)'}); } else { slh.style.transition='transform .2s ease'; slh.style.transform='translate3d('+dx*6+'px,'+dy*6+'px,0) rotate('+dx*2+'deg)'; } }) }
  document.querySelectorAll('.ops-btn').forEach(b=>{b.addEventListener('click',ev=>{ev.stopPropagation();const m=b.nextElementSibling;m.style.display=m.style.display==='block'?'none':'block'})})
  document.querySelectorAll('tbody tr[data-row="emp"] .ops-menu .it').forEach(it=>{
    it.addEventListener('click', async function(ev){ ev.stopPropagation(); const tr=this.closest('tr'); const id=parseInt(tr.getAttribute('data-id')); const op=this.getAttribute('data-op'); if(op==='edit'){ const name=tr.children[1].textContent.trim(); const pos=tr.children[2].textContent.trim(); const br=tr.children[3].textContent.trim(); const base=tr.children[4].textContent.trim(); const html=`<form id='empForm' class='d-grid gap-2'>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„Ø§Ø³Ù…</span><input name='full_name' class='form-control' value='${name}' required></div>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„Ù‚Ø³Ù…</span><input name='department' class='form-control' value='${(tr.dataset.dept||'')}'></div>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„ÙˆØ¸ÙŠÙØ©</span><input name='position' class='form-control' value='${pos}'></div>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„ÙØ±Ø¹</span><input name='branch_code' class='form-control' value='${br}'></div>
        <div class='input-group'><span class='input-group-text'>Ø±Ø§ØªØ¨ Ø£Ø³Ø§Ø³ÙŠ</span><input name='base_salary' type='number' step='0.01' class='form-control' value='${base}'></div>
        <div class='d-flex gap-2 mt-2'><button class='btn btn-navy ripple' type='submit'>ğŸ’¾ Ø­ÙØ¸</button><button type='button' class='btn btn-outline-secondary' id='cancelEdit'>Ø¥Ù„ØºØ§Ø¡</button></div>
      </form>`; openSlideover(html); document.getElementById('cancelEdit').onclick=closeSlideover; const f=document.getElementById('empForm'); f.onsubmit=async function(e){ e.preventDefault(); const fd=new FormData(f); fd.append('id', String(id)); const r=await fetch('/api/employees/'+id, { method:'PUT', body:fd }); const j=await r.json(); if(j&&j.ok){ tr.children[1].textContent=fd.get('full_name'); tr.children[2].textContent=fd.get('position'); tr.children[3].textContent=fd.get('branch_code'); tr.children[4].textContent=parseFloat(fd.get('base_salary')||0).toFixed(2); tr.dataset.dept=(fd.get('department')||'').toLowerCase(); showToast('ØªÙ… Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù'); closeSlideover(); } else { showToast('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); } } }
    else if(op==='delete'){ const confirmHtml=`<div class='d-grid gap-2'><div>Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙØŸ</div><div class='d-flex gap-2'><button id='doDel' class='btn btn-danger'>Ù†Ø¹Ù…ØŒ Ø­Ø°Ù</button><button class='btn btn-outline-secondary' id='noDel'>Ø¥Ù„ØºØ§Ø¡</button></div></div>`; openSlideover(confirmHtml); document.getElementById('noDel').onclick=closeSlideover; document.getElementById('doDel').onclick=async function(){ const r=await fetch('/api/employees/'+id, { method:'DELETE' }); const j=await r.json(); if(j&&j.ok){ tr.remove(); showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù'); closeSlideover(); } else { showToast('ØªØ¹Ø°Ø± Ø§Ù„Ø­Ø°Ù'); } } }
    else if(op==='advance'){ const html=`<form id='advForm' class='d-grid gap-2'>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„Ù…Ø¨Ù„Øº</span><input name='amount' type='number' step='0.01' class='form-control' required></div>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„ØªØ§Ø±ÙŠØ®</span><input name='date' type='date' class='form-control' value='${new Date().toISOString().slice(0,10)}'></div>
        <div class='input-group'><span class='input-group-text'>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</span><select name='method' class='form-select'><option value='cash'>Ù†Ù‚Ø¯ÙŠ</option><option value='bank'>Ø¨Ù†Ùƒ</option><option value='card'>Ø¨Ø·Ø§Ù‚Ø©</option></select></div>
        <div class='d-flex gap-2 mt-2'><button class='btn btn-navy ripple' type='submit'>ğŸ’¾ Ø­ÙØ¸</button><button type='button' class='btn btn-outline-secondary' id='cancelAdv'>Ø¥Ù„ØºØ§Ø¡</button></div>
      </form>`; openSlideover(html); document.getElementById('cancelAdv').onclick=closeSlideover; const f=document.getElementById('advForm'); f.onsubmit=async function(e){ e.preventDefault(); const fd=new FormData(f); fd.append('employee_id', String(id)); const r=await fetch('/api/advances', { method:'POST', body:fd }); const j=await r.json(); if(j&&j.ok){ showToast('ØªÙ… Ù…Ù†Ø­ Ø§Ù„Ø³Ù„ÙØ©'); closeSlideover(); } else { showToast('ÙØ´Ù„ Ù…Ù†Ø­ Ø§Ù„Ø³Ù„ÙØ©'); } } }
    else if(op==='pay'){ const html=`<form id='payForm' class='d-grid gap-2'>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„Ø´Ù‡Ø±</span><input name='month' type='month' class='form-control' value='${new Date().toISOString().slice(0,7)}'></div>
        <div class='input-group'><span class='input-group-text'>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</span><input name='paid_amount' type='number' step='0.01' class='form-control' required></div>
        <div class='input-group'><span class='input-group-text'>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</span><select name='payment_method' class='form-select'><option value='cash'>Ù†Ù‚Ø¯ÙŠ</option><option value='bank'>Ø¨Ù†Ùƒ</option><option value='card'>Ø¨Ø·Ø§Ù‚Ø©</option></select></div>
        <div class='d-flex gap-2 mt-2'><button class='btn btn-navy ripple' type='submit'>ğŸ’¾ Ø­ÙØ¸</button><button type='button' class='btn btn-outline-secondary' id='cancelPay'>Ø¥Ù„ØºØ§Ø¡</button></div>
      </form>`; openSlideover(html); document.getElementById('cancelPay').onclick=closeSlideover; const f=document.getElementById('payForm'); f.onsubmit=async function(e){ e.preventDefault(); const fd=new FormData(f); fd.append('employee_id', String(id)); const r=await fetch('/salaries/pay', { method:'POST', body:fd }); const ok = r.status===200; if(ok){ showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹ Ø§Ù„Ø±Ø§ØªØ¨'); closeSlideover(); } else { showToast('ÙØ´Ù„ Ø¯ÙØ¹ Ø§Ù„Ø±Ø§ØªØ¨'); } } }
    else if(op==='journal'){ const url=new URL('/api/employee-ledger', location.origin); url.searchParams.set('emp_id', String(id)); const r=await fetch(url); const j=await r.json(); if(j&&j.ok){ const rows=(j.rows||[]).map(x=>`<tr><td>${x.date}</td><td>${x.entry}</td><td>${x.desc}</td><td class='text-end'>${Number(x.debit||0).toFixed(2)}</td><td class='text-end'>${Number(x.credit||0).toFixed(2)}</td></tr>`).join(''); openSlideover(`<div class='table-responsive'><table class='table table-sm'><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ù…Ø¯ÙŠÙ†</th><th>Ø¯Ø§Ø¦Ù†</th></tr></thead><tbody>${rows}</tbody></table></div>`); } else { showToast('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯'); } }
  }); });
  function openAddEmp(){ const html=`<form id='addEmpForm' class='d-grid gap-2'>
      <div class='input-group'><span class='input-group-text'>Ø§Ù„Ø§Ø³Ù…</span><input name='full_name' class='form-control' required></div>
      <div class='input-group'><span class='input-group-text'>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ</span><input name='national_id' class='form-control' required></div>
      <div class='input-group'><span class='input-group-text'>Ø§Ù„Ù‚Ø³Ù…</span><input name='department' class='form-control'></div>
      <div class='input-group'><span class='input-group-text'>Ø§Ù„ÙˆØ¸ÙŠÙØ©</span><input name='position' class='form-control'></div>
      <div class='input-group'><span class='input-group-text'>Ø§Ù„Ù‡Ø§ØªÙ</span><input name='phone' class='form-control'></div>
      <div class='input-group'><span class='input-group-text'>Ø§Ù„Ø¨Ø±ÙŠØ¯</span><input name='email' class='form-control'></div>
      <div class='input-group'><span class='input-group-text'>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†</span><input name='hire_date' type='date' class='form-control' value='${new Date().toISOString().slice(0,10)}'></div>
      <div class='input-group'><span class='input-group-text'>Ø§Ù„ÙØ±Ø¹</span><input name='branch_code' class='form-control'></div>
      <div class='input-group'><span class='input-group-text'>Ø±Ø§ØªØ¨ Ø£Ø³Ø§Ø³ÙŠ</span><input name='base_salary' type='number' step='0.01' class='form-control' value='0'></div>
      <div class='d-flex gap-2 mt-2'><button class='btn btn-navy ripple' type='submit'>ğŸ’¾ Ø­ÙØ¸</button><a class='btn btn-outline-primary' href='/employees/create'>ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</a><button type='button' class='btn btn-outline-secondary' id='cancelAdd'>Ø¥Ù„ØºØ§Ø¡</button></div>
    </form>`; openSlideover(html); document.getElementById('cancelAdd').onclick=closeSlideover; const f=document.getElementById('addEmpForm'); f.onsubmit=async function(e){ e.preventDefault(); const fd=new FormData(f); const r=await fetch('/api/employees', { method:'POST', body:fd }); const j=await r.json(); if(j&&j.ok){ const tbody=document.querySelector('#panel-employees tbody'); const idx=tbody.children.length+1; const d=(fd.get('department')||'').toLowerCase(); const tr=document.createElement('tr'); tr.setAttribute('data-row','emp'); tr.setAttribute('data-id', String(j.id)); tr.setAttribute('data-dept', d); tr.innerHTML=`<td>${idx}</td><td>${fd.get('full_name')||''}</td><td>${fd.get('position')||''}</td><td>${fd.get('branch_code')||''}</td><td>${parseFloat(fd.get('base_salary')||0).toFixed(2)}</td><td>${(0).toFixed(2)}</td><td>${(0).toFixed(2)}</td><td>active</td><td><button class='btn btn-sm btn-outline-primary ops-btn'>â‹®</button><div class='ops-menu'><div class='it' data-op='edit'>ØªØ¹Ø¯ÙŠÙ„</div><div class='it' data-op='advance'>Ù…Ù†Ø­ Ø³Ù„ÙØ©</div><div class='it' data-op='pay'>Ø¯ÙØ¹ Ø±Ø§ØªØ¨</div><div class='it' data-op='journal'>Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚ÙŠØ¯</div><div class='it text-danger' data-op='delete'>Ø­Ø°Ù</div></div></td>`; tbody.appendChild(tr); showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù'); closeSlideover(); } else { showToast('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù'); } } }
  document.getElementById('btnAddEmp')?.addEventListener('click', function(ev){ ev.preventDefault(); openAddEmp(); });
  if(window.AUTO_OPEN_CREATE){ openAddEmp(); }
  try{lottie.loadAnimation({container:document.getElementById('lottieEmp'),renderer:'svg',loop:true,autoplay:true,path:'https://assets8.lottiefiles.com/packages/lf20_3rwasyjy.json'})}catch(e){}
  try{lottie.loadAnimation({container:document.getElementById('lottieSal'),renderer:'svg',loop:true,autoplay:true,path:'https://assets1.lottiefiles.com/packages/lf20_ujd3f9rs.json'})}catch(e){}
  try{lottie.loadAnimation({container:document.getElementById('lottieAdv'),renderer:'svg',loop:true,autoplay:true,path:'https://assets3.lottiefiles.com/packages/lf20_vfux7z1h.json'})}catch(e){}
  try{lottie.loadAnimation({container:document.getElementById('lottiePay'),renderer:'svg',loop:true,autoplay:true,path:'https://assets9.lottiefiles.com/packages/lf20_udydk9.json'})}catch(e){}
</script>
{% endblock %}
