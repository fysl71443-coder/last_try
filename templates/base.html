{% extends 'base.html' %}
{% set back_url = url_for('main.invoices', type=kind) %}

{% block title %}{{ _(title) }}{% endblock %}

{% block content %}
<div class="container py-4">

  {# === شعار الشركة الكبير أعلى الفاتورة === #}
  {% if settings and settings.logo_url %}
  <div class="text-center mb-3">
    <img src="{{ settings.logo_url }}" alt="Logo" style="height: 120px; width: auto; margin-bottom: 10px;">
  </div>
  {% endif %}

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">🧾 {{ _(title) }} — {{ inv.invoice_number }}</h3>
    <div class="d-flex gap-2">
      <a href="{{ url_for('main.invoices', type=kind) }}" class="btn btn-outline-secondary">⬅️ {{ _('Back / رجوع') }}</a>
      <a href="#" target="_blank" class="btn btn-success">🖨 {{ _('Print / طباعة') }}</a>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <div class="card p-3">
        <div><strong>{{ _('Date / التاريخ') }}</strong></div>
        <div>{{ inv.date }}</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <div><strong>{{ _('Party / الطرف') }}</strong></div>
        <div>{{ inv.customer_name or inv.supplier_name or '-' }}</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <div><strong>{{ _('Status / الحالة') }}</strong></div>
        <div>{{ inv.status }}</div>
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped">
          <thead class="table-dark">
            <tr>
              <th>#</th>
              <th>{{ _('Item / العنصر') }}</th>
              <th>{{ _('Qty / الكمية') }}</th>
              <th>{{ _('Price / السعر') }}</th>
              <th>{{ _('Tax / الضريبة') }}</th>
              <th>{{ _('Discount / الخصم') }}</th>
              <th>{{ _('Total / الإجمالي') }}</th>
            </tr>
          </thead>
          <tbody>
            {% for it in items %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ it.product_name or it.raw_material_name or it.description }}</td>
              <td>{{ it.quantity }}</td>
              <td>{{ '%.2f'|format(it.price_before_tax) if it.price_before_tax is not none else '-' }}</td>
              <td>{{ '%.2f'|format(it.tax) if it.tax is not none else '-' }}</td>
              <td>{{ '%.2f'|format(it.discount) if it.discount is not none else '0.00' }}</td>
              <td>{{ '%.2f'|format(it.total_price) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-md-3">
      <div class="card p-3">
        <div><strong>{{ _('Subtotal / المجموع') }}</strong></div>
        <div>{{ '%.2f'|format(inv.total_before_tax) }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <div><strong>{{ _('Tax / الضريبة') }}</strong></div>
        <div>{{ '%.2f'|format(inv.tax_amount) }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <div><strong>{{ _('Discount / الخصم') }}</strong></div>
        <div>{{ '%.2f'|format(inv.discount_amount) }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <div><strong>{{ _('Total / الإجمالي') }}</strong></div>
        <div>{{ '%.2f'|format(inv.total_after_tax_discount) }}</div>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-3">
    <div class="col-md-4">
      <div class="card p-3">
        <div><strong>{{ _('Paid / المدفوع') }}</strong></div>
        <div>{{ '%.2f'|format(paid) }}</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <div><strong>{{ _('Remaining / المتبقي') }}</strong></div>
        <div>{{ '%.2f'|format(remaining) }}</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <div class="d-flex gap-2">
          <button class="btn btn-success" onclick="payFull('{{ kind }}','{{ inv.id }}','{{ remaining }}')">{{ _('Pay Full') }}</button>
          <button class="btn btn-outline-success" onclick="payCustom('{{ kind }}','{{ inv.id }}','{{ remaining }}')">{{ _('Enter Amount') }}</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function sendPayment(kind, id, amount){
  if(!amount || parseFloat(amount)<=0){ alert('{{ _('Invalid amount / مبلغ غير صالح') }}'); return; }
  const form = new FormData();
  form.append('invoice_id', id);
  form.append('invoice_type', kind);
  form.append('amount', amount);
  const csrf = document.querySelector('input[name="csrf_token"]');
  if (csrf) form.append('csrf_token', csrf.value);
  fetch('#', { method:'POST', body: form, credentials:'same-origin' })
    .then(r=>r.json()).then(d=>{ if(d.status==='success') location.reload(); else alert('Error'); })
    .catch(()=>alert('Network error'));
}
function payFull(kind, id, remaining){
  const amt = parseFloat(remaining||0);
  if(!amt || amt<=0){ alert('{{ _('Nothing to pay / لا يوجد متبقي للدفع') }}'); return; }
  if(!confirm('{{ _('Confirm full payment / تأكيد دفع كامل') }}: '+amt)) return;
  sendPayment(kind, id, amt);
}
function payCustom(kind, id, remaining){
  const input = prompt("{{ _('Enter amount to pay / ادخل مبلغ الدفع') }}\n{{ _('Remaining / المتبقي') }}: "+remaining);
  if(!input) return;
  const amt = parseFloat((input||'').toString().replace(',', '.'));
  if(!amt || isNaN(amt) || amt<=0){ alert('{{ _('Invalid amount / مبلغ غير صالح') }}'); return; }
  sendPayment(kind, id, amt);
}
</script>
{% endblock %}
