{% extends 'base.html' %}
{% set back_url = url_for('main.invoices', type=kind) %}

{% block title %}{{ _(title) }}{% endblock %}

{% block content %}
<div class="container py-4">

  {# === Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„ÙƒØ¨ÙŠØ± Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø© === #}
  {% if settings and settings.logo_url %}
  <div class="text-center mb-3">
    <img src="{{ settings.logo_url }}" alt="Logo" style="height: 120px; width: auto; margin-bottom: 10px;">
  </div>
  {% endif %}

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">ğŸ§¾ {{ _(title) }} â€” {{ inv.invoice_number }}</h3>
    <div class="d-flex gap-2">
      <a href="{{ url_for('main.invoices', type=kind) }}" class="btn btn-outline-secondary">â¬…ï¸ {{ _('Back / Ø±Ø¬ÙˆØ¹') }}</a>
      <a href="#" target="_blank" class="btn btn-success">ğŸ–¨ {{ _('Print / Ø·Ø¨Ø§Ø¹Ø©') }}</a>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <div class="card p-3">
        <div><strong>{{ _('Date / Ø§Ù„ØªØ§Ø±ÙŠØ®') }}</strong></div>
        <div>{{ inv.date }}</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <div><strong>{{ _('Party / Ø§Ù„Ø·Ø±Ù') }}</strong></div>
        <div>{{ inv.customer_name or inv.supplier_name or '-' }}</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <div><strong>{{ _('Status / Ø§Ù„Ø­Ø§Ù„Ø©') }}</strong></div>
        <div>{{ inv.status }}</div>
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped">
          <thead class="table-dark">
            <tr>
              <th>#</th>
              <th>{{ _('Item / Ø§Ù„Ø¹Ù†ØµØ±') }}</th>
              <th>{{ _('Qty / Ø§Ù„ÙƒÙ…ÙŠØ©') }}</th>
              <th>{{ _('Price / Ø§Ù„Ø³Ø¹Ø±') }}</th>
              <th>{{ _('Tax / Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©') }}</th>
              <th>{{ _('Discount / Ø§Ù„Ø®ØµÙ…') }}</th>
              <th>{{ _('Total / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ') }}</th>
            </tr>
          </thead>
          <tbody>
            {% for it in items %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ it.product_name or it.raw_material_name or it.description }}</td>
              <td>{{ it.quantity }}</td>
              <td>{{ '%.2f'|format(it.price_before_tax) if it.price_before_tax is not none else '-' }}</td>
              <td>{{ '%.2f'|format(it.tax) if it.tax is not none else '-' }}</td>
              <td>{{ '%.2f'|format(it.discount) if it.discount is not none else '0.00' }}</td>
              <td>{{ '%.2f'|format(it.total_price) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-md-3">
      <div class="card p-3">
        <div><strong>{{ _('Subtotal / Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹') }}</strong></div>
        <div>{{ '%.2f'|format(inv.total_before_tax) }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <div><strong>{{ _('Tax / Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©') }}</strong></div>
        <div>{{ '%.2f'|format(inv.tax_amount) }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <div><strong>{{ _('Discount / Ø§Ù„Ø®ØµÙ…') }}</strong></div>
        <div>{{ '%.2f'|format(inv.discount_amount) }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <div><strong>{{ _('Total / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ') }}</strong></div>
        <div>{{ '%.2f'|format(inv.total_after_tax_discount) }}</div>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-3">
    <div class="col-md-4">
      <div class="card p-3">
        <div><strong>{{ _('Paid / Ø§Ù„Ù…Ø¯ÙÙˆØ¹') }}</strong></div>
        <div>{{ '%.2f'|format(paid) }}</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <div><strong>{{ _('Remaining / Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ') }}</strong></div>
        <div>{{ '%.2f'|format(remaining) }}</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <div class="d-flex gap-2">
          <button class="btn btn-success" onclick="payFull('{{ kind }}','{{ inv.id }}','{{ remaining }}')">{{ _('Pay Full') }}</button>
          <button class="btn btn-outline-success" onclick="payCustom('{{ kind }}','{{ inv.id }}','{{ remaining }}')">{{ _('Enter Amount') }}</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function sendPayment(kind, id, amount){
  if(!amount || parseFloat(amount)<=0){ alert('{{ _('Invalid amount / Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­') }}'); return; }
  const form = new FormData();
  form.append('invoice_id', id);
  form.append('invoice_type', kind);
  form.append('amount', amount);
  const csrf = document.querySelector('input[name="csrf_token"]');
  if (csrf) form.append('csrf_token', csrf.value);
  fetch('#', { method:'POST', body: form, credentials:'same-origin' })
    .then(r=>r.json()).then(d=>{ if(d.status==='success') location.reload(); else alert('Error'); })
    .catch(()=>alert('Network error'));
}
function payFull(kind, id, remaining){
  const amt = parseFloat(remaining||0);
  if(!amt || amt<=0){ alert('{{ _('Nothing to pay / Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø¯ÙØ¹') }}'); return; }
  if(!confirm('{{ _('Confirm full payment / ØªØ£ÙƒÙŠØ¯ Ø¯ÙØ¹ ÙƒØ§Ù…Ù„') }}: '+amt)) return;
  sendPayment(kind, id, amt);
}
function payCustom(kind, id, remaining){
  const input = prompt("{{ _('Enter amount to pay / Ø§Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹') }}\n{{ _('Remaining / Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ') }}: "+remaining);
  if(!input) return;
  const amt = parseFloat((input||'').toString().replace(',', '.'));
  if(!amt || isNaN(amt) || amt<=0){ alert('{{ _('Invalid amount / Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­') }}'); return; }
  sendPayment(kind, id, amt);
}
</script>
{% endblock %}
