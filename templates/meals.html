{% extends 'base.html' %}
{% if current_user.is_authenticated %}{% set back_url = url_for('inventory.inventory') %}{% else %}{% set back_url = '#' %}{% endif %}

{% block title %}{{ _('Meals Management') }}{% endblock %}
{% block content %}

<style>
body { background: var(--bg, #f8fafc); }
.ingredient-row {
  border: 1px solid #e9ecef;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 0.5rem;
  background: #f8f9fa;
}
.cost-display {
  background: #e8f5e8;
  border: 1px solid #4caf50;
  border-radius: 5px;
  padding: 0.5rem;
  text-align: center;
  font-weight: bold;
  color: #2e7d32;
}
.profit-margin {
  background: #fff3e0;
  border: 1px solid #ff9800;
  border-radius: 5px;
  padding: 0.5rem;
  text-align: center;
  font-weight: bold;
  color: #f57c00;
}
.selling-price {
  background: #e3f2fd;
  border: 1px solid #2196f3;
  border-radius: 5px;
  padding: 0.5rem;
  text-align: center;
  font-weight: bold;
  color: #1976d2;
}
</style>

<div class="container py-4 ops-layout hub-wrap">
  <div class="ops-header-bar">
    <span class="ops-icon"><i class="fa-solid fa-utensils"></i></span>
    <div>
      <h1 class="ops-title mb-0">{{ _('Meals Management') }}</h1>
      <span class="ops-subtitle">{{ _('Manage meals, ingredients and cost') }}</span>
    </div>
    <div class="ops-actions d-flex flex-wrap gap-2">
      <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#importModal"><i class="fa-solid fa-file-import me-1"></i>{{ _('Import Meals') }}</button>
      <a href="{{ url_for('main.dashboard') }}" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-house me-1"></i>{{ _('Dashboard') }}</a>
      <a href="{{ url_for('purchases.raw_materials') }}" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-bowl-food me-1"></i>{{ _('Raw Materials') }}</a>
      <a href="{{ url_for('inventory.inventory') }}" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-boxes-stacked me-1"></i>{{ _('Inventory') }}</a>
    </div>
  </div>

  <div class="ops-body ops-body-no-sidebar">
    <main class="ops-main">
  <div class="ops-form-card mt-0">
    <div class="ops-form-head">{{ _('Create New Meal') }}</div>
    <div class="ops-form-body">
        {% if form %}
        <form method="POST" id="meal-form">
            {{ form.hidden_tag() }}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>


            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙˆØ¬Ø¨Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
            <div class="row mb-3">
                <div class="col-md-3">
                    {{ form.name.label(class_='form-label') }}
                    {{ form.name(class_='form-control') }}
                </div>
                <div class="col-md-3">
                    {{ form.name_ar.label(class_='form-label') }}
                    {{ form.name_ar(class_='form-control') }}
                </div>
                <div class="col-md-3">
                    {{ form.category.label(class_='form-label') }}
                    {{ form.category(class_='form-control') }}
                </div>
                <div class="col-md-3">
                    {{ form.profit_margin_percent.label(class_='form-label') }}
                    {{ form.profit_margin_percent(class_='form-control', step='0.01') }}
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-12">
                    {{ form.description.label(class_='form-label') }}
                    {{ form.description(class_='form-control') }}
                </div>
            </div>

            <!-- Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„ÙˆØ¬Ø¨Ø© -->
            <h6 class="mb-3">{{ _('Meal Ingredients') }}</h6>
            <div id="ingredients-container">
                {% for ingredient_form in form.ingredients %}
                <div class="ingredient-row">
                    <div class="row">
                        <div class="col-md-6">
                            {{ ingredient_form.raw_material_id.label(class_='form-label') }}
                            {{ ingredient_form.raw_material_id(class_='form-select') }}
                        </div>
                        <div class="col-md-3">
                            {{ ingredient_form.quantity.label(class_='form-label') }}
                            {{ ingredient_form.quantity(class_='form-control', step='0.0001') }}
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">{{ _('Cost') }}</label>
                            <div class="cost-display ingredient-cost">$0.0000</div>
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="button" class="btn btn-danger btn-sm remove-ingredient-btn">âˆ’</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Ù…Ù„Ø®Øµ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label">{{ _('Total Cost') }}</label>
                    <div class="cost-display" id="total-cost">$0.00</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">{{ _('Profit Margin') }}</label>
                    <div class="profit-margin" id="profit-amount">$0.00</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">{{ _('Selling Price') }}</label>
                    <div class="selling-price" id="selling-price">$0.00</div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <button type="button" class="btn btn-secondary" id="add-ingredient">
                        â• {{ _('Add Ingredient') }}
                    </button>
                </div>
                <div class="col-md-6 text-end">
                    {{ form.submit(class_='btn btn-primary btn-lg') }}
                </div>
            </div>
        </form>
        {% else %}
        <div class="alert alert-warning mb-0">
            {{ _('The meal form is not available yet in this build. The page is shown for preview only.') }}
        </div>
        {% endif %}
    </div>
  </div>

  {% if meals %}
  <div class="ops-form-card">
    <div class="ops-form-head">{{ _('Existing Meals') }}</div>
    <div class="ops-form-body p-0">
      <div class="table-responsive screen-table-wrap">
            <table class="table table-hover screen-table mb-0">
                <thead>
                    <tr>
                        <th>{{ _('Meal Name') }}</th>
                        <th>{{ _('Category') }}</th>
                        <th>{{ _('Total Cost') }}</th>
                        <th>{{ _('Profit Margin') }}</th>
                        <th>{{ _('Selling Price') }}</th>
                        <th>{{ _('Ingredients') }}</th>
                        <th>{{ _('Actions') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for meal in meals %}
                    <tr>
                        <td><strong>{{ meal.display_name }}</strong></td>
                        <td>{{ meal.category or '-' }}</td>
                        <td class="cost-highlight">${{ "%.2f"|format(meal.total_cost) }}</td>
                        <td>{{ "%.1f"|format(meal.profit_margin_percent) }}%</td>
                        <td class="selling-price"><strong>${{ "%.2f"|format(meal.selling_price) }}</strong></td>
                        <td>
                            <small>{{ meal.ingredients|length }} {{ _('ingredients') }}</small>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" onclick="viewMeal({{ meal.id }})">
                                ğŸ‘ {{ _('View') }}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteMeal({{ meal.id }}, '{{ meal.display_name }}')">
                                ğŸ—‘ï¸ {{ _('Delete') }}
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
  </div>
  {% endif %}
    </main>
  </div>
</div>

<!-- SocketIO and JavaScript -->
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
    // Materials data for calculations
    const materials = {{ materials_json | default('[]') | safe }};

    // SocketIO for real-time updates
    var socket = io();
    socket.on('meal_update', function(data) {
        console.log('Meal updated:', data);
        alert('New meal created: ' + data.meal_name + ' - Cost: $' + data.total_cost + ' - Price: $' + data.selling_price);
        location.reload();
    });

    // Auto-calculation functionality
    function calculateCosts() {
        let totalCost = 0;

        document.querySelectorAll('.ingredient-row').forEach(row => {
            const materialSelect = row.querySelector('select[name$="-raw_material_id"]');
            const quantityInput = row.querySelector('input[name$="-quantity"]');
            const costDisplay = row.querySelector('.ingredient-cost');

            const materialId = parseInt(materialSelect.value);
            const quantity = parseFloat(quantityInput.value) || 0;

            const material = materials.find(m => m.id === materialId);
            let ingredientCost = 0;

            if (material && quantity > 0) {
                ingredientCost = material.cost_per_unit * quantity;
                costDisplay.textContent = '$' + ingredientCost.toFixed(4);
                totalCost += ingredientCost;
            } else {
                costDisplay.textContent = '$0.0000';
            }
        });

        // Update total cost
        document.getElementById('total-cost').textContent = '$' + totalCost.toFixed(2);

        // Calculate profit and selling price
        const profitMargin = parseFloat(document.querySelector('input[name="profit_margin_percent"]').value) || 0;
        const profitAmount = totalCost * (profitMargin / 100);
        const sellingPrice = totalCost + profitAmount;

        document.getElementById('profit-amount').textContent = '$' + profitAmount.toFixed(2);
        document.getElementById('selling-price').textContent = '$' + sellingPrice.toFixed(2);
    }

    // Event listeners for auto-calculation
    document.addEventListener('change', e => {
        if (e.target.matches('select[name$="-raw_material_id"], input[name$="-quantity"], input[name="profit_margin_percent"]')) {
            calculateCosts();
        }
    });

    // Add new ingredient functionality
    let ingredientIndex = {{ (form.ingredients|length) if form else 0 }};

    document.getElementById('add-ingredient').addEventListener('click', function() {
        const container = document.getElementById('ingredients-container');
        const newIngredient = document.createElement('div');
        newIngredient.className = 'ingredient-row';
        newIngredient.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">{{ _('Ingredient') }}</label>
                    <select class="form-select" name="ingredients-${ingredientIndex}-raw_material_id">
                        <option value="0">{{ _('Select Ingredient') }}</option>
                        ${materials.map(m => `<option value="${m.id}">${m.name}</option>`).join('')}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">{{ _('Quantity') }}</label>
                    <input class="form-control" name="ingredients-${ingredientIndex}-quantity" step="0.0001" type="number">
                </div>
                <div class="col-md-2">
                    <label class="form-label">{{ _('Cost') }}</label>
                    <div class="cost-display ingredient-cost">$0.0000</div>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-danger btn-sm remove-ingredient-btn">âˆ’</button>
                </div>
            </div>
        `;
        container.appendChild(newIngredient);
        ingredientIndex++;
    });

    // Remove ingredient functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-ingredient-btn')) {
            e.target.closest('.ingredient-row').remove();
            calculateCosts();
        }
    });

    // View meal details
    function viewMeal(mealId) {
        alert('Meal details for ID: ' + mealId + ' (Feature coming soon)');
    }

    async function deleteMeal(mealId, mealName) {
        if (!confirm('{{ _("Are you sure you want to delete") }} "' + mealName + '"?\n\n{{ _("This action cannot be undone. If the meal has sales history, it will be deactivated instead.") }}')) {
            return;
        }

        const password = prompt('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø­Ø°Ù Ø§Ù„ÙˆØ¬Ø¨Ø© (1991):');
        if (!password) return;

        try {
            const res = await fetch(`/api/meals/${mealId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrf()
                },
                body: JSON.stringify({ password })
            });

            const data = await res.json();
            if (!data.ok) {
                alert(data.error === 'invalid_password' ? 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©' : data.error);
                return;
            }

            if (data.deactivated) {
                alert('ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙˆØ¬Ø¨Ø© (Ù„Ù‡Ø§ ØªØ§Ø±ÙŠØ® Ù…Ø¨ÙŠØ¹Ø§Øª)');
            } else {
                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ¬Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­');
            }
            location.reload();
        } catch (error) {
            console.error('Error:', error);
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù');
        }
    }

    async function deleteAllMeals() {
        const ok = confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ');
        if (!ok) return;

        const password = prompt('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª (1991):');
        if (!password) return;

        try {
            const res = await fetch('/api/meals/delete-all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrf()
                },
                body: JSON.stringify({ password })
            });

            const data = await res.json();
            if (!data.ok) {
                alert(data.error === 'invalid_password' ? 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©' : data.error);
                return;
            }

            alert(`ØªÙ… Ø­Ø°Ù ${data.deleted} ÙˆØ¬Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­`);
            location.reload();
        } catch (error) {
            console.error('Error:', error);
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù');
        }
    }

    // Initial calculation
    document.addEventListener('DOMContentLoaded', function() {
        calculateCosts();
    });
</script>

<!-- Import Meals Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{{ url_for('purchases.meals_import') }}" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-header">
                    <h5 class="modal-title">{{ _('Import Meals') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">{{ _('Select File') }}</label>
                        <input type="file" name="file" class="form-control" accept=".xlsx,.xls,.csv" required>
                        <div class="form-text">{{ _('Supported formats: Excel (.xlsx, .xls), CSV') }}</div>
                    </div>
                    <div class="alert alert-info">
                        <strong>{{ _('Required columns') }}:</strong><br>
                        {{ _('Name, Name (Arabic), Selling Price') }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-success">{{ _('Import') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}
