{% extends "base.html" %}
{% block content %}
<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">ğŸ“˜ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
    <div class="d-flex gap-2">
      <a href="{{ url_for('journal.new_entry') }}" class="btn btn-primary">â• Ù‚ÙŠØ¯ Ø¬Ø¯ÙŠØ¯</a>
      <a href="{{ url_for('journal.list_entries') }}" class="btn btn-outline-secondary">ğŸ“„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</a>
      <a href="{{ url_for('journal.backfill_missing_all') }}" class="btn btn-outline-dark">âš™ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</a>
      <a href="{{ url_for('main.chart_of_accounts') }}" class="btn btn-outline-dark">ğŸŒ³ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</a>
      <a href="{{ url_for('journal.print_all_pdf') }}?branch={{ branch }}&q={{ request.args.get('q') or '' }}&start_date={{ request.args.get('start_date') or '' }}&end_date={{ request.args.get('end_date') or '' }}" target="_blank" class="btn btn-success">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙƒÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ (PDF)</a>
      <a href="{{ url_for('journal.export_all') }}?branch={{ branch }}&q={{ request.args.get('q') or '' }}&start_date={{ request.args.get('start_date') or '' }}&end_date={{ request.args.get('end_date') or '' }}" class="btn btn-outline-success">ğŸ“¥ ØªØµØ¯ÙŠØ± XLS</a>
    </div>
  </div>

  {% if mode == 'list' %}
  <form method="get" class="row g-2 align-items-end mb-3" id="journalFilters">
    <div class="col-auto">
      <label class="form-label mb-0">Ø§Ù„ÙØ±Ø¹</label>
      <select class="form-select" name="branch" style="min-width:180px">
        <option value="all" {% if branch=='all' %}selected{% endif %}>Ø§Ù„ÙƒÙ„</option>
        <option value="china_town" {% if branch=='china_town' %}selected{% endif %}>China Town</option>
        <option value="place_india" {% if branch=='place_india' %}selected{% endif %}>Place India</option>
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label mb-0">Ø¨Ø­Ø«</label>
      <input type="text" class="form-control" name="q" value="{{ request.args.get('q') or '' }}" placeholder="ÙˆØµÙ Ø§Ù„Ù‚ÙŠØ¯">
    </div>
    <div class="col-auto">
      <label class="form-label mb-0">Ù…Ù†</label>
      <input type="date" class="form-control" name="start_date" value="{{ request.args.get('start_date') or '' }}">
    </div>
    <div class="col-auto">
      <label class="form-label mb-0">Ø¥Ù„Ù‰</label>
      <input type="date" class="form-control" name="end_date" value="{{ request.args.get('end_date') or '' }}">
    </div>
    <div class="col-auto">
      <label class="form-label mb-0">Ø¹Ø¯Ø¯ Ù„ÙƒÙ„ ØµÙØ­Ø©</label>
      {% set _pp = (request.args.get('per_page') or '50') %}
      <select class="form-select" name="per_page">
        <option value="20" {% if _pp=='20' %}selected{% endif %}>20</option>
        <option value="50" {% if _pp=='50' %}selected{% endif %}>50</option>
        <option value="100" {% if _pp=='100' %}selected{% endif %}>100</option>
        <option value="200" {% if _pp=='200' %}selected{% endif %}>200</option>
        <option value="500" {% if _pp=='500' %}selected{% endif %}>500</option>
        <option value="all" {% if _pp=='all' %}selected{% endif %}>Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</option>
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label mb-0">Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙŠØ¯</label>
      {% set _type = (request.args.get('type') or '').lower() %}
      <select class="form-select" name="type" style="min-width:160px">
        <option value="">Ø§Ù„ÙƒÙ„</option>
        <option value="sales" {% if _type=='sales' %}selected{% endif %}>Ù…Ø¨ÙŠØ¹Ø§Øª</option>
        <option value="purchase" {% if _type=='purchase' %}selected{% endif %}>Ù…Ø´ØªØ±ÙŠØ§Øª</option>
        <option value="expense" {% if _type=='expense' %}selected{% endif %}>Ù…ØµØ±ÙˆÙØ§Øª</option>
        <option value="salary" {% if _type=='salary' %}selected{% endif %}>Ø±ÙˆØ§ØªØ¨</option>
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label mb-0">Ø§Ù„Ø­Ø§Ù„Ø©</label>
      {% set _status = (request.args.get('status') or '').lower() %}
      <select class="form-select" name="status" style="min-width:140px">
        <option value="">Ø§Ù„ÙƒÙ„</option>
        <option value="posted" {% if _status=='posted' %}selected{% endif %}>Ù…Ø±Ø­Ù‘Ù„</option>
        <option value="draft" {% if _status=='draft' %}selected{% endif %}>Ù…Ø³ÙˆØ¯Ø©</option>
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label mb-0">Ø§Ù„Ù…ÙˆØ¸Ù</label>
      <select class="form-select" name="emp_id" style="min-width:200px">
        <option value="">Ø§Ù„ÙƒÙ„</option>
        {% for e in employees %}
        <option value="{{ e.id }}" {% if (request.args.get('emp_id')|int) == e.id %}selected{% endif %}>{{ e.full_name }}</option>
        {% endfor %}
      </select>
    </div>
  </form>
  <div class="d-flex gap-2 mb-3">
    <a href="{{ url_for('main.chart_of_accounts') }}" class="btn btn-outline-dark">ğŸŒ³ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</a>
  </div>

  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>#</th>
          <th>Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø§Ù„ÙØ±Ø¹</th>
          <th>Ø§Ù„ÙˆØµÙ</th>
          <th>Ù…Ø¯ÙŠÙ†</th>
          <th>Ø¯Ø§Ø¦Ù†</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody>
        {% for e in entries %}
        <tr>
          <td>{{ e.id }}</td>
          <td>{{ e.entry_number }}</td>
          <td>{{ e.date }}</td>
          <td>{{ e.branch_code or '-' }}</td>
          <td>{{ e.description }}</td>
          <td>{{ '%.2f'|format(e.total_debit or 0) }}</td>
          <td>{{ '%.2f'|format(e.total_credit or 0) }}</td>
          <td><span class="badge {% if e.status=='posted' %}bg-success{% else %}bg-secondary{% endif %}">{{ e.status }}</span></td>
          <td>
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('journal.edit_entry', jid=e.id) }}">ÙØªØ­</a>
            <form method="POST" action="{{ url_for('journal.delete_entry', jid=e.id) }}" style="display:inline" onsubmit="return confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚ÙŠØ¯ØŸ');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn btn-sm btn-outline-danger">Ø­Ø°Ù</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="d-flex justify-content-between align-items-center mt-2">
    <div>ØµÙØ­Ø© {{ page }} / {{ pages }} â€” Ø¥Ø¬Ù…Ø§Ù„ÙŠ {{ total }}</div>
    <div class="d-flex gap-2">
      <a class="btn btn-sm btn-outline-dark" href="{{ url_for('main.chart_of_accounts') }}">ğŸŒ³ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</a>
      {% if page > 1 %}
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('journal.list_entries', page=page-1, branch=branch, q=request.args.get('q') or '', start_date=request.args.get('start_date') or '', end_date=request.args.get('end_date') or '', per_page=request.args.get('per_page') or '50') }}">Ø§Ù„Ø³Ø§Ø¨Ù‚</a>
      {% endif %}
      {% if page < pages %}
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('journal.list_entries', page=page+1, branch=branch, q=request.args.get('q') or '', start_date=request.args.get('start_date') or '', end_date=request.args.get('end_date') or '', per_page=request.args.get('per_page') or '50') }}">Ø§Ù„ØªØ§Ù„ÙŠ</a>
      {% endif %}
    </div>
  </div>
  {% endif %}

  {% if mode in ['new','edit'] %}
  <form method="post" enctype="multipart/form-data" class="card">
    <div class="card-body">
      <div class="row g-2 mb-3">
        <div class="col-md-3">
          <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚ÙŠØ¯</label>
          <input type="date" class="form-control" name="date" value="{{ (entry.date if entry else today) or '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Ø§Ù„ÙØ±Ø¹</label>
          <select class="form-select" name="branch">
            <option value="">-</option>
            <option value="china_town" {% if entry and entry.branch_code=='china_town' %}selected{% endif %}>China Town</option>
            <option value="place_india" {% if entry and entry.branch_code=='place_india' %}selected{% endif %}>Place India</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">ÙˆØµÙ Ø§Ù„Ù‚ÙŠØ¯</label>
          <input type="text" class="form-control" name="description" value="{{ entry.description if entry else '' }}" required>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered align-middle" id="lines-table">
          <thead class="table-light">
            <tr>
              <th style="width:40px">#</th>
              <th style="min-width:220px">Ø§Ù„Ø­Ø³Ø§Ø¨</th>
              <th style="width:140px">Ù…Ø¯ÙŠÙ†</th>
              <th style="width:140px">Ø¯Ø§Ø¦Ù†</th>
              <th style="min-width:180px">Ù…Ø±ÙƒØ² ØªÙƒÙ„ÙØ©</th>
              <th style="min-width:220px">ÙˆØµÙ Ø§Ù„Ø³Ø·Ø±</th>
              <th style="min-width:160px">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø·Ø±</th>
              <th style="min-width:180px">Ø§Ù„Ù…ÙˆØ¸Ù</th>
              <th style="min-width:160px">Ù…Ø±ÙÙ‚</th>
              <th style="width:80px">Ø¥Ø²Ø§Ù„Ø©</th>
            </tr>
          </thead>
          <tbody>
            {% set lines = entry.lines if entry else [] %}
            {% if not lines %}
            {% set lines = [None, None] %}
            {% endif %}
            {% for ln in lines %}
            {% set idx = loop.index0 %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>
                <select class="form-select account-select" name="lines-{{ idx }}-account_id" data-current="{{ ln.account_id if ln else '' }}" required>
                  <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨</option>
                </select>
              </td>
              <td><input type="number" step="0.01" class="form-control" name="lines-{{ idx }}-debit" value="{{ ln.debit if ln else '' }}"></td>
              <td><input type="number" step="0.01" class="form-control" name="lines-{{ idx }}-credit" value="{{ ln.credit if ln else '' }}"></td>
              <td><input type="text" class="form-control" name="lines-{{ idx }}-cost_center" value="{{ ln.cost_center if ln else '' }}"></td>
              <td><input type="text" class="form-control" name="lines-{{ idx }}-description" value="{{ ln.description if ln else '' }}" required></td>
              <td><input type="date" class="form-control" name="lines-{{ idx }}-date" value="{{ ln.line_date if ln else '' }}"></td>
              <td>
                <select class="form-select employee-select" name="lines-{{ idx }}-employee_id" data-current="{{ ln.employee_id if ln else '' }}">
                  <option value="">-</option>
                </select>
              </td>
              <td><input type="file" class="form-control" name="lines-{{ idx }}-attachment"></td>
              <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Ø­Ø°Ù</button></td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr>
              <th colspan="2" class="text-end">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
              <th id="total-debit">0.00</th>
              <th id="total-credit">0.00</th>
              <th colspan="6"></th>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="d-flex justify-content-between">
        {% if mode=='edit' %}
        <div>
          {% if entry.status != 'posted' %}
          <button formaction="{{ url_for('journal.post_entry', jid=entry.id) }}" class="btn btn-warning">ØªØ±Ø­ÙŠÙ„</button>
          {% endif %}
          <form method="POST" action="{{ url_for('journal.delete_entry', jid=entry.id) }}" style="display:inline" onsubmit="return confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚ÙŠØ¯ØŸ');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-outline-danger">Ø­Ø°Ù Ø§Ù„Ù‚ÙŠØ¯</button>
          </form>
        </div>
        {% endif %}
        <div>
          <button type="submit" class="btn btn-success">Ø­ÙØ¸</button>
        </div>
      </div>
    </div>
  </form>
  {% endif %}
</div>

<script>
(function(){
  const f = document.getElementById('journalFilters');
  if(!f) return;
  function apply(){
    const params = new URLSearchParams(window.location.search);
    ['branch','q','start_date','end_date','per_page','type','status','emp_id'].forEach(name=>{
      const el = f.querySelector(`[name="${name}"]`);
      if(el){ params.set(name, el.value || ''); }
    });
    window.location.search = params.toString();
  }
  f.querySelectorAll('select,input').forEach(el=>{
    el.addEventListener('change', apply);
  });
})();
</script>

<script>
function removeRow(btn){ const tr = btn.closest('tr'); tr.parentNode.removeChild(tr); recalcTotals(); }
function recalcTotals(){
  const table = document.getElementById('lines-table');
  if(!table) return;
  let td=0, tc=0;
  table.querySelectorAll('tbody tr').forEach(tr=>{
    const d = parseFloat((tr.querySelector('[name$="-debit"]').value||'0').toString());
    const c = parseFloat((tr.querySelector('[name$="-credit"]').value||'0').toString());
    td += isNaN(d)?0:d; tc += isNaN(c)?0:c;
  });
  const tdEl = document.getElementById('total-debit');
  const tcEl = document.getElementById('total-credit');
  if(!tdEl || !tcEl) return;
  tdEl.innerText = td.toFixed(2);
  tcEl.innerText = tc.toFixed(2);
}
document.addEventListener('input', (e)=>{ const n=(e.target&&e.target.name)||''; if(n.endsWith('-debit')||n.endsWith('-credit')) recalcTotals(); });
let _employeesLoaded=false; async function loadEmployees(){ if(_employeesLoaded) return; try{ const r=await fetch('/journal/employees'); const arr=await r.json(); document.querySelectorAll('.employee-select').forEach(sel=>{ const cur=sel.getAttribute('data-current')||''; arr.forEach(o=>{ const opt=document.createElement('option'); opt.value=o.id; opt.textContent=o.full_name; sel.appendChild(opt); }); if(cur){ sel.value=cur; } }); _employeesLoaded=true; }catch(e){} }
let _accountsLoaded=false; async function loadAccounts(){ if(_accountsLoaded) return; try{ const r=await fetch('/journal/accounts'); const arr=await r.json(); document.querySelectorAll('.account-select').forEach(sel=>{ const cur=sel.getAttribute('data-current')||''; arr.forEach(o=>{ const opt=document.createElement('option'); opt.value=o.id; opt.textContent=`${o.code} â€“ ${o.name}`; sel.appendChild(opt); }); if(cur){ sel.value=cur; } }); _accountsLoaded=true; }catch(e){} }
document.addEventListener('DOMContentLoaded', ()=>{ loadEmployees(); loadAccounts(); });
let _dirty=false; if({{ 'true' if mode in ['new','edit'] else 'false' }}){
  document.addEventListener('input', ()=>{_dirty=true});
  const form=document.querySelector('form.card');
  if(form){ form.addEventListener('submit', ()=>{_dirty=false}); }
  window.addEventListener('beforeunload', (e)=>{ if(_dirty){ e.preventDefault(); e.returnValue=''; } });
}
document.addEventListener('DOMContentLoaded', recalcTotals);
</script>

{% if mode == 'list' %}
<script>
(function(){
  let lastId = 0;
  try{
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(r=>{ const t=r.querySelector('td'); const v=parseInt((t&&t.textContent)||'0'); if(!isNaN(v)&&v>lastId) lastId=v; });
  }catch(e){ lastId = 0; }
  async function ping(){
    try{
      const r = await fetch('/journal/latest_meta', { credentials:'same-origin' });
      const j = await r.json();
      if(j && j.ok){
        if(parseInt(j.latest_id||0) > lastId || parseInt(j.count||0) !== document.querySelectorAll('tbody tr').length){
          window.location.reload();
        }
      }
    }catch(e){}
  }
  setInterval(ping, 8000);
})();
</script>
{% endif %}
{% endblock %}
