{% extends 'base.html' %}
{% block title %}{{ _('Salaries / Ø§Ù„Ø±ÙˆØ§ØªØ¨') }}{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="section-header mb-3">
    <h3 class="mb-0">ğŸ’µ {{ _('Salaries / Ø§Ù„Ø±ÙˆØ§ØªØ¨') }}</h3>
    <div class="d-flex gap-2">
      <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">ğŸ  {{ _('Dashboard / Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…') }}</a>
    </div>
  </div>

  <style>
    .table thead th{position:sticky;top:0;z-index:1}
  </style>

  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label">{{ _('Month / Ø§Ù„Ø´Ù‡Ø±') }}</label>
          <input type="month" class="form-control" id="filter_month">
        </div>
        <div class="col-md-3">
          <label class="form-label">{{ _('Status / Ø§Ù„Ø­Ø§Ù„Ø©') }}</label>
          <select class="form-select" id="filter_status">
            <option value="all">{{ _('All / Ø§Ù„ÙƒÙ„') }}</option>
            <option value="due">{{ _('Due / Ù…Ø³ØªØ­Ù‚') }}</option>
            <option value="partial">{{ _('Partial / Ø¬Ø²Ø¦ÙŠ') }}</option>
            <option value="paid">{{ _('Paid / Ù…Ø¯ÙÙˆØ¹') }}</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">{{ _('Employee / Ø§Ù„Ù…ÙˆØ¸Ù') }}</label>
          <select class="form-select" id="filter_emp">
            <option value="">{{ _('All / Ø§Ù„ÙƒÙ„') }}</option>
            {% for e in form.employee_id.choices %}
            <option value="{{ e[0] }}">{{ e[1] }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">{{ _('Search / Ø¨Ø­Ø«') }}</label>
          <input type="text" class="form-control" id="filter_q" placeholder="{{ _('Employee name / Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù') }}">
        </div>
        <div class="col-md-3 text-end">
          <button class="btn btn-primary" id="btnRefresh">ğŸ”„ {{ _('Refresh / ØªØ­Ø¯ÙŠØ«') }}</button>
          <a class="btn btn-outline-primary" id="btnPrint" target="_blank">ğŸ§¾ {{ _('Print / Ø·Ø¨Ø§Ø¹Ø©') }}</a>
          <button class="btn btn-outline-success" id="btnCSV">ğŸ“„ {{ _('CSV') }}</button>
          <button class="btn btn-warning" id="btnBulkPay">ğŸ’³ {{ _('Bulk Pay / Ø³Ø¯Ø§Ø¯ Ø¬Ù…Ø§Ø¹ÙŠ') }}</button>
        </div>
      </div>
      <div class="row mt-3 g-3" id="summaryRow">
        <div class="col-6 col-md-3"><div class="p-3 border rounded"><div class="fw-bold">{{ _('Basic / Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ') }}</div><div id="sum_basic">0.00</div></div></div>
        <div class="col-6 col-md-3"><div class="p-3 border rounded"><div class="fw-bold">{{ _('Allowances / Ø§Ù„Ø¨Ø¯Ù„Ø§Øª') }}</div><div id="sum_allow">0.00</div></div></div>
        <div class="col-6 col-md-3"><div class="p-3 border rounded"><div class="fw-bold">{{ _('Deductions / Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª') }}</div><div id="sum_ded">0.00</div></div></div>
        <div class="col-6 col-md-3"><div class="p-3 border rounded"><div class="fw-bold">{{ _('Prev Due / Ø³Ø§Ø¨Ù‚Ø©') }}</div><div id="sum_prev">0.00</div></div></div>
        <div class="col-6 col-md-3"><div class="p-3 border rounded"><div class="fw-bold">{{ _('Total / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ') }}</div><div id="sum_total">0.00</div></div></div>
        <div class="col-6 col-md-3"><div class="p-3 border rounded"><div class="fw-bold">{{ _('Paid / Ø§Ù„Ù…Ø¯ÙÙˆØ¹') }}</div><div id="sum_paid">0.00</div></div></div>
        <div class="col-6 col-md-3"><div class="p-3 border rounded"><div class="fw-bold">{{ _('Remaining / Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ') }}</div><div id="sum_remaining">0.00</div></div></div>
      </div>
      <div class="mt-3">
        <ul class="nav nav-pills" id="monthViews" role="tablist">
          <li class="nav-item" role="presentation"><button class="nav-link active" id="tabPayroll" data-bs-toggle="pill" data-bs-target="#panePayroll" type="button" role="tab">{{ _('Payroll Statement / ÙƒØ´Ù Ø§Ù„Ø±ÙˆØ§ØªØ¨') }}</button></li>
          <li class="nav-item" role="presentation"><button class="nav-link" id="tabAdv" data-bs-toggle="pill" data-bs-target="#paneAdv" type="button" role="tab">{{ _('Advances Statement / ÙƒØ´Ù Ø§Ù„Ø³Ù„Ù') }}</button></li>
        </ul>
        <div class="tab-content pt-3">
          <div class="tab-pane fade show active" id="panePayroll" role="tabpanel">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead class="table-light">
                  <tr>
                    <th>{{ _('Employee / Ø§Ù„Ù…ÙˆØ¸Ù') }}</th>
                    <th class="text-end">{{ _('Basic') }}</th>
                    <th class="text-end">{{ _('Allowances') }}</th>
                    <th class="text-end">{{ _('Deductions') }}</th>
                    <th class="text-end">{{ _('Prev Due') }}</th>
                    <th class="text-end">{{ _('Total') }}</th>
                    <th class="text-end">{{ _('Paid') }}</th>
                    <th class="text-end">{{ _('Remaining') }}</th>
                    <th>{{ _('Status') }}</th>
                  </tr>
                </thead>
                <tbody id="monthlyPayrollBody"></tbody>
              </table>
            </div>
          </div>
          <div class="tab-pane fade" id="paneAdv" role="tabpanel">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead class="table-light">
                  <tr>
                    <th>{{ _('Employee / Ø§Ù„Ù…ÙˆØ¸Ù') }}</th>
                    <th class="text-end">{{ _('Granted / Ø§Ù„Ù…Ù…Ù†ÙˆØ­') }}</th>
                    <th class="text-end">{{ _('Paid / Ø§Ù„Ù…Ø³Ø¯Ø¯') }}</th>
                    <th class="text-end">{{ _('Remaining / Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ') }}</th>
                    <th>{{ _('Last Date / Ø¢Ø®Ø± ØªØ§Ø±ÙŠØ®') }}</th>
                  </tr>
                </thead>
                <tbody id="monthlyAdvBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <form method="POST">
        {{ form.hidden_tag() }}
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

        <div class="row g-3">
          <div class="col-md-4">{{ form.employee_id.label(class_='form-label') }}{{ form.employee_id(class_='form-select', id='employee_id') }}</div>
          <div class="col-md-2">{{ form.year.label(class_='form-label') }}{{ form.year(class_='form-control') }}</div>
          <div class="col-md-2">{{ form.month.label(class_='form-label') }}{{ form.month(class_='form-select') }}</div>
          <div class="col-md-2">{{ form.status.label(class_='form-label') }}{{ form.status(class_='form-select') }}</div>
          <div class="col-md-2">{{ form.basic_salary.label(class_='form-label') }}{{ form.basic_salary(class_='form-control', id='basic_salary') }}</div>
          <div class="col-md-2">{{ form.allowances.label(class_='form-label') }}{{ form.allowances(class_='form-control', id='allowances') }}</div>
          <div class="col-md-2">{{ form.deductions.label(class_='form-label') }}{{ form.deductions(class_='form-control', id='deductions') }}</div>
          <div class="col-md-2">{{ form.previous_salary_due.label(class_='form-label') }}{{ form.previous_salary_due(class_='form-control', id='previous_salary_due') }}</div>
          <div class="col-md-2">{{ form.total_salary.label(class_='form-label') }}{{ form.total_salary(class_='form-control', readonly=True, id='total_salary') }}</div>
        </div>
        <div class="text-end mt-3">
          {{ form.submit(class_='btn btn-primary') }}
        </div>
      </form>
    </div>
  </div>

  {% if salaries %}
  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped">
          <thead class="table-dark">
            <tr>
              <th>#</th>
              <th>{{ _('Employee / Ø§Ù„Ù…ÙˆØ¸Ù') }}</th>
              <th>{{ _('Year / Ø§Ù„Ø³Ù†Ø©') }}</th>
              <th>{{ _('Month / Ø§Ù„Ø´Ù‡Ø±') }}</th>
              <th class="text-end">{{ _('Basic / Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ') }}</th>
              <th class="text-end">{{ _('Allowances / Ø§Ù„Ø¨Ø¯Ù„Ø§Øª') }}</th>
              <th class="text-end">{{ _('Deductions / Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª') }}</th>
              <th class="text-end">{{ _('Prev Due / Ø³Ø§Ø¨Ù‚Ø©') }}</th>
              <th class="text-end">{{ _('Total / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ') }}</th>
              <th>{{ _('Status / Ø§Ù„Ø­Ø§Ù„Ø©') }}</th>
              <th>{{ _('Actions / Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª') }}</th>
            </tr>
          </thead>
          <tbody>
            {% for s in salaries %}
            <tr data-year="{{ s.year }}" data-month="{{ s.month }}" data-status="{{ (s.status or 'due')|lower }}" data-emp="{{ s.employee.full_name if s.employee else s.employee_id }}">
              <td>{{ loop.index }}</td>
              <td>{{ s.employee.full_name if s.employee else s.employee_id }}</td>
              <td>{{ s.year }}</td>
              <td>{{ s.month }}</td>
              <td class="text-end">{{ '%.2f'|format(s.basic_salary) }}</td>
              <td class="text-end">{{ '%.2f'|format(s.allowances or 0) }}</td>
              <td class="text-end">{{ '%.2f'|format(s.deductions or 0) }}</td>
              <td class="text-end">{{ '%.2f'|format(s.previous_salary_due or 0) }}</td>
              <td class="text-end">{{ '%.2f'|format(s.total_salary) }}</td>
              <td>
                {% set _st = (s.status or 'due')|lower %}
                {% if _st == 'paid' %}
                  <span class="badge bg-success">{{ _('Paid / Ù…Ø¯ÙÙˆØ¹') }}</span>
                {% elif _st == 'partial' %}
                  <span class="badge bg-warning text-dark">{{ _('Partial / Ø¬Ø²Ø¦ÙŠ') }}</span>
                {% else %}
                  <span class="badge bg-danger">{{ _('Due / Ù…Ø³ØªØ­Ù‚') }}</span>
                {% endif %}
              </td>
              <td>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="openEditSalary({{ s.id }}, {{ s.employee_id }}, {{ s.year }}, {{ s.month }}, {{ (s.basic_salary or 0)|float }}, {{ (s.allowances or 0)|float }}, {{ (s.deductions or 0)|float }}, {{ (s.previous_salary_due or 0)|float }}, '{{ s.status }}')">{{ _('Edit / ØªØ¹Ø¯ÙŠÙ„') }}</button>
                <button type="button" class="btn btn-sm btn-outline-success" onclick="openPaySalary({{ s.employee_id }}, '{{ s.employee.full_name if s.employee else s.employee_id }}', {{ s.year }}, {{ s.month }})">{{ _('Pay / Ø³Ø¯Ø§Ø¯') }}</button>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteSalary({{ s.id }}, '{{ s.employee.full_name if s.employee else s.employee_id }}')">{{ _('Delete / Ø­Ø°Ù') }}</button>
              </td>
            </tr>
<script>
async function deleteSalary(id, name){
  const ok = confirm("{{ _('Are you sure to delete / Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ') }}\n" + name);
  if(!ok) return false;
  try{
    const fd = new FormData();
    fd.append('csrf_token', '{{ csrf_token() }}');
    const r = await fetch(`/api/salaries/${id}/delete`, { method:'POST', body: fd });
    if(r.ok){ location.reload(); } else { alert('{{ _('Delete failed / ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù') }}'); }
  }catch(e){ alert('{{ _('Delete failed / ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù') }}'); }
}
</script>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}
</div>


<script>
(function(){
  const empSelect = document.getElementById('employee_id');
  async function fetchDefaults(empId){
    if(!empId) return null;
    try{
      const r = await fetch(`/api/employee/${empId}/salary_defaults`);
      if(!r.ok) return null;
      return await r.json();
    }catch(e){ return null; }
  }
  async function applyDefaults(){
    const empId = empSelect && empSelect.value;
    const data = await fetchDefaults(empId);
    if(!data) return;
    const basic = document.getElementById('basic_salary');
    const allow = document.getElementById('allowances');
    const ded = document.getElementById('deductions');
    if(basic && !basic.value) basic.value = (data.base_salary||0);
    if(allow && !allow.value) allow.value = (data.allowances||0);
    if(ded && !ded.value) ded.value = (data.deductions||0);
    // Trigger recalc
    document.dispatchEvent(new Event('input'));
  }
  if(empSelect){
    empSelect.addEventListener('change', applyDefaults);
    document.addEventListener('DOMContentLoaded', applyDefaults);
  }
})();
</script>

<script>
function recalc() {
  const basic = parseFloat(document.querySelector('[name="basic_salary"]').value) || 0;
  const allowances = parseFloat(document.querySelector('[name="allowances"]').value) || 0;
  const deductions = parseFloat(document.querySelector('[name="deductions"]').value) || 0;
  const prev = parseFloat(document.querySelector('[name="previous_salary_due"]').value) || 0;
  const total = basic + allowances - deductions + prev;
  const totalInput = document.querySelector('[name="total_salary"]');
  if (totalInput) totalInput.value = total.toFixed(2);
}

document.addEventListener('input', function(e) {
  if (['basic_salary','allowances','deductions','previous_salary_due'].includes(e.target.name)) {
    recalc();
  }
});

document.addEventListener('DOMContentLoaded', recalc);
</script>

<div class="modal fade" id="paySalaryModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ _('Pay Salary / Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø§ØªØ¨') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="ps_emp">
        <input type="hidden" id="ps_year">
        <input type="hidden" id="ps_month">
        <div class="mb-2">
          <label class="form-label">{{ _('Amount / Ø§Ù„Ù…Ø¨Ù„Øº') }}</label>
          <input type="number" step="0.01" class="form-control" id="ps_amount">
        </div>
        <div class="mb-2">
          <label class="form-label">{{ _('Method / Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©') }}</label>
          <select class="form-select" id="ps_method">
            <option value="cash">{{ _('Cash / Ù†Ù‚Ø¯ÙŠ') }}</option>
            <option value="bank">{{ _('Bank / Ø¨Ù†Ùƒ') }}</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close / Ø¥ØºÙ„Ø§Ù‚') }}</button>
        <button type="button" class="btn btn-primary" onclick="submitPaySalary()">{{ _('Pay / Ø³Ø¯Ø§Ø¯') }}</button>
      </div>
    </div>
  </div>
  </div>

<script>
let _psModal;
function openPaySalary(empId, name, year, month){
  document.getElementById('ps_emp').value = empId;
  document.getElementById('ps_year').value = year;
  document.getElementById('ps_month').value = month;
  try{
    const el = document.getElementById('paySalaryModal');
    _psModal = new bootstrap.Modal(el);
    _psModal.show();
  }catch(e){ document.getElementById('paySalaryModal').style.display='block'; }
}
async function submitPaySalary(){
  const empId = document.getElementById('ps_emp').value;
  const year = document.getElementById('ps_year').value;
  const month = document.getElementById('ps_month').value;
  const amt = document.getElementById('ps_amount').value || '0';
  const method = document.getElementById('ps_method').value || 'cash';
  const fd = new FormData();
  fd.append('csrf_token', '{{ csrf_token() }}');
  fd.append('paid_amount', amt);
  fd.append('payment_method', method);
  const url = `/employees/${empId}/pay?employee_id=${empId}&year=${year}&month=${month}`;
  try{
    const r = await fetch(url, { method:'POST', body: fd });
    if(r.ok){ location.reload(); } else { alert('{{ _('Payment failed / ÙØ´Ù„ Ø§Ù„Ø³Ø¯Ø§Ø¯') }}'); }
  }catch(e){ alert('{{ _('Payment failed / ÙØ´Ù„ Ø§Ù„Ø³Ø¯Ø§Ø¯') }}'); }
}
let _bpModal;
function openBulkPay(){
  try{
    const el = document.getElementById('bulkPayModal');
    _bpModal = new bootstrap.Modal(el);
    _bpModal.show();
  }catch(e){ document.getElementById('bulkPayModal').style.display='block'; }
}
async function submitBulkPay(){
  const m = document.getElementById('filter_month').value || '';
  const amt = document.getElementById('bp_amount').value || '0';
  const method = document.getElementById('bp_method').value || 'cash';
  const fd = new FormData();
  fd.append('csrf_token', '{{ csrf_token() }}');
  fd.append('employee_id', 'all');
  fd.append('month', m);
  fd.append('paid_amount', amt);
  fd.append('payment_method', method);
  try{
    const r = await fetch('/salaries/pay', { method:'POST', body: fd });
    if(r.ok){ location.reload(); } else { alert('{{ _('Payment failed / ÙØ´Ù„ Ø§Ù„Ø³Ø¯Ø§Ø¯') }}'); }
  }catch(e){ alert('{{ _('Payment failed / ÙØ´Ù„ Ø§Ù„Ø³Ø¯Ø§Ø¯') }}'); }
}
</script>

<script>
async function refreshSummary(){
  const m = document.getElementById('filter_month').value || '';
  const st = (document.getElementById('filter_status').value || '').toLowerCase();
  const emp = document.getElementById('filter_emp').value || '';
  let url = `/api/salaries/statements?month=${encodeURIComponent(m)}`;
  if(st && st !== 'all') url += `&status=${encodeURIComponent(st)}`;
  if(emp) url += `&emp_id=${encodeURIComponent(emp)}`;
  try{
    const r = await fetch(url);
    const j = await r.json();
    const t = j.totals || {};
    document.getElementById('sum_basic').textContent = (t.basic||0).toFixed(2);
    document.getElementById('sum_allow').textContent = (t.allow||0).toFixed(2);
    document.getElementById('sum_ded').textContent = (t.ded||0).toFixed(2);
    document.getElementById('sum_prev').textContent = (t.prev||0).toFixed(2);
    document.getElementById('sum_total').textContent = (t.total||0).toFixed(2);
    document.getElementById('sum_paid').textContent = (t.paid||0).toFixed(2);
    document.getElementById('sum_remaining').textContent = (t.remaining||0).toFixed(2);
    const pm = (j.month||0);
    const py = (j.year||0);
    const printBtn = document.getElementById('btnPrint');
    if(printBtn){ printBtn.href = `/payroll/print/${py}/${pm}`; }
    const body = document.getElementById('monthlyPayrollBody');
    if(body){
      body.innerHTML = '';
      (j.rows||[]).forEach(rw => {
        const tr = document.createElement('tr');
        const st = String(rw.status||'').toLowerCase();
        const badge = st==='paid'? '<span class="badge bg-success">{{ _('Paid / Ù…Ø¯ÙÙˆØ¹') }}'</span> : (st==='partial'? '<span class="badge bg-warning text-dark">{{ _('Partial / Ø¬Ø²Ø¦ÙŠ') }}'</span> : '<span class="badge bg-danger">{{ _('Due / Ù…Ø³ØªØ­Ù‚') }}'</span>);
        tr.innerHTML = `<td>${rw.employee_name||('#'+rw.employee_id)}</td><td class='text-end'>${Number(rw.basic||0).toFixed(2)}</td><td class='text-end'>${Number(rw.allow||0).toFixed(2)}</td><td class='text-end'>${Number(rw.ded||0).toFixed(2)}</td><td class='text-end'>${Number(rw.prev||0).toFixed(2)}</td><td class='text-end'>${Number(rw.total||0).toFixed(2)}</td><td class='text-end'>${Number(rw.paid||0).toFixed(2)}</td><td class='text-end'>${Number(rw.remaining||0).toFixed(2)}</td><td>${badge}</td>`;
        body.appendChild(tr);
      });
    }
  }catch(e){ }
}
document.getElementById('btnRefresh').addEventListener('click', refreshSummary);
document.addEventListener('DOMContentLoaded', function(){
  try{
    const d = new Date();
    const v = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    const fm = document.getElementById('filter_month');
    if(fm && !fm.value) fm.value = v;
  }catch(e){}
  refreshSummary();
});
</script>

<div class="modal fade" id="bulkPayModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ _('Bulk Pay / Ø³Ø¯Ø§Ø¯ Ø¬Ù…Ø§Ø¹ÙŠ') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">{{ _('Month / Ø§Ù„Ø´Ù‡Ø±') }}</label>
          <input type="month" class="form-control" id="bp_month" disabled>
        </div>
        <div class="mb-2">
          <label class="form-label">{{ _('Amount / Ø§Ù„Ù…Ø¨Ù„Øº') }}</label>
          <input type="number" step="0.01" class="form-control" id="bp_amount">
        </div>
        <div class="mb-2">
          <label class="form-label">{{ _('Method / Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©') }}</label>
          <select class="form-select" id="bp_method">
            <option value="cash">{{ _('Cash / Ù†Ù‚Ø¯ÙŠ') }}</option>
            <option value="bank">{{ _('Bank / Ø¨Ù†Ùƒ') }}</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close / Ø¥ØºÙ„Ø§Ù‚') }}</button>
        <button type="button" class="btn btn-primary" onclick="submitBulkPay()">{{ _('Pay / Ø³Ø¯Ø§Ø¯') }}</button>
      </div>
    </div>
  </div>
  </div>

<script>
let summaryCache = null;
async function refreshSummary(){
  const m = document.getElementById('filter_month').value || '';
  const st = (document.getElementById('filter_status').value || '').toLowerCase();
  const emp = document.getElementById('filter_emp').value || '';
  const q = (document.getElementById('filter_q').value || '').trim().toLowerCase();
  let url = `/api/salaries/statements?month=${encodeURIComponent(m)}`;
  if(st && st !== 'all') url += `&status=${encodeURIComponent(st)}`;
  if(emp) url += `&emp_id=${encodeURIComponent(emp)}`;
  try{
    const r = await fetch(url);
    const j = await r.json();
    summaryCache = j;
    const t = j.totals || {};
    document.getElementById('sum_basic').textContent = (t.basic||0).toFixed(2);
    document.getElementById('sum_allow').textContent = (t.allow||0).toFixed(2);
    document.getElementById('sum_ded').textContent = (t.ded||0).toFixed(2);
    document.getElementById('sum_prev').textContent = (t.prev||0).toFixed(2);
    document.getElementById('sum_total').textContent = (t.total||0).toFixed(2);
    document.getElementById('sum_paid').textContent = (t.paid||0).toFixed(2);
    document.getElementById('sum_remaining').textContent = (t.remaining||0).toFixed(2);
    const pm = (j.month||0);
    const py = (j.year||0);
    const printBtn = document.getElementById('btnPrint');
    if(printBtn){ printBtn.href = `/payroll/print/${py}/${pm}`; }
  }catch(e){}
  applyTableFilters();
}
function applyTableFilters(){
  const m = document.getElementById('filter_month').value || '';
  const st = (document.getElementById('filter_status').value || '').toLowerCase();
  const emp = document.getElementById('filter_emp').value || '';
  const q = (document.getElementById('filter_q').value || '').trim().toLowerCase();
  const rows = document.querySelectorAll('table tbody tr');
  const parts = (m||'').split('-');
  const fy = parts[0];
  const fm = parts[1];
  rows.forEach(tr => {
    const y = tr.getAttribute('data-year');
    const mo = String(tr.getAttribute('data-month')).padStart(2,'0');
    const stx = tr.getAttribute('data-status');
    const empx = tr.getAttribute('data-emp');
    const nameMatch = !q || (empx||'').toLowerCase().includes(q);
    const empMatch = !emp || String(empx).includes(emp);
    const statusMatch = (st === 'all' || !st) || stx === st;
    const monthMatch = (!fy || !fm) || (String(y) === String(fy) && String(mo) === String(fm));
    const show = nameMatch && empMatch && statusMatch && monthMatch;
    tr.style.display = show ? '' : 'none';
  });
}
document.getElementById('filter_month').addEventListener('change', refreshSummary);
document.getElementById('filter_status').addEventListener('change', refreshSummary);
document.getElementById('filter_emp').addEventListener('change', refreshSummary);
document.getElementById('filter_q').addEventListener('input', applyTableFilters);
document.getElementById('btnCSV').addEventListener('click', function(){
  try{
    const rows = (summaryCache && summaryCache.rows) || [];
    let csv = 'employee_id,employee_name,month,basic,allow,ded,prev,total,paid,remaining,status\n';
    rows.forEach(r=>{
      csv += `${r.employee_id},"${(r.employee_name||'').replace(/\"/g,'\"')}",${r.month_label},${r.basic||0},${r.allow||0},${r.ded||0},${r.prev||0},${r.total||0},${r.paid||0},${r.remaining||0},${r.status||''}\n`;
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'salaries_summary.csv'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }catch(e){}
});
document.getElementById('btnBulkPay').addEventListener('click', function(){
  try{
    const fm = document.getElementById('filter_month');
    const bp = document.getElementById('bp_month');
    if(bp && fm) bp.value = fm.value;
  }catch(e){}
  openBulkPay();
});

async function refreshAdvMonthly(){
  const m = document.getElementById('filter_month').value || '';
  try{
    const r = await fetch(`/api/advances/list?month=${encodeURIComponent(m)}`);
    const j = await r.json();
    const body = document.getElementById('monthlyAdvBody');
    if(body){
      body.innerHTML = '';
      (j.rows||[]).forEach(x=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${x.employee_name||('#'+x.employee_id)}</td><td class='text-end'>${Number(x.granted||0).toFixed(2)}</td><td class='text-end'>${Number(x.paid||0).toFixed(2)}</td><td class='text-end'>${Number(x.remaining||0).toFixed(2)}</td><td>${x.last_date||'-'}</td>`;
        body.appendChild(tr);
      });
    }
  }catch(e){}
}
document.getElementById('filter_month').addEventListener('change', refreshAdvMonthly);
document.getElementById('tabAdv').addEventListener('click', refreshAdvMonthly);
</script>

<div class="modal fade" id="editSalaryModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ _('Edit Salary / ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø§ØªØ¨') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="es_sid">
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label">{{ _('Basic') }}</label>
            <input type="number" step="0.01" class="form-control" id="es_basic">
          </div>
          <div class="col-6">
            <label class="form-label">{{ _('Allowances') }}</label>
            <input type="number" step="0.01" class="form-control" id="es_allow">
          </div>
          <div class="col-6">
            <label class="form-label">{{ _('Deductions') }}</label>
            <input type="number" step="0.01" class="form-control" id="es_ded">
          </div>
          <div class="col-6">
            <label class="form-label">{{ _('Prev Due') }}</label>
            <input type="number" step="0.01" class="form-control" id="es_prev">
          </div>
          <div class="col-12">
            <label class="form-label">{{ _('Status') }}</label>
            <select class="form-select" id="es_status">
              <option value="due">{{ _('Due') }}</option>
              <option value="partial">{{ _('Partial') }}</option>
              <option value="paid">{{ _('Paid') }}</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close / Ø¥ØºÙ„Ø§Ù‚') }}</button>
        <button type="button" class="btn btn-primary" onclick="saveEditSalary()">{{ _('Save / Ø­ÙØ¸') }}</button>
      </div>
    </div>
  </div>
  </div>

<script>
let _esModal;
function openEditSalary(id, empId, year, month, basic, allow, ded, prev, status){
  document.getElementById('es_sid').value = id;
  document.getElementById('es_basic').value = (basic||0).toFixed ? Number(basic||0) : basic;
  document.getElementById('es_allow').value = (allow||0).toFixed ? Number(allow||0) : allow;
  document.getElementById('es_ded').value = (ded||0).toFixed ? Number(ded||0) : ded;
  document.getElementById('es_prev').value = (prev||0).toFixed ? Number(prev||0) : prev;
  document.getElementById('es_status').value = (status||'due').toLowerCase();
  try{
    const el = document.getElementById('editSalaryModal');
    _esModal = new bootstrap.Modal(el);
    _esModal.show();
  }catch(e){
    document.getElementById('editSalaryModal').style.display='block';
  }
}
async function saveEditSalary(){
  const sid = document.getElementById('es_sid').value;
  const fd = new FormData();
  fd.append('csrf_token', '{{ csrf_token() }}');
  fd.append('basic_salary', document.getElementById('es_basic').value||'0');
  fd.append('allowances', document.getElementById('es_allow').value||'0');
  fd.append('deductions', document.getElementById('es_ded').value||'0');
  fd.append('previous_salary_due', document.getElementById('es_prev').value||'0');
  fd.append('status', document.getElementById('es_status').value||'due');
  try{
    const r = await fetch(`/api/salaries/${sid}/update`, { method:'POST', body: fd });
    if(r.ok){ location.reload(); } else { alert('{{ _('Save failed / ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸') }}'); }
  }catch(e){ alert('{{ _('Save failed / ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸') }}'); }
}
</script>
{% endblock %}
