{% extends 'base.html' %}
{% block title %}{{ meta.title }}{% endblock %}
{% block content %}
<style>
  @media print { .no-print { display: none !important; } }
  .report-header { border-bottom: 2px solid #333; margin-bottom: 12px; padding-bottom: 8px; }
  .muted { color: #666; font-size: 0.9rem; }
</style>
<div class="container py-3">
  <div class="d-flex align-items-center gap-3 mb-2">
    {% if settings and settings.receipt_show_logo and settings.logo_url %}
      <img src="{{ settings.logo_url }}" alt="logo" style="height:48px;max-width:140px;object-fit:contain" />
    {% endif %}
    <div>
      <div class="fw-bold">{{ settings.company_name or 'Company' }}</div>
      <div class="muted">VAT: {{ settings.tax_number or '-' }}{% if settings.address %} | {{ settings.address }}{% endif %}</div>
    </div>
  </div>
  <div class="report-header d-flex justify-content-between align-items-center">
    <div>
      <h4 class="mb-1">{{ meta.title }}</h4>
      <div class="muted">Range: {{ meta.start_date or 'All' }} â†’ {{ meta.end_date or 'All' }} | PM: {{ meta.payment_method|upper }} | Branch: {{ meta.branch }}</div>
    </div>
    <div class="text-end">
      <div class="muted">Printed: {{ meta.generated_at }}</div>
      <button class="btn btn-sm btn-outline-secondary no-print" onclick="window.print()">Print</button>
    </div>
  <script>
    (function(){
      function autoPrint(){ setTimeout(function(){ try{ window.print(); }catch(e){} }, 300); }
      window.addEventListener('load', autoPrint);
      window.onafterprint = function(){ try{ window.close(); }catch(e){} };
    })();
  </script>

  </div>

  <div class="table-responsive">
    <table class="table table-bordered table-striped table-sm align-middle">
      <thead class="table-light">
        <tr>
          <th>Branch</th><th>Date</th><th>Invoice No.</th><th>Item</th><th>Qty</th>
          <th>Amount</th><th>Discount</th><th>VAT</th><th>Total</th><th>Payment</th>
        </tr>
      </thead>
      <tbody>
        {% set current = None %}
        {% for r in rows %}
          {% if r.branch != current %}
            <tr class="table-info fw-bold"><td colspan="10">Branch: {{ r.branch }}</td></tr>
            {% set current = r.branch %}
          {% endif %}
          <tr>
            <td>{{ r.branch }}</td><td>{{ r.date }}</td><td>{{ r.invoice_number }}</td>
            <td>{{ r.item_name }}</td><td>{{ '%.2f'|format(r.quantity) }}</td>
            <td>{{ '%.2f'|format(r.amount) }}</td><td>{{ '%.2f'|format(r.discount) }}</td>
            <td>{{ '%.2f'|format(r.vat) }}</td><td>{{ '%.2f'|format(r.total) }}</td>
            <td>{{ r.payment_method }}</td>
          </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        {% for b, t in branch_totals|dictsort %}
          <tr class="table-warning fw-bold">
            <td colspan="5" class="text-end">Branch Totals ({{ b }}):</td>
            <td>{{ '%.2f'|format(t.amount) }}</td>
            <td>{{ '%.2f'|format(t.discount) }}</td>
            <td>{{ '%.2f'|format(t.vat) }}</td>
            <td>{{ '%.2f'|format(t.total) }}</td>
            <td></td>
          </tr>
        {% endfor %}
        <tr class="table-secondary fw-bold">
          <td colspan="5" class="text-end">Overall Totals:</td>
          <td>{{ '%.2f'|format(overall.amount) }}</td>
          <td>{{ '%.2f'|format(overall.discount) }}</td>
          <td>{{ '%.2f'|format(overall.vat) }}</td>
          <td>{{ '%.2f'|format(overall.total) }}</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>

  {% if payment_totals %}
  <div class="mt-3">
    <h6>Payment Method Totals</h6>
    <table class="table table-sm table-bordered w-auto">
      <thead class="table-light"><tr><th>Method</th><th class="text-end">Total</th></tr></thead>
      <tbody>
        {% for pm, val in payment_totals|dictsort %}
        <tr><td>{{ pm }}</td><td class="text-end">{{ '%.2f'|format(val) }}</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

</div>
{% endblock %}

