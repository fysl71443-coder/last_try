{% extends 'base.html' %}
{% block title %}{{ _('Order Invoices') }}{% endblock %}
{% block content %}
<div class="container py-4 ops-layout hub-wrap">
  <div class="ops-header-bar">
    <span class="ops-icon"><i class="fa-solid fa-receipt"></i></span>
    <div>
      <h1 class="ops-title mb-0">{{ _('Order Invoices') }}</h1>
      <span class="ops-subtitle">{{ _('Filter and view order invoices') }}</span>
    </div>
    <div class="ops-actions d-flex flex-wrap gap-2">
      <a href="{{ url_for('main.dashboard') }}" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-house me-1"></i>{{ _('Dashboard') }}</a>
    </div>
  </div>

  <div class="ops-form-card mt-0">
    <div class="ops-form-head">{{ _('Filters & actions') }}</div>
    <div class="ops-form-body">
      <div class="row g-3 align-items-end mb-3">
        <form method="get" action="{{ url_for('main.order_invoices_list') }}" class="d-flex gap-2 align-items-center flex-wrap">
          <label class="form-label mb-0">{{ _('Branch') }}:</label>
          <select name="branch" class="form-select" style="width:auto">
            <option value="" {{ '' == (current_branch or '') and 'selected' or '' }}>{{ _('All branches') }}</option>
            <option value="china_town" {{ (current_branch or '')=='china_town' and 'selected' or '' }}>China Town</option>
            <option value="place_india" {{ (current_branch or '')=='place_india' and 'selected' or '' }}>Place India</option>
          </select>
          <button type="submit" class="btn btn-primary btn-sm"><i class="fa-solid fa-filter me-1"></i>{{ _('Filter') }}</button>
        </form>
        <form method="get" action="{{ url_for('reports.reports_print_daily_items_summary') }}" target="_blank" class="d-flex gap-2 align-items-center flex-wrap">
          <label class="form-label mb-0">{{ _('Daily summary date') }}:</label>
          <input type="date" name="date" value="{{ (now().date() if now else None) or '' }}" class="form-control" style="width:auto">
          <input type="hidden" name="branch" value="{{ current_branch or '' }}">
          <button type="submit" class="btn btn-outline-secondary btn-sm"><i class="fa-solid fa-print me-1"></i>{{ _('Print daily summary') }}</button>
        </form>
        <form method="post" action="{{ url_for('main.order_invoices_clear_all') }}" onsubmit="return confirm('{{ _("Clear all orders? This cannot be undone.") }}');" class="d-inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-sm btn-outline-danger"><i class="fa-solid fa-trash me-1"></i>{{ _('Clear all orders') }}</button>
        </form>
      </div>

      <div class="table-responsive screen-table-wrap">
        <table class="table table-hover align-middle screen-table mb-0">
          <thead>
            <tr>
              <th>{{ _('Branch') }}</th>
              <th>{{ _('Date') }}</th>
              <th>{{ _('Invoice No.') }}</th>
              <th>{{ _('Items') }}</th>
              <th>{{ _('Qty') }}</th>
              <th class="text-end">{{ _('Amount') }}</th>
              <th class="text-end">{{ _('Discount') }}</th>
              <th class="text-end">{{ _('VAT') }}</th>
              <th class="text-end">{{ _('Total') }}</th>
              <th>{{ _('Payment') }}</th>
            </tr>
          </thead>
          <tbody>
            {% for order in orders %}
            <tr>
              <td>{{ order.branch }}</td>
              <td>{{ order.invoice_date }}</td>
              <td>{{ order.invoice_no }}</td>
              <td>
                {% set item_count = (order.items|length) if order.items else 0 %}
                {{ item_count }} أصناف
              </td>
              <td>
                {% set ns = namespace(total=0) %}
                {% for item in (order.items or []) %}
                  {% set ns.total = ns.total + (item.qty or 0) %}
                {% endfor %}
                {{ '%.2f'|format(ns.total) }}
              </td>
              <td>{{ '%.2f'|format(order.subtotal or 0) }}</td>
              <td>{{ '%.2f'|format(order.discount or 0) }}</td>
              <td>{{ '%.2f'|format(order.vat or 0) }}</td>
              <td>{{ '%.2f'|format(order.total or 0) }}</td>
              <td>{{ order.payment_method or 'PENDING' }}</td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr>
              <th colspan="5" class="text-end">Subtotal</th>
              <th>{{ '%.2f'|format(totals.subtotal_sum or 0) }}</th>
              <th>{{ '%.2f'|format(totals.discount_sum or 0) }}</th>
              <th>{{ '%.2f'|format(totals.vat_sum or 0) }}</th>
              <th>{{ '%.2f'|format(totals.total_sum or 0) }}</th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>

      {% if items_summary and items_summary|length > 0 %}
      <div class="p-3 border-top">
        <h6 class="mb-2">{{ _('Items summary') }}</h6>
        <table class="table table-sm mb-0">
          <thead>
            <tr>
              <th>{{ _('Item') }}</th>
              <th>{{ _('Total qty') }}</th>
            </tr>
          </thead>
          <tbody>
            {% for row in items_summary %}
            <tr>
              <td>{{ row.item_name }}</td>
              <td>{{ row.total_qty }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

