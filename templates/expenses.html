{% extends 'base.html' %}
{% if current_user.is_authenticated %}{% set back_url = url_for('main.dashboard') %}{% else %}{% set back_url = '#' %}{% endif %}

{% block title %}{{ _('Expenses / Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª') }}{% endblock %}
{% block content %}

<style>
body {
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  min-height: 100vh;
}

.expenses-card {
  background: white;
  border-radius: 15px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  padding: 2rem;
  margin-bottom: 2rem;
  border: 1px solid rgba(0,0,0,0.05);
}

.expenses-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 35px rgba(0,0,0,0.15);
  transition: all 0.3s ease;
}

.status-badge {
  padding: 0.4rem 0.8rem;
  border-radius: 25px;
  font-size: 0.85rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.status-paid { 
  background: linear-gradient(45deg, #00b894, #00a085); 
  color: white; 
  box-shadow: 0 2px 8px rgba(0,184,148,0.3);
}

.status-pending { 
  background: linear-gradient(45deg, #ffeaa7, #fdcb6e); 
  color: #2d3436; 
  box-shadow: 0 2px 8px rgba(253,203,110,0.3);
}

.item-row {
  border: 2px solid #e9ecef;
  border-radius: 12px;
  padding: 1.25rem 2.5rem 1.25rem 1.25rem;
  margin-bottom: 1rem;
  background: white;
  transition: all 0.3s ease;
  position: relative;
}

.item-row:hover {
  border-color: #007bff;
  box-shadow: 0 4px 15px rgba(0,123,255,0.1);
}

.remove-row-btn {
  position: absolute;
  top: 8px;
  right: 8px;
}

.expense-highlight {
  font-weight: bold;
  color: #e74c3c;
}

/* Enhanced form controls */
.form-control:focus, .form-select:focus {
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
}

/* Button enhancements */
.btn {
  border-radius: 8px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Table enhancements */
.table {
  border-radius: 10px;
  overflow: hidden;
}

.table thead th {
  border: none;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-size: 0.85rem;
}

.table tbody tr:hover {
  background-color: rgba(0,123,255,0.05);
  transform: scale(1.01);
  transition: all 0.2s ease;
}

/* Card stats */
.card {
  border-radius: 12px;
  border: none;
  transition: all 0.3s ease;
}

.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}
</style>

<div class="container py-4">
    <!-- Header with navigation -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">ğŸ’¸ {{ _('Expenses Management / Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª') }}</h2>
            <p class="text-muted mb-0">{{ _('Track and manage business expenses / ØªØªØ¨Ø¹ ÙˆØ¥Ø¯Ø§Ø±Ø© Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø¹Ù…Ù„') }}</p>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <a href="{{ url_for('main.purchases') }}" class="btn btn-outline-warning">
                ğŸ›’ {{ _('Purchases / Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª') }}
            </a>
            <a href="{{ url_for('main.sales') }}" class="btn btn-outline-success">
                ğŸ’° {{ _('Sales / Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª') }}
            </a>
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary">
                ğŸ  {{ _('Dashboard / Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…') }}
            </a>
        </div>
    </div>

    <!-- Quick Stats -->
    {% if invoices %}
    <div class="row mb-4">
        {% set total_expenses = invoices|sum(attribute='total_after_tax_discount') %}
        {% set paid_expenses = invoices|selectattr('status','equalto','paid')|sum(attribute='total_after_tax_discount') %}
        {% set pending_expenses = total_expenses - paid_expenses %}
        
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <h4 class="mb-1">${{ "%.2f"|format(total_expenses) }}</h4>
                    <small>{{ _('Total Expenses / Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª') }}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h4 class="mb-1">${{ "%.2f"|format(paid_expenses) }}</h4>
                    <small>{{ _('Paid / Ù…Ø¯ÙÙˆØ¹') }}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h4 class="mb-1">${{ "%.2f"|format(pending_expenses) }}</h4>
                    <small>{{ _('Pending / Ù…Ø¹Ù„Ù‚') }}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h4 class="mb-1">{{ invoices|length }}</h4>
                    <small>{{ _('Total Invoices / Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±') }}</small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ù…ØµØ±ÙˆÙØ§Øª Ø¬Ø¯ÙŠØ¯Ø© -->
    <div class="expenses-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">ğŸ“ {{ _('Create New Expense Invoice / Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ù…ØµØ±ÙˆÙØ§Øª Ø¬Ø¯ÙŠØ¯Ø©') }}</h5>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearExpenseForm()">
                ğŸ—‘ï¸ {{ _('Clear Form / Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬') }}
            </button>
        </div>

        <div class="alert alert-info border-0">
            <div class="d-flex align-items-center">
                <i class="fas fa-info-circle me-2"></i>
                <div>
                    <strong>ğŸ’¡ {{ _('Tip / Ù†ØµÙŠØ­Ø©') }}:</strong>
                    {{ _('Record all business expenses including utilities, rent, supplies, and other operational costs / Ø³Ø¬Ù„ Ø¬Ù…ÙŠØ¹ Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø¹Ù…Ù„ Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„Ù…Ø±Ø§ÙÙ‚ ÙˆØ§Ù„Ø¥ÙŠØ¬Ø§Ø± ÙˆØ§Ù„Ù„ÙˆØ§Ø²Ù… ÙˆØ§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ© Ø§Ù„Ø£Ø®Ø±Ù‰') }}
                </div>
            </div>
        </div>

        <form method="POST" id="expense-form">
            {{ form.hidden_tag() }}

            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
            <div class="card border-0 bg-light mb-4">
                <div class="card-body">
                    <h6 class="card-title mb-3">ğŸ“‹ {{ _('Invoice Information / Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©') }}</h6>
                    <div class="row g-3">
                        {% if form.csrf_token %}{{ form.csrf_token }}{% endif %}
                        <div class="col-md-4">
                            {{ form.date.label(class_='form-label fw-bold') }}
                            {{ form.date(class_='form-control') }}
                        </div>
                        <div class="col-md-4">
                            {{ form.payment_method.label(class_='form-label fw-bold') }}
                            {{ form.payment_method(class_='form-select') }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">{{ _('Payment Status / Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹') }}</label>
                            <select name="status" id="expense-status" class="form-select">
                                <option value="paid">âœ… {{ _('Paid / Ù…Ø¯ÙÙˆØ¹') }}</option>
                                <option value="partial">âš ï¸ {{ _('Partial / Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹') }}</option>
                                <option value="unpaid">âŒ {{ _('Unpaid / ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹') }}</option>
                            </select>
                        </div>
                        <div class="col-md-4" id="expense-partial-box" style="display:none;">
                            <label class="form-label fw-bold">{{ _('Paid Amount (Partial) / Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ø¬Ø²Ø¦ÙŠ)') }}</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input name="partial_paid_amount" id="expense-partial-amount" type="number" step="0.01" min="0" class="form-control" placeholder="0.00">
                            </div>
                            <div class="form-text">{{ _('Max is Final Total / Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù‡Ùˆ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ') }}: <span id="expense-partial-max" class="fw-bold text-danger"></span></div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
            <div class="card border-0 bg-light mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-title mb-0">ğŸ§¾ {{ _('Expense Items / Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª') }}</h6>
                        <button type="button" class="btn btn-success btn-sm" id="add-item">
                            â• {{ _('Add Item / Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯') }}
                        </button>
                    </div>
                    
                    <div id="items-container">
                        {% for item_form in form.items %}
                        <div class="item-row border rounded bg-white">
                            <button type="button" class="btn btn-sm btn-outline-danger remove-row-btn remove-item-btn" title="Remove">âœ–</button>
                            <div class="row g-2 align-items-end">
                                <div class="col-md-4">
                                    {{ item_form.form.description.label(class_='form-label fw-bold') }}
                                    {{ item_form.form.description(class_='form-control', placeholder=_('e.g., Office rent, Electricity bill / Ù…Ø«Ù„: Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ù…ÙƒØªØ¨ØŒ ÙØ§ØªÙˆØ±Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡')) }}
                                </div>
                                <div class="col-md-2">
                                    {{ item_form.quantity.label(class_='form-label fw-bold') }}
                                    <div class="input-group">
                                        {{ item_form.quantity(class_='form-control', step='0.01', value='1') }}
                                        <span class="input-group-text">{{ _('unit / ÙˆØ­Ø¯Ø©') }}</span>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    {{ item_form.price_before_tax.label(class_='form-label fw-bold') }}
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        {{ item_form.price_before_tax(class_='form-control', step='0.01') }}
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    {{ item_form.tax.label(class_='form-label fw-bold') }}
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        {{ item_form.tax(class_='form-control', step='0.01', value='0') }}
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    {{ item_form.discount.label(class_='form-label fw-bold') }}
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        {{ item_form.discount(class_='form-control', step='0.01', value='0') }}
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">{{ _('Total / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ') }}</label>
                                    <div class="form-control bg-success text-white fw-bold item-total">$0.00</div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Ù…Ù„Ø®Øµ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ -->
            <div class="card border-0 bg-light mb-4 position-sticky" style="top: 0; z-index: 1;">
                <div class="card-body">
                    <h6 class="card-title mb-3">ğŸ’° {{ _('Cost Summary / Ù…Ù„Ø®Øµ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ') }}</h6>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold">{{ _('Subtotal / Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ') }}</label>
                            <div class="form-control bg-info text-white fw-bold" id="total-before-tax">$0.00</div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">{{ _('Tax / Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©') }}</label>
                            <div class="form-control bg-warning text-dark fw-bold" id="tax-amount">$0.00</div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">{{ _('Discount / Ø§Ù„Ø®ØµÙ…') }}</label>
                            <div class="form-control bg-secondary text-white fw-bold" id="total-discount">$0.00</div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">{{ _('Final Total / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ') }}</label>
                            <div class="form-control bg-danger text-white fw-bold fs-5" id="final-total">$0.00</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button type="button" class="btn btn-outline-secondary me-2" onclick="clearExpenseForm()">
                        ğŸ—‘ï¸ {{ _('Clear Form / Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬') }}
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="calculateTotals()">
                        ğŸ”„ {{ _('Recalculate / Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨') }}
                    </button>
                </div>
                <div>
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    {{ form.submit(class_='btn btn-danger btn-lg px-4') }}
                </div>
            </div>
        </form>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
    {% if invoices %}
    <div class="expenses-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">ğŸ“‹ {{ _('Previous Expense Invoices / ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©') }}</h5>
            <div class="d-flex gap-2">
                <input type="text" class="form-control form-control-sm" id="invoiceSearch" placeholder="{{ _('Search invoices... / Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±...') }}" style="width: 200px;">
                <button class="btn btn-outline-primary btn-sm" onclick="window.exportExpenses()">
                    ğŸ“Š {{ _('Export / ØªØµØ¯ÙŠØ±') }}
                </button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th class="text-center">#</th>
                        <th>{{ _('Invoice No / Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©') }}</th>
                        <th>{{ _('Date / Ø§Ù„ØªØ§Ø±ÙŠØ®') }}</th>
                        <th>{{ _('Payment / Ø§Ù„Ø¯ÙØ¹') }}</th>
                        <th class="text-end">{{ _('Total / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ') }}</th>
                        <th class="text-center">{{ _('Status / Ø§Ù„Ø­Ø§Ù„Ø©') }}</th>
                        <th class="text-center">{{ _('Items / Ø§Ù„Ø¹Ù†Ø§ØµØ±') }}</th>
                        <th class="text-center">{{ _('Actions / Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª') }}</th>
                    </tr>
                </thead>
                <tbody id="invoicesTableBody">
                    {% for invoice in invoices %}
                    <tr>
                        <td class="text-center"><span class="badge bg-secondary">{{ loop.index }}</span></td>
                        <td><strong class="text-primary">{{ invoice.invoice_number }}</strong></td>
                        <td>
                            <span class="badge bg-light text-dark">{{ invoice.date.strftime('%Y-%m-%d') }}</span>
                        </td>
                        <td>
                            {% if invoice.payment_method == 'cash' %}
                                <span class="badge bg-success">ğŸ’° {{ _('Cash / Ù†Ù‚Ø¯Ø§Ù‹') }}</span>
                            {% elif invoice.payment_method == 'bank' %}
                                <span class="badge bg-primary">ğŸ¦ {{ _('Bank / Ø¨Ù†Ùƒ') }}</span>
                            {% elif invoice.payment_method == 'visa' %}
                                <span class="badge bg-info">ğŸ’³ {{ _('Visa / ÙÙŠØ²Ø§') }}</span>
                            {% elif invoice.payment_method == 'mada' %}
                                <span class="badge bg-warning">ğŸ’³ {{ _('Mada / Ù…Ø¯Ù‰') }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ invoice.payment_method }}</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <span class="fw-bold text-danger fs-6">${{ "%.2f"|format(invoice.total_after_tax_discount) }}</span>
                        </td>
                        <td class="text-center">
                            {% if invoice.status == 'paid' %}
                                <span class="badge bg-success">âœ… {{ _('Paid / Ù…Ø¯ÙÙˆØ¹') }}</span>
                            {% elif invoice.status == 'partial' %}
                                <span class="badge bg-warning">âš ï¸ {{ _('Partial / Ø¬Ø²Ø¦ÙŠ') }}</span>
                            {% else %}
                                <span class="badge bg-danger">âŒ {{ _('Unpaid / ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹') }}</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <span class="badge bg-info">{{ invoice.items|length }} {{ _('items / Ø¹Ù†Ø§ØµØ±') }}</span>
                        </td>
                        <td class="text-center">
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-info" onclick="window.viewInvoice({{ invoice.id }})" title="{{ _('View Details / Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„') }}">
                                    ğŸ‘ï¸
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="window.editInvoice({{ invoice.id }})" title="{{ _('Edit / ØªØ¹Ø¯ÙŠÙ„') }}">
                                    âœï¸
                                </button>
                                <form method="post" action="{{ url_for('main.expense_delete', eid=invoice.id) }}" class="d-inline" onsubmit="return confirm('{{ _('Delete this expense invoice? / Ø­Ø°Ù ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ù‡Ø°Ù‡ØŸ') }}')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="{{ _('Delete / Ø­Ø°Ù') }}">ğŸ—‘ï¸</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<!-- SocketIO and JavaScript -->
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
    // SocketIO for real-time updates
    var socket = io();
    socket.on('expense_update', function(data) {
        console.log('Expense updated:', data);
        alert('New expense invoice created: ' + data.invoice_number + ' - $' + data.total);
        location.reload();
    });

    // Payment status handling
    document.getElementById('expense-status')?.addEventListener('change', function() {
        const partialBox = document.getElementById('expense-partial-box');
        if (this.value === 'partial') {
            partialBox.style.display = 'block';
        } else {
            partialBox.style.display = 'none';
        }
    });

    // Auto-calculation functionality
    function calculateTotals() {
        let totalBeforeTax = 0;
        let totalTax = 0;
        let totalDiscount = 0;

        document.querySelectorAll('.item-row').forEach(row => {
            const quantityInput = row.querySelector('input[name$="-quantity"]');
            const priceInput = row.querySelector('input[name$="-price_before_tax"]');
            const taxInput = row.querySelector('input[name$="-tax"]');
            const discountInput = row.querySelector('input[name$="-discount"]');
            const totalDisplay = row.querySelector('.item-total');

            const quantity = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const tax = parseFloat(taxInput.value) || 0;
            const discount = parseFloat(discountInput.value) || 0;

            const itemBeforeTax = quantity * price;
            const itemTotal = itemBeforeTax + tax - discount;

            totalDisplay.textContent = '$' + itemTotal.toFixed(2);
            totalBeforeTax += itemBeforeTax;
            totalTax += tax;
            totalDiscount += discount;
        });

        const finalTotal = totalBeforeTax + totalTax - totalDiscount;

        document.getElementById('total-before-tax').textContent = '$' + totalBeforeTax.toFixed(2);
        document.getElementById('tax-amount').textContent = '$' + totalTax.toFixed(2);
        document.getElementById('total-discount').textContent = '$' + totalDiscount.toFixed(2);
        document.getElementById('final-total').textContent = '$' + finalTotal.toFixed(2);
        try{ if(typeof updateExpensePartialMax==='function') updateExpensePartialMax(); }catch(e){}
    }

    // Event listeners
    document.addEventListener('change', e => {
        if (e.target.matches('input[name$="-quantity"], input[name$="-price_before_tax"], input[name$="-tax"], input[name$="-discount"]')) {
            calculateTotals();
        }
    });

    // Add new item functionality
    let itemIndex = {{ form.items|length }};

    document.getElementById('add-item').addEventListener('click', function() {
        const container = document.getElementById('items-container');
        const newItem = document.createElement('div');
        newItem.className = 'item-row';
        newItem.innerHTML = `
            <button type=\"button\" class=\"btn btn-sm btn-outline-danger remove-row-btn remove-item-btn\" title=\"Remove\">âœ–</button>
            <div class=\"row g-2 align-items-end\">
                <div class=\"col-md-4\">
                    <label class=\"form-label fw-bold\">{{ _('Description / Ø§Ù„ÙˆØµÙ') }}</label>
                    <input class=\"form-control\" name=\"items-${itemIndex}-description\" type=\"text\" placeholder=\"{{ _('e.g., Office rent, Electricity bill / Ù…Ø«Ù„: Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ù…ÙƒØªØ¨ØŒ ÙØ§ØªÙˆØ±Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡') }}\">
                </div>
                <div class=\"col-md-2\">
                    <label class=\"form-label fw-bold\">{{ _('Quantity / Ø§Ù„ÙƒÙ…ÙŠØ©') }}</label>
                    <div class=\"input-group\">
                        <input class=\"form-control\" name=\"items-${itemIndex}-quantity\" step=\"0.01\" type=\"number\" value=\"1\">
                        <span class=\"input-group-text\">{{ _('unit / ÙˆØ­Ø¯Ø©') }}</span>
                    </div>
                </div>
                <div class=\"col-md-2\">
                    <label class=\"form-label fw-bold\">{{ _('Unit Price / Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©') }}</label>
                    <div class=\"input-group\">
                        <span class=\"input-group-text\">$</span>
                        <input class=\"form-control\" name=\"items-${itemIndex}-price_before_tax\" step=\"0.01\" type=\"number\">
                    </div>
                </div>
                <div class=\"col-md-1\">
                    <label class=\"form-label fw-bold\">{{ _('Tax / Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©') }}</label>
                    <div class=\"input-group\">
                        <span class=\"input-group-text\">$</span>
                        <input class=\"form-control\" name=\"items-${itemIndex}-tax\" step=\"0.01\" type=\"number\" value=\"0\">
                    </div>
                </div>
                <div class=\"col-md-1\">
                    <label class=\"form-label fw-bold\">{{ _('Discount / Ø§Ù„Ø®ØµÙ…') }}</label>
                    <div class=\"input-group\">
                        <span class=\"input-group-text\">$</span>
                        <input class=\"form-control\" name=\"items-${itemIndex}-discount\" step=\"0.01\" type=\"number\" value=\"0\">
                    </div>
                </div>
                <div class=\"col-md-2\">
                    <label class=\"form-label fw-bold\">{{ _('Total / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ') }}</label>
                    <div class=\"form-control bg-success text-white fw-bold item-total\">$0.00</div>
                </div>
            </div>
        `;
        container.appendChild(newItem);
        itemIndex++;
        calculateTotals();
    });

    // Remove item functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-item-btn')) {
            e.target.closest('.item-row').remove();
            calculateTotals();
        }
    });

    // Clear expense form
    function clearExpenseForm() {
        document.getElementById('expense-form').reset();
        document.getElementById('items-container').innerHTML = '';
        calculateTotals();
        // Add one default item
        document.getElementById('add-item').click();
    }

    // Search functionality
    document.getElementById('invoiceSearch')?.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('#invoicesTableBody tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    });

    // Export expenses
    window.exportExpenses = function() {
        // Get all invoice data
        const rows = [];
        const tableRows = document.querySelectorAll('#invoicesTableBody tr');
        
        // Add header
        rows.push(['Invoice No', 'Date', 'Payment Method', 'Total', 'Status', 'Items']);
        
        // Add data rows
        tableRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 7) {
                const invoiceNo = cells[1].textContent.trim();
                const date = cells[2].textContent.trim();
                const payment = cells[3].textContent.trim();
                const total = cells[4].textContent.trim();
                const status = cells[5].textContent.trim();
                const items = cells[6].textContent.trim();
                
                rows.push([invoiceNo, date, payment, total, status, items]);
            }
        });
        
        // Convert to CSV
        const csvContent = rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
        
        // Download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'expenses_export.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // View invoice details
    window.viewInvoice = function(invoiceId) {
        // Open in new tab
        window.open(`/expenses/${invoiceId}/view`, '_blank');
    }

    // Edit invoice
    window.editInvoice = async function(invoiceId) {
        // Redirect to edit page
        if (await window.showConfirm('{{ _("Edit this expense invoice? / ØªØ¹Ø¯ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ù‡Ø°Ù‡ØŸ") }}')) {
            window.location.href = '/expenses/' + invoiceId + '/edit';
        }
    }

    // Delete expense invoice
    window.deleteExpenseInvoice = async function(invoiceId, invoiceNumber) {
        if (await window.showConfirm('{{ _("Are you sure you want to delete expense invoice") }} "' + invoiceNumber + '"?\n\n{{ _("This action cannot be undone.") }}')) {
            // Create a form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/expenses/' + invoiceId + '/delete';

            // Add CSRF token if available
            const csrfToken = document.querySelector('input[name="csrf_token"]');
            if (csrfToken) {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = 'csrf_token';
                tokenInput.value = csrfToken.value;
                form.appendChild(tokenInput);
            }

            document.body.appendChild(form);
            form.submit();
        }
    }

<script>
(function(){
  function parseMoneyText(txt){ const s = String(txt||'').replace(/[^0-9.\-]/g,''); const v = parseFloat(s); return isNaN(v)?0:v; }
  function updateExpensePartialMax(){
    const max = parseMoneyText(document.getElementById('final-total')?.textContent||'0');
    const span = document.getElementById('expense-partial-max'); if(span) span.textContent = '$' + max.toFixed(2);
    const inp = document.getElementById('expense-partial-amount');
    if(inp){ let v = parseFloat(inp.value||'0'); if(isNaN(v)) v = 0; if(v>max) inp.value = max.toFixed(2); if(v<0) inp.value='0.00'; }
  }
  function toggleExpensePartial(){
    const sel = document.getElementById('expense-status');
    const box = document.getElementById('expense-partial-box');
    if(!sel || !box) return;
    if((sel.value||'').toLowerCase()==='partial'){ box.style.display=''; updateExpensePartialMax(); }
    else { box.style.display='none'; }
  }
  document.addEventListener('DOMContentLoaded', function(){
    const sel = document.getElementById('expense-status');
    if(sel){ sel.addEventListener('change', toggleExpensePartial); }
    toggleExpensePartial();
    updateExpensePartialMax();
  });
})();
</script>


    // Initialize calculations
    document.addEventListener('DOMContentLoaded', function() {
        calculateTotals();
    });
</script>

{% endblock %}
