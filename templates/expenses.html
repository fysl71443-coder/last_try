{% extends 'base.html' %}
{% set back_url = url_for('main.dashboard') %}

{% block title %}{{ _('Expenses') }}{% endblock %}
{% block content %}

<style>.expense-highlight{ font-weight:700; color:var(--danger,#e74c3c); }</style>

<div class="container py-4 ops-layout hub-wrap">
    <div class="ops-header-bar">
        <span class="ops-icon"><i class="fa-solid fa-wallet"></i></span>
        <div>
            <h1 class="ops-title mb-0">{{ _('Expenses') }}</h1>
            <span class="ops-subtitle">{{ _('Add and view expense invoices') }}</span>
        </div>
        <div class="ops-actions d-flex flex-wrap gap-2" data-partial-links>
            <a href="{{ url_for('purchases.purchases') }}" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-cart-shopping me-1"></i>{{ _('Purchases') }}</a>
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-sm"><i class="fa-solid fa-house me-1"></i>{{ _('Dashboard') }}</a>
        </div>
    </div>

    {% if invoices %}
    <div class="kpi-row">
        {% set total_expenses = invoices|sum(attribute='total_after_tax_discount') %}
        {% set paid_expenses = invoices|selectattr('status','equalto','paid')|sum(attribute='total_after_tax_discount') %}
        {% set pending_expenses = total_expenses - paid_expenses %}
        <div class="kpi-card kpi-card--blue"><div class="kpi-value">{{ invoices|length }}</div><div class="kpi-label">{{ _('Invoices') }}</div></div>
        <div class="kpi-card kpi-card--red"><div class="kpi-value">ï·¼{{ "%.2f"|format(total_expenses) }}</div><div class="kpi-label">{{ _('Total') }}</div></div>
        <div class="kpi-card kpi-card--green"><div class="kpi-value">ï·¼{{ "%.2f"|format(paid_expenses) }}</div><div class="kpi-label">{{ _('Paid') }}</div></div>
        <div class="kpi-card kpi-card--orange"><div class="kpi-value">ï·¼{{ "%.2f"|format(pending_expenses) }}</div><div class="kpi-label">{{ _('Pending') }}</div></div>
    </div>
    {% endif %}

    <div class="ops-tabs-wrap">
        <div class="ops-tabs" role="tablist">
            <button type="button" class="ops-tab active" data-panel="panel-add">{{ _('Add') }}</button>
            <button type="button" class="ops-tab" data-panel="panel-log">{{ _('Log') }}</button>
        </div>
    </div>
    <div class="ops-body ops-body-no-sidebar">
        <main class="ops-main">
            <div id="panel-add" class="ops-panel" data-panel>
                <div class="ops-form-card">
                    <div class="ops-form-head d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <span>{{ _('Add Expense') }}</span>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="expense-type-driven-reset">ğŸ—‘ï¸ {{ _('Clear') }}</button>
                    </div>
                    <div class="ops-form-body">
                        <div class="alert alert-info border-0 py-2 mb-3"><i class="fas fa-info-circle me-2"></i><strong>{{ _('Tip') }}:</strong> {{ _('Choose expense type first â€” the system will set account, VAT, and payment.') }}</div>

                        <!-- Step 1: Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ (Mandatory) -->
                        <div class="ops-form-card mb-3">
                            <div class="ops-form-head"><i class="fa-solid fa-tags me-2"></i>{{ _('Step 1: Expense Type') }} <span class="text-danger">*</span></div>
                            <div class="ops-form-body">
                                <p class="text-muted small mb-2">{{ _('You cannot continue without selecting a type.') }}</p>
                                <div id="expense-type-cards" class="row g-2">
                                    <!-- populated by JS from /expenses/api/expense_types -->
                                </div>
                                <input type="hidden" name="expense_type" id="expense_type" value="">
                            </div>
                        </div>

                        <!-- Step 2: Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ±Ø¹ÙŠ (Sub-Type) -->
                        <div class="ops-form-card mb-3" id="expense-step2-box" style="display:none;">
                            <div class="ops-form-head"><i class="fa-solid fa-list me-2"></i>{{ _('Step 2: Sub-Type') }}</div>
                            <div class="ops-form-body">
                                <label class="form-label fw-bold">{{ _('Sub-Type') }}</label>
                                <select class="form-select" id="expense_sub_type" name="expense_sub_type">
                                    <option value="">{{ _('Select sub-type') }}</option>
                                </select>
                            </div>
                        </div>

                        <!-- Step 3: Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© -->
                        <form method="POST" id="expense-form" style="display:none;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="expense_type" id="expense_type_submit" value="">
                            <input type="hidden" name="expense_sub_type" id="expense_sub_type_submit" value="">
                            <div class="ops-form-card mb-3">
                                <div class="ops-form-head"><i class="fa-solid fa-file-invoice me-2"></i>{{ _('Step 3: Details') }}</div>
                                <div class="ops-form-body">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">{{ _('Date') }}</label>
                                            <input type="date" name="date" id="expense-date" class="form-control" value="{{ form.date.data or '' }}">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">{{ _('Payment Method') }}</label>
                                            <select name="payment_method" id="expense-payment-method" class="form-select">
                                                <option value="CASH">{{ _('Cash') }}</option>
                                                <option value="BANK">{{ _('Bank') }}</option>
                                                <option value="INTERNAL">{{ _('Internal / N/A') }}</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">{{ _('Payment Status') }}</label>
                                            <select name="status" id="expense-status" class="form-select">
                                                <option value="paid">{{ _('Paid') }}</option>
                                                <option value="partial">{{ _('Partial') }}</option>
                                                <option value="unpaid">{{ _('Unpaid') }}</option>
                                                <option value="posted">{{ _('Posted') }}</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">{{ _('Amount') }} (ï·¼) <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <span class="input-group-text">ï·¼</span>
                                                <input type="number" name="amount" id="expense-amount" class="form-control" step="0.01" min="0" placeholder="0.00" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6 d-flex align-items-end">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="expense-apply-vat" name="apply_vat">
                                                <label class="form-check-label" for="expense-apply-vat">{{ _('Apply 15%% VAT') }}</label>
                                            </div>
                                            <span class="ms-2 small text-muted" id="expense-vat-hint"></span>
                                        </div>
                                        <div class="col-12 small alert alert-secondary py-2 mb-0" id="expense-waste-hint" style="display:none;">
                                            <i class="fa-solid fa-info-circle me-1"></i> {{ _('Waste & Spoilage: Internal adjustment â€” no cash, no supplier, no VAT. Journal: Debit Expense (5160), Credit Inventory (1160).') }}
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label fw-bold">{{ _('Description') }}</label>
                                            <input type="text" name="description" id="expense-description" class="form-control" placeholder="{{ _('Optional') }}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary btn-lg px-4"><i class="fa-solid fa-save me-1"></i> {{ _('Save') }}</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="panel-log" class="ops-panel d-none" data-panel>
                <div class="ops-form-card">
                    <div class="ops-form-head d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <span>{{ _('Expense Invoices') }}</span>
                        <div class="d-flex gap-2">
                            <input type="text" class="form-control form-control-sm" id="invoiceSearch" placeholder="{{ _('Search...') }}" style="width:180px">
                            <button class="btn btn-outline-primary btn-sm" onclick="window.exportExpenses()"><i class="fa-solid fa-file-export me-1"></i>{{ _('Export') }}</button>
                        </div>
                    </div>
                    <div class="ops-form-body p-0">
    {% if invoices %}
                        <div class="table-responsive">
                            <table class="table table-hover align-middle screen-table mb-0">
                                <thead>
                                    <tr>
                                        <th class="text-center">#</th>
                                        <th>{{ _('Invoice No') }}</th>
                                        <th>{{ _('Date') }}</th>
                                        <th>{{ _('Payment') }}</th>
                                        <th class="text-end">{{ _('Total') }}</th>
                                        <th class="text-center">{{ _('Status') }}</th>
                                        <th class="text-center">{{ _('Items') }}</th>
                                        <th class="text-center">{{ _('Actions') }}</th>
                                    </tr>
                                </thead>
                                <tbody id="invoicesTableBody">
                                    {% for invoice in invoices %}
                                    <tr>
                                        <td class="text-center"><span class="badge bg-secondary">{{ loop.index }}</span></td>
                                        <td><strong class="text-primary">{{ invoice.invoice_number }}</strong></td>
                                        <td><span class="badge bg-light text-dark">{{ invoice.date.strftime('%Y-%m-%d') }}</span></td>
                                        <td>
                                            {% set pm = (invoice.payment_method or '')|lower %}
                                            {% if pm == 'internal' %}<span class="badge bg-secondary">{{ _('Internal') }}</span>
                                            {% elif pm == 'cash' %}<span class="badge bg-success">{{ _('Cash') }}</span>{% else %}<span class="badge bg-primary">{{ _('Bank') }}</span>{% endif %}
                                        </td>
                                        <td class="text-end"><span class="fw-bold text-danger fs-6">ï·¼{{ "%.2f"|format(invoice.total_after_tax_discount) }}</span></td>
                                        <td class="text-center">
                                            {% if invoice.status == 'posted' %}<span class="badge bg-secondary">{{ _('Posted') }}</span>
                                            {% elif invoice.status == 'paid' %}<span class="badge bg-success">{{ _('Paid') }}</span>
                                            {% elif invoice.status == 'partial' %}<span class="badge bg-warning">{{ _('Partial') }}</span>
                                            {% else %}<span class="badge bg-danger">{{ _('Unpaid') }}</span>{% endif %}
                                        </td>
                                        <td class="text-center"><span class="badge bg-info">{{ invoice.items|length }} {{ _('items') }}</span></td>
                                        <td class="text-center">
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-outline-info" onclick="window.viewInvoice({{ invoice.id }})" title="{{ _('View') }}">ğŸ‘ï¸</button>
                                                <form method="post" action="{{ url_for('expenses.expense_delete', eid=invoice.id) }}" class="d-inline" onsubmit="return confirm('{{ _('Delete this expense invoice?') }}')">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="{{ _('Delete') }}">ğŸ—‘ï¸</button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
    {% else %}
                        <div class="text-center text-muted py-5">{{ _('No expense invoices yet') }}</div>
    {% endif %}
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    // SocketIO optional (server may not have SocketIO; avoid 404 noise)
    try {
        if (typeof io === 'function') {
            var socket = io();
            socket.on('expense_update', function(data) {
                console.log('Expense updated:', data);
                location.reload();
            });
        }
    } catch (e) { /* Socket.IO not available */ }

    // --- Type-driven expense UI ---
    let EXPENSE_CATEGORIES = [];
    const typeCardsEl = document.getElementById('expense-type-cards');
    const expenseTypeEl = document.getElementById('expense_type');
    const step2Box = document.getElementById('expense-step2-box');
    const subTypeSelect = document.getElementById('expense_sub_type');
    const expenseFormEl = document.getElementById('expense-form');
    const expenseTypeSubmit = document.getElementById('expense_type_submit');
    const expenseSubTypeSubmit = document.getElementById('expense_sub_type_submit');
    const expenseVatCheck = document.getElementById('expense-apply-vat');
    const expenseVatHint = document.getElementById('expense-vat-hint');

    function expenseTypeReset() {
        expenseTypeEl.value = '';
        if (typeCardsEl) typeCardsEl.querySelectorAll('.expense-type-card').forEach(c => c.classList.remove('active', 'border-primary'));
        step2Box.style.display = 'none';
        subTypeSelect.innerHTML = '<option value="">{{ _("Select sub-type") }}</option>';
        subTypeSelect.value = '';
        expenseFormEl.style.display = 'none';
        expenseTypeSubmit.value = '';
        expenseSubTypeSubmit.value = '';
    }

    function loadExpenseTypes() {
        fetch('{{ url_for("expenses.expense_types_api") }}', { credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => {
                EXPENSE_CATEGORIES = data.categories || [];
                if (!typeCardsEl) return;
                typeCardsEl.innerHTML = '';
                EXPENSE_CATEGORIES.forEach(cat => {
                    const card = document.createElement('button');
                    card.type = 'button';
                    card.className = 'btn btn-outline-secondary expense-type-card text-start col-md-4 col-lg-3';
                    card.dataset.categoryId = cat.id;
                    const icon = (cat.icon && cat.icon.startsWith('fa-')) ? cat.icon : 'fa-tag';
                    card.innerHTML = '<i class="fa-solid ' + icon + ' me-2"></i><span>' + (cat.label_ar || cat.label_en || cat.id) + '</span>';
                    card.addEventListener('click', function() {
                        typeCardsEl.querySelectorAll('.expense-type-card').forEach(c => c.classList.remove('active', 'border-primary'));
                        this.classList.add('active', 'border-primary');
                        expenseTypeEl.value = cat.id;
                        step2Box.style.display = 'block';
                        subTypeSelect.innerHTML = '<option value="">Select sub-type</option>';
                        (cat.sub_types || []).forEach(st => {
                            const opt = document.createElement('option');
                            opt.value = st.id;
                            opt.textContent = (st.label_ar || st.label_en || st.id);
                            opt.dataset.defaultVat = (st.default_vat === true || st.default_vat === '1') ? '1' : '0';
                            opt.dataset.isWaste = (st.is_internal_adjustment === true && st.id === 'spoilage_waste') ? '1' : '0';
                            subTypeSelect.appendChild(opt);
                        });
                        expenseFormEl.style.display = 'none';
                    });
                    typeCardsEl.appendChild(card);
                });
            })
            .catch(e => console.error('Expense types load error', e));
    }

    const paymentMethodWrap = document.querySelector('.col-md-4:has(#expense-payment-method)');
    const paymentStatusWrap = document.querySelector('.col-md-4:has(#expense-status)');
    const vatRowWrap = document.querySelector('.col-md-6.d-flex.align-items-end');
    function toggleWasteUI(isWaste) {
        if (paymentMethodWrap) paymentMethodWrap.style.display = isWaste ? 'none' : '';
        if (paymentStatusWrap) paymentStatusWrap.style.display = isWaste ? 'none' : '';
        if (vatRowWrap) vatRowWrap.style.display = isWaste ? 'none' : '';
        const wasteHint = document.getElementById('expense-waste-hint');
        if (wasteHint) wasteHint.style.display = isWaste ? 'block' : 'none';
        if (isWaste) {
            const pm = document.getElementById('expense-payment-method');
            const st = document.getElementById('expense-status');
            if (pm) pm.value = 'INTERNAL';
            if (st) st.value = 'posted';
        }
    }
    if (subTypeSelect) {
        subTypeSelect.addEventListener('change', function() {
            const val = this.value;
            expenseSubTypeSubmit.value = val;
            expenseTypeSubmit.value = expenseTypeEl.value || '';
            if (val) {
                expenseFormEl.style.display = 'block';
                const opt = this.selectedOptions[0];
                const isWaste = opt && opt.dataset.isWaste === '1';
                toggleWasteUI(isWaste);
                if (opt && expenseVatCheck && !isWaste) {
                    const defaultVat = opt.dataset.defaultVat === '1';
                    expenseVatCheck.checked = defaultVat;
                    if (expenseVatHint) expenseVatHint.textContent = defaultVat ? '{{ _("VAT applied by default for this type") }}' : '';
                }
                if (isWaste && expenseVatCheck) expenseVatCheck.checked = false;
            } else {
                expenseFormEl.style.display = 'none';
                toggleWasteUI(false);
            }
        });
    }

    document.getElementById('expense-type-driven-reset')?.addEventListener('click', expenseTypeReset);

    expenseFormEl?.addEventListener('submit', function() {
        expenseTypeSubmit.value = expenseTypeEl.value || '';
        expenseSubTypeSubmit.value = subTypeSelect.value || '';
    });

    document.addEventListener('DOMContentLoaded', function() {
        loadExpenseTypes();
        const d = document.getElementById('expense-date');
        if (d && !d.value) {
            const t = new Date();
            d.value = t.getFullYear() + '-' + String(t.getMonth() + 1).padStart(2, '0') + '-' + String(t.getDate()).padStart(2, '0');
        }
    });

    // Search functionality
    document.getElementById('invoiceSearch')?.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('#invoicesTableBody tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    });

    // Export expenses
    window.exportExpenses = function() {
        // Get all invoice data
        const rows = [];
        const tableRows = document.querySelectorAll('#invoicesTableBody tr');
        
        // Add header
        rows.push(['Invoice No', 'Date', 'Payment Method', 'Total', 'Status', 'Items']);
        
        // Add data rows
        tableRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 7) {
                const invoiceNo = cells[1].textContent.trim();
                const date = cells[2].textContent.trim();
                const payment = cells[3].textContent.trim();
                const total = cells[4].textContent.trim();
                const status = cells[5].textContent.trim();
                const items = cells[6].textContent.trim();
                
                rows.push([invoiceNo, date, payment, total, status, items]);
            }
        });
        
        // Convert to CSV
        const csvContent = rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
        
        // Download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'expenses_export.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    const EXP_INVOICES = {{ (invoices_json or '[]') | safe }};
    // View invoice details
    window.viewInvoice = function(invoiceId) {
        const inv = EXP_INVOICES.find(x => x.id === invoiceId);
        if(!inv) return;
        const modalBody = document.getElementById('expenseModalBody');
        if(!modalBody) return;
        const rows = (inv.items||[]).map(it=>`
          <tr>
            <td>${it.description||''}</td>
            <td class="text-end">${(it.quantity||0).toFixed(2)}</td>
            <td class="text-end">ï·¼${(it.price_before_tax||0).toFixed(2)}</td>
            <td class="text-end">ï·¼${(it.discount||0).toFixed(2)}</td>
            <td class="text-end">ï·¼${(it.tax||0).toFixed(2)}</td>
            <td class="text-end">ï·¼${(it.total_price||0).toFixed(2)}</td>
          </tr>`).join('');
        modalBody.innerHTML = `
          <div class="mb-2"><strong>{{ _('Invoice No') }}:</strong> ${inv.invoice_number||'-'}</div>
          <div class="mb-2"><strong>{{ _('Date') }}:</strong> ${inv.date||'-'}</div>
          <div class="mb-2"><strong>{{ _('Payment') }}:</strong> ${(inv.payment_method||'-').toUpperCase()}</div>
          <div class="mb-2"><strong>{{ _('Status') }}:</strong> ${(inv.status||'-').toUpperCase()}</div>
          <div class="mb-2"><strong>{{ _('Total') }}:</strong> ï·¼${(inv.total||0).toFixed(2)}</div>
          <div class="table-responsive">
            <table class="table table-sm table-bordered align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>{{ _('Description') }}</th>
                  <th class="text-end">{{ _('Quantity') }}</th>
                  <th class="text-end">{{ _('Unit Price') }}</th>
                  <th class="text-end">{{ _('Discount') }}</th>
                  <th class="text-end">{{ _('Tax') }}</th>
                  <th class="text-end">{{ _('Total') }}</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
        const m = new bootstrap.Modal(document.getElementById('expenseViewModal'));
        m.show();
    }

    // Edit invoice
    window.editInvoice = async function(invoiceId) {
        // Redirect to edit page
        if (await window.showConfirm('{{ _("Edit this expense invoice?") }}')) {
            window.location.href = '/expenses/' + invoiceId + '/edit';
        }
    }

    // Delete expense invoice
    window.deleteExpenseInvoice = async function(invoiceId, invoiceNumber) {
        if (await window.showConfirm('{{ _("Are you sure you want to delete expense invoice") }} "' + invoiceNumber + '"?\n\n{{ _("This action cannot be undone.") }}')) {
            // Create a form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/expenses/' + invoiceId + '/delete';

            // Add CSRF token if available
            const csrfToken = document.querySelector('input[name="csrf_token"]');
            if (csrfToken) {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = 'csrf_token';
                tokenInput.value = csrfToken.value;
                form.appendChild(tokenInput);
            }

            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
<script>
(function(){
  function parseMoneyText(txt){ const s = String(txt||'').replace(/[^0-9.\-]/g,''); const v = parseFloat(s); return isNaN(v)?0:v; }
  function updateExpensePartialMax(){
    const max = parseMoneyText(document.getElementById('final-total')?.textContent||'0');
    const span = document.getElementById('expense-partial-max'); if(span) span.textContent = 'ï·¼' + max.toFixed(2);
    const inp = document.getElementById('expense-partial-amount');
    if(inp){ let v = parseFloat(inp.value||'0'); if(isNaN(v)) v = 0; if(v>max) inp.value = max.toFixed(2); if(v<0) inp.value='0.00'; }
  }
  function toggleExpensePartial(){
    const sel = document.getElementById('expense-status');
    const box = document.getElementById('expense-partial-box');
    if(!sel || !box) return;
    if((sel.value||'').toLowerCase()==='partial'){ box.style.display=''; updateExpensePartialMax(); }
    else { box.style.display='none'; }
  }
  document.addEventListener('DOMContentLoaded', function(){
    const sel = document.getElementById('expense-status');
    if(sel){ sel.addEventListener('change', toggleExpensePartial); }
    toggleExpensePartial();
    updateExpensePartialMax();
  });
})();
</script>

<div class="modal fade" id="expenseViewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ _('Expense Details') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="expenseModalBody"></div>
    </div>
  </div>
</div>


    <script>
    document.addEventListener('DOMContentLoaded', function() {
        try{ const d=document.getElementById('scDate'); if(d && !d.value){ const t=new Date(); const y=t.getFullYear(); const m=String(t.getMonth()+1).padStart(2,'0'); const dd=String(t.getDate()).padStart(2,'0'); d.value=t.getFullYear()+'-'+m+'-'+dd; } }catch(e){}
    });
    let currentScenario = null;
    function openScenario(s){ var f=document.getElementById('scenarioForm'); if(!f) return; currentScenario = s; f.style.display='block';
      document.getElementById('scVatBox').style.display = ((s==='maintenance')||(s==='prepaid_rent'))?'block':'none';
      document.getElementById('scBankFeeBox').style.display = (s==='cash_deposit')?'block':'none';
      const pBox = document.getElementById('scPurchaseBox'); const pItemBox = document.getElementById('scPurchaseItemBox');
      if(pBox&&pItemBox){ const show = (s==='purchase_no_vat'); pBox.style.display = show?'block':'none'; pItemBox.style.display = show?'block':'none'; }
      const autoBtn = document.getElementById('scAutoBtn'); autoBtn.style.display='none'; autoBtn.onclick=null; autoBtn.textContent='';
      if(s==='vat'){ autoBtn.style.display='inline-block'; autoBtn.textContent='Auto-fill VAT Net / Ù…Ù„Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„ØµØ§ÙÙŠ VAT'; autoBtn.onclick=function(){ const b=document.getElementById('scBranch').value; const d=document.getElementById('scDate').value; const u='/api/vat/net?branch='+encodeURIComponent(b)+'&end_date='+encodeURIComponent(d||''); fetch(u, {credentials:'same-origin'}).then(r=>r.json()).then(j=>{ if(j&&j.ok){ document.getElementById('scAmount').value = j.net||0; previewScenario(); } }); } }
      if(s==='cash_deposit'){ autoBtn.style.display='inline-block'; autoBtn.textContent='Suggest Deposit Amount / Ø§Ù‚ØªØ±Ø§Ø­ Ù…Ø¨Ù„Øº Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹'; autoBtn.onclick=function(){ const b=document.getElementById('scBranch').value; const d=document.getElementById('scDate').value; const u='/api/sales/cash_total?branch='+encodeURIComponent(b)+'&end_date='+encodeURIComponent(d||''); fetch(u, {credentials:'same-origin'}).then(r=>r.json()).then(j=>{ if(j&&j.ok){ document.getElementById('scAmount').value = j.amount||0; previewScenario(); } }); } }
      if(s==='purchase_no_vat'){ try{ fetch('/api/purchase-categories',{credentials:'same-origin'}).then(r=>r.json()).then(j=>{ const sel=document.getElementById('scPurchaseType'); const selIt=document.getElementById('scPurchaseItem'); if(!sel||!selIt) return; sel.innerHTML=''; selIt.innerHTML=''; const pc=(j.purchase_categories||[]); const opts=[]; pc.forEach(cat=>{ const catLabel=((cat.category?.en)||'')+' / '+((cat.category?.ar)||''); (cat.subcategories||[]).forEach(sub=>{ const subLabel=((sub.name?.en)||'')+' / '+((sub.name?.ar)||''); const val=((cat.category?.en)||'')+'::'+((sub.name?.en)||''); opts.push({v:val,l:catLabel+' â€“ '+subLabel,items:(sub.items||[])}); }); }); opts.forEach(o=>{ const opt=document.createElement('option'); opt.value=o.v; opt.textContent=o.l; opt.dataset.items=JSON.stringify(o.items||[]); sel.appendChild(opt); }); const updItems=function(){ const cur=sel.selectedOptions[0]; const items=cur?JSON.parse(cur.dataset.items||'[]'):[]; selIt.innerHTML=''; const def=document.createElement('option'); def.value=''; def.textContent='â€”'; selIt.appendChild(def); items.forEach(it=>{ const lbl=((it.en)||'')+' / '+((it.ar)||''); const op=document.createElement('option'); op.value=lbl; op.textContent=lbl; selIt.appendChild(op); }); }; sel.addEventListener('change', function(){ updItems(); previewScenario(); }); updItems(); }); }catch(e){} }
      previewScenario(); }
    function closeScenario(){ var f=document.getElementById('scenarioForm'); if(!f) return; currentScenario=null; f.style.display='none'; }
    function previewScenario(){
      const scAmount = document.getElementById('scAmount'); if(!scAmount) return;
      const amt = parseFloat(scAmount.value||'0')||0;
      const pm = document.getElementById('scPM').value;
      const dt = document.getElementById('scDate').value;
      const br = document.getElementById('scBranch').value;
      const vatOn = !!document.getElementById('scApplyVat')?.checked;
      const scenLabels = {
        'salaries': 'Salaries Payment / Ø³Ø¯Ø§Ø¯ Ø±ÙˆØ§ØªØ¨',
        'vat': 'VAT Settlement / Ø³Ø¯Ø§Ø¯ Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©',
        'purchase_no_vat': 'Operating Purchases (No VAT) / Ù…Ø´ØªØ±ÙŠØ§Øª ØªØ´ØºÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø¶Ø±ÙŠØ¨Ø©',
        'maintenance': 'Maintenance & Services / ØµÙŠØ§Ù†Ø©/Ø®Ø¯Ù…Ø§Øª',
        'prepaid_rent': 'Prepaid Rent / Ø¥ÙŠØ¬Ø§Ø± Ù…Ù‚Ø¯Ù‘Ù…',
        'cash_deposit': 'Bank Cash Deposit / Ø¥ÙŠØ¯Ø§Ø¹ Ù†Ù‚Ø¯ÙŠ Ø¨Ø§Ù„Ø¨Ù†Ùƒ'
      };
      const pmLabel = pm==='cash' ? 'Cash / Ù†Ù‚Ø¯Ø§Ù‹' : (pm==='bank' ? 'Bank / Ø¨Ù†Ùƒ' : 'Creditors / Ù…ÙˆØ±Ø¯ÙŠÙ†');
      const brLabel = br==='place_india' ? 'Place India / Ø¨Ø§Ù„Ø§Ø³ Ø§Ù†Ø¯ÙŠØ§' : (br==='china_town' ? 'China Town / ØªØ´Ø§ÙŠÙ†Ø§ ØªØ§ÙˆÙ†' : 'All / Ø§Ù„ÙƒÙ„');
      const vatNote = vatOn ? 'Includes 15% VAT / ÙŠØ´Ù…Ù„ Ø¶Ø±ÙŠØ¨Ø© Ù‚ÙŠÙ…Ø© Ù…Ø¶Ø§ÙØ© 15%' : 'No VAT applied / Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¶Ø±ÙŠØ¨Ø©';
      const catSel=document.getElementById('scPurchaseType'); const itSel=document.getElementById('scPurchaseItem');
      const catLbl=(catSel && catSel.value)?catSel.options[catSel.selectedIndex].textContent:'';
      const itLbl=(itSel && itSel.value)?itSel.options[itSel.selectedIndex].textContent:'';
      const extra = (currentScenario==='purchase_no_vat')? (` â€” Type: ${catLbl||'-'}; Item: ${itLbl||'-'}`) : '';
      const extraAr = (currentScenario==='purchase_no_vat')? (` â€” Ø§Ù„Ù†ÙˆØ¹: ${catLbl||'-'}Ø› Ø§Ù„ØµÙ†Ù: ${itLbl||'-'}`) : '';
      const txtEn = `Will record ${scenLabels[currentScenario]||'Expense / Ù…ØµØ±ÙˆÙ'} amount SAR ${amt.toFixed(2)} via ${pmLabel} on ${dt||''} â€” Branch: ${brLabel}. ${vatNote}.${extra}`;
      const txtAr = `Ø³ÙŠØªÙ… Ø¥Ø«Ø¨Ø§Øª ${scenLabels[currentScenario]?.split(' / ')[1]||'Ù…ØµØ±ÙˆÙ'} Ø¨Ù…Ø¨Ù„Øº ï·¼${amt.toFixed(2)} Ù…Ù† ${pm==='cash'?'Ù†Ù‚Ø¯Ø§Ù‹':(pm==='bank'?'Ø¨Ù†Ùƒ':'Ù…ÙˆØ±Ø¯ÙŠÙ†')} Ø¨ØªØ§Ø±ÙŠØ® ${dt||''} â€” Ø§Ù„ÙØ±Ø¹: ${br==='place_india'?'Ø¨Ø§Ù„Ø§Ø³ Ø§Ù†Ø¯ÙŠØ§':(br==='china_town'?'ØªØ´Ø§ÙŠÙ†Ø§ ØªØ§ÙˆÙ†':'Ø§Ù„ÙƒÙ„')}. ${vatOn?'ÙŠØ´Ù…Ù„ Ø¶Ø±ÙŠØ¨Ø© Ù‚ÙŠÙ…Ø© Ù…Ø¶Ø§ÙØ© 15%':'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¶Ø±ÙŠØ¨Ø©'}${extraAr}.`;
      const el = document.getElementById('scPreview');
      el.innerHTML = `<div>${txtEn}</div><div>${txtAr}</div>`;
    }
    function submitScenario(){ if(!document.getElementById('scenarioForm')) return; const payload={ scenario: currentScenario, amount: document.getElementById('scAmount')?.value, date: document.getElementById('scDate')?.value, branch: document.getElementById('scBranch')?.value, payment_method: document.getElementById('scPM')?.value, apply_vat: document.getElementById('scApplyVat')?.checked, bank_fee: document.getElementById('scBankFee')?.value, note: document.getElementById('scNote')?.value, purchase_category: document.getElementById('scPurchaseType')?.value||'', purchase_item: document.getElementById('scPurchaseItem')?.value||'' }; fetch('/api/expenses/proof', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), credentials:'same-origin' }).then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }).then(j=>{ if(j&&j.ok){ closeScenario(); location.reload(); } else { alert('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + (j&&j.error ? j.error : '')); } }).catch(e=>{ alert('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + (e&&e.message ? e.message : '')); }); }
    ['scAmount','scDate','scPM','scBranch'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.addEventListener('input', previewScenario); el.addEventListener('change', previewScenario); }});
    document.querySelectorAll('.ops-tabs-wrap .ops-tab[data-panel]').forEach(function(btn){
      btn.addEventListener('click', function(){
        var id = this.getAttribute('data-panel');
        document.querySelectorAll('.ops-tabs-wrap .ops-tab[data-panel]').forEach(function(b){ b.classList.remove('active'); });
        document.querySelectorAll('.ops-panel[data-panel]').forEach(function(p){ p.classList.add('d-none'); });
        this.classList.add('active');
        var panel = document.getElementById(id);
        if (panel) panel.classList.remove('d-none');
      });
    });
    </script>

{% endblock %}
