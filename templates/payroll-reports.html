<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تقارير الرواتب - Payroll Reports</title>
  <style>
    :root{
      --accent:#0b5ed7;
      --muted:#6c757d;
      --border:#d6d8db;
      --bg:#ffffff;
      --paper-margin:20mm;
    }

    html,body{margin:0;padding:0;background:#f4f6f8;font-family: "Segoe UI", Tahoma, "Helvetica Neue", Arial; color:#222;}
    .container{max-width:1100px;margin:18px auto;padding:18px;background:var(--bg);box-shadow:0 2px 8px rgba(16,24,40,0.06);border-radius:8px;}
    .controls{display:flex;gap:8px;justify-content:flex-start;margin-bottom:12px;align-items:center;}
    button.control{background:#fff;border:1px solid var(--border);padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600;}
    button.control:hover{box-shadow:0 2px 6px rgba(11,94,215,0.08)}
    .btn-print{background:var(--accent);color:#fff;border:0}
    .btn-danger{background:#e95757;color:#fff;border:0}
    .header{display:flex;gap:12px;align-items:center;justify-content:space-between;border-bottom:2px solid var(--border);padding-bottom:12px;margin-bottom:14px}
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{height:64px;object-fit:contain;border-radius:6px}
    .report-title{font-size:18px;font-weight:700}
    .meta{font-size:13px;color:var(--muted);text-align:left}

    table.report{width:100%;border-collapse:collapse;margin-top:14px;background:var(--bg)}
    table.report th, table.report td{border:1px solid var(--border);padding:8px 10px;text-align:center;font-size:13px}
    table.report th{background:#f1f5f9;font-weight:700}
    table.report tbody tr:nth-child(even){background:#fbfcfd}
    .totals-row th, .totals-row td{background:#0b5ed7;color:#fff;font-weight:700}

    .summary{display:flex;gap:14px;justify-content:space-between;margin-top:18px}
    .summary .box{background:#fafbff;padding:12px;border-radius:8px;border:1px solid var(--border);flex:1}
    .summary .box h4{margin:0 0 6px 0;font-size:14px}
    .summary .box p{margin:0;color:var(--muted);font-size:14px}

    .receipt{max-width:780px;margin:18px auto;padding:16px;border:1px dashed var(--border);border-radius:8px;background:#fff}
    .receipt .row{display:flex;justify-content:space-between;gap:10px;margin-bottom:8px;font-size:14px}

    @media print{
      .controls, .no-print {display:none !important}
      @page { margin: var(--paper-margin); }
      body{background:transparent}
      .container{box-shadow:none;border-radius:0;padding:0;margin:0}
      * { color:#000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      table.report th { background:#fff !important; }
      .totals-row th, .totals-row td { background:#fff !important; color:#000 !important; border-color:#000 !important; }
    }
  </style>
  {% if auto_print %}
  <script>
    window.addEventListener('load', function(){ setTimeout(function(){ window.print(); }, 200); });
    {% if close_after_print %}
    window.addEventListener('afterprint', function(){ window.close(); });
    {% endif %}
  </script>
  {% endif %}
</head>
<body>

  <div class="container" id="page">

    <div class="controls no-print">
      <button class="control btn-print" onclick="window.print()">🖨️ طباعة</button>
      <button class="control" onclick="history.back()">⬅︎ رجوع</button>
      <button class="control btn-danger" onclick="window.close()">✖︎ إغلاق</button>
      <div style="flex:1"></div>
      <div class="meta no-print" id="print-timestamp">تم الطباعة: --</div>
    </div>

    <div class="header">
      <div class="brand">
        <img src="{{ company_logo or url_for('static', filename='logo.svg') }}" alt="Logo" />
        <div>
          <div style="font-weight:800;font-size:16px">{{ company_name or 'Global Restaurant / اسم الشركة' }}</div>
          <div style="color:var(--muted);font-size:13px">{{ company_tagline or 'Address or Tagline' }}</div>
        </div>
      </div>
      <div style="text-align:left">
        <div class="report-title" id="current-report-title">{{ report_title or '🧾 Detailed Payroll Report / تقرير الرواتب التفصيلي' }}</div>
        <div class="meta" id="report-period">{% if start_year and start_month and end_year and end_month %}From {{ start_year }}/{{ start_month }} to {{ end_year }}/{{ end_month }} / من {{ start_year }}/{{ start_month }} إلى {{ end_year }}/{{ end_month }}{% elif year and month %}{{ year }}/{{ '%02d'|format(month) }}{% endif %}</div>
      </div>
    </div>

    {# Detailed summary (all/selected) #}
    {% if mode in ['all','selected'] and employees %}
    <section id="detailed-report">
      <table class="report" aria-label="Detailed Payroll Report">
        <thead>
          <tr>
            <th style="width:40px">#</th>
            <th>Employee / الموظف</th>
            <th style="width:120px">Unpaid Months / الأشهر غير المدفوعة</th>
            <th style="width:110px">Basic / الأساسي</th>
            <th style="width:110px">Allowances / البدلات</th>
            <th style="width:120px">Deductions / الاستقطاعات</th>
            <th style="width:110px">Previous Due / سابقة</th>
            <th style="width:120px">Total / الإجمالي</th>
            <th style="width:110px">Paid / المدفوع</th>
            <th style="width:110px">Remaining / المتبقي</th>
          </tr>
        </thead>
        <tbody>
          {% for e in employees %}
          <tr>
            <td>{{ loop.index }}</td>
            <td style="text-align:left;padding-left:12px">{{ e.name }}</td>
            <td>{{ e.unpaid_months }}</td>
            <td>{{ '%.2f'|format(e.basic_total) }}</td>
            <td>{{ '%.2f'|format(e.allowances_total) }}</td>
            <td>{{ '%.2f'|format(e.deductions_total) }}</td>
            <td>{{ '%.2f'|format(e.prev_due) }}</td>
            <td>{{ '%.2f'|format(e.total) }}</td>
            <td>{{ '%.2f'|format(e.paid) }}</td>
            <td>{{ '%.2f'|format(e.remaining) }}</td>
          </tr>
          {% endfor %}
        </tbody>
        {% if grand %}
        <tfoot>
          <tr class="totals-row">
            <th colspan="3">Grand Totals / الإجماليات</th>
            <th>{{ '%.2f'|format(grand.basic) }}</th>
            <th>{{ '%.2f'|format(grand.allowances) }}</th>
            <th>{{ '%.2f'|format(grand.deductions) }}</th>
            <th>{{ '%.2f'|format(grand.prev_due) }}</th>
            <th>{{ '%.2f'|format(grand.total) }}</th>
            <th>{{ '%.2f'|format(grand.paid) }}</th>
            <th>{{ '%.2f'|format(grand.remaining) }}</th>
          </tr>
        </tfoot>
        {% endif %}
      </table>
    </section>
    {% endif %}

    {# Monthly statement #}
    {% if mode == 'monthly' and payrolls %}
    <section id="monthly-statement" style="margin-top:28px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">🧾 Monthly Payroll Statement / كشف رواتب الشهر</div>
        <div class="meta">{{ year }}/{{ '%02d'|format(month) }}</div>
      </div>

      <table class="report" aria-label="Monthly Payroll Statement" style="margin-top:8px">
        <thead>
          <tr>
            <th style="width:40px">#</th>
            <th>Employee / الموظف</th>
            <th>Basic / الأساسي</th>
            <th>Allowances / البدلات</th>
            <th>Deductions / الاستقطاعات</th>
            <th>Previous Due / سابقة</th>
            <th>Total / الإجمالي</th>
            <th>Paid / المدفوع</th>
            <th>Remaining / المتبقي</th>
            <th style="width:110px">Status / الحالة</th>
          </tr>
        </thead>
        <tbody>
          {% for r in payrolls %}
          <tr>
            <td>{{ loop.index }}</td>
            <td style="text-align:left;padding-left:12px">{{ r.employee.full_name }}</td>
            <td>{{ '%.2f'|format(r.basic) }}</td>
            <td>{{ '%.2f'|format(r.allowances) }}</td>
            <td>{{ '%.2f'|format(r.deductions) }}</td>
            <td>{{ '%.2f'|format(r.prev_due) }}</td>
            <td>{{ '%.2f'|format(r.total) }}</td>
            <td>{{ '%.2f'|format(r.paid) }}</td>
            <td>{{ '%.2f'|format(r.remaining) }}</td>
            <td>{{ r.status }}</td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          {% set tb = payrolls|sum(attribute='basic') %}
          {% set ta = payrolls|sum(attribute='allowances') %}
          {% set td = payrolls|sum(attribute='deductions') %}
          {% set tpv = payrolls|sum(attribute='prev_due') %}
          {% set tt = payrolls|sum(attribute='total') %}
          {% set tpd = payrolls|sum(attribute='paid') %}
          {% set trm = payrolls|sum(attribute='remaining') %}
          <tr class="totals-row">
            <th colspan="2">Totals / الإجماليات</th>
            <th>{{ '%.2f'|format(tb) }}</th>
            <th>{{ '%.2f'|format(ta) }}</th>
            <th>{{ '%.2f'|format(td) }}</th>
            <th>{{ '%.2f'|format(tpv) }}</th>
            <th>{{ '%.2f'|format(tt) }}</th>
            <th>{{ '%.2f'|format(tpd) }}</th>
            <th>{{ '%.2f'|format(trm) }}</th>
            <th>-</th>
          </tr>
        </tfoot>
      </table>
    </section>
    {% endif %}

    {# Individual detailed (single employee) #}
    {% if mode == 'single' and employees and employees[0].months is not none %}
    {% set e = employees[0] %}
    <section id="individual-details" style="margin-top:28px">
      <div style="font-weight:700;margin-bottom:8px">Report Payroll Detailed / تقرير الرواتب التفصيلي (تفاصيل موظف)</div>
      <div style="border:1px solid var(--border);padding:12px;border-radius:8px;background:#fff">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div><strong>Employee / الموظف:</strong> {{ e.name }}</div>
          <div class="meta">Period: {{ start_year }}/{{ start_month }} to {{ end_year }}/{{ end_month }}</div>
        </div>
        <table class="report" style="margin-top:6px">
          <thead>
            <tr>
              <th>#</th>
              <th>Year</th>
              <th>Month</th>
              <th>Basic / الأساسي</th>
              <th>Allowances / البدلات</th>
              <th>Deductions / الاستقطاعات</th>
              <th>Previous Due / سابقة</th>
              <th>Total / الإجمالي</th>
              <th>Paid / المدفوع</th>
              <th>Remaining / المتبقي</th>
              <th>Status / الحالة</th>
            </tr>
          </thead>
          <tbody>
            {% for m in e.months %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ m.year }}</td>
              <td>{{ m.month }}</td>
              <td>{{ '%.2f'|format(m.basic) }}</td>
              <td>{{ '%.2f'|format(m.allowances) }}</td>
              <td>{{ '%.2f'|format(m.deductions) }}</td>
              <td>{{ '%.2f'|format(m.prev_due) }}</td>
              <td>{{ '%.2f'|format(m.total) }}</td>
              <td>{{ '%.2f'|format(m.paid) }}</td>
              <td>{{ '%.2f'|format(m.remaining) }}</td>
              <td>{{ m.status }}</td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="totals-row">
              <th colspan="3">Totals / الإجماليات</th>
              <th>{{ '%.2f'|format(e.basic_total) }}</th>
              <th>{{ '%.2f'|format(e.allowances_total) }}</th>
              <th>{{ '%.2f'|format(e.deductions_total) }}</th>
              <th>{{ '%.2f'|format(e.prev_due) }}</th>
              <th>{{ '%.2f'|format(e.total) }}</th>
              <th>{{ '%.2f'|format(e.paid) }}</th>
              <th>{{ '%.2f'|format(e.remaining) }}</th>
              <th>-</th>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>
    {% endif %}

    {# Receipt #}
    {% if mode == 'receipt' and payments %}
    <section id="receipt-section" style="margin-top:28px">
      <div class="receipt">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div>
            <div style="font-weight:800">Salary Payment Receipt / إيصال سداد رواتب</div>
            <div class="meta">{{ company_name or 'Company' }}</div>
          </div>
          <div style="text-align:left">
            <div style="font-weight:700">Date: {{ payment_date or now }}</div>
            <div class="meta">Printed by system at {{ now }}</div>
          </div>
        </div>

        <table class="report" style="margin-top:10px">
          <thead>
            <tr>
              <th>#</th>
              <th>Employee / الموظف</th>
              <th>Basic Salary / الراتب الأساسي</th>
              <th>Allowances / البدلات</th>
              <th>Deductions / الاستقطاعات</th>
              <th>Previous Dues / مستحقات سابقة</th>
              <th>Amount Paid / المبلغ المدفوع</th>
              <th>Net Salary / الصافي</th>
              <th>Payment Method / طريقة الدفع</th>
            </tr>
          </thead>
          <tbody>
            {% for p in payments %}
            <tr>
              <td>{{ loop.index }}</td>
              <td style="text-align:left;padding-left:12px">{{ p.employee.full_name }}</td>
              <td>{{ '%.2f'|format(p.basic) }}</td>
              <td>{{ '%.2f'|format(p.allowances) }}</td>
              <td>{{ '%.2f'|format(p.deductions) }}</td>
              <td>{{ '%.2f'|format(p.prev_due) }}</td>
              <td>{{ '%.2f'|format(p.paid_amount) }}</td>
              <td>{{ '%.2f'|format(p.net_salary) }}</td>
              <td>{{ p.method|upper }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <div style="margin-top:12px;display:flex;gap:12px;justify-content:space-between;align-items:center">
          <div style="font-size:14px">
            <div>Paid By / تم السداد بواسطة: <strong>{{ paid_by or '' }}</strong></div>
          </div>
          <div style="display:flex;gap:28px">
            <div style="text-align:center">
              <div style="border-top:1px solid var(--border);padding-top:6px;font-size:13px">Accountant Signature / توقيع المحاسب</div>
            </div>
            <div style="text-align:center">
              <div style="border-top:1px solid var(--border);padding-top:6px;font-size:13px">Manager Signature / توقيع المدير</div>
            </div>
          </div>
        </div>
      </div>
      <div style="margin-top:10px;color:var(--muted);font-size:13px">🖨️ <strong>Print Receipt / طباعة الإيصال</strong> — اضغط زر الطباعة أعلى الصفحة ثم اختر "طباعة" أو "حفظ كـ PDF".</div>
    </section>
    {% endif %}

    <div style="margin-top:20px;border-top:1px solid var(--border);padding-top:10px;display:flex;justify-content:space-between;align-items:center">
      <div style="color:var(--muted)">© {{ company_name or 'Global Restaurant' }} — جميع الحقوق محفوظة</div>
      <div style="font-size:13px;color:var(--muted)">Prepared by Payroll System</div>
    </div>

  </div>

  <script>
    (function(){
      var el = document.getElementById('print-timestamp');
      if (!el) return;
      var now = new Date();
      var padded = function(n){ return String(n).padStart(2,'0'); };
      var date = now.getFullYear() + '/' + padded(now.getMonth()+1) + '/' + padded(now.getDate());
      var time = padded(now.getHours()) + ':' + padded(now.getMinutes());
      el.textContent = 'تم الطباعة: ' + date + ' - ' + time;
    })();
  </script>

</body>
</html>


