{% extends 'base.html' %}
{% block title %}All Invoices{% endblock %}
{% block content %}
<div class="container py-4">
  <h3 class="mb-3">All Invoices</h3>

  <div class="table-responsive">
    <table class="table table-bordered table-striped table-hover align-middle">
      <thead>
        <tr>
          <th>Branch</th>
          <th>Date</th>
          <th>Invoice No.</th>
          <th>Item</th>
          <th>Qty</th>
          <th>Amount</th>
          <th>Discount</th>
          <th>VAT</th>
          <th>Total</th>
          <th>Payment</th>
        </tr>
      </thead>
      <tbody id="allinv-body"></tbody>
      <tfoot id="allinv-summary"></tfoot>
    </table>
  </div>
</div>

<script>
(function(){
  function n2(x){ try{return Number(x||0).toFixed(2);}catch(e){return '0.00';} }
  fetch('/api/all-invoices', {credentials:'same-origin'})
    .then(r=>r.json())
    .then(data=>{
      const body = document.getElementById('allinv-body');
      const tfoot = document.getElementById('allinv-summary');
      if(!body||!tfoot) return;
      body.innerHTML=''; tfoot.innerHTML='';

      const rows = (data.invoices||[]).slice().sort((a,b)=> (a.branch||'').localeCompare(b.branch||'') || (b.date||'').localeCompare(a.date||''));
      let currentBranch = null;
      rows.forEach(r=>{
        if(r.branch !== currentBranch){
          currentBranch = r.branch;
          const hdr = document.createElement('tr');
          hdr.className = 'table-info fw-bold';
          hdr.innerHTML = `<td colspan="10">Branch: ${currentBranch||''}</td>`;
          body.appendChild(hdr);
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.branch||''}</td>
          <td>${r.date||''}</td>
          <td>${r.invoice_number||''}</td>
          <td>${r.item_name||''}</td>
          <td>${Number(r.quantity||0)}</td>
          <td>${n2(r.price)}</td>
          <td>${n2(r.discount)}</td>
          <td>${n2(r.vat)}</td>
          <td>${n2(r.total)}</td>
          <td>${r.payment_method||''}</td>`;
        body.appendChild(tr);
      });

      // Branch totals
      const btot = data.branch_totals||{};
      Object.keys(btot).sort().forEach(b=>{
        const t = btot[b]||{amount:0,discount:0,vat:0,total:0};
        const tr = document.createElement('tr'); tr.className = 'table-warning fw-bold';
        tr.innerHTML = `
          <td colspan="5" class="text-end">Branch Totals (${b}):</td>
          <td>${n2(t.amount)}</td>
          <td>${n2(t.discount)}</td>
          <td>${n2(t.vat)}</td>
          <td>${n2(t.total)}</td>
          <td></td>`;
        tfoot.appendChild(tr);
      });
      const overall = data.overall_totals || data.summary || {amount:0,discount:0,vat:0,total:0};
      const tro = document.createElement('tr'); tro.className = 'table-secondary fw-bold';
      tro.innerHTML = `
        <td colspan="5" class="text-end">Overall Totals:</td>
        <td>${n2(overall.amount)}</td>
        <td>${n2(overall.discount)}</td>
        <td>${n2(overall.vat)}</td>
        <td>${n2(overall.total)}</td>
        <td></td>`;
      tfoot.appendChild(tro);
    })
    .catch(err=> console.error('Failed to load all invoices', err));
})();
</script>
{% endblock %}

