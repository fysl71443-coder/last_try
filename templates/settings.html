{% extends 'base.html' %}
{% set back_url = url_for('main.dashboard') %}

{% block title %}Settings{% endblock %}
{% block content %}
<div class="container py-4">
  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
  
  <!-- Navigation Tabs -->
  <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
        ๐ข General Settings
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="china-tab" data-bs-toggle="tab" data-bs-target="#china" type="button" role="tab">
        ๐ฎ China Town Settings
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="india-tab" data-bs-toggle="tab" data-bs-target="#india" type="button" role="tab">
        ๐๏ธ Palace India Settings
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="print-tab" data-bs-toggle="tab" data-bs-target="#print" type="button" role="tab">
        ๐จ๏ธ Print Settings
      </button>
    </li>
  </ul>

  <form method="post" enctype="multipart/form-data" id="settingsForm" action="/settings">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

    <div class="tab-content" id="settingsTabContent">
      <!-- General Settings Tab -->
      <div class="tab-pane fade show active" id="general" role="tabpanel">
        <div class="row g-3">
          <div class="col-12">
            <h4>Company General Settings</h4>
          </div>
          <div class="col-md-6">
            <label class="form-label">Company Name</label>
            <input type="text" name="company_name" class="form-control" value="{{ s.company_name or '' }}">
          </div>
          <div class="col-md-6">
            <label class="form-label">ุงูุฑูู ุงูุถุฑูุจู</label>
            <input type="text" name="tax_number" class="form-control" value="{{ s.tax_number or '' }}">
          </div>
          <div class="col-md-8">
            <label class="form-label">ุงูุนููุงู</label>
            <input type="text" name="address" class="form-control" value="{{ s.address or '' }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">ุงููุงุชู</label>
            <input type="text" name="phone" class="form-control" value="{{ s.phone or '' }}">
          </div>
          <div class="col-md-6">
            <label class="form-label">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
            <input type="email" name="email" class="form-control" value="{{ s.email or '' }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">ูุณุจุฉ VAT ุงูุนุงูุฉ (%)</label>
            <input type="number" step="0.01" name="vat_rate" class="form-control" value="{{ s.vat_rate if s.vat_rate is not none else 15 }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">ุงูุนููุฉ</label>
            <input type="text" name="currency" class="form-control" value="{{ s.currency if s.currency is not none else 'SAR' }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">ุณูุฉ ุงููุงุฌูุฉ ุงูุงูุชุฑุงุถูุฉ</label>
            <select name="default_theme" class="form-select">
              <option value="light" {% if s.default_theme!='dark' %}selected{% endif %}>ููุงุฑู</option>
              <option value="dark" {% if s.default_theme=='dark' %}selected{% endif %}>ูููู</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">ุชุณููุฉ ูุฑุน Place India</label>
            <input type="text" name="place_india_label" class="form-control" value="{{ s.place_india_label if s.place_india_label is not none else 'Place India' }}">
          </div>
          <div class="col-md-6">
            <label class="form-label">ุชุณููุฉ ูุฑุน China Town</label>
            <input type="text" name="china_town_label" class="form-control" value="{{ s.china_town_label if s.china_town_label is not none else 'China Town' }}">
          </div>
          <div class="col-md-6">
            <label class="form-label">ุงูุดุนุงุฑ ุงูุนุงู</label>
            <div class="mb-2">
              <input type="file" name="logo_file" class="form-control" accept="image/*" id="logoFile">
              <div class="form-text">ุฑูุน ุงูุดุนุงุฑ ุงูุนุงู ููุจุฑูุงูุฌ (ูุธูุฑ ูู ุฌููุน ุงูุทุจุงุนุงุช ุนุฏุง ุงููุจูุนุงุช)</div>
            </div>
            <div class="mb-2">
              <label class="form-label small">ุฃู ุฃุฏุฎู ุฑุงุจุท ุงูุดุนุงุฑ</label>
              <input type="text" name="logo_url" class="form-control" value="{{ s.logo_url if s.logo_url is not none else '' }}">
            </div>
            {% if s and s.logo_url %}
            <div class="mt-2">
              <img src="{{ s.logo_url }}" alt="Current Logo" style="max-height: 60px; max-width: 200px;" class="border rounded">
              <div class="form-text">ุงูุดุนุงุฑ ุงูุญุงูู</div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- China Town Settings Tab -->
      <div class="tab-pane fade" id="china" role="tabpanel">
        <div class="row g-3">
          <div class="col-12">
            <h4>๐ฎ ุฅุนุฏุงุฏุงุช China Town</h4>
            <p class="text-muted">ุฅุนุฏุงุฏุงุช ุฎุงุตุฉ ุจูุฑุน China Town</p>
          </div>
          <div class="col-md-4">
            <label class="form-label">ูููุฉ ุณุฑ ุญุฐู ุงูุฃุตูุงู</label>
            <input type="password" name="china_town_void_password" class="form-control" value="{{ s.china_town_void_password if s.china_town_void_password is not none else '1991' }}">
            <div class="form-text">ูููุฉ ุงูุณุฑ ุงููุทููุจุฉ ูุญุฐู ุงูุฃุตูุงู ูู ุงููุงุชูุฑุฉ</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">ูุณุจุฉ ุงูุถุฑูุจุฉ (%)</label>
            <input type="number" step="0.01" name="china_town_vat_rate" class="form-control" value="{{ s.china_town_vat_rate if s.china_town_vat_rate is not none else 15 }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">ูุณุจุฉ ุงูุฎุตู ุงูุงูุชุฑุงุถูุฉ (%)</label>
            <input type="number" step="0.01" name="china_town_discount_rate" class="form-control" value="{{ s.china_town_discount_rate if s.china_town_discount_rate is not none else 0 }}">
          </div>
          <div class="col-md-6">
            <label class="form-label">ุดุนุงุฑ ุงููุฑุน</label>
            <div class="mb-2">
              <input type="file" name="china_logo_file" class="form-control" accept="image/*">
              <div class="form-text">ุฑูุน ุดุนุงุฑ ูุฎุตุต ููุฑุน China Town</div>
            </div>
            <div class="mb-2">
              <label class="form-label small">ุฃู ุฃุฏุฎู ุฑุงุจุท ุงูุดุนุงุฑ</label>
              <input type="text" name="china_town_logo_url" class="form-control" value="{{ s.china_town_logo_url if s.china_town_logo_url is not none else '' }}">
            </div>
            {% if s and s.china_town_logo_url %}
            <div class="mt-2">
              <img src="{{ s.china_town_logo_url }}" alt="China Town Logo" style="max-height:70px;max-width:220px;" class="border rounded">
              <div class="form-text">ุงูุดุนุงุฑ ุงูุญุงูู ููุฑุน China Town</div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Palace India Settings Tab -->
      <div class="tab-pane fade" id="india" role="tabpanel">
        <div class="row g-3">
          <div class="col-12">
            <h4>๐๏ธ ุฅุนุฏุงุฏุงุช Palace India</h4>
            <p class="text-muted">ุฅุนุฏุงุฏุงุช ุฎุงุตุฉ ุจูุฑุน Palace India</p>
          </div>
          <div class="col-md-4">
            <label class="form-label">ูููุฉ ุณุฑ ุญุฐู ุงูุฃุตูุงู</label>
            <input type="password" name="place_india_void_password" class="form-control" value="{{ s.place_india_void_password if s.place_india_void_password is not none else '1991' }}">
            <div class="form-text">ูููุฉ ุงูุณุฑ ุงููุทููุจุฉ ูุญุฐู ุงูุฃุตูุงู ูู ุงููุงุชูุฑุฉ</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">ูุณุจุฉ ุงูุถุฑูุจุฉ (%)</label>
            <input type="number" step="0.01" name="place_india_vat_rate" class="form-control" value="{{ s.place_india_vat_rate if s.place_india_vat_rate is not none else 15 }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">ูุณุจุฉ ุงูุฎุตู ุงูุงูุชุฑุงุถูุฉ (%)</label>
            <input type="number" step="0.01" name="place_india_discount_rate" class="form-control" value="{{ s.place_india_discount_rate if s.place_india_discount_rate is not none else 0 }}">
          </div>
          <div class="col-md-6">
            <label class="form-label">ุดุนุงุฑ ุงููุฑุน</label>
            <div class="mb-2">
              <input type="file" name="india_logo_file" class="form-control" accept="image/*">
              <div class="form-text">ุฑูุน ุดุนุงุฑ ูุฎุตุต ููุฑุน Palace India</div>
            </div>
            <div class="mb-2">
              <label class="form-label small">ุฃู ุฃุฏุฎู ุฑุงุจุท ุงูุดุนุงุฑ</label>
              <input type="text" name="place_india_logo_url" class="form-control" value="{{ s.place_india_logo_url if s.place_india_logo_url is not none else '' }}">
            </div>
            {% if s and s.place_india_logo_url %}
            <div class="mt-2">
              <img src="{{ s.place_india_logo_url }}" alt="Place India Logo" style="max-height:70px;max-width:220px;" class="border rounded">
              <div class="form-text">ุงูุดุนุงุฑ ุงูุญุงูู ููุฑุน Place India</div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Print Settings Tab -->
      <div class="tab-pane fade" id="print" role="tabpanel">
        <div class="row g-3">

          <div class="col-12">
            <h4>Print & Receipt Settings</h4>
            <p class="text-muted">Configure receipt and invoice printing</p>
          </div>
          <div class="col-md-3">
            <label class="form-label">Paper Width (mm)</label>
            <select name="receipt_paper_width" class="form-select">
              <option value="80" {% if s.receipt_paper_width=='80' %}selected{% endif %}>80mm</option>
              <option value="58" {% if s.receipt_paper_width=='58' %}selected{% endif %}>58mm</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Font Size</label>
            <input type="number" name="receipt_font_size" class="form-control" value="{{ s.receipt_font_size if s.receipt_font_size is not none else 12 }}">
          </div>
          <div class="col-md-6">
            <div class="form-check mt-4">
              <input class="form-check-input" type="checkbox" name="receipt_show_logo" id="recLogo" {% if s.receipt_show_logo %}checked{% endif %}>
              <label class="form-check-label" for="recLogo">ุฅุธูุงุฑ ุงูุดุนุงุฑ</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="receipt_show_tax_number" id="recTax" {% if s.receipt_show_tax_number %}checked{% endif %}>
              <label class="form-check-label" for="recTax">ุฅุธูุงุฑ ุงูุฑูู ุงูุถุฑูุจู</label>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">ูุต ุชุฐููู ุงูุฅูุตุงู</label>
            <input type="text" name="receipt_footer_text" class="form-control" value="{{ s.receipt_footer_text or '' }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">ุทูู ุฅุถุงูู ุฃุณูู ุงูุฅูุตุงู (ูู)</label>
            <input type="number" step="1" min="0" name="receipt_extra_bottom_mm" class="form-control" value="{{ s.receipt_extra_bottom_mm if s.receipt_extra_bottom_mm is not none else 15 }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">ุงุฑุชูุงุน ุงูุดุนุงุฑ (px)</label>
            <input type="number" step="1" min="20" name="receipt_logo_height" class="form-control" value="{{ s.receipt_logo_height if s.receipt_logo_height is not none else 72 }}">
          </div>
        </div>
      <!-- New: Printer type, footer message, currency image -->
      <div class="row g-3 mt-3">
        <div class="col-md-4">
          <label class="form-label">Printer Type</label>
          <select name="printer_type" class="form-select">
            <option value="thermal" {% if s.printer_type=='thermal' %}selected{% endif %}>Thermal</option>
            <option value="A4" {% if s.printer_type=='A4' %}selected{% endif %}>A4</option>
          </select>
        </div>
        <div class="col-md-8">
          <label class="form-label">Receipt Footer Message</label>
          <input type="text" name="footer_message" class="form-control" value="{{ s.footer_message if s.footer_message is not none else 'THANK YOU FOR VISIT' }}" placeholder="THANK YOU FOR VISIT">
        </div>
        <div class="col-md-6">
          <label class="form-label">Currency Image (PNG)</label>
          <input type="file" name="currency_file" accept="image/png" class="form-control">
          <div class="form-text">Upload a PNG to show next to amounts</div>
        </div>
        <div class="col-md-6">
          <label class="form-label">Or Currency Image URL</label>
          <input type="text" name="currency_image_url" class="form-control" value="{{ s.currency_image or '' }}" placeholder="/static/uploads/sar.png">
        </div>
        {% if s and s.currency_image %}
        <div class="col-12">
          <label class="form-label small">Preview</label>
          <div><img src="{{ s.currency_image }}" alt="Currency" width="24" height="24"></div>
        </div>
        {% endif %}
      </div>
      </div>
    </div>

    <div class="mt-4 d-flex justify-content-end gap-2">
      <a class="btn btn-secondary" href="{{ url_for('main.dashboard') }}">Back</a>
      <button class="btn btn-success" type="button" onclick="console.log('Test Save clicked'); document.getElementById('settingsForm').submit();">Test Save</button>
      <button class="btn btn-primary" type="submit" id="saveBtn">
        <span class="btn-text">Save Settings</span>
        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
      </button>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('settingsForm');
    const saveBtn = document.getElementById('saveBtn');
    const btnText = saveBtn.querySelector('.btn-text');
    const spinner = saveBtn.querySelector('.spinner-border');
    
    // Add click handler to save button
    saveBtn.addEventListener('click', function(e) {
        console.log('Save button clicked');
        e.preventDefault();
        
        // Show loading state
        saveBtn.disabled = true;
        btnText.textContent = 'Saving...';
        spinner.classList.remove('d-none');
        
        // Force form submission
        console.log('Forcing form submission...');
        form.submit();
    });
    
        form.addEventListener('submit', function(e) {
            console.log('Form submit event triggered');
            // Show loading state
            saveBtn.disabled = true;
            btnText.textContent = 'Saving...';
            spinner.classList.remove('d-none');
            
            console.log('Form submitting...');
            return true;
        });

        // Listen for successful save to reload branch settings in POS
        const originalSubmit = form.submit;
        form.submit = function() {
            originalSubmit.call(this);
            // After form submission, reload branch settings in any open POS windows
            setTimeout(() => {
                if (window.reloadBranchSettings) {
                    window.reloadBranchSettings();
                }
                // Also try to reload in parent window if this is opened from POS
                if (window.opener && window.opener.reloadBranchSettings) {
                    window.opener.reloadBranchSettings();
                }
            }, 1000);
        };
    
    // Check for flash messages
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
        setTimeout(() => {
            alert.style.opacity = '0';
            setTimeout(() => alert.remove(), 300);
        }, 3000);
    });
});
</script>
{% endblock %}
