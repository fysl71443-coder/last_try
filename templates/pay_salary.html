{% extends "base.html" %}
{% block content %}
<div class="container py-3">
  <h2 class="mb-3">💵 Pay Salaries / سداد الرواتب</h2>

  <form method="POST" class="card mb-4">
    <div class="card-body">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      {% if next_due_label %}
      <div class="alert alert-info" role="alert" style="margin-bottom: 8px;">
        سيتم توجيه السداد إلى أقدم شهر غير مسدد: <strong>{{ next_due_label }}</strong>
      </div>
      {% endif %}
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Month / الشهر</label>
          <input class="form-control" type="text" value="{{ month_name }}, {{ year }}" disabled>
        </div>
        <div class="col-md-4">
          <label class="form-label">Employee / الموظف</label>
          <select name="employee_id" required class="form-select">
            <option value="">-- Select --</option>
            {% for emp in employees %}
              <option value="{{ emp.id }}" {% if emp.id == selected_employee_id %}selected{% endif %}>{{ emp.full_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Payment Method / طريقة الدفع</label>
          <select name="payment_method" class="form-select">
            <option value="cash">Cash</option>
            <option value="bank">Bank Transfer</option>
            <option value="check">Check</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Paid Amount / المبلغ المدفوع</label>
          {% set _rem = ( (salary.total|default(0)) - (salary.paid|default(0)) ) %}
          <input class="form-control" type="number" step="0.01" name="paid_amount" required max="{{ '%.2f'|format(_rem if _rem>0 else 0) }}" autofocus>
          <div class="form-text">المتبقي الحالي: {{ '%.2f'|format(_rem if _rem>0 else 0) }}</div>
        </div>

        <div class="col-12"><hr/></div>

        <div class="col-md-3">
          <label class="form-label">Basic Salary / الراتب الأساسي</label>
          <input class="form-control text-end" value="{{ salary.basic or 0 }}" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Allowances / البدلات</label>
          <input class="form-control text-end" value="{{ salary.allowances or 0 }}" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Deductions / الاستقطاعات</label>
          <input class="form-control text-end" value="{{ salary.deductions or 0 }}" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Previous Due / مستحقات سابقة</label>
          <input class="form-control text-end" value="{{ salary.prev_due or 0 }}" readonly>
        </div>

        <div class="col-md-3">
          <label class="form-label">Net Salary / صافي الراتب</label>
          <input class="form-control text-end" value="{{ salary.total or 0 }}" readonly>
        </div>
      </div>
      <div class="mt-3 d-flex justify-content-between">
        <a class="btn btn-outline-primary" href="{{ url_for('main.payroll', year=year, month=month) }}">⬅︎ رجوع لكشوف هذا الشهر</a>
        <div class="text-end">
          <button type="submit" class="btn btn-success">💰 Save Payment</button>
          <button type="button" class="btn btn-outline-secondary" onclick="openPrintModal('{{ url_for('reports.payroll_report_employee', emp_id=selected_employee_id, year_from=year, month_from=month, year_to=year, month_to=month, print=1) }}')">🖨️ تقرير هذا الموظف</button>
        </div>
      </div>
    </div>
  </form>

  <h3>📌 Current Month Salaries / رواتب الشهر الحالي ({{ year }}-{{ month }})</h3>
  <table class="table table-striped table-bordered">
    <thead>
      <tr>
        <th>#</th>
        <th>Employee</th>
        <th class="text-end">Basic</th>
        <th class="text-end">Allowances</th>
        <th class="text-end">Deductions</th>
        <th class="text-end">Prev Due</th>
        <th class="text-end">Net</th>
        <th class="text-end text-success">Paid</th>
        <th class="text-end">Remaining</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% if current_month_salaries %}
      {% for s in current_month_salaries %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ s.employee.full_name }}</td>
        <td class="text-end">{{ "%.2f"|format(s.basic) }}</td>
        <td class="text-end">{{ "%.2f"|format(s.allowances) }}</td>
        <td class="text-end">{{ "%.2f"|format(s.deductions) }}</td>
        <td class="text-end">{{ "%.2f"|format(s.prev_due) }}</td>
        <td class="text-end">{{ "%.2f"|format(s.total) }}</td>
        <td class="text-end text-success fw-bold">{{ "%.2f"|format(s.paid) }}</td>
        <td class="text-end {% if s.remaining > 0 %}text-danger{% else %}text-success{% endif %} fw-bold">{{ "%.2f"|format(s.remaining) }}</td>
        <td>
          {% if s.status == 'due' %}
            <span class="badge bg-danger">مستحقة</span>
          {% elif s.status == 'partial' %}
            <span class="badge bg-warning text-dark">جزئي</span>
          {% else %}
            <span class="badge bg-success">مدفوعة</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
      {% else %}
      <tr><td colspan="10">لا يوجد سجلات لهذا الشهر</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>
{% endblock %}


