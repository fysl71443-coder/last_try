{% extends 'base.html' %}{% set back_url = url_for('main.dashboard') %}
{% block title %}{{ _('Employees / Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†') }}{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="section-header mb-3">
    <h3 class="mb-0">ğŸ‘¤ {{ _('Employees / Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†') }}</h3>
    <div class="d-flex flex-wrap gap-2">
      <a href="{{ url_for('main.salaries_pay') }}" class="btn btn-success">ğŸ’µ {{ _('Pay Salaries / Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø±ÙˆØ§ØªØ¨') }}</a>
      <a href="{{ url_for('main.salaries_statements') }}" class="btn btn-outline-success">ğŸ§¾ {{ _('Payroll Statements / ÙƒØ´ÙˆÙØ§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨') }}</a>
      <button type="button" class="btn btn-outline-secondary" onclick="clearEmployeeForm(); document.getElementById('employees-form').scrollIntoView({ behavior: 'smooth' });">ğŸ“ {{ _('Add New / Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯') }}</button>
      <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary">ğŸ  {{ _('Dashboard / Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…') }}</a>
    </div>
  </div>

  <div class="card mb-4" id="employees-form">
    <div class="card-body">
      <h5 class="mb-3" id="form-title">ğŸ“ {{ _('Add New Employee / Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯') }}</h5>
      <form method="POST">
        {{ form.hidden_tag() }}
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

        <div class="row g-3">
          <div class="col-md-3">{{ form.employee_code.label(class_='form-label') }}{{ form.employee_code(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.full_name.label(class_='form-label') }}{{ form.full_name(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.national_id.label(class_='form-label') }}{{ form.national_id(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.status.label(class_='form-label') }}{{ form.status(class_='form-select') }}</div>
          <div class="col-md-3">{{ form.department.label(class_='form-label') }}
            <div class="input-group">
              {{ form.department(class_='form-control', placeholder=_('e.g. Kitchen / Admin / Cashier')) }}
              <select class="form-select" id="deptQuickSelect" style="max-width: 9rem">
                <option value="">{{ _('Choose') }}</option>
                <option>Kitchen</option>
                <option>Admin</option>
                <option>Cashier</option>
                <option>Store</option>
                <option>Delivery</option>
              </select>
            </div>
          </div>
          <div class="col-md-3">{{ form.position.label(class_='form-label') }}{{ form.position(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.phone.label(class_='form-label') }}{{ form.phone(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.email.label(class_='form-label') }}{{ form.email(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.hire_date.label(class_='form-label') }}{{ form.hire_date(class_='form-control') }}</div>

        </div>
        <hr/>
        <div class="row g-3">
          <div class="col-md-3">{{ form.base_salary.label(class_='form-label') }}{{ form.base_salary(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.allowances.label(class_='form-label') }}{{ form.allowances(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.deductions.label(class_='form-label') }}{{ form.deductions(class_='form-control') }}</div>
        </div>
        <div class="text-end mt-3">
          <button type="button" class="btn btn-outline-secondary me-2" onclick="clearEmployeeForm()">{{ _('Clear / Ù…Ø³Ø­') }}</button>
          {{ form.submit(class_='btn btn-success') }}
        </div>
      </form>
    </div>
  </div>
  <div class="card mb-4" id="pay-salaries-section">
    <div class="card-body">
      <h5 class="mb-3">ğŸ’µ {{ _('Pay Salaries / Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø±ÙˆØ§ØªØ¨') }}</h5>
      <form id="paySalaryForm" onsubmit="return handleCreateSalary(event)">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label">{{ _('Month / Ø§Ù„Ø´Ù‡Ø±') }}</label>
            <input type="month" class="form-control" id="pay_month" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">{{ _('Employee / Ø§Ù„Ù…ÙˆØ¸Ù') }}</label>
            <select class="form-select" id="pay_employee" required>
              <option value="">-- {{ _('Select') }} --</option>
              {% for e in employees or [] %}
              <option value="{{ e.id }}">{{ e.full_name }}{% if e.department %} â€” {{ e.department }}{% endif %}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">{{ _('Paid Amount / Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹') }}</label>
            <input type="number" step="0.01" class="form-control" id="paid_amount" placeholder="0.00">
          </div>
          <div class="col-md-3 text-end">
            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#monthAdjust">{{ _('Edit Allowances/Deductions / ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø¯Ù„Ø§Øª ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª') }}</button>
          </div>
        </div>
        <div class="collapse mt-3" id="monthAdjust">
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">{{ _('Basic Salary / Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ') }}</label>
              <input type="number" step="0.01" class="form-control" id="basic_salary" placeholder="0.00">
            </div>
            <div class="col-md-3">
              <label class="form-label">{{ _('Allowances / Ø§Ù„Ø¨Ø¯Ù„Ø§Øª') }}</label>
              <input type="number" step="0.01" class="form-control" id="allowances" placeholder="0.00">
            </div>
            <div class="col-md-3">
              <label class="form-label">{{ _('Deductions / Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª') }}</label>
              <input type="number" step="0.01" class="form-control" id="deductions" placeholder="0.00">
            </div>
            <div class="col-md-3">
              <label class="form-label">{{ _('Previous Due / Ù…Ø³ØªØ­Ù‚Ø§Øª Ø³Ø§Ø¨Ù‚Ø©') }}</label>
              <input type="number" step="0.01" class="form-control" id="previous_due" placeholder="0.00">
            </div>
          </div>
          <div class="row g-3 mt-2">
            <div class="col-md-3">
              <label class="form-label">{{ _('Work Hours / Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„') }}</label>
              <input type="number" step="0.1" class="form-control" id="work_hours" placeholder="0">
            </div>
            <div class="col-md-3">
              <label class="form-label">{{ _('Net Salary / Ø§Ù„ØµØ§ÙÙŠ') }}</label>
              <input type="text" class="form-control" id="net_salary" readonly>
            </div>
            <div class="col-md-3">
              <label class="form-label">{{ _('Remaining / Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ') }}</label>
              <input type="text" class="form-control" id="remaining_salary" readonly>
            </div>
            <div class="col-md-3 text-end d-flex align-items-end justify-content-end">
              <button type="submit" class="btn btn-success">{{ _('Create/Update Salary / Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§ØªØ¨') }}</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="card mb-4" id="statements-section">
    <div class="card-body">
      <h5 class="mb-3">ğŸ§¾ {{ _('Payroll Statements / ÙƒØ´ÙˆÙØ§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨') }}</h5>
      <div class="row g-3 mb-3">
        <div class="col-md-3">
          <label class="form-label">{{ _('Month / Ø§Ù„Ø´Ù‡Ø±') }}</label>
          <input type="month" class="form-control" id="stmt_month">
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button class="btn btn-outline-primary" id="btnLoadStatements">{{ _('Load / ØªØ­Ù…ÙŠÙ„') }}</button>
          <button class="btn btn-outline-success ms-2" id="btnExportStatements">{{ _('Export / ØªØµØ¯ÙŠØ±') }}</button>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-sm align-middle" id="tblStatements">
          <thead class="table-light">
            <tr>
              <th>{{ _('Employee / Ø§Ù„Ù…ÙˆØ¸Ù') }}</th>
              <th>{{ _('Department / Ø§Ù„Ù‚Ø³Ù…') }}</th>
              <th>{{ _('Basic / Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ') }}</th>
              <th>{{ _('Allowances / Ø§Ù„Ø¨Ø¯Ù„Ø§Øª') }}</th>
              <th>{{ _('Deductions / Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª') }}</th>
              <th>{{ _('Net / Ø§Ù„ØµØ§ÙÙŠ') }}</th>
              <th>{{ _('Paid / Ø§Ù„Ù…Ø¯ÙÙˆØ¹') }}</th>
              <th>{{ _('Remaining / Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ') }}</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="row g-3 mt-2" id="stmtTotals">
        <div class="col">
          <div class="small text-muted">{{ _('Totals (All Employees) / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª (ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†)') }}</div>
          <div class="d-flex flex-wrap gap-3">
            <div>{{ _('Employees') }}: <strong id="t_emps">0</strong></div>
            <div>{{ _('Basic') }}: <strong id="t_basic">0.00</strong></div>
            <div>{{ _('Allowances') }}: <strong id="t_allow">0.00</strong></div>
            <div>{{ _('Deductions') }}: <strong id="t_ded">0.00</strong></div>
            <div>{{ _('Paid') }}: <strong id="t_paid">0.00</strong></div>
            <div>{{ _('Net') }}: <strong id="t_net">0.00</strong></div>
            <div>{{ _('Remaining') }}: <strong id="t_remain">0.00</strong></div>
          </div>
        </div>
      </div>
    </div>
  </div>


  {% if employees %}
  <div class="card">
    <div class="card-body">
      {% set emps = employees or [] %}
      {% set total = emps|length %}
      {% set active_count = emps|selectattr('status','equalto','active')|list|length %}
      {% set inactive_count = total - active_count %}
      <div class="row g-3 mb-3">
        <div class="col-6 col-md-4"><div class="card shadow-sm h-100"><div class="card-body">
          <div class="text-muted small">{{ _('Total Employees / Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†') }}</div>
          <div class="fs-5 fw-bold">{{ total }}</div>
        </div></div></div>
        <div class="col-6 col-md-4"><div class="card shadow-sm h-100"><div class="card-body">
          <div class="text-muted small">{{ _('Active / Ù†Ø´Ø·') }}</div>
          <div class="fs-5 fw-bold text-success">{{ active_count }}</div>
        </div></div></div>
        <div class="col-6 col-md-4"><div class="card shadow-sm h-100"><div class="card-body">
          <div class="text-muted small">{{ _('Inactive / ØºÙŠØ± Ù†Ø´Ø·') }}</div>
          <div class="fs-5 fw-bold text-secondary">{{ inactive_count }}</div>
        </div></div></div>
      </div>
      <div class="row g-2 mb-2">
        <div class="col-md-3 ms-auto">
          <input type="text" class="form-control" id="empSearch" placeholder="{{ _('Search employees... / Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†...') }}">
        </div>
        <div class="col-md-2">
          <select class="form-select" id="empFilterStatus">
            <option value="">{{ _('All Status / ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª') }}</option>
            <option value="active">{{ _('Active / Ù†Ø´Ø·') }}</option>
            <option value="inactive">{{ _('Inactive / ØºÙŠØ± Ù†Ø´Ø·') }}</option>
          </select>
        </div>
        <div class="col-md-2">
          <input type="text" class="form-control" id="empFilterDept" placeholder="{{ _('Filter by Dept / ØªØµÙÙŠØ© Ø¨Ø§Ù„Ù‚Ø³Ù…') }}">
        </div>
        <div class="col-md-2">
          <input type="text" class="form-control" id="empFilterPos" placeholder="{{ _('Filter by Position / ØªØµÙÙŠØ© Ø¨Ø§Ù„ÙˆØ¸ÙŠÙØ©') }}">
        </div>
        <div class="col-md-3 text-end">
          <button class="btn btn-outline-primary" id="btnExportEmployees">{{ _('Export Employees / ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†') }}</button>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-striped table-hover align-middle table-sm">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>{{ _('Code / Ø§Ù„Ø±Ù…Ø²') }}</th>
              <th>{{ _('Name / Ø§Ù„Ø§Ø³Ù…') }}</th>
              <th>{{ _('National ID / Ø§Ù„Ù‡ÙˆÙŠØ©') }}</th>
              <th>{{ _('Department / Ø§Ù„Ù‚Ø³Ù…') }}</th>
              <th>{{ _('Position / Ø§Ù„ÙˆØ¸ÙŠÙØ©') }}</th>
              <th>{{ _('Phone / Ø§Ù„Ù‡Ø§ØªÙ') }}</th>
              <th>{{ _('Email / Ø§Ù„Ø¨Ø±ÙŠØ¯') }}</th>
              <th>{{ _('Hire Date / Ø§Ù„ØªØ¹ÙŠÙŠÙ†') }}</th>
              <th>{{ _('Status / Ø§Ù„Ø­Ø§Ù„Ø©') }}</th>
              <th>{{ _('Actions / Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª') }}</th>
            </tr>
          </thead>
          <tbody id="empTableBody">
            {% for e in employees %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ e.employee_code }}</td>
              <td>{{ e.full_name }}</td>
              <td>{{ e.national_id }}</td>
              <td>{{ e.department or '-' }}</td>
              <td>{{ e.position or '-' }}</td>
              <td>{% if e.phone %}<a href="tel:{{ e.phone }}">{{ e.phone }}</a>{% else %}-{% endif %}</td>
              <td>{% if e.email %}<a href="mailto:{{ e.email }}">{{ e.email }}</a>{% else %}-{% endif %}</td>
              <td>{{ e.hire_date or '-' }}</td>
              <td>{% if e.status=='active' %}<span class="badge bg-success">{{ _('Active / Ù†Ø´Ø·') }}</span>{% else %}<span class="badge bg-secondary">{{ _('Inactive / ØºÙŠØ± Ù†Ø´Ø·') }}</span>{% endif %}</td>
              <td>
                <div class="btn-group" role="group">
                  <button type="button" class="btn btn-sm btn-outline-primary" onclick="editEmployee({{ e.id }}, '{{ e.full_name|e }}', '{{ e.employee_code|e }}', '{{ e.national_id|e }}', '{{ e.department|e }}', '{{ e.position|e }}', '{{ e.phone|e }}', '{{ e.email|e }}', '{{ e.hire_date|e }}', '{{ e.status|e }}')" title="{{ _('Edit / ØªØ¹Ø¯ÙŠÙ„') }}">âœï¸</button>
                  <button type="button" class="btn btn-sm btn-outline-success" onclick="alert('Ø²Ø± Ø§Ù„Ø±Ø§ØªØ¨ ÙŠØ¹Ù…Ù„! Ø§Ù„Ù…ÙˆØ¸Ù: {{ e.full_name|e }} (ID: {{ e.id }})')" title="{{ _('Salary / Ø§Ù„Ø±Ø§ØªØ¨') }}">ğŸ’°</button>
                  <form method="post" action="{{ url_for('main.employee_delete', eid=e.id) }}" class="d-inline" onsubmit="return confirm('{{ _('Delete this employee? / Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸ÙØŸ') }}')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-sm btn-outline-danger" title="{{ _('Delete / Ø­Ø°Ù') }}">ğŸ—‘ï¸</button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<script>
// WORKING FUNCTIONS - STEP BY STEP
console.log('JavaScript loaded successfully!');

// Edit employee function
function editEmployee(id, name, code, nationalId, dept, position, phone, email, hireDate, status) {
  console.log('Edit employee clicked:', name);
  
  // Fill the form with employee data
  const codeInput = document.querySelector('input[name="employee_code"]');
  const nameInput = document.querySelector('input[name="full_name"]');
  const nationalIdInput = document.querySelector('input[name="national_id"]');
  const deptInput = document.querySelector('input[name="department"]');
  const positionInput = document.querySelector('input[name="position"]');
  const phoneInput = document.querySelector('input[name="phone"]');
  const emailInput = document.querySelector('input[name="email"]');
  const hireDateInput = document.querySelector('input[name="hire_date"]');
  const statusSelect = document.querySelector('select[name="status"]');
  
  if (codeInput) codeInput.value = code || '';
  if (nameInput) nameInput.value = name || '';
  if (nationalIdInput) nationalIdInput.value = nationalId || '';
  if (deptInput) deptInput.value = dept || '';
  if (positionInput) positionInput.value = position || '';
  if (phoneInput) phoneInput.value = phone || '';
  if (emailInput) emailInput.value = email || '';
  if (hireDateInput) hireDateInput.value = hireDate || '';
  if (statusSelect) statusSelect.value = status || 'active';
  
  // Change form action to edit route
  const form = document.querySelector('#employees-form form');
  if (form) {
    form.action = '/employees/edit/' + id;
    // Change submit button text
    const submitBtn = form.querySelector('button[type="submit"]');
    if (submitBtn) {
      submitBtn.textContent = '{{ _("Update Employee / ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¸Ù") }}';
      submitBtn.className = 'btn btn-warning';
    }
    // Change form title
    const formTitle = document.getElementById('form-title');
    if (formTitle) {
      formTitle.textContent = `âœï¸ {{ _('Edit Employee / ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù') }}: ${name}`;
    }
  }
  
  // Scroll to form
  const formElement = document.getElementById('employees-form');
  if (formElement) {
    formElement.scrollIntoView({ behavior: 'smooth' });
  }
  
  alert('ØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ ÙˆØ­ÙØ¸Ù‡Ø§.');
}

// Make function globally accessible
window.editEmployee = editEmployee;

console.log('Edit function assigned to window object');

// Go to salary section for a specific employee and prefill
function goToSalary(id){
  try{
    const sel = document.getElementById('pay_employee');
    if (sel){ sel.value = String(id); }
    const month = document.getElementById('pay_month');
    if (month && !month.value){
      const d = new Date();
      const m = String(d.getMonth()+1).padStart(2,'0');
      month.value = `${d.getFullYear()}-${m}`;
    }
    document.getElementById('pay-salaries-section')?.scrollIntoView({behavior:'smooth'});
  }catch(e){ console.error(e); }
}
window.goToSalary = goToSalary;

// Replace salary button alerts with goToSalary behavior
(function(){
  try{
    const titleTxt = '{{ _("Salary / Ø§Ù„Ø±Ø§ØªØ¨") }}';
    document.querySelectorAll(`#empTableBody button[title="${titleTxt}"]`).forEach(btn=>{
      const oc = btn.getAttribute('onclick')||'';
      const m = oc.match(/ID:\s*(\d+)/);
      const id = m ? parseInt(m[1], 10) : null;
      if (id){
        btn.removeAttribute('onclick');
        btn.addEventListener('click', function(){ goToSalary(id); });
      }
    });
  }catch(e){ console.error(e); }
})();

// Delete employee function - NEW
async function deleteEmployeeNew(id, name) {
  console.log('Delete employee clicked:', name);
  
  try {
    const confirmed = await window.showConfirm(`{{ _('Are you sure to delete / Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ') }}\n${name}`);
    if (confirmed) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/employees/${id}/delete`;
      
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'csrf_token';
      csrfInput.value = document.querySelector('meta[name="csrf-token"]')?.content || '';
      
      form.appendChild(csrfInput);
      document.body.appendChild(form);
      form.submit();
    }
  } catch (error) {
    console.error('Error in deleteEmployeeNew:', error);
    alert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù');
  }
}

// Clear form function
function clearEmployeeForm() {
  console.log('Clear form clicked');
  
  const form = document.querySelector('#employees-form form');
  if (form) {
    form.reset();
    form.action = '/employees'; // Reset to create route
    // Reset submit button
    const submitBtn = form.querySelector('button[type="submit"]');
    if (submitBtn) {
      submitBtn.textContent = '{{ _("Add Employee / Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù") }}';
      submitBtn.className = 'btn btn-success';
    }
    // Reset form title
    const formTitle = document.getElementById('form-title');
    if (formTitle) {
      formTitle.textContent = 'ğŸ“ {{ _("Add New Employee / Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯") }}';
    }
  }
}

// Make function globally accessible
window.clearEmployeeForm = clearEmployeeForm;

// Live search in employees table
(document.getElementById('empSearch')||{}).addEventListener?.('input', function(){
  const q = this.value.toLowerCase();
  document.querySelectorAll('#empTableBody tr').forEach(tr => {
    const txt = tr.textContent.toLowerCase();
    tr.style.display = txt.includes(q) ? '' : 'none';
  });
});

(function(){
  const filter = ()=>{
    const q = (document.getElementById('empSearch')?.value||'').toLowerCase();
    const st = (document.getElementById('empFilterStatus')?.value||'').toLowerCase();
    const dp = (document.getElementById('empFilterDept')?.value||'').toLowerCase();
    const ps = (document.getElementById('empFilterPos')?.value||'').toLowerCase();
    document.querySelectorAll('#empTableBody tr').forEach(tr => {
      const t = tr.textContent.toLowerCase();
      const okQ = !q || t.includes(q);
      const okS = !st || t.includes(st);
      const okD = !dp || t.includes(dp);
      const okP = !ps || t.includes(ps);
      tr.style.display = (okQ && okS && okD && okP) ? '' : 'none';
    });
  };
  ['empFilterStatus','empFilterDept','empFilterPos'].forEach(id=>{
    const el = document.getElementById(id); el && el.addEventListener('input', filter);
  });
})();

document.getElementById('btnExportEmployees')?.addEventListener('click', function(){
  const rows = [['Code','Name','National ID','Department','Position','Phone','Email','Hire Date','Status']];
  const depTotals = {}; const stTotals = {active:0,inactive:0};
  document.querySelectorAll('#empTableBody tr').forEach(tr=>{
    if(tr.style.display==='none') return;
    const tds = Array.from(tr.children).map(td=> td.textContent.trim());
    const code = tds[1]||''; const name = tds[2]||''; const nid = tds[3]||''; const dept=tds[4]||''; const pos=tds[5]||''; const phone=tds[6]||''; const email=tds[7]||''; const hire=tds[8]||''; const status=tds[9]||'';
    rows.push([code,name,nid,dept,pos,phone,email,hire,status]);
    if(dept){ depTotals[dept] = (depTotals[dept]||0) + 1; }
    const isActive = /active|Ù†Ø´Ø·/i.test(status);
    stTotals[isActive?'active':'inactive'] += 1;
  });
  rows.push([]);
  rows.push(['Department Totals','Count']);
  Object.keys(depTotals).sort().forEach(k=> rows.push([k, depTotals[k]]));
  rows.push([]);
  rows.push(['Status Totals','Active','Inactive']);
  rows.push(['', stTotals.active, stTotals.inactive]);
  const csv = rows.map(r=> r.map(x=> String(x).includes(',') ? '"'+String(x).replaceAll('"','""')+'"' : String(x)).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'employees.csv'; a.click();
});

// Quick Department selector fills the input
(function(){
  const sel = document.getElementById('deptQuickSelect');
  if (!sel) return;
  sel.addEventListener('change', function(){
    const inp = document.querySelector('input[name="department"]');
    if (inp && this.value) inp.value = this.value;
  });
})();

// ===== Payroll helpers (UI only) =====
function toNum(v){ const n = parseFloat(v); return isNaN(n)?0:n; }
function updateNet(){
  const base = toNum(document.getElementById('basic_salary')?.value);
  const allow = toNum(document.getElementById('allowances')?.value);
  const ded = toNum(document.getElementById('deductions')?.value);
  const prev = toNum(document.getElementById('previous_due')?.value);
  const paid = toNum(document.getElementById('paid_amount')?.value);
  const net = Math.max(0, base + allow - ded + prev);
  const remaining = Math.max(0, net - paid);
  const netEl = document.getElementById('net_salary');
  const remEl = document.getElementById('remaining_salary');
  if (netEl) netEl.value = 'ï·¼' + net.toFixed(2);
  if (remEl) remEl.value = 'ï·¼' + remaining.toFixed(2);
}
['basic_salary','allowances','deductions','previous_due','paid_amount'].forEach(id=>{
  const el = document.getElementById(id);
  if (el) el.addEventListener('input', updateNet);
});

async function handleCreateSalary(ev){
  ev.preventDefault();
  const monthVal = document.getElementById('pay_month')?.value || '';
  if (!monthVal){ alert('{{ _('Please choose month') }}'); return false; }
  const [year, month] = monthVal.split('-');
  const employee_id = document.getElementById('pay_employee')?.value || '';
  if (!employee_id){ alert('{{ _('Please choose employee') }}'); return false; }
  const base = toNum(document.getElementById('basic_salary')?.value);
  const allow = toNum(document.getElementById('allowances')?.value);
  const ded = toNum(document.getElementById('deductions')?.value);
  const prev = toNum(document.getElementById('previous_due')?.value);
  updateNet();
  const fd = new FormData();
  fd.append('csrf_token', document.querySelector('#paySalaryForm [name=csrf_token]')?.value || '');
  fd.append('employee_id', employee_id);
  fd.append('year', year);
  fd.append('month', month);
  fd.append('basic_salary', base);
  fd.append('allowances', allow);
  fd.append('deductions', ded);
  fd.append('previous_salary_due', prev);
  try{
    const resp = await fetch('{{ url_for('main.employees_create_salary') }}', { method:'POST', body: fd });
    const data = await resp.json().catch(()=>({ok:false,error:'parse_error'}));
    if (resp.ok && data.ok){
      alert('{{ _('Salary saved successfully / ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø§ØªØ¨ Ø¨Ù†Ø¬Ø§Ø­') }}\n{{ _('Net') }}: ' + (data.total?.toFixed?data.total.toFixed(2):data.total));
    } else {
      alert('{{ _('Error') }}: ' + (data.error || resp.status));
    }
  }catch(err){
    alert('{{ _('Network error') }}');
  }
  return false;
}

// Stub: load statements (UI only placeholder for now)
(document.getElementById('btnLoadStatements')||{}).addEventListener?.('click', async function(e){
  e.preventDefault();
  const month = document.getElementById('stmt_month')?.value || '';
  try{
    const url = month ? `/api/salaries/statements?month=${encodeURIComponent(month)}` : '/api/salaries/statements';
    const resp = await fetch(url, {credentials:'same-origin'});
    const data = await resp.json();
    if(!resp.ok || !data.ok){ alert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ÙƒØ´ÙˆÙ Ø§Ù„Ø±ÙˆØ§ØªØ¨'); return; }
    window.statementsData = data;
    const tbody = document.querySelector('#tblStatements tbody'); if(!tbody) return;
    tbody.innerHTML = '';
    let tEmps=0;
    (data.rows||[]).forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.employee_name||''}</td>
        <td>${r.department||''}</td>
        <td class="text-end">${Number(r.basic||0).toFixed(2)}</td>
        <td class="text-end">${Number(r.allow||0).toFixed(2)}</td>
        <td class="text-end">${Number(r.ded||0).toFixed(2)}</td>
        <td class="text-end">${Number(r.net||0).toFixed(2)}</td>
        <td class="text-end">${Number(r.paid||0).toFixed(2)}</td>
        <td class="text-end">${Number(r.remaining||0).toFixed(2)}</td>`;
      tbody.appendChild(tr); tEmps += 1;
    });
    const t = data.totals || {basic:0,allow:0,ded:0,total:0,paid:0,remaining:0};
    document.getElementById('t_emps')?.innerText = tEmps;
    document.getElementById('t_basic')?.innerText = Number(t.basic||0).toFixed(2);
    document.getElementById('t_allow')?.innerText = Number(t.allow||0).toFixed(2);
    document.getElementById('t_ded')?.innerText = Number(t.ded||0).toFixed(2);
    document.getElementById('t_paid')?.innerText = Number(t.paid||0).toFixed(2);
    document.getElementById('t_net')?.innerText = Number(t.total||0).toFixed(2);
    document.getElementById('t_remain')?.innerText = Number(t.remaining||0).toFixed(2);
  }catch(err){ alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©'); }
});

document.getElementById('btnExportStatements')?.addEventListener('click', function(){
  const data = window.statementsData || {rows:[], totals:{}};
  const rows = [['Employee','Department','Basic','Allowances','Deductions','Net','Paid','Remaining']];
  (data.rows||[]).forEach(r=> rows.push([r.employee_name||'', r.department||'', Number(r.basic||0), Number(r.allow||0), Number(r.ded||0), Number(r.net||0), Number(r.paid||0), Number(r.remaining||0)]));
  rows.push([]);
  const t = data.totals || {}; rows.push(['Totals','', Number(t.basic||0), Number(t.allow||0), Number(t.ded||0), Number(t.total||0), Number(t.paid||0), Number(t.remaining||0)]);
  const csv = rows.map(r=> r.map(x=> String(x).includes(',') ? '"'+String(x).replaceAll('"','""')+'"' : String(x)).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'payroll_statements.csv'; a.click();
});
</script>

{% endblock %}
