{% extends "base.html" %}
{% block content %}
<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h2 class="mb-0">๐ค Employees / ุงูููุธููู</h2>
    <a href="{{ url_for('reports.payroll_report') }}" class="btn btn-outline-secondary btn-sm" title="Detailed Payroll Report" aria-label="Detailed Payroll Report">๐ ุชูุฑูุฑ ุงูุฑูุงุชุจ ุงูุชูุตููู</a>
  </div>

  <div class="d-flex gap-2 flex-wrap align-items-center mb-2">
    <a href="{{ url_for('main.add_employee') }}" class="btn btn-primary" title="Add New Employee" aria-label="Add New Employee">โ ุฅุถุงูุฉ ููุธู ุฌุฏูุฏ</a>
    <a href="{{ url_for('main.payroll', year=current_year, month=current_month) }}" class="btn btn-outline-primary" title="Payroll Statements" aria-label="Payroll Statements">๐งพ ูุดูู ุงูุฑูุงุชุจ</a>
    <a href="{{ url_for('main.employees_settings', year=current_year, month=current_month) }}" class="btn btn-outline-info" title="Hourly Settings" aria-label="Hourly Settings">โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุฑูุงุชุจ (ุจุงูุณุงุนุฉ)</a>
    <form method="POST" action="{{ url_for('main.salary_receipt_bulk') }}" class="d-inline" onsubmit="return openPrintModalAndSubmit(this)">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      <input type="hidden" name="year" value="{{ current_year }}"/>
      <input type="hidden" name="month" value="{{ current_month }}"/>
      <button type="submit" class="btn btn-outline-secondary" onclick="return collectSelectedEmployees(this)" title="Print receipt for selected" aria-label="Print receipt for selected">๐จ๏ธ ุทุจุงุนุฉ ุฅูุตุงู (ูุฎุชุงุฑูู)</button>
    </form>
    <div class="ms-auto">
      <input type="text" id="search" class="form-control" placeholder="๐ ุจุญุซ ูู ุงูููุธููู..." onkeyup="filterEmployees()" style="min-width: 260px;" aria-label="Search employees">
    </div>
  </div>

  <div class="text-muted small mb-1">
    ุฅุฌูุงูู: {{ employees|length }}
    &nbsp; | &nbsp; ูุดุท: {{ active_count }}
    &nbsp; | &nbsp; ุบูุฑ ูุดุท: {{ inactive_count }}
  </div>
  <div class="small text-muted mb-2">
    <span class="me-2"><span class="badge bg-success">ูุดุท</span> = Active</span>
    <span class="me-2"><span class="badge bg-secondary">ุบูุฑ ูุดุท</span> = Inactive</span>
  </div>
  {% if (employees|length) == 0 %}
  <div class="alert alert-warning d-flex align-items-center gap-2" role="alert">
    <span>ูุง ููุฌุฏ ููุธููู ุจุนุฏ.</span>
    <a href="{{ url_for('main.add_employee') }}" class="btn btn-sm btn-primary">โ ุฅุถุงูุฉ ุฃูู ููุธู</a>
  </div>
  {% endif %}

  <div class="table-responsive">
    <table class="table table-striped align-middle" id="employeeTable">
      <thead class="table-light position-sticky top-0" style="z-index:1">
        <tr data-id="{{ emp.id }}"
            data-code="{{ emp.employee_code or emp.code }}"
            data-name="{{ emp.full_name }}"
            data-nid="{{ emp.national_id }}"
            data-dept="{{ emp.department }}"
            data-pos="{{ emp.position }}"
            data-phone="{{ emp.phone or '-' }}"
            data-email="{{ emp.email or '-' }}"
            data-hiredate="{{ emp.hire_date }}"
            data-status="{{ emp.status }}">
          <th style="width:36px"><input type="checkbox" id="select_all" title="Select all visible"></th>
          <th style="width:56px">#</th>
          <th>ุงูุฑูุฒ</th>
          <th>ุงูุงุณู</th>
          <th>ุงููููุฉ</th>
          <th>ุงููุณู</th>
          <th>ุงููุธููุฉ</th>
          <th>ุงููุงุชู</th>
          <th>ุงูุจุฑูุฏ</th>
          <th>ุชุงุฑูุฎ ุงูุชุนููู</th>
          <th>ุงูุญุงูุฉ</th>
          <th style="white-space: nowrap;">ุฅุฌุฑุงุกุงุช</th>
        </tr>
      </thead>
      <tbody>
        {% for emp in employees %}
        <tr>
          <td><input type="checkbox" class="form-check-input emp-select" value="{{ emp.id }}" title="ุชุญุฏูุฏ ููุทุจุงุนุฉ ุงูุฌูุงุนูุฉ"/></td>
          <td>{{ loop.index }}</td>
          <td>{{ emp.employee_code or emp.code }}</td>
          <td>
            <button type="button" class="btn btn-link p-0" onclick="openEmployeeDetails(this)" data-bs-toggle="modal" data-bs-target="#employeeModal" title="ุชูุงุตูู ุงูููุธู" aria-label="ุชูุงุตูู ุงูููุธู">{{ emp.full_name }}</button>
          </td>
          <td>{{ emp.national_id }}</td>
          <td>{{ emp.department }}</td>
          <td>{{ emp.position }}</td>
          <td>{{ emp.phone or "-" }}</td>
          <td>{{ emp.email or "-" }}</td>
          <td>{{ emp.hire_date }}</td>
          <td>
            {% if emp.status == 'active' %}
              <span class="badge bg-success">ูุดุท</span>
            {% else %}
              <span class="badge bg-secondary">ุบูุฑ ูุดุท</span>
            {% endif %}
          </td>
          <td style="white-space: nowrap;">
            <button type="button" class="btn btn-sm btn-secondary" onclick="openEmployeeDetails(this)" data-bs-toggle="modal" data-bs-target="#employeeModal" title="ุชูุงุตูู" aria-label="ุชูุงุตูู">ุชูุงุตูู</button>
            <a href="{{ url_for('main.edit_employee', emp_id=emp.id) }}" class="btn btn-sm btn-warning" title="Edit" aria-label="Edit">ุชุนุฏูู</a>
            <a href="{{ url_for('main.pay_salary', emp_id=emp.id, year=current_year, month=current_month) }}" class="btn btn-sm btn-info" title="Pay salary" aria-label="Pay salary">ุณุฏุงุฏ</a>
            <form method="POST" action="{{ url_for('main.employee_delete', eid=emp.id) }}" style="display:inline;">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
              <button class="btn btn-sm btn-danger" onclick="return confirm('ุชุฃููุฏ ุญุฐู ุงูููุธูุ')" title="Delete" aria-label="Delete">ุญุฐู</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Employee Quick Details Modal -->
<div class="modal fade" id="employeeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ุชูุงุตูู ุงูููุธู</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-2">
          <div class="col-6"><strong>ุงูุงุณู:</strong> <span id="emName"></span></div>
          <div class="col-6"><strong>ุงูุฑูุฒ:</strong> <span id="emCode"></span></div>
          <div class="col-6"><strong>ุงููููุฉ:</strong> <span id="emNID"></span></div>
          <div class="col-6"><strong>ุงููุณู:</strong> <span id="emDept"></span></div>
          <div class="col-6"><strong>ุงููุธููุฉ:</strong> <span id="emPos"></span></div>
          <div class="col-6"><strong>ุงููุงุชู:</strong> <span id="emPhone"></span></div>
          <div class="col-6"><strong>ุงูุจุฑูุฏ:</strong> <span id="emEmail"></span></div>
          <div class="col-6"><strong>ุงูุชุนููู:</strong> <span id="emHire"></span></div>
          <div class="col-12">
            <strong>ุงูุญุงูุฉ:</strong>
            <span id="emStatusBadge" class="badge"></span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <a id="emEditLink" class="btn btn-warning">ุชุนุฏูู</a>
        <a id="emPayLink" class="btn btn-info">ุณุฏุงุฏ</a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅุบูุงู</button>
      </div>
    </div>
  </div>
</div>

<script>
function filterEmployees() {
  let input = document.getElementById("search").value.toLowerCase();
  let rows = document.querySelectorAll("#employeeTable tbody tr");
  rows.forEach(row => {
    let txt = row.innerText.toLowerCase();
    row.style.display = txt.includes(input) ? "" : "none";
  });
}

function openEmployeeDetails(btn){
  try{
    const row = btn.closest('tr');
    if(!row) return;
    const get = k => (row.dataset[k] && row.dataset[k] !== 'None') ? row.dataset[k] : '-';
    document.getElementById('emName').textContent = get('name');
    document.getElementById('emCode').textContent = get('code');
    document.getElementById('emNID').textContent = get('nid');
    document.getElementById('emDept').textContent = get('dept');
    document.getElementById('emPos').textContent = get('pos');
    document.getElementById('emPhone').textContent = get('phone');
    document.getElementById('emEmail').textContent = get('email');
    document.getElementById('emHire').textContent = get('hiredate');
    const status = (get('status')||'').toLowerCase();
    const badge = document.getElementById('emStatusBadge');
    badge.textContent = (status === 'active') ? 'ูุดุท' : 'ุบูุฑ ูุดุท';
    badge.className = 'badge ' + ((status === 'active') ? 'bg-success' : 'bg-secondary');
    const id = row.dataset.id;
    const y = {{ current_year }}; const m = {{ current_month }};
    document.getElementById('emEditLink').href = "{{ url_for('main.edit_employee', emp_id=0) }}".replace('0', id);
    document.getElementById('emPayLink').href = "{{ url_for('main.pay_salary', emp_id=0, year=current_year, month=current_month) }}".replace('0', id);
  }catch(e){}
}

function collectSelectedEmployees(btn){
  const ids = Array.from(document.querySelectorAll('.emp-select:checked')).map(x=>x.value);
  if(ids.length === 0){ alert('ุงุฎุชุฑ ููุธููุง ูุงุญุฏูุง ุนูู ุงูุฃูู'); return false; }
  const form = btn.closest('form');
  // remove old
  form.querySelectorAll('input[name="employee_ids"]').forEach(n=>n.remove());
  // append new
  ids.forEach(id=>{
    const i = document.createElement('input');
    i.type = 'hidden'; i.name = 'employee_ids'; i.value = id; form.appendChild(i);
  });
  return true;
}

 document.getElementById('select_all')?.addEventListener('change', function(e){
   const boxes = document.querySelectorAll('.emp-select');
   boxes.forEach(cb => { if (cb.closest('tr').style.display !== 'none') cb.checked = e.target.checked; });
 });
</script>
{% endblock %}


