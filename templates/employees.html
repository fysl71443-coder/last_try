{% extends 'base.html' %}
{% set back_url = url_for('main.dashboard') %}
{% block title %}{{ _('Employees') }}{% endblock %}
{% block content %}
<style>
.emp-tab-wrap .ops-tab.active { background: var(--ops-blue, #1565c0); color: #fff; }
.emp-tab-wrap .ops-tab { border-radius: 8px; }
</style>
<div class="container py-4 ops-layout hub-wrap">
  <div class="ops-header-bar">
    <span class="ops-icon"><i class="fa-solid fa-user-group"></i></span>
    <div>
      <h1 class="ops-title mb-0">{{ _('Employees') }}</h1>
      <span class="ops-subtitle">{{ _('Add employees, payroll, advances, reports') }}</span>
    </div>
    <div class="ops-actions d-flex flex-wrap gap-2" data-partial-links>
      <a href="{{ url_for('main.employees_settings') }}" class="btn btn-sm"><i class="fa-solid fa-gear me-1"></i>{{ _('Settings') }}</a>
      <a href="{{ url_for('main.dashboard') }}" class="btn btn-sm"><i class="fa-solid fa-house me-1"></i>{{ _('Dashboard') }}</a>
    </div>
  </div>

  <div class="ops-tabs-wrap emp-tab-wrap">
    <div class="ops-tabs" role="tablist">
      <button type="button" class="ops-tab {{ 'active' if tab == 'add' else '' }}" data-panel="panel-add">{{ _('Add') }}</button>
      <button type="button" class="ops-tab {{ 'active' if tab == 'payroll' else '' }}" data-panel="panel-payroll">{{ _('Payroll run') }}</button>
      <button type="button" class="ops-tab {{ 'active' if tab == 'reports' else '' }}" data-panel="panel-reports">{{ _('Payroll reports') }}</button>
      <button type="button" class="ops-tab {{ 'active' if tab == 'advances' else '' }}" data-panel="panel-advances">{{ _('Advances') }}</button>
      <button type="button" class="ops-tab {{ 'active' if tab == 'unpaid' else '' }}" data-panel="panel-unpaid">{{ _('Unpaid dues') }}</button>
      <button type="button" class="ops-tab {{ 'active' if tab == 'payment' else '' }}" data-panel="panel-payment">{{ _('Payment') }}</button>
    </div>
  </div>

  <div class="ops-body ops-body-no-sidebar">
    <main class="ops-main">
      <!-- Tab 1: Add employees -->
      <div id="panel-add" class="ops-panel {{ '' if tab == 'add' else 'd-none' }}" data-panel>
        <div class="ops-form-card mt-0">
          <div class="ops-form-head">{{ _('Add employee') }}</div>
          <div class="ops-form-body">
            <form id="emp-add-form" class="row g-3">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
              <div class="col-md-4"><label class="form-label">{{ _('Full name') }} <span class="text-danger">*</span></label><input name="full_name" class="form-control" required></div>
              <div class="col-md-4"><label class="form-label">{{ _('National ID') }} <span class="text-danger">*</span></label><input name="national_id" class="form-control" required placeholder="مثال: 1xxxxxxxx"></div>
              <div class="col-md-4"><label class="form-label">{{ _('Department') }}</label><input name="department" class="form-control" placeholder="{{ _('مثال: مطبخ، صالة') }}"></div>
              <div class="col-md-4"><label class="form-label">{{ _('Position') }}</label><input name="position" class="form-control"></div>
              <div class="col-md-4"><label class="form-label">{{ _('Phone') }}</label><input name="phone" class="form-control"></div>
              <div class="col-md-4"><label class="form-label">{{ _('Email') }}</label><input name="email" type="email" class="form-control"></div>
              <div class="col-md-4"><label class="form-label">{{ _('Hire date') }}</label><input name="hire_date" type="date" class="form-control"></div>
              <div class="col-md-4"><label class="form-label">{{ _('Base salary') }}</label><input name="base_salary" type="number" step="0.01" min="0" class="form-control" value="0"></div>
              <div class="col-md-4 d-flex align-items-end"><button type="submit" class="btn btn-primary"><i class="fa-solid fa-plus me-1"></i>{{ _('Add') }}</button></div>
            </form>
            <div id="emp-add-msg" class="mt-2"></div>
          </div>
        </div>
        <div class="ops-form-card">
          <div class="ops-form-head">{{ _('Employees list') }}</div>
          <div class="ops-form-body p-0">
            <div class="table-responsive screen-table-wrap">
              <table class="table table-hover screen-table mb-0">
                <thead><tr><th>#</th><th>{{ _('Name') }}</th><th>{{ _('Department') }}</th><th>{{ _('Phone') }}</th><th>{{ _('Base salary') }}</th><th></th></tr></thead>
                <tbody id="emp-list-tbody">
                  {% for e in employees %}
                  <tr data-id="{{ e.id }}">
                    <td>{{ e.employee_code or e.id }}</td>
                    <td>{{ e.full_name }}</td>
                    <td>{{ e.department or '—' }}</td>
                    <td>{{ e.phone or '—' }}</td>
                    <td>{% set d = e.employee_salary_default %}{% if d %}﷼{{ '%.2f'|format(d.base_salary or 0) }}{% else %}—{% endif %}</td>
                    <td>
                      <form method="post" action="{{ url_for('main.employee_delete', eid=e.id) }}" class="d-inline" onsubmit="return confirm('{{ _('Delete this employee?') }}');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-sm btn-outline-danger">{{ _('Delete') }}</button>
                      </form>
                    </td>
                  </tr>
                  {% else %}
                  <tr><td colspan="6" class="text-center text-muted py-4">{{ _('No employees yet') }}</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab 2: Payroll run -->
      <div id="panel-payroll" class="ops-panel {{ 'd-none' if tab != 'payroll' else '' }}" data-panel>
        <div class="ops-form-card mt-0">
          <div class="ops-form-head">{{ _('مسير الرواتب') }} — {{ _('انقر «إنشاء مسير» لفتح النموذج، اختر الشهر، املأ الحقول (الأساسي من بيانات الموظف مع إمكانية التعديل)، ثم احفظ المسير. بعد الحفظ يصبح المسير جاهزاً للترحيل.') }}</div>
          <div class="ops-form-body">
            <div class="row g-3 align-items-end mb-3">
              <div class="col-auto"><label class="form-label">{{ _('Year') }}</label><select id="pay-year" class="form-select">{% for y in years %}<option value="{{ y }}" {{ 'selected' if y == year else '' }}>{{ y }}</option>{% endfor %}</select></div>
              <div class="col-auto"><label class="form-label">{{ _('Month') }}</label><select id="pay-month" class="form-select">{% for m in months %}<option value="{{ m.value }}" {{ 'selected' if m.value == month else '' }}>{{ m.label }}</option>{% endfor %}</select></div>
              <div class="col-auto"><label class="form-label">{{ _('Department') }}</label><select id="pay-dept" class="form-select"><option value="">{{ _('All') }}</option>{% for d in dept_options %}<option value="{{ d }}" {{ 'selected' if (pay_dept or '') and d == (pay_dept or '') else '' }}>{{ d }}</option>{% endfor %}</select></div>
              <div class="col-auto"><label class="form-label">{{ _('Status') }}</label><select id="pay-status" class="form-select"><option value="all" {{ 'selected' if (pay_status or 'all') == 'all' else '' }}>{{ _('All') }}</option><option value="due" {{ 'selected' if (pay_status or '') == 'due' else '' }}>{{ _('Due') }}</option><option value="partial" {{ 'selected' if (pay_status or '') == 'partial' else '' }}>{{ _('Partial') }}</option><option value="paid" {{ 'selected' if (pay_status or '') == 'paid' else '' }}>{{ _('Paid') }}</option></select></div>
              <div class="col-auto"><button type="button" class="btn btn-primary" id="pay-apply"><i class="fa-solid fa-filter me-1"></i>{{ _('Apply') }}</button></div>
            </div>
            <div class="kpi-row" id="pay-kpis"></div>
            <div class="table-responsive screen-table-wrap">
              <table class="table table-hover screen-table mb-0" id="pay-table">
                <thead>
                  <tr>
                    <th><input type="checkbox" id="pay-select-all" class="form-check-input" title="{{ _('تحديد الكل') }}"></th>
                    <th>{{ _('Employee') }}</th>
                    <th>{{ _('Department') }}</th>
                    <th class="text-end">{{ _('أساسي') }}</th>
                    <th class="text-end">{{ _('إضافي') }}</th>
                    <th class="text-end">{{ _('غياب') }}</th>
                    <th class="text-end">{{ _('حافز') }}</th>
                    <th class="text-end">{{ _('بدلات') }}</th>
                    <th class="text-end">{{ _('استقطاعات') }}</th>
                    <th class="text-end">{{ _('إجمالي') }}</th>
                    <th class="text-end">{{ _('مدفوع') }}</th>
                    <th class="text-end">{{ _('متبقي') }}</th>
                    <th>{{ _('Status') }}</th>
                  </tr>
                </thead>
                <tbody id="pay-tbody"></tbody>
                <tfoot id="pay-tfoot"></tfoot>
              </table>
            </div>
            <p class="text-muted small mb-2">{{ _('مصدر البيانات: المسيرات المنشأة فقط. عدم وجود مسيرات = عدم عرض أي استحقاق. انقر «إنشاء مسير» لفتح النموذج واختيار الشهر وملء الحقول ثم حفظ المسير.') }}</p>
            <div class="d-flex flex-wrap gap-2 mt-3 align-items-center">
              <button type="button" class="btn btn-outline-secondary" id="pay-ensure-records"><i class="fa-solid fa-wand-magic-sparkles me-1"></i>{{ _('إنشاء مسيرات من تاريخ التعيين') }}</button>
              <button type="button" class="btn btn-primary" id="pay-open-create-run"><i class="fa-solid fa-plus me-1"></i>{{ _('إنشاء مسير') }}</button>
              <button type="button" class="btn btn-warning d-none" id="pay-post-run"><i class="fa-solid fa-paper-plane me-1"></i>{{ _('ترحيل المسير (إنشاء قيد استحقاق)') }}</button>
              <span class="badge bg-secondary ms-2" id="pay-run-status"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal: إنشاء مسير -->
      <div class="modal fade" id="modal-create-payroll" tabindex="-1" aria-labelledby="modal-create-payroll-label" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="modal-create-payroll-label">{{ _('إنشاء مسير') }} — {{ _('اختر الشهر ثم املأ الحقول (الأساسي من بيانات الموظف مع إمكانية التعديل)') }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row g-3 mb-3">
                <div class="col-auto"><label class="form-label">{{ _('السنة') }}</label><select id="modal-pay-year" class="form-select">{% for y in years %}<option value="{{ y }}" {{ 'selected' if y == year else '' }}>{{ y }}</option>{% endfor %}</select></div>
                <div class="col-auto"><label class="form-label">{{ _('الشهر') }}</label><select id="modal-pay-month" class="form-select">{% for m in months %}<option value="{{ m.value }}" {{ 'selected' if m.value == month else '' }}>{{ m.label }}</option>{% endfor %}</select></div>
                <div class="col-auto"><label class="form-label">{{ _('القسم') }}</label><select id="modal-pay-dept" class="form-select"><option value="">{{ _('الكل') }}</option>{% for d in dept_options %}<option value="{{ d }}">{{ d }}</option>{% endfor %}</select></div>
                <div class="col-auto d-flex align-items-end"><button type="button" class="btn btn-sm btn-outline-primary" id="modal-pay-load">{{ _('تحميل الموظفين') }}</button></div>
              </div>
              <div class="table-responsive">
                <table class="table table-hover table-sm mb-0" id="modal-pay-table">
                  <thead>
                    <tr>
                      <th><input type="checkbox" id="modal-pay-select-all" class="form-check-input" title="{{ _('تحديد الكل') }}"></th>
                      <th>{{ _('الموظف') }}</th>
                      <th>{{ _('القسم') }}</th>
                      <th class="text-end">{{ _('أساسي') }}</th>
                      <th class="text-end">{{ _('إضافي') }}</th>
                      <th class="text-end">{{ _('غياب') }}</th>
                      <th class="text-end">{{ _('حافز') }}</th>
                      <th class="text-end">{{ _('بدلات') }}</th>
                      <th class="text-end">{{ _('استقطاعات') }}</th>
                      <th class="text-end">{{ _('إجمالي') }}</th>
                    </tr>
                  </thead>
                  <tbody id="modal-pay-tbody"></tbody>
                </table>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('إلغاء') }}</button>
              <button type="button" class="btn btn-success" id="modal-pay-save"><i class="fa-solid fa-check me-1"></i>{{ _('حفظ المسير') }}</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab 3: Payroll reports -->
      <div id="panel-reports" class="ops-panel d-none" data-panel>
        <div class="ops-form-card mt-0">
          <div class="ops-form-head">{{ _('Payroll reports') }} — {{ _('From date') }} – {{ _('To date') }}</div>
          <div class="ops-form-body">
            <div class="row g-3 align-items-end mb-3">
              <div class="col-auto"><label class="form-label">{{ _('From year') }}</label><select id="rep-y-from" class="form-select">{% for y in years %}<option value="{{ y }}">{{ y }}</option>{% endfor %}</select></div>
              <div class="col-auto"><label class="form-label">{{ _('From month') }}</label><select id="rep-m-from" class="form-select">{% for m in months %}<option value="{{ m.value }}">{{ m.label }}</option>{% endfor %}</select></div>
              <div class="col-auto"><label class="form-label">{{ _('To year') }}</label><select id="rep-y-to" class="form-select">{% for y in years %}<option value="{{ y }}" {{ 'selected' if y == year else '' }}>{{ y }}</option>{% endfor %}</select></div>
              <div class="col-auto"><label class="form-label">{{ _('To month') }}</label><select id="rep-m-to" class="form-select">{% for m in months %}<option value="{{ m.value }}" {{ 'selected' if m.value == month else '' }}>{{ m.label }}</option>{% endfor %}</select></div>
              <div class="col-md-4"><label class="form-label">{{ _('Employees') }}</label>
                <div class="d-flex gap-1 align-items-start">
                  <select id="rep-employees" class="form-select" multiple size="5" style="min-width:220px">
                    {% for e in employees %}<option value="{{ e.id }}">{{ e.full_name }} ({{ e.department or '-' }})</option>{% endfor %}
                  </select>
                  <div class="d-flex flex-column gap-1">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="rep-emp-all" title="{{ _('Select all') }}">{{ _('الكل') }}</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="rep-emp-clear" title="{{ _('Clear') }}">{{ _('إلغاء') }}</button>
                  </div>
                </div>
                <small class="text-muted">{{ _('لا تحدد = الكل. حدد موظفاً أو عدة موظفين للطباعة.') }}</small>
              </div>
              <div class="col-auto"><a href="#" id="rep-print" class="btn btn-primary" target="_blank"><i class="fa-solid fa-print me-1"></i>{{ _('Print') }}</a></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab 4: Advances -->
      <div id="panel-advances" class="ops-panel d-none" data-panel>
        <div class="ops-form-card mt-0">
          <div class="ops-form-head">{{ _('Grant advance') }}</div>
          <div class="ops-form-body">
            <div class="row g-3 align-items-end mb-3">
              <div class="col-md-3"><label class="form-label">{{ _('Employee') }}</label><select id="adv-emp" class="form-select"><option value="">{{ _('Select') }}</option>{% for e in employees %}<option value="{{ e.id }}">{{ e.full_name }} ({{ e.department or '-' }})</option>{% endfor %}</select></div>
              <div class="col-md-2"><label class="form-label">{{ _('Date') }}</label><input type="date" id="adv-date" class="form-control" value="{{ start_date }}"></div>
              <div class="col-md-2"><label class="form-label">{{ _('Amount') }}</label><div class="input-group"><span class="input-group-text">﷼</span><input type="number" step="0.01" min="0" id="adv-amount" class="form-control" placeholder="0"></div></div>
              <div class="col-md-2"><label class="form-label">{{ _('Method') }}</label><select id="adv-method" class="form-select"><option value="cash">{{ _('Cash') }}</option><option value="bank">{{ _('Bank') }}</option></select></div>
              <div class="col-md-2"><button type="button" class="btn btn-primary w-100" id="adv-grant"><i class="fa-solid fa-hand-holding-dollar me-1"></i>{{ _('Grant') }}</button></div>
            </div>
            <div id="adv-grant-msg" class="mb-3"></div>
          </div>
        </div>
        <div class="ops-form-card">
          <div class="ops-form-head">{{ _('Advances list & recover') }} — {{ _('From date') }} – {{ _('To date') }}</div>
          <div class="ops-form-body">
            <div class="row g-3 align-items-end mb-3">
              <div class="col-auto"><label class="form-label">{{ _('From date') }}</label><input type="date" id="adv-start" class="form-control" value="{{ start_date }}"></div>
              <div class="col-auto"><label class="form-label">{{ _('To date') }}</label><input type="date" id="adv-end" class="form-control" value="{{ end_date }}"></div>
              <div class="col-auto"><label class="form-label">{{ _('Employee') }}</label><select id="adv-filter-emp" class="form-select" style="min-width:180px"><option value="">{{ _('All') }}</option>{% for e in employees %}<option value="{{ e.id }}">{{ e.full_name }}</option>{% endfor %}</select></div>
              <div class="col-auto"><button type="button" class="btn btn-primary" id="adv-load"><i class="fa-solid fa-search me-1"></i>{{ _('Load') }}</button></div>
            </div>
            <div class="table-responsive screen-table-wrap">
              <table class="table table-hover screen-table mb-0">
                <thead><tr><th>{{ _('Employee') }}</th><th>{{ _('Department') }}</th><th class="text-end">{{ _('Granted') }}</th><th class="text-end">{{ _('Repaid') }}</th><th class="text-end">{{ _('Remaining') }}</th><th></th></tr></thead>
                <tbody id="adv-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal: Repay advance -->
      <div class="modal fade" id="repay-modal" tabindex="-1" aria-labelledby="repay-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="repay-modal-label">{{ _('Repay advance') }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p class="text-muted small mb-2" id="repay-emp-info"></p>
              <p class="text-muted small mb-2" id="repay-remaining-hint"></p>
              <form id="repay-form">
                <input type="hidden" id="repay-emp-id" name="employee_id">
                <div class="mb-3">
                  <label class="form-label">{{ _('Date') }}</label>
                  <input type="date" id="repay-date" class="form-control" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">{{ _('Amount') }}</label>
                  <div class="input-group">
                    <span class="input-group-text">﷼</span>
                    <input type="number" step="0.01" min="0" id="repay-amount" class="form-control" placeholder="0" required>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">{{ _('Payment method') }}</label>
                  <select id="repay-method" class="form-select">
                    <option value="cash">{{ _('Cash') }}</option>
                    <option value="bank">{{ _('Bank') }}</option>
                    <option value="transfer">{{ _('Transfer') }}</option>
                  </select>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
              <button type="button" class="btn btn-primary" id="repay-submit"><i class="fa-solid fa-check me-1"></i>{{ _('Repay') }}</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab 5: Payment (سداد فردي وجماعي) -->
      <div id="panel-payment" class="ops-panel {{ 'd-none' if tab != 'payment' else '' }}" data-panel>
        <div class="ops-form-card mt-0">
          <div class="ops-form-head">{{ _('السداد الفردي') }} — {{ _('موظف واحد، شهر واحد أو عدة أشهر (كل شهر = مسير)') }}</div>
          <div class="ops-form-body">
            <div class="row g-3 align-items-end mb-3">
              <div class="col-md-3"><label class="form-label">{{ _('Employee') }}</label><select id="pay-emp-single" class="form-select"><option value="">{{ _('Select') }}</option>{% for e in employees %}<option value="{{ e.id }}">{{ e.full_name }} ({{ e.department or '-' }})</option>{% endfor %}</select></div>
              <div class="col-auto"><label class="form-label">{{ _('From') }}</label><div class="d-flex gap-1"><select id="pay-single-from-year" class="form-select" style="min-width:85px">{% for y in years %}<option value="{{ y }}" {{ 'selected' if y == year else '' }}>{{ y }}</option>{% endfor %}</select><select id="pay-single-from-month" class="form-select" style="min-width:100px">{% for m in months %}<option value="{{ m.value }}" {{ 'selected' if m.value == month else '' }}>{{ m.label }}</option>{% endfor %}</select></div></div>
              <div class="col-auto"><label class="form-label">{{ _('To') }}</label><div class="d-flex gap-1"><select id="pay-single-to-year" class="form-select" style="min-width:85px">{% for y in years %}<option value="{{ y }}" {{ 'selected' if y == year else '' }}>{{ y }}</option>{% endfor %}</select><select id="pay-single-to-month" class="form-select" style="min-width:100px">{% for m in months %}<option value="{{ m.value }}" {{ 'selected' if m.value == month else '' }}>{{ m.label }}</option>{% endfor %}</select></div></div>
              <div class="col-auto"><button type="button" class="btn btn-primary" id="pay-load-unpaid-months"><i class="fa-solid fa-list me-1"></i>{{ _('تحميل الأشهر غير المدفوعة') }}</button></div>
            </div>
            <p class="text-muted small mb-2">{{ _('شهر واحد: اختر نفس الشهر في «من» و«إلى». عدة أشهر: من - إلى يعرض جميع المسيرات غير المدفوعة في النطاق.') }}</p>
            <div class="row g-2 mb-2">
              <div class="col-md-2"><label class="form-label">{{ _('Date') }}</label><input type="date" id="pay-single-date" class="form-control" value="{{ start_date }}"></div>
              <div class="col-md-2"><label class="form-label">{{ _('Method') }}</label><select id="pay-single-method" class="form-select"><option value="cash">{{ _('Cash') }}</option><option value="transfer">{{ _('Transfer') }}</option><option value="cheque">{{ _('Cheque') }}</option></select></div>
            </div>
            <div class="table-responsive screen-table-wrap">
              <table class="table table-hover screen-table mb-0" id="pay-single-table">
                <thead><tr><th><input type="checkbox" id="pay-single-select-all" class="form-check-input" title="{{ _('تحديد الكل') }}"></th><th>{{ _('الشهر') }}</th><th class="text-end">{{ _('الإجمالي') }}</th><th class="text-end">{{ _('مدفوع') }}</th><th class="text-end">{{ _('متبقي') }}</th><th></th></tr></thead>
                <tbody id="pay-single-tbody"></tbody>
              </table>
            </div>
            <div class="mt-2"><button type="button" class="btn btn-success d-none" id="pay-single-batch"><i class="fa-solid fa-money-bill-wave me-1"></i>{{ _('سداد المحدد (كامل)') }}</button> <span class="ms-2 text-muted small" id="pay-single-hint"></span></div>
          </div>
        </div>
        <div class="ops-form-card mt-3">
          <div class="ops-form-head">{{ _('السداد الجماعي') }} — {{ _('مسير واحد أو عدة مسيرات (شهر = مسير، سداد كامل للمسير)') }}</div>
          <div class="ops-form-body">
            <div class="row g-3 align-items-end mb-3">
              <div class="col-auto"><label class="form-label">{{ _('From') }}</label><div class="d-flex gap-1"><select id="pay-collective-from-year" class="form-select" style="min-width:85px">{% for y in years %}<option value="{{ y }}" {{ 'selected' if y == year else '' }}>{{ y }}</option>{% endfor %}</select><select id="pay-collective-from-month" class="form-select" style="min-width:100px">{% for m in months %}<option value="{{ m.value }}" {{ 'selected' if m.value == month else '' }}>{{ m.label }}</option>{% endfor %}</select></div></div>
              <div class="col-auto"><label class="form-label">{{ _('To') }}</label><div class="d-flex gap-1"><select id="pay-collective-to-year" class="form-select" style="min-width:85px">{% for y in years %}<option value="{{ y }}" {{ 'selected' if y == year else '' }}>{{ y }}</option>{% endfor %}</select><select id="pay-collective-to-month" class="form-select" style="min-width:100px">{% for m in months %}<option value="{{ m.value }}" {{ 'selected' if m.value == month else '' }}>{{ m.label }}</option>{% endfor %}</select></div></div>
              <div class="col-auto"><button type="button" class="btn btn-primary" id="pay-load-unpaid-runs"><i class="fa-solid fa-list me-1"></i>{{ _('تحميل المسيرات غير المدفوعة') }}</button></div>
              <div class="col-md-2"><label class="form-label">{{ _('Date') }}</label><input type="date" id="pay-collective-date" class="form-control" value="{{ start_date }}"></div>
              <div class="col-md-2"><label class="form-label">{{ _('Method') }}</label><select id="pay-collective-method" class="form-select"><option value="cash">{{ _('Cash') }}</option><option value="transfer">{{ _('Transfer') }}</option><option value="cheque">{{ _('Cheque') }}</option></select></div>
            </div>
            <p class="text-muted small mb-2">{{ _('شهر واحد: اختر نفس الشهر في «من» و«إلى». عدة أشهر: من - إلى يعرض جميع المسيرات غير المدفوعة في النطاق.') }} {{ _('يمكنك أيضاً السداد من شاشة العمليات المالية عند اختيار «سداد مستحقات» → رواتب مستحقة.') }}</p>
            <div class="table-responsive screen-table-wrap">
              <table class="table table-hover screen-table mb-0" id="pay-collective-table">
                <thead><tr><th><input type="checkbox" id="pay-collective-select-all" class="form-check-input" title="{{ _('تحديد الكل') }}"></th><th>{{ _('المسير (الشهر)') }}</th><th class="text-end">{{ _('متبقي') }}</th><th>{{ _('عدد الموظفين') }}</th><th></th></tr></thead>
                <tbody id="pay-collective-tbody"></tbody>
              </table>
            </div>
            <div class="mt-2"><button type="button" class="btn btn-success d-none" id="pay-collective-batch"><i class="fa-solid fa-money-bill-wave me-1"></i>{{ _('سداد المحدد') }}</button> <span class="ms-2 text-muted small" id="pay-collective-hint"></span></div>
          </div>
        </div>
      </div>

      <!-- Tab 6: Unpaid dues -->
      <div id="panel-unpaid" class="ops-panel d-none" data-panel>
        <div class="ops-form-card mt-0">
          <div class="ops-form-head">{{ _('Unpaid salary dues') }}</div>
          <p class="text-muted small mb-2">{{ _('All payroll runs that have been processed for employees and not yet paid') }}</p>
          <div class="ops-form-body">
            <div class="row g-3 align-items-end mb-3">
              <div class="col-auto"><label class="form-label">{{ _('Year') }}</label><select id="unp-year" class="form-select">{% for y in years %}<option value="{{ y }}" {{ 'selected' if y == year else '' }}>{{ y }}</option>{% endfor %}</select></div>
              <div class="col-auto"><label class="form-label">{{ _('Month') }}</label><select id="unp-month" class="form-select">{% for m in months %}<option value="{{ m.value }}" {{ 'selected' if m.value == month else '' }}>{{ m.label }}</option>{% endfor %}</select></div>
              <div class="col-auto"><label class="form-label">{{ _('Department') }}</label><select id="unp-dept" class="form-select"><option value="">{{ _('All') }}</option>{% for d in dept_options %}<option value="{{ d }}">{{ d }}</option>{% endfor %}</select></div>
              <div class="col-auto"><button type="button" class="btn btn-primary" id="unp-apply"><i class="fa-solid fa-filter me-1"></i>{{ _('Apply') }}</button></div>
            </div>
            <div class="kpi-row" id="unp-kpis"></div>
            <div class="table-responsive screen-table-wrap">
              <table class="table table-hover screen-table mb-0">
                <thead><tr><th>{{ _('Employee') }}</th><th class="text-end">{{ _('Total') }}</th><th class="text-end">{{ _('Paid') }}</th><th class="text-end">{{ _('Remaining') }}</th><th>{{ _('Status') }}</th></tr></thead>
                <tbody id="unp-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
(function() {
  function csrfToken() { var t = document.querySelector('meta[name="csrf-token"]'); return t ? (t.getAttribute('content') || '') : ''; }

  // Tab switching
  document.querySelectorAll('.ops-tabs-wrap .ops-tab[data-panel]').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const id = this.getAttribute('data-panel');
      document.querySelectorAll('.ops-tabs-wrap .ops-tab[data-panel]').forEach(function(b) { b.classList.remove('active'); });
      document.querySelectorAll('.ops-panel[data-panel]').forEach(function(p) { p.classList.add('d-none'); });
      this.classList.add('active');
      const pan = document.getElementById(id);
      if (pan) { pan.classList.remove('d-none'); }
      if (id === 'panel-payroll') loadPayroll();
      if (id === 'panel-advances') loadAdvances();
      if (id === 'panel-unpaid') loadUnpaid();
    });
  });

  // Payment tab: individual unpaid months (فلترة: شهر واحد أو عدة أشهر من - إلى)
  document.getElementById('pay-load-unpaid-months') && document.getElementById('pay-load-unpaid-months').addEventListener('click', function() {
    var empId = document.getElementById('pay-emp-single').value;
    if (!empId) { alert(typeof _ !== 'undefined' ? _('اختر موظفاً.') : 'Select employee.'); return; }
    var fromY = document.getElementById('pay-single-from-year') && document.getElementById('pay-single-from-year').value;
    var fromM = document.getElementById('pay-single-from-month') && document.getElementById('pay-single-from-month').value;
    var toY = document.getElementById('pay-single-to-year') && document.getElementById('pay-single-to-year').value;
    var toM = document.getElementById('pay-single-to-month') && document.getElementById('pay-single-to-month').value;
    var u = '/api/employee-unpaid-months?employee_id=' + encodeURIComponent(empId);
    if (fromY && fromM) u += '&from_year=' + encodeURIComponent(fromY) + '&from_month=' + encodeURIComponent(fromM);
    if (toY && toM) u += '&to_year=' + encodeURIComponent(toY) + '&to_month=' + encodeURIComponent(toM);
    fetch(u).then(function(r) { return r.json(); }).then(function(j) {
      var tbody = document.getElementById('pay-single-tbody');
      var batchBtn = document.getElementById('pay-single-batch');
      var hint = document.getElementById('pay-single-hint');
      if (!j.ok || !(j.months && j.months.length)) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">' + (typeof _ !== 'undefined' ? _('لا توجد أشهر غير مدفوعة.') : 'No unpaid months.') + '</td></tr>';
        if (batchBtn) batchBtn.classList.add('d-none');
        if (hint) hint.textContent = '';
        return;
      }
      var h = '';
      j.months.forEach(function(m) {
        var payUrl = '/employees/' + empId + '/pay?year=' + m.year + '&month=' + m.month;
        h += '<tr data-year="' + m.year + '" data-month="' + m.month + '">' +
          '<td><input type="checkbox" class="form-check-input pay-single-row-chk"></td>' +
          '<td>' + (m.label_ar || m.label) + '</td>' +
          '<td class="text-end">' + (m.total != null ? m.total.toFixed(2) : '0.00') + '</td>' +
          '<td class="text-end">' + (m.paid != null ? m.paid.toFixed(2) : '0.00') + '</td>' +
          '<td class="text-end">' + (m.remaining != null ? m.remaining.toFixed(2) : '0.00') + '</td>' +
          '<td><a class="btn btn-sm btn-outline-primary" href="' + payUrl + '">' + (typeof _ !== 'undefined' ? _('سداد شهر واحد') : 'Pay one') + '</a></td></tr>';
      });
      tbody.innerHTML = h;
      if (batchBtn) batchBtn.classList.remove('d-none');
      if (hint) hint.textContent = (typeof _ !== 'undefined' ? _('حدد أشهراً ثم انقر «سداد المحدد».') : 'Select months then click Pay selected.');
    }).catch(function() {});
  });
  document.getElementById('pay-single-select-all') && document.getElementById('pay-single-select-all').addEventListener('change', function() {
    var c = this.checked;
    document.querySelectorAll('#pay-single-tbody .pay-single-row-chk').forEach(function(el) { el.checked = c; });
  });
  document.getElementById('pay-single-batch') && document.getElementById('pay-single-batch').addEventListener('click', function() {
    var empId = document.getElementById('pay-emp-single').value;
    if (!empId) return;
    var rows = [];
    document.querySelectorAll('#pay-single-tbody tr[data-year][data-month]').forEach(function(tr) {
      if (tr.querySelector('.pay-single-row-chk') && tr.querySelector('.pay-single-row-chk').checked)
        rows.push({ year: parseInt(tr.getAttribute('data-year'), 10), month: parseInt(tr.getAttribute('data-month'), 10) });
    });
    if (rows.length === 0) { alert(typeof _ !== 'undefined' ? _('حدد شهراً واحداً على الأقل.') : 'Select at least one month.'); return; }
    var dateEl = document.getElementById('pay-single-date');
    var methodEl = document.getElementById('pay-single-method');
    var btn = this;
    btn.disabled = true;
    fetch('/api/employee-pay-months', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken() },
      body: JSON.stringify({ employee_id: parseInt(empId, 10), months: rows, date: dateEl ? dateEl.value : '', payment_method: methodEl ? methodEl.value : 'cash' })
    }).then(function(r) { return r.json(); }).then(function(j) {
      if (j.ok) { alert((typeof _ !== 'undefined' ? _('تم السداد لـ') : 'Paid ') + (j.paid_months || 0) + (typeof _ !== 'undefined' ? _(' شهر.') : ' month(s).')); document.getElementById('pay-load-unpaid-months').click(); } else { alert(j.error || 'Error'); }
      btn.disabled = false;
    }).catch(function(e) { alert(e.message); btn.disabled = false; });
  });

  // Payment tab: collective unpaid runs (فلترة: شهر واحد أو عدة أشهر من - إلى)
  var payCollectiveRuns = [];
  document.getElementById('pay-load-unpaid-runs') && document.getElementById('pay-load-unpaid-runs').addEventListener('click', function() {
    var fromY = document.getElementById('pay-collective-from-year') && document.getElementById('pay-collective-from-year').value;
    var fromM = document.getElementById('pay-collective-from-month') && document.getElementById('pay-collective-from-month').value;
    var toY = document.getElementById('pay-collective-to-year') && document.getElementById('pay-collective-to-year').value;
    var toM = document.getElementById('pay-collective-to-month') && document.getElementById('pay-collective-to-month').value;
    var u = '/financials/api/unpaid_payroll_runs';
    if (fromY && fromM) u += '?from_year=' + encodeURIComponent(fromY) + '&from_month=' + encodeURIComponent(fromM);
    if (toY && toM) u += (u.indexOf('?') >= 0 ? '&' : '?') + 'to_year=' + encodeURIComponent(toY) + '&to_month=' + encodeURIComponent(toM);
    fetch(u).then(function(r) { return r.json(); }).then(function(j) {
      var tbody = document.getElementById('pay-collective-tbody');
      var batchBtn = document.getElementById('pay-collective-batch');
      var hint = document.getElementById('pay-collective-hint');
      if (!j.ok || !(j.runs && j.runs.length)) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">' + (typeof _ !== 'undefined' ? _('لا توجد مسيرات غير مدفوعة.') : 'No unpaid runs.') + '</td></tr>';
        payCollectiveRuns = [];
        if (batchBtn) batchBtn.classList.add('d-none');
        if (hint) hint.textContent = '';
        return;
      }
      payCollectiveRuns = j.runs;
      var h = '';
      j.runs.forEach(function(r, i) {
        h += '<tr data-idx="' + i + '">' +
          '<td><input type="checkbox" class="form-check-input pay-collective-row-chk"></td>' +
          '<td>' + (r.label_ar || r.label) + '</td>' +
          '<td class="text-end">' + (r.remaining != null ? r.remaining.toFixed(2) : '0.00') + '</td>' +
          '<td>' + (r.n_employees || 0) + '</td>' +
          '<td></td></tr>';
      });
      tbody.innerHTML = h;
      if (batchBtn) batchBtn.classList.remove('d-none');
      if (hint) hint.textContent = (typeof _ !== 'undefined' ? _('حدد مسيراً أو أكثر ثم انقر «سداد المحدد».') : 'Select run(s) then click Pay selected.');
    }).catch(function() {});
  });
  document.getElementById('pay-collective-select-all') && document.getElementById('pay-collective-select-all').addEventListener('change', function() {
    var c = this.checked;
    document.querySelectorAll('#pay-collective-tbody .pay-collective-row-chk').forEach(function(el) { el.checked = c; });
  });
  document.getElementById('pay-collective-batch') && document.getElementById('pay-collective-batch').addEventListener('click', function() {
    var dateEl = document.getElementById('pay-collective-date');
    var methodEl = document.getElementById('pay-collective-method');
    var dateVal = dateEl ? dateEl.value : '';
    var methodVal = methodEl ? methodEl.value : 'cash';
    var selected = [];
    document.querySelectorAll('#pay-collective-tbody tr[data-idx]').forEach(function(tr) {
      if (tr.querySelector('.pay-collective-row-chk') && tr.querySelector('.pay-collective-row-chk').checked) {
        var idx = parseInt(tr.getAttribute('data-idx'), 10);
        if (payCollectiveRuns[idx]) selected.push(payCollectiveRuns[idx]);
      }
    });
    if (selected.length === 0) { alert(typeof _ !== 'undefined' ? _('حدد مسيراً واحداً على الأقل.') : 'Select at least one run.'); return; }
    var btn = this;
    btn.disabled = true;
    var done = 0;
    var errs = [];
    function doNext(i) {
      if (i >= selected.length) {
        btn.disabled = false;
        if (done) { alert((typeof _ !== 'undefined' ? _('تم السداد لـ') : 'Paid ') + done + (typeof _ !== 'undefined' ? _(' مسير.') : ' run(s).')); document.getElementById('pay-load-unpaid-runs').click(); }
        if (errs.length) alert(errs.join('\n'));
        return;
      }
      var r = selected[i];
      fetch('/financials/api/quick-txn', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: 'pay_liability', liability_code: '2121', payroll_year: r.year, payroll_month: r.month, amount: r.remaining, date: dateVal, payment_method: methodVal })
      }).then(function(res) { return res.json(); }).then(function(j) {
        if (j && j.ok) done++; else if (j && j.error) errs.push(r.label + ': ' + j.error);
        doNext(i + 1);
      }).catch(function(e) { errs.push(r.label + ': ' + e.message); doNext(i + 1); });
    }
    doNext(0);
  });

  // Add employee
  var addForm = document.getElementById('emp-add-form');
  if (addForm) addForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const fd = new FormData(this);
    const msg = document.getElementById('emp-add-msg');
    msg.innerHTML = '';
    try {
      const r = await fetch('/api/employees', { method: 'POST', headers: { 'X-CSRFToken': csrfToken(), 'Accept': 'application/json' }, body: fd });
      const j = await r.json().catch(function() { return {}; });
      if (j.ok) {
        msg.innerHTML = '<div class="alert alert-success mb-0">' + (typeof _ !== 'undefined' ? _('Added.') : 'Added.') + '</div>';
        setTimeout(function() { location.reload(); }, 800);
      } else {
        msg.innerHTML = '<div class="alert alert-danger mb-0">' + (j.error || 'Error') + '</div>';
      }
    } catch (err) {
      msg.innerHTML = '<div class="alert alert-danger mb-0">' + err.message + '</div>';
    }
  });

  var payData = { year: null, month: null, accrual_posted: false, run_saved: false };

  function loadPayroll() {
    var y = document.getElementById('pay-year').value;
    var m = document.getElementById('pay-month').value;
    var dept = document.getElementById('pay-dept').value;
    var st = document.getElementById('pay-status').value;
    var u = '/api/payroll?year=' + y + '&month=' + m + (dept ? '&dept=' + encodeURIComponent(dept) : '') + (st && st !== 'all' ? '&status=' + st : '');
    fetch(u).then(function(r) { return r.json(); }).then(function(j) {
      if (!j.ok) return;
      var rows = j.payrolls || [];
      var tot = j.totals || {};
      payData.year = j.year || parseInt(y, 10);
      payData.month = j.month != null ? parseInt(j.month, 10) : parseInt(m, 10);
      payData.accrual_posted = !!j.accrual_posted;
      payData.run_saved = !!j.run_saved;
      var tbody = document.getElementById('pay-tbody');
      var tfoot = document.getElementById('pay-tfoot');
      var kpis = document.getElementById('pay-kpis');
      kpis.innerHTML = '<div class="kpi-card kpi-card--blue"><div class="kpi-value">' + rows.length + '</div><div class="kpi-label">' + (typeof _ !== 'undefined' ? _('Employees') : 'Employees') + '</div></div>' +
        '<div class="kpi-card kpi-card--red"><div class="kpi-value">' + (tot.remaining || 0).toFixed(2) + '</div><div class="kpi-label">' + (typeof _ !== 'undefined' ? _('Remaining') : 'Remaining') + '</div></div>' +
        '<div class="kpi-card kpi-card--green"><div class="kpi-value">' + (tot.paid || 0).toFixed(2) + '</div><div class="kpi-label">' + (typeof _ !== 'undefined' ? _('Paid') : 'Paid') + '</div></div>';
      var h = '';
      rows.forEach(function(r) {
        var stLabel = (r.status === 'paid' ? 'مدفوع' : (r.status === 'partial' ? 'جزئي' : 'مستحق'));
        var basic = (r.basic != null ? r.basic : 0);
        var extra = (r.extra != null ? r.extra : 0);
        var absence = (r.absence != null ? r.absence : 0);
        var incentive = (r.incentive != null ? r.incentive : 0);
        var allow = (r.allowances != null ? r.allowances : 0);
        var ded = (r.deductions != null ? r.deductions : 0);
        var totalRow = basic + extra - absence + incentive + allow - ded;
        h += '<tr data-employee-id="' + (r.employee_id || '') + '">' +
          '<td><input type="checkbox" class="form-check-input pay-row-select" data-employee-id="' + (r.employee_id || '') + '"></td>' +
          '<td>' + (r.employee_name || '') + '</td>' +
          '<td>' + (r.department || '—') + '</td>' +
          '<td class="text-end"><input type="number" step="0.01" min="0" class="form-control form-control-sm text-end pay-basic-inp" data-employee-id="' + (r.employee_id || '') + '" value="' + (typeof basic === 'number' ? basic.toFixed(2) : basic) + '" style="min-width:70px" readonly></td>' +
          '<td class="text-end"><input type="number" step="0.01" min="0" class="form-control form-control-sm text-end pay-extra-inp" data-employee-id="' + (r.employee_id || '') + '" value="' + (typeof extra === 'number' ? extra.toFixed(2) : extra) + '" style="min-width:70px"></td>' +
          '<td class="text-end"><input type="number" step="0.01" min="0" class="form-control form-control-sm text-end pay-absence-inp" data-employee-id="' + (r.employee_id || '') + '" value="' + (typeof absence === 'number' ? absence.toFixed(2) : absence) + '" style="min-width:70px"></td>' +
          '<td class="text-end"><input type="number" step="0.01" min="0" class="form-control form-control-sm text-end pay-incentive-inp" data-employee-id="' + (r.employee_id || '') + '" value="' + (typeof incentive === 'number' ? incentive.toFixed(2) : incentive) + '" style="min-width:70px"></td>' +
          '<td class="text-end"><input type="number" step="0.01" min="0" class="form-control form-control-sm text-end pay-allowances-inp" data-employee-id="' + (r.employee_id || '') + '" value="' + (typeof allow === 'number' ? allow.toFixed(2) : allow) + '" style="min-width:70px"></td>' +
          '<td class="text-end"><input type="number" step="0.01" min="0" class="form-control form-control-sm text-end pay-deductions-inp" data-employee-id="' + (r.employee_id || '') + '" value="' + (typeof ded === 'number' ? ded.toFixed(2) : ded) + '" style="min-width:70px"></td>' +
          '<td class="text-end pay-total-cell">' + (totalRow >= 0 ? totalRow.toFixed(2) : '0.00') + '</td>' +
          '<td class="text-end">' + (r.paid != null ? r.paid.toFixed(2) : '0.00') + '</td>' +
          '<td class="text-end">' + (r.remaining != null ? r.remaining.toFixed(2) : '0.00') + '</td>' +
          '<td><span class="badge bg-' + (r.status === 'paid' ? 'success' : (r.status === 'partial' ? 'warning' : 'danger')) + '">' + stLabel + '</span></td></tr>';
      });
      tbody.innerHTML = h || '<tr><td colspan="13" class="text-center text-muted py-4">' + (typeof _ !== 'undefined' ? _('لا توجد مسيرات لهذا الشهر. البيانات تعتمد على المسيرات المنشأة فقط — أنشئ مسيراً أو اختر شهراً آخر.') : 'No payroll runs for this month. Data is from created runs only.') + '</td></tr>';
      tfoot.innerHTML = '<tr><th colspan="3">' + (typeof _ !== 'undefined' ? _('Totals') : 'Totals') + '</th><th></th><th></th><th></th><th></th><th></th><th></th><th class="text-end">' + (tot.total || 0).toFixed(2) + '</th><th class="text-end">' + (tot.paid || 0).toFixed(2) + '</th><th class="text-end">' + (tot.remaining || 0).toFixed(2) + '</th><th></th></tr>';
      document.querySelectorAll('#pay-tbody tr[data-employee-id]').forEach(function(tr) {
        ['pay-extra-inp','pay-absence-inp','pay-incentive-inp','pay-allowances-inp','pay-deductions-inp'].forEach(function(cls) {
          var inp = tr.querySelector('.' + cls);
          if (inp) inp.addEventListener('input', function() {
            var row = tr;
            var b = parseFloat(row.querySelector('.pay-basic-inp').value || 0) || 0;
            var ex = parseFloat(row.querySelector('.pay-extra-inp').value || 0) || 0;
            var ab = parseFloat(row.querySelector('.pay-absence-inp').value || 0) || 0;
            var inc = parseFloat(row.querySelector('.pay-incentive-inp').value || 0) || 0;
            var al = parseFloat(row.querySelector('.pay-allowances-inp').value || 0) || 0;
            var de = parseFloat(row.querySelector('.pay-deductions-inp').value || 0) || 0;
            var tot = b + ex - ab + inc + al - de;
            var cell = row.querySelector('.pay-total-cell');
            if (cell) cell.textContent = (tot >= 0 ? tot.toFixed(2) : '0.00');
          });
        });
      });

      var postBtn = document.getElementById('pay-post-run');
      var statusEl = document.getElementById('pay-run-status');
      if (postBtn) {
        if (payData.run_saved && !payData.accrual_posted) { postBtn.classList.remove('d-none'); postBtn.disabled = false; } else { postBtn.classList.add('d-none'); }
      }
      if (statusEl) {
        if (payData.accrual_posted) statusEl.textContent = 'مرحّل'; else if (payData.run_saved) statusEl.textContent = 'معتمد — جاهز للترحيل'; else statusEl.textContent = '';
      }

      var allChk = document.getElementById('pay-select-all');
      if (allChk) { allChk.checked = false; allChk.indeterminate = false; }
    }).catch(function() {});
  }

  document.getElementById('pay-select-all') && document.getElementById('pay-select-all').addEventListener('change', function() {
    var c = this.checked;
    document.querySelectorAll('#pay-tbody .pay-row-select').forEach(function(el) { el.checked = c; });
  });

  document.getElementById('pay-apply') && document.getElementById('pay-apply').addEventListener('click', loadPayroll);

  document.getElementById('pay-ensure-records') && document.getElementById('pay-ensure-records').addEventListener('click', function() {
    var btn = this;
    if (!confirm(typeof _ !== 'undefined' ? _('إنشاء مسيرات رواتب ناقصة لجميع الموظفين من تاريخ تعيين كل موظف حتى الشهر الحالي؟') : 'Create missing payroll runs for all employees from each hire date to current month?')) return;
    btn.disabled = true;
    var fd = new FormData();
    fd.append('csrf_token', csrfToken());
    fetch('/api/payroll/ensure-records', { method: 'POST', headers: { 'X-CSRFToken': csrfToken() }, body: fd }).then(function(r) { return r.json(); }).then(function(j) {
      if (j.ok) {
        var msg = (typeof _ !== 'undefined' ? _('تم إنشاء') : 'Created ') + (j.created || 0) + (typeof _ !== 'undefined' ? _(' مسير رواتب.') : ' payroll run(s).');
        if (j.accruals_created) msg += ' ' + (typeof _ !== 'undefined' ? _('وقيد استحقاق لكل شهر:') : ' Accrual JEs: ') + (j.accruals_created || 0);
        alert(msg);
        loadPayroll();
      } else { alert(j.error || 'Error'); }
      btn.disabled = false;
    }).catch(function(e) { alert(e.message); btn.disabled = false; });
  });

  document.getElementById('pay-open-create-run') && document.getElementById('pay-open-create-run').addEventListener('click', function() {
    var my = document.getElementById('pay-year');
    var mm = document.getElementById('pay-month');
    var modalY = document.getElementById('modal-pay-year');
    var modalM = document.getElementById('modal-pay-month');
    if (my && modalY) modalY.value = my.value;
    if (mm && modalM) modalM.value = mm.value;
    var modal = new bootstrap.Modal(document.getElementById('modal-create-payroll'));
    modal.show();
    loadModalPayroll();
  });

  function loadModalPayroll() {
    var y = document.getElementById('modal-pay-year') && document.getElementById('modal-pay-year').value;
    var m = document.getElementById('modal-pay-month') && document.getElementById('modal-pay-month').value;
    var dept = document.getElementById('modal-pay-dept') && document.getElementById('modal-pay-dept').value;
    var u = '/api/payroll?year=' + (y || '') + '&month=' + (m || '');
    if (dept) u += '&dept=' + encodeURIComponent(dept);
    fetch(u).then(function(r) { return r.json(); }).then(function(j) {
      if (j.ok && (j.payrolls || []).length === 0) {
        u = '/api/payroll?year=' + (y || '') + '&month=' + (m || '') + '&for_new_run=1';
        if (dept) u += '&dept=' + encodeURIComponent(dept);
        fetch(u).then(function(r2) { return r2.json(); }).then(function(j2) {
          if (j2.ok) fillModalTable(j2.payrolls || []);
        }).catch(function() {});
        return;
      }
      if (j.ok) fillModalTable(j.payrolls || []);
    }).catch(function() {});
  }
  function fillModalTable(rows) {
      var tbody = document.getElementById('modal-pay-tbody');
      if (!tbody) return;
      var h = '';
      rows.forEach(function(r) {
        var basic = (r.basic != null ? r.basic : 0);
        var extra = (r.extra != null ? r.extra : 0);
        var absence = (r.absence != null ? r.absence : 0);
        var incentive = (r.incentive != null ? r.incentive : 0);
        var allow = (r.allowances != null ? r.allowances : 0);
        var ded = (r.deductions != null ? r.deductions : 0);
        var totalRow = basic + extra - absence + incentive + allow - ded;
        h += '<tr data-employee-id="' + (r.employee_id || '') + '">' +
          '<td><input type="checkbox" class="form-check-input modal-pay-row-select" data-employee-id="' + (r.employee_id || '') + '"></td>' +
          '<td>' + (r.employee_name || '') + '</td>' +
          '<td>' + (r.department || '—') + '</td>' +
          '<td class="text-end"><input type="number" step="0.01" min="0" class="form-control form-control-sm text-end modal-pay-basic" value="' + (typeof basic === "number" ? basic.toFixed(2) : basic) + '" style="min-width:70px"></td>' +
          '<td class="text-end"><input type="number" step="0.01" min="0" class="form-control form-control-sm text-end modal-pay-extra" value="' + (typeof extra === "number" ? extra.toFixed(2) : extra) + '" style="min-width:70px"></td>' +
          '<td class="text-end"><input type="number" step="0.01" min="0" class="form-control form-control-sm text-end modal-pay-absence" value="' + (typeof absence === "number" ? absence.toFixed(2) : absence) + '" style="min-width:70px"></td>' +
          '<td class="text-end"><input type="number" step="0.01" min="0" class="form-control form-control-sm text-end modal-pay-incentive" value="' + (typeof incentive === "number" ? incentive.toFixed(2) : incentive) + '" style="min-width:70px"></td>' +
          '<td class="text-end"><input type="number" step="0.01" min="0" class="form-control form-control-sm text-end modal-pay-allowances" value="' + (typeof allow === "number" ? allow.toFixed(2) : allow) + '" style="min-width:70px"></td>' +
          '<td class="text-end"><input type="number" step="0.01" min="0" class="form-control form-control-sm text-end modal-pay-deductions" value="' + (typeof ded === "number" ? ded.toFixed(2) : ded) + '" style="min-width:70px"></td>' +
          '<td class="text-end modal-pay-total-cell">' + (totalRow >= 0 ? totalRow.toFixed(2) : "0.00") + '</td></tr>';
      });
      tbody.innerHTML = h || '<tr><td colspan="10" class="text-center text-muted">' + (typeof _ !== "undefined" ? _("لا يوجد موظفون") : "No employees") + '</td></tr>';
      document.querySelectorAll('#modal-pay-tbody tr[data-employee-id]').forEach(function(tr) {
        ['modal-pay-basic','modal-pay-extra','modal-pay-absence','modal-pay-incentive','modal-pay-allowances','modal-pay-deductions'].forEach(function(cls) {
          var inp = tr.querySelector('.' + cls);
          if (inp) inp.addEventListener('input', function() {
            var b = parseFloat(tr.querySelector('.modal-pay-basic').value || 0) || 0;
            var ex = parseFloat(tr.querySelector('.modal-pay-extra').value || 0) || 0;
            var ab = parseFloat(tr.querySelector('.modal-pay-absence').value || 0) || 0;
            var inc = parseFloat(tr.querySelector('.modal-pay-incentive').value || 0) || 0;
            var al = parseFloat(tr.querySelector('.modal-pay-allowances').value || 0) || 0;
            var de = parseFloat(tr.querySelector('.modal-pay-deductions').value || 0) || 0;
            var tot = b + ex - ab + inc + al - de;
            var cell = tr.querySelector('.modal-pay-total-cell');
            if (cell) cell.textContent = (tot >= 0 ? tot.toFixed(2) : "0.00");
          });
        });
      });
  }

  document.getElementById('modal-pay-load') && document.getElementById('modal-pay-load').addEventListener('click', loadModalPayroll);
  document.getElementById('modal-pay-select-all') && document.getElementById('modal-pay-select-all').addEventListener('change', function() {
    var c = this.checked;
    document.querySelectorAll('#modal-pay-tbody .modal-pay-row-select').forEach(function(el) { el.checked = c; });
  });
  document.getElementById('modal-pay-save') && document.getElementById('modal-pay-save').addEventListener('click', function() {
    var y = document.getElementById('modal-pay-year') && document.getElementById('modal-pay-year').value;
    var m = document.getElementById('modal-pay-month') && document.getElementById('modal-pay-month').value;
    var mm = (String(m).length === 1 ? "0" + m : m);
    var rows = [];
    document.querySelectorAll('#modal-pay-tbody tr[data-employee-id]').forEach(function(tr) {
      var chk = tr.querySelector('.modal-pay-row-select');
      if (!chk || !chk.checked) return;
      var eid = tr.getAttribute('data-employee-id');
      var basic = parseFloat(String((tr.querySelector('.modal-pay-basic') || {}).value || "0").replace(/,/g, ".")) || 0;
      var extra = parseFloat(String((tr.querySelector('.modal-pay-extra') || {}).value || "0").replace(/,/g, ".")) || 0;
      var absence = parseFloat(String((tr.querySelector('.modal-pay-absence') || {}).value || "0").replace(/,/g, ".")) || 0;
      var incentive = parseFloat(String((tr.querySelector('.modal-pay-incentive') || {}).value || "0").replace(/,/g, ".")) || 0;
      var allowances = parseFloat(String((tr.querySelector('.modal-pay-allowances') || {}).value || "0").replace(/,/g, ".")) || 0;
      var deductions = parseFloat(String((tr.querySelector('.modal-pay-deductions') || {}).value || "0").replace(/,/g, ".")) || 0;
      var total = basic + extra - absence + incentive + allowances - deductions;
      rows.push({ employee_id: parseInt(eid, 10), selected: true, basic: basic, extra: extra, absence: absence, incentive: incentive, allowances: allowances, deductions: deductions, salary: total });
    });
    if (rows.length === 0) { alert(typeof _ !== "undefined" ? _("حدد موظفاً واحداً على الأقل.") : "Select at least one employee."); return; }
    var fd = new FormData();
    fd.append("month", y + "-" + mm);
    fd.append("rows", JSON.stringify(rows));
    fd.append("csrf_token", csrfToken());
    var btn = this;
    btn.disabled = true;
    fetch("/api/payroll-run", { method: "POST", headers: { "X-CSRFToken": csrfToken() }, body: fd }).then(function(r) { return r.json(); }).then(function(j) {
      if (j.ok) {
        bootstrap.Modal.getInstance(document.getElementById('modal-create-payroll')).hide();
        alert(typeof _ !== "undefined" ? _("تم حفظ المسير. المسير جاهز للترحيل.") : "Saved. Ready to post.");
        document.getElementById('pay-year').value = y;
        document.getElementById('pay-month').value = m;
        loadPayroll();
      } else { alert(j.error === "select_at_least_one" ? (typeof _ !== "undefined" ? _("حدد موظفاً واحداً على الأقل.") : "Select at least one.") : (j.error || "Error")); }
      btn.disabled = false;
    }).catch(function(e) { alert(e.message); btn.disabled = false; });
  });

  document.getElementById('pay-post-run') && document.getElementById('pay-post-run').addEventListener('click', function() {
    var btn = this;
    var y = document.getElementById('pay-year').value;
    var m = document.getElementById('pay-month').value;
    if (!y || !m) { alert(typeof _ !== 'undefined' ? _('اختر السنة والشهر.') : 'Select year and month.'); return; }
    btn.disabled = true;
    var fd = new FormData();
    fd.append('year', y);
    fd.append('month', m);
    fd.append('csrf_token', csrfToken());
    fetch('/api/payroll-post', { method: 'POST', headers: { 'X-CSRFToken': csrfToken() }, body: fd }).then(function(r) { return r.json(); }).then(function(j) {
      if (j.ok) { alert(typeof _ !== 'undefined' ? _('تم ترحيل المسير. قيد الاستحقاق أنشئ.') : 'Posted. Accrual JE created.'); loadPayroll(); } else { alert(j.error || 'Error'); btn.disabled = false; }
    }).catch(function(e) { alert(e.message); btn.disabled = false; });
  });

  // Reports: print link — فتح كشف الرواتب في نافذة جديدة مع رسالة عند الفشل
  function reportPrintHref() {
    const yf = (document.getElementById('rep-y-from') || {}).value || '';
    const mf = (document.getElementById('rep-m-from') || {}).value || '';
    const yt = (document.getElementById('rep-y-to') || {}).value || '';
    const mt = (document.getElementById('rep-m-to') || {}).value || '';
    const sel = document.getElementById('rep-employees');
    let ids = [];
    if (sel && sel.selectedOptions) {
      for (var i = 0; i < sel.selectedOptions.length; i++) ids.push(sel.selectedOptions[i].value);
    }
    let u = "{{ url_for('reports.print_payroll') }}?year_from=" + encodeURIComponent(yf) + "&month_from=" + encodeURIComponent(mf) + "&year_to=" + encodeURIComponent(yt) + "&month_to=" + encodeURIComponent(mt);
    if (ids.length > 0) u += '&employee_ids=' + encodeURIComponent(ids.join(','));
    return u;
  }
  var repPrint = document.getElementById('rep-print');
  if (repPrint) {
    repPrint.href = reportPrintHref();
    repPrint.addEventListener('click', function(e) {
      this.href = reportPrintHref();
      // لا نمنع السلوك الافتراضي — فتح الرابط في نافذة جديدة (target="_blank") عادة لا يُحظر
    });
  }
  ['rep-y-from','rep-m-from','rep-y-to','rep-m-to'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.addEventListener('change', function() { var p = document.getElementById('rep-print'); if (p) p.href = reportPrintHref(); });
  });
  document.getElementById('rep-employees') && document.getElementById('rep-employees').addEventListener('change', function() { var p = document.getElementById('rep-print'); if (p) p.href = reportPrintHref(); });
  document.getElementById('rep-emp-all') && document.getElementById('rep-emp-all').addEventListener('click', function() {
    var sel = document.getElementById('rep-employees');
    if (sel) { for (var i = 0; i < sel.options.length; i++) sel.options[i].selected = true; var p = document.getElementById('rep-print'); if (p) p.href = reportPrintHref(); }
  });
  document.getElementById('rep-emp-clear') && document.getElementById('rep-emp-clear').addEventListener('click', function() {
    var sel = document.getElementById('rep-employees');
    if (sel) { for (var i = 0; i < sel.options.length; i++) sel.options[i].selected = false; var p = document.getElementById('rep-print'); if (p) p.href = reportPrintHref(); }
  });

  // Advances
  function loadAdvances() {
    const start = document.getElementById('adv-start').value;
    const end = document.getElementById('adv-end').value;
    const emp = document.getElementById('adv-filter-emp').value;
    let u = '/api/advances/list?start=' + (start || '') + '&end=' + (end || '');
    if (emp) u += '&employee_id=' + emp;
    fetch(u).then(function(r) { return r.json(); }).then(function(j) {
      if (!j.ok) return;
      const rows = j.rows || [];
      const tbody = document.getElementById('adv-tbody');
      let h = '';
      rows.forEach(function(r) {
        const empName = (r.employee_name || '').replace(/"/g, '&quot;');
        const remaining = parseFloat(r.remaining || 0);
        h += '<tr><td>' + (r.employee_name || '') + '</td><td>' + (r.department || '') + '</td><td class="text-end">' + (r.granted || 0).toFixed(2) + '</td><td class="text-end">' + (r.paid || 0).toFixed(2) + '</td><td class="text-end">' + (r.remaining || 0).toFixed(2) + '</td><td><button type="button" class="btn btn-sm btn-outline-primary repay-btn" data-emp-id="' + (r.employee_id || '') + '" data-emp-name="' + empName + '" data-remaining="' + remaining + '">' + (typeof _ !== 'undefined' ? _('Repay') : 'Repay') + '</button></td></tr>';
      });
      tbody.innerHTML = h || '<tr><td colspan="6" class="text-center text-muted">' + (typeof _ !== 'undefined' ? _('No data') : 'No data') + '</td></tr>';
      tbody.querySelectorAll('.repay-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          const empId = this.getAttribute('data-emp-id');
          const empName = this.getAttribute('data-emp-name') || '';
          const remaining = parseFloat(this.getAttribute('data-remaining') || 0);
          document.getElementById('repay-emp-id').value = empId;
          document.getElementById('repay-emp-info').textContent = (typeof _ !== 'undefined' ? _('Employee') : 'Employee') + ': ' + empName;
          document.getElementById('repay-remaining-hint').textContent = (typeof _ !== 'undefined' ? _('Remaining') : 'Remaining') + ': ' + remaining.toFixed(2) + ' ﷼';
          document.getElementById('repay-date').value = new Date().toISOString().slice(0, 10);
          document.getElementById('repay-amount').value = remaining > 0 ? remaining.toFixed(2) : '';
          document.getElementById('repay-amount').setAttribute('max', remaining);
          const modal = new bootstrap.Modal(document.getElementById('repay-modal'));
          modal.show();
        });
      });
    }).catch(function() {});
  }

  document.getElementById('repay-submit') && document.getElementById('repay-submit').addEventListener('click', function() {
    const empId = document.getElementById('repay-emp-id').value;
    const amt = parseFloat(document.getElementById('repay-amount').value);
    const dateVal = document.getElementById('repay-date').value;
    const method = document.getElementById('repay-method').value || 'cash';
    if (!empId || !amt || amt <= 0 || !dateVal) {
      alert(typeof _ !== 'undefined' ? _('Enter date and amount') : 'Enter date and amount.');
      return;
    }
    const fd = new FormData();
    fd.append('employee_id', empId);
    fd.append('amount', amt);
    fd.append('date', dateVal);
    fd.append('method', method);
    fd.append('csrf_token', csrfToken());
    this.disabled = true;
    fetch('/api/advances/pay', { method: 'POST', headers: { 'X-CSRFToken': csrfToken() }, body: fd }).then(function(r) { return r.json(); }).then(function(j) {
      if (j.ok) {
        bootstrap.Modal.getInstance(document.getElementById('repay-modal')).hide();
        loadAdvances();
      } else { alert(j.error || 'Error'); }
    }).finally(function() { document.getElementById('repay-submit').disabled = false; });
  });

  var advLoad = document.getElementById('adv-load');
  if (advLoad) advLoad.addEventListener('click', loadAdvances);
  var advGrant = document.getElementById('adv-grant');
  if (advGrant) advGrant.addEventListener('click', async function() {
    const emp = document.getElementById('adv-emp').value;
    const amt = document.getElementById('adv-amount').value;
    const date = document.getElementById('adv-date').value;
    const method = document.getElementById('adv-method').value;
    const msg = document.getElementById('adv-grant-msg');
    if (!emp || !amt || parseFloat(amt) <= 0) { msg.innerHTML = '<div class="alert alert-warning mb-0">' + (typeof _ !== 'undefined' ? _('Select employee and amount.') : 'Select employee and amount.') + '</div>'; return; }
    const fd = new FormData();
    fd.append('employee_id', emp);
    fd.append('amount', amt);
    fd.append('date', date || new Date().toISOString().slice(0, 10));
    fd.append('method', method || 'cash');
    fd.append('csrf_token', csrfToken());
    try {
      var r = await fetch('/api/advances', { method: 'POST', headers: { 'X-CSRFToken': csrfToken() }, body: fd });
      const j = await r.json().catch(function() { return {}; });
      if (j.ok) { msg.innerHTML = '<div class="alert alert-success mb-0">' + (typeof _ !== 'undefined' ? _('Granted.') : 'Granted.') + '</div>'; loadAdvances(); document.getElementById('adv-amount').value = ''; }
      else { msg.innerHTML = '<div class="alert alert-danger mb-0">' + (j.error || 'Error') + '</div>'; }
    } catch (e) { msg.innerHTML = '<div class="alert alert-danger mb-0">' + e.message + '</div>'; }
  });

  // Unpaid tab: يعرض فقط المستحقات التي لها قيد استحقاق (مسير مرحّل)
  function loadUnpaid() {
    const y = document.getElementById('unp-year').value;
    const m = document.getElementById('unp-month').value;
    const dept = document.getElementById('unp-dept').value;
    const u = '/api/payroll?year=' + y + '&month=' + m + (dept ? '&dept=' + encodeURIComponent(dept) : '') + '&status=all';
    fetch(u).then(function(r) { return r.json(); }).then(function(j) {
      if (!j.ok) return;
      const accrualPosted = !!j.accrual_posted;
      var rows = (j.payrolls || []).filter(function(r) { var s = (r.status || '').toLowerCase(); return (s === 'due' || s === 'partial') && (r.remaining || 0) > 0 && (r.has_salary_record !== false); });
      const tbody = document.getElementById('unp-tbody');
      const kpis = document.getElementById('unp-kpis');
      if (!accrualPosted && rows.length > 0) {
        kpis.innerHTML = '<div class="alert alert-warning mb-0 w-100"><i class="fa-solid fa-exclamation-triangle me-2"></i>' + (typeof _ !== 'undefined' ? _('يجب ترحيل المسير أولاً: لا توجد قيود تثبت الاستحقاق.') : 'Post payroll first: No journal entry exists.') + ' <button type="button" class="btn btn-sm btn-warning ms-2" id="unp-go-post">' + (typeof _ !== 'undefined' ? _('اذهب لترحيل المسير') : 'Go to Post payroll') + '</button></div>';
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">' + (typeof _ !== 'undefined' ? _('يُعرض فقط المسيرات المرحلة والمرحّلة (لها قيد استحقاق JE-PR).') : 'Only posted payroll runs (with accrual journal JE-PR) are shown here.') + '</td></tr>';
        document.getElementById('unp-go-post') && document.getElementById('unp-go-post').addEventListener('click', function() {
          document.querySelector('.ops-tab[data-panel="panel-payroll"]').click();
          document.getElementById('pay-year').value = y;
          document.getElementById('pay-month').value = m;
          if (document.getElementById('pay-apply')) document.getElementById('pay-apply').click();
        });
        return;
      }
      const totRem = rows.reduce(function(a, r) { return a + (r.remaining || 0); }, 0);
      kpis.innerHTML = '<div class="kpi-card kpi-card--blue"><div class="kpi-value">' + rows.length + '</div><div class="kpi-label">' + (typeof _ !== 'undefined' ? _('Unpaid count') : 'Unpaid') + '</div></div><div class="kpi-card kpi-card--red"><div class="kpi-value">' + totRem.toFixed(2) + '</div><div class="kpi-label">' + (typeof _ !== 'undefined' ? _('Total remaining') : 'Remaining') + '</div></div>' + (accrualPosted ? '<span class="badge bg-success align-self-center ms-2"><i class="fa-solid fa-check me-1"></i>' + (typeof _ !== 'undefined' ? _('مسير مرحّل – قيد JE-PR موجود') : 'Posted – JE-PR exists') + '</span>' : '');
      let h = '';
      rows.forEach(function(r) {
        const stLabel = (r.status === 'partial' ? 'جزئي' : 'مستحق');
        h += '<tr><td>' + (r.employee_name || '') + '</td><td class="text-end">' + (r.total || 0).toFixed(2) + '</td><td class="text-end">' + (r.paid || 0).toFixed(2) + '</td><td class="text-end">' + (r.remaining || 0).toFixed(2) + '</td><td><span class="badge bg-' + (r.status === 'partial' ? 'warning' : 'danger') + '">' + stLabel + '</span></td></tr>';
      });
      tbody.innerHTML = h || '<tr><td colspan="5" class="text-center text-muted">' + (typeof _ !== 'undefined' ? _('No unpaid dues') : 'No unpaid.') + '</td></tr>';
    }).catch(function() {});
  }

  var unpApply = document.getElementById('unp-apply');
  if (unpApply) unpApply.addEventListener('click', loadUnpaid);

  if (document.getElementById('panel-payroll') && !document.getElementById('panel-payroll').classList.contains('d-none')) loadPayroll();
  if (document.getElementById('panel-advances') && !document.getElementById('panel-advances').classList.contains('d-none')) loadAdvances();
  if (document.getElementById('panel-unpaid') && !document.getElementById('panel-unpaid').classList.contains('d-none')) loadUnpaid();
})();
</script>
{% endblock %}
