{% extends 'base.html' %}{% set back_url = url_for('main.dashboard') %}
{% block title %}{{ _('Employees / الموظفون') }}{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">👤 {{ _('Employees / الموظفون') }}</h3>
    <div class="d-flex flex-wrap gap-2">
      <a href="#" class="btn btn-success">💵 {{ _('Monthly Salaries / رواتب شهرية') }}</a>
      <a href="#" class="btn btn-outline-success">🧾 {{ _('Payroll Statements / كشوفات الرواتب') }}</a>
      <a href="#" class="btn btn-outline-secondary">📝 {{ _('Salaries Form / نموذج الرواتب') }}</a>
      <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary">🏠 {{ _('Dashboard / لوحة التحكم') }}</a>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <form method="POST">
        {{ form.hidden_tag() }}
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

        <div class="row g-3">
          <div class="col-md-3">{{ form.employee_code.label(class_='form-label') }}{{ form.employee_code(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.full_name.label(class_='form-label') }}{{ form.full_name(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.national_id.label(class_='form-label') }}{{ form.national_id(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.status.label(class_='form-label') }}{{ form.status(class_='form-select') }}</div>
          <div class="col-md-3">{{ form.department.label(class_='form-label') }}{{ form.department(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.position.label(class_='form-label') }}{{ form.position(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.phone.label(class_='form-label') }}{{ form.phone(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.email.label(class_='form-label') }}{{ form.email(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.hire_date.label(class_='form-label') }}{{ form.hire_date(class_='form-control') }}</div>
        </div>
        <hr/>
        <div class="row g-3">
          <div class="col-md-3">{{ form.base_salary.label(class_='form-label') }}{{ form.base_salary(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.allowances.label(class_='form-label') }}{{ form.allowances(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.deductions.label(class_='form-label') }}{{ form.deductions(class_='form-control') }}</div>
        </div>
        <div class="text-end mt-3">
          {{ form.submit(class_='btn btn-success') }}
        </div>
      </form>
    </div>
  </div>

  {% if employees %}
  <div class="card">
    <div class="card-body">
      {% set emps = employees or [] %}
      {% set total = emps|length %}
      {% set active_count = emps|selectattr('status','equalto','active')|list|length %}
      {% set inactive_count = total - active_count %}
      <div class="row g-3 mb-3">
        <div class="col-6 col-md-4"><div class="card shadow-sm h-100"><div class="card-body">
          <div class="text-muted small">{{ _('Total Employees / إجمالي الموظفين') }}</div>
          <div class="fs-5 fw-bold">{{ total }}</div>
        </div></div></div>
        <div class="col-6 col-md-4"><div class="card shadow-sm h-100"><div class="card-body">
          <div class="text-muted small">{{ _('Active / نشط') }}</div>
          <div class="fs-5 fw-bold text-success">{{ active_count }}</div>
        </div></div></div>
        <div class="col-6 col-md-4"><div class="card shadow-sm h-100"><div class="card-body">
          <div class="text-muted small">{{ _('Inactive / غير نشط') }}</div>
          <div class="fs-5 fw-bold text-secondary">{{ inactive_count }}</div>
        </div></div></div>
      </div>
      <div class="row g-2 mb-2">
        <div class="col-md-4 ms-auto">
          <input type="text" class="form-control" id="empSearch" placeholder="{{ _('Search employees... / بحث في الموظفين...') }}">
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-striped table-hover align-middle table-sm">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>{{ _('Code / الرمز') }}</th>
              <th>{{ _('Name / الاسم') }}</th>
              <th>{{ _('National ID / الهوية') }}</th>
              <th>{{ _('Department / القسم') }}</th>
              <th>{{ _('Position / الوظيفة') }}</th>
              <th>{{ _('Phone / الهاتف') }}</th>
              <th>{{ _('Email / البريد') }}</th>
              <th>{{ _('Hire Date / التعيين') }}</th>
              <th>{{ _('Status / الحالة') }}</th>
              <th>{{ _('Actions / الإجراءات') }}</th>
            </tr>
          </thead>
          <tbody id="empTableBody">
            {% for e in employees %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ e.employee_code }}</td>
              <td>{{ e.full_name }}</td>
              <td>{{ e.national_id }}</td>
              <td>{{ e.department or '-' }}</td>
              <td>{{ e.position or '-' }}</td>
              <td>{% if e.phone %}<a href="tel:{{ e.phone }}">{{ e.phone }}</a>{% else %}-{% endif %}</td>
              <td>{% if e.email %}<a href="mailto:{{ e.email }}">{{ e.email }}</a>{% else %}-{% endif %}</td>
              <td>{{ e.hire_date or '-' }}</td>
              <td>{% if e.status=='active' %}<span class="badge bg-success">{{ _('Active / نشط') }}</span>{% else %}<span class="badge bg-secondary">{{ _('Inactive / غير نشط') }}</span>{% endif %}</td>
              <td>
                <div class="d-flex flex-wrap gap-1">
                  <a href="#" class="btn btn-sm btn-outline-primary">{{ _('Edit / تعديل') }}</a>
                  <a href="#" class="btn btn-sm btn-outline-success">{{ _('Defaults / الافتراضات') }}</a>
                  <form method="POST" action="#" onsubmit="return handleDeleteEmployee(event, '{{ e.full_name }}')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-sm btn-outline-danger">{{ _('Delete / حذف') }}</button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<script>
window.handleDeleteEmployee = async function(event, name){
  event.preventDefault();
  const confirmed = await showConfirm("{{ _('Are you sure to delete / هل أنت متأكد من الحذف؟') }}\n" + name);
  if (confirmed) {
    event.target.submit();
  }
}

document.getElementById('empSearch')?.addEventListener('input', function(){
  const q = this.value.toLowerCase();
  document.querySelectorAll('#empTableBody tr').forEach(tr => {
    const txt = tr.textContent.toLowerCase();
    tr.style.display = txt.includes(q) ? '' : 'none';
  });
});
</script>

{% endblock %}
