{% extends 'base.html' %}{% set back_url = url_for('main.dashboard') %}
{% block title %}{{ _('Employees / Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†') }}{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">ğŸ‘¤ {{ _('Employees / Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†') }}</h3>
    <div class="d-flex flex-wrap gap-2">
      <a href="{{ url_for('main.salaries_pay') }}" class="btn btn-success">ğŸ’µ {{ _('Pay Salaries / Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø±ÙˆØ§ØªØ¨') }}</a>
      <a href="{{ url_for('main.salaries_statements') }}" class="btn btn-outline-success">ğŸ§¾ {{ _('Payroll Statements / ÙƒØ´ÙˆÙØ§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨') }}</a>
      <button type="button" class="btn btn-outline-secondary" onclick="clearEmployeeForm(); document.getElementById('employees-form').scrollIntoView({ behavior: 'smooth' });">ğŸ“ {{ _('Add New / Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯') }}</button>
      <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary">ğŸ  {{ _('Dashboard / Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…') }}</a>
    </div>
  </div>

  <div class="card mb-4" id="employees-form">
    <div class="card-body">
      <h5 class="mb-3" id="form-title">ğŸ“ {{ _('Add New Employee / Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯') }}</h5>
      <form method="POST">
        {{ form.hidden_tag() }}
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

        <div class="row g-3">
          <div class="col-md-3">{{ form.employee_code.label(class_='form-label') }}{{ form.employee_code(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.full_name.label(class_='form-label') }}{{ form.full_name(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.national_id.label(class_='form-label') }}{{ form.national_id(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.status.label(class_='form-label') }}{{ form.status(class_='form-select') }}</div>
          <div class="col-md-3 d-flex align-items-end">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="emp_active" name="active" checked>
              <label class="form-check-label" for="emp_active">{{ _('Active / Ù†Ø´Ø·') }}</label>
            </div>
          </div>
          <div class="col-md-3">{{ form.department.label(class_='form-label') }}
            <div class="input-group">
              {{ form.department(class_='form-control', placeholder=_('e.g. Kitchen / Admin / Cashier')) }}
              <select class="form-select" id="deptQuickSelect" style="max-width: 9rem">
                <option value="">{{ _('Choose') }}</option>
                <option>Kitchen</option>
                <option>Admin</option>
                <option>Cashier</option>
                <option>Store</option>
                <option>Delivery</option>
              </select>
            </div>
          </div>
          <div class="col-md-3">{{ form.position.label(class_='form-label') }}{{ form.position(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.phone.label(class_='form-label') }}{{ form.phone(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.email.label(class_='form-label') }}{{ form.email(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.hire_date.label(class_='form-label') }}{{ form.hire_date(class_='form-control') }}</div>

        </div>
        <hr/>
        <div class="row g-3">
          <div class="col-md-3">{{ form.base_salary.label(class_='form-label') }}{{ form.base_salary(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.allowances.label(class_='form-label') }}{{ form.allowances(class_='form-control') }}</div>
          <div class="col-md-3">{{ form.deductions.label(class_='form-label') }}{{ form.deductions(class_='form-control') }}</div>
        </div>
        <div class="text-end mt-3">
          <button type="button" class="btn btn-outline-secondary me-2" onclick="clearEmployeeForm()">{{ _('Clear / Ù…Ø³Ø­') }}</button>
          {{ form.submit(class_='btn btn-success') }}
        </div>
      </form>
    </div>
  </div>
  <div class="card mb-4" id="pay-salaries-section">
    <div class="card-body">
      <h5 class="mb-3">ğŸ’µ {{ _('Pay Salaries / Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø±ÙˆØ§ØªØ¨') }}</h5>
      <form id="paySalaryForm" onsubmit="return handleCreateSalary(event)">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label">{{ _('Month / Ø§Ù„Ø´Ù‡Ø±') }}</label>
            <input type="month" class="form-control" id="pay_month" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">{{ _('Employee / Ø§Ù„Ù…ÙˆØ¸Ù') }}</label>
            <select class="form-select" id="pay_employee" required>
              <option value="">-- {{ _('Select') }} --</option>
              {% for e in employees or [] %}
              <option value="{{ e.id }}">{{ e.full_name }}{% if e.department %} â€” {{ e.department }}{% endif %}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">{{ _('Paid Amount / Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹') }}</label>
            <input type="number" step="0.01" class="form-control" id="paid_amount" placeholder="0.00">
          </div>
          <div class="col-md-3 text-end">
            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#monthAdjust">{{ _('Edit Allowances/Deductions / ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø¯Ù„Ø§Øª ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª') }}</button>
          </div>
        </div>
        <div class="collapse mt-3" id="monthAdjust">
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">{{ _('Basic Salary / Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ') }}</label>
              <input type="number" step="0.01" class="form-control" id="basic_salary" placeholder="0.00">
            </div>
            <div class="col-md-3">
              <label class="form-label">{{ _('Allowances / Ø§Ù„Ø¨Ø¯Ù„Ø§Øª') }}</label>
              <input type="number" step="0.01" class="form-control" id="allowances" placeholder="0.00">
            </div>
            <div class="col-md-3">
              <label class="form-label">{{ _('Deductions / Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª') }}</label>
              <input type="number" step="0.01" class="form-control" id="deductions" placeholder="0.00">
            </div>
            <div class="col-md-3">
              <label class="form-label">{{ _('Previous Due / Ù…Ø³ØªØ­Ù‚Ø§Øª Ø³Ø§Ø¨Ù‚Ø©') }}</label>
              <input type="number" step="0.01" class="form-control" id="previous_due" placeholder="0.00">
            </div>
          </div>
          <div class="row g-3 mt-2">
            <div class="col-md-3">
              <label class="form-label">{{ _('Work Hours / Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„') }}</label>
              <input type="number" step="0.1" class="form-control" id="work_hours" placeholder="0">
            </div>
            <div class="col-md-3">
              <label class="form-label">{{ _('Net Salary / Ø§Ù„ØµØ§ÙÙŠ') }}</label>
              <input type="text" class="form-control" id="net_salary" readonly>
            </div>
            <div class="col-md-3">
              <label class="form-label">{{ _('Remaining / Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ') }}</label>
              <input type="text" class="form-control" id="remaining_salary" readonly>
            </div>
            <div class="col-md-3 text-end d-flex align-items-end justify-content-end">
              <button type="submit" class="btn btn-success">{{ _('Create/Update Salary / Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§ØªØ¨') }}</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="card mb-4" id="statements-section">
    <div class="card-body">
      <h5 class="mb-3">ğŸ§¾ {{ _('Payroll Statements / ÙƒØ´ÙˆÙØ§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨') }}</h5>
      <div class="row g-3 mb-3">
        <div class="col-md-3">
          <label class="form-label">{{ _('Month / Ø§Ù„Ø´Ù‡Ø±') }}</label>
          <input type="month" class="form-control" id="stmt_month">
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button class="btn btn-outline-primary" id="btnLoadStatements">{{ _('Load / ØªØ­Ù…ÙŠÙ„') }}</button>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-sm align-middle" id="tblStatements">
          <thead class="table-light">
            <tr>
              <th>{{ _('Employee / Ø§Ù„Ù…ÙˆØ¸Ù') }}</th>
              <th>{{ _('Department / Ø§Ù„Ù‚Ø³Ù…') }}</th>
              <th>{{ _('Basic / Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ') }}</th>
              <th>{{ _('Allowances / Ø§Ù„Ø¨Ø¯Ù„Ø§Øª') }}</th>
              <th>{{ _('Deductions / Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª') }}</th>
              <th>{{ _('Net / Ø§Ù„ØµØ§ÙÙŠ') }}</th>
              <th>{{ _('Paid / Ø§Ù„Ù…Ø¯ÙÙˆØ¹') }}</th>
              <th>{{ _('Remaining / Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ') }}</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="row g-3 mt-2" id="stmtTotals">
        <div class="col">
          <div class="small text-muted">{{ _('Totals (All Employees) / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª (ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†)') }}</div>
          <div class="d-flex flex-wrap gap-3">
            <div>{{ _('Employees') }}: <strong id="t_emps">0</strong></div>
            <div>{{ _('Basic') }}: <strong id="t_basic">0.00</strong></div>
            <div>{{ _('Allowances') }}: <strong id="t_allow">0.00</strong></div>
            <div>{{ _('Deductions') }}: <strong id="t_ded">0.00</strong></div>
            <div>{{ _('Paid') }}: <strong id="t_paid">0.00</strong></div>
            <div>{{ _('Net') }}: <strong id="t_net">0.00</strong></div>
            <div>{{ _('Remaining') }}: <strong id="t_remain">0.00</strong></div>
          </div>
        </div>
      </div>
    </div>
  </div>


  {% if employees %}
  <div class="card">
    <div class="card-body">
      {% set emps = employees or [] %}
      {% set total = emps|length %}
      {% set active_count = emps|selectattr('status','equalto','active')|list|length %}
      {% set inactive_count = total - active_count %}
      <div class="row g-3 mb-3">
        <div class="col-6 col-md-4"><div class="card shadow-sm h-100"><div class="card-body">
          <div class="text-muted small">{{ _('Total Employees / Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†') }}</div>
          <div class="fs-5 fw-bold">{{ total }}</div>
        </div></div></div>
        <div class="col-6 col-md-4"><div class="card shadow-sm h-100"><div class="card-body">
          <div class="text-muted small">{{ _('Active / Ù†Ø´Ø·') }}</div>
          <div class="fs-5 fw-bold text-success">{{ active_count }}</div>
        </div></div></div>
        <div class="col-6 col-md-4"><div class="card shadow-sm h-100"><div class="card-body">
          <div class="text-muted small">{{ _('Inactive / ØºÙŠØ± Ù†Ø´Ø·') }}</div>
          <div class="fs-5 fw-bold text-secondary">{{ inactive_count }}</div>
        </div></div></div>
      </div>
      <div class="row g-2 mb-2">
        <div class="col-md-4 ms-auto">
          <input type="text" class="form-control" id="empSearch" placeholder="{{ _('Search employees... / Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†...') }}">
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-striped table-hover align-middle table-sm">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>{{ _('Code / Ø§Ù„Ø±Ù…Ø²') }}</th>
              <th>{{ _('Name / Ø§Ù„Ø§Ø³Ù…') }}</th>
              <th>{{ _('National ID / Ø§Ù„Ù‡ÙˆÙŠØ©') }}</th>
              <th>{{ _('Department / Ø§Ù„Ù‚Ø³Ù…') }}</th>
              <th>{{ _('Position / Ø§Ù„ÙˆØ¸ÙŠÙØ©') }}</th>
              <th>{{ _('Phone / Ø§Ù„Ù‡Ø§ØªÙ') }}</th>
              <th>{{ _('Email / Ø§Ù„Ø¨Ø±ÙŠØ¯') }}</th>
              <th>{{ _('Hire Date / Ø§Ù„ØªØ¹ÙŠÙŠÙ†') }}</th>
              <th>{{ _('Status / Ø§Ù„Ø­Ø§Ù„Ø©') }}</th>
              <th>{{ _('Actions / Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª') }}</th>
            </tr>
          </thead>
          <tbody id="empTableBody">
            {% for e in employees %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ e.employee_code }}</td>
              <td>{{ e.full_name }}</td>
              <td>{{ e.national_id }}</td>
              <td>{{ e.department or '-' }}</td>
              <td>{{ e.position or '-' }}</td>
              <td>{% if e.phone %}<a href="tel:{{ e.phone }}">{{ e.phone }}</a>{% else %}-{% endif %}</td>
              <td>{% if e.email %}<a href="mailto:{{ e.email }}">{{ e.email }}</a>{% else %}-{% endif %}</td>
              <td>{{ e.hire_date or '-' }}</td>
              <td>{% if e.status=='active' %}<span class="badge bg-success">{{ _('Active / Ù†Ø´Ø·') }}</span>{% else %}<span class="badge bg-secondary">{{ _('Inactive / ØºÙŠØ± Ù†Ø´Ø·') }}</span>{% endif %}</td>
              <td>
                <div class="btn-group" role="group">
                  <button type="button" class="btn btn-sm btn-outline-primary" onclick="editEmployeeFromRow(this, {{ e.id }})" title="{{ _('Edit / ØªØ¹Ø¯ÙŠÙ„') }}">âœï¸</button>
                  <button type="button" class="btn btn-sm btn-outline-success" onclick="openPaySalary({{ e.id }})" title="{{ _('Salary / Ø§Ù„Ø±Ø§ØªØ¨') }}">ğŸ’°</button>
                  <form method="post" action="{{ url_for('main.employee_delete', eid=e.id) }}" class="d-inline" onsubmit="return confirm('{{ _('Delete this employee? / Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸ÙØŸ') }}')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-sm btn-outline-danger" title="{{ _('Delete / Ø­Ø°Ù') }}">ğŸ—‘ï¸</button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<script>
// WORKING FUNCTIONS - STEP BY STEP
console.log('JavaScript loaded successfully!');

// i18n strings
var I18N = {
  editEmployee: "{{ _('Edit Employee / ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù') }}",
  addEmployee: "{{ _('Add New Employee / Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯') }}",
  addEmployeeBtn: "{{ _('Add Employee / Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù') }}",
  salarySaved: "{{ _('Salary saved successfully / ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø§ØªØ¨ Ø¨Ù†Ø¬Ø§Ø­') }}",
  net: "{{ _('Net') }}",
  chooseMonth: "{{ _('Please choose month') }}",
  chooseEmployee: "{{ _('Please choose employee') }}",
  confirmDelete: "{{ _('Are you sure to delete / Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ') }}"
};

// Edit employee function
function editEmployeeFromRow(button, empId){
  // Read values from the current row cells to avoid complex escaping in attributes
  var tr = button.closest('tr');
  if (!tr) return;
  function cellText(idx){
    var td = tr.children[idx];
    return td ? (td.textContent||'').trim() : '';
  }
  var emp = {
    id: empId,
    employee_code: cellText(1),
    full_name: cellText(2),
    national_id: cellText(3),
    department: cellText(4) === '-' ? '' : cellText(4),
    position: cellText(5) === '-' ? '' : cellText(5),
    phone: cellText(6) === '-' ? '' : cellText(6),
    email: cellText(7) === '-' ? '' : cellText(7),
    hire_date: cellText(8) === '-' ? '' : cellText(8),
    status: (function(){ var b = tr.querySelector('.badge'); return (b && b.classList.contains('bg-success')) ? 'active' : 'inactive'; })()
  };
  console.log('Edit employee clicked:', emp.full_name);
  
  // Fill the form with employee data
  const codeInput = document.querySelector('input[name="employee_code"]');
  const nameInput = document.querySelector('input[name="full_name"]');
  const nationalIdInput = document.querySelector('input[name="national_id"]');
  const deptInput = document.querySelector('input[name="department"]');
  const positionInput = document.querySelector('input[name="position"]');
  const phoneInput = document.querySelector('input[name="phone"]');
  const emailInput = document.querySelector('input[name="email"]');
  const hireDateInput = document.querySelector('input[name="hire_date"]');
  const statusSelect = document.querySelector('select[name="status"]');
  
  if (codeInput) codeInput.value = emp.employee_code || '';
  if (nameInput) nameInput.value = emp.full_name || '';
  if (nationalIdInput) nationalIdInput.value = emp.national_id || '';
  if (deptInput) deptInput.value = emp.department || '';
  if (positionInput) positionInput.value = emp.position || '';
  if (phoneInput) phoneInput.value = emp.phone || '';
  if (emailInput) emailInput.value = emp.email || '';
  if (hireDateInput) hireDateInput.value = emp.hire_date || '';
  if (statusSelect) statusSelect.value = emp.status || 'active';
  const activeChk = document.getElementById('emp_active');
  if (activeChk) activeChk.checked = (emp.status||'active') === 'active';
  
  // Change form action to edit route
  const form = document.querySelector('#employees-form form');
  if (form) {
    form.action = `/employees/edit/${emp.id}`;
    // Change submit text for both button and input submit
    const btn = form.querySelector('button[type="submit"]');
    const inp = form.querySelector('input[type="submit"]');
    const newText = I18N.editEmployee;
    if (btn) { btn.textContent = newText; btn.className = 'btn btn-warning'; }
    if (inp) { inp.value = newText; inp.className = 'btn btn-warning'; }
    // Change form title
    const formTitle = document.getElementById('form-title');
    if (formTitle) {
      formTitle.textContent = 'âœï¸ ' + I18N.editEmployee + ': ' + (emp.full_name || '');
    }
  }
  
  // Scroll to form
  const formElement = document.getElementById('employees-form');
  if (formElement) {
    formElement.scrollIntoView({ behavior: 'smooth' });
  }
  
  // Focus first field for faster edits
  var f = document.querySelector('input[name="full_name"]');
  if (f && typeof f.focus === 'function') { f.focus(); }
}

// Make function globally accessible
window.editEmployeeFromRow = editEmployeeFromRow;

console.log('Edit function assigned to window object');

// Delete employee function - NEW
async function deleteEmployeeNew(id, name) {
  console.log('Delete employee clicked:', name);
  
  try {
    const confirmed = await window.showConfirm(`{{ _('Are you sure to delete / Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ') }}\n${name}`);
    if (confirmed) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/employees/${id}/delete`;
      
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'csrf_token';
      var mt = document.querySelector('meta[name="csrf-token"]');
      csrfInput.value = mt ? mt.content : '';
      
      form.appendChild(csrfInput);
      document.body.appendChild(form);
      form.submit();
    }
  } catch (error) {
    console.error('Error in deleteEmployeeNew:', error);
    alert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù');
  }
}

// Clear form function
function clearEmployeeForm() {
  console.log('Clear form clicked');
  
  const form = document.querySelector('#employees-form form');
  if (form) {
    form.reset();
    form.action = '/employees'; // Reset to create route
    // Reset submit text for both button and input submit
    const btn = form.querySelector('button[type="submit"]');
    const inp = form.querySelector('input[type="submit"]');
    const addText = '{{ _("Add Employee / Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù") }}';
    if (btn) { btn.textContent = addText; btn.className = 'btn btn-success'; }
    if (inp) { inp.value = addText; inp.className = 'btn btn-success'; }
    // Reset form title
    const formTitle = document.getElementById('form-title');
    if (formTitle) {
      formTitle.textContent = 'ğŸ“ {{ _("Add New Employee / Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯") }}';
    }
  }
}

// Make function globally accessible
window.clearEmployeeForm = clearEmployeeForm;

// Quick open Pay Salary section and preselect employee
function openPaySalary(empId, name){
  try{
    const sel = document.getElementById('pay_employee');
    if (sel){ sel.value = String(empId); sel.dispatchEvent(new Event('change')); }
    const paySec = document.getElementById('pay-salaries-section');
    if (paySec) paySec.scrollIntoView({behavior:'smooth'});
    // Auto-open adjustment area so Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ±Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„
    try{ new bootstrap.Collapse(document.getElementById('monthAdjust'), {toggle:true}); }catch(e){}
  }catch(e){ console.warn(e); }
}
window.openPaySalary = openPaySalary;

// Live search in employees table
(function(){
  var empSearch = document.getElementById('empSearch');
  if (empSearch && empSearch.addEventListener){
    empSearch.addEventListener('input', function(){
      var q = (this.value||'').toLowerCase();
      var rows = document.querySelectorAll('#empTableBody tr');
      Array.prototype.forEach.call(rows, function(tr){
        var txt = (tr.textContent||'').toLowerCase();
        tr.style.display = (txt.indexOf(q) !== -1) ? '' : 'none';
      });
    });
  }
})();

// Quick Department selector fills the input
(function(){
  const sel = document.getElementById('deptQuickSelect');
  if (!sel) return;
  sel.addEventListener('change', function(){
    const inp = document.querySelector('input[name="department"]');
    if (inp && this.value) inp.value = this.value;
  });
})();

// ===== Payroll helpers (UI only) =====
function toNum(v){ var n = parseFloat(v); return isNaN(n)?0:n; }
function updateNet(){
  var base = toNum((document.getElementById('basic_salary')||{}).value);
  var allow = toNum((document.getElementById('allowances')||{}).value);
  var ded = toNum((document.getElementById('deductions')||{}).value);
  var prev = toNum((document.getElementById('previous_due')||{}).value);
  var paid = toNum((document.getElementById('paid_amount')||{}).value);
  var net = Math.max(0, base + allow - ded + prev);
  var remaining = Math.max(0, net - paid);
  var netEl = document.getElementById('net_salary');
  var remEl = document.getElementById('remaining_salary');
  if (netEl) netEl.value = net.toFixed(2);
  if (remEl) remEl.value = remaining.toFixed(2);
}
['basic_salary','allowances','deductions','previous_due','paid_amount'].forEach(function(id){
  var el = document.getElementById(id);
  if (el && el.addEventListener) el.addEventListener('input', updateNet);
});

async function handleCreateSalary(ev){
  ev.preventDefault();
  var monthInput = document.getElementById('pay_month');
  var monthVal = (monthInput && monthInput.value) ? monthInput.value : '';
  if (!monthVal){ alert('{{ _('Please choose month') }}'); return false; }
  var parts = monthVal.split('-');
  var year = parts[0];
  var month = parts[1];
  var empSel = document.getElementById('pay_employee');
  var employee_id = (empSel && empSel.value) ? empSel.value : '';
  if (!employee_id){ alert('{{ _('Please choose employee') }}'); return false; }
  var base = toNum((document.getElementById('basic_salary')||{}).value);
  var allow = toNum((document.getElementById('allowances')||{}).value);
  var ded = toNum((document.getElementById('deductions')||{}).value);
  var prev = toNum((document.getElementById('previous_due')||{}).value);
  updateNet();
  var fd = new FormData();
  var csrfEl = document.querySelector('#paySalaryForm [name=csrf_token]');
  fd.append('csrf_token', csrfEl ? csrfEl.value : '');
  fd.append('employee_id', employee_id);
  fd.append('year', year);
  fd.append('month', month);
  fd.append('basic_salary', base);
  fd.append('allowances', allow);
  fd.append('deductions', ded);
  fd.append('previous_salary_due', prev);
  try{
    var resp = await fetch('{{ url_for('main.employees_create_salary') }}', { method:'POST', body: fd });
    var data;
    try { data = await resp.json(); } catch(_){ data = {ok:false,error:'parse_error'} }
    if (resp.ok && data.ok){
      var netTxt = '';
      if (data && typeof data.total === 'number') {
        netTxt = data.total.toFixed(2);
      } else if (data && data.total != null) {
        netTxt = String(data.total);
      }
      alert('{{ _('Salary saved successfully / ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø§ØªØ¨ Ø¨Ù†Ø¬Ø§Ø­') }}' + '\n' + '{{ _('Net') }}' + ': ' + netTxt);
    } else {
      alert('{{ _('Error') }}: ' + (data.error || resp.status));
    }
  }catch(err){
    alert('{{ _('Network error') }}');
  }
  return false;
}

// Stub: load statements (UI only placeholder for now)
(function(){
  var tbody = document.querySelector('#tblStatements tbody');
  if (!tbody) return;
})();
(function(){
  var tbody = document.querySelector('#tblStatements tbody');
  if (!tbody) return;
  tbody.innerHTML = '';
  let tEmps=0, tBasic=0, tAllow=0, tDed=0, tPaid=0, tNet=0, tRemain=0;
  {% for e in employees or [] %}
    // Defaults unknown at UI layer; render zeroed row with employee + department only
    var tr = document.createElement('tr');
    tr.innerHTML = '<td>{{ e.full_name|e }}</td>' +
                   '<td>{{ (e.department or '-')|e }}</td>' +
                   '<td>0.00</td><td>0.00</td><td>0.00</td><td>0.00</td><td>0.00</td><td>0.00</td>';
    tbody.appendChild(tr);
    tEmps += 1;
  {% endfor %}
  var el;
  el = document.getElementById('t_emps'); if (el) el.innerText = tEmps;
  el = document.getElementById('t_basic'); if (el) el.innerText = tBasic.toFixed(2);
  el = document.getElementById('t_allow'); if (el) el.innerText = tAllow.toFixed(2);
  el = document.getElementById('t_ded'); if (el) el.innerText = tDed.toFixed(2);
  el = document.getElementById('t_paid'); if (el) el.innerText = tPaid.toFixed(2);
  el = document.getElementById('t_net'); if (el) el.innerText = tNet.toFixed(2);
  el = document.getElementById('t_remain'); if (el) el.innerText = tRemain.toFixed(2);
});
</script>

{% endblock %}
