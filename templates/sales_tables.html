{% extends 'base.html' %}
{% block title %}Tables - {{ branch_label }}{% endblock %}
{% block content %}
<div id="tables-root" class="container py-4" data-branch="{{ branch_code }}">
  <div class="section-header mb-3">
    <div>
      <h4 class="mb-0">{{ branch_label }} &bull; Tables</h4>
      <small class="text-muted">Select a table to open the POS</small>
    </div>
    <div>
      <a class="btn btn-outline-secondary" href="{{ url_for('sales.sales') }}">&larr; Back to Branches</a>
      <button class="btn btn-outline-primary ms-2" id="btnArchive">{{ _('Archive Receipts') }}</button>
    </div>
  </div>

  <div class="row g-3">
    {% if grouped_tables %}
      {% if grouped_tables is mapping %}
        {% for group, tlist in grouped_tables.items() %}
        <div class="col-12"><h6 class="text-muted mt-3">{{ group }}</h6></div>
          {% for t in tlist %}
          <div class="col-6 col-md-3 col-lg-2">
            <a class="btn w-100 {% if t.status=='occupied' %}btn-danger{% else %}btn-success{% endif %}" data-table="{{ t.number }}" href="{{ url_for('sales.pos_table', branch_code=branch_code, table_number=t.number) }}">
              Table {{ t.number }}
              <span class="badge ms-2 status-label {% if t.status=='occupied' %}bg-danger{% else %}bg-success{% endif %}">{% if t.status=='occupied' %}Occupied{% else %}Available{% endif %}</span>
            </a>
          </div>
          {% endfor %}
        {% endfor %}
      {% else %}
        {% for sec in grouped_tables %}
        <div class="col-12"><h6 class="text-muted mt-3">{{ sec.section }}</h6></div>
          {% if sec.rows %}
            {% for row in sec.rows %}
              {% for t in row %}
              <div class="col-6 col-md-3 col-lg-2">
                <a class="btn w-100 {% if t.status=='occupied' %}btn-danger{% else %}btn-success{% endif %}" data-table="{{ t.number }}" href="{{ url_for('sales.pos_table', branch_code=branch_code, table_number=t.number) }}">
                  Table {{ t.number }}
                  <span class="badge ms-2 status-label {% if t.status=='occupied' %}bg-danger{% else %}bg-success{% endif %}">{% if t.status=='occupied' %}Occupied{% else %}Available{% endif %}</span>
                </a>
              </div>
              {% endfor %}
              <div class="w-100 d-none d-lg-block"></div>
            {% endfor %}
          {% else %}
            {% for t in sec.tables %}
            <div class="col-6 col-md-3 col-lg-2">
              <a class="btn w-100 {% if t.status=='occupied' %}btn-danger{% else %}btn-success{% endif %}" data-table="{{ t.number }}" href="{{ url_for('sales.pos_table', branch_code=branch_code, table_number=t.number) }}">
                Table {{ t.number }}
                <span class="badge ms-2 status-label {% if t.status=='occupied' %}bg-danger{% else %}bg-success{% endif %}">{% if t.status=='occupied' %}Occupied{% else %}Available{% endif %}</span>
              </a>
            </div>
            {% endfor %}
          {% endif %}
        {% endfor %}
      {% endif %}
    {% elif tables %}
      {% for t in tables %}
      <div class="col-6 col-md-3 col-lg-2">
        <a class="btn w-100 {% if t.status=='occupied' %}btn-danger{% else %}btn-success{% endif %}" data-table="{{ t.number }}" href="{{ url_for('sales.pos_table', branch_code=branch_code, table_number=t.number) }}">
          Table {{ t.number }}
          <span class="badge ms-2 status-label {% if t.status=='occupied' %}bg-danger{% else %}bg-success{% endif %}">{% if t.status=='occupied' %}Occupied{% else %}Available{% endif %}</span>
        </a>
      </div>
      {% endfor %}
    {% else %}
      {% for n in range(1,21) %}
      <div class="col-6 col-md-3 col-lg-2">
        <a class="btn w-100 btn-outline-primary" href="{{ url_for('sales.pos_table', branch_code=branch_code, table_number=n) }}">
          Table {{ n }}
        </a>
      </div>
      {% endfor %}


    {% endif %}
  </div>
    </div>
  </div>
</div>
<div class="offcanvas offcanvas-end" tabindex="-1" id="archiveOffcanvas" aria-labelledby="archiveOffcanvasLabel" style="width:80vw; max-width:1200px">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="archiveOffcanvasLabel">{{ _('Receipt Archive') }}</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body p-0 d-flex flex-column" style="height:100%">
    <div class="p-2 border-bottom small text-muted" id="archiveInfo"></div>
    <div class="p-2 border-bottom">
      <div class="input-group">
        <span class="input-group-text">ðŸ”Ž</span>
        <input type="text" class="form-control" id="archiveSearch" placeholder="{{ _('Enter last 4 digits') }}">
        <button class="btn btn-outline-secondary" id="archiveClear">{{ _('Clear') }}</button>
      </div>
      <div class="small text-muted mt-1">{{ _('Search receipts using the last 4 digits of the invoice number') }}</div>
    </div>
    <div class="row g-0" style="flex:1; min-height:0">
      <div class="col-4 border-end" style="overflow:auto; max-height:100%">
        <div class="list-group list-group-flush" id="archiveList"></div>
      </div>
      <div class="col-8" style="height:100%">
        <iframe id="archivePreview" src="" style="width:100%; height:100%; border:0"></iframe>
      </div>
    </div>
    <div class="p-2 border-top">
      <button class="btn btn-success w-100" onclick="printSelected()">{{ _('Print') }}</button>
    </div>
  </div>
</div>
{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/tables.js') }}?v={{ ASSET_VERSION }}"></script>
  <script>
    var __salesBranch = window.__salesBranch || (document.getElementById('tables-root')?.getAttribute('data-branch')||'');
    window.__salesBranch = __salesBranch;
    let _selectedInv = null;
    function _branchLabel(code){
      const m = {'place_india':'Place India','china_town':'China Town'}; return m[code]||code||'-';
    }
    function openArchive(){
      const el = document.getElementById('archiveOffcanvas');
      if(!el) return;
      const body = document.getElementById('archiveList');
      const info = document.getElementById('archiveInfo');
      const frame = document.getElementById('archivePreview');
      const searchEl = document.getElementById('archiveSearch');
      const clearEl = document.getElementById('archiveClear');
      _selectedInv = null; info.textContent = '';
      frame.src = '';
      body.innerHTML = '<div class="p-2 text-muted">{{ _('Loading...') }}</div>';
      const url = `/api/archive/list?branch=${encodeURIComponent(window.__salesBranch)}&page=1&page_size=100`;
      fetch(url, {credentials:'same-origin'})
        .then(r=>r.json())
        .then(j=>{
          if(!j || j.ok!==true){ body.innerHTML = '<div class="p-2 text-danger">{{ _('Failed to load') }}</div>'; return; }
          if(!Array.isArray(j.items) || j.items.length===0){ body.innerHTML = '<div class="p-2 text-muted">{{ _('No receipts') }}</div>'; return; }
          window.__archiveItems = j.items;
          function renderList(items){
            body.innerHTML = '';
            items.forEach(it=>{
              const row = document.createElement('div');
              row.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
              const dt = `${it.date} ${it.time||''}`.trim();
              const pm = (it.payment_method||'').toUpperCase();
              const pmBadge = pm ? `<span class="badge bg-light text-dark">${pm}</span>` : '';
              const amt = (Number(it.total_amount||0)).toFixed(2);
              row.innerHTML = `<div>
                  <div class="fw-bold">${it.invoice_number}</div>
                  <div class="small text-muted">${dt} Â· ${_branchLabel(it.branch)||'-'} ${pmBadge}</div>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <span class="text-success fw-semibold">ï·¼${amt}</span>
                  <button class="btn btn-sm btn-outline-secondary">{{ _('Preview') }}</button>
                </div>`;
              const btn = row.querySelector('button');
              btn.addEventListener('click', function(ev){ ev.preventDefault(); selectArchive(it); });
              row.addEventListener('click', function(ev){ ev.preventDefault(); selectArchive(it); });
              body.appendChild(row);
            });
            if(items.length === 0){ body.innerHTML = '<div class="p-2 text-muted">{{ _('No matching receipts') }}</div>'; }
          }
          function filterBySuffix(q){
            const qq = String(q||'').replace(/\D/g,'').slice(-4);
            if(!qq){ renderList(window.__archiveItems); return; }
            const out = (window.__archiveItems||[]).filter(it=>{
              const digits = String(it.invoice_number||'').replace(/\D/g,'');
              return digits.endsWith(qq);
            });
            renderList(out);
          }
          renderList(window.__archiveItems);
          if(searchEl){
            searchEl.addEventListener('input', function(){ filterBySuffix(searchEl.value); });
          }
          if(clearEl){
            clearEl.addEventListener('click', function(ev){ ev.preventDefault(); if(searchEl){ searchEl.value=''; searchEl.focus(); } renderList(window.__archiveItems); });
          }
        })
        .catch(()=>{ body.innerHTML = '<div class="p-2 text-danger">{{ _('Network error') }}</div>'; });
      new bootstrap.Offcanvas(el).show();
    }
    function selectArchive(it){
      _selectedInv = String(it.invoice_number||'');
      const info = document.getElementById('archiveInfo');
      info.textContent = `${it.invoice_number} Â· ${it.date} ${it.time||''} Â· ${_branchLabel(it.branch)}`;
      const frame = document.getElementById('archivePreview');
      frame.src = `/print/receipt/${encodeURIComponent(_selectedInv)}`;
    }
    function printSelected(){
      const frame = document.getElementById('archivePreview');
      if(!frame || !_selectedInv){ return; }
      try{ frame.contentWindow && frame.contentWindow.focus(); frame.contentWindow && frame.contentWindow.print(); }catch(_){ window.open(frame.src, '_blank'); }
      try{ bootstrap.Offcanvas.getInstance(document.getElementById('archiveOffcanvas')).hide(); }catch(_){}
    }
    document.getElementById('btnArchive')?.addEventListener('click', function(ev){ ev.preventDefault(); openArchive(); });
  </script>
{% endblock %}

{% endblock %}

<!-- offcanvas moved into content block above -->
