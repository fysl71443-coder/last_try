{% extends 'base.html' %}
{% set back_url = url_for('main.invoices', type=back_type if back_type is defined else kind) %}

{% block title %}{{ _(title) }}{% endblock %}
{% block content %}
<div class="container py-4 ops-layout hub-wrap printable">
  <div class="ops-header-bar no-print">
    <span class="ops-icon"><i class="fa-solid fa-file-invoice"></i></span>
    <div>
      <h1 class="ops-title mb-0">{{ _(title) }} â€” {{ inv.invoice_number }}</h1>
      <span class="ops-subtitle">{{ _('View and print invoice') }}</span>
    </div>
    <div class="ops-actions">
      <a href="{{ url_for('main.invoices', type=back_type if back_type is defined else kind) }}" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-arrow-left me-1"></i>{{ _('Back') }}</a>
      <a href="#" class="btn btn-sm btn-primary" onclick="window.print(); return false;"><i class="fa-solid fa-print me-1"></i>{{ _('Print') }}</a>
    </div>
  </div>

  <div class="ops-form-card mt-0">
    <div class="ops-form-head">{{ _('Invoice info') }}</div>
    <div class="ops-form-body">
      <div class="row g-3 mb-0">
        <div class="col-md-4"><div class="text-muted small">{{ _('Date') }}</div><strong>{{ inv.date }}</strong></div>
        <div class="col-md-4"><div class="text-muted small">{{ _('Party') }}</div><strong>{{ inv.customer_name or inv.supplier_name or '-' }}</strong></div>
        <div class="col-md-4"><div class="text-muted small">{{ _('Status') }}</div><strong>{{ inv.status }}</strong></div>
      </div>
    </div>
  </div>

  <div class="screen-section">
    <div class="screen-section-title">{{ _('Items') }}</div>
    <div class="screen-section-body">
      <div class="screen-table-wrap">
        <table class="table screen-table invoice-table">
          <thead>
            <tr>
              <th>#</th>
              <th>{{ _('Item') }}</th>
              <th>{{ _('Qty') }}</th>
              <th>{{ _('Price') }}</th>
              <th>{{ _('Tax') }}</th>
              <th>{{ _('Discount') }}</th>
              <th>{{ _('Total') }}</th>
            </tr>
          </thead>
          <tbody>
            {% for it in items %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ it.product_name or it.raw_material_name or it.description }}</td>
              <td>{{ it.quantity }}</td>
              <td>{{ '%.2f'|format(it.price_before_tax) if it.price_before_tax is not none else '-' }}</td>
              <td>{{ '%.2f'|format(it.tax) if it.tax is not none else '-' }}</td>
              <td>{{ '%.2f'|format(it.discount) if it.discount is not none else '0.00' }}</td>
              <td>{{ '%.2f'|format(it.total_price) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="ops-form-card">
    <div class="ops-form-head">{{ _('Totals') }}</div>
    <div class="ops-form-body">
      <div class="row g-3 kpi-row">
        <div class="col-md-3"><div class="text-muted small">{{ _('Subtotal') }}</div><div class="kpi-value">{{ '%.2f'|format(inv.total_before_tax) }}</div></div>
        <div class="col-md-3"><div class="text-muted small">{{ _('Tax') }}</div><div class="kpi-value">{{ '%.2f'|format(inv.tax_amount) }}</div></div>
        <div class="col-md-3"><div class="text-muted small">{{ _('Discount') }}</div><div class="kpi-value">{{ '%.2f'|format(inv.discount_amount) }}</div></div>
        <div class="col-md-3"><div class="text-muted small">{{ _('Total') }}</div><div class="kpi-value">{{ '%.2f'|format(inv.total_after_tax_discount) }}</div></div>
      </div>
      <div class="row g-3 mt-2">
        <div class="col-md-4"><div class="text-muted small">{{ _('Paid') }}</div><div class="kpi-value">{{ '%.2f'|format(paid) }}</div></div>
        <div class="col-md-4"><div class="text-muted small">{{ _('Remaining') }}</div><div class="kpi-value">{{ '%.2f'|format(remaining) }}</div></div>
        <div class="col-md-4 no-print">
          <div class="d-flex gap-2">
            <button class="btn btn-primary" onclick="payFull('{{ kind }}','{{ inv.id }}','{{ remaining }}')">{{ _('Pay Full') }}</button>
            <button class="btn btn-outline-primary" onclick="payCustom('{{ kind }}','{{ inv.id }}','{{ remaining }}')">{{ _('Enter Amount') }}</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
@media print {
  body {
    background: white !important;
    color: black !important;
  }
  .printable, .printable * {
    color: black !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    font-weight: bold !important;
  }
  .table thead th {
    background: black !important;
    color: white !important;
  }
  .table tbody td {
    border: 1px solid black !important;
  }
  .card {
    border: 1px solid black !important;
    box-shadow: none !important;
  }
  .no-print {
    display: none !important;
  }
}
</style>

<script>
function sendPayment(kind, id, amount){
  if(!amount || parseFloat(amount)<=0){ alert('{{ _('Invalid amount') }}'); return; }
  const form = new FormData();
  form.append('invoice_id', id);
  form.append('invoice_type', kind);
  form.append('amount', amount);
  const csrf = document.querySelector('input[name="csrf_token"]');
  if (csrf) form.append('csrf_token', csrf.value);
  fetch('#', { method:'POST', body: form, credentials:'same-origin' })
    .then(r=>r.json()).then(d=>{ if(d.status==='success') location.reload(); else alert('Error'); })
    .catch(()=>alert('Network error'));
}
function payFull(kind, id, remaining){
  const amt = parseFloat(remaining||0);
  if(!amt || amt<=0){ alert('{{ _('Nothing to pay') }}'); return; }
  if(!confirm('{{ _('Confirm full payment') }}: '+amt)) return;
  sendPayment(kind, id, amt);
}
function payCustom(kind, id, remaining){
  const input = prompt("{{ _('Enter amount to pay') }}\n{{ _('Remaining') }}: "+remaining);
  if(!input) return;
  const amt = parseFloat((input||'').toString().replace(',', '.'));
  if(!amt || isNaN(amt) || amt<=0){ alert('{{ _('Invalid amount') }}'); return; }
  sendPayment(kind, id, amt);
}
</script>
{% endblock %}
