{% extends 'base.html' %}
{% set back_url = url_for('dashboard') %}

{% block title %}{{ _('All Invoices / ÙƒÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±') }}{% endblock %}
{% block content %}

<style>
body {
  background: #f4f6f9;
}
.invoice-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0px 4px 8px rgba(0,0,0,0.05);
  padding: 1.5rem;
  margin-bottom: 1rem;
}
.status-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: bold;
}
.status-pending { background: #ffeaa7; color: #2d3436; }
.status-partial { background: #fab1a0; color: #2d3436; }
.status-paid { background: #00b894; color: white; }
.nav-buttons {
  background: white;
  border-radius: 12px;
  padding: 1rem;
  margin-bottom: 1rem;
  box-shadow: 0px 2px 4px rgba(0,0,0,0.05);
}
</style>

<div class="container py-4">
    <h3 class="mb-4">{{ _('All Invoices / ÙƒÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±') }}</h3>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ -->
    <div class="nav-buttons">
        <div class="row">
            <div class="col-md-8">
                <a href="{{ url_for('invoices', type='sales') }}"
                   class="btn btn-outline-primary me-2 {{ 'active' if current_type == 'sales' else '' }}">
                   {{ _('Sales / Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª') }}
                </a>
                <a href="{{ url_for('invoices', type='purchases') }}"
                   class="btn btn-outline-primary me-2 {{ 'active' if current_type == 'purchases' else '' }}">
                   {{ _('Purchases / Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª') }}
                </a>
                <a href="{{ url_for('invoices', type='expenses') }}"
                   class="btn btn-outline-primary me-2 {{ 'active' if current_type == 'expenses' else '' }}">
                   {{ _('Expenses / Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª') }}
                </a>
                <a href="{{ url_for('invoices', type='all') }}"
                   class="btn btn-outline-secondary {{ 'active' if current_type == 'all' else '' }}">
                   {{ _('All / Ø§Ù„ÙƒÙ„') }}
                </a>
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group" role="group">
                  <a href="{{ url_for('print_invoices', section=current_type) }}" class="btn btn-success" target="_blank">ğŸ“„ {{ _('Print All / Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„') }}</a>
                  <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">ğŸ—‘ï¸ {{ _('Delete / Ø­Ø°Ù') }}</button>
                </div>
            </div>
        </div>
    </div>

    {% if invoices %}
    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ -->
    <div class="invoice-card">
        <form method="post" action="{{ url_for('bulk_payment') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th><input type="checkbox" id="select-all"></th>
                            <th>#</th>
                            <th>{{ _('Invoice No') }}</th>
                            <th>{{ _('Type') }}</th>
                            <th>{{ _('Customer/Supplier') }}</th>
                            <th>{{ _('Total') }}</th>
                            <th>{{ _('Paid') }}</th>
                            <th>{{ _('Remaining') }}</th>
                            <th>{{ _('Status') }}</th>
                            <th>{{ _('Due Date') }}</th>
                            <th>{{ _('Pay') }}</th>
                           <th>{{ _('View') }}</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-list">
                        {% for invoice in invoices %}
                        <tr>
                            <td><input type="checkbox" name="invoice_ids" value="{{ invoice.id }}"></td>
                            <td>{{ loop.index }}</td>
                            <td><strong>{{ invoice.invoice_number }}</strong></td>
                            <td>
                                <span class="badge bg-secondary">{{ invoice.invoice_type.title() }}</span>
                            </td>
                            <td>{{ invoice.customer_supplier }}</td>
                            <td>${{ "%.2f"|format(invoice.total_amount) }}</td>
                            <td>${{ "%.2f"|format(invoice.paid_amount) }}</td>
                            <td>${{ "%.2f"|format(invoice.remaining_amount) }}</td>
                            <td>
                                <span class="status-badge status-{{ invoice.status }}">
                                    {{ invoice.status.title() }}
                                </span>
                            </td>
                            <td>{{ invoice.due_date.strftime('%Y-%m-%d') if invoice.due_date else '-' }}</td>
                            <td>
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                                {% if invoice.status != 'paid' %}
                                <form method="post" action="{{ url_for('single_payment', invoice_id=invoice.id) }}" class="d-flex">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="number" step="0.01" name="payment_amount"
                                           placeholder="Amount" class="form-control form-control-sm me-1"
                                           max="{{ invoice.remaining_amount }}" required>
                                    <button type="submit" class="btn btn-sm btn-primary">
                                        {{ _('Pay') }}
                                    </button>
                                </form>
                                {% else %}
                                <span class="text-success">âœ“ {{ _('Paid') }}</span>
                                {% endif %}

                                </td>
                                <td>
                                  <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('view_invoice', kind=invoice.invoice_type, invoice_id=invoice.id) }}">{{ _('View / Ø¹Ø±Ø¶') }}</a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" step="0.01" name="bulk_payment_amount"
                               placeholder="{{ _('Total Amount for Selected') }}"
                               class="form-control" required>
                        <button type="submit" class="btn btn-warning">
                            ğŸ’³ {{ _('Pay Selected / Ø¯ÙØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯') }}
                        </button>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <small class="text-muted">
                        {{ _('Select invoices and enter total amount to distribute payment equally') }}
                    </small>
                </div>
            </div>
        </form>
    </div>
    {% else %}
    <div class="invoice-card text-center">
        <h5>{{ _('No invoices found / Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ±') }}</h5>
        <p class="text-muted">{{ _('Create your first invoice to get started / Ø£Ù†Ø´Ø¦ Ø£ÙˆÙ„ ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø¨Ø¯Ø¡') }}</p>
    </div>
    {% endif %}
</div>
    <!-- Delete Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form method="post" action="{{ url_for('invoices_delete', type=current_type) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="modal-header">
              <h5 class="modal-title">{{ _('Delete Invoices / Ø­Ø°Ù Ø§Ù„ÙÙˆØ§ØªÙŠØ±') }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-2">
                <label class="form-label">{{ _('Scope / Ø§Ù„Ù†Ø·Ø§Ù‚') }}</label>
                <select class="form-select" name="scope" id="del-scope">
                  <option value="selected">{{ _('Selected only / Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙ‚Ø·') }}</option>
                  <option value="type">{{ _('All in current type tab / ÙƒÙ„ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ') }}</option>
                </select>
              </div>
              <div class="mb-2">
                <label class="form-label">{{ _('Type / Ø§Ù„Ù†ÙˆØ¹') }}</label>
                <select class="form-select" name="invoice_type">
                  <option value="sales" {{ 'selected' if current_type=='sales' else '' }}>{{ _('Sales / Ù…Ø¨ÙŠØ¹Ø§Øª') }}</option>
                  <option value="purchases" {{ 'selected' if current_type=='purchases' else '' }}>{{ _('Purchases / Ù…Ø´ØªØ±ÙŠØ§Øª') }}</option>
                  <option value="expenses" {{ 'selected' if current_type=='expenses' else '' }}>{{ _('Expenses / Ù…ØµØ±ÙˆÙØ§Øª') }}</option>
                </select>
              </div>
              <div class="alert alert-warning small">{{ _('This action is irreversible. Related items and payments will be deleted as well. / Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡ ÙˆØ³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø£ÙŠØ¶Ø§Ù‹') }}</div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel / Ø¥Ù„ØºØ§Ø¡') }}</button>
              <button type="submit" class="btn btn-danger">{{ _('Delete / Ø­Ø°Ù') }}</button>
            </div>
            <!-- Include selected IDs as hidden fields dynamically before submit via JS -->
          </form>
        </div>
      </div>
    </div>


<!-- SocketIO and JavaScript -->
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
    // SocketIO for real-time updates
    var socket = io();
    socket.on('invoice_update', function(data) {
        console.log('Invoice updated:', data);
        // Reload page to show updates
        location.reload();
    });

    // Select all functionality
    document.getElementById('select-all').addEventListener('click', function() {
        let checkboxes = document.querySelectorAll('input[name="invoice_ids"]');
        checkboxes.forEach(cb => cb.checked = this.checked);
    });

    // Before submit delete form, inject selected ids as hidden fields
    const delModal = document.getElementById('deleteModal');
    if(delModal){
      delModal.addEventListener('show.bs.modal', function(){
        // nothing yet
      });
      delModal.addEventListener('shown.bs.modal', function(){
        // Focus
      });
      delModal.querySelector('form').addEventListener('submit', function(ev){
        const tbodyCbs = document.querySelectorAll('tbody#invoice-list input[name="invoice_ids"]:checked');
        // remove previous hidden inputs
        this.querySelectorAll('input[type="hidden"][name="invoice_ids"]').forEach(n=>n.remove());
        tbodyCbs.forEach(cb => {
          const i = document.createElement('input');
          i.type = 'hidden'; i.name = 'invoice_ids'; i.value = cb.value;
          this.appendChild(i);
        });
        // pass current tab type for safety
        const t = document.createElement('input'); t.type='hidden'; t.name='current_type'; t.value='{{ current_type }}'; this.appendChild(t);
      });
    }

    // Auto-calculate remaining amount for payment input
    document.querySelectorAll('input[name="payment_amount"]').forEach(input => {
        input.addEventListener('input', function() {
            const maxAmount = parseFloat(this.getAttribute('max'));
            if (parseFloat(this.value) > maxAmount) {
                this.value = maxAmount;
            }
        });
    });
</script>

{% endblock %}
