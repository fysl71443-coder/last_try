{% extends 'base.html' %}
{% set back_url = url_for('main.dashboard') %}

{% block title %}{{ _('All Invoices') }}{% endblock %}
{% block content %}

<style>.status-pending{ background:rgba(253,203,110,.3); color:#856404; } .status-partial{ background:rgba(255,193,7,.25); color:#856404; } .status-paid{ background:rgba(39,174,96,.2); color:#27ae60; }</style>

<div class="container py-4 ops-layout hub-wrap">
    <div class="ops-header-bar">
        <span class="ops-icon"><i class="fa-solid fa-file-invoice"></i></span>
        <div>
            <h1 class="ops-title mb-0">{{ _('All Invoices') }}</h1>
            <span class="ops-subtitle">{{ _('Sales, purchases, expenses') }}</span>
        </div>
        <div class="ops-actions d-flex flex-wrap gap-2">
            <a href="#" id="btnPrintAll" class="btn btn-sm btn-primary" target="_blank"><i class="fa-solid fa-print me-1"></i>{{ _('Print') }}</a>
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-sm" data-partial-links><i class="fa-solid fa-house me-1"></i>{{ _('Dashboard') }}</a>
        </div>
    </div>

    <div class="ops-tabs-wrap">
        <div class="ops-tabs" role="tablist">
            <a href="{{ url_for('main.invoices', type='sales') }}" class="ops-tab {{ 'active' if current_type == 'sales' else '' }}">{{ _('Sales') }}</a>
            <a href="{{ url_for('main.invoices', type='purchases') }}" class="ops-tab {{ 'active' if current_type == 'purchases' else '' }}">{{ _('Purchases') }}</a>
            <a href="{{ url_for('main.invoices', type='expenses') }}" class="ops-tab {{ 'active' if current_type == 'expenses' else '' }}">{{ _('Expenses') }}</a>
            <a href="{{ url_for('main.invoices', type='all') }}" class="ops-tab {{ 'active' if current_type == 'all' else '' }}">{{ _('All') }}</a>
        </div>
    </div>

    <div class="ops-body ops-body-no-sidebar">
    <main class="ops-main">
    <div class="ops-form-card mt-0">
      <div class="ops-form-head">{{ _('Detailed View') }}</div>
      <div class="ops-form-body">
        <p class="text-muted small mb-3">{{ _('This screen is for viewing, filtering and printing only. No payments or deletions are performed here.') }}</p>
      <div class="row g-3 align-items-end mb-3">
        <div class="col-md-3">
          <label class="form-label">{{ _('Start Date') }}</label>
          <input type="date" id="detStart" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label">{{ _('End Date') }}</label>
          <input type="date" id="detEnd" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label">{{ _('Payment Method') }}</label>
          <select id="detPM" class="form-select">
            <option value="all" selected>{{ _('All') }}</option>
            <option value="cash">{{ _('Cash') }}</option>
            <option value="card">{{ _('Card') }}</option>
            <option value="bank">{{ _('Bank') }}</option>
            <option value="online">{{ _('Online') }}</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">{{ _('Branch (Sales)') }}</label>
          <select id="detBranch" class="form-select">
            <option value="all" selected>{{ _('All') }}</option>
            <option value="china_town">China Town</option>
            <option value="place_india">Place India</option>
          </select>
        </div>
      </div>
        <div class="mb-3">
          <button id="btnApplyFilters" class="btn btn-primary btn-sm"><i class="fa-solid fa-filter me-1"></i>{{ _('Apply Filters') }}</button>
        </div>

      <!-- Sales Detailed (visible when tab Sales or All) -->
      <div class="mb-4 section-det section-sales" {% if current_type not in ['sales', 'all'] %}style="display:none"{% endif %}>
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">{{ _('Sales Invoices (Itemized, grouped by Branch)') }}</h6>
          <div>
            <button id="btnPrintSales" class="btn btn-sm btn-outline-dark">{{ _('Print') }}</button>
            <button id="btnExportSalesDet" class="btn btn-sm btn-primary ms-2">{{ _('Export') }}</button>
          </div>
        </div>
        <div class="table-responsive screen-table-wrap">
          <table class="table table-sm table-hover align-middle screen-table mb-0">
            <thead>
              <tr>
                <th>{{ _('Branch') }}</th>
                <th>{{ _('Date') }}</th>
                <th>{{ _('Invoice No.') }}</th>
                <th>{{ _('Item') }}</th>
                <th>{{ _('Qty') }}</th>
                <th>{{ _('Amount') }}</th>
                <th>{{ _('Discount') }}</th>
                <th>{{ _('VAT') }}</th>
                <th>{{ _('Total') }}</th>
                <th>{{ _('Payment') }}</th>
              </tr>
            </thead>
            <tbody id="det-sales-body"></tbody>
            <tfoot id="det-sales-foot"></tfoot>
          </table>
        </div>
      </div>

      <!-- Purchases Detailed (visible when tab Purchases or All) -->
      <div class="mb-4 section-det section-purchases" {% if current_type not in ['purchases', 'all'] %}style="display:none"{% endif %}>
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">{{ _('Purchase Invoices (Itemized)') }}</h6>
          <div>
            <button id="btnPrintPurch" class="btn btn-sm btn-outline-dark">{{ _('Print') }}</button>
            <button id="btnExportPurchDet" class="btn btn-sm btn-primary ms-2">{{ _('Export') }}</button>
          </div>
        </div>
        <div class="table-responsive screen-table-wrap">
          <table class="table table-sm table-hover align-middle screen-table mb-0">
            <thead>
              <tr>
                <th>{{ _('Date') }}</th>
                <th>{{ _('Invoice No.') }}</th>
                <th>{{ _('Item') }}</th>
                <th>{{ _('Qty') }}</th>
                <th>{{ _('Amount') }}</th>
                <th>{{ _('Discount') }}</th>
                <th>{{ _('VAT') }}</th>
                <th>{{ _('Total') }}</th>
                <th>{{ _('Payment') }}</th>
              </tr>
            </thead>
            <tbody id="det-pur-body"></tbody>
            <tfoot id="det-pur-foot"></tfoot>
          </table>
        </div>
      </div>

      <!-- Expenses Detailed (visible when tab Expenses or All) -->
      <div class="section-det section-expenses" {% if current_type not in ['expenses', 'all'] %}style="display:none"{% endif %}>
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">{{ _('Expenses (Itemized)') }}</h6>
          <div>
            <button id="btnPrintExp" class="btn btn-sm btn-outline-secondary">{{ _('Print') }}</button>
            <button id="btnExportExpDet" class="btn btn-sm btn-outline-primary ms-2">{{ _('Export') }}</button>
          </div>
        </div>
        <div class="table-responsive screen-table-wrap">
          <table class="table table-sm table-hover align-middle screen-table mb-0">
            <thead>
              <tr>
                <th>{{ _('Date') }}</th>
                <th>{{ _('Expense No.') }}</th>
                <th>{{ _('Description') }}</th>
                <th>{{ _('Amount') }}</th>
                <th>{{ _('Payment') }}</th>
              </tr>
            </thead>
            <tbody id="det-exp-body"></tbody>
            <tfoot id="det-exp-foot"></tfoot>
          </table>
        </div>
      </div>
      </div>
    </div>
    </main>
    </div>

    {% if invoices %}
    <div class="ops-form-card">
        <div class="ops-form-head">{{ _('Invoices list') }}</div>
        <div class="ops-form-body">
            <div class="d-flex justify-content-end mb-3 gap-2">
              <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportInvoicesCSV()"><i class="fa-solid fa-file-csv me-1"></i>{{ _('Export CSV') }}</button>
              <button type="button" class="btn btn-sm btn-outline-primary" onclick="exportInvoicesDetailedCSV()"><i class="fa-solid fa-file-excel me-1"></i>{{ _('Export Detailed CSV') }}</button>
            </div>
            <div class="table-responsive screen-table-wrap">
                <table class="table table-hover align-middle screen-table mb-0">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>{{ _('Invoice No') }}</th>
                            <th>{{ _('Type') }}</th>
                            <th>{{ _('Customer/Supplier') }}</th>
                            <th>{{ _('Total') }}</th>
                            <th>{{ _('Paid') }}</th>
                            <th>{{ _('Remaining') }}</th>
                            <th>{{ _('Status') }}</th>
                            <th>{{ _('Due Date') }}</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="invoice-list">
                        {% for invoice in invoices %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td><strong>{{ invoice.invoice_number }}</strong></td>
                            <td>
                                <span class="badge bg-secondary">{{ invoice.invoice_type.title() }}</span>
                            </td>
                            <td>{{ invoice.customer_supplier }}</td>
                            <td>${{ "%.2f"|format(invoice.total_amount) }}</td>
                            <td>${{ "%.2f"|format(invoice.paid_amount) }}</td>
                            <td>${{ "%.2f"|format(invoice.remaining_amount) }}</td>
                            <td>
                                <span class="status-badge status-{{ invoice.status }}">
                                    {{ invoice.status.title() }}
                                </span>
                            </td>
                            <td>{{ invoice.due_date.strftime('%Y-%m-%d') if invoice.due_date else '-' }}</td>
                            <td>
                                <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('main.view_invoice', kind=invoice.invoice_type, invoice_id=invoice.id) }}">{{ _('View') }}</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="ops-form-card">
        <div class="ops-form-body text-center py-4">
        <h5 class="text-secondary">{{ _('No invoices found') }}</h5>
        <p class="text-muted">{{ _('Create your first invoice to get started') }}</p>
        </div>
    </div>
    {% endif %}


  <script>
    // Detailed view loaders with filters
    (function(){
      function n2(x){ try{return Number(x||0).toFixed(2);}catch(e){return '0.00';} }
      function enc(s){ return encodeURIComponent(s||''); }
      var CURRENT_TYPE = '{{ current_type }}';
      function buildQS(){
        const s = document.getElementById('detStart')?.value || '';
        const e = document.getElementById('detEnd')?.value || '';
        const pm = (document.getElementById('detPM')?.value || 'all');
        const br = (document.getElementById('detBranch')?.value || 'all');
        const parts = [];
        if(CURRENT_TYPE && CURRENT_TYPE !== 'all') parts.push('type='+enc(CURRENT_TYPE));
        if(s) parts.push('start_date='+enc(s));
        if(e) parts.push('end_date='+enc(e));
        if(pm && pm!=='all') parts.push('payment_method='+enc(pm));
        if(br && br!=='all') parts.push('branch='+enc(br));
        return parts.length ? ('?'+parts.join('&')) : '';
      }

      function loadDetSales(){
        const qs = buildQS();
        fetch('/api/all-invoices'+qs, {credentials:'same-origin'})
          .then(r=>r.json()).then(data=>{
            const body = document.getElementById('det-sales-body');
            const foot = document.getElementById('det-sales-foot');
            if(!body||!foot) return; body.innerHTML=''; foot.innerHTML='';
            const rows = (data.invoices||[]).filter(r=> (r.type||'sale')==='sale')
              .sort((a,b)=> (a.branch||'').localeCompare(b.branch||'') || (b.date||'').localeCompare(a.date||''));
            let curB=null; const totalsByB={}; let overall={amount:0,discount:0,vat:0,total:0};
            rows.forEach(r=>{
              if(r.branch!==curB){
                curB=r.branch; const hdr=document.createElement('tr'); hdr.className='table-info fw-bold';
                hdr.innerHTML = `<td colspan="10">Branch: ${curB||''}</td>`; body.appendChild(hdr);
              }
              const tr=document.createElement('tr');
              tr.innerHTML = `
                <td>${r.branch||''}</td><td>${r.date||''}</td><td>${r.invoice_number||''}</td>
                <td>${r.item_name||''}</td><td>${Number(r.quantity||0)}</td>
                <td>${n2(r.price)}</td><td>${n2(r.discount)}</td><td>${n2(r.vat)}</td>
                <td>${n2(r.total)}</td><td>${r.payment_method||''}</td>`;
              body.appendChild(tr);
              const b=r.branch||''; const t=totalsByB[b]||(totalsByB[b]={amount:0,discount:0,vat:0,total:0});
              t.amount+=Number(r.price||0); t.discount+=Number(r.discount||0); t.vat+=Number(r.vat||0); t.total+=Number(r.total||0);
              overall.amount+=Number(r.price||0); overall.discount+=Number(r.discount||0); overall.vat+=Number(r.vat||0); overall.total+=Number(r.total||0);
            });
            Object.keys(totalsByB).sort().forEach(b=>{
              const t=totalsByB[b]; const tr=document.createElement('tr'); tr.className='table-warning fw-bold';
              tr.innerHTML=`<td colspan="5" class="text-end">Branch Totals (${b}):</td>
                <td>${n2(t.amount)}</td><td>${n2(t.discount)}</td><td>${n2(t.vat)}</td><td>${n2(t.total)}</td><td></td>`;
              foot.appendChild(tr);
            });
            const tro=document.createElement('tr'); tro.className='table-secondary fw-bold';
            tro.innerHTML=`<td colspan="5" class="text-end">Overall Totals:</td>
              <td>${n2((data.overall_totals||data.summary||overall).amount||overall.amount)}</td>
              <td>${n2((data.overall_totals||data.summary||overall).discount||overall.discount)}</td>
              <td>${n2((data.overall_totals||data.summary||overall).vat||overall.vat)}</td>
              <td>${n2((data.overall_totals||data.summary||overall).total||overall.total)}</td><td></td>`;
            foot.appendChild(tro);
          }).catch(err=> console.error('loadDetSales failed', err));
      }

      function loadDetPurch(){
        const qs = buildQS().replace(/(^\?|&)branch=[^&]*/,'').replace('??','?');
        fetch('/api/reports/all-purchases'+qs, {credentials:'same-origin'})
          .then(r=>r.json()).then(data=>{
            const body=document.getElementById('det-pur-body'); const foot=document.getElementById('det-pur-foot');
            if(!body||!foot) return; body.innerHTML=''; foot.innerHTML='';
            // Group purchases by invoice number (and payment/date) and show items under one invoice row
            const groups = {};
            (data.purchases||[]).forEach(r=>{
              const key = `${r.invoice_number||''}|${r.payment_method||''}|${r.date||''}`;
              if(!groups[key]){
                groups[key] = { date: r.date||'', invoice_number: r.invoice_number||'', payment_method: r.payment_method||'',
                  items: [], totals: { qty: 0, amount: 0, discount: 0, vat: 0, total: 0 } };
              }
              groups[key].items.push({ item: r.item||r.item_name||'', quantity: Number(r.quantity||0), amount: Number(r.amount||0), discount: Number(r.discount||0), vat: Number(r.vat||0), total: Number(r.total||0) });
              groups[key].totals.qty += Number(r.quantity||0);
              groups[key].totals.amount += Number(r.amount||0);
              groups[key].totals.discount += Number(r.discount||0);
              groups[key].totals.vat += Number(r.vat||0);
              groups[key].totals.total += Number(r.total||0);
            });
            Object.values(groups).forEach((g,idx)=>{
              const tr = document.createElement('tr');
              tr.className = 'table-row-summary';
              const btnId = `pur_items_${idx}`;
              tr.innerHTML = `
                <td>${g.date}</td>
                <td><button class="btn btn-sm btn-link p-0" type="button" data-target="#${btnId}">ðŸ”½</button> ${g.invoice_number}</td>
                <td>${g.items.length} item(s)</td>
                <td>${Number(g.totals.qty)}</td>
                <td>${n2(g.totals.amount)}</td>
                <td>${n2(g.totals.discount)}</td>
                <td>${n2(g.totals.vat)}</td>
                <td>${n2(g.totals.total)}</td>
                <td>${g.payment_method||''}</td>`;
              body.appendChild(tr);
              const dtr = document.createElement('tr');
              dtr.className = 'table-row-details';
              dtr.innerHTML = `<td colspan="9">
                <div id="${btnId}" style="display:none;">
                  <div class="table-responsive screen-table-wrap">
                    <table class="table table-sm table-bordered table-hover mb-0 screen-table">
                      <thead class="table-light">
                        <tr><th>Item</th><th>Qty</th><th>Amount</th><th>Discount</th><th>VAT</th><th>Total</th></tr>
                      </thead>
                      <tbody>
                        ${g.items.map(it=>`<tr>
                          <td>${it.item||''}</td>
                          <td>${Number(it.quantity)}</td>
                          <td>${n2(it.amount)}</td>
                          <td>${n2(it.discount)}</td>
                          <td>${n2(it.vat)}</td>
                          <td>${n2(it.total)}</td>
                        </tr>`).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              </td>`;
              body.appendChild(dtr);
            });
            // Toggle details
            body.addEventListener('click', function(ev){
              const btn = ev.target.closest('button[data-target]');
              if(!btn) return;
              const sel = btn.getAttribute('data-target');
              const panel = body.querySelector(sel);
              if(panel){ panel.style.display = (panel.style.display==='none'||panel.style.display==='') ? 'block' : 'none'; }
            });
            const o=data.overall_totals||{amount:0,discount:0,vat:0,total:0};
            const tro=document.createElement('tr'); tro.className='table-secondary fw-bold';
            tro.innerHTML=`<td colspan="4" class="text-end">Overall Totals:</td>
              <td>${n2(o.amount)}</td><td>${n2(o.discount)}</td><td>${n2(o.vat)}</td><td>${n2(o.total)}</td><td></td>`;
            foot.appendChild(tro);
          }).catch(err=> console.error('loadDetPurch failed', err));
      }

      window.exportInvoicesDetailedCSV = function(){
        try{
          const qs = (typeof buildQS === 'function') ? buildQS() : '';
          fetch('/api/all-invoices'+qs, {credentials:'same-origin'})
            .then(r=>r.json())
            .then(data=>{
              const header = ['Branch','Date','Invoice No.','Item','Qty','Amount','Discount','VAT','Total','Payment'];
              const rows = [header.join(',')];
              (data.invoices||[]).forEach(r=>{
                const vals = [
                  r.branch||'', r.date||'', r.invoice_number||'', r.item_name||'',
                  Number(r.quantity||0), Number(r.amount||r.price||0), Number(r.discount||0), Number(r.vat||0), Number(r.total||0),
                  r.payment_method||''
                ].map(v=>{
                  const s = String(v);
                  return /[",\n]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s;
                });
                rows.push(vals.join(','));
              });
              const blob = new Blob([rows.join('\n')], {type: 'text/csv;charset=utf-8;'});
              const a = document.createElement('a');
              a.href = URL.createObjectURL(blob);
              const today = new Date().toISOString().slice(0,10);
              a.download = `all_invoices_detailed_${today}.csv`;
              document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
            }).catch(e=> console.error('Export detailed CSV failed', e));
        }catch(e){ console.error('Export detailed CSV failed', e); }
      };

      window.exportInvoicesCSV = function(){
        try{
          const rows = [];
          const header = ['#','Invoice No','Type','Customer/Supplier','Total','Paid','Remaining','Status','Due Date'];
          rows.push(header.join(','));
          document.querySelectorAll('#invoice-list tr').forEach(tr=>{
            const tds = tr.querySelectorAll('td');
            const pick = [0,1,2,3,4,5,6,7,8];
            const vals = pick.map(i=>{
              let txt = (tds[i] && tds[i].innerText) ? tds[i].innerText : '';
              txt = txt.replace(/\s+/g,' ').trim();
              if (/[",\n]/.test(txt)) txt = '"' + txt.replace(/"/g,'""') + '"';
              return txt;
            });
            rows.push(vals.join(','));
          });
          const blob = new Blob([rows.join('\n')], {type: 'text/csv;charset=utf-8;'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          const today = new Date().toISOString().slice(0,10);
          a.download = `all_invoices_${today}.csv`;
          document.body.appendChild(a);
          a.click();
          URL.revokeObjectURL(a.href);
          a.remove();
        }catch(e){ console.error('Export CSV failed', e); }
      };

      function loadDetExp(){
        const qs = buildQS().replace(/(^\?|&)branch=[^&]*/,'').replace('??','?');
        fetch('/api/all-expenses'+qs, {credentials:'same-origin'})
          .then(r=>r.json()).then(data=>{
            const body=document.getElementById('det-exp-body'); const foot=document.getElementById('det-exp-foot');
            if(!body||!foot) return; body.innerHTML=''; foot.innerHTML='';
            (data.expenses||[]).forEach((r,idx)=>{
              const items = r.items||[]; const panelId = 'exp-items-'+idx;
              const tr=document.createElement('tr');
              tr.innerHTML = `
                <td>${r.date||''}</td>
                <td>${r.expense_number||''}</td>
                <td>
                  <button class="btn btn-sm btn-outline-primary" type="button" data-target="#${panelId}">Show Items (${items.length})</button>
                  <div id="${panelId}" class="mt-2" style="display:none;">
                    <div class="table-responsive screen-table-wrap">
                      <table class="table table-sm table-bordered table-hover screen-table">
                        <thead class="table-light"><tr>
                          <th>Description</th><th>Qty</th><th>Price</th><th>Tax</th><th>Discount</th><th>Total</th>
                        </tr></thead>
                        <tbody>
                          ${items.map(it=>`<tr>
                            <td>${it.description||''}</td>
                            <td>${n2(it.quantity||0)}</td>
                            <td>${n2(it.price||0)}</td>
                            <td>${n2(it.tax||0)}</td>
                            <td>${n2(it.discount||0)}</td>
                            <td>${n2(it.total||0)}</td>
                          </tr>`).join('')}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </td>
                <td>${n2(r.amount)}</td>
                <td>${r.payment_method||''}</td>`;
              body.appendChild(tr);
              const btn = tr.querySelector('button[data-target]');
              const panel = tr.querySelector(btn?.getAttribute('data-target'));
              btn?.addEventListener('click', ()=>{
                if(panel){ panel.style.display = (panel.style.display==='none'||panel.style.display==='') ? 'block' : 'none'; }
              });
            });
            const o=data.overall_totals||{amount:0};
            const tro=document.createElement('tr'); tro.className='table-secondary fw-bold';
            tro.innerHTML=`<td colspan="3" class="text-end">Total Expenses:</td><td>${n2(o.amount)}</td><td></td>`;
            foot.appendChild(tro);
          }).catch(err=> console.error('loadDetExp failed', err));
      }

      function reloadAll(){
        if(CURRENT_TYPE==='sales'||CURRENT_TYPE==='all') loadDetSales();
        if(CURRENT_TYPE==='purchases'||CURRENT_TYPE==='all') loadDetPurch();
        if(CURRENT_TYPE==='expenses'||CURRENT_TYPE==='all') loadDetExp();
      }
      document.getElementById('btnApplyFilters')?.addEventListener('click', function(ev){ ev.preventDefault(); reloadAll(); });

      function openPrint(urlBase, dropBranch){
        let qs = buildQS();
        if(dropBranch){ qs = qs.replace(/(^\?|&)branch=[^&]*/,'').replace('??','?'); }
        window.open(urlBase + qs, '_blank');
      }
      document.getElementById('btnPrintSales')?.addEventListener('click', function(){ openPrint('/reports/print/all-invoices/sales', false); });
      document.getElementById('btnPrintPurch')?.addEventListener('click', function(){ openPrint('/reports/print/all-invoices/purchases', true); });
      document.getElementById('btnPrintExp')?.addEventListener('click', function(){ openPrint('/reports/print/all-invoices/expenses', true); });
      document.getElementById('btnExportSalesDet')?.addEventListener('click', function(){
        const body = document.getElementById('det-sales-body'); const foot = document.getElementById('det-sales-foot');
        const rows = [['Branch','Date','Invoice No.','Item','Qty','Amount','Discount','VAT','Total','Payment']];
        let amt=0, disc=0, vat=0, tot=0;
        body?.querySelectorAll('tr').forEach(tr=>{
          const tds = Array.from(tr.children).map(td=> td.textContent.trim());
          if(tds.length===10 && !tr.classList.contains('table-info')){
            rows.push(tds);
            amt += Number(tds[5]||0); disc += Number(tds[6]||0); vat += Number(tds[7]||0); tot += Number(tds[8]||0);
          }
        });
        rows.push([]);
        rows.push(['Totals','','','','', Number(amt.toFixed(2)), Number(disc.toFixed(2)), Number(vat.toFixed(2)), Number(tot.toFixed(2)), '']);
        const csv = rows.map(r=> r.map(x=> String(x).includes(',') ? '"'+String(x).replaceAll('"','""')+'"' : String(x)).join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'sales_detail.csv'; a.click();
      });
      document.getElementById('btnExportPurchDet')?.addEventListener('click', function(){
        const body = document.getElementById('det-pur-body'); const rows = [['Date','Invoice No.','Items','Qty','Amount','Discount','VAT','Total','Payment']];
        let amt=0, disc=0, vat=0, tot=0, qty=0;
        body?.querySelectorAll('tr.table-row-summary').forEach(tr=>{
          const tds = Array.from(tr.children).map(td=> td.textContent.trim());
          if(tds.length===9){ rows.push(tds); qty+=Number(tds[3]||0); amt+=Number(tds[4]||0); disc+=Number(tds[5]||0); vat+=Number(tds[6]||0); tot+=Number(tds[7]||0); }
        });
        rows.push([]);
        rows.push(['Totals','','', Number(qty), Number(amt.toFixed(2)), Number(disc.toFixed(2)), Number(vat.toFixed(2)), Number(tot.toFixed(2)), '']);
        const csv = rows.map(r=> r.map(x=> String(x).includes(',') ? '"'+String(x).replaceAll('"','""')+'"' : String(x)).join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'purchases_detail.csv'; a.click();
      });
      document.getElementById('btnExportExpDet')?.addEventListener('click', function(){
        const body = document.getElementById('det-exp-body'); const rows = [['Date','Expense No.','Amount','Payment']];
        let amt=0;
        body?.querySelectorAll('tr').forEach(tr=>{
          const tds = Array.from(tr.children).map(td=> td.textContent.trim());
          if(tds.length===5){ rows.push([tds[0], tds[1], tds[3], tds[4]]); amt+=Number(tds[3]||0); }
        });
        rows.push([]);
        rows.push(['Totals','','', Number(amt.toFixed(2))]);
        const csv = rows.map(r=> r.map(x=> String(x).includes(',') ? '"'+String(x).replaceAll('"','""')+'"' : String(x)).join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'expenses_detail.csv'; a.click();
      });
      document.getElementById('btnPrintAll')?.addEventListener('click', function(ev){
        ev.preventDefault();
        const t = '{{ current_type }}';
        let base = '/reports/print/all-invoices/sales';
        let dropBranch = false;
        if(t==='purchases'){ base='/reports/print/all-invoices/purchases'; dropBranch=true; }
        else if(t==='expenses'){ base='/reports/print/all-invoices/expenses'; dropBranch=true; }
        openPrint(base, dropBranch);
      });

      if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', reloadAll); } else { reloadAll(); }
    })();
  </script>

<!-- SocketIO for real-time updates (optional) -->
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
    var socket = io();
    socket.on('invoice_update', function(data) {
        console.log('Invoice updated:', data);
        location.reload();
    });
</script>

{% endblock %}
