{% extends 'base.html' %}
{% set back_url = url_for('main.dashboard') %}

{% block title %}{{ _('All Invoices / ÙƒÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±') }}{% endblock %}
{% block content %}

<style>
body {
  background: #f4f6f9;
}
.invoice-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0px 4px 8px rgba(0,0,0,0.05);
  padding: 1.5rem;
  margin-bottom: 1rem;
}
.status-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: bold;
}
.status-pending { background: #ffeaa7; color: #2d3436; }
.status-partial { background: #fab1a0; color: #2d3436; }
.status-paid { background: #00b894; color: white; }
.nav-buttons {
  background: white;
  border-radius: 12px;
  padding: 1rem;
  margin-bottom: 1rem;
  box-shadow: 0px 2px 4px rgba(0,0,0,0.05);
}
</style>

<div class="container py-4">
    <div class="section-header mb-3">
      <h3 class="mb-0">{{ _('All Invoices / ÙƒÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±') }}</h3>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ -->
    <div class="nav-buttons">
        <div class="row">
            <div class="col-md-8">
                <a href="{{ url_for('main.invoices', type='sales') }}"
                   class="btn btn-outline-primary me-2 {{ 'active' if current_type == 'sales' else '' }}">
                   {{ _('Sales / Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª') }}
                </a>
                <a href="{{ url_for('main.invoices', type='purchases') }}"
                   class="btn btn-outline-primary me-2 {{ 'active' if current_type == 'purchases' else '' }}">
                   {{ _('Purchases / Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª') }}
                </a>
                <a href="{{ url_for('main.invoices', type='expenses') }}"
                   class="btn btn-outline-primary me-2 {{ 'active' if current_type == 'expenses' else '' }}">
                   {{ _('Expenses / Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª') }}
                </a>
                <a href="{{ url_for('main.invoices', type='all') }}"
                   class="btn btn-outline-secondary {{ 'active' if current_type == 'all' else '' }}">
                   {{ _('All / Ø§Ù„ÙƒÙ„') }}
                </a>
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group" role="group">
                  <a href="#" id="btnPrintAll" class="btn btn-success" target="_blank">ğŸ“„ {{ _('Print All / Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„') }}</a>
                  {% if current_type in ['sales','all'] %}
                  <button class="btn btn-primary" id="btnMarkSalesPaid">âœ… {{ _('Mark Sales Paid / ØªØ±Ø­ÙŠÙ„ Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒÙ…Ø¯ÙÙˆØ¹Ø©') }}</button>
                  {% endif %}
                  <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">ğŸ—‘ï¸ {{ _('Delete / Ø­Ø°Ù') }}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed View / Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ (moved to top) -->
    <div class="invoice-card mt-2">
      <h4 class="mb-3">Detailed View / Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h4>
      <div class="row g-2 mb-3">
        <div class="col-md-3">
          <label class="form-label">Start Date</label>
          <input type="date" id="detStart" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label">End Date</label>
          <input type="date" id="detEnd" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label">Payment Method</label>
          <select id="detPM" class="form-select">
            <option value="all" selected>All</option>
            <option value="cash">Cash</option>
            <option value="card">Card</option>
            <option value="bank">Bank</option>
            <option value="online">Online</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Branch (Sales)</label>
          <select id="detBranch" class="form-select">
            <option value="all" selected>All</option>
            <option value="china_town">China Town</option>
            <option value="place_india">Palace India</option>
          </select>
        </div>
      </div>
        <div class="mb-3 text-end">
          <button id="btnApplyFilters" class="btn btn-primary btn-sm">Apply Filters</button>
        </div>
        <p class="text-muted">Sales are auto-paid except platform orders (HUNGER/KEETA) which remain Unpaid. Purchases and Expenses reflect user-recorded payments.</p>
        <div class="d-flex gap-2 mb-3">
          <button id="btnNormalizePlatform" class="btn btn-sm btn-outline-warning">Normalize Platform Sales (set HUNGER/KEETA unpaid)</button>
          <div class="d-flex align-items-center gap-2">
            <label class="form-label mb-0">Batch Pay Sales:</label>
            <select id="bpCustomer" class="form-select form-select-sm" style="width:auto">
              <option value="all">All</option>
              <option value="hunger">HUNGER</option>
              <option value="keeta">KEETA</option>
            </select>
            <select id="bpMethod" class="form-select form-select-sm" style="width:auto">
              <option value="CASH">CASH</option>
              <option value="CARD">CARD</option>
              <option value="BANK">BANK</option>
            </select>
            <button id="btnBatchPaySales" class="btn btn-sm btn-success">Run Batch Pay</button>
          </div>
        </div>

      <!-- Sales Detailed -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">Sales Invoices (Itemized, grouped by Branch)</h6>
          <div>
            <button id="btnPrintSales" class="btn btn-sm btn-outline-dark">Print</button>
            <button id="btnExportSalesDet" class="btn btn-sm btn-primary ms-2">Export</button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-sm table-bordered table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Branch</th>
                <th>Date</th>
                <th>Invoice No.</th>
                <th>Item</th>
                <th>Qty</th>
                <th>Amount</th>
                <th>Discount</th>
                <th>VAT</th>
                <th>Total</th>
                <th>Payment</th>
              </tr>
            </thead>
            <tbody id="det-sales-body"></tbody>
            <tfoot id="det-sales-foot"></tfoot>
          </table>
        </div>
      </div>

      <!-- Purchases Detailed -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">Purchase Invoices (Itemized)</h6>
          <div>
            <button id="btnPrintPurch" class="btn btn-sm btn-outline-dark">Print</button>
            <button id="btnExportPurchDet" class="btn btn-sm btn-primary ms-2">Export</button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-sm table-bordered table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Invoice No.</th>
                <th>Item</th>
                <th>Qty</th>
                <th>Amount</th>
                <th>Discount</th>
                <th>VAT</th>
                <th>Total</th>
                <th>Payment</th>
              </tr>
            </thead>
            <tbody id="det-pur-body"></tbody>
            <tfoot id="det-pur-foot"></tfoot>
          </table>
        </div>
      </div>

      <!-- Expenses Detailed -->
      <div>
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">Expenses (Itemized)</h6>
          <div>
            <button id="btnPrintExp" class="btn btn-sm btn-outline-dark">Print</button>
            <button id="btnExportExpDet" class="btn btn-sm btn-primary ms-2">Export</button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-sm table-bordered table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Expense No.</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Payment</th>
              </tr>
            </thead>
            <tbody id="det-exp-body"></tbody>
            <tfoot id="det-exp-foot"></tfoot>
          </table>
        </div>
      </div>
    </div>


    {% if invoices %}
    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ -->
    <div class="invoice-card">
        <form method="post" action="#">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

            <div class="d-flex justify-content-end mb-2 gap-2">
              <button type="button" class="btn btn-sm btn-outline-success" onclick="exportInvoicesCSV()">Export CSV</button>
              <button type="button" class="btn btn-sm btn-outline-primary" onclick="exportInvoicesDetailedCSV()">Export Detailed CSV</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th><input type="checkbox" id="select-all"></th>
                            <th>#</th>
                            <th>{{ _('Invoice No') }}</th>
                            <th>{{ _('Type') }}</th>
                            <th>{{ _('Customer/Supplier') }}</th>
                            <th>{{ _('Total') }}</th>
                            <th>{{ _('Paid') }}</th>
                            <th>{{ _('Remaining') }}</th>
                            <th>{{ _('Status') }}</th>
                            <th>{{ _('Due Date') }}</th>
                            <th>{{ _('Pay') }}</th>
                            <th>{{ _('View') }}</th>
                            <th>{{ _('Actions / Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª') }}</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-list">
                        {% for invoice in invoices %}
                        <tr>
                            <td><input type="checkbox" name="invoice_ids" value="{{ invoice.id }}"></td>
                            <td>{{ loop.index }}</td>
                            <td><strong>{{ invoice.invoice_number }}</strong></td>
                            <td>
                                <span class="badge bg-secondary">{{ invoice.invoice_type.title() }}</span>
                            </td>
                            <td>{{ invoice.customer_supplier }}</td>
                            <td>${{ "%.2f"|format(invoice.total_amount) }}</td>
                            <td>${{ "%.2f"|format(invoice.paid_amount) }}</td>
                            <td>${{ "%.2f"|format(invoice.remaining_amount) }}</td>
                            <td>
                                <span class="status-badge status-{{ invoice.status }}">
                                    {{ invoice.status.title() }}
                                </span>
                            </td>
                            <td>{{ invoice.due_date.strftime('%Y-%m-%d') if invoice.due_date else '-' }}</td>
                            <td>
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                                {% if invoice.status != 'paid' %}
                                    <input type="number" step="0.01" class="form-control form-control-sm me-1 rowPaymentAmount"
                                           placeholder="Amount" max="{{ invoice.remaining_amount }}" value="{{ '%.2f'|format(invoice.remaining_amount) }}">
                                    <button type="button" class="btn btn-sm btn-primary btn-row-pay" data-invoice-id="{{ invoice.id }}" data-method="CASH">{{ _('Pay') }}</button>
                                {% else %}
                                    <span class="text-success">âœ“ {{ _('Paid') }}</span>
                                {% endif %}

                                </td>
                            <td>
                                  <a class="btn btn-sm btn-outline-secondary" href="#">{{ _('View / Ø¹Ø±Ø¶') }}</a>
                            </td>
                            <td>
                              <button type="button" class="btn btn-sm btn-outline-danger btn-row-delete" data-invoice-id="{{ invoice.id }}" data-invoice-type="{{ invoice.invoice_type }}">ğŸ—‘ï¸ {{ _('Delete / Ø­Ø°Ù') }}</button>
                            </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" step="0.01" name="bulk_payment_amount"
                               placeholder="{{ _('Total Amount for Selected') }}"
                               class="form-control" required>
                        <button type="submit" class="btn btn-warning">
                            ğŸ’³ {{ _('Pay Selected / Ø¯ÙØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯') }}
                        </button>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <small class="text-muted">
                        {{ _('Select invoices and enter total amount to distribute payment equally') }}
                    </small>
                </div>
            </div>
        </form>
    </div>
    {% else %}
    <div class="invoice-card text-center">
        <h5>{{ _('No invoices found / Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ±') }}</h5>
        <p class="text-muted">{{ _('Create your first invoice to get started / Ø£Ù†Ø´Ø¦ Ø£ÙˆÙ„ ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø¨Ø¯Ø¡') }}</p>
    </div>
    {% endif %}
</div>


    <!-- Delete Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">

  <script>
    // Detailed view loaders with filters
    (function(){
      function n2(x){ try{return Number(x||0).toFixed(2);}catch(e){return '0.00';} }
      function enc(s){ return encodeURIComponent(s||''); }
      function buildQS(){
        const s = document.getElementById('detStart')?.value || '';
        const e = document.getElementById('detEnd')?.value || '';
        const pm = (document.getElementById('detPM')?.value || 'all');
        const br = (document.getElementById('detBranch')?.value || 'all');
        const parts = [];
        if(s) parts.push('start_date='+enc(s));
        if(e) parts.push('end_date='+enc(e));
        if(pm && pm!=='all') parts.push('payment_method='+enc(pm));
        if(br && br!=='all') parts.push('branch='+enc(br));
        return parts.length ? ('?'+parts.join('&')) : '';
      }

      function loadDetSales(){
        const qs = buildQS();
        fetch('/api/all-invoices'+qs, {credentials:'same-origin'})
          .then(r=>r.json()).then(data=>{
            const body = document.getElementById('det-sales-body');
            const foot = document.getElementById('det-sales-foot');
            if(!body||!foot) return; body.innerHTML=''; foot.innerHTML='';
            const rows = (data.invoices||[]).filter(r=> (r.branch||'')!=='Purchases' && (r.branch||'')!=='Expenses')
              .sort((a,b)=> (a.branch||'').localeCompare(b.branch||'') || (b.date||'').localeCompare(a.date||''));
            let curB=null; const totalsByB={}; let overall={amount:0,discount:0,vat:0,total:0};
            rows.forEach(r=>{
              if(r.branch!==curB){
                curB=r.branch; const hdr=document.createElement('tr'); hdr.className='table-info fw-bold';
                hdr.innerHTML = `<td colspan="10">Branch: ${curB||''}</td>`; body.appendChild(hdr);
              }
              const tr=document.createElement('tr');
              tr.innerHTML = `
                <td>${r.branch||''}</td><td>${r.date||''}</td><td>${r.invoice_number||''}</td>
                <td>${r.item_name||''}</td><td>${Number(r.quantity||0)}</td>
                <td>${n2(r.price)}</td><td>${n2(r.discount)}</td><td>${n2(r.vat)}</td>
                <td>${n2(r.total)}</td><td>${r.payment_method||''}</td>`;
              body.appendChild(tr);
              const b=r.branch||''; const t=totalsByB[b]||(totalsByB[b]={amount:0,discount:0,vat:0,total:0});
              t.amount+=Number(r.price||0); t.discount+=Number(r.discount||0); t.vat+=Number(r.vat||0); t.total+=Number(r.total||0);
              overall.amount+=Number(r.price||0); overall.discount+=Number(r.discount||0); overall.vat+=Number(r.vat||0); overall.total+=Number(r.total||0);
            });
            Object.keys(totalsByB).sort().forEach(b=>{
              const t=totalsByB[b]; const tr=document.createElement('tr'); tr.className='table-warning fw-bold';
              tr.innerHTML=`<td colspan="5" class="text-end">Branch Totals (${b}):</td>
                <td>${n2(t.amount)}</td><td>${n2(t.discount)}</td><td>${n2(t.vat)}</td><td>${n2(t.total)}</td><td></td>`;
              foot.appendChild(tr);
            });
            const tro=document.createElement('tr'); tro.className='table-secondary fw-bold';
            tro.innerHTML=`<td colspan="5" class="text-end">Overall Totals:</td>
              <td>${n2((data.overall_totals||data.summary||overall).amount||overall.amount)}</td>
              <td>${n2((data.overall_totals||data.summary||overall).discount||overall.discount)}</td>
              <td>${n2((data.overall_totals||data.summary||overall).vat||overall.vat)}</td>
              <td>${n2((data.overall_totals||data.summary||overall).total||overall.total)}</td><td></td>`;
            foot.appendChild(tro);
          }).catch(err=> console.error('loadDetSales failed', err));
      }

      function loadDetPurch(){
        const qs = buildQS().replace(/(^\?|&)branch=[^&]*/,'').replace('??','?');
        fetch('/api/reports/all-purchases'+qs, {credentials:'same-origin'})
          .then(r=>r.json()).then(data=>{
            const body=document.getElementById('det-pur-body'); const foot=document.getElementById('det-pur-foot');
            if(!body||!foot) return; body.innerHTML=''; foot.innerHTML='';
            // Group purchases by invoice number (and payment/date) and show items under one invoice row
            const groups = {};
            (data.purchases||[]).forEach(r=>{
              const key = `${r.invoice_number||''}|${r.payment_method||''}|${r.date||''}`;
              if(!groups[key]){
                groups[key] = { date: r.date||'', invoice_number: r.invoice_number||'', payment_method: r.payment_method||'',
                  items: [], totals: { qty: 0, amount: 0, discount: 0, vat: 0, total: 0 } };
              }
              groups[key].items.push({ item: r.item||r.item_name||'', quantity: Number(r.quantity||0), amount: Number(r.amount||0), discount: Number(r.discount||0), vat: Number(r.vat||0), total: Number(r.total||0) });
              groups[key].totals.qty += Number(r.quantity||0);
              groups[key].totals.amount += Number(r.amount||0);
              groups[key].totals.discount += Number(r.discount||0);
              groups[key].totals.vat += Number(r.vat||0);
              groups[key].totals.total += Number(r.total||0);
            });
            Object.values(groups).forEach((g,idx)=>{
              const tr = document.createElement('tr');
              tr.className = 'table-row-summary';
              const btnId = `pur_items_${idx}`;
              tr.innerHTML = `
                <td>${g.date}</td>
                <td><button class="btn btn-sm btn-link p-0" type="button" data-target="#${btnId}">ğŸ”½</button> ${g.invoice_number}</td>
                <td>${g.items.length} item(s)</td>
                <td>${Number(g.totals.qty)}</td>
                <td>${n2(g.totals.amount)}</td>
                <td>${n2(g.totals.discount)}</td>
                <td>${n2(g.totals.vat)}</td>
                <td>${n2(g.totals.total)}</td>
                <td>${g.payment_method||''}</td>`;
              body.appendChild(tr);
              const dtr = document.createElement('tr');
              dtr.className = 'table-row-details';
              dtr.innerHTML = `<td colspan="9">
                <div id="${btnId}" style="display:none;">
                  <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-0">
                      <thead class="table-light">
                        <tr><th>Item</th><th>Qty</th><th>Amount</th><th>Discount</th><th>VAT</th><th>Total</th></tr>
                      </thead>
                      <tbody>
                        ${g.items.map(it=>`<tr>
                          <td>${it.item||''}</td>
                          <td>${Number(it.quantity)}</td>
                          <td>${n2(it.amount)}</td>
                          <td>${n2(it.discount)}</td>
                          <td>${n2(it.vat)}</td>
                          <td>${n2(it.total)}</td>
                        </tr>`).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              </td>`;
              body.appendChild(dtr);
            });
            // Toggle details
            body.addEventListener('click', function(ev){
              const btn = ev.target.closest('button[data-target]');
              if(!btn) return;
              const sel = btn.getAttribute('data-target');
              const panel = body.querySelector(sel);
              if(panel){ panel.style.display = (panel.style.display==='none'||panel.style.display==='') ? 'block' : 'none'; }
            });
            const o=data.overall_totals||{amount:0,discount:0,vat:0,total:0};
            const tro=document.createElement('tr'); tro.className='table-secondary fw-bold';
            tro.innerHTML=`<td colspan="4" class="text-end">Overall Totals:</td>
              <td>${n2(o.amount)}</td><td>${n2(o.discount)}</td><td>${n2(o.vat)}</td><td>${n2(o.total)}</td><td></td>`;
            foot.appendChild(tro);
          }).catch(err=> console.error('loadDetPurch failed', err));
      }

      window.exportInvoicesDetailedCSV = function(){
        try{
          const qs = (typeof buildQS === 'function') ? buildQS() : '';
          fetch('/api/all-invoices'+qs, {credentials:'same-origin'})
            .then(r=>r.json())
            .then(data=>{
              const header = ['Branch','Date','Invoice No.','Item','Qty','Amount','Discount','VAT','Total','Payment'];
              const rows = [header.join(',')];
              (data.invoices||[]).forEach(r=>{
                const vals = [
                  r.branch||'', r.date||'', r.invoice_number||'', r.item_name||'',
                  Number(r.quantity||0), Number(r.amount||r.price||0), Number(r.discount||0), Number(r.vat||0), Number(r.total||0),
                  r.payment_method||''
                ].map(v=>{
                  const s = String(v);
                  return /[",\n]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s;
                });
                rows.push(vals.join(','));
              });
              const blob = new Blob([rows.join('\n')], {type: 'text/csv;charset=utf-8;'});
              const a = document.createElement('a');
              a.href = URL.createObjectURL(blob);
              const today = new Date().toISOString().slice(0,10);
              a.download = `all_invoices_detailed_${today}.csv`;
              document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
            }).catch(e=> console.error('Export detailed CSV failed', e));
        }catch(e){ console.error('Export detailed CSV failed', e); }
      };

      window.exportInvoicesCSV = function(){
        try{
          const rows = [];
          const header = ['#','Invoice No','Type','Customer/Supplier','Total','Paid','Remaining','Status','Due Date'];
          rows.push(header.join(','));
          document.querySelectorAll('#invoice-list tr').forEach(tr=>{
            const tds = tr.querySelectorAll('td');
            const pick = [1,2,3,4,5,6,7,8,9];
            const vals = pick.map(i=>{
              let txt = (tds[i] && tds[i].innerText) ? tds[i].innerText : '';
              txt = txt.replace(/\s+/g,' ').trim();
              if (/[",\n]/.test(txt)) txt = '"' + txt.replace(/"/g,'""') + '"';
              return txt;
            });
            rows.push(vals.join(','));
          });
          const blob = new Blob([rows.join('\n')], {type: 'text/csv;charset=utf-8;'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          const today = new Date().toISOString().slice(0,10);
          a.download = `all_invoices_${today}.csv`;
          document.body.appendChild(a);
          a.click();
          URL.revokeObjectURL(a.href);
          a.remove();
        }catch(e){ console.error('Export CSV failed', e); }
      };

      function loadDetExp(){
        const qs = buildQS().replace(/(^\?|&)branch=[^&]*/,'').replace('??','?');
        fetch('/api/all-expenses'+qs, {credentials:'same-origin'})
          .then(r=>r.json()).then(data=>{
            const body=document.getElementById('det-exp-body'); const foot=document.getElementById('det-exp-foot');
            if(!body||!foot) return; body.innerHTML=''; foot.innerHTML='';
            (data.expenses||[]).forEach((r,idx)=>{
              const items = r.items||[]; const panelId = 'exp-items-'+idx;
              const tr=document.createElement('tr');
              tr.innerHTML = `
                <td>${r.date||''}</td>
                <td>${r.expense_number||''}</td>
                <td>
                  <button class="btn btn-sm btn-outline-primary" type="button" data-target="#${panelId}">Show Items (${items.length})</button>
                  <div id="${panelId}" class="mt-2" style="display:none;">
                    <div class="table-responsive">
                      <table class="table table-sm table-bordered">
                        <thead class="table-light"><tr>
                          <th>Description</th><th>Qty</th><th>Price</th><th>Tax</th><th>Discount</th><th>Total</th>
                        </tr></thead>
                        <tbody>
                          ${items.map(it=>`<tr>
                            <td>${it.description||''}</td>
                            <td>${n2(it.quantity||0)}</td>
                            <td>${n2(it.price||0)}</td>
                            <td>${n2(it.tax||0)}</td>
                            <td>${n2(it.discount||0)}</td>
                            <td>${n2(it.total||0)}</td>
                          </tr>`).join('')}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </td>
                <td>${n2(r.amount)}</td>
                <td>${r.payment_method||''}</td>`;
              body.appendChild(tr);
              const btn = tr.querySelector('button[data-target]');
              const panel = tr.querySelector(btn?.getAttribute('data-target'));
              btn?.addEventListener('click', ()=>{
                if(panel){ panel.style.display = (panel.style.display==='none'||panel.style.display==='') ? 'block' : 'none'; }
              });
            });
            const o=data.overall_totals||{amount:0};
            const tro=document.createElement('tr'); tro.className='table-secondary fw-bold';
            tro.innerHTML=`<td colspan="3" class="text-end">Total Expenses:</td><td>${n2(o.amount)}</td><td></td>`;
            foot.appendChild(tro);
          }).catch(err=> console.error('loadDetExp failed', err));
      }

      function reloadAll(){ loadDetSales(); loadDetPurch(); loadDetExp(); }
      document.getElementById('btnApplyFilters')?.addEventListener('click', function(ev){ ev.preventDefault(); reloadAll(); });

      function openPrint(urlBase, dropBranch){
        let qs = buildQS();
        if(dropBranch){ qs = qs.replace(/(^\?|&)branch=[^&]*/,'').replace('??','?'); }
        window.open(urlBase + qs, '_blank');
      }
      document.getElementById('btnPrintSales')?.addEventListener('click', function(){ openPrint('/reports/print/all-invoices/sales', false); });
      document.getElementById('btnPrintPurch')?.addEventListener('click', function(){ openPrint('/reports/print/all-invoices/purchases', true); });
      document.getElementById('btnPrintExp')?.addEventListener('click', function(){ openPrint('/reports/print/all-invoices/expenses', true); });
      document.getElementById('btnExportSalesDet')?.addEventListener('click', function(){
        const body = document.getElementById('det-sales-body'); const foot = document.getElementById('det-sales-foot');
        const rows = [['Branch','Date','Invoice No.','Item','Qty','Amount','Discount','VAT','Total','Payment']];
        let amt=0, disc=0, vat=0, tot=0;
        body?.querySelectorAll('tr').forEach(tr=>{
          const tds = Array.from(tr.children).map(td=> td.textContent.trim());
          if(tds.length===10 && !tr.classList.contains('table-info')){
            rows.push(tds);
            amt += Number(tds[5]||0); disc += Number(tds[6]||0); vat += Number(tds[7]||0); tot += Number(tds[8]||0);
          }
        });
        rows.push([]);
        rows.push(['Totals','','','','', Number(amt.toFixed(2)), Number(disc.toFixed(2)), Number(vat.toFixed(2)), Number(tot.toFixed(2)), '']);
        const csv = rows.map(r=> r.map(x=> String(x).includes(',') ? '"'+String(x).replaceAll('"','""')+'"' : String(x)).join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'sales_detail.csv'; a.click();
      });
      document.getElementById('btnExportPurchDet')?.addEventListener('click', function(){
        const body = document.getElementById('det-pur-body'); const rows = [['Date','Invoice No.','Items','Qty','Amount','Discount','VAT','Total','Payment']];
        let amt=0, disc=0, vat=0, tot=0, qty=0;
        body?.querySelectorAll('tr.table-row-summary').forEach(tr=>{
          const tds = Array.from(tr.children).map(td=> td.textContent.trim());
          if(tds.length===9){ rows.push(tds); qty+=Number(tds[3]||0); amt+=Number(tds[4]||0); disc+=Number(tds[5]||0); vat+=Number(tds[6]||0); tot+=Number(tds[7]||0); }
        });
        rows.push([]);
        rows.push(['Totals','','', Number(qty), Number(amt.toFixed(2)), Number(disc.toFixed(2)), Number(vat.toFixed(2)), Number(tot.toFixed(2)), '']);
        const csv = rows.map(r=> r.map(x=> String(x).includes(',') ? '"'+String(x).replaceAll('"','""')+'"' : String(x)).join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'purchases_detail.csv'; a.click();
      });
      document.getElementById('btnExportExpDet')?.addEventListener('click', function(){
        const body = document.getElementById('det-exp-body'); const rows = [['Date','Expense No.','Amount','Payment']];
        let amt=0;
        body?.querySelectorAll('tr').forEach(tr=>{
          const tds = Array.from(tr.children).map(td=> td.textContent.trim());
          if(tds.length===5){ rows.push([tds[0], tds[1], tds[3], tds[4]]); amt+=Number(tds[3]||0); }
        });
        rows.push([]);
        rows.push(['Totals','','', Number(amt.toFixed(2))]);
        const csv = rows.map(r=> r.map(x=> String(x).includes(',') ? '"'+String(x).replaceAll('"','""')+'"' : String(x)).join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'expenses_detail.csv'; a.click();
      });
      document.getElementById('btnPrintAll')?.addEventListener('click', function(ev){
        ev.preventDefault();
        const t = '{{ current_type }}';
        let base = '/reports/print/all-invoices/sales';
        let dropBranch = false;
        if(t==='purchases'){ base='/reports/print/all-invoices/purchases'; dropBranch=true; }
        else if(t==='expenses'){ base='/reports/print/all-invoices/expenses'; dropBranch=true; }
        openPrint(base, dropBranch);
      });

      // Normalize platform sales: mark HUNGER/KEETA unpaid and remove payments
      document.getElementById('btnNormalizePlatform')?.addEventListener('click', async function(){
        if(!confirm('ØªØ·Ø¨ÙŠØ¹ ÙÙˆØ§ØªÙŠØ± Ù…Ù†ØµØ§Øª HUNGER/KEETA ÙƒØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©ØŸ')) return;
        try{
          const r = await fetch('/api/sales/mark-platform-unpaid', { method:'POST', headers:{'Accept':'application/json','X-CSRFToken':'{{ csrf_token() }}'} });
          const j = await r.json();
          alert('ØªÙ… ØªØ­Ø¯ÙŠØ« '+(j.updated||0)+' ÙØ§ØªÙˆØ±Ø© Ù…Ù†ØµØ©');
          location.reload();
        }catch(e){ alert('ÙØ´Ù„ Ø§Ù„ØªØ·Ø¨ÙŠØ¹: '+(e && e.message || e)); }
      });

      // Batch pay sales by customer filter
      document.getElementById('btnBatchPaySales')?.addEventListener('click', async function(){
        const cust = document.getElementById('bpCustomer')?.value || 'all';
        const method = document.getElementById('bpMethod')?.value || 'CASH';
        if(!confirm('ØªÙ†ÙÙŠØ° Ø¯ÙØ¹ Ø¬Ù…Ø§Ø¹ÙŠ Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ('+cust+')ØŸ')) return;
        try{
          const r = await fetch('/api/sales/batch-pay', {
            method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json','X-CSRFToken':'{{ csrf_token() }}'},
            body: JSON.stringify({ customer: cust, payment_method: method })
          });
          const j = await r.json();
          if(j && j.ok){ alert('ØªÙ… Ø¯ÙØ¹ '+(j.updated||0)+' ÙØ§ØªÙˆØ±Ø©'); location.reload(); }
          else{ alert('ÙØ´Ù„ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ: '+(j && j.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')); }
        }catch(e){ alert('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: '+(e && e.message || e)); }
      });

      // Mark all sales invoices as paid
      document.getElementById('btnMarkSalesPaid')?.addEventListener('click', async function(ev){
        ev.preventDefault();
        try{
          const r = await fetch('/api/sales/mark-unpaid-paid', { method:'POST', headers:{'Accept':'application/json','X-CSRFToken':'{{ csrf_token() }}'} });
          const ct = (r.headers.get('content-type')||'').toLowerCase();
          const j = ct.indexOf('application/json')!==-1 ? await r.json() : null;
          if(j && j.ok){ alert('ØªÙ… ØªØ­Ø¯ÙŠØ« '+(j.updated||0)+' ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª Ø¥Ù„Ù‰ Ù…Ø¯ÙÙˆØ¹Ø©'); location.reload(); }
          else{ alert('ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«: '+(j && j.error || (await r.text()) || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')); }
        }catch(err){ alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: '+err.message); }
      });


      if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', reloadAll); } else { reloadAll(); }
    })();
  </script>

          <form method="post" action="{{ url_for('main.invoices_delete') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="modal-header">
              <h5 class="modal-title">{{ _('Delete Invoices / Ø­Ø°Ù Ø§Ù„ÙÙˆØ§ØªÙŠØ±') }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-2">
                <label class="form-label">{{ _('Scope / Ø§Ù„Ù†Ø·Ø§Ù‚') }}</label>
                <select class="form-select" name="scope" id="del-scope">
                  <option value="selected">{{ _('Selected only / Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙ‚Ø·') }}</option>
                  <option value="type">{{ _('All in current type tab / ÙƒÙ„ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ') }}</option>
                </select>
              </div>
              <div class="mb-2">
                <label class="form-label">{{ _('Type / Ø§Ù„Ù†ÙˆØ¹') }}</label>
                <select class="form-select" name="invoice_type">
                  <option value="sales" {{ 'selected' if current_type=='sales' else '' }}>{{ _('Sales / Ù…Ø¨ÙŠØ¹Ø§Øª') }}</option>
                  <option value="purchases" {{ 'selected' if current_type=='purchases' else '' }}>{{ _('Purchases / Ù…Ø´ØªØ±ÙŠØ§Øª') }}</option>
                  <option value="expenses" {{ 'selected' if current_type=='expenses' else '' }}>{{ _('Expenses / Ù…ØµØ±ÙˆÙØ§Øª') }}</option>
                </select>
              </div>
              <div class="alert alert-warning small">{{ _('This action is irreversible. Related items and payments will be deleted as well. / Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡ ÙˆØ³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø£ÙŠØ¶Ø§Ù‹') }}</div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel / Ø¥Ù„ØºØ§Ø¡') }}</button>
              <button type="submit" class="btn btn-danger">{{ _('Delete / Ø­Ø°Ù') }}</button>
            </div>
            <!-- Include selected IDs as hidden fields dynamically before submit via JS -->
          </form>
        </div>
      </div>
    </div>


<!-- SocketIO and JavaScript -->
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
    // SocketIO for real-time updates
    var socket = io();
    socket.on('invoice_update', function(data) {
        console.log('Invoice updated:', data);
        // Reload page to show updates
        location.reload();
    });

    // Select all functionality
    document.getElementById('select-all').addEventListener('click', function() {
        let checkboxes = document.querySelectorAll('input[name="invoice_ids"]');
        checkboxes.forEach(cb => cb.checked = this.checked);
    });

    // Before submit delete form, inject selected ids as hidden fields
    const delModal = document.getElementById('deleteModal');
    if(delModal){
      delModal.addEventListener('show.bs.modal', function(){
        // nothing yet
      });
      delModal.addEventListener('shown.bs.modal', function(){
        // Focus
      });
      delModal.querySelector('form').addEventListener('submit', function(ev){
        const tbodyCbs = document.querySelectorAll('tbody#invoice-list input[name="invoice_ids"]:checked');
        // remove previous hidden inputs
        this.querySelectorAll('input[type="hidden"][name="invoice_ids"]').forEach(n=>n.remove());
        tbodyCbs.forEach(cb => {
          const i = document.createElement('input');
          i.type = 'hidden'; i.name = 'invoice_ids'; i.value = cb.value;
          this.appendChild(i);
        });
        // pass current tab type for safety
        const t = document.createElement('input'); t.type='hidden'; t.name='current_type'; t.value='{{ current_type }}'; this.appendChild(t);
      });
    }

    // Auto-calculate remaining amount for payment input
    document.querySelectorAll('input[name="payment_amount"]').forEach(input => {
        input.addEventListener('input', function() {
            const maxAmount = parseFloat(this.getAttribute('max'));
            if (parseFloat(this.value) > maxAmount) {
                this.value = maxAmount;
            }
        });
    });

    document.querySelectorAll('.btn-row-delete').forEach(btn => {
      btn.addEventListener('click', async function(){
        const id = this.getAttribute('data-invoice-id');
        const t = this.getAttribute('data-invoice-type');
        const ok = confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ');
        if(!ok) return;
        const body = new URLSearchParams({ scope: 'selected', invoice_type: t || 'sales', invoice_ids: String(id||'') });
        try{
          const r = await fetch('{{ url_for('main.invoices_delete') }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': '{{ csrf_token() }}' },
            body
          });
          if(r.redirected){ location.href = r.url; }
          else { location.reload(); }
        }catch(e){ alert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©: '+(e && e.message || e)); }
      });
    });
</script>

{% endblock %}
      document.querySelectorAll('.btn-row-pay').forEach(btn=>{
        btn.addEventListener('click', async function(){
          const td = this.closest('td');
          const input = td && td.querySelector('.rowPaymentAmount');
          const amt = parseFloat(input && input.value || '0');
          const id = this.getAttribute('data-invoice-id');
          const method = this.getAttribute('data-method') || 'CASH';
          if(!(amt>0)){ alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºØ§Ù‹ ØµØ§Ù„Ø­Ø§Ù‹'); return; }
          try{
            const r = await fetch('/api/sales/pay', { method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json','X-CSRFToken':'{{ csrf_token() }}'}, body: JSON.stringify({ invoice_id: id, amount: amt, payment_method: method }) });
            const j = await r.json();
            if(j && j.ok){ location.reload(); }
            else{ alert('ÙØ´Ù„ Ø§Ù„Ø¯ÙØ¹: '+(j && j.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')); }
          }catch(e){ alert('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: '+(e && e.message || e)); }
        });
      });

      // Event delegation fallback in case earlier JS errors prevented bindings
      document.addEventListener('click', async function(ev){
        const btn = ev.target && ev.target.closest && ev.target.closest('.btn-row-pay');
        if(!btn) return;
        ev.preventDefault();
        try{
          const td = btn.closest('td');
          const input = td && td.querySelector('.rowPaymentAmount');
          const amt = parseFloat(input && input.value || '0');
          const id = btn.getAttribute('data-invoice-id');
          const method = btn.getAttribute('data-method') || 'CASH';
          if(!(amt>0)){ alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºØ§Ù‹ ØµØ§Ù„Ø­Ø§Ù‹'); return; }
          const r = await fetch('/api/sales/pay', { method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json','X-CSRFToken':'{{ csrf_token() }}'}, body: JSON.stringify({ invoice_id: id, amount: amt, payment_method: method }) });
          const j = await r.json();
          if(j && j.ok){ location.reload(); }
          else{ alert('ÙØ´Ù„ Ø§Ù„Ø¯ÙØ¹: '+(j && j.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')); }
        }catch(e){ alert('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: '+(e && e.message || e)); }
      });
