<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>إعدادات الطاولات</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .settings-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            margin: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .branch-section {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .branch-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: -20px -20px 20px -20px;
            text-align: center;
        }

        .table-config {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }

        .table-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .table-item {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-size: 14px;
        }

        .btn-save {
            background: linear-gradient(135deg, #00b894, #00a085);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
            color: white;
        }

        .btn-reset {
            background: linear-gradient(135deg, #e17055, #d63031);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-reset:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(225, 112, 85, 0.3);
            color: white;
        }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .alert-success {
            background: linear-gradient(135deg, #00b894, #00a085);
            border: none;
            color: white;
            border-radius: 10px;
        }

        .alert-danger {
            background: linear-gradient(135deg, #e17055, #d63031);
            border: none;
            color: white;
            border-radius: 10px;
        }

        .numbering-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .numbering-option {
            flex: 1;
            min-width: 200px;
        }

        .custom-numbering {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="settings-container">
            <div class="row align-items-center mb-4">
                <div class="col-md-2">
                    <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-right me-2"></i>
                        العودة للوحة التحكم
                    </a>
                </div>
                <div class="col-md-8 text-center">
                    <h1 class="mb-0" style="background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 2.5rem; font-weight: bold;">
                        🪑 إعدادات الطاولات
                    </h1>
                </div>
                <div class="col-md-2 text-start">
                    <button class="btn btn-success" onclick="saveAllSettings()">
                        <i class="fas fa-save me-2"></i>
                        حفظ جميع الإعدادات
                    </button>
                </div>
            </div>

            <!-- Success/Error Messages -->
            <div id="messageContainer"></div>

            <!-- China Town Settings -->
            <div class="branch-section">
                <div class="branch-header">
                    <h3><i class="fas fa-dragon me-2"></i>🏮 China Town - إعدادات الطاولات</h3>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="table-config">
                            <h5><i class="fas fa-cog me-2"></i>إعدادات عامة</h5>

                            <div class="mb-3">
                                <label class="form-label">عدد الطاولات:</label>
                                <input type="number" class="form-control" id="chinaTableCount" min="1" max="50" value="20" onchange="updatePreview('china')">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">نظام الترقيم:</label>
                                <div class="numbering-options">
                                    <div class="numbering-option">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="chinaNumbering" id="chinaNumeric" value="numeric" checked onchange="updatePreview('china')">
                                            <label class="form-check-label" for="chinaNumeric">
                                                رقمي (1, 2, 3...)
                                            </label>
                                        </div>
                                    </div>
                                    <div class="numbering-option">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="chinaNumbering" id="chinaAlpha" value="alpha" onchange="updatePreview('china')">
                                            <label class="form-check-label" for="chinaAlpha">
                                                أبجدي (A, B, C...)
                                            </label>
                                        </div>
                                    </div>
                                    <div class="numbering-option">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="chinaNumbering" id="chinaCustom" value="custom" onchange="updatePreview('china')">
                                            <label class="form-check-label" for="chinaCustom">
                                                مخصص
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="custom-numbering" id="chinaCustomNumbering" style="display: none;">
                                <label class="form-label">أرقام الطاولات المخصصة (مفصولة بفواصل):</label>
                                <textarea class="form-control" id="chinaCustomNumbers" rows="3" placeholder="مثال: VIP-1, VIP-2, A1, A2, B1, B2" onchange="updatePreview('china')"></textarea>
                                <small class="text-muted">يمكنك استخدام أي نص أو رقم تريده</small>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h5><i class="fas fa-eye me-2"></i>معاينة الطاولات</h5>
                        <div class="table-preview" id="chinaPreview">
                            <!-- Tables will be generated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Palace India Settings -->
            <div class="branch-section">
                <div class="branch-header">
                    <h3><i class="fas fa-mosque me-2"></i>🏰 Palace India - إعدادات الطاولات</h3>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="table-config">
                            <h5><i class="fas fa-cog me-2"></i>إعدادات عامة</h5>

                            <div class="mb-3">
                                <label class="form-label">عدد الطاولات:</label>
                                <input type="number" class="form-control" id="indiaTableCount" min="1" max="50" value="20" onchange="updatePreview('india')">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">نظام الترقيم:</label>
                                <div class="numbering-options">
                                    <div class="numbering-option">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="indiaNumbering" id="indiaNumeric" value="numeric" checked onchange="updatePreview('india')">
                                            <label class="form-check-label" for="indiaNumeric">
                                                رقمي (1, 2, 3...)
                                            </label>
                                        </div>
                                    </div>
                                    <div class="numbering-option">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="indiaNumbering" id="indiaAlpha" value="alpha" onchange="updatePreview('india')">
                                            <label class="form-check-label" for="indiaAlpha">
                                                أبجدي (A, B, C...)
                                            </label>
                                        </div>
                                    </div>
                                    <div class="numbering-option">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="indiaNumbering" id="indiaCustom" value="custom" onchange="updatePreview('india')">
                                            <label class="form-check-label" for="indiaCustom">
                                                مخصص
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="custom-numbering" id="indiaCustomNumbering" style="display: none;">
                                <label class="form-label">أرقام الطاولات المخصصة (مفصولة بفواصل):</label>
                                <textarea class="form-control" id="indiaCustomNumbers" rows="3" placeholder="مثال: VIP-1, VIP-2, A1, A2, B1, B2" onchange="updatePreview('india')"></textarea>
                                <small class="text-muted">يمكنك استخدام أي نص أو رقم تريده</small>
                        <div class="mt-3">
                          <label class="form-label">
  0 0 0 0 0 0 0 0                   "/>
                          <label class="form-label">تخطيط الصفوف (مثال: 4,4,4)</label>
                          <div class="input-group">
                            <!-- removed obsolete per-branch rows layout UI -->
                        </div>

                    </div>

                    <div class="col-md-6">
                        <h5><i class="fas fa-eye me-2"></i>معاينة الطاولات</h5>
                        <div class="table-preview" id="indiaPreview">
                            <!-- Tables will be generated here -->
                        </div>
                    </div>
                </div>
            <!-- Sections Management -->
            <div class="branch-section">
              <div class="branch-header">
                <h3><i class="fas fa-layer-group me-2"></i>📚 الأقسام</h3>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <h5>أقسام China Town</h5>
                  <div id="chinaSections"></div>
                  <button class="btn btn-sm btn-outline-primary mt-2" onclick="addSection('china')"><i class="fa fa-plus"></i> إضافة قسم</button>
                </div>
                <div class="col-md-6">
                  <h5>أقسام Palace India</h5>
                  <div id="indiaSections"></div>
                  <button class="btn btn-sm btn-outline-primary mt-2" onclick="addSection('india')"><i class="fa fa-plus"></i> إضافة قسم</button>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-md-12">
                  <h5>توزيع الطاولات على الأقسام</h5>
                  <div class="table-preview" id="assignPreview"></div>
                  <small class="text-muted">معاينة توزيع الطاولات حسب الصفوف المحددة لكل قسم</small>
                </div>
              </div>
            </div>

            </div>

            <!-- Action Buttons -->
            <div class="text-center mt-4">
                <button class="btn btn-save me-3" onclick="saveAllSettings()">
                    <i class="fas fa-save me-2"></i>
                    حفظ جميع الإعدادات
                </button>
                <button class="btn btn-reset" onclick="resetToDefaults()">
                    <i class="fas fa-undo me-2"></i>
                    إعادة تعيين للافتراضي
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
        });

        // Load current settings
        async function loadSettings() {
            try {
                const response = await fetch('/api/table-settings');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        // Load China Town settings
                        if (data.settings && data.settings.china) {
                            document.getElementById('chinaTableCount').value = data.settings.china.count || 20;
                            const chinaNumberingElement = document.querySelector(`input[name="chinaNumbering"][value="${data.settings.china.numbering || 'numeric'}"]`);
                            if (chinaNumberingElement) {
                                chinaNumberingElement.checked = true;
                            }
                            if (data.settings.china.custom_numbers) {
                                document.getElementById('chinaCustomNumbers').value = data.settings.china.custom_numbers;
                            }
                        }

                        // Load Palace India settings
                        if (data.settings && data.settings.india) {
                            document.getElementById('indiaTableCount').value = data.settings.india.count || 20;
            // Load sections for both branches
            await loadSections('china_town', 'china');
            await loadSections('place_india', 'india');

                            const indiaNumberingElement = document.querySelector(`input[name="indiaNumbering"][value="${data.settings.india.numbering || 'numeric'}"]`);
                            if (indiaNumberingElement) {
                                indiaNumberingElement.checked = true;
                            }
                            if (data.settings.india.custom_numbers) {
                                document.getElementById('indiaCustomNumbers').value = data.settings.india.custom_numbers;
                            }
                        }

                        updatePreview('china');
                        updatePreview('india');
                        toggleCustomNumbering();
                    } else {
                        showMessage('خطأ في تحميل الإعدادات: ' + (data.error || 'خطأ غير معروف'), 'danger');
                    }
                } else {
                    showMessage('خطأ في الاتصال بالخادم', 'danger');
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                showMessage('خطأ في تحميل الإعدادات', 'danger');
                // Set default values
                updatePreview('china');
                updatePreview('india');
                toggleCustomNumbering();
            }
        }

        // Update preview when settings change
        function updatePreview(branch) {
            const count = parseInt(document.getElementById(branch + 'TableCount').value);
            const numbering = document.querySelector(`input[name="${branch}Numbering"]:checked`).value;
            const customNumbers = document.getElementById(branch + 'CustomNumbers').value;

            const preview = document.getElementById(branch + 'Preview');
            preview.innerHTML = '';

            let tableNumbers = [];

            if (numbering === 'numeric') {
                for (let i = 1; i <= count; i++) {
                    tableNumbers.push(i.toString());
                }
            } else if (numbering === 'alpha') {
                for (let i = 0; i < count; i++) {
                    tableNumbers.push(String.fromCharCode(65 + i)); // A, B, C...
                }
            } else if (numbering === 'custom' && customNumbers) {
                tableNumbers = customNumbers.split(',').map(n => n.trim()).filter(n => n);
            }

            tableNumbers.forEach(number => {
                const tableDiv = document.createElement('div');
                tableDiv.className = 'table-item';
                tableDiv.textContent = number;
                preview.appendChild(tableDiv);
            });

            toggleCustomNumbering();
        }

        // Toggle custom numbering visibility
        function toggleCustomNumbering() {
            const chinaCustom = document.getElementById('chinaCustom').checked;
            const indiaCustom = document.getElementById('indiaCustom').checked;

            document.getElementById('chinaCustomNumbering').style.display = chinaCustom ? 'block' : 'none';
            document.getElementById('indiaCustomNumbering').style.display = indiaCustom ? 'block' : 'none';
        }

        // Save all settings
        async function saveAllSettings() {
            const settings = {
                china: {
                    count: parseInt(document.getElementById('chinaTableCount').value),
                    numbering: document.querySelector('input[name="chinaNumbering"]:checked').value,
                    custom_numbers: document.getElementById('chinaCustomNumbers').value
                },
                india: {
                    count: parseInt(document.getElementById('indiaTableCount').value),
                    numbering: document.querySelector('input[name="indiaNumbering"]:checked').value,
                    custom_numbers: document.getElementById('indiaCustomNumbers').value
                }
            };

            try {
                const response = await fetch('/api/table-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('تم حفظ الإعدادات بنجاح!', 'success');
                } else {
                    showMessage('خطأ في حفظ الإعدادات: ' + data.error, 'danger');
                }
            } catch (error) {
                showMessage('خطأ في الاتصال بالخادم', 'danger');
            }
        }

        // Reset to defaults
        function resetToDefaults() {
            if (confirm('هل أنت متأكد من إعادة تعيين جميع الإعدادات للافتراضي؟')) {
                document.getElementById('chinaTableCount').value = 20;
                document.getElementById('indiaTableCount').value = 20;
                document.getElementById('chinaNumeric').checked = true;
                document.getElementById('indiaNumeric').checked = true;
                document.getElementById('chinaCustomNumbers').value = '';
                document.getElementById('indiaCustomNumbers').value = '';

                updatePreview('china');
                updatePreview('india');
            }
        }

        // Show message (fixed: keep function small and global)
        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>`;
            setTimeout(() => { container.innerHTML = ''; }, 5000);
        }

        // ----- Sections JS (moved to global scope) -----
        let sectionsState = { china: [], india: [], assign: { china: {}, india: {} } };

        async function loadSections(branchCode, short){
          try{
            const resp = await fetch(`/api/table-sections/${branchCode}`);
            if(!resp.ok) return;
            const data = await resp.json();
            if(!data.success) return;
            const list = data.sections || [];
            sectionsState[short] = list;
            const assigns = data.assignments || [];
            const map = {};
            assigns.forEach(a=>{ map[a.table_number] = a.section_id; });
            sectionsState.assign[short] = map;
            renderSections(short);
            renderAssign(short);
          }catch(e){ console.error('loadSections failed', e); }
        }

        function renderSections(short){
          const el = document.getElementById(short + 'Sections');
          const arr = sectionsState[short] || [];
          el.innerHTML = '';
          arr.forEach((s, i)=>{
            const row = document.createElement('div');
            row.className = 'd-flex gap-2 align-items-center mb-2';
            row.innerHTML = `
              <div class=\"w-100\">
                <div class=\"d-flex gap-2 align-items-center mb-2\">
                  <input class=\"form-control form-control-sm\" style=\"max-width:220px\" placeholder=\"اسم القسم (اختياري)\" value=\"${s.name||''}\" onchange=\"updateSectionName('${short}', ${i}, this.value)\">
                  <input class=\"form-control form-control-sm\" style=\"max-width:120px\" type=\"number\" min=\"0\" placeholder=\"عدد الصفوف\" value=\"${(s.rows&&s.rows.length)||s.rowsCount||0}\" onchange=\"updateRowsCount('${short}', ${i}, this.value)\" title=\"عدد الصفوف لهذا القسم\">
                  <input class=\"form-control form-control-sm\" style=\"max-width:90px\" type=\"number\" value=\"${s.sort_order||0}\" onchange=\"updateSectionOrder('${short}', ${i}, this.value)\" title=\"ترتيب القسم\">
                  <button class=\"btn btn-sm btn-outline-danger\" onclick=\"removeSection('${short}', ${i})\"><i class=\"fa fa-trash\"></i></button>
                </div>
                <div id=\"rows-${short}-${i}\"></div>
              </div>
            `;
            el.appendChild(row);
            try{ renderRowsForSection(short, i); }catch(e){}
          });
        }
        function addSection(short){
          sectionsState[short] = sectionsState[short] || [];
          sectionsState[short].push({ name: '', layout: '', sort_order: sectionsState[short].length });
          renderSections(short);
        }

        function getAllAssignedTables(short){
          const arr = sectionsState[short]||[];
          const set = new Set();
          arr.forEach(s=>{ (s.rows||[]).forEach(r=> (r||[]).forEach(t=> set.add(String(t))) ); });
          return set;
        }
        function getAvailableTables(short){
          const all = getTableNumbers(short);
          const used = getAllAssignedTables(short);
          return all.filter(t=> !used.has(String(t)) );
        }
        function updateRowsCount(short, idx, val){
          const count = Math.max(0, parseInt(val||'0'));
          const s = (sectionsState[short]||[])[idx];
          if(!s) return;
          s.rows = s.rows || [];
          if(s.rows.length < count){
            while(s.rows.length < count) s.rows.push([]);
          }else if(s.rows.length > count){
            s.rows = s.rows.slice(0, count);
          }
          renderSections(short);
          renderAssign(short);
        }
        function renderRowsForSection(short, idx){
          const s = (sectionsState[short]||[])[idx];
          const container = document.getElementById(`rows-${short}-${idx}`);
          if(!s || !container){ return; }
          const rows = s.rows||[];
          let html = '';
          rows.forEach((r,ri)=>{
            const avail = getAvailableTables(short);
            const selId = `sel-${short}-${idx}-${ri}`;
            html += `<div class="mb-2">
              <div class="d-flex align-items-center gap-2 mb-1">
                <span class="badge bg-secondary">الصف ${ri+1}</span>
                <select id="${selId}" class="form-select form-select-sm" style="max-width:200px">
                  ${avail.map(v=>`<option value="${v}">${v}</option>`).join('')}
                </select>
                <button class="btn btn-sm btn-outline-primary" onclick="addRowTable('${short}', ${idx}, ${ri})">إضافة</button>
              </div>
              <div>
                ${(r||[]).map(t=>`<span class="badge text-bg-light border me-1 mb-1">${t} <a href="#" onclick=\"removeRowTable('${short}', ${idx}, ${ri}, '${t}')\" class=\"text-danger ms-1\">×</a></span>`).join('')}
              </div>
            </div>`;
          });
          container.innerHTML = html || '<small class="text-muted">أدخل عدد الصفوف لبدء التوزيع داخل هذا القسم</small>';
        }
        function addRowTable(short, idx, ri){
          const s = (sectionsState[short]||[])[idx]; if(!s) return;
          const sel = document.getElementById(`sel-${short}-${idx}-${ri}`); if(!sel) return;
          const val = (sel.value||'').trim(); if(!val) return;
          s.rows = s.rows || []; s.rows[ri] = s.rows[ri]||[];
          // avoid duplicates globally and within row
          const used = getAllAssignedTables(short);
          if(used.has(String(val))) { alert('هذه الطاولة مستخدمة بالفعل'); return; }
          s.rows[ri].push(val);
          renderRowsForSection(short, idx);
          renderAssign(short);
        }
        function removeRowTable(short, idx, ri, t){
          const s = (sectionsState[short]||[])[idx]; if(!s) return;
          s.rows = s.rows || []; s.rows[ri] = (s.rows[ri]||[]).filter(x=> String(x)!==String(t));
          renderRowsForSection(short, idx);
          renderAssign(short);
        }


        function updateSectionName(short, idx, v){ sectionsState[short][idx].name = v; }
        function updateSectionLayout(short, idx, v){ sectionsState[short][idx].layout = v; renderAssign(short); }
        function updateSectionOrder(short, idx, v){ sectionsState[short][idx].sort_order = parseInt(v||'0'); }
        function removeSection(short, idx){ sectionsState[short].splice(idx,1); renderSections(short); renderAssign(short); }

        function renderAssign(short){
          const container = document.getElementById('assignPreview');
          if(!container) return;
          const tableNumbers = getTableNumbers(short);
          const secList = (sectionsState[short]||[]).slice().sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));

          const wrapper = document.createElement('div');
          wrapper.className = 'mb-3';
          wrapper.innerHTML = `<h6 class=\"mb-2\">${short==='china'?'China Town':'Palace India'}</h6>`;

          // used tables across all sections
          const used = new Set();
          secList.forEach(s=>{ (s.rows||[]).forEach(r=> (r||[]).forEach(t=> used.add(String(t)) )); });

          secList.forEach(s=>{
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'mb-2';
            const title = (s.name && s.name.trim()) ? s.name : '\u0628\u062f\u0648\u0646 \u0627\u0633\u0645';
            sectionDiv.innerHTML = `<div class=\"fw-bold small text-muted mb-1\">${title}</div>`;

            const rows = s.rows||[];
            if(rows.length>0){
              rows.forEach(r=>{
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row g-2';
                (r||[]).forEach(tn=>{
                  const col = document.createElement('div');
                  col.className = 'col-3 col-md-2 col-lg-1';
                  col.innerHTML = `<div class=\"btn btn-sm btn-outline-secondary w-100\">${tn}</div>`;
                  rowDiv.appendChild(col);
                });
                sectionDiv.appendChild(rowDiv);
              });
            }
            wrapper.appendChild(sectionDiv);
          });

          // Unassigned tables
          const unassigned = tableNumbers.filter(n=> !used.has(String(n)) );
          if(unassigned.length>0){
            const remDiv = document.createElement('div');
            remDiv.className = 'mb-2';
            remDiv.innerHTML = `<div class=\"fw-bold small text-muted mb-1\">\u0628\u062f\u0648\u0646 \u0642\u0633\u0645</div>`;
            const rowDiv = document.createElement('div'); rowDiv.className='row g-2';
            unassigned.forEach(tn=>{
              const col = document.createElement('div');
              col.className = 'col-3 col-md-2 col-lg-1';
              col.innerHTML = `<div class=\"btn btn-sm btn-outline-secondary w-100\">${tn}</div>`;
              rowDiv.appendChild(col);
            });
            remDiv.appendChild(rowDiv); wrapper.appendChild(remDiv);
          }

          const prev = container.querySelector(`div[data-branch=\"${short}\"]`);
          if(prev) prev.remove();
          wrapper.setAttribute('data-branch', short);
          container.appendChild(wrapper);
        }

        function getTableNumbers(short){
          const count = parseInt(document.getElementById(short + 'TableCount').value)||0;
          const numbering = document.querySelector(`input[name="${short}Numbering"]:checked`).value;
          let tableNumbers = [];
          if(numbering==='numeric'){
            for(let i=1;i<=count;i++) tableNumbers.push(String(i));
          }else if(numbering==='alpha'){
            for(let i=0;i<count;i++) tableNumbers.push(String.fromCharCode(65+i));
          }else{
            const cn = document.getElementById(short + 'CustomNumbers').value;
            tableNumbers = (cn||'').split(',').map(x=>x.trim()).filter(Boolean);
          }
          return tableNumbers;
        }

        function applyRowsLayout(short){
          const inputId = short==='china' ? 'chinaRowsLayout' : 'indiaRowsLayout';
          const raw = (document.getElementById(inputId)?.value || '').trim();
          if(!raw){ alert('أدخل مخطط الصفوف مثل: 5,3,7'); return; }
          const parts = raw.split(',').map(s=>parseInt(s.trim(),10)).filter(n=>!isNaN(n) && n>0);
          if(parts.length===0){ alert('قيمة غير صحيحة'); return; }
          const numbers = getTableNumbers(short);
          let idx = 0;
          // build sections with names صف 1, صف 2, ...
          sectionsState[short] = parts.map((cnt,i)=>({ name: `صف ${i+1}`, sort_order: i }));
          sectionsState.assign[short] = sectionsState.assign[short] || {};
          // clear previous assignments for these tables
          numbers.forEach(n=>{ if(sectionsState.assign[short][n]!==undefined){ delete sectionsState.assign[short][n]; } });
          parts.forEach((cnt,i)=>{
            const sec = sectionsState[short][i];
            for(let k=0;k<cnt && idx<numbers.length;k++, idx++){
              const tn = numbers[idx];
              sectionsState.assign[short][tn] = sec.id || sec.name; // id if known after save, otherwise name
            }
          });
          renderSections(short);
          renderAssign(short);
          try{ showMessage('تم تطبيق الصفوف لهذا الفرع. لا تنس الضغط على "حفظ".', 'success'); }catch(e){}
        }


        async function chooseSection(short, tableNumber){
          const list = sectionsState[short] || [];
          if(list.length===0){ alert('أضف قسماً أولاً'); return; }
          const name = prompt('اختر رقم القسم (اكتب رقمه من القائمة):\n' + list.map((s,i)=> `${i+1}) ${s.name}`).join('\n'));
          const idx = parseInt((name||'').trim()) - 1;
          if(!(idx>=0 && idx<list.length)) return;
          const sec = list[idx];
          sectionsState.assign[short][tableNumber] = sec.id || sec.name;
          renderAssign(short);
        }

        const _origSave = saveAllSettings;
        saveAllSettings = async function(){
          await _origSave();
          await saveSections('china_town', 'china');
          await saveSections('place_india', 'india');
          showMessage('تم حفظ الأقسام بنجاح', 'success');
          // فتح شاشة الطاولات الصحيحة لكل فرع (بدون أخطاء 404)
          try{
            window.open('/sales/china_town/tables','_blank');
            window.open('/sales/place_india/tables','_blank');
          }catch(e){}
        }

        async function saveSections(branchCode, short){
          const list = (sectionsState[short]||[]).slice().sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
          const sections = list.map(s=>({ id: s.id, name: (s.name||''), sort_order: (s.sort_order||0), layout: ((s.rows||[]).map(r=>r.length).join(',')) }));
          const assignments = [];
          list.forEach(s=>{
            (s.rows||[]).forEach(row=>{
              (row||[]).forEach(tn=>{
                assignments.push({ table_number: tn, section_id: s.id, section_name: s.id?undefined:(s.name||'') });
              });
            });
          });
          await fetch(`/api/table-sections/${branchCode}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
            body: JSON.stringify({ sections, assignments })
          }).then(r=>r.json()).then(data=>{
            if(data && data.sections){
              const mapByName = {};
              data.sections.forEach(s=>{ mapByName[s.name]=s.id; });
              (sectionsState[short]||[]).forEach(s=>{ if(!s.id) s.id = mapByName[s.name]; });
            }
          }).catch(e=>console.error('saveSections failed', e));
        }

        // Get CSRF token
        function getCsrfToken() {
            return document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
        }

        // Add event listeners for numbering options
        document.addEventListener('change', function(e) {
            if (e.target.name === 'chinaNumbering') {
                updatePreview('china');
            } else if (e.target.name === 'indiaNumbering') {
                updatePreview('india');
            }
        });

        // Initialize previews
        updatePreview('china');
        updatePreview('india');
    </script>
</body>
</html>
