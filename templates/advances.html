{% extends 'base.html' %}
{% block title %}{{ _('Advances / Ø§Ù„Ø³Ù„Ù') }}{% endblock %}
{% block head %}
<style>
.page-rtl{direction:rtl}
.btn-navy{background:linear-gradient(135deg,#1E40AF 0%,#4F46E5 100%);color:#fff;border:none;position:relative;overflow:hidden}
.btn-navy:hover{filter:brightness(1.05);transform:scale(1.05)}
.glass-card{background:rgba(255,255,255,.75);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.4);box-shadow:0 20px 40px rgba(30,64,175,.15);border-radius:16px}
.kpi-card{display:flex;align-items:center;gap:12px;padding:16px;position:relative}
.kpi-icon{width:40px;height:40px}
.pill-tabs{display:flex;gap:8px;flex-wrap:wrap}
.pill-tab{padding:8px 14px;border-radius:999px;background:#f1f3f5;color:#1E40AF;border:1px solid #e6e9ee;cursor:pointer;position:relative}
.pill-tab.active{background:linear-gradient(135deg,#1E40AF,#4F46E5);color:#fff}
.pill-tab.active::after{content:"";position:absolute;bottom:-2px;left:12px;right:12px;height:3px;background:linear-gradient(90deg,#06B6D4,#22D3EE);filter:drop-shadow(0 0 6px rgba(6,182,212,.6))}
.table-hover-elevate tbody tr{transition:all .18s ease}
.table-hover-elevate tbody tr:hover{background:linear-gradient(90deg, rgba(79,70,229,.06), rgba(79,70,229,.0));box-shadow:0 4px 16px rgba(0,0,0,.08);transform:translateY(-1px)}
.avatar{width:36px;height:36px;border-radius:50%;background:#e9eef5}
.bottom-toolbar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;margin-top:12px;background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
.sticky-wrap{position:relative}
.sticky-wrap{overflow:visible}
.dropdown-menu{z-index:2000}
.ops-fly{position:fixed;background:#fff;border:1px solid #eaeaea;border-radius:10px;box-shadow:0 12px 28px rgba(0,0,0,.18);min-width:180px;z-index:2000}
.ops-menu .it{padding:8px 12px;cursor:pointer}
.ops-menu .it:hover{background:#f6fbff}
.sticky-wrap .table thead th{position:sticky;top:0;background:#fff;z-index:2;box-shadow:0 2px 0 rgba(0,0,0,.06)}
.sticky-wrap::before,.sticky-wrap::after{content:'';position:absolute;top:0;bottom:0;width:16px;pointer-events:none}
.sticky-wrap::before{left:0;background:linear-gradient(90deg, rgba(0,0,0,.12), rgba(0,0,0,0));opacity:0}
.sticky-wrap::after{right:0;background:linear-gradient(270deg, rgba(0,0,0,.12), rgba(0,0,0,0));opacity:0}
.sticky-wrap.shadow-left::before{opacity:.35}
.sticky-wrap.shadow-right::after{opacity:.35}
.logo{transition:transform .18s ease;will-change:transform}
.suggest-box{position:absolute;top:100%;right:0;left:0;z-index:30;background:#0b1020;border:1px solid #0ea5e9;border-top:none;border-radius:0 0 12px 12px;box-shadow:0 12px 20px rgba(0,0,0,.35);display:none;max-height:220px;overflow:auto}
.suggest-item{padding:10px 12px;cursor:pointer;color:#e2f6ff}
.suggest-item .hl{color:#22D3EE;text-shadow:0 0 8px rgba(34,211,238,.8)}
.suggest-item:hover{background:#0b1a2e}
.ripple::after{content:"";position:absolute;left:50%;top:50%;width:5px;height:5px;background:radial-gradient(circle, rgba(255,255,255,.8) 0%, rgba(255,255,255,0) 70%);transform:translate(-50%,-50%) scale(0);border-radius:50%;opacity:0;transition:transform .5s ease, opacity .8s ease}
.ripple:active::after{transform:translate(-50%,-50%) scale(20);opacity:1}
.toast-adv{position:fixed;top:16px;right:16px;background:#09122a;color:#e2f6ff;border:1px solid #22D3EE;border-radius:12px;box-shadow:0 12px 24px rgba(0,0,0,.35);padding:12px 16px;z-index:1055;animation:advPulse 2.5s infinite}
@keyframes advPulse{0%{box-shadow:0 0 0 0 rgba(34,211,238,.5)}70%{box-shadow:0 0 0 12px rgba(34,211,238,0)}100%{box-shadow:0 0 0 0 rgba(34,211,238,0)}}
.offcanvas.show .offcanvas-body{animation:advScale .25s ease}
@keyframes advScale{0%{transform:scale(.96);opacity:.0}100%{transform:scale(1);opacity:1}}
.spark{position:absolute;right:16px;bottom:10px;width:120px;height:28px}
</style>
{% endblock %}
{% block content %}
<div class="container py-4 page-rtl">
  <div class="d-flex align-items-center justify-content-between mb-3" id="advHeader">
    <div class="d-flex align-items-center gap-3">
      <img src="/static/logo.svg" class="logo" style="width:32px;height:32px;border-radius:8px" id="advLogo">
      <div>
        <div class="fw-semibold" style="color:#0B2347">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ù</div>
        <div class="text-muted small">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© â€º Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ù</div>
      </div>
    </div>
    <div class="d-flex align-items-center gap-2" style="min-width:360px">
      <select class="form-select" id="advEmployee" style="max-width:240px">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù</option>
        {% for e in employees or [] %}
        <option value="{{ e.id }}">{{ e.full_name }}</option>
        {% endfor %}
      </select>
      <div class="avatar"></div>
      <button class="btn btn-navy ripple" onclick="openNewAdvanceModal()">âŠ Ù…Ù†Ø­ Ø³Ù„ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-12 col-xl-4"><div class="glass-card kpi-card"><div id="lottieWallet" class="kpi-icon"></div><div class="flex-grow-1"><div class="text-muted small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù„Ù</div><div class="fs-5 fw-bold" id="kpiTotalAdv">â€”</div></div><canvas class="spark" id="advSpark"></canvas></div></div>
    <div class="col-12 col-xl-4"><div class="glass-card kpi-card"><div id="lottieUnpaid" class="kpi-icon"></div><div class="flex-grow-1"><div class="text-muted small">Ø³Ù„Ù ØºÙŠØ± Ù…Ø³Ø¯Ø¯Ø©</div><div class="fs-5 fw-bold text-danger" id="kpiUnpaid">â€”</div></div></div></div>
    <div class="col-12 col-xl-4"><div class="glass-card kpi-card"><div id="lottieDate" class="kpi-icon"></div><div class="flex-grow-1"><div class="text-muted small">Ø¢Ø®Ø± Ø³Ù„ÙØ©</div><div class="fs-6 fw-semibold" id="kpiLast">â€”</div></div></div></div>
  </div>

  <div class="pill-tabs mb-3" id="deptTabs">
    <button class="pill-tab active" data-dept="all">Ø§Ù„ÙƒÙ„ <span class="badge bg-light text-dark ms-1" id="count-all">0</span></button>
    <button class="pill-tab" data-dept="kitchen">Ø´ÙŠÙ <span class="badge bg-light text-dark ms-1" id="count-kitchen">0</span></button>
    <button class="pill-tab" data-dept="hall">Ø§Ù„ØµØ§Ù„Ø© <span class="badge bg-light text-dark ms-1" id="count-hall">0</span></button>
    <button class="pill-tab" data-dept="admin">Ø¥Ø¯Ø§Ø±ÙŠ <span class="badge bg-light text-dark ms-1" id="count-admin">0</span></button>
    <button class="pill-tab" data-dept="branches">ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹ <span class="badge bg-light text-dark ms-1" id="count-branches">0</span></button>
  </div>
  <div class="card mb-3">
    <div class="card-body d-flex flex-wrap gap-2 align-items-end">
      <div>
        <label class="form-label mb-0">Ø§Ù„Ø´Ù‡Ø±</label>
        <input type="month" class="form-control" id="advMonth" value="{{ get_saudi_now().strftime('%Y-%m') if get_saudi_now else '' }}" />
      </div>
      <div>
        <label class="form-label mb-0">Ø§Ù„Ù‚Ø³Ù…</label>
        <select class="form-select" id="advDept">
          <option value="">Ø§Ù„ÙƒÙ„</option>
          <option value="kitchen">Ø´ÙŠÙ</option>
          <option value="hall">Ø§Ù„ØµØ§Ù„Ø©</option>
          <option value="admin">Ø¥Ø¯Ø§Ø±ÙŠ</option>
        </select>
      </div>
      <div>
        <label class="form-label mb-0">Ø§Ù„Ù…ÙˆØ¸Ù</label>
        <select class="form-select" id="advEmp">
          <option value="">Ø§Ù„ÙƒÙ„</option>
          {% for e in employees or [] %}
          <option value="{{ e.id }}">{{ e.full_name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="ms-auto">
        <button class="btn btn-outline-primary" id="advRefresh"><i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <div class="table-responsive sticky-wrap" id="advGridWrap">
        <table class="table table-borderless table-hover table-hover-elevate align-middle table-sm">
          <thead class="table-light"><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙØ±Ø¹</th><th class="text-end">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ù…Ù†ÙˆØ­</th><th class="text-end">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><th class="text-end">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø¢Ø®Ø± ØªØ§Ø±ÙŠØ®</th><th>âš™</th></tr></thead>
          <tbody id="advTableBody"></tbody>
        </table>
      </div>
      <div class="bottom-toolbar"><div class="d-flex align-items-center gap-2"><button class="btn btn-outline-primary" id="btnExportAdv">ØªØµØ¯ÙŠØ± CSV</button></div><div class="d-flex align-items-center gap-2"><label class="text-muted">Ø§Ù„Ø­Ø¬Ù…</label><select class="form-select" id="advPageSize" style="width:90px"><option>10</option><option>25</option><option>50</option></select><div id="advPager" class="d-flex align-items-center gap-2"><button class="btn btn-outline-secondary" id="advPrev">â€¹</button><span id="advPageInfo" class="small text-muted">â€”</span><button class="btn btn-outline-secondary" id="advNext">â€º</button></div></div></div>
    </div>
  </div>

  <div class="offcanvas offcanvas-end" tabindex="-1" id="advanceCanvas" aria-labelledby="advanceCanvasLabel">
    <div class="offcanvas-header" style="background:linear-gradient(135deg,#1E40AF,#4F46E5);color:#fff"><h5 id="advanceCanvasLabel">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ù„ÙØ©</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button></div>
    <div class="offcanvas-body">
      <div class="d-grid gap-2">
        <div><span class="text-muted">Ø§Ù„Ù…ÙˆØ¸Ù:</span> <span id="aName"></span></div>
        <div><span class="text-muted">Ø§Ù„Ø³Ù„ÙØ©:</span> <span id="aGrant"></span></div>
        <div><span class="text-muted">Ø§Ù„Ù…Ø³Ø¯Ù‘Ø¯:</span> <span id="aPaid"></span></div>
        <div><span class="text-muted">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span> <span id="aRemain"></span></div>
        <div><span class="text-muted">Ø¢Ø®Ø± ØªØ§Ø±ÙŠØ®:</span> <span id="aDate"></span></div>
      </div>
      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-navy ripple" id="btnRepay">ğŸ’° Ø³Ø¯Ø§Ø¯ Ø¬Ø²Ø¦ÙŠ</button>
        <button class="btn btn-outline-secondary ripple" id="btnEditAdv">ğŸ’¾ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn btn-outline-dark ripple" id="btnPreviewAdv">ğŸ“Š Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚ÙŠØ¯</button>
      </div>
    </div>
  </div>

  <div class="modal fade" id="newAdvanceModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Ù…Ù†Ø­ Ø³Ù„ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form id="newAdvanceForm" class="d-grid gap-2">
            <div>
              <label class="form-label">Ø§Ù„Ù…ÙˆØ¸Ù</label>
              <select name="employee_id" class="form-select" required>
                {% for e in employees or [] %}
                <option value="{{ e.id }}">{{ e.full_name }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº</label>
              <input name="amount" type="number" step="0.01" class="form-control" required>
            </div>
            <div>
              <label class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
              <select name="method" class="form-select">
                <option value="cash">Ù†Ù‚Ø¯ÙŠ</option>
                <option value="bank">Ø¨Ù†Ùƒ</option>
                <option value="card">Ø¨Ø·Ø§Ù‚Ø©</option>
              </select>
            </div>
            <div>
              <label class="form-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
              <input name="date" type="date" class="form-control" value="{{ get_saudi_now().strftime('%Y-%m-%d') if get_saudi_now else '' }}">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="button" class="btn btn-navy" id="submitNewAdvance">Ø­ÙØ¸</button>
        </div>
      </div>
    </div>
  </div>

</div>
<script>
 (async function(){ try{ const r = await fetch('/api/advances/metrics'); const j = await r.json(); if(j&&j.ok){ document.getElementById('kpiTotalAdv').textContent = 'ï·¼'+Number(j.total||0).toFixed(2); document.getElementById('kpiUnpaid').textContent = 'ï·¼'+Number(j.unpaid||0).toFixed(2); document.getElementById('kpiLast').textContent = j.last_date||'â€”'; const s=(j.series||[]); const cv=document.getElementById('advSpark'); if(cv&&s.length){ const ctx=cv.getContext('2d'); const w=cv.width=cv.clientWidth; const h=cv.height=cv.clientHeight; const vals=s.map(x=>Number(x.granted||0)); const max=Math.max.apply(null,vals.concat([1])); const min=Math.min.apply(null,vals.concat([0])); const pad=4; ctx.clearRect(0,0,w,h); ctx.strokeStyle='#22D3EE'; ctx.lineWidth=2; ctx.beginPath(); s.forEach((x,i)=>{ const vx=pad + (w-2*pad)*i/(s.length-1||1); const vy=h-pad - (h-2*pad)*(vals[i]-min)/(max-min||1); if(i===0) ctx.moveTo(vx,vy); else ctx.lineTo(vx,vy); }); ctx.stroke(); ctx.fillStyle='rgba(79,70,229,.15)'; ctx.beginPath(); s.forEach((x,i)=>{ const vx=pad + (w-2*pad)*i/(s.length-1||1); const vy=h-pad - (h-2*pad)*(vals[i]-min)/(max-min||1); if(i===0) ctx.moveTo(vx,vy); else ctx.lineTo(vx,vy); }); ctx.lineTo(w-pad,h-pad); ctx.lineTo(pad,h-pad); ctx.closePath(); ctx.fill(); } } }catch(e){} }());
 (async function(){ try{ const r = await fetch('/api/advances/list'); const j = await r.json(); if(j&&j.ok){ const tbody = document.getElementById('advTableBody'); let idx=0; (j.rows||[]).forEach(x=>{ const status = (Number(x.remaining||0)>0? 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' : 'Ù…Ù†ØªÙ‡ÙŠØ©'); const tr=document.createElement('tr'); tr.setAttribute('data-emp', String(x.employee_id||'')); tr.setAttribute('data-name', x.employee_name||''); tr.setAttribute('data-dept', (x.department||'').toLowerCase()); tr.innerHTML = `<td>${++idx}</td><td>${x.employee_name||''}</td><td>${x.branch||'-'}</td><td class='text-end'>${Number(x.granted||0).toFixed(2)}</td><td class='text-end'>${Number(x.paid||0).toFixed(2)}</td><td class='text-end'>${Number(x.remaining||0).toFixed(2)}</td><td>${x.last_date||'-'}</td><td><div class='dropdown'><button class='btn btn-sm btn-outline-secondary' data-bs-toggle='dropdown'>â‹®</button><ul class='dropdown-menu'><li><button class='dropdown-item' data-adv='${encodeURIComponent(JSON.stringify(x))}' data-bs-toggle='offcanvas' data-bs-target='#advanceCanvas'>Ù…Ø¹Ø§ÙŠÙ†Ø©</button></li><li><button class='dropdown-item' data-act='repay' data-adv='${encodeURIComponent(JSON.stringify(x))}'>Ø³Ø¯Ø§Ø¯ Ø¬Ø²Ø¦ÙŠ</button></li><li><button class='dropdown-item' data-act='edit' data-adv='${encodeURIComponent(JSON.stringify(x))}'>ØªØ¹Ø¯ÙŠÙ„</button></li><li><button class='dropdown-item' data-act='preview' data-adv='${encodeURIComponent(JSON.stringify(x))}'>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù‚ÙŠØ¯</button></li></ul></div></td>`; tbody.appendChild(tr); }); const cnt={all:0,kitchen:0,hall:0,admin:0,branches:0}; document.querySelectorAll('#advTableBody tr').forEach(tr=>{ cnt.all+=1; const dep=(tr.getAttribute('data-dept')||''); if(/kitchen|chef|Ø´ÙŠÙ/i.test(dep)) cnt.kitchen+=1; if(/hall|floor|wait|ØµØ§Ù„Ø©|Ø§Ù„ØµØ§Ù„Ø©/i.test(dep)) cnt.hall+=1; if(/admin|Ø¥Ø¯Ø§Ø±ÙŠ/i.test(dep)) cnt.admin+=1; }); for(const k of Object.keys(cnt)){ const el=document.getElementById('count-'+k); if(el) el.textContent = cnt[k]; } document.querySelectorAll('[data-bs-target="#advanceCanvas"]').forEach(b=> b.addEventListener('click', function(){ const data = JSON.parse(decodeURIComponent(this.getAttribute('data-adv')||'%7B%7D')); document.getElementById('aName').textContent = data.employee_name||''; document.getElementById('aGrant').textContent = 'ï·¼'+Number(data.granted||0).toFixed(2); document.getElementById('aPaid').textContent = 'ï·¼'+Number(data.paid||0).toFixed(2); document.getElementById('aRemain').textContent = 'ï·¼'+Number(data.remaining||0).toFixed(2); document.getElementById('aDate').textContent = data.last_date||'-'; document.getElementById('btnRepay').onclick = ()=> repayAdvance(data.employee_id); document.getElementById('btnPreviewAdv').onclick = ()=> showToast('Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù‚ÙŠØ¯'); document.getElementById('btnEditAdv').onclick = ()=> showToast('ÙØªØ­ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); }); document.querySelectorAll('[data-act]').forEach(b=> b.addEventListener('click', function(){ const act=this.getAttribute('data-act'); const data = JSON.parse(decodeURIComponent(this.getAttribute('data-adv')||'%7B%7D')); if(act==='repay'){ repayAdvance(data.employee_id); } else if(act==='edit'){ showToast('ÙØªØ­ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); } else if(act==='preview'){ showToast('Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù‚ÙŠØ¯'); } })); const overLimit=(j.rows||[]).some(r=> Number(r.granted||0) > 5000); if(overLimit){ showToast('Ø§Ù„Ø³Ù„ÙØ© ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡'); } const anyUnapproved=(j.rows||[]).some(r=> Number(r.remaining||0)>0); if(anyUnapproved){ showToast('Ø³Ù„ÙØ© Ù„Ù… ÙŠØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯Ù‡Ø§ Ø¨Ø¹Ø¯'); } } }catch(e){} }());
document.getElementById('advSearch')?.addEventListener('input', function(){ const q=(this.value||'').trim(); const box=document.getElementById('advSuggest'); if(!q){ box.style.display='none'; box.innerHTML=''; return; } const list=EMPS.filter(x=> x && x.toLowerCase().includes(q.toLowerCase())).slice(0,8); box.innerHTML = list.map(t=>{ const idx=t.toLowerCase().indexOf(q.toLowerCase()); const pre=t.substring(0,idx); const mid=t.substring(idx, idx+q.length); const suf=t.substring(idx+q.length); return `<div class='suggest-item'>${pre}<span class='hl'>${mid}</span>${suf}</div>`; }).join(''); box.style.display = list.length?'block':'none'; Array.from(box.querySelectorAll('.suggest-item')).forEach(i=> i.addEventListener('click',()=>{ document.getElementById('advSearch').value=i.textContent; box.style.display='none'; })); });
document.querySelectorAll('#deptTabs .pill-tab').forEach(b=> b.addEventListener('click', function(){ document.querySelectorAll('#deptTabs .pill-tab').forEach(x=> x.classList.remove('active')); this.classList.add('active'); const d=this.getAttribute('data-dept')||'all'; document.querySelectorAll('#advTableBody tr').forEach(tr=>{ const dep=(tr.getAttribute('data-dept')||''); const ok = d==='all' || (d==='kitchen'&&/kitchen|chef|Ø´ÙŠÙ/i.test(dep)) || (d==='hall'&&/hall|floor|wait|ØµØ§Ù„Ø©|Ø§Ù„ØµØ§Ù„Ø©/i.test(dep)) || (d==='admin'&&/admin|Ø¥Ø¯Ø§Ø±ÙŠ/i.test(dep)); tr.style.display = ok? '' : 'none'; }); }));
function openNewAdvance(){ const empId = prompt('Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù'); const amount = prompt('Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ù„ÙØ©'); if(!empId||!amount) return; const fd=new FormData(); fd.append('employee_id', empId); fd.append('amount', amount); fd.append('method','cash'); fd.append('csrf_token', '{{ csrf_token() }}'); fetch('/api/advances', { method:'POST', body: fd }).then(r=> r.json()).then(j=>{ showToast(j&&j.ok?'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ù„ÙØ©':'ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„'); location.reload(); }).catch(()=> showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©')); }
function repayAdvance(empId){ const amount = prompt('Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯'); if(!amount) return; const fd=new FormData(); fd.append('employee_id', String(empId)); fd.append('amount', String(amount)); fd.append('method','cash'); fd.append('csrf_token', '{{ csrf_token() }}'); fetch('/api/advances/pay', { method:'POST', body: fd }).then(r=> r.json()).then(j=>{ showToast(j&&j.ok?'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø¯Ø§Ø¯':'ÙØ´Ù„ Ø§Ù„Ø³Ø¯Ø§Ø¯'); location.reload(); }).catch(()=> showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©')); }
try{ lottie.loadAnimation({ container: document.getElementById('lottieWallet'), renderer:'svg', loop:true, autoplay:true, path:'https://lottie.host/7f8da2c2-money.json' }); lottie.loadAnimation({ container: document.getElementById('lottieUnpaid'), renderer:'svg', loop:true, autoplay:true, path:'https://lottie.host/b1c2a3d4-clock.json' }); lottie.loadAnimation({ container: document.getElementById('lottieDate'), renderer:'svg', loop:true, autoplay:true, path:'https://lottie.host/92b0a1f1-payroll.json' }); }catch(e){}
function showToast(msg){ const el=document.createElement('div'); el.className='toast-adv'; el.textContent=msg||''; document.body.appendChild(el); setTimeout(()=>{ el.remove(); },5000); }
function openNewAdvanceModal(){ const m=new bootstrap.Modal(document.getElementById('newAdvanceModal')); m.show(); }
document.getElementById('submitNewAdvance')?.addEventListener('click', function(){ const f=document.getElementById('newAdvanceForm'); const fd=new FormData(f); fd.append('csrf_token', '{{ csrf_token() }}'); fetch('/api/advances', { method:'POST', body: fd }).then(r=> r.json()).then(j=>{ showToast(j&&j.ok?'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ù„ÙØ©':'ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„'); const m=bootstrap.Modal.getInstance(document.getElementById('newAdvanceModal')); m?.hide(); location.reload(); }).catch(()=> showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©')); });
document.getElementById('advEmployee')?.addEventListener('change', function(){ const id=(this.value||''); document.querySelectorAll('#advTableBody tr').forEach(tr=>{ const tid=(tr.getAttribute('data-emp')||''); tr.style.display = (!id || tid===id) ? '' : 'none'; }); });
const hdr=document.getElementById('advHeader'); const lg=document.getElementById('advLogo'); if(hdr&&lg){ hdr.addEventListener('mousemove', function(ev){ const r=hdr.getBoundingClientRect(); const cx=ev.clientX - r.left; const cy=ev.clientY - r.top; const rx=(cx/r.width - .5)*8; const ry=(cy/r.height - .5)*-8; lg.style.transform = `perspective(300px) rotateY(${rx}deg) rotateX(${ry}deg) scale(1.06)`; }); hdr.addEventListener('mouseleave', function(){ lg.style.transform='none'; }); }
</script>
<script>
// ØªØ­ÙˆÙŠÙ„ Ù‚ÙˆØ§Ø¦Ù… ØµÙÙˆÙ Ø§Ù„Ø³Ù„Ù Ø¥Ù„Ù‰ Ù‚ÙˆØ§Ø¦Ù… Ø¹Ø§Ø¦Ù…Ø© Ø£Ù…Ø§Ù…ÙŠØ©
function bindAdvFloatingMenus(){
  function replaceDropdowns(){
    document.querySelectorAll('#advTableBody tr').forEach(tr=>{
      const last = tr.querySelector('td:last-child');
      if(!last) return;
      const dd = last.querySelector('.dropdown');
      if(dd){
        const x = dd.querySelector('[data-adv]')?.getAttribute('data-adv')||'%7B%7D';
        last.innerHTML = `<button class='btn btn-sm btn-outline-secondary adv-ops-btn'>â‹®</button><div class='ops-menu'><div class='it' data-act='preview' data-adv='${x}'>Ù…Ø¹Ø§ÙŠÙ†Ø©</div><div class='it' data-act='repay' data-adv='${x}'>Ø³Ø¯Ø§Ø¯ Ø¬Ø²Ø¦ÙŠ</div><div class='it' data-act='edit' data-adv='${x}'>ØªØ¹Ø¯ÙŠÙ„</div></div>`;
      }
    });
  }
  function hide(){ document.querySelectorAll('.ops-fly').forEach(m=> m.remove()); }
  replaceDropdowns();
  document.addEventListener('click', function(e){ if(!e.target.closest('.adv-ops-btn') && !e.target.closest('.ops-fly')) hide(); });
  document.querySelectorAll('.adv-ops-btn').forEach(btn=>{
    btn.addEventListener('click', function(ev){ ev.stopPropagation(); hide(); const cell = this.parentElement; const orig = cell.querySelector('.ops-menu'); if(!orig) return; const fly = orig.cloneNode(true); fly.classList.remove('ops-menu'); fly.classList.add('ops-fly'); fly.style.display='block'; document.body.appendChild(fly); const r = this.getBoundingClientRect(); const w = fly.offsetWidth; const h = fly.offsetHeight; let top = r.bottom + 6; let left = r.right - w; if(top + h > window.innerHeight) top = r.top - h - 6; if(left < 6) left = 6; fly.style.top = (top)+'px'; fly.style.left = (left)+'px'; fly.querySelectorAll('.it').forEach(it=>{
      it.addEventListener('click', function(ev2){ ev2.stopPropagation(); hide(); const act = this.getAttribute('data-act'); const x = JSON.parse(decodeURIComponent(this.getAttribute('data-adv')||'%7B%7D'));
        if(act==='preview'){ document.getElementById('aName').textContent=x.employee_name||''; document.getElementById('aGrant').textContent=Number(x.granted||0).toFixed(2); document.getElementById('aPaid').textContent=Number(x.paid||0).toFixed(2); document.getElementById('aRemain').textContent=Number(x.remaining||0).toFixed(2); document.getElementById('aDate').textContent=x.last_date||'-'; const canvas=new bootstrap.Offcanvas(document.getElementById('advanceCanvas')); canvas.show(); }
        else if(act==='repay'){ repayAdvance(x.employee_id); }
        else if(act==='edit'){ showToast('Ù…ÙŠØ²Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø±ÙŠØ¨Ù‹Ø§'); }
    });
    });
  });
}
// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ ÙˆØ¨Ø¹Ø¯ Ø§Ù„ÙÙ„Ø§ØªØ±
(function(){
  try{ bindAdvFloatingMenus(); }catch(e){}
  try{ setTimeout(function(){ bindAdvFloatingMenus(); }, 600); }catch(e){}
})();
</script>
<script>
// ÙÙ„Ø§ØªØ± Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† API
(function(){
  async function reloadByFilters(){
    const emp = document.getElementById('advEmp')?.value||'';
    const dept = document.getElementById('advDept')?.value||'';
    const month = document.getElementById('advMonth')?.value||'';
    const qs = new URLSearchParams();
    if(emp) qs.set('employee_id', emp);
    if(dept) qs.set('dept', dept);
    if(month) qs.set('month', month);
    try{
      const r = await fetch('/api/advances/list?'+qs.toString());
      const j = await r.json();
      if(j&&j.ok){
        const tbody = document.getElementById('advTableBody');
        tbody.innerHTML = '';
        let idx=0;
        (j.rows||[]).forEach(x=>{
          const tr=document.createElement('tr');
          tr.setAttribute('data-emp', String(x.employee_id||''));
          tr.setAttribute('data-name', x.employee_name||'');
          tr.setAttribute('data-dept', (x.department||'').toLowerCase());
          tr.innerHTML = `<td>${++idx}</td><td>${x.employee_name||''}</td><td>${x.branch||'-'}</td><td class='text-end'>${Number(x.granted||0).toFixed(2)}</td><td class='text-end'>${Number(x.paid||0).toFixed(2)}</td><td class='text-end'>${Number(x.remaining||0).toFixed(2)}</td><td>${x.last_date||'-'}</td><td><div class='dropdown'><button class='btn btn-sm btn-outline-secondary' data-bs-toggle='dropdown'>â‹®</button><ul class='dropdown-menu'><li><button class='dropdown-item' data-adv='${encodeURIComponent(JSON.stringify(x))}' data-bs-toggle='offcanvas' data-bs-target='#advanceCanvas'>Ù…Ø¹Ø§ÙŠÙ†Ø©</button></li><li><button class='dropdown-item' data-act='repay' data-adv='${encodeURIComponent(JSON.stringify(x))}'>Ø³Ø¯Ø§Ø¯ Ø¬Ø²Ø¦ÙŠ</button></li><li><button class='dropdown-item' data-act='edit' data-adv='${encodeURIComponent(JSON.stringify(x))}'>ØªØ¹Ø¯ÙŠÙ„</button></li><li><button class='dropdown-item' data-act='preview' data-adv='${encodeURIComponent(JSON.stringify(x))}'>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù‚ÙŠØ¯</button></li></ul></div></td>`;
          tbody.appendChild(tr);
        });
        try{ bindAdvFloatingMenus(); }catch(e){}
      }
    }catch(e){ console.error(e); }
  }
  ['advEmp','advDept','advMonth','advRefresh'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(id==='advRefresh') el.addEventListener('click', reloadByFilters);
    else el.addEventListener('change', reloadByFilters);
  });
})();
</script>
{% endblock %}
