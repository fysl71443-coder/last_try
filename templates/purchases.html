{% extends 'base.html' %}
{% set back_url = url_for('inventory') %}

{% block title %}{{ _('Purchases / Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª') }}{% endblock %}
{% block content %}

<style>
body {
  background: #f4f6f9;
}
.purchases-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0px 4px 8px rgba(0,0,0,0.05);
  padding: 1.5rem;
  margin-bottom: 1rem;
}
.status-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: bold;
}
.status-unpaid { background: #ffeaa7; color: #2d3436; }
.status-partial { background: #fab1a0; color: #2d3436; }
.status-paid { background: #00b894; color: white; }
.item-row {
  border: 1px solid #e9ecef;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 0.5rem;
  background: #f8f9fa;
}
.stock-info {
  font-size: 0.8rem;
  color: #6c757d;
  font-style: italic;
}
</style>

<div class="container py-4">
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹ -->
    <div class="row mb-3">
        <div class="col-md-6">
            <h3 class="mb-0">ğŸ›’ {{ _('Purchases / Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª') }}</h3>
        </div>
        <div class="col-md-6 text-end">
            <a href="{{ url_for('raw_materials') }}" class="btn btn-outline-success me-2">
                ğŸ¥˜ {{ _('Raw Materials / Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…') }}
            </a>
            <a href="{{ url_for('sales') }}" class="btn btn-outline-info me-2">
                ğŸ’° {{ _('Sales / Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª') }}
            </a>
            <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
                ğŸ  {{ _('Dashboard / Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…') }}
            </a>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø© -->
    <div class="purchases-card">
        <h5 class="mb-3">{{ _('Create New Purchase Invoice / Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø©') }}</h5>

        <form method="POST" id="purchase-form">
            {{ form.hidden_tag() }}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

            <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ -->
            <div class="card mb-3">
              <div class="card-header bg-light fw-semibold">{{ _('Supplier Info / Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯') }}</div>
              <div class="card-body">
                <div class="row g-3 align-items-end">
                  <div class="col-md-4">
                    <label class="form-label">{{ _('Supplier / Ø§Ù„Ù…ÙˆØ±Ø¯') }}</label>
                    <select name="supplier_name" id="supplier_select" class="form-select">
                      <option value="">{{ _('Select Supplier / Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯') }}</option>
                      {% for s in suppliers_list or [] %}
                        <option value="{{ s.name }}" data-id="{{ s.id }}">{{ s.name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">{{ _('Phone / Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ') }}</label>
                    <input id="s_phone" class="form-control" value="" readonly>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">{{ _('Tax Number / Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ') }}</label>
                    <input id="s_tax" class="form-control" value="" readonly>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">{{ _('Address / Ø§Ù„Ù…ÙˆÙ‚Ø¹') }}</label>
                    <input id="s_address" class="form-control" value="" readonly>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">{{ _('CR Number / Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ') }}</label>
                    <input id="s_cr" class="form-control" value="" readonly>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">{{ _('IBAN / Ø§Ù„Ø¢ÙŠØ¨Ø§Ù†') }}</label>
                    <input id="s_iban" class="form-control" value="" readonly>
                  </div>
                </div>
                <input type="hidden" name="supplier_id" id="supplier_id" value="">
              </div>
            </div>

            <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
            <div class="card mb-3">
              <div class="card-header bg-light fw-semibold">{{ _('Invoice Info / Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©') }}</div>
              <div class="card-body">
                <div class="row g-3 align-items-end mb-2">
                  <div class="col-md-3">
                    {{ form.date.label(class_='form-label') }}
                    {{ form.date(class_='form-control') }}
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">{{ _('Invoice No / Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©') }}</label>
                    <input class="form-control" value="{{ _('Auto on save (e.g. INV-PUR-YYYY-0001) / ÙŠÙÙˆÙ„Ù‘Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸ (Ù…Ø«Ø§Ù„: INV-PUR-YYYY-0001)') }}" readonly>
                  </div>
                  <div class="col-md-3">
                    {{ form.payment_method.label(class_='form-label') }}
                    {{ form.payment_method(class_='form-select') }}
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">{{ _('Reference No / Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹') }}</label>
                    <input name="reference_number" class="form-control" placeholder="PO/Ref if provided">
                  </div>
                </div>

            <!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
            <h6 class="mb-3">{{ _('Invoice Items / Ø£ØµÙ†Ø§Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©') }}</h6>
            <div id="items-container">
                <datalist id="materials-datalist"></datalist>
                {% for item_form in form.items %}
                <div class="item-row">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">{{ _('Item / Ø§Ù„ØµÙ†Ù') }}</label>
                            <input class="form-control item-name-input" name="items-{{ loop.index0 }}-item_name" list="materials-datalist" placeholder="{{ _('Type item name / Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©') }}">
                            <div class="stock-info" id="stock-info-{{ loop.index0 }}"></div>
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">{{ _('Unit / Ø§Ù„ÙˆØ­Ø¯Ø©') }}</label>
                            <input class="form-control unit-input" name="items-{{ loop.index0 }}-unit" placeholder="{{ _('e.g., kg') }}">
                        </div>
                        <div class="col-md-2">
                            {{ item_form.quantity.label(class_='form-label') }}
                            {{ item_form.quantity(class_='form-control', step='0.0001') }}
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">{{ _('Price / Ø§Ù„Ø³Ø¹Ø±') }}</label>
                            {{ item_form.price_before_tax(class_='form-control', step='0.0001') }}
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">{{ _('Discount %% / Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… %%') }}</label>
                            {{ item_form.discount(class_='form-control', step='0.01', min='0', max='100') }}
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">{{ _('Tax %% / Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© %%') }}</label>
                            <input class="form-control" name="items-{{ loop.index0 }}-tax_pct" step="0.01" type="number" min="0" max="100" value="15">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">{{ _('Total / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ') }}</label>
                            <div class="form-control bg-light item-total">$0.00</div>
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="button" class="btn btn-danger btn-sm remove-item-btn">âˆ’</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Ù…Ù„Ø®Øµ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="form-label">{{ _('Total Before Discount & Tax / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ… ÙˆØ§Ù„Ø¶Ø±ÙŠØ¨Ø©') }}</label>
                    <div class="form-control bg-light" id="total-before-tax">$0.00</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">{{ _('Tax / Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©') }}</label>
                    <div class="form-control bg-light" id="tax-amount">$0.00</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">{{ _('Total Discount / Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙ…') }}</label>
                    <div class="form-control bg-light" id="total-discount">$0.00</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">{{ _('Final Total / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ') }}</label>
                    <div class="form-control bg-success text-white fw-bold" id="final-total">$0.00</div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <button type="button" class="btn btn-secondary" id="add-item">
                        â• {{ _('Add Item / Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù') }}
                    </button>
                </div>
                <div class="col-md-6 text-end">
                    {{ form.submit(class_='btn btn-primary btn-lg') }}
                </div>
            </div>
        </form>
    </div>

</div>

<!-- SocketIO and JavaScript -->
<script>
    // Materials data for calculations and stock info
    const materials = {{ materials_json | safe }};


    // Auto-calculation functionality with input normalization and safety clamps
    function toAsciiDigits(str){
        let s = String(str || '');
        const ar = 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
        const fa = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹';
        for(let i=0;i<10;i++){ s = s.replace(new RegExp(ar[i],'g'), String(i)); }
        for(let i=0;i<10;i++){ s = s.replace(new RegExp(fa[i],'g'), String(i)); }
        return s;
    }
    function clamp(v, min, max){ v = parseFloat(v); if (isNaN(v)) v = 0; return Math.min(max, Math.max(min, v)); }
    function calculateTotals() {
        const rows = Array.from(document.querySelectorAll('.item-row'));
        let totalBefore = 0, totalDiscount = 0, totalTax = 0, finalTotal = 0;
        rows.forEach(row => {
            const qVal = row.querySelector('input[name$="-quantity"]')?.value;
            const pVal = row.querySelector('input[name$="-price_before_tax"]')?.value;
            const dVal = row.querySelector('input[name$="-discount"]')?.value;
            const tVal = row.querySelector('input[name$="-tax_pct"]')?.value;
            const q = parseFloat(toAsciiDigits(qVal)) || 0;
            const p = parseFloat(toAsciiDigits(pVal)) || 0;
            let dPct = parseFloat(toAsciiDigits(dVal)) || 0;
            let tPct = parseFloat(toAsciiDigits(tVal)) || 0;
            dPct = clamp(dPct, 0, 100);
            tPct = clamp(tPct, 0, 100);
            const before = q * p;
            let discount = before * (dPct / 100.0);
            if (discount > before) discount = before;
            const base = Math.max(before - discount, 0);
            const tax = base * (tPct / 100.0);
            const lineTotal = base + tax;
            totalBefore += before;
            totalDiscount += discount;
            totalTax += tax;
            finalTotal += lineTotal;
            const totalDisplay = row.querySelector('.item-total');
            if (totalDisplay) totalDisplay.textContent = '$' + lineTotal.toFixed(2);
        });
        document.getElementById('total-before-tax').textContent = '$' + totalBefore.toFixed(2);
        document.getElementById('tax-amount').textContent = '$' + totalTax.toFixed(2);
        document.getElementById('total-discount').textContent = '$' + totalDiscount.toFixed(2);
        document.getElementById('final-total').textContent = '$' + finalTotal.toFixed(2);
    }

    // Show stock info when material is selected
    function updateStockInfoByName(inputEl) {
        const val = (inputEl.value || '').trim().toLowerCase();
        const stockInfoDiv = inputEl.parentElement.querySelector('.stock-info');
        const unitInput = inputEl.closest('.row').querySelector('.unit-input');
        let match = null;
        for (const m of materials) {
            const dn = (m.name || '').toLowerCase();
            const en = dn.split('/')[0].trim();
            if (dn === val || en === val) { match = m; break; }
        }
        if (match) {
            stockInfoDiv.textContent = `Current stock: ${match.stock_quantity} ${match.unit} | Cost: $${match.cost_per_unit}/unit`;
            if (unitInput && !unitInput.value) unitInput.value = match.unit || '';
        } else {
            stockInfoDiv.textContent = '';
        }
    }


    // Event listeners
    document.addEventListener('change', e => {
        if (e.target.matches('input[name$="-item_name"]')) {
            updateStockInfoByName(e.target);
            calculateTotals();
        } else if (e.target.matches('input[name$="-quantity"], input[name$="-price_before_tax"], input[name$="-discount"], input[name$="-tax_pct"], input[name$="-unit"]')) {
            calculateTotals();
        }
    });

    // Add new item functionality
    let itemIndex = {{ form.items|length }};

    document.getElementById('add-item').addEventListener('click', function() {
        const container = document.getElementById('items-container');
        const newItem = document.createElement('div');
        newItem.className = 'item-row';
        newItem.innerHTML = `
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">{{ _('Item / Ø§Ù„ØµÙ†Ù') }}</label>
                    <input class="form-control item-name-input" name="items-${itemIndex}-item_name" list="materials-datalist" placeholder="{{ _('Type item name / Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©') }}">
                    <div class="stock-info"></div>
                </div>
                <div class="col-md-1">
                    <label class="form-label">{{ _('Unit / Ø§Ù„ÙˆØ­Ø¯Ø©') }}</label>
                    <input class="form-control unit-input" name="items-${itemIndex}-unit" placeholder="{{ _('e.g., kg') }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label">{{ _('Quantity / Ø§Ù„ÙƒÙ…ÙŠØ©') }}</label>
                    <input class="form-control" name="items-${itemIndex}-quantity" step="0.0001" type="number">
                </div>
                <div class="col-md-2">
                    <label class="form-label">{{ _('Price / Ø§Ù„Ø³Ø¹Ø±') }}</label>
                    <input class="form-control" name="items-${itemIndex}-price_before_tax" step="0.0001" type="number">
                </div>
                <div class="col-md-2">
                    <label class="form-label">{{ _('Discount %% / Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… %%') }}</label>
                    <input class="form-control" name="items-${itemIndex}-discount" step="0.01" type="number" min="0" max="100" value="0">
                </div>
                <div class="col-md-1">
                    <label class="form-label">{{ _('Tax %% / Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© %%') }}</label>
                    <input class="form-control" name="items-${itemIndex}-tax_pct" step="0.01" type="number" min="0" max="100" value="15">
                </div>
                <div class="col-md-1">
                    <label class="form-label">{{ _('Total / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ') }}</label>
                    <div class="form-control bg-light item-total">$0.00</div>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-danger btn-sm remove-item-btn">âˆ’</button>
                </div>
            </div>
        `;
        container.appendChild(newItem);
        itemIndex++;
    });

    // Remove item functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-item-btn')) {
            e.target.closest('.item-row').remove();
            calculateTotals();
        }
    });

    </script>


<script>
(function(){
  const SUPPLIERS = JSON.parse({{ (suppliers_json or '[]') | tojson | safe }});
  const input = document.getElementById('supplier_select');
  const hiddenId = document.getElementById('supplier_id');
  const phone = document.getElementById('s_phone');
  const tax = document.getElementById('s_tax');
  const address = document.getElementById('s_address');
  const cr = document.getElementById('s_cr');
  const iban = document.getElementById('s_iban');

  function renderSupplier(s){
    if(!s){
      hiddenId.value='';
      if(phone) phone.value='';
      if(tax) tax.value='';
      if(address) address.value='';
      if(cr) cr.value='';
      if(iban) iban.value='';
      return;
    }
    hiddenId.value = s.id || '';
    if(phone) phone.value = s.phone || '';
    if(tax) tax.value = s.tax_number || '';
    if(address) address.value = s.address || '';
    // CR & IBAN may not exist in model yet -> leave empty
    if(cr) cr.value = s.cr_number || '';
    if(iban) iban.value = s.iban || '';
  }

  function matchSupplierByName(name){
    if(!name) return null;
    const n = name.trim().toLowerCase();
    return SUPPLIERS.find(s => (s.name||'').toLowerCase() === n) || null;
  }

  if(input){
    const update = ()=>{ renderSupplier(matchSupplierByName(input.value)); };
    input.addEventListener('change', update);
    input.addEventListener('blur', update);
    update();
  }
})();
</script>

<script>


    // Initialize stock info and calculations
    document.addEventListener('DOMContentLoaded', function() {
        const dl = document.getElementById('materials-datalist');
        if (dl) {
            dl.innerHTML = materials.map(m => `<option value="${m.name}"></option>`).join('');
        }
        document.querySelectorAll('input[name$="-item_name"]').forEach(updateStockInfoByName);
        calculateTotals();
    });
</script>

{% endblock %}
