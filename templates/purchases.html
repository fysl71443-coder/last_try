{% extends 'base.html' %}
{% set back_url = url_for('main.dashboard') %}

{% block title %}{{ _('Purchases / Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª') }}{% endblock %}
{% block content %}

<style>
body {
  background: #f4f6f9;
}
.purchases-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0px 4px 8px rgba(0,0,0,0.05);
  padding: 1.5rem;
  margin-bottom: 1rem;
}
.status-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: bold;
}
.status-unpaid { background: #ffeaa7; color: #2d3436; }
.status-partial { background: #fab1a0; color: #2d3436; }
.status-paid { background: #00b894; color: white; }
.item-row {
  border: 1px solid #e9ecef;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 0.5rem;
  background: #f8f9fa;
}
.stock-info {
  font-size: 0.8rem;
  color: #6c757d;
  font-style: italic;
}
</style>

<div class="container py-4">
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹ -->
    <div class="section-header mb-3">
        <h3 class="mb-0">ğŸ›’ {{ _('Purchases / Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª') }}</h3>
        <div class="d-flex flex-wrap gap-2">
            <a href="{{ url_for('main.raw_materials') }}" class="btn btn-outline-success">
                ğŸ¥˜ {{ _('Raw Materials / Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…') }}
            </a>
            <a href="{{ url_for('main.sales') }}" class="btn btn-outline-info">
                ğŸ’° {{ _('Sales / Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª') }}
            </a>
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary">
                ğŸ  {{ _('Dashboard / Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…') }}
            </a>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø© -->
    <div class="purchases-card">
        <h5 class="mb-3">{{ _('Create New Purchase Invoice / Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø©') }}</h5>

        <form method="POST" id="purchase-form">
            {{ form.hidden_tag() }}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

            <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ -->
            <div class="card mb-3">
              <div class="card-header bg-light fw-semibold">{{ _('Supplier Info / Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯') }}</div>
              <div class="card-body">
                <div class="row g-3 align-items-end">
                  <div class="col-md-3">
                    <label class="form-label">{{ _('Invoice Type / Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©') }}</label>
                    <select id="invoice_type" name="invoice_type" class="form-select">
                      <option value="VAT">{{ _('VAT / Ø¶Ø±ÙŠØ¨Ø© Ù‚ÙŠÙ…Ø© Ù…Ø¶Ø§ÙØ©') }}</option>
                      <option value="NO_VAT">{{ _('Ø¨Ø¯ÙˆÙ† VAT') }}</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">{{ _('Supplier / Ø§Ù„Ù…ÙˆØ±Ø¯') }}</label>
                    <select name="supplier_name" id="supplier_select" class="form-select">
                      <option value="">{{ _('Select Supplier / Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯') }}</option>
                      {% for s in suppliers_list or [] %}
                        <option value="{{ s.name }}" data-id="{{ s.id }}">{{ s.name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-3" id="supplier_free_box" style="display:none;">
                    <label class="form-label">{{ _('Supplier / Ø§Ù„Ù…ÙˆØ±Ø¯ Ø£Ùˆ Ø§Ù„Ø¬Ù‡Ø©') }}</label>
                    <input name="supplier_name_free" id="supplier_free" class="form-control" placeholder="{{ _('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ Ø£Ùˆ Ø§Ù„Ø¬Ù‡Ø©') }}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">{{ _('Phone / Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ') }}</label>
                    <input id="s_phone" class="form-control" value="" readonly>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">{{ _('Tax Number / Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ') }}</label>
                    <input id="s_tax" class="form-control" value="" readonly>
                  </div>
                </div>
                <div class="row g-3 align-items-end mt-1">
                  <div class="col-md-6">
                    <label class="form-label">{{ _('Address / Ø§Ù„Ù…ÙˆÙ‚Ø¹') }}</label>
                    <input id="s_address" class="form-control" value="" readonly>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">{{ _('CR Number / Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ') }}</label>
                    <input id="s_cr" class="form-control" value="" readonly>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">{{ _('IBAN / Ø§Ù„Ø¢ÙŠØ¨Ø§Ù†') }}</label>
                    <input id="s_iban" class="form-control" value="" readonly>
                  </div>
                </div>
                <input type="hidden" name="supplier_id" id="supplier_id" value="">
              </div>
            </div>

            <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
            <div class="card mb-3">
              <div class="card-header bg-light fw-semibold">{{ _('Invoice Info / Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©') }}</div>
              <div class="card-body">
                <div class="row g-3 align-items-end mb-2">
                  <div class="col-md-3">
                    {{ form.date.label(class_='form-label') }}
                    {{ form.date(class_='form-control') }}
                  </div>
                  <div class="col-md-3">
                    {{ form.payment_method.label(class_='form-label') }}
                    {{ form.payment_method(class_='form-select') }}
                  </div>
                  
                  <div class="col-md-3" style="display:none;">
                    <label class="form-label">{{ _('Invoice No / Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©') }}</label>
                    <input class="form-control" value="{{ _('Auto on save (e.g. INV-PUR-YYYY-0001) / ÙŠÙÙˆÙ„Ù‘Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸ (Ù…Ø«Ø§Ù„: INV-PUR-YYYY-0001)') }}" readonly>
                  </div>
                </div>
                <div class="row g-3 align-items-end mb-2">
                  <div class="col-md-3">
                    <label class="form-label">{{ _('Supplier Invoice No / Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯') }}</label>
                    <input name="supplier_invoice_number" class="form-control" placeholder="{{ _('Ø¥Ù† ÙˆØ¬Ø¯') }}">
                  </div>
                  <div class="col-md-9">
                    <label class="form-label">{{ _('Notes / Ù…Ù„Ø§Ø­Ø¸Ø§Øª') }}</label>
                    <input name="notes" class="form-control" placeholder="{{ _('Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)') }}">
                  </div>
                </div>
                <div class="row g-3 mt-1">
                  <div class="col-md-3">
                    <label class="form-label">{{ _('Payment Status / Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹') }}</label>
                    <select name="status" id="purchase-status" class="form-select">
                      <option value="unpaid">{{ _('Unpaid / ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹') }}</option>
                      <option value="partial">{{ _('Partial / Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹') }}</option>
                      <option value="paid">{{ _('Paid / Ù…Ø¯ÙÙˆØ¹') }}</option>
                    </select>
                  </div>
                  <div class="col-md-3" id="partial-paid-box" style="display:none;">
                    <label class="form-label">{{ _('Paid Amount (Partial) / Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ø¬Ø²Ø¦ÙŠ)') }}</label>
                    <input name="partial_paid_amount" id="partial-paid-amount" type="number" step="0.01" min="0" class="form-control" placeholder="0.00">
                    <div class="form-text">{{ _('Max is Final Total / Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù‡Ùˆ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ') }}: <span id="partial-max"></span></div>
                  </div>
                </div>


            <!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ù…ÙˆØ§Ø¯ Ø®Ø§Ù… ØªØ¯Ø®Ù„ ÙÙŠ ØªÙƒÙˆÙŠÙ† Ø§Ù„ÙˆØ¬Ø¨Ø§Øª) -->
            <div class="card mb-3">
              <div class="card-header bg-light fw-semibold">{{ _('Purchase Items / Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡') }}</div>
              <div class="card-body" id="items-container">
                {% for item_form in form.items %}
                <div class="item-row">
                  <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                      {{ item_form.category.label(class_='form-label') }}
                      {{ item_form.category(class_='form-select category-select') }}
                    </div>
                    <div class="col-md-4">
                      {{ item_form.raw_material_id.label(class_='form-label') }}
                      {{ item_form.raw_material_id(class_='form-select material-select') }}
                      <div class="stock-info"></div>
                    </div>
                    <div class="col-md-2">
                      {{ item_form.quantity.label(class_='form-label') }}
                      {{ item_form.quantity(class_='form-control', step='0.01', type='text', inputmode='decimal', dir='ltr', pattern='[0-9Ù -Ù©Û°-Û¹.,Ù«ØŒ]+' ) }}
                    </div>
                    <div class="col-md-2">
                      {{ item_form.price_before_tax.label(class_='form-label') }}
                      {{ item_form.price_before_tax(class_='form-control', step='0.01', type='text', inputmode='decimal', dir='ltr', pattern='[0-9Ù -Ù©Û°-Û¹.,Ù«ØŒ]+' ) }}
                    </div>
                    <!-- Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø®ØµÙ… ÙˆØ§Ù„Ø¶Ø±ÙŠØ¨Ø© Ù„ÙƒÙ„ Ø¨Ù†Ø¯ Ù„ØªØ¨Ø³ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
                    <div class="col-md-2" style="display:none;">
                      {{ item_form.discount.label(class_='form-label') }}
                      {{ item_form.discount(class_='form-control', step='0.01') }}
                    </div>
                    <div class="col-md-1" style="display:none;">
                      <label class="form-label">VAT %</label>
                      <input type="number" step="0.01" class="form-control" name="items-{{ loop.index0 }}-tax_pct" value="0">
                    </div>
                  </div>
                </div>
                {% endfor %}
                <div class="d-flex justify-content-end">
                  <button type="button" class="btn btn-outline-success" id="add-item-btn">{{ _('Add Item / Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯') }}</button>
                </div>
              </div>
            </div>

            <!-- Ù…Ù„Ø®Øµ Ù…Ø¨Ø³Ø· Ø­Ø³Ø¨ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
            <div class="card mb-3">
              <div class="card-header bg-light fw-semibold">{{ _('Totals / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª') }}</div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-3" style="display:none;">
                    <label class="form-label">{{ _('Items Count / Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù') }}</label>
                    <input type="number" id="items_count" name="items_count" class="form-control" value="">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">{{ _('Inventory Kind / Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†') }}</label>
                    <select id="inventory_kind" name="inventory_kind" class="form-select">
                      <option value="">{{ _('None / Ø¨Ø¯ÙˆÙ†') }}</option>
                      <option value="FOOD">{{ _('Food Materials / Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©') }}</option>
                      <option value="OTHER">{{ _('Other Supplies / Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø£Ø®Ø±Ù‰') }}</option>
                    </select>
                    <div class="form-check mt-2">
                      <input class="form-check-input" type="checkbox" id="production_flag" name="production_flag">
                      <label class="form-check-label" for="production_flag">{{ _('Goes to Production / ØªØ¯Ø®Ù„ Ø§Ù„Ø¥Ù†ØªØ§Ø¬') }}</label>
                    </div>
                  </div>
                </div>
                <hr/>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div>{{ _('Purchases Total / Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª') }}: <strong id="final-total"></strong></div>
                        <div>{{ _('VAT Total / Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©') }}: <strong id="display_vat"></strong></div>
                    </div>
                    <div>
                        <button type="submit" class="btn btn-primary">{{ _('Save / Ø­ÙØ¸') }}</button>
                        <button type="reset" class="btn btn-outline-secondary">{{ _('Clear / Ù…Ø³Ø­') }}</button>
                    </div>
                </div>
              </div>
            </div>
        </form>
    </div>

</div>

<!-- SocketIO and JavaScript -->
<script>
    // Materials data for calculations and stock info
    const materials = {{ materials_json | safe }};


    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø¨Ù†ÙˆØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
    function toAsciiDigits(str){
        let s = String(str || '');
        const ar = 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'; const fa = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹';
        for(let i=0;i<10;i++){ s = s.replace(new RegExp(ar[i],'g'), String(i)); s = s.replace(new RegExp(fa[i],'g'), String(i)); }
        return s;
    }
    function calculateTotals() {
        const invType = (document.getElementById('invoice_type')?.value || 'VAT').toUpperCase();
        const VAT_RATE = invType === 'VAT' ? 0.15 : 0.0;
        let base = 0.0, vat = 0.0, cnt = 0;
        document.querySelectorAll('#items-container .item-row').forEach(row => {
            const qEl = row.querySelector('[name*="-quantity"]');
            const pEl = row.querySelector('[name*="-price_before_tax"]');
            const dEl = row.querySelector('[name*="-discount"]');
            const q = parseFloat(toAsciiDigits(qEl?.value||'')) || 0;
            const p = parseFloat(toAsciiDigits(pEl?.value||'')) || 0;
            const d = parseFloat(toAsciiDigits(dEl?.value||'')) || 0;
            if(q>0 && p>0){
                let line = (q*p) - d; if(line<0) line = 0;
                base += line; vat += line * VAT_RATE; cnt += 1;
            }
        });
        const totalEl = document.getElementById('final-total');
        const vatEl = document.getElementById('display_vat');
        if(totalEl) totalEl.textContent = base>0 || vat>0 ? ('ï·¼' + (base+vat).toFixed(2)) : '';
        if(vatEl) vatEl.textContent = vat>0 ? ('ï·¼' + vat.toFixed(2)) : 'ï·¼0.00';
        const cntEl = document.getElementById('items_count'); if(cntEl) cntEl.value = String(cnt);
        try{ if(typeof updatePartialMax==='function') updatePartialMax(); }catch(e){}
    }

    // Show stock info when material is selected
    function updateStockInfoByName(inputEl) {
        const val = (inputEl.value || '').trim().toLowerCase();
        const stockInfoDiv = inputEl.parentElement.querySelector('.stock-info');
        const unitInput = inputEl.closest('.row').querySelector('.unit-input');
        let match = null;
        for (const m of materials) {
            const dn = (m.name || '').toLowerCase();
            const en = dn.split('/')[0].trim();
            if (dn === val || en === val) { match = m; break; }
        }
        if (match) {
            stockInfoDiv.textContent = `Current stock: ${match.stock_quantity} ${match.unit} | Cost: ï·¼${match.cost_per_unit}/unit`;
            if (unitInput && !unitInput.value) unitInput.value = match.unit || '';
        } else {
            stockInfoDiv.textContent = '';
        }
    }


    // Event listeners
    document.addEventListener('input', e => {
        if (e.target && /items-\d+-(quantity|price_before_tax|discount)/.test(e.target.name||'')) {
            try{ e.target.value = toAsciiDigits(e.target.value); }catch(err){}
            calculateTotals();
        }
    });
    document.getElementById('invoice_type')?.addEventListener('change', calculateTotals);

    (function(){
      const container = document.getElementById('items-container');
      const addBtn = document.getElementById('add-item-btn');
      async function fetchMaterialsByCategory(cat){
        try{
          const url = cat ? (`/api/raw_materials?category=${encodeURIComponent(cat)}`) : '/api/raw_materials';
          const resp = await fetch(url);
          if(!resp.ok) throw new Error('HTTP '+resp.status);
          const j = await resp.json();
          return (j && j.ok) ? (j.items||[]) : [];
        }catch(e){ return []; }
      }
      async function fetchCategories(){
        try{
          const resp = await fetch('/api/raw_materials/categories');
          if(!resp.ok) throw new Error('HTTP '+resp.status);
          const j = await resp.json();
          return (j && j.ok) ? (j.categories||[]) : [];
        }catch(e){ return []; }
      }
      function populateCategorySelect(sel, cats){
        const current = sel.value;
        sel.innerHTML = '';
        const opt0 = document.createElement('option'); opt0.value = ''; opt0.textContent = '{{ _('Select Category / Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©') }}'; sel.appendChild(opt0);
        cats.forEach(c=>{ const opt=document.createElement('option'); opt.value = c.name; opt.textContent = c.label; sel.appendChild(opt); });
        if(current){ sel.value=current; }
      }
      function populateMaterialsSelect(sel, arr){
        const current = sel.value;
        sel.innerHTML = '';
        const opt0 = document.createElement('option'); opt0.value = '0'; opt0.textContent = '{{ _('Select Raw Material / Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø®Ø§Ù…') }}'; sel.appendChild(opt0);
        arr.forEach(o=>{ const opt=document.createElement('option'); opt.value = o.id; opt.textContent = o.name; sel.appendChild(opt); });
        if(current){ sel.value=current; }
      }
      async function onCategoryChange(e){
        const row = e.target.closest('.item-row');
        const matSel = row?.querySelector('.material-select');
        const cat = e.target.value;
        const arr = await fetchMaterialsByCategory(cat);
        populateMaterialsSelect(matSel, arr);
        // Reset unit when category changes
        const unitInput = row?.querySelector('.unit-input');
        if(unitInput){ unitInput.value=''; }
      }
      async function onMaterialChange(e){
        const row = e.target.closest('.item-row');
        const catSel = row?.querySelector('.category-select');
        const unitInput = row?.querySelector('.unit-input');
        const stockInfoDiv = row?.querySelector('.stock-info');
        const cat = catSel?.value || '';
        const id = e.target.value;
        if(!id){ if(unitInput) unitInput.value=''; if(stockInfoDiv) stockInfoDiv.textContent=''; return; }
        const arr = await fetchMaterialsByCategory(cat);
        const item = arr.find(o => String(o.id) === String(id));
        if(item){
          if(unitInput) unitInput.value = item.unit || '';
          if(stockInfoDiv) stockInfoDiv.textContent = `Current stock: ${item.stock_quantity} ${item.unit} | Cost: ï·¼${Number(item.cost_per_unit||0).toFixed(2)}/unit`;
        } else {
          if(unitInput) unitInput.value='';
          if(stockInfoDiv) stockInfoDiv.textContent='';
        }
      }
      async function attachRowEvents(row){
        const catSel = row.querySelector('.category-select');
        const matSel = row.querySelector('.material-select');
        if(catSel){
          const cats = await fetchCategories();
          populateCategorySelect(catSel, cats);
          catSel.addEventListener('change', onCategoryChange);
        }
        if(matSel && catSel){
          const arr = await fetchMaterialsByCategory(catSel.value||'');
          populateMaterialsSelect(matSel, arr);
          matSel.addEventListener('change', onMaterialChange);
          // Initialize unit/stock for current selection
          await onMaterialChange({ target: matSel });
        }
      }
      function nextIndex(){
        const rows = container.querySelectorAll('.item-row'); return rows.length;
      }
      function cloneLast(){
        const rows = container.querySelectorAll('.item-row');
        if (rows.length===0) return;
        const last = rows[rows.length-1];
        const clone = last.cloneNode(true);
        const idx = nextIndex();
        clone.querySelectorAll('select, input').forEach(el=>{
          const n = el.getAttribute('name');
          if(n && n.startsWith('items-')){
            const parts = n.split('-'); parts[1] = String(idx); el.setAttribute('name', parts.join('-'));
          }
          if(el.tagName==='SELECT') el.selectedIndex=0; else el.value='';
        });
        container.insertBefore(clone, addBtn.parentElement);
        attachRowEvents(clone);
      }
      addBtn?.addEventListener('click', function(){ cloneLast(); calculateTotals(); });
      // Attach events for initial rows
      container.querySelectorAll('.item-row').forEach(row=>{ attachRowEvents(row); });
      calculateTotals();
    })();

    // Remove item functionality
    // No per-item remove under the new design

    </script>


<script>
(function(){
  const SUPPLIERS = {{ (suppliers_json or '[]') | tojson | safe }};
  const input = document.getElementById('supplier_select');
  const freeBox = document.getElementById('supplier_free_box');
  const freeInput = document.getElementById('supplier_free');
  const hiddenId = document.getElementById('supplier_id');
  const phone = document.getElementById('s_phone');
  const tax = document.getElementById('s_tax');
  const address = document.getElementById('s_address');
  const cr = document.getElementById('s_cr');
  const iban = document.getElementById('s_iban');
  const invType = document.getElementById('invoice_type');

  function renderSupplier(s){
    if(!s){
      hiddenId.value='';
      if(phone) phone.value='';
      if(tax) tax.value='';
      if(address) address.value='';
      if(cr) cr.value='';
      if(iban) iban.value='';
      return;
    }
    hiddenId.value = s.id || '';
    if(phone) phone.value = s.phone || '';
    if(tax) tax.value = s.tax_number || '';
    if(address) address.value = s.address || '';
    // CR & IBAN may not exist in model yet -> leave empty
    if(cr) cr.value = s.cr_number || '';
    if(iban) iban.value = s.iban || '';
  }

  function matchSupplierByName(name){
    if(!name) return null;
    const n = name.trim().toLowerCase();
    return SUPPLIERS.find(s => (s.name||'').toLowerCase() === n) || null;
  }

  if(input){
    const update = ()=>{ renderSupplier(matchSupplierByName(input.value)); };
    input.addEventListener('change', update);
    input.addEventListener('blur', update);
    update();
  }

  function toggleSupplierMode(){
    const t = (invType?.value||'VAT').toUpperCase();
    if(t === 'NO_VAT'){
      if(freeBox) freeBox.style.display='';
    }else{
      if(freeBox) freeBox.style.display='none';
      if(freeInput) freeInput.value='';
    }
    setDefaultTaxByType();
  }

  function setDefaultTaxByType(){
    const t = (invType?.value||'VAT').toUpperCase();
        const vatInput = document.getElementById('vat_amount');
        if(vatInput){ vatInput.value=''; }
        calculateTotals();
  }
  invType?.addEventListener('change', toggleSupplierMode);
  toggleSupplierMode();
})();
</script>

<script>


    // Initialize stock info and calculations
    document.addEventListener('DOMContentLoaded', function() {
        calculateTotals();
    });
</script>

<script>
(function(){
  function parseMoneyText(txt){
    const s = String(txt||'').replace(/[^0-9.\-]/g,'');
    const v = parseFloat(s); return isNaN(v)?0:v;
  }
  function updatePartialMax(){
    const max = parseMoneyText(document.getElementById('final-total')?.textContent||'0');
    const span = document.getElementById('partial-max'); if(span) span.textContent = 'ï·¼' + max.toFixed(2);
    const inp = document.getElementById('partial-paid-amount');
    if(inp){ let v = parseFloat(inp.value||'0'); if(isNaN(v)) v = 0; if(v>max) inp.value = max.toFixed(2); if(v<0) inp.value='0.00'; }
  }
  function togglePartialBox(){
    const sel = document.getElementById('purchase-status');
    const box = document.getElementById('partial-paid-box');
    if(!sel || !box) return;
    if((sel.value||'').toLowerCase()==='partial'){ box.style.display=''; updatePartialMax(); }
    else { box.style.display='none'; }
  }
  document.addEventListener('DOMContentLoaded', function(){
    const sel = document.getElementById('purchase-status');
    if(sel){ sel.addEventListener('change', togglePartialBox); }
    togglePartialBox();
    updatePartialMax();
  });
})();
</script>


{% endblock %}
