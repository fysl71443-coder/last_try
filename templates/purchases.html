{% extends 'base.html' %}
{% set back_url = url_for('main.dashboard') %}

{% block title %}{{ _('Purchases / Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª') }}{% endblock %}
{% block content %}

<style>
  :root{--ui-bg:#f8fafc;--ui-primary:#1e3a8a;--ui-accent:#2563eb;--ui-soft:#eef2f7;--ui-border:#e5e9f2;--glass-bg:rgba(255,255,255,.7);--glass-border:rgba(226,232,240,.8);--shadow-1:0 6px 24px rgba(16,24,40,.06);--shadow-2:0 12px 40px rgba(16,24,40,.1);} 
  body{background:var(--ui-bg);} 
  .purchases-card{background:#ffffff;border-radius:16px;box-shadow:var(--shadow-1);padding:1rem;margin-bottom:1rem;border:1px solid var(--ui-border)}
  .section-header h3{font-weight:800;background:linear-gradient(90deg,#1e293b,#2563eb);-webkit-background-clip:text;background-clip:text;color:transparent}
  .btn{border-radius:12px}
  .btn-primary{background:var(--ui-primary);border:0;color:#fff}
  .btn-outline-success,.btn-outline-info{border:1px solid var(--ui-border)}
  .status-badge{padding:.25rem .75rem;border-radius:999px;font-size:.8rem;font-weight:700}
  .status-unpaid{background:#ffeaa7;color:#2d3436}
  .status-partial{background:#fab1a0;color:#2d3436}
  .status-paid{background:#00b894;color:#fff}
  .item-row{border:1px solid var(--ui-border);border-radius:16px;padding:1rem;margin-bottom:.75rem;background:#fbfcfe;box-shadow:0 2px 10px rgba(0,0,0,.04);animation:sectionIn .35s ease both}
  .stock-info{font-size:.8rem;color:#6c757d;font-style:italic}
  .card{border:1px solid #e6e9ef;border-radius:12px;box-shadow:0 1px 4px rgba(0,0,0,.05)}
  .card-header{border-radius:12px 12px 0 0;background:#f1f3f5;border-bottom:1px solid #e6e9ef}
  .form-control,.form-select{border-radius:10px;border:1px solid #d9dee7;background:#fff;transition:box-shadow .2s ease}
  .form-control:focus,.form-select:focus{box-shadow:0 0 0 3px rgba(13,110,253,.15)}
  .input-icon{position:relative}
  .input-icon .icon{position:absolute;left:.75rem;top:50%;transform:translateY(-50%);font-size:1rem;opacity:.55}
  .input-icon .form-control{padding-left:2.25rem}
  .floating-save{position:fixed;right:24px;bottom:24px;z-index:1000}
  .ripple{position:absolute;border-radius:50%;transform:scale(0);animation:ripple .6s linear;background:rgba(255,255,255,.6)}
  @keyframes ripple{to{transform:scale(4);opacity:0}}
  .sticky-totals{position:sticky;bottom:0;z-index:900;background:var(--glass-bg);backdrop-filter:blur(10px);border:1px solid var(--glass-border);border-radius:18px;box-shadow:var(--shadow-2)}
  .meter{height:8px;border-radius:999px;background:#e6ecf5;overflow:hidden}
  .meter>span{display:block;height:100%;border-radius:999px;background:linear-gradient(90deg,#2f3e7a,#0f172a);transition:width .4s ease}
  .fade-in{animation:fadeIn .35s ease both}
  .header-float{position:static;top:auto;padding:.5rem 0;z-index:auto;background:#ffffff}
  @keyframes fadeIn{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
  @keyframes sectionIn{from{opacity:0;transform:translateY(12px) scale(.98)}to{opacity:1;transform:translateY(0) scale(1)}}
  .hint-vat{font-size:.85rem;color:#1f2937;background:#eef2f7;border:1px dashed #d1d8e6;border-radius:999px;padding:.25rem .6rem;display:inline-block}
  .icon-float{transition:transform .18s ease}
  .icon-float:hover{transform:scale(1.06)}
  .hidden-adv{display:none}
</style>

<div class="container py-4">
    <div class="section-header header-float mb-3">
        <h3 class="mb-0">ğŸ›’ {{ _('Purchases / Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª') }}</h3>
        <div class="d-flex flex-wrap gap-2">
            <a href="{{ url_for('main.raw_materials') }}" class="btn btn-outline-success">
                <span class="icon-float">ğŸ¥˜</span> {{ _('Raw Materials / Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…') }}
            </a>
            <a href="{{ url_for('main.sales') }}" class="btn btn-outline-info">
                <span class="icon-float">ğŸ’°</span> {{ _('Sales / Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª') }}
            </a>
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary">
                <span class="icon-float">ğŸ </span> {{ _('Dashboard / Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…') }}
            </a>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø© -->
    <div class="purchases-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0 fade-in">{{ _('Create New Purchase Invoice / Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø©') }}</h5>
          <button type="button" class="btn btn-outline-secondary btn-sm" id="toggle-adv">{{ _('Show Advanced / Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©') }}</button>
        </div>

        <form method="POST" id="purchase-form">
            {{ form.hidden_tag() }}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

            <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ -->
            <div class="card mb-3 fade-in">
              <div class="card-header bg-light fw-semibold">{{ _('Supplier Info / Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯') }}</div>
              <div class="card-body">
                <div class="row g-3 align-items-end">
                  <div class="col-md-3">
                    <label class="form-label">{{ _('Invoice Type / Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©') }}</label>
                    <select id="invoice_type" name="invoice_type" class="form-select">
                      <option value="VAT">{{ _('VAT / Ø¶Ø±ÙŠØ¨Ø© Ù‚ÙŠÙ…Ø© Ù…Ø¶Ø§ÙØ©') }}</option>
                      <option value="NO_VAT">{{ _('Ø¨Ø¯ÙˆÙ† VAT') }}</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">{{ _('Supplier / Ø§Ù„Ù…ÙˆØ±Ø¯') }}</label>
                    <select name="supplier_name" id="supplier_select" class="form-select">
                      <option value="">{{ _('Select Supplier / Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯') }}</option>
                      {% for s in suppliers_list or [] %}
                        <option value="{{ s.name }}" data-id="{{ s.id }}">{{ s.name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-3" id="supplier_free_box" style="display:none;">
                    <label class="form-label">{{ _('Supplier / Ø§Ù„Ù…ÙˆØ±Ø¯ Ø£Ùˆ Ø§Ù„Ø¬Ù‡Ø©') }}</label>
                    <div class="input-icon"><span class="icon">ğŸ§¾</span><input name="supplier_name_free" id="supplier_free" class="form-control" placeholder="{{ _('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ Ø£Ùˆ Ø§Ù„Ø¬Ù‡Ø©') }}"></div>
                  </div>
                  <div class="col-md-4 hidden-adv">
                    <label class="form-label">{{ _('Phone / Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ') }}</label>
                    <div class="input-icon"><span class="icon">ğŸ“</span><input id="s_phone" class="form-control" value="" readonly></div>
                  </div>
                  <div class="col-md-4 hidden-adv">
                    <label class="form-label">{{ _('Tax Number / Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ') }}</label>
                    <div class="input-icon"><span class="icon">ğŸ“„</span><input id="s_tax" class="form-control" value="" readonly></div>
                  </div>
                </div>
                <div class="row g-3 align-items-end mt-1">
                  <div class="col-md-6 hidden-adv">
                    <label class="form-label">{{ _('Address / Ø§Ù„Ù…ÙˆÙ‚Ø¹') }}</label>
                    <div class="input-icon"><span class="icon">ğŸ“</span><input id="s_address" class="form-control" value="" readonly></div>
                  </div>
                  <div class="col-md-3 hidden-adv">
                    <label class="form-label">{{ _('CR Number / Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ') }}</label>
                    <div class="input-icon"><span class="icon">ğŸ¢</span><input id="s_cr" class="form-control" value="" readonly></div>
                  </div>
                  <div class="col-md-3 hidden-adv">
                    <label class="form-label">{{ _('IBAN / Ø§Ù„Ø¢ÙŠØ¨Ø§Ù†') }}</label>
                    <div class="input-icon"><span class="icon">ğŸ¦</span><input id="s_iban" class="form-control" value="" readonly></div>
                  </div>
                </div>
                <input type="hidden" name="supplier_id" id="supplier_id" value="">
              </div>
            </div>

            <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
            <div class="card mb-3 fade-in">
              <div class="card-header bg-light fw-semibold">{{ _('Invoice Info / Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©') }}</div>
              <div class="card-body">
                <div class="row g-3 align-items-end mb-2">
                  <div class="col-md-3">
                    {{ form.date.label(class_='form-label') }}
                    <div class="input-icon"><span class="icon">ğŸ“…</span>{{ form.date(class_='form-control') }}</div>
                    <div id="date-ar" class="form-text"></div>
                  </div>
                  <div class="col-md-3">
                    {{ form.payment_method.label(class_='form-label') }}
                    <div class="input-icon"><span class="icon">ğŸ’³</span>{{ form.payment_method(class_='form-select') }}</div>
                  </div>
                  
                  <div class="col-md-3 hidden-adv">
                    <label class="form-label">{{ _('Invoice No / Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©') }}</label>
                    <input class="form-control" value="{{ _('Auto on save (e.g. INV-PUR-YYYY-0001) / ÙŠÙÙˆÙ„Ù‘Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸ (Ù…Ø«Ø§Ù„: INV-PUR-YYYY-0001)') }}" readonly>
                  </div>
                </div>
                <div class="row g-3 align-items-end mb-2">
                  <div class="col-md-3 hidden-adv">
                    <label class="form-label">{{ _('Supplier Invoice No / Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯') }}</label>
                    <div class="input-icon"><span class="icon">ğŸ§¾</span><input name="supplier_invoice_number" class="form-control" placeholder="{{ _('Ø¥Ù† ÙˆØ¬Ø¯') }}"></div>
                  </div>
                  <div class="col-md-9 hidden-adv">
                    <label class="form-label">{{ _('Notes / Ù…Ù„Ø§Ø­Ø¸Ø§Øª') }}</label>
                    <div class="input-icon"><span class="icon">ğŸ“</span><input name="notes" class="form-control" placeholder="{{ _('Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)') }}"></div>
                  </div>
                </div>
                <div class="row g-3 mt-1">
                  <div class="col-md-3">
                    <label class="form-label">{{ _('Payment Status / Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹') }}</label>
                    <select name="status" id="purchase-status" class="form-select">
                      <option value="unpaid">{{ _('Unpaid / ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹') }}</option>
                      <option value="partial">{{ _('Partial / Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹') }}</option>
                      <option value="paid">{{ _('Paid / Ù…Ø¯ÙÙˆØ¹') }}</option>
                    </select>
                    <div class="meter mt-2"><span id="status-meter" style="width:10%"></span></div>
                  </div>
                  <div class="col-md-3" id="partial-paid-box" style="display:none;">
                    <label class="form-label">{{ _('Paid Amount (Partial) / Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ø¬Ø²Ø¦ÙŠ)') }}</label>
                    <input name="partial_paid_amount" id="partial-paid-amount" type="number" step="0.01" min="0" class="form-control" placeholder="0.00">
                    <div class="form-text">{{ _('Max is Final Total / Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù‡Ùˆ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ') }}: <span id="partial-max"></span></div>
                  </div>
                </div>


            <!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ù…ÙˆØ§Ø¯ Ø®Ø§Ù… ØªØ¯Ø®Ù„ ÙÙŠ ØªÙƒÙˆÙŠÙ† Ø§Ù„ÙˆØ¬Ø¨Ø§Øª) -->
            <div class="card mb-3 fade-in">
              <div class="card-header bg-light fw-semibold">{{ _('Purchase Items / Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡') }}</div>
              <div class="card-body" id="items-container">
                {% for item_form in form.items %}
                <div class="item-row">
                  <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                      {{ item_form.category.label(class_='form-label') }}
                      {{ item_form.category(class_='form-select category-select') }}
                    </div>
                    <div class="col-md-4">
                      {{ item_form.raw_material_id.label(class_='form-label') }}
                      {{ item_form.raw_material_id(class_='form-select material-select') }}
                      <div class="stock-info"></div>
                    </div>
                    <div class="col-md-2">
                      {{ item_form.quantity.label(class_='form-label') }}
                      {{ item_form.quantity(class_='form-control', step='0.01') }}
                    </div>
                    <div class="col-md-2">
                      {{ item_form.price_before_tax.label(class_='form-label') }}
                      {{ item_form.price_before_tax(class_='form-control', step='0.01') }}
                    </div>
                    <div class="col-md-2">
                      {{ item_form.discount.label(class_='form-label') }}
                      {{ item_form.discount(class_='form-control', step='0.01') }}
                    </div>
                    <div class="col-md-1 hidden-adv">
                      <label class="form-label">VAT %</label>
                      <input type="number" step="0.01" class="form-control" name="items-{{ loop.index0 }}-tax_pct" value="15" readonly>
                      <div class="form-text hint-vat">{{ _('Ø´Ø§Ù…Ù„ Ø¶Ø±ÙŠØ¨Ø© 15% ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹') }}</div>
                    </div>
                  </div>
                </div>
                {% endfor %}
                <div class="d-flex justify-content-end">
                  <button type="button" class="btn btn-outline-success hover-reflect" id="add-item-btn">{{ _('Add Item / Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯') }}</button>
                </div>
              </div>
            </div>

            <div class="card mb-3 sticky-totals">
              <div class="card-header bg-light fw-semibold">{{ _('Totals / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª') }}</div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-3 hidden-adv">
                    <label class="form-label">{{ _('Total Amount / Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ') }}</label>
                    <input type="number" step="0.01" id="total_amount" name="total_amount" class="form-control" value="" readonly>
                  </div>
                  <div class="col-md-3 hidden-adv">
                    <label class="form-label">{{ _('VAT Amount / Ù…Ø¨Ù„Øº Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©') }}</label>
                    <input type="number" step="0.01" id="vat_amount" name="vat_amount" class="form-control" value="" readonly>
                    <div class="form-text hint-vat">{{ _('Ø´Ø§Ù…Ù„ Ø¶Ø±ÙŠØ¨Ø© 15% ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹') }}</div>
                  </div>
                  <div class="col-md-3 hidden-adv">
                    <label class="form-label">{{ _('Items Count / Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù') }}</label>
                    <input type="number" id="items_count" name="items_count" class="form-control" value="">
                  </div>
                  <div class="col-md-3 hidden-adv">
                    <label class="form-label">{{ _('Inventory Kind / Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†') }}</label>
                    <select id="inventory_kind" name="inventory_kind" class="form-select">
                      <option value="">{{ _('None / Ø¨Ø¯ÙˆÙ†') }}</option>
                      <option value="FOOD">{{ _('Food Materials / Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©') }}</option>
                      <option value="OTHER">{{ _('Other Supplies / Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø£Ø®Ø±Ù‰') }}</option>
                    </select>
                    <div class="form-check mt-2">
                      <input class="form-check-input" type="checkbox" id="production_flag" name="production_flag">
                      <label class="form-check-label" for="production_flag">{{ _('Goes to Production / ØªØ¯Ø®Ù„ Ø§Ù„Ø¥Ù†ØªØ§Ø¬') }}</label>
                    </div>
                  </div>
                </div>
                <hr/>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div>{{ _('Purchases Total / Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª') }}: <strong id="display_total"></strong></div>
                        <div>{{ _('VAT Total / Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©') }}: <strong id="display_vat"></strong></div>
                        <div class="meter mt-2"><span id="calc-meter" style="width:0%"></span></div>
                    </div>
                    <div>
                        <button type="submit" class="btn btn-primary btn-glow floating-save" id="save-btn">{{ _('Save / Ø­ÙØ¸') }}</button>
                        <button type="reset" class="btn btn-outline-secondary">{{ _('Clear / Ù…Ø³Ø­') }}</button>
                    </div>
                </div>
              </div>
            </div>
        </form>
    </div>

</div>

<!-- SocketIO and JavaScript -->
<script>
    // Materials data for calculations and stock info
    const materials = {{ materials_json | safe }};


    // Auto-calculation
    function toAsciiDigits(str){
        let s = String(str || '');
        const ar = 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
        const fa = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹';
        for(let i=0;i<10;i++){ s = s.replace(new RegExp(ar[i],'g'), String(i)); }
        for(let i=0;i<10;i++){ s = s.replace(new RegExp(fa[i],'g'), String(i)); }
        return s;
    }
    function clamp(v, min, max){ v = parseFloat(v); if (isNaN(v)) v = 0; return Math.min(max, Math.max(min, v)); }
    function arDigits(s){const map={'0':'Ù ','1':'Ù¡','2':'Ù¢','3':'Ù£','4':'Ù¤','5':'Ù¥','6':'Ù¦','7':'Ù§','8':'Ù¨','9':'Ù©'};return String(s||'').replace(/[0-9]/g,d=>map[d]);}
    function fmtMoney(v){try{return 'ï·¼'+Number(v||0).toFixed(2);}catch(e){return 'ï·¼0.00';}}
    function computeFromItems(){
      const rows = document.querySelectorAll('#items-container .item-row');
      let itemsCount = 0, baseSum = 0, vatSum = 0; const VAT_RATE = 0.15;
      rows.forEach(r=>{
        const qty = parseFloat(toAsciiDigits(r.querySelector('[name*="quantity"]').value||0))||0;
        const price = parseFloat(toAsciiDigits(r.querySelector('[name*="price_before_tax"]').value||0))||0;
        const disc = parseFloat(toAsciiDigits(r.querySelector('[name*="discount"]').value||0))||0;
        const lineBase = Math.max(0,(qty*price) - disc);
        const lineVat = lineBase * VAT_RATE;
        const vatPct = r.querySelector('[name*="tax_pct"]'); if(vatPct){ vatPct.value = 15; }
        if(qty>0 || price>0 || disc>0){ itemsCount++; }
        baseSum += lineBase; vatSum += lineVat;
      });
      const total = baseSum + vatSum;
      const totalInput = document.getElementById('total_amount');
      const vatInput = document.getElementById('vat_amount');
      const itemsInput = document.getElementById('items_count');
      if(totalInput) totalInput.value = Number(total||0).toFixed(2);
      if(vatInput) vatInput.value = Number(vatSum||0).toFixed(2);
      if(itemsInput) itemsInput.value = itemsCount;
      const totalEl = document.getElementById('display_total');
      const vatEl = document.getElementById('display_vat');
      if(totalEl) totalEl.textContent = fmtMoney(total);
      if(vatEl) vatEl.textContent = fmtMoney(vatSum);
      const calcMeter = document.getElementById('calc-meter'); if(calcMeter){ const pct = Math.min(100, Math.round((itemsCount/Math.max(rows.length,1))*100)); calcMeter.style.width = pct+'%'; }
      try{ if(typeof updatePartialMax==='function') updatePartialMax(); }catch(e){}
    }
    function calculateTotals() {
        computeFromItems();
    }

    // Show stock info when material is selected
    function updateStockInfoByName(inputEl) {
        const val = (inputEl.value || '').trim().toLowerCase();
        const stockInfoDiv = inputEl.parentElement.querySelector('.stock-info');
        const unitInput = inputEl.closest('.row').querySelector('.unit-input');
        let match = null;
        for (const m of materials) {
            const dn = (m.name || '').toLowerCase();
            const en = dn.split('/')[0].trim();
            if (dn === val || en === val) { match = m; break; }
        }
        if (match) {
            stockInfoDiv.textContent = `Current stock: ${match.stock_quantity} ${match.unit} | Cost: ï·¼${match.cost_per_unit}/unit`;
            if (unitInput && !unitInput.value) unitInput.value = match.unit || '';
        } else {
            stockInfoDiv.textContent = '';
        }
    }


    // Event listeners
    document.addEventListener('input', e => {
        if (e.target && (e.target.name||'').includes('items-')) { calculateTotals(); }
    });

    (function(){
      const container = document.getElementById('items-container');
      const addBtn = document.getElementById('add-item-btn');
      const categoryData = { sections: [], itemsBySection: {} };
      async function loadCategories(){
        try{
          const resp = await fetch('/api/purchase-categories', {credentials:'same-origin'});
          const data = await resp.json();
          const pcs = data.purchase_categories || [];
          const itemsBySection = {};
          const sections = [];
          function biName(obj){
            if(!obj) return '';
            const en = (obj.en||'').trim(); const ar = (obj.ar||'').trim();
            if(en && ar) return en+' / '+ar;
            return en || ar;
          }
          pcs.forEach(cat=>{
            (cat.subcategories || []).forEach(sub=>{
              const secName = biName(sub.name);
              if(!secName) return;
              sections.push(secName);
              const items = (sub.items || []).map(it=>{
                if(typeof it === 'string') return it;
                const en = (it && it.en) || ''; const ar = (it && it.ar) || '';
                if(en && ar) return en+' / '+ar; return en || ar;
              }).filter(Boolean);
              itemsBySection[secName] = items;
            });
          });
          categoryData.sections = sections;
          categoryData.itemsBySection = itemsBySection;
        }catch(e){
          categoryData.sections = [];
          categoryData.itemsBySection = {};
        }
      }
      function populateMaterialsSelect(sel, arr){
        const current = sel.value;
        sel.innerHTML = '';
        const opt0 = document.createElement('option'); opt0.value = '0'; opt0.textContent = '{{ _('Select Raw Material / Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø®Ø§Ù…') }}'; sel.appendChild(opt0);
        arr.forEach(o=>{ const opt=document.createElement('option'); opt.value = o.id; opt.textContent = o.name; sel.appendChild(opt); });
        if(current){ sel.value=current; }
        sel.disabled = (arr.length === 0);
      }
      function populateCategorySelect(sel){
        const current = sel.value;
        sel.innerHTML = '';
        const opt0 = document.createElement('option'); opt0.value = ''; opt0.textContent = '{{ _('Select Section / Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…') }}'; sel.appendChild(opt0);
        categoryData.sections.forEach(name=>{ const opt=document.createElement('option'); opt.value = name; opt.textContent = name; sel.appendChild(opt); });
        if(current){ sel.value=current; }
      }
      function matchMaterialByItemName(item){
        const normalize=(s)=>String(s||'').replace(/\s+/g,' ').trim().toLowerCase();
        const target = normalize(item);
        const tEn = normalize(target.split('/')[0]||'');
        const tAr = normalize(target.split('/')[1]||'');
        for(const m of materials){
          const nm = normalize(m.name);
          const en = normalize(nm.split('/')[0]||'');
          const ar = normalize(nm.split('/')[1]||'');
          if(nm===target || en===target || ar===target || (tEn && en===tEn) || (tAr && ar===tAr)) return m;
        }
        return null;
      }
      function populateMaterialsFromSection(sel, section){
        let arr = materials.filter(m => (m.category||'') === section);
        if(arr.length === 0){
          const items = categoryData.itemsBySection[section] || [];
          arr = [];
          items.forEach(it=>{ const m = matchMaterialByItemName(it); if(m) arr.push(m); });
        }
        populateMaterialsSelect(sel, arr);
        sel.disabled = (arr.length === 0);
      }
      function onCategoryChange(e){
        const row = e.target.closest('.item-row');
        const matSel = row?.querySelector('.material-select');
        const sec = e.target.value;
        populateMaterialsFromSection(matSel, sec);
        if(matSel){ matSel.disabled = false; matSel.selectedIndex = 0; }
      }
      function attachRowEvents(row){
        const catSel = row.querySelector('.category-select');
        const matSel = row.querySelector('.material-select');
        catSel?.addEventListener('change', onCategoryChange);
        populateCategorySelect(catSel);
        // Require selecting a section first
        populateMaterialsSelect(matSel, []);
        matSel.disabled = true;
        // Guard: if material is focused without section, notify user
        matSel?.addEventListener('focus', function(){
          if(!catSel || !catSel.value){
            alert('{{ _('Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ù‹Ø§ Ø«Ù… Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù/Ø§Ù„Ù…Ø§Ø¯Ø©') }}');
            catSel && catSel.focus();
          }
        });
      }
      function nextIndex(){ const rows = container.querySelectorAll('.item-row'); return rows.length; }
      function cloneLast(){
        const rows = container.querySelectorAll('.item-row');
        if (rows.length===0) return;
        const last = rows[rows.length-1];
        const clone = last.cloneNode(true);
        const idx = nextIndex();
        clone.querySelectorAll('select, input').forEach(el=>{
          const n = el.getAttribute('name');
          if(n && n.startsWith('items-')){
            const parts = n.split('-'); parts[1] = String(idx); el.setAttribute('name', parts.join('-'));
          }
          if(el.tagName==='SELECT') el.selectedIndex=0; else el.value='';
        });
        container.insertBefore(clone, addBtn.parentElement);
        attachRowEvents(clone);
        clone.style.opacity='0'; clone.style.transform='translateY(8px)'; requestAnimationFrame(()=>{ clone.style.transition='all .25s ease'; clone.style.opacity='1'; clone.style.transform='translateY(0)'; });
        calculateTotals();
      }
      addBtn?.addEventListener('click', cloneLast);
      document.addEventListener('DOMContentLoaded', async function(){
        await loadCategories();
        container.querySelectorAll('.item-row').forEach(attachRowEvents);
        // Block form submit if any row has material/quantity without section
        const formEl = document.getElementById('purchase-form');
        formEl?.addEventListener('submit', function(ev){
          const rows = container.querySelectorAll('.item-row');
          for(const row of rows){
            const catSel = row.querySelector('.category-select');
            const matSel = row.querySelector('.material-select');
            const qtyIn = row.querySelector('[name*="quantity"]');
            const matChosen = matSel && matSel.value && matSel.value !== '0';
            const qtyVal = qtyIn && parseFloat(qtyIn.value||'0')>0;
            if((matChosen || qtyVal) && (!catSel || !catSel.value)){
              alert('{{ _('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ù‹Ø§ Ù‚Ø¨Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ†Ù/Ø§Ù„Ù…Ø§Ø¯Ø©') }}');
              ev.preventDefault();
              catSel && catSel.focus();
              return;
            }
          }
        });
      });
    })();

    // Remove item functionality
    // No per-item remove under the new design

    </script>


<script>
(function(){
  const SUPPLIERS = {{ (suppliers_json or '[]') | tojson | safe }};
  const input = document.getElementById('supplier_select');
  const freeBox = document.getElementById('supplier_free_box');
  const freeInput = document.getElementById('supplier_free');
  const hiddenId = document.getElementById('supplier_id');
  const phone = document.getElementById('s_phone');
  const tax = document.getElementById('s_tax');
  const address = document.getElementById('s_address');
  const cr = document.getElementById('s_cr');
  const iban = document.getElementById('s_iban');
  const invType = document.getElementById('invoice_type');

  function renderSupplier(s){
    if(!s){
      hiddenId.value='';
      if(phone) phone.value='';
      if(tax) tax.value='';
      if(address) address.value='';
      if(cr) cr.value='';
      if(iban) iban.value='';
      return;
    }
    hiddenId.value = s.id || '';
    if(phone) phone.value = s.phone || '';
    if(tax) tax.value = s.tax_number || '';
    if(address) address.value = s.address || '';
    // CR & IBAN may not exist in model yet -> leave empty
    if(cr) cr.value = s.cr_number || '';
    if(iban) iban.value = s.iban || '';
  }

  function matchSupplierByName(name){
    if(!name) return null;
    const n = name.trim().toLowerCase();
    return SUPPLIERS.find(s => (s.name||'').toLowerCase() === n) || null;
  }

  if(input){
    const update = ()=>{ renderSupplier(matchSupplierByName(input.value)); };
    input.addEventListener('change', update);
    input.addEventListener('blur', update);
    update();
  }

  function toggleSupplierMode(){
    const t = (invType?.value||'VAT').toUpperCase();
    if(t === 'NO_VAT'){
      if(freeBox) freeBox.style.display='';
    }else{
      if(freeBox) freeBox.style.display='none';
      if(freeInput) freeInput.value='';
    }
    setDefaultTaxByType();
  }

  function setDefaultTaxByType(){
    const t = (invType?.value||'VAT').toUpperCase();
    calculateTotals();
  }
  invType?.addEventListener('change', toggleSupplierMode);
  toggleSupplierMode();
})();
</script>

<script>


    // Initialize stock info and calculations
  document.addEventListener('DOMContentLoaded', function() {
    calculateTotals();
        const dateInput = document.querySelector('[name="date"]');
        const dateAr = document.getElementById('date-ar');
        function toArDate(d){ if(!d) return ''; const parts = String(d).split('-'); if(parts.length===3){ return arDigits(parts[2]+'/'+parts[1]+'/'+parts[0]); } return ''; }
        if(dateInput && dateAr){ dateAr.textContent = toArDate(dateInput.value); dateInput.addEventListener('change', ()=> dateAr.textContent = toArDate(dateInput.value)); }
        const statusSel = document.getElementById('purchase-status'); const meter=document.getElementById('status-meter');
        function updateMeter(){ const v=(statusSel.value||'unpaid').toLowerCase(); meter.style.width = v==='paid'? '100%' : (v==='partial'? '55%' : '15%'); }
        statusSel?.addEventListener('change', updateMeter); updateMeter();
    const saveBtn=document.getElementById('save-btn'); if(saveBtn){ saveBtn.addEventListener('click', function(e){ const rect=this.getBoundingClientRect(); const r=document.createElement('span'); const size=Math.max(rect.width,rect.height); r.className='ripple'; r.style.width=r.style.height=size+'px'; r.style.left=(e.offsetX-size/2)+'px'; r.style.top=(e.offsetY-size/2)+'px'; this.appendChild(r); setTimeout(()=>r.remove(),600); }); }
    const toggle=document.getElementById('toggle-adv'); if(toggle){ toggle.addEventListener('click', function(){ const hidden=document.querySelectorAll('.hidden-adv'); const toShow = Array.from(hidden).some(el=> el.style.display==='none' || window.getComputedStyle(el).display==='none'); hidden.forEach(el=>{ el.style.display = toShow ? '' : 'none'; }); this.textContent = toShow ? '{{ _('Hide Advanced / Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©') }}' : '{{ _('Show Advanced / Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©') }}'; }); }
  });
</script>

<script>
(function(){
  function parseMoneyText(txt){
    const s = String(txt||'').replace(/[^0-9.\-]/g,'');
    const v = parseFloat(s); return isNaN(v)?0:v;
  }
  function updatePartialMax(){
    const max = parseMoneyText(document.getElementById('final-total')?.textContent||'0');
    const span = document.getElementById('partial-max'); if(span) span.textContent = 'ï·¼' + max.toFixed(2);
    const inp = document.getElementById('partial-paid-amount');
    if(inp){ let v = parseFloat(inp.value||'0'); if(isNaN(v)) v = 0; if(v>max) inp.value = max.toFixed(2); if(v<0) inp.value='0.00'; }
  }
  function togglePartialBox(){
    const sel = document.getElementById('purchase-status');
    const box = document.getElementById('partial-paid-box');
    if(!sel || !box) return;
    if((sel.value||'').toLowerCase()==='partial'){ box.style.display=''; updatePartialMax(); }
    else { box.style.display='none'; }
  }
  document.addEventListener('DOMContentLoaded', function(){
    const sel = document.getElementById('purchase-status');
    if(sel){ sel.addEventListener('change', togglePartialBox); }
    togglePartialBox();
    updatePartialMax();
  });
})();
</script>


{% endblock %}
