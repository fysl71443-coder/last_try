{% extends 'base.html' %}
{% set back_url = url_for('inventory') %}

{% block title %}{{ _('Purchases / Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª') }}{% endblock %}
{% block content %}

<style>
body {
  background: #f4f6f9;
}
.purchases-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0px 4px 8px rgba(0,0,0,0.05);
  padding: 1.5rem;
  margin-bottom: 1rem;
}
.status-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: bold;
}
.status-unpaid { background: #ffeaa7; color: #2d3436; }
.status-partial { background: #fab1a0; color: #2d3436; }
.status-paid { background: #00b894; color: white; }
.item-row {
  border: 1px solid #e9ecef;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 0.5rem;
  background: #f8f9fa;
}
.stock-info {
  font-size: 0.8rem;
  color: #6c757d;
  font-style: italic;
}
</style>

<div class="container py-4">
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹ -->
    <div class="row mb-3">
        <div class="col-md-6">
            <h3 class="mb-0">ğŸ›’ {{ _('Purchases / Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª') }}</h3>
        </div>
        <div class="col-md-6 text-end">
            <a href="{{ url_for('raw_materials') }}" class="btn btn-outline-success me-2">
                ğŸ¥˜ {{ _('Raw Materials / Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…') }}
            </a>
            <a href="{{ url_for('sales') }}" class="btn btn-outline-info me-2">
                ğŸ’° {{ _('Sales / Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª') }}
            </a>
            <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
                ğŸ  {{ _('Dashboard / Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…') }}
            </a>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø© -->
    <div class="purchases-card">
        <h5 class="mb-3">{{ _('Create New Purchase Invoice / Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø©') }}</h5>

        <div class="alert alert-info">
            <strong>ğŸ’¡ {{ _('Note / Ù…Ù„Ø§Ø­Ø¸Ø©') }}:</strong>
            {{ _('Purchase invoices will automatically update raw material stock quantities and costs / ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø´Ø±Ø§Ø¡ Ø³ØªØ­Ø¯Ø« ÙƒÙ…ÙŠØ§Øª ÙˆØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹') }}
        </div>

        <form method="POST" id="purchase-form">
            {{ form.hidden_tag() }}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>


            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
            <div class="row mb-3">
                <div class="col-md-3">
                    {{ form.date.label(class_='form-label') }}
                    {{ form.date(class_='form-control') }}
                </div>
                <div class="col-md-3">
                    {{ form.payment_method.label(class_='form-label') }}
                    {{ form.payment_method(class_='form-select') }}
                </div>
                <div class="col-md-6">
                    {{ form.supplier_name.label(class_='form-label') }}
                    {{ form.supplier_name(class_='form-control') }}
                </div>
            </div>

            <!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
            <h6 class="mb-3">{{ _('Purchase Items (Raw Materials) / Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…)') }}</h6>
            <div id="items-container">
                {% for item_form in form.items %}
                <div class="item-row">
                    <div class="row">
                        <div class="col-md-3">
                            {{ item_form.raw_material_id.label(class_='form-label') }}
                            {{ item_form.raw_material_id(class_='form-select') }}
                            <div class="stock-info" id="stock-info-{{ loop.index0 }}"></div>
                        </div>
                        <div class="col-md-2">
                            {{ item_form.quantity.label(class_='form-label') }}
                            {{ item_form.quantity(class_='form-control', step='0.0001') }}
                        </div>
                        <div class="col-md-2">
                            {{ item_form.price_before_tax.label(class_='form-label') }}
                            {{ item_form.price_before_tax(class_='form-control', step='0.0001') }}
                        </div>
                        <div class="col-md-2">
                            {{ item_form.discount.label(class_='form-label') }}
                            {{ item_form.discount(class_='form-control', step='0.01') }}
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">{{ _('Total / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ') }}</label>
                            <div class="form-control bg-light item-total">$0.00</div>
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="button" class="btn btn-danger btn-sm remove-item-btn">âˆ’</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Ù…Ù„Ø®Øµ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="form-label">{{ _('Total Before Tax / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©') }}</label>
                    <div class="form-control bg-light" id="total-before-tax">$0.00</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">{{ _('Tax 15%% / Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© 15%%') }}</label>
                    <div class="form-control bg-light" id="tax-amount">$0.00</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">{{ _('Total Discount / Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙ…') }}</label>
                    <div class="form-control bg-light" id="total-discount">$0.00</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">{{ _('Final Total / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ') }}</label>
                    <div class="form-control bg-success text-white fw-bold" id="final-total">$0.00</div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <button type="button" class="btn btn-secondary" id="add-item">
                        â• {{ _('Add Raw Material / Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø®Ø§Ù…') }}
                    </button>
                </div>
                <div class="col-md-6 text-end">
                    {{ form.submit(class_='btn btn-primary btn-lg') }}
                </div>
            </div>
        </form>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
    {% if invoices %}
    <div class="purchases-card">
        <h5 class="mb-3">{{ _('Previous Purchase Invoices / ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©') }}</h5>

        <div class="table-responsive">
            <table class="table table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>{{ _('Invoice No / Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©') }}</th>
                        <th>{{ _('Date / Ø§Ù„ØªØ§Ø±ÙŠØ®') }}</th>
                        <th>{{ _('Supplier / Ø§Ù„Ù…ÙˆØ±Ø¯') }}</th>
                        <th>{{ _('Payment Method / Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹') }}</th>
                        <th>{{ _('Total / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ') }}</th>
                        <th>{{ _('Status / Ø§Ù„Ø­Ø§Ù„Ø©') }}</th>
                        <th>{{ _('Items / Ø§Ù„Ø¹Ù†Ø§ØµØ±') }}</th>
                        <th>{{ _('Actions / Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for invoice in invoices %}
                    <tr>
                        <td><strong>{{ invoice.invoice_number }}</strong></td>
                        <td>{{ invoice.date.strftime('%Y-%m-%d') }}</td>
                        <td>{{ invoice.supplier_name or '-' }}</td>
                        <td>
                            {% if invoice.payment_method == 'cash' %}
                                ğŸ’° {{ _('Cash / Ù†Ù‚Ø¯Ø§Ù‹') }}
                            {% elif invoice.payment_method == 'card' %}
                                ğŸ’³ {{ _('Card / Ø¨Ø·Ø§Ù‚Ø©') }}
                            {% elif invoice.payment_method == 'bank_transfer' %}
                                ğŸ¦ {{ _('Bank Transfer / ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ') }}
                            {% elif invoice.payment_method == 'check' %}
                                ğŸ“ {{ _('Check / Ø´ÙŠÙƒ') }}
                            {% else %}
                                {{ invoice.payment_method }}
                            {% endif %}
                        </td>
                        <td>${{ "%.2f"|format(invoice.total_after_tax_discount) }}</td>
                        <td>
                            <span class="status-badge status-{{ invoice.status }}">
                                {% if invoice.status == 'paid' %}
                                    {{ _('Paid / Ù…Ø¯ÙÙˆØ¹') }}
                                {% elif invoice.status == 'partial' %}
                                    {{ _('Partial / Ø¬Ø²Ø¦ÙŠ') }}
                                {% else %}
                                    {{ _('Unpaid / ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹') }}
                                {% endif %}
                            </span>
                        </td>
                        <td>{{ invoice.items|length }} {{ _('items / Ø¹Ù†Ø§ØµØ±') }}</td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" onclick="viewInvoice({{ invoice.id }})">
                                ğŸ‘ {{ _('View / Ø¹Ø±Ø¶') }}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deletePurchaseInvoice({{ invoice.id }}, '{{ invoice.invoice_number }}')">
                                ğŸ—‘ï¸ {{ _('Delete / Ø­Ø°Ù') }}
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<!-- SocketIO and JavaScript -->
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
    // Materials data for calculations and stock info
    const materials = {{ materials_json | safe }};

    // SocketIO for real-time updates
    var socket = io();
    socket.on('purchase_update', function(data) {
        console.log('Purchase updated:', data);
        alert('New purchase invoice created: ' + data.invoice_number + ' - $' + data.total);
        location.reload();
    });

    // Auto-calculation functionality
    function calculateTotals() {
        let totalBeforeTax = 0;
        let totalDiscount = 0;

        document.querySelectorAll('.item-row').forEach(row => {
            const materialSelect = row.querySelector('select[name$="-raw_material_id"]');
            const quantityInput = row.querySelector('input[name$="-quantity"]');
            const priceInput = row.querySelector('input[name$="-price_before_tax"]');
            const discountInput = row.querySelector('input[name$="-discount"]');
            const totalDisplay = row.querySelector('.item-total');

            const quantity = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const discount = parseFloat(discountInput.value) || 0;

            const itemBeforeTax = quantity * price;
            const itemTax = itemBeforeTax * 0.15;
            const itemTotal = itemBeforeTax + itemTax - discount;

            totalDisplay.textContent = '$' + itemTotal.toFixed(2);
            totalBeforeTax += itemBeforeTax;
            totalDiscount += discount;
        });

        const totalTax = totalBeforeTax * 0.15;
        const finalTotal = totalBeforeTax + totalTax - totalDiscount;

        document.getElementById('total-before-tax').textContent = '$' + totalBeforeTax.toFixed(2);
        document.getElementById('tax-amount').textContent = '$' + totalTax.toFixed(2);
        document.getElementById('total-discount').textContent = '$' + totalDiscount.toFixed(2);
        document.getElementById('final-total').textContent = '$' + finalTotal.toFixed(2);
    }

    // Show stock info when material is selected
    function updateStockInfo(selectElement) {
        const materialId = parseInt(selectElement.value);
        const stockInfoDiv = selectElement.parentElement.querySelector('.stock-info');

        const material = materials.find(m => m.id === materialId);
        if (material) {
            stockInfoDiv.textContent = `Current stock: ${material.stock_quantity} ${material.unit} | Cost: $${material.cost_per_unit}/unit`;
        } else {
            stockInfoDiv.textContent = '';
        }
    }

    // Event listeners
    document.addEventListener('change', e => {
        if (e.target.matches('select[name$="-raw_material_id"]')) {
            updateStockInfo(e.target);
            calculateTotals();
        } else if (e.target.matches('input[name$="-quantity"], input[name$="-price_before_tax"], input[name$="-discount"]')) {
            calculateTotals();
        }
    });

    // Add new item functionality
    let itemIndex = {{ form.items|length }};

    document.getElementById('add-item').addEventListener('click', function() {
        const container = document.getElementById('items-container');
        const newItem = document.createElement('div');
        newItem.className = 'item-row';
        newItem.innerHTML = `
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">{{ _('Raw Material / Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø®Ø§Ù…') }}</label>
                    <select class="form-select" name="items-${itemIndex}-raw_material_id">
                        <option value="0">{{ _('Select Raw Material / Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø®Ø§Ù…') }}</option>
                        ${materials.map(m => `<option value="${m.id}">${m.name}</option>`).join('')}
                    </select>
                    <div class="stock-info"></div>
                </div>
                <div class="col-md-2">
                    <label class="form-label">{{ _('Quantity / Ø§Ù„ÙƒÙ…ÙŠØ©') }}</label>
                    <input class="form-control" name="items-${itemIndex}-quantity" step="0.0001" type="number">
                </div>
                <div class="col-md-2">
                    <label class="form-label">{{ _('Unit Price / Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©') }}</label>
                    <input class="form-control" name="items-${itemIndex}-price_before_tax" step="0.0001" type="number">
                </div>
                <div class="col-md-2">
                    <label class="form-label">{{ _('Discount / Ø§Ù„Ø®ØµÙ…') }}</label>
                    <input class="form-control" name="items-${itemIndex}-discount" step="0.01" type="number" value="0">
                </div>
                <div class="col-md-2">
                    <label class="form-label">{{ _('Total / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ') }}</label>
                    <div class="form-control bg-light item-total">$0.00</div>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-danger btn-sm remove-item-btn">âˆ’</button>
                </div>
            </div>
        `;
        container.appendChild(newItem);
        itemIndex++;
    });

    // Remove item functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-item-btn')) {
            e.target.closest('.item-row').remove();
            calculateTotals();
        }
    });

    // View invoice details
    function viewInvoice(invoiceId) {
        alert('Invoice details for ID: ' + invoiceId + ' (Feature coming soon)');
    }

    function deletePurchaseInvoice(invoiceId, invoiceNumber) {
        if (confirm('{{ _("Are you sure you want to delete purchase invoice") }} "' + invoiceNumber + '"?\n\n{{ _("This action will reverse stock updates and cannot be undone.") }}')) {
            // Create a form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/delete_purchase_invoice/' + invoiceId;

            // Add CSRF token if available
            const csrfToken = document.querySelector('input[name="csrf_token"]');
            if (csrfToken) {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = 'csrf_token';
                tokenInput.value = csrfToken.value;
                form.appendChild(tokenInput);
            }

            document.body.appendChild(form);
            form.submit();
        }
    }

    // Initialize stock info and calculations
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('select[name$="-raw_material_id"]').forEach(updateStockInfo);
        calculateTotals();
    });
</script>

{% endblock %}
