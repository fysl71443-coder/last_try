{% extends 'base.html' %}
{% set back_url = url_for('main.dashboard') %}

{% block title %}{{ _('Purchases') }}{% endblock %}
{% block content %}

<style>.stock-info{ font-size:0.8rem; color:var(--muted); } .status-unpaid{ background:rgba(253,203,110,.3); color:#856404; } .status-partial{ background:rgba(255,193,7,.25); color:#856404; } .status-paid{ background:rgba(39,174,96,.2); color:#27ae60; }</style>

<div class="container py-4 ops-layout hub-wrap">
    <div class="ops-header-bar">
        <span class="ops-icon"><i class="fa-solid fa-cart-shopping"></i></span>
        <div>
            <h1 class="ops-title mb-0">{{ _('Purchases') }}</h1>
            <span class="ops-subtitle">{{ _('Create and manage purchase invoices') }}</span>
        </div>
        <div class="ops-actions d-flex flex-wrap gap-2">
            <a href="{{ url_for('purchases.raw_materials') }}" class="btn btn-sm btn-primary"><i class="fa-solid fa-bowl-food me-1"></i>{{ _('Raw Materials') }}</a>
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-house me-1"></i>{{ _('Dashboard') }}</a>
        </div>
    </div>

    <div class="ops-body ops-body-no-sidebar">
        <main class="ops-main">
    <div class="ops-form-card mt-0">
        <div class="ops-form-head">{{ _('Create New Purchase Invoice') }}</div>
        <div class="ops-form-body">
        <form method="POST" id="purchase-form">
            {{ form.hidden_tag() }}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

            <div class="ops-form-card mb-3">
              <div class="ops-form-head">{{ _('Supplier Info') }}</div>
              <div class="ops-form-body">
                <div class="row g-3 align-items-end">
                  <div class="col-md-3">
                    <label class="form-label">{{ _('Invoice Type') }}</label>
                    <select id="invoice_type" name="invoice_type" class="form-select">
                      <option value="VAT">{{ _('VAT') }}</option>
                      <option value="NO_VAT">{{ _('بدون VAT') }}</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">{{ _('Supplier') }}</label>
                    <select name="supplier_name" id="supplier_select" class="form-select">
                      <option value="">{{ _('Select Supplier') }}</option>
                      {% for s in suppliers_list or [] %}
                        <option value="{{ s.name }}" data-id="{{ s.id }}">{{ s.name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-3" id="supplier_free_box" style="display:none;">
                    <label class="form-label">{{ _('Supplier') }}</label>
                    <input name="supplier_name_free" id="supplier_free" class="form-control" placeholder="{{ _('اكتب اسم المورد أو الجهة') }}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">{{ _('Phone') }}</label>
                    <input id="s_phone" class="form-control" value="" readonly>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">{{ _('Tax Number') }}</label>
                    <input id="s_tax" class="form-control" value="" readonly>
                  </div>
                </div>
                <div class="row g-3 align-items-end mt-1">
                  <div class="col-md-6">
                    <label class="form-label">{{ _('Address') }}</label>
                    <input id="s_address" class="form-control" value="" readonly>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">{{ _('CR Number') }}</label>
                    <input id="s_cr" class="form-control" value="" readonly>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">{{ _('IBAN') }}</label>
                    <input id="s_iban" class="form-control" value="" readonly>
                  </div>
                </div>
                <input type="hidden" name="supplier_id" id="supplier_id" value="">
              </div>
            </div>

            <div class="ops-form-card mb-3">
              <div class="ops-form-head">{{ _('Invoice Info') }}</div>
              <div class="ops-form-body">
                <div class="row g-3 align-items-end mb-2">
                  <div class="col-md-3">
                    {{ form.date.label(class_='form-label') }}
                    {{ form.date(class_='form-control') }}
                  </div>
                  <div class="col-md-3">
                    {{ form.payment_method.label(class_='form-label') }}
                    {{ form.payment_method(class_='form-select') }}
                  </div>
                  
                  <div class="col-md-3" style="display:none;">
                    <label class="form-label">{{ _('Invoice No') }}</label>
                    <input class="form-control" value="{{ _('Auto on save (e.g. INV-PUR-YYYY-0001)') }}" readonly>
                  </div>
                </div>
                <div class="row g-3 align-items-end mb-2">
                  <div class="col-md-3">
                    <label class="form-label">{{ _('Supplier Invoice No') }}</label>
                    <input name="supplier_invoice_number" class="form-control" placeholder="{{ _('إن وجد') }}">
                  </div>
                  <div class="col-md-9">
                    <label class="form-label">{{ _('Notes') }}</label>
                    <input name="notes" class="form-control" placeholder="{{ _('ملاحظات إضافية (اختياري)') }}">
                  </div>
                </div>
                <div class="row g-3 mt-1">
                  <div class="col-md-3">
                    <label class="form-label">{{ _('Payment Status') }}</label>
                    <select name="status" id="purchase-status" class="form-select">
                      <option value="unpaid">{{ _('Unpaid') }} / غير مدفوع</option>
                      <option value="partial">{{ _('Partial') }} / مدفوع جزئي</option>
                      <option value="paid">{{ _('Paid') }} / مدفوع</option>
                    </select>
                  </div>
                  <div class="col-md-3" id="partial-paid-box" style="display:none;">
                    <label class="form-label">{{ _('Paid Amount (Partial)') }} / المبلغ المدفوع (جزئي)</label>
                    <input name="partial_paid_amount" id="partial-paid-amount" type="number" step="0.01" min="0" class="form-control" placeholder="0.00">
                    <div class="form-text">{{ _('Max is Final Total') }}: <span id="partial-max"></span></div>
                  </div>
                </div>


            <div class="ops-form-card mb-3">
              <div class="ops-form-head">{{ _('Purchase Items') }}</div>
              <div class="ops-form-body" id="items-container">
                {% for item_form in form.items %}
                <div class="screen-item-row item-row d-flex align-items-end gap-2 mb-2">
                  <div class="row g-3 align-items-end flex-grow-1 mb-0">
                    <div class="col-md-2">
                      {{ item_form.category.label(class_='form-label') }}
                      {{ item_form.category(class_='form-select category-select') }}
                    </div>
                    <div class="col-md-4">
                      {{ item_form.item_name.label(class_='form-label') }}
                      {{ item_form.item_name(class_='form-control', placeholder=_('Item name or description')) }}
                    </div>
                    <div class="col-md-2">
                      {{ item_form.quantity.label(class_='form-label') }}
                      {{ item_form.quantity(class_='form-control', step='0.01', type='text', inputmode='decimal', dir='ltr', pattern='[0-9٠-٩۰-۹.,٫،]+' ) }}
                    </div>
                    <div class="col-md-2">
                      {{ item_form.price_before_tax.label(class_='form-label') }}
                      {{ item_form.price_before_tax(class_='form-control', step='0.01', type='text', inputmode='decimal', dir='ltr', pattern='[0-9٠-٩۰-۹.,٫،]+' ) }}
                    </div>
                    <div class="col-md-2" style="display:none;">
                      {{ item_form.discount.label(class_='form-label') }}
                      {{ item_form.discount(class_='form-control', step='0.01') }}
                    </div>
                    <div class="col-md-1" style="display:none;">
                      <label class="form-label">VAT %</label>
                      <input type="number" step="0.01" class="form-control" name="items-{{ loop.index0 }}-tax_pct" value="0">
                    </div>
                  </div>
                  <div class="mb-0">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-item-btn" title="{{ _('Remove row') }} / حذف البند" aria-label="{{ _('Remove') }}">
                      <i class="fa-solid fa-trash-can"></i>
                    </button>
                  </div>
                </div>
                {% endfor %}
                <div class="d-flex justify-content-end">
                  <button type="button" class="btn btn-outline-success" id="add-item-btn">{{ _('Add Item') }}</button>
                </div>
              </div>
            </div>

            <div class="ops-form-card mb-3">
              <div class="ops-form-head">{{ _('Totals') }}</div>
              <div class="ops-form-body">
                <div class="row g-3">
                  <div class="col-md-3" style="display:none;">
                    <label class="form-label">{{ _('Items Count') }}</label>
                    <input type="number" id="items_count" name="items_count" class="form-control" value="">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">{{ _('Inventory Kind') }}</label>
                    <select id="inventory_kind" name="inventory_kind" class="form-select">
                      <option value="">{{ _('None') }}</option>
                      <option value="FOOD">{{ _('Food Materials') }}</option>
                      <option value="OTHER">{{ _('Other Supplies') }}</option>
                    </select>
                    <div class="form-check mt-2">
                      <input class="form-check-input" type="checkbox" id="production_flag" name="production_flag">
                      <label class="form-check-label" for="production_flag">{{ _('Goes to Production') }}</label>
                    </div>
                  </div>
                </div>
                <hr/>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div>{{ _('Purchases Total') }}: <strong id="final-total"></strong></div>
                        <div>{{ _('VAT Total') }}: <strong id="display_vat"></strong></div>
                    </div>
                    <div>
                        <button type="submit" class="btn btn-primary">{{ _('Save') }}</button>
                        <button type="reset" class="btn btn-outline-secondary">{{ _('Clear') }}</button>
                    </div>
                </div>
              </div>
            </div>
        </form>
    </div>
        </main>
    </div>

<!-- SocketIO and JavaScript -->
<script>
    // حساب الإجماليات تلقائيًا من بنود الفاتورة
    function toAsciiDigits(str){
        let s = String(str || '');
        const ar = '٠١٢٣٤٥٦٧٨٩'; const fa = '۰۱۲۳۴۵۶۷۸۹';
        for(let i=0;i<10;i++){ s = s.replace(new RegExp(ar[i],'g'), String(i)); s = s.replace(new RegExp(fa[i],'g'), String(i)); }
        return s;
    }
    function calculateTotals() {
        const invType = (document.getElementById('invoice_type')?.value || 'VAT').toUpperCase();
        const VAT_RATE = invType === 'VAT' ? 0.15 : 0.0;
        let base = 0.0, vat = 0.0, cnt = 0;
        document.querySelectorAll('#items-container .item-row').forEach(row => {
            const qEl = row.querySelector('[name*="-quantity"]');
            const pEl = row.querySelector('[name*="-price_before_tax"]');
            const dEl = row.querySelector('[name*="-discount"]');
            const q = parseFloat(toAsciiDigits(qEl?.value||'')) || 0;
            const p = parseFloat(toAsciiDigits(pEl?.value||'')) || 0;
            const d = parseFloat(toAsciiDigits(dEl?.value||'')) || 0;
            if(q>0 && p>0){
                let line = (q*p) - d; if(line<0) line = 0;
                base += line; vat += line * VAT_RATE; cnt += 1;
            }
        });
        const totalEl = document.getElementById('final-total');
        const vatEl = document.getElementById('display_vat');
        if(totalEl) totalEl.textContent = base>0 || vat>0 ? ('﷼' + (base+vat).toFixed(2)) : '';
        if(vatEl) vatEl.textContent = vat>0 ? ('﷼' + vat.toFixed(2)) : '﷼0.00';
        const cntEl = document.getElementById('items_count'); if(cntEl) cntEl.value = String(cnt);
        try{ if(typeof updatePartialMax==='function') updatePartialMax(); }catch(e){}
    }

    document.addEventListener('input', e => {
        if (e.target && /items-\d+-(quantity|price_before_tax|discount|item_name)/.test(e.target.name||'')) {
            try{ if(/quantity|price_before_tax|discount/.test(e.target.name||'')) e.target.value = toAsciiDigits(e.target.value); }catch(err){}
            calculateTotals();
        }
    });
    document.getElementById('invoice_type')?.addEventListener('change', calculateTotals);

    (function(){
      const container = document.getElementById('items-container');
      const addBtn = document.getElementById('add-item-btn');
      function nextIndex(){ return container.querySelectorAll('.item-row').length; }
      function cloneLast(){
        const rows = container.querySelectorAll('.item-row');
        if (rows.length===0) return;
        const last = rows[rows.length-1];
        const clone = last.cloneNode(true);
        const idx = nextIndex();
        clone.querySelectorAll('select, input').forEach(el=>{
          const n = el.getAttribute('name');
          if(n && n.startsWith('items-')){
            const parts = n.split('-'); parts[1] = String(idx); el.setAttribute('name', parts.join('-'));
          }
          if(el.tagName==='SELECT') el.selectedIndex=0; else el.value='';
        });
        clone.querySelectorAll('.remove-item-btn').forEach(btn=>{ btn.onclick = removeRow; });
        container.insertBefore(clone, addBtn.parentElement);
        updateRemoveButtonsVisibility();
      }
      function removeRow(ev){
        const btn = ev && ev.target ? ev.target.closest('.remove-item-btn') : null;
        const row = btn && btn.closest('.item-row');
        if(!row) return;
        const rows = container.querySelectorAll('.item-row');
        if(rows.length <= 1) return;
        row.remove();
        calculateTotals();
        updateRemoveButtonsVisibility();
      }
      function updateRemoveButtonsVisibility(){
        const rows = container.querySelectorAll('.item-row');
        rows.forEach((r, i)=>{
          const btn = r.querySelector('.remove-item-btn');
          if(btn){ btn.style.visibility = rows.length > 1 ? 'visible' : 'hidden'; btn.disabled = rows.length <= 1; }
        });
      }
      container.addEventListener('click', function(ev){
        if(ev.target && ev.target.closest('.remove-item-btn')) removeRow(ev);
      });
      addBtn?.addEventListener('click', function(){ cloneLast(); calculateTotals(); });
      updateRemoveButtonsVisibility();
      calculateTotals();
    })();

    </script>


<script>
(function(){
  const SUPPLIERS = {{ (suppliers_json or '[]') | tojson | safe }};
  const input = document.getElementById('supplier_select');
  const freeBox = document.getElementById('supplier_free_box');
  const freeInput = document.getElementById('supplier_free');
  const hiddenId = document.getElementById('supplier_id');
  const phone = document.getElementById('s_phone');
  const tax = document.getElementById('s_tax');
  const address = document.getElementById('s_address');
  const cr = document.getElementById('s_cr');
  const iban = document.getElementById('s_iban');
  const invType = document.getElementById('invoice_type');

  function renderSupplier(s){
    if(!s){
      hiddenId.value='';
      if(phone) phone.value='';
      if(tax) tax.value='';
      if(address) address.value='';
      if(cr) cr.value='';
      if(iban) iban.value='';
      return;
    }
    hiddenId.value = s.id || '';
    if(phone) phone.value = s.phone || '';
    if(tax) tax.value = s.tax_number || '';
    if(address) address.value = s.address || '';
    // CR & IBAN may not exist in model yet -> leave empty
    if(cr) cr.value = s.cr_number || '';
    if(iban) iban.value = s.iban || '';
  }

  function matchSupplierByName(name){
    if(!name) return null;
    const n = name.trim().toLowerCase();
    return SUPPLIERS.find(s => (s.name||'').toLowerCase() === n) || null;
  }

  if(input){
    const update = ()=>{ renderSupplier(matchSupplierByName(input.value)); };
    input.addEventListener('change', update);
    input.addEventListener('blur', update);
    update();
  }

  function toggleSupplierMode(){
    const t = (invType?.value||'VAT').toUpperCase();
    if(t === 'NO_VAT'){
      if(freeBox) freeBox.style.display='';
    }else{
      if(freeBox) freeBox.style.display='none';
      if(freeInput) freeInput.value='';
    }
    setDefaultTaxByType();
  }

  function setDefaultTaxByType(){
    const t = (invType?.value||'VAT').toUpperCase();
        const vatInput = document.getElementById('vat_amount');
        if(vatInput){ vatInput.value=''; }
        calculateTotals();
  }
  invType?.addEventListener('change', toggleSupplierMode);
  toggleSupplierMode();
})();
</script>

<script>


    // Initialize stock info and calculations
    document.addEventListener('DOMContentLoaded', function() {
        calculateTotals();
    });
</script>

<script>
(function(){
  function parseMoneyText(txt){
    const s = String(txt||'').replace(/[^0-9.\-]/g,'');
    const v = parseFloat(s); return isNaN(v)?0:v;
  }
  function updatePartialMax(){
    const max = parseMoneyText(document.getElementById('final-total')?.textContent||'0');
    const span = document.getElementById('partial-max'); if(span) span.textContent = '﷼' + max.toFixed(2);
    const inp = document.getElementById('partial-paid-amount');
    if(inp){ let v = parseFloat(inp.value||'0'); if(isNaN(v)) v = 0; if(v>max) inp.value = max.toFixed(2); if(v<0) inp.value='0.00'; }
  }
  function togglePartialBox(){
    const sel = document.getElementById('purchase-status');
    const box = document.getElementById('partial-paid-box');
    if(!sel || !box) return;
    if((sel.value||'').toLowerCase()==='partial'){ box.style.display=''; updatePartialMax(); }
    else { box.style.display='none'; }
  }
  document.addEventListener('DOMContentLoaded', function(){
    const sel = document.getElementById('purchase-status');
    if(sel){ sel.addEventListener('change', togglePartialBox); }
    togglePartialBox();
    updatePartialMax();
  });
})();
</script>


{% endblock %}
