{% extends 'base.html' %}
{% block title %}üèõÔ∏è Palace India - Sales{% endblock %}
{% block content %}

<style>
body {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  min-height: 100vh;
}
.pos-container {
  background: white;
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  margin: 20px auto;
  max-width: 1400px;
  overflow: hidden;
}
.pos-header {
  background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
  color: white;
  padding: 1rem 2rem;
  text-align: center;
}
.pos-content {
  display: flex;
  min-height: 80vh;
}
.categories-panel {
  width: 300px;
  background: #f8f9fa;
  border-right: 1px solid #dee2e6;
  padding: 1rem;
  overflow-y: auto;
}
.invoice-panel {
  flex: 1;
  padding: 1rem 2rem;
  display: flex;
  flex-direction: column;
}
.category-btn {
  width: 100%;
  margin-bottom: 0.5rem;
  padding: 0.75rem;
  border: none;
  border-radius: 8px;
  background: white;
  color: #333;
  font-weight: 500;
  transition: all 0.3s;
  cursor: pointer;
}
.category-btn:hover, .category-btn.active {
  background: #74b9ff;
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(116, 185, 255, 0.3);
}
.products-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 0.5rem;
  margin-top: 1rem;
  max-height: 300px;
  overflow-y: auto;
}
.product-btn {
  padding: 0.75rem 0.5rem;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  background: white;
  color: #333;
  font-size: 0.85rem;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
}
.product-btn:hover {
  background: #74b9ff;
  color: white;
  border-color: #74b9ff;
  transform: translateY(-2px);
}
.invoice-items {
  flex: 1;
  background: #f8f9fa;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1rem;
  max-height: 400px;
  overflow-y: auto;
}
.invoice-item {
  background: white;
  border-radius: 6px;
  padding: 0.75rem;
  margin-bottom: 0.5rem;
  display: flex;
  justify-content: between;
  align-items: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.invoice-summary {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1rem;
}
.action-buttons {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}
.btn-print-draft {
  background: #74b9ff;
  color: white;
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s;
}
.btn-print-draft:hover {
  background: #0984e3;
  transform: translateY(-2px);
}
.btn-payment {
  background: #00b894;
  color: white;
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s;
}
.btn-payment:hover {
  background: #00a085;
  transform: translateY(-2px);
}
.btn-void {
  background: #e17055;
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  font-size: 0.8rem;
  cursor: pointer;
}
.table-selector {
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 0.5rem;
  margin-bottom: 1rem;
  width: 100%;
}
</style>

<div class="pos-container">
  <!-- Header -->
  <div class="pos-header">
    <h2>üèõÔ∏è Palace India - Point of Sale</h2>
    <p class="mb-0">Table-based ordering system</p>
  </div>

  <!-- Main Content -->
  <div class="pos-content">
    <!-- Categories Panel -->
    <div class="categories-panel">
      <h5 class="mb-3">üìã Categories</h5>
      <div id="categories-list">
        <!-- Categories will be loaded here -->
      </div>
      
      <h6 class="mt-4 mb-2">üçΩÔ∏è Products</h6>
      <div class="products-grid" id="products-grid">
        <!-- Products will be loaded here -->
      </div>
    </div>

    <!-- Invoice Panel -->
    <div class="invoice-panel">
      <!-- Table Selection -->
      <div class="mb-3">
        <label class="form-label">ü™ë Table Number</label>
        <select class="table-selector" id="table-number">
          <option value="">Select Table</option>
          {% for i in range(1, 21) %}
          <option value="{{ i }}">Table {{ i }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Customer Search -->
      <div class="row mb-3">
        <div class="col-md-8">
          <label class="form-label">üîç Search Customer</label>
          <div class="input-group">
            <input type="text" class="form-control" id="customer-search" placeholder="Search by name or phone">
            <button class="btn btn-outline-secondary" type="button" onclick="searchCustomers()">üîç</button>
          </div>
          <div id="customer-results" class="dropdown-menu" style="display: none; width: 100%;"></div>
        </div>
        <div class="col-md-4">
          <label class="form-label">üí∞ Discount (%)</label>
          <input type="number" class="form-control" id="customer-discount" value="0" min="0" max="100" step="0.01" readonly>
        </div>
      </div>

      <!-- Selected Customer Info -->
      <div id="selected-customer" class="alert alert-info" style="display: none;">
        <strong>Selected Customer:</strong> <span id="customer-name"></span> - <span id="customer-phone"></span>
        <button type="button" class="btn btn-sm btn-outline-danger float-end" onclick="clearCustomer()">Clear</button>
      </div>

      <!-- Invoice Items -->
      <div class="invoice-items">
        <h6 class="mb-3">üßæ Invoice Items</h6>
        <div id="invoice-items-list">
          <div class="text-center text-muted py-4">
            <i class="fas fa-shopping-cart fa-2x mb-2"></i>
            <p>No items added yet</p>
          </div>
        </div>
      </div>

      <!-- Invoice Summary -->
      <div class="invoice-summary">
        <div class="row">
          <div class="col-6">
            <strong>Subtotal:</strong>
            <span id="subtotal">0.00 SAR</span>
          </div>
          <div class="col-6">
            <strong>Discount:</strong>
            <span id="discount-amount">0.00 SAR</span>
          </div>
          <div class="col-6">
            <strong>Tax (15%):</strong>
            <span id="tax-amount">0.00 SAR</span>
          </div>
          <div class="col-6">
            <strong>Total:</strong>
            <span id="total-amount">0.00 SAR</span>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button class="btn-print-draft" onclick="printDraftInvoice()">
          üñ®Ô∏è Print Invoice (Unpaid)
        </button>
        <button class="btn-payment" onclick="showPaymentModal()">
          üí≥ Payment & Print
        </button>
        <button class="btn btn-secondary" onclick="clearInvoice()">
          üóëÔ∏è Clear All
        </button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">
          üè† Back to Dashboard
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üí≥ Payment Method</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-6">
            <button class="btn btn-success w-100 py-3" onclick="processPayment('cash')">
              üíµ Cash
            </button>
          </div>
          <div class="col-6">
            <button class="btn btn-primary w-100 py-3" onclick="processPayment('card')">
              üí≥ Card
            </button>
          </div>
          <div class="col-6">
            <button class="btn btn-info w-100 py-3" onclick="processPayment('bank_transfer')">
              üè¶ Bank Transfer
            </button>
          </div>
          <div class="col-6">
            <button class="btn btn-warning w-100 py-3" onclick="processPayment('other')">
              üì± Other
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Void Password Modal -->
<div class="modal fade" id="voidModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üîí Enter Password</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="password" class="form-control" id="void-password" placeholder="Enter password to void item">
        <input type="hidden" id="void-item-index">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="confirmVoidItem()">Void Item</button>
      </div>
    </div>
  </div>
</div>

<script>
// POS System JavaScript for Palace India
let currentInvoice = {
  items: [],
  tableNumber: '',
  customerId: null,
  customerName: '',
  customerPhone: '',
  customerDiscount: 0
};

let categories = [];
let currentCategory = null;
let selectedCustomer = null;

// Load categories and products
document.addEventListener('DOMContentLoaded', function() {
  loadCategories();
  setupEventListeners();
});

function setupEventListeners() {
  // Table number change
  document.getElementById('table-number').addEventListener('change', function() {
    currentInvoice.tableNumber = this.value;
  });

  // Customer search
  document.getElementById('customer-search').addEventListener('input', function() {
    if (this.value.length >= 2) {
      searchCustomers();
    } else {
      hideCustomerResults();
    }
  });

  // Customer discount change
  document.getElementById('customer-discount').addEventListener('change', function() {
    currentInvoice.customerDiscount = parseFloat(this.value) || 0;
    updateInvoiceDisplay();
  });

  // Hide customer results when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('#customer-search') && !e.target.closest('#customer-results')) {
      hideCustomerResults();
    }
  });
}

function loadCategories() {
  fetch('/api/pos/palace_india/categories')
    .then(response => response.json())
    .then(data => {
      categories = data;
      displayCategories();
      if (categories.length > 0) {
        selectCategory(0);
      }
    })
    .catch(error => {
      console.error('Error loading categories:', error);
      alert('Failed to load categories');
    });
}

function displayCategories() {
  const categoriesList = document.getElementById('categories-list');
  categoriesList.innerHTML = '';

  categories.forEach((category, index) => {
    const button = document.createElement('button');
    button.className = 'category-btn';
    button.textContent = category.name;
    button.onclick = () => selectCategory(index);
    categoriesList.appendChild(button);
  });
}

function selectCategory(index) {
  // Update active category
  const categoryButtons = document.querySelectorAll('.category-btn');
  categoryButtons.forEach(btn => btn.classList.remove('active'));
  categoryButtons[index].classList.add('active');

  currentCategory = categories[index];
  loadCategoryItems(currentCategory.id);
}

function loadCategoryItems(categoryId) {
  const productsGrid = document.getElementById('products-grid');
  productsGrid.innerHTML = '<div class="text-center p-3">Loading items...</div>';

  fetch(`/api/pos/palace_india/categories/${categoryId}/items`)
    .then(response => response.json())
    .then(items => {
      displayProducts(items);
    })
    .catch(error => {
      console.error('Error loading items:', error);
      productsGrid.innerHTML = '<div class="text-center p-3 text-danger">Failed to load items</div>';
    });
}

function displayProducts(items) {
  const productsGrid = document.getElementById('products-grid');
  productsGrid.innerHTML = '';

  if (!items || items.length === 0) {
    productsGrid.innerHTML = '<div class="text-center p-3 text-muted">No items in this category</div>';
    return;
  }

  items.forEach(item => {
    const button = document.createElement('button');
    button.className = 'product-btn';
    button.innerHTML = `<div>${item.name}</div><div>${item.price.toFixed(2)} SAR</div>`;
    button.onclick = () => addItemToInvoice(item.id, item.name, item.price);
    productsGrid.appendChild(button);
  });
}

function addItemToInvoice(productId, productName, price) {
  // Check if item already exists
  const existingItem = currentInvoice.items.find(item => item.id === productId);

  if (existingItem) {
    existingItem.quantity += 1;
  } else {
    currentInvoice.items.push({
      id: productId,
      name: productName,
      price: price,
      quantity: 1
    });
  }

  updateInvoiceDisplay();
}

function updateInvoiceDisplay() {
  const itemsList = document.getElementById('invoice-items-list');

  if (currentInvoice.items.length === 0) {
    itemsList.innerHTML = `
      <div class="text-center text-muted py-4">
        <i class="fas fa-shopping-cart fa-2x mb-2"></i>
        <p>No items added yet</p>
      </div>
    `;
  } else {
    itemsList.innerHTML = '';

    currentInvoice.items.forEach((item, index) => {
      const itemDiv = document.createElement('div');
      itemDiv.className = 'invoice-item';
      itemDiv.innerHTML = `
        <div style="flex: 1;">
          <strong>${item.name}</strong><br>
          <small>${item.price.toFixed(2)} SAR x ${item.quantity}</small>
        </div>
        <div style="text-align: right;">
          <div>${(item.price * item.quantity).toFixed(2)} SAR</div>
          <button class="btn-void" onclick="voidItem(${index})">‚ùå</button>
        </div>
      `;
      itemsList.appendChild(itemDiv);
    });
  }

  updateTotals();
}

function updateTotals() {
  const subtotal = currentInvoice.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const discountAmount = subtotal * (currentInvoice.customerDiscount / 100);
  const subtotalAfterDiscount = subtotal - discountAmount;
  const taxAmount = subtotalAfterDiscount * 0.15; // 15% tax
  const total = subtotalAfterDiscount + taxAmount;

  document.getElementById('subtotal').textContent = subtotal.toFixed(2) + ' SAR';
  document.getElementById('discount-amount').textContent = discountAmount.toFixed(2) + ' SAR';
  document.getElementById('tax-amount').textContent = taxAmount.toFixed(2) + ' SAR';
  document.getElementById('total-amount').textContent = total.toFixed(2) + ' SAR';
}

function printDraftInvoice() {
  if (currentInvoice.items.length === 0) {
    alert('Please add items to the invoice first');
    return;
  }

  if (!currentInvoice.tableNumber) {
    alert('Please select a table number');
    return;
  }

  const invoiceData = {
    items: currentInvoice.items,
    table_number: currentInvoice.tableNumber,
    customer_phone: currentInvoice.customerPhone,
    customer_discount: currentInvoice.customerDiscount
  };

  fetch('/api/pos/palace_india/print_draft', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(invoiceData)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Open print window
      const printWindow = window.open('', '_blank');
      printWindow.document.write(data.invoice_html);
      printWindow.document.close();
      printWindow.print();
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error printing draft invoice:', error);
    alert('Failed to print draft invoice');
  });
}

function showPaymentModal() {
  if (currentInvoice.items.length === 0) {
    alert('Please add items to the invoice first');
    return;
  }

  if (!currentInvoice.tableNumber) {
    alert('Please select a table number');
    return;
  }

  $('#paymentModal').modal('show');
}

function processPayment(method) {
  const invoiceData = {
    items: currentInvoice.items,
    table_number: currentInvoice.tableNumber,
    customer_phone: currentInvoice.customerPhone,
    customer_discount: currentInvoice.customerDiscount,
    payment_method: method
  };

  fetch('/api/pos/palace_india/process_payment', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(invoiceData)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Open print window
      const printWindow = window.open('', '_blank');
      printWindow.document.write(data.invoice_html);
      printWindow.document.close();
      printWindow.print();

      // Clear invoice
      clearInvoice();
      alert('Payment processed successfully!');
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error processing payment:', error);
    alert('Failed to process payment');
  });

  $('#paymentModal').modal('hide');
}

function voidItem(index) {
  $('#void-item-index').val(index);
  $('#voidModal').modal('show');
}

function confirmVoidItem() {
  const password = $('#void-password').val();
  const itemIndex = parseInt($('#void-item-index').val());

  // Verify password with backend
  fetch('/api/pos/palace_india/verify_void_password', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ password: password })
  })
  .then(response => response.json())
  .then(data => {
    if (data.valid) {
      currentInvoice.items.splice(itemIndex, 1);
      updateInvoiceDisplay();
      $('#voidModal').modal('hide');
      $('#void-password').val('');
    } else {
      alert('Incorrect password');
    }
  })
  .catch(error => {
    console.error('Error verifying password:', error);
    alert('Failed to verify password');
  });
}

// Customer search functions
function searchCustomers() {
  const query = document.getElementById('customer-search').value.trim();
  if (query.length < 2) {
    hideCustomerResults();
    return;
  }

  fetch(`/api/pos/palace_india/customers/search?q=${encodeURIComponent(query)}`)
    .then(response => response.json())
    .then(customers => {
      displayCustomerResults(customers);
    })
    .catch(error => {
      console.error('Error searching customers:', error);
      hideCustomerResults();
    });
}

function displayCustomerResults(customers) {
  const resultsDiv = document.getElementById('customer-results');

  if (!customers || customers.length === 0) {
    resultsDiv.innerHTML = '<div class="dropdown-item text-muted">No customers found</div>';
  } else {
    resultsDiv.innerHTML = '';
    customers.forEach(customer => {
      const item = document.createElement('div');
      item.className = 'dropdown-item';
      item.style.cursor = 'pointer';
      item.innerHTML = `
        <strong>${customer.name}</strong><br>
        <small>üì± ${customer.phone} | üí∞ ${customer.discount_percent}% discount</small>
      `;
      item.onclick = () => selectCustomer(customer);
      resultsDiv.appendChild(item);
    });
  }

  resultsDiv.style.display = 'block';
}

function selectCustomer(customer) {
  selectedCustomer = customer;
  currentInvoice.customerId = customer.id;
  currentInvoice.customerName = customer.name;
  currentInvoice.customerPhone = customer.phone;
  currentInvoice.customerDiscount = customer.discount_percent;

  // Update UI
  document.getElementById('customer-search').value = '';
  document.getElementById('customer-discount').value = customer.discount_percent;
  document.getElementById('customer-name').textContent = customer.name;
  document.getElementById('customer-phone').textContent = customer.phone;
  document.getElementById('selected-customer').style.display = 'block';

  hideCustomerResults();
  updateInvoiceDisplay();
}

function clearCustomer() {
  selectedCustomer = null;
  currentInvoice.customerId = null;
  currentInvoice.customerName = '';
  currentInvoice.customerPhone = '';
  currentInvoice.customerDiscount = 0;

  // Update UI
  document.getElementById('customer-search').value = '';
  document.getElementById('customer-discount').value = '0';
  document.getElementById('selected-customer').style.display = 'none';

  updateInvoiceDisplay();
}

function hideCustomerResults() {
  document.getElementById('customer-results').style.display = 'none';
}

function clearInvoice() {
  if (currentInvoice.items.length > 0 && !confirm('Are you sure you want to clear all items?')) {
    return;
  }

  currentInvoice = {
    items: [],
    tableNumber: document.getElementById('table-number').value,
    customerId: selectedCustomer ? selectedCustomer.id : null,
    customerName: selectedCustomer ? selectedCustomer.name : '',
    customerPhone: selectedCustomer ? selectedCustomer.phone : '',
    customerDiscount: selectedCustomer ? selectedCustomer.discount_percent : 0
  };
  updateInvoiceDisplay();
}
</script>

{% endblock %}
