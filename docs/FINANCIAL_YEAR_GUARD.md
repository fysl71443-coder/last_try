# حارس السنة المالية (Financial Year Guard)

## القاعدة

**لا توجد سنة مالية مفتوحة = لا توجد عملية.**

أي عملية من الأنواع التالية **يجب** أن تمر عبر التحقق من الفترة المالية (مصدر الحقيقة: `services/gl_truth.py`):

| العملية | الملف | الدالة / التحقق |
|---------|-------|-----------------|
| فاتورة مبيعات | `routes/sales.py` | `can_create_invoice_on_date(inv_date)` قبل الحفظ |
| فاتورة مشتريات | `routes/purchases.py` | `can_create_invoice_on_date(inv_date)` قبل الحفظ |
| فاتورة مصروف | `routes/expenses.py` | `can_create_invoice_on_date(inv_date)` قبل الحفظ |
| قيد يدوي | `routes/journal.py` | `is_period_open_for_date(d)` + `validate_journal_gates()` قبل الإنشاء |
| تعديل/حذف/ترحيل قيد | `routes/journal.py` | `can_mutate_journal(je)` → عند الفشل `abort(403, "الفترة المالية مغلقة")` |
| استيراد قيود (Backfill) | `routes/journal.py` | `is_period_open_for_date(entry_date)` لكل فاتورة قبل إنشاء القيد؛ إن كانت الفترة مغلقة يُضاف إلى الأخطاء ويُتخطى |

## الدوال في gl_truth

- **`get_fiscal_year_for_date(d)`** — السنة المالية التي يقع فيها التاريخ.
- **`is_period_open_for_date(d)`** — هل الفترة مفتوحة للقيود/الفواتير؟ (سنة موجودة، تاريخ داخل النطاق، حالة مفتوحة أو فترة استثنائية).
- **`can_mutate_journal(entry)`** — هل يُسمح بتعديل/حذف/ترحيل هذا القيد؟ (يعتمد على تاريخ القيد).
- **`can_create_invoice_on_date(d)`** — نفس منطق `is_period_open_for_date(d)`؛ يُستدعى قبل إنشاء فاتورة مبيعات/مشتريات/مصروف.
- **`validate_journal_gates(entry_date, lines)`** — البوابات السبع لقيود اليومية (سنة مالية، نطاق، فترة مفتوحة، مدين=دائن، إلخ).

## سلوك واجهة القيود

- قيود اليومية = **سلطة عليا**. لا تتأثر بالواجهة ولا بالمستخدم ولا بتأخير التحميل.
- عند محاولة إنشاء/تعديل/حذف/ترحيل قيد في فترة مغلقة: **استجابة HTTP 403** مع رسالة واضحة (مثل: "الفترة المالية مغلقة")، وليس مجرد رسالة flash وتوجيه.
