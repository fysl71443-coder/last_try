# نشر النظام على Render مع PostgreSQL دون فقدان البيانات

هذا المستند **يشرح فقط** طريقة دفع الكود الحالي إلى المستودع ونشر النظام على Render مع PostgreSQL وربط شجرة الكود بقاعدة البيانات **دون فقدان أي بيانات**. لا يتضمن تنفيذ الدفع أو النشر من قبلي.

---

## ١. الفكرة العامة

- **المستودع (Git)** = يحوي **الكود فقط** (ملفات المشروع: Python، قوالب، ثابتات، إعدادات، هجرات).
- **قاعدة البيانات على Render** = خدمة **منفصلة ومستمرة**: بياناتك (المستخدمون، الفواتير، الحسابات، …) تُخزَّن فيها ولا تُرفع مع الكود.
- **الربط** = عند كل نشر، التطبيق على Render يتصل **بنفس** قاعدة PostgreSQL عبر متغير بيئة `DATABASE_URL`. لذلك:
  - دفع كود جديد إلى المستودع → Render يعيد بناء التطبيق ويشغّله → التطبيق الجديد يتصل **بنفس** قاعدة البيانات القديمة → **لا فقدان للبيانات**.

---

## ٢. ما الذي يُدفع إلى المستودع (وما الذي لا يُدفع)

### يُدفع (يُرفع إلى المستودع)

- كل ملفات الكود: `app/`, `routes/`, `templates/`, `static/`, `config.py`, `requirements.txt`, …
- مجلد **`migrations/`** (هجرات Flask-Migrate/Alembic) — مهم جداً لأنها تصف هيكل الجداول وتغييراته دون حذف البيانات.
- ملفات النشر: `render.yaml`, `Procfile`, `Dockerfile` (إن وُجدت).
- أي إعدادات **عامة** لا تحتوي أسراراً (مثل `.env.example`).

### لا يُدفع (يجب أن تبقى خارج المستودع)

- ملف **`.env`** — فيه أسرار (مثل `SECRET_KEY`, `DATABASE_URL` المحلي). يجب أن يكون في `.gitignore`.
- مجلد **`instance/`** وملف **`*.db`** (SQLite المحلي) — بياناتك المحلية لا تُرفع؛ على Render ستستخدم PostgreSQL وليس SQLite.
- أي ملفات مؤقتة أو نسخ احتياطية محلية.

النتيجة: **شجرة الكود في المستودع = الكود + الهجرات فقط، وليست قاعدة البيانات.** قاعدة البيانات على Render منفصلة ومربوطة عبر `DATABASE_URL`.

---

## ٣. كيف يعمل الربط بين الكود وقاعدة البيانات على Render

1. **إنشاء قاعدة بيانات PostgreSQL على Render**
   - من لوحة Render: New → PostgreSQL.
   - Render يعطيك **Internal Database URL** (وغالباً External أيضاً). هذا هو `DATABASE_URL`.

2. **ربط خدمة الويب (Web Service) بقاعدة البيانات**
   - عند إنشاء أو تعديل الـ Web Service الذي يشغّل تطبيقك:
     - في **Environment** أضف متغيراً:
       - الاسم: `DATABASE_URL`
       - القيمة: نفس الرابط الذي أعطاك إياه Render لقاعدة PostgreSQL (Internal Database URL عادةً).
   - يمكنك أيضاً ربط قاعدة البيانات من واجهة Render بـ "Add Environment Group" أو بربط الـ Database بالـ Service حتى يحقن Render `DATABASE_URL` تلقائياً.

3. **ما يحدث عند كل نشر (بعد دفع كود جديد)**
   - Render يسحب الكود من المستودع.
   - يشغّل أوامر البناء (مثل `pip install -r requirements.txt`).
   - يشغّل التطبيق (مثل `gunicorn ...`).
   - التطبيق عند التشغيل يقرأ `DATABASE_URL` من البيئة ويتصل **بنفس** قاعدة PostgreSQL التي استخدمتها من قبل.
   - **لا إعادة إنشاء للقاعدة من الصفر**، ولا حذف للبيانات، طالما أنك لا تغيّر يدوياً شيئاً يمسّ البيانات (مثل DROP TABLE).

الخلاصة: **شجرة الكود المدفوعة في المستودع تُربط دائماً بنفس قاعدة البيانات عبر `DATABASE_URL`؛ الدفعات الجديدة لا تحذف البيانات.**

---

## ٤. عدم فقدان البيانات: دور الهجرات (Migrations)

- تغييرات هيكل قاعدة البيانات (جداول جديدة، أعمدة جديدة، فهارس، …) يجب أن تتم عبر **الهجرات** (Flask-Migrate / Alembic)، وليس عبر حذف الجداول وإعادة إنشائها.
- الهجرات موجودة في مشروعك في **`migrations/versions/`**.
- على السيرفر (Render):
  - عند النشر يمكن تشغيل أمر مثل: `flask db upgrade` (أو `python -m flask db upgrade`) في **Build Command** أو **Start Command** أو في خطوة ما بعد البناء، بحيث تُطبَّق الهجرات على قاعدة PostgreSQL.
  - النتيجة: أي تعديل في الهيكل (مثلاً عمود جديد) يُطبَّق **فوق** البيانات الحالية دون مسح الجداول، فلا فقدان للبيانات.

لذلك: **ربط شجرة الكود بقاعدة البيانات دون فقدان البيانات = استخدام نفس `DATABASE_URL` + تطبيق الهجرات عند النشر.**

---

## ٥. ما الذي يجب تعديله في المشروع (منطقياً) لاستخدام PostgreSQL على Render

حالياً في مشروعك:

- في **`config.py`**: الإعداد مضبوط على استخدام SQLite فقط (`USE_ONLY_LOCAL_SQLITE = True`)، ولا يُقرأ `DATABASE_URL` من البيئة لاستخدام PostgreSQL.
- في **`app/__init__.py`**: حتى لو غيّرت الإعداد، هناك منطق يفرض استخدام SQLite عند وجود كلمة `postgres` في الرابط، أي أن التطبيق لا يستخدم PostgreSQL في أي بيئة.

**لنشر النظام على Render مع PostgreSQL دون فقدان البيانات (بعد أن تصبح قاعدة البيانات على Render جاهزة):**

1. **في `config.py`**
   - جعل قراءة رابط قاعدة البيانات كالتالي:
     - إذا وُجد متغير بيئة **`DATABASE_URL`** (كما يحدث على Render) → استخدمه كـ `SQLALCHEMY_DATABASE_URI`.
     - إذا لم يُوجد (تطوير محلي) → استخدم SQLite كما هو الآن.
   - إزالة أو تعديل أي إجبار لاستخدام SQLite عندما يكون الرابط خاصاً بـ PostgreSQL.

2. **في `app/__init__.py`**
   - إزالة الجزء الذي يفرض استبدال رابط PostgreSQL بـ SQLite، حتى عندما يكون `DATABASE_URL` مضبوطاً (أي السماح فعلياً لاستخدام PostgreSQL على Render).

3. **على Render**
   - تعيين **`DATABASE_URL`** في Environment لخدمة الويب بالقيمة التي تعطيك إياها خدمة PostgreSQL (Internal Database URL).
   - التأكد من تشغيل **`flask db upgrade`** عند النشر (في أمر البناء أو التشغيل أو سكريبت تشغيل) حتى تُطبَّق الهجرات على PostgreSQL دون مسح البيانات.

بعد هذه التعديلات: **نفس شجرة الكود** المدفوعة إلى المستودع ستُبنى على Render وتتصل تلقائياً بقاعدة PostgreSQL عبر `DATABASE_URL`، ولن تفقد البيانات عند كل نشر.

---

## ٦. إذا كانت لديك بيانات محلية في SQLite وترغب في استخدام PostgreSQL على Render

- **البيانات على Render ستكون في PostgreSQL فقط.** لا يتم "رفع" ملف SQLite إلى Render.
- خياران:
  1. **البدء من قاعدة PostgreSQL فارغة على Render**  
     - تدفع الكود، تضبط `DATABASE_URL`، تشغّل الهجرات (`flask db upgrade`) → الهيكل يُنشأ، والبيانات تُضاف لاحقاً عبر التطبيق أو استيراد.
  2. **نقل البيانات من SQLite المحلي إلى PostgreSQL**  
     - يتم **خارج** عملية الدفع إلى المستودع: تصدير من SQLite (مثلاً dump أو سكريبت تصدير) ثم استيراد إلى PostgreSQL (عبر أدوات أو سكريبتات استيراد). بعد ذلك على Render تستخدم فقط PostgreSQL؛ المستودع يبقى كود + هجرات فقط.

في الحالتين: **دفع الكود إلى المستودع لا يحذف ولا يستبدل بيانات PostgreSQL على Render.**

---

## ٧. ملخص سريع

| الموضوع | التوضيح |
|--------|---------|
| **دفع الكود إلى المستودع** | ترفع فقط ملفات المشروع والهجرات؛ لا ترفع `.env` ولا ملفات SQLite. |
| **قاعدة البيانات على Render** | خدمة PostgreSQL منفصلة؛ بياناتك تعيش فيها ولا تُرفع مع الكود. |
| **الربط** | متغير البيئة `DATABASE_URL` في خدمة الويب على Render يربط التطبيق بنفس قاعدة PostgreSQL. |
| **عدم فقدان البيانات** | كل نشر جديد = نفس الكود يتصل بنفس القاعدة؛ استخدم الهجرات (`flask db upgrade`) لأي تغيير في الهيكل. |
| **تعديلات المشروع** | تمكين استخدام `DATABASE_URL` في `config.py` وإزالة إجبار SQLite في `app/__init__.py` عند وجود PostgreSQL، ثم ضبط `DATABASE_URL` وتشغيل الهجرات على Render. |

بهذا تكون طريقة دفع الكود الحالي للمستودع ونشر النظام على Render مع PostgreSQL وربط شجرة الكود بقاعدة البيانات **دون فقدان البيانات** واضحة، دون تنفيذ الدفع أو النشر من هنا.
