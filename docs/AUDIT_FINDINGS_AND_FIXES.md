# تصحيحات خلاصة التدقيق (Design & Logic)

## تم تنفيذه

### 1. تكرار وتضارب شجرة الحسابات في العرض
- **المشكلة:** الحساب 5100 (تكلفة المبيعات) و 5140 يظهران مكررين؛ الحسابات التجميعية تظهر لها مدين/دائن.
- **التصحيح:**
  - **قاعدة ذهبية:** الحساب الذي له أبناء → لا يحمل أرقاماً (عرض عنوان فقط).
  - ميزان المراجعة وقائمة الحسابات وطباعة/تصدير الميزان: استخدام **الحسابات الورقية فقط** (`LEAF_CODES` من `data/coa_new_tree`).
  - تجميع بالرمز `Account.code` (وليس `Account.id`) لمنع تكرار نفس الرمز.
  - في API ميزان المراجعة: الحسابات التجميعية تُعرض بـ `debit=0, credit=0, balance=0` (عنوان فقط).

### 2. ميزان المراجعة — عرض الرصيد بشكل مهني
- **المشكلة:** عرض أرصدة سالبة مثل -164.75 غير مقبول مهنياً.
- **التصحيح:** عرض الرصيد مع طبيعته: **"X مدين"** أو **"X دائن"** (عمود "الرصيد (طبيعة)" في شاشة الحسابات).

### 3. كشف حساب المورد — الحالة والمدفوعات
- **المشكلة 1:** حالة الفاتورة تظهر "partial" رغم دفع كامل المبلغ (متبقي 0.00).
- **التصحيح:** عرض الحالة من الرصيد الفعلي: متبقي ≤ 0.01 → **paid**؛ مدفوع جزئياً → **partial**؛ غير مدفوع → **unpaid**. وتحديث `PurchaseInvoice.status` عند حفظ الدفعة (في المشتريات ومسارات الدفع).
- **المشكلة 2:** إجمالي المدفوعات في الكشف يتجاوز إجمالي الفواتير (دفعات قيود قديمة 2111 غير مربوطة بفاتورة كانت تُحسب لكل الموردين).
- **التصحيح:** في كشف المورد عرض **فقط** الدفعات المرتبطة بفواتير هذا المورد (JournalLine 2111 مدين حيث `invoice_id in فواتير المورد`)، وعدم دمج قيود 2111 مدين بدون `invoice_id` (legacy) في قائمة الدفعات أو في تخصيص الرصيد لهذا المورد.
- **قاعدة تدقيق:** إضافة `rule_supplier_overpayment`: إذا تجاوز إجمالي المدفوعات المرتبطة بفواتير موردٍ إجماليَ فواتيره، تُسجّل ملاحظة تدقيق (اختلال محاسبي، مراجعة ربط الدفعات بالفواتير).

### 4. ربط القيود المنشورة بالفواتير (تثبيت القيود)
- **المشكلة:** قيود منشورة (JE-PAY-…، JE-EXP-…، JE-PUR-…، …) موجودة لكن غير مربوطة بالفواتير (invoice_id / invoice_type فارغ أو غير معبأ على أسطر القيد)، فكشوف العملاء/الموردين والميزان والقوائم المالية لا تعكس الربط الصحيح.
- **التصحيح:**
  - في **backfill** القيود (إنشاء قيد من فاتورة): تعبئة **invoice_id** و **invoice_type** على كل **JournalLine** عند الإنشاء (نفس قيم الـ JournalEntry) حتى تظهر الدفعات والأرصدة في كشوف الحساب.
  - **سكربت ربط القيود الحالية:** `scripts/link_journal_entries_to_invoices.py` يمر على كل قيد منشور غير مربوط (invoice_id/invoice_type فارغ)، يستخرج رقم الفاتورة من رقم القيد أو الوصف (مثل JE-SAL-…، Purchase …، Expense …)، يربط الـ JournalEntry وأسطر الـ JournalLine بالفاتورة المناسبة.
- **تشغيل مرة واحدة بعد التحديث:**  
  `python scripts/link_journal_entries_to_invoices.py` ثم إنشاء أي قيود ناقصة من واجهة "ترحيل القيود الناقصة" أو:  
  `python scripts/link_journal_entries_to_invoices.py --backfill`

### 5. تقرير التدفق النقدي (Cash Flow) يظهر صفر
- **المشكلة:** رغم وجود أرصدة على الحسابات النقدية (1111، 1112، 1121)، يظهر التقرير Inflow = 0 و Outflow = 0.
- **السبب:** عند وجود جدول `cashflow_summary` (حتى لو فارغاً) كان التقرير يعتمد عليه؛ والجدول إن لم يُملأ يبقى فارغاً فيُعاد صفر.
- **التصحيح:** استخدام **قيود اليومية** كمصدر لبيانات التدفق النقدي عندما لا يوجد أي صف في `cashflow_summary` (أي نستخدم الجدول فقط إن وُجدت فيه صفوف فعلاً؛ وإلا نستعلم من JournalLine + Account للحسابات 1111، 1112، 1121، 1122، 1123).

---

## مراجعة الحسابات الفرعية (ميزان وتدفق)
- **صندوق فرعي (1112):** رصيد دائن كبير قد يشير إلى قيد خاطئ أو تحويل غير مسجل؛ مراجعة القيود المرتبطة به.
- **عملاء (1141) وضريبة مخرجات (2141):** التأكد من مطابقة الضريبة والمدفوعات مع الفواتير؛ وتدقيق ربط طريقة الدفع (نقدي/بنك/آجل) بالحساب المستخدم في القيد.
- **ضريبة المدخلات (1170) و 2141:** التحقق من تطابق حركة الضريبة مع الفواتير والمدفوعات.

---

## مطلوب تنفيذ لاحقاً (مراجع التصميم)

### 6. رصيد الموردين (2111) وترحيل المصروفات
- **القاعدة:** مصروف نقداً → صندوق فقط؛ بنك → بنك فقط؛ آجل → مورد (2111) فقط. لا خلط.
- **الموقع المقترح:** منطق إنشاء قيود المصروفات (ربط طريقة الدفع بالحساب المستخدم).

### 7. اتساق نوع العملية مع الحساب
- **القاعدة:** ربط نوع العملية (مصروف تشغيلي / غير تشغيلي) بـ Account Mapping؛ منع اختيار حساب عشوائي.
- **الموقع المقترح:** واجهة إدخال المصروفات + قواعد التحقق.

### 8. ضريبة القيمة المضافة — Rule Engine
- **القاعدة:** VAT فقط على حسابات مصروف خاضعة؛ منع التلاعب اليدوي.
- **الموقع المقترح:** التحقق عند ترحيل قيد يحتوي ضريبة مدخلات/مخرجات.

---

## ملاحظة
التصحيحات (1)–(5) تم تطبيقها في الكود. البنود (6–8) تحتاج تعديلات تصميم ومنطق أعمق ويمكن تنفيذها على مراحل.

للخطوات التفصيلية والجدول التحليلي لكل الحسابات مع الحالات، راجع **`docs/COMPREHENSIVE_AUDIT_CHECKLIST.md`**.
