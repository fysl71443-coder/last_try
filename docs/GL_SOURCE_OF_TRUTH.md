# قيود اليومية مصدر الحقيقة — جميع الشاشات والتقارير

## المبدأ
- **مصدر الحقيقة الوحيد للأرصدة والحركات**: قيود اليومية المرحّلة فقط (`JournalEntry.status = 'posted'` + `JournalLine`).
- لا يُعتمد على حسابات داخلية من الفواتير أو الدفعات أو الجداول المساعدة؛ أي رصيد أو حركة تُعرض يجب أن تكون قابلة للتتبع من القيود.
- **كل حركة يجب أن يكون لها قيد**؛ عند إنشاء قيد جديد، تتحدّث جميع الأرصدة في الشاشات فوراً لأنها تُحسب من القيود.

## ما تم تنفيذه

### 1. خدمة الأرصدة من القيود (`services/gl_truth.py`)
- **`get_account_debit_credit_from_gl(account_id, asof_date)`**: مجموع مدين/دائن لحساب حتى تاريخ من القيود المرحّلة فقط.
- **`get_account_balance_from_gl_by_code(account_code, asof_date)`**: رصيد حساب من القيود فقط (بحسب نوع الحساب: أصل مدين، التزام/حقوق دائن).
- **`sum_gl_by_account_code_and_date_range(...)`**: مجموع (دائن − مدين) أو (مدين − دائن) لحساب/حسابات في نطاق تاريخ من القيود المرحّلة.
- **`sync_ledger_from_journal(je)`**: عند إنشاء قيد مرحّل (بدون المرور عبر "ترحيل" يدوي)، يُنسخ إلى `LedgerEntry` لضمان تطابق أي شاشة ما زالت تقرأ من دفتر الأستاذ.

### 2. التقارير والقوائم المالية
- **ميزان المراجعة / قائمة المركز المالي** (في `routes/financials.py`): كانت وتظل مبنية على `JournalLine` + `JournalEntry.status == 'posted'`.
- **نفس التقارير في `app/routes.py`** (إن وُجدت مسجّلة): تم تحويلها من `LedgerEntry` إلى `JournalLine` + `JournalEntry` حتى تكون من مصدر واحد.
- **قائمة الدخل (VAT، إيرادات، نوع الحساب)** في `app/routes.py`: تم استبدال استعلامات `LedgerEntry` باستعلامات من `JournalLine` + `JournalEntry` (مرحّل فقط).

### 3. الرواتب والموظفين
- **رصيد السلف (حساب 1151)** في شاشة الرواتب: يُحسب من القيود عبر `get_account_debit_credit_from_gl`.

### 4. مزامنة دفتر الأستاذ عند إنشاء قيود مرحّلة
عند إنشاء قيد بـ `status='posted'` مباشرة (بدون ضغط "ترحيل")، يُستدعى `sync_ledger_from_journal(je)` بعد إضافة الأسطر حتى يبقى `LedgerEntry` متطابقاً مع القيود:
- `_create_expense_journal`
- `_create_expense_payment_journal`
- `_create_receipt_journal`
- `_create_supplier_payment_journal` وقيود رسوم البنك
- `_create_supplier_direct_payment_journal`

(ترحيل القيود اليدوية في `routes/journal.py` كان أصلاً يكتب إلى `LedgerEntry` داخل `post_entry`.)

### 5. العملاء والموردون والمدفوعات
- **كشف حساب العميل** (`routes/customers.py`): يعتمد على فواتير المبيعات + **التحصيلات من القيود** (حساب 1141، `JournalLine` مرتبط بفاتورة/نوع مبيعات).
- **كشف حساب المورد** (`routes/suppliers.py`): يعتمد على فواتير المشتريات + **الدفعات من القيود** (حساب 2111، `JournalLine` مرتبط بفاتورة/نوع مشتريات).

بهذا تكون الأرصدة المعروضة في الشاشات والتقارير مطابقة للقيود، وتحديث أي قيد جديد يظهر فوراً في كل الشاشات التي تقرأ من القيود.

---

## السجلات والمقاييس (sync_ledger_from_journal)
- **تسجيل**: نجاح/فشل، زمن التنفيذ (ثانية)، عدد الأسطر المزامَنة، ورقم القيد.
- **تنبيه عند فشل متكرر**: بعد `SYNC_LEDGER_ALERT_THRESHOLD` مرات فشل ضمن نافذة `SYNC_LEDGER_ALERT_WINDOW_SEC` يُسجَّل تحذير (repeated failures).
- **مقاييس للتكامل مع أنظمة مراقبة**: `get_sync_ledger_metrics()` تُرجع failure_count و last_failure_ts وحدّ التنبيه.

## الفهارس الموصى بها
لتقليل نقاط الاختناق في استعلامات GL:
- **journal_lines**: `line_date`، مركّب `(account_id, line_date)`، مركّب `(journal_id, line_date)`.
- **ledger_entries**: `account_id` (بالإضافة إلى `date` الموجود).

تشغيل إضافة الفهارس: `python scripts/add_gl_indexes.py`.

## اختبار التحميل
سكربت **scripts/load_test_gl_truth.py** يشغّل دوال gl_truth ببيانات حجمية ويقيس زمن الاستجابة.
- `--seed N`: إدراج أسطر تقريبية لقيود (لحجم أكبر).
- `--calls M`: عدد استدعاءات كل دالة.

استخدمه لتحديد نقاط الاختناق وقياس تأثير الفهارس.

## مصالحة JournalLine مقابل LedgerEntry
سكربت **scripts/reconcile_gl_ledger.py** يقتارن مجمّعات (account_id, date) من القيود المرحّلة مقابل LedgerEntry ويصوّر الفروقات.
- بدون معاملات: طباعة إحصائيات وتفاصيل الفروقات.
- **--fix**: إصلاح آلي بإضافة أسطر LedgerEntry الناقصة من القيود المرحّلة (لا يحذف زائداً تلقائياً).
- **--report path**: كتابة تقرير JSON أو HTML إلى المسار.

يُنصح بتشغيله دورياً (cron أو مهمة مجدولة) ومراجعة التقرير.

## عرض ثقيل (Materialized views / جدول ملخّص)
إذا ظهرت مشاكل أداء على ميزان المراجعة أو تقارير نهاية الفترة:
- يمكن اعتماد **جدول ملخّص** يُحدَّث دورياً (مهمة ليلية أو بعد كل ترحيل) يجمع (account_id, date, sum_debit, sum_credit) من JournalLine المرحّل.
- أو **materialized view** (إن كان المحرك يدعمها) مع REFRESH دوري.
- الخيار يُحدَّد حسب قياس الأداء (نتائج load_test_gl_truth والملاحظات على الإنتاج).

## قواعد المطورين
انظر **DEVELOPER_GL_RULES.md**: أي شاشة جديدة يجب أن تقرأ من JournalLine/JournalEntry فقط؛ وإذا استُخدم LedgerEntry يجب توضيح سبب الاستثناء وتوثيقه.
