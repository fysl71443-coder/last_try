# شجرة الحسابات وقواعد إنشاء القيود

## 1. أهداف التصميم

| القاعدة | الوصف |
|---------|--------|
| رمز فريد | كل حساب له `Account.code` فريد. |
| حسابات تجميعية | لا تحمل أرصدة؛ تظهر كعنوان فقط (Parent Accounts). |
| حسابات ورقية | فقط الـ **Leaf Codes** تحمل أرصدة وتُستخدم في القيود. |
| التحقق عند الربط | عند ربط حساب بعملية: الحساب موجود في الشجرة، ورقي، ومناسب لنوع العملية. |

## 2. هيكل البيانات (الحساب)

- `Account.code`: فريد، من شجرة الحسابات المعتمدة.
- `Account.name` / `name_ar` / `name_en`: للعرض.
- `Account.type`: ASSET | LIABILITY | EQUITY | REVENUE | EXPENSE | COGS | TAX.
- `Account.parent_account_code`: للحسابات الفرعية (من الشجرة).
- **ورقي (Leaf):** يُستمد من `data.coa_new_tree.LEAF_CODES` — لا عمود `is_leaf` في الجدول؛ المصدر الوحيد للورقية هو الشجرة.

التحقق عند إنشاء قيد أو ربط عملية:

```python
from services.account_validation import validate_account_for_transaction, validate_journal_entry_balanced

# قبل إضافة سطر قيد
ok, err = validate_account_for_transaction("5230", "expense", role="debit")
if not ok:
    raise ValueError(err)

# قبل حفظ القيد
ok, err = validate_journal_entry_balanced(lines)
if not ok:
    raise ValueError(err)
```

## 3. منطق إنشاء القيود (حسب نوع العملية)

| نوع العملية | المدين (Debit) | الدائن (Credit) | ملاحظات |
|-------------|----------------|-----------------|---------|
| مصروف نقدي | حساب المصروف | صندوق رئيسي (1111/1112/1113) | فقط صندوق، لا بنك |
| مصروف بنك | حساب المصروف | حساب بنك (1121/1122/1123) | لا إنشاء قيد مصروف بنكي تلقائي خاطئ |
| مشتريات آجل | المخزون/المصروف + ضريبة مدخلات | حساب المورد (2111) | حسب المورد |
| مشتريات نقدية | المخزون/المصروف + ضريبة مدخلات | صندوق/بنك | حسب طريقة الدفع |
| مبيعات نقدية | صندوق/بنك | المبيعات + ضريبة مخرجات | |
| مبيعات آجلة | العملاء (1141) | المبيعات + ضريبة مخرجات | |

تحقق شامل قبل الحفظ:

1. القيد **متوازن**: مجموع المدين = مجموع الدائن.
2. كل حساب **موجود** في الشجرة و**ورقي**.
3. نوع العملية **متوافق** مع الحسابات المستخدمة.
4. لا قيود تلقائية غير متعارف عليها (مثل مصروف بنكي يُرحّل على صندوق).

## 4. الربط بين العمليات والقيود

- أي عملية (فاتورة مبيعات/مشتريات/مصروف، راتب، دفعة) يُنشأ لها **قيد مرتبط** فوراً (أو عبر ترحيل القيود الناقصة).
- لا يُفترض وجود **عملية بدون قيد**؛ محرك التدقيق يبلّغ عن "فواتير بدون قيد".
- تعديل القيد يُسمح به فقط في إطار تعديل العملية، مع حفظ سجل (audit log) إن وُجد.
- لا قيود تلقائية عند عملية غير معرفة (مثل افتراض مصروف بنكي كقيد صندوق).

## 5. التقارير والقوائم المالية

- استخدام **الحسابات الورقية فقط** (Leaf Codes) في ميزان المراجعة والعرض.
- عدم تغيير رمز أو اسم حساب أثناء التقرير.
- عرض الرصيد بطبيعته: **X مدين** أو **X دائن** (لا أرقام سالبة فقط).
- تجميع صحيح: الحسابات التجميعية عناوين فقط، أرصدة = 0.
- Cross-check: كل رقم في التقارير يطابق القيود المرتبطة بالعملية.

## 6. التدقيق (Audit Engine)

- الهدف: التأكد من أن كل قيد متوازن، وكل حساب صحيح، وكل عملية مربوطة بقيد منطقي.
- أي خطأ **حرج** → يمنع إقفال السنة المالية (أو يتطلب سبب التجاوز).
- سجل التدقيق يتضمن: رقم العملية، الحسابات مدين/دائن، نوع العملية، الملاحظات وسبب الخطأ، طريقة التصحيح المقترحة.

## 7. إجراءات إضافية

- **منع قيود تلقائية غير صحيحة:** مصروف بنكي لا يُرحّل على صندوق.
- **لقطة تدقيق** عند كل إقفال سنة.
- **سجلات مفصلة** لكل إنشاء/تعديل/حذف قيد (JournalAudit إن وُجد).
- **واجهات الإدخال:** تمنع اختيار حساب غير متوافق مع نوع العملية (استخدام `validate_account_for_transaction` في واجهة المصروفات وقيود اليومية).

## 8. الخدمة: `services/account_validation.py`

- `validate_account_for_transaction(account_code, transaction_type, role, payment_method)` → (ok, error_message)
- `validate_journal_entry_balanced(lines)` → (ok, error_message)
- `is_leaf_account(account_code)` → bool
- `get_account_type(account_code)` → نوع الحساب من الشجرة
- `validate_account_codes_in_coa(account_codes)` → (all_ok, list of errors)

استخدامها عند إنشاء قيد من واجهة المصروفات، أو عند إدخال قيد يومية يدوي، أو في أي مسار يُنشئ قيوداً يضمن تطابق الحسابات مع الشجرة ونوع العملية.
