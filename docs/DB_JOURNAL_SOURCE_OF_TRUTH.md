# مصدر الحقيقة: قيود اليومية المنشورة (Journal as Single Source of Truth)

**القواعد الكاملة (لا استثناءات):** [IMMUTABLE_ACCOUNTING_RULES.md](IMMUTABLE_ACCOUNTING_RULES.md)

## المبدأ

- **مصدر الحقيقة الوحيد** في النظام المحاسبي هو **قيود اليومية المنشورة** (`journal_entries.status = 'posted'` و`journal_lines`).
- جميع التقارير المالية (ميزان المراجعة، الميزانية العمومية، قائمة الدخل، كشف الحساب، VAT) **يجب** أن تقرأ من `journal_lines` مع `journal_entries.status = 'posted'` فقط.
- أي بيانات **ليس لها قيد مرتبط** (فواتير بدون قيد، أو قيود تشير لفواتير/رواتب محذوفة) تُعتبر خللاً ويجب معالجتها أو حذفها حسب السياسة.
- **أي قيد** لا يُنشأ على القاعدة والواجهة **بتطابق تام** (مجموع المدين = مجموع الدائن، و`total_debit` = `total_credit`) **لا يُقبل** — التحقق يتم عند الحفظ وعند الترحيل.

## ما تم تطبيقه

1. **التقارير المالية (financials blueprint)**  
   - ميزان المراجعة، الميزانية العمومية، قائمة الدخل، كشف الحساب، التصدير، والطباعة (بما فيها `print/balance_sheet`) تقرأ كلها من `JournalLine` + `JournalEntry.status == 'posted'` فقط.

2. **طباعة الميزانية العمومية**  
   - تم تعديل `routes/financials.py` لاستخدام `JournalLine` بدلاً من `LedgerEntry` في `print_balance_sheet` ليكون مطابقاً لباقي التقارير ومصدر الحقيقة.

3. **التحقق من القيد عند الحفظ والترحيل**  
   - في `routes/journal.py`:  
     - عند **إنشاء قيد جديد**: لا يُحفظ إلا إذا `round(total_debit, 2) == round(total_credit, 2)`.  
     - عند **ترحيل قيد**: لا يُرحّل إلا إذا مجموع مدين الأسطر = مجموع دائن الأسطر و`total_debit == total_credit`.

4. **شجرة الحسابات (COA)**  
   - المرجع المعتمد: `data/coa_new_tree.py` (NEW_COA_TREE و LEAF_CODES).  
   - جدول `accounts` في القاعدة يجب أن يكون مرآة للحسابات المستخدمة في القيود (الحسابات الورقية على الأقل).  
   - يمكن مزامنة الشجرة إلى القاعدة عبر `seed_chart_of_accounts()` أو استيراد COA من الواجهة.

5. **LedgerEntry (تراثي)**  
   - `ledger_entries` مصدر تراثي؛ لا يُستخدم في التقارير المعتمدة.  
   - الترحيل من واجهة القيود يكتب إلى `journal_entries` + `journal_lines`، وعند الترحيل يُنسخ إلى `ledger_entries` للتوافق مع أي كود قديم.  
   - **المصدر المعتمد للتقارير**: `journal_lines` فقط.

## تدقيق تطابق القاعدة مع النظام

تشغيل سكربت التدقيق:

```bash
# من جذر المشروع
set PYTHONPATH=.
python scripts/db_audit_journal_integrity.py
```

يفحص السكربت:

1. **تطابق شجرة الحسابات**: رموز COA في `data/coa_new_tree` مقابل جدول `accounts`.  
2. **صلاحية القيود المنشورة**: كل قيد `posted` يكون مجموع المدين = مجموع الدائن ومطابقة `total_debit`/`total_credit`.  
3. **مراجع مكسورة**: قيود تشير إلى `invoice_id` أو `salary_id` غير موجود.  
4. **فواتير بدون قيد**: فواتير مبيعات/مشتريات/مصروفات ليس لها قيد مرتبط (invoice_id + invoice_type في journal_entries).  
5. **إحصاء LedgerEntry مقابل JournalLine**: للتأكد أن الاعتماد على JournalLine فقط.

## إجراءات مقترحة عند وجود خلل

- **حسابات في الشجرة غير موجودة في القاعدة**: تشغيل `seed_chart_of_accounts` أو استيراد COA.  
- **قيود غير متوازنة**: تصحيح الأسطر أو إلغاء ترحيل القيد وإعادة إنشائه.  
- **قيود بمرجع فاتورة/راتب مكسور**: إما استعادة الفاتورة/الراتب أو إزالة/تعديل المرجع في القيد حسب السياسة.  
- **فواتير بدون قيد**: استخدام "ترحيل من الفواتير" أو backfill لإنشاء قيود من الفواتير غير المرحلة.
