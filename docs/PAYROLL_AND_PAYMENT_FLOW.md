# مسير الرواتب والسداد — سير العمل المعتمد

## ١. إنشاء المسير (شاشة الموظفين → مسير رواتب)

1. **اختيار شهر المسير**: من القائمة اختر **السنة** و**الشهر** (كل مسير = شهر واحد).
2. **تطبيق الفلتر**: انقر **تطبيق** لتحميل قائمة الموظفين (حسب القسم/الحالة إن رغبت).
3. **تحديد الموظفين المشمولين**: علّق على الموظفين الذين سيشملهم المسير (checkbox).
4. **إدخال الراتب لكل موظف**: في عمود «الراتب» أدخل المبلغ المستحق لذلك الشهر لكل موظف محدد.
5. **حفظ / اعتماد المسير**: انقر **حفظ / اعتماد المسير** → يُحفظ المسير (سجلات رواتب للشهر المحدد) دون إنشاء قيد محاسبي.
6. **ترحيل المسير**: بعد الحفظ يظهر زر **ترحيل المسير (إنشاء قيد استحقاق)**. عند النقر يُنشأ قيد استحقاق واحد (مصروف رواتب / رواتب مستحقة 2121) لفترة ذلك الشهر، ويصبح المسير «مرحّلاً» حتى يتم السداد.

**ملاحظة**: كل مسير يُميّز برقم الشهر (السنة–الشهر)، وهو المعتمد في السداد والكشوفات.

---

## ٢. السداد — الطريقة الأولى: شاشة الموظفين → قسم السداد

تم إضافة تبويب **«السداد»** في شاشة الموظفين يتضمن:

### ٢.١ السداد الفردي (موظف واحد، شهر أو عدة أشهر)

- **اختيار الموظف** من القائمة.
- **تحميل الأشهر غير المدفوعة**: يعرض جدولاً بكل أشهر المسيرات التي لها متبقي (غير مدفوعة أو مدفوعة جزئياً) لهذا الموظف.
- **سداد شهر واحد**: من كل صف يمكن فتح صفحة سداد ذلك الشهر فقط (رابط «سداد شهر واحد»).
- **سداد عدة أشهر**: حدد الأشهر المطلوبة (checkbox) ثم اختر **التاريخ** و**طريقة الدفع** وانقر **سداد المحدد (كامل)** → يتم دفع المتبقي بالكامل لكل شهر محدد مع إنشاء قيود السداد.

### ٢.٢ السداد الجماعي (مسير واحد أو عدة مسيرات)

- **تحميل المسيرات غير المدفوعة**: يعرض جدولاً بجميع المسيرات (الشهور) التي لها متبقي غير مدفوع.
- حدد **التاريخ** و**طريقة الدفع**.
- **تحديد مسير أو أكثر** (checkbox) ثم انقر **سداد المحدد** → يتم سداد كل مسير محدد بالكامل (لجميع الموظفين المشمولين في ذلك المسير) مع إنشاء قيد سداد واحد لكل مسير.

---

## ٣. السداد — الطريقة الثانية: شاشة العمليات المالية

- من **شاشة الحسابات المتكاملة** (accounts_hub) → تبويب **«العمليات»**.
- اختر **«سداد مستحقات»** ثم من **«نوع المستحق»** اختر **«رواتب مستحقة»**.
- يتم **جلب جميع المسيرات غير المدفوعة** تلقائياً في قائمة «المسير (غير مدفوعة)».
- اختر **مسير شهر** واحداً، يُعبّأ المبلغ المتبقي تلقائياً، ثم أدخل التاريخ والملاحظة وانقر **تنفيذ العملية** → يُسجّل سداد كامل لذلك المسير مع قيد محاسبي.

---

## ٤. واجهات برمجة التطبيقات (APIs) المضافة

| المسار | الوصف |
|--------|--------|
| `GET /api/employee-unpaid-months?employee_id=<id>` | قائمة أشهر المسيرات غير المدفوعة (أو الجزئية) لموظف معين — للسداد الفردي. |
| `POST /api/employee-pay-months` | سداد فردي لعدة أشهر: Body `{ employee_id, months: [{year, month}], date, payment_method }` — يدفع المتبقي بالكامل لكل شهر مع إنشاء Payment + قيد. |

السداد الجماعي من شاشة الموظفين يستخدم نفس واجهة **`/financials/api/unpaid_payroll_runs`** و**`/financials/api/quick-txn`** (نوع `pay_liability` مع `payroll_year`, `payroll_month`, `amount`).

---

## ٥. ملخص التدفق

- **المسير** = شهر واحد (سنة–شهر)، يُنشأ باختيار الشهر ثم الموظفين والراتب ثم **حفظ/اعتماد** ثم **ترحيل** (قيد استحقاق).
- **السداد الفردي**: من الموظفين → السداد → موظف واحد → شهر واحد (رابط) أو عدة أشهر (تحديد + سداد المحدد).
- **السداد الجماعي**: من الموظفين → السداد → تحميل المسيرات غير المدفوعة → تحديد مسير أو أكثر → سداد المحدد؛ أو من العمليات → سداد مستحقات → رواتب مستحقة → اختيار مسير وتنفيذ.
