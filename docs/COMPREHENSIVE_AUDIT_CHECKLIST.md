# خطوات الفحص الشامل والجدول التحليلي

## 1. خطوات الفحص الشامل

### أ. الفواتير والعمليات
- المبيعات، المشتريات، المصروفات، المدفوعات، الرواتب، الضرائب، أي قيود يدوية.
- **التأكد من أن كل عملية لديها:**
  - حساب **مدين** مطابق لنوع العملية وطريقة الدفع.
  - حساب **دائن** مطابق لطبيعة العملية (آجل، نقد، بنك، مورد، عميل).

### ب. القيد
لكل عملية، نتحقق من:
- القيد **موجود ومرحّل (منشور)** ✅
- كل **سطر القيد** مرتبط بالحساب الصحيح من شجرة الحسابات.
- المدين والدائن **متطابقان** مع إجمالي العملية.
- **عدم وجود تكرار** للأرقام أو القيم.

### ج. الترحيل
| طريقة الدفع | الحساب المستخدم |
|-------------|------------------|
| نقداً       | صندوق فقط       |
| بنك         | حساب بنك فقط    |
| آجل         | حساب ذمم (مورد / عميل) |

**أي خلط بين Cash / Bank / Accounts Receivable أو Payable → خطأ.**

### د. الربط مع التقارير
- **ميزان المراجعة:** أرصدة صحيحة (حسابات ورقية فقط)، مع طبيعة الرصيد (مدين / دائن).
- **التقارير التفصيلية:** كل فاتورة وقيودها تظهر صحيحة.
- **Cash Flow:** يعكس كل حركة نقدية فعلية لكل صندوق أو بنك.
- **VAT:** المدخلات والمخرجات مرتبطة بالفواتير والتسويات.

### هـ. القوائم المالية
- **الأصول:** رصيد المخزون + النقدية + العملاء
- **الالتزامات:** الموردون + الضرائب المستحقة + الرواتب المستحقة
- **المصروفات والإيرادات:** مرتبطة بالقيد الصحيح
- **التحقق:** تطابق بين القيد، ميزان المراجعة، التقارير، القوائم المالية.

---

## 2. جدول تحليلي (كل الحسابات مع الحالات)

| الحساب | نوع العملية | العملية | المبلغ | القيد | الحالة | ملاحظات |
|--------|-------------|---------|--------|-------|--------|----------|
| 1111 – صندوق رئيسي | مصروف نقدي | INV-EXP-… | … | JE-PAY-EXP-… | منشور | مدين/دائن صحيح |
| 1111 – صندوق رئيسي | مصروف نقدي | TEST-EXP-001 | 230.00 | غير موجود | ❌ | لا يوجد قيد → لم يترحل |
| 1121 – بنك | مصروف بنك | INV-EXP-… | … | JE-EXP-… | منشور | مدين/دائن مطابق |
| 1141 – عملاء | مبيعات آجل | TEST-SAL-002 | 165.00 | غير موجود | ❌ | لا يوجد قيد → لم يترحل |
| 1161 – مخزون بضائع | مشتريات | TEST-PUR-005 | 1200.00 | غير موجود | ❌ | لا يوجد قيد → لم يترحل |
| 1170 – ضريبة المدخلات | ضريبة | مشتريات/مصروفات | … | — | ⚠️ | تحقق من الترحيل مع الفواتير |
| 2111 – موردون | مشتريات آجل | INV-PUR-… | … | JE-PAY-PUR-… | منشور | مطابق |
| 2114 – ذمم دائنة | منصات إلكترونية | JE-API-… | … | منشور | ❌ | حساب المدين/الدائن غير مطابق للشجرة |
| 5140 – مصروفات غير تشغيلية | مصروف نقدي | … | … | منشور | ✅ | صحيح |
| 5242 – صيانة أجهزة | مصروف بنك | … | … | منشور | ✅ | صحيح |

**ملاحظة:** أي عملية **بدون قيد** → غير مرصودة في التقارير والقوائم المالية → يجب إنشاء القيد فوراً (ترحيل القيود الناقصة أو سكربت الربط).

---

## 3. خلاصة الفحص والتصحيحات في النظام

| المشكلة | ما يوفره النظام |
|---------|------------------|
| قيود غير موجودة | قاعدة تدقيق **فواتير بدون قيد** + **ترحيل القيود الناقصة** + سكربت `link_journal_entries_to_invoices.py` |
| قيود خاطئة (حساب غير في الشجرة) | قاعدة تدقيق **قيد يستخدم حساباً غير موجود في شجرة الحسابات** (حرجة) |
| Cash Flow صفر | استخدام قيود اليومية عند خلو جدول `cashflow_summary` |
| ميزان متوازن لكن تفاصيل غير دقيقة | قواعد: رصيد نقدي دائن، مدفوعات مورد تتجاوز الفواتير، إلخ. |
| إقفال سنة رغم أخطاء | **فحص تلقائي عند الإقفال:** لا يمكن إقفال السنة (أو الإقفال الجزئي) إذا وُجدت ملاحظات **حرجة** إلا بإدخال **سبب التجاوز** (20 حرفاً على الأقل) وتسجيله في السجل. |

---

## 4. خطوات تصحيح عاجلة (يدوياً + النظام)

1. **توليد قيود** لكل فاتورة/عملية غير موجودة: تشغيل **ترحيل القيود الناقصة** من واجهة المحاسبة، أو `python scripts/link_journal_entries_to_invoices.py --backfill`.
2. **تصحيح قيود خاطئة** (مثل JE-API-1-27): مراجعة الحساب المدين/الدائن في القيد وتصحيحه ليتطابق مع شجرة الحسابات؛ محرك التدقيق يبلّغ عن حسابات غير موجودة في الشجرة.
3. **إعادة ترحيل المصروفات والفواتير** → تحديث Cash Flow (التقرير يعتمد على القيود بعد الإصلاح).
4. **إعادة توليد تقارير** الميزان والقوائم المالية → التأكد من التطابق.
5. **تفعيل فحص تلقائي عند الإقفال:** مفعّل — لا يمكن إقفال السنة أو الإقفال الجزئي عند وجود ملاحظات حرجة إلا بعد معالجتها أو إدخال مبرر التجاوز.
