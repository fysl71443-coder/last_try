# شاشة إعدادات الحسابات — التصميم والوظائف

## 1. الهدف من الشاشة

- **شجرة الحسابات** = ماذا هو الحساب (التعريف، الرمز، النوع).
- **إعدادات الحسابات** = كيف يُستخدم الحساب في العمليات المختلفة، أي **الوظيفة (Role)**، مع التحكم في الحساب الافتراضي والحالة النشطة/المعطلة لكل وظيفة.

الشاشة لا تعرض الحسابات فقط، بل تعطي القدرة على:

- ربط أي حساب بالوظائف (Roles) المختلفة.
- تحديد الحساب الافتراضي لكل وظيفة (واحد فقط لكل وظيفة).
- تعطيل أي حساب عن وظيفة معينة دون حذفه من شجرة الحسابات.
- دعم إضافة حسابات جديدة دون الحاجة لتعديل الكود — أي حساب جديد يظهر تلقائياً في القوائم المنسدلة.

---

## 2. الوظائف الرئيسية (Roles) لكل قسم

| القسم | أمثلة الوظائف |
|-------|----------------|
| النقد والبنوك | صندوق نقدي، حساب جاري، بطاقة ائتمان |
| الموردين | ذمم دائنة، مصروفات مشتريات، عمولات منصات |
| العملاء | ذمم مدينة، خصومات ممنوحة، إيرادات خدمات |
| المخزون | مخزون مواد خام، مخزون مواد تشغيلية، مخزون تحت التشغيل، تكلفة الهدر والتالف |
| الضرائب | ض.ق.م مدخلات، ض.ق.م مخرجات |
| الرواتب | رواتب الموظفين، التأمينات، الاستقطاعات |
| المصروفات | مصروفات تشغيلية، مصروفات خدمات، مصروفات منصات إلكترونية |
| الإيرادات | مبيعات نقدية، مبيعات آجلة، إيرادات خدمات |
| الأصول | أصول ثابتة، أصول متداولة |
| الهدر والتالف | تكلفة الهدر والتالف |
| فروقات وتسويات | فروقات أسعار، تسويات مالية |

---

## 3. تصميم الجدول في الشاشة

| الوظيفة (Role) | قائمة منسدلة للحسابات | افتراضي | تعطيل/تفعيل |
|----------------|------------------------|---------|--------------|
| مخزون مواد خام | [Dropdown: جميع الحسابات المتعلقة بالمخزون] | ✅ | ❌ |
| تكلفة الهدر والتالف | [Dropdown] | ✅ | ❌ |
| … | … | … | … |

**شرح الأعمدة:**

- **الوظيفة (Role):** ثابت لكل صف — يحدد نوع العملية التي يستخدم فيها الحساب.
- **قائمة منسدلة للحسابات:** تعرض كل الحسابات المتاحة من شجرة الحسابات حسب القسم. المستخدم يختار أي حساب (أي حساب جديد يظهر تلقائياً).
- **افتراضي:** checkbox/زر — لتعيين الحساب الافتراضي للوظيفة. يجب أن يكون لكل وظيفة حساب افتراضي واحد فقط.
- **تعطيل/تفعيل:** checkbox/زر — يسمح بإيقاف استخدام الحساب لهذه الوظيفة دون حذفه من شجرة الحسابات.

---

## 4. جدول قاعدة البيانات

الجدول المستخدم: **account_usage_map** (النموذج المقترح اسمه `account_function_settings`؛ التنفيذ الحالي يستخدم `account_usage_map` مع أعمدة مكافئة).

| العمود | النوع | الوصف |
|--------|--------|--------|
| id | PK | رقم تسلسلي |
| function_key | string | مفتاح الوظيفة (Role) |
| function_label_ar | string | تسمية الوظيفة بالعربية |
| account_id | FK | ربط إلى شجرة الحسابات (accounts) |
| is_default | boolean | هل الحساب الافتراضي لهذه الوظيفة |
| active | boolean | مفعل أم معطل |
| module, action, usage_group | string | سياق الاستخدام (للتوافق مع العمليات) |

أي عملية مالية تسحب الحساب المرتبط بالوظيفة من هذا الجدول (عبر `get_account_by_usage` أو الاستعلام المباشر على `account_usage_map`).

---

## 5. سلوك الشاشة

- **عند فتح الشاشة:** تحميل جميع الوظائف (Roles) لكل قسم، تحميل الحسابات المرتبطة من `account_usage_map`، تحميل كل الحسابات من شجرة الحسابات لعرضها في القائمة المنسدلة.
- **عند إضافة حساب جديد (من شجرة الحسابات):** يظهر تلقائياً في القوائم المنسدلة لكل وظيفة قابلة للاستخدام.
- **عند تغيير الافتراضي:** يتم تحديث `is_default` بحيث يكون حساب واحد فقط افتراضي لكل وظيفة (function_key).
- **تعطيل الحساب:** الحساب المعطل لا يظهر في العمليات المستقبلية لهذه الوظيفة، لكنه يبقى في إعدادات الحسابات وشجرة الحسابات.

---

## 6. الـ API المستخدمة

| المسار | الوصف |
|--------|--------|
| GET `/financials/api/account_settings/sections` | قائمة الأقسام الـ 11 |
| GET `/financials/api/account_settings/by_group?group=X` | الحسابات المرتبطة بمجموعة (وظائف + ربط) |
| GET `/financials/api/account_settings/accounts_available?group=X` | كل الحسابات للقائمة المنسدلة |
| POST `/financials/api/account_settings/set_default` | تعيين حساب افتراضي (واحد لكل وظيفة) |
| POST `/financials/api/account_settings/update_mapping` | تغيير الحساب المرتبط بوظيفة (من القائمة المنسدلة) |
| POST `/financials/api/account_settings/toggle_active` | تفعيل/تعطيل ربط حساب–وظيفة |
| POST `/financials/api/account_settings/seed` | تحميل الربط الافتراضي لجميع الأقسام |
